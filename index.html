<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="naver-site-verification" content="680b130ec4f9b3289e87133cd10464a98eebf9fd" />
  <title>ë˜íŒŒëª¨ë°”ì¼ ê³„ì‚°ê¸° | ë°ë¯¸ì§€Â·ì„¸íŒ…Â·ìŠ¤í‚¬ ê³„ì‚° - ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ</title>
  <meta name="description" content="ë˜ì „ì•¤íŒŒì´í„° ëª¨ë°”ì¼(ë˜íŒŒëª¨ë°”ì¼) ë°ë¯¸ì§€ ê³„ì‚°ê¸°. ì¥ë¹„/ì„¸íŠ¸/ìŠ¤í‚¬/ë²„í”„ë¥¼ ì…ë ¥í•´ ìµœì¢… ë°ë¯¸ì§€ì™€ íš¨ìœ¨ì„ ë¹„êµí•´ë³´ì„¸ìš”." />
  <style>
    /*ê¸°ë³¸ ë³€ìˆ˜ ìƒ‰ìƒ*/
    :root {
      --bg: #0f1115;
      --panel: #151922;
      --text: #e6e9ef;
      --muted: #9aa3b2;
      --accent: #6ea8ff;
      --ring: rgba(110, 168, 255, 0.45);
      --gold: #cfa24f;
      --gold-2: #8f6b2b;
      --card-bg: #17120f;
    }

    /*ëª¨ë“  ë°•ìŠ¤*/
    * {
      box-sizing: border-box;
    }

    /*htmlê³¼ bodyì— ëŒ€í•´ */
    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(1200px 600px at 50% -10%, #1b2130 0%, #0f1115 60%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial;
      overflow: auto;
    }

    .wrap {
      max-width: 1300px;
      margin: 20px auto;
      padding: 0 16px;
    }

    .top-title {
      text-align: center;
      font-weight: 800;
      font-size: clamp(20px, 2.6vw, 36px);
      margin: 6px 0 4px;
    }

    .sub-alert {
      text-align: center;
      color: #ffb3b3;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .main2 {
      text-align: center;
      color: #ff0000;
      font-size: 12px;
      margin-bottom: 10px;
      font-weight: bold;
      /* ê¸€ì”¨ ë‘ê»˜ â†’ êµµê²Œ */
    }

    .grid {
      display: grid;
      grid-template-columns: 1.4fr 0.9fr;
      /* ì™¼ìª½ í° ë¹„ì£¼ì–¼ / ì˜¤ë¥¸ìª½ ê³µì§€ */
      gap: 18px;
      align-items: start;
    }

    /* ===== ì™¼ìª½: ë©”ì¸ ë¹„ì£¼ì–¼ + ë¡œê·¸ì¸ ì¹´ë“œ ===== */
    .hero {
      display: flex;
      align-items: center;
      /* ì„¸ë¡œ ê°€ìš´ë° */
      position: relative;
      background: #0b0f16;
      border: 1px solid #1f2633;
      border-radius: 14px;
      overflow: hidden;
      min-height: 460px;
    }

    .hero-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      opacity: .92;
      filter: saturate(1.05) contrast(1.05);
    }

    /* ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: ê³µì§€ + ë¡œê·¸ì¸ ì„¸ë¡œë¡œ ìŒ“ê¸° */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
      /* ë‘ ë°•ìŠ¤ ì‚¬ì´ ê°„ê²© */
    }

    /* ìŠ¤ìƒ·ì˜ ë¹¨ê°„ íƒ€ì› ìœ„ì¹˜: í•˜ë‹¨ ì¢Œì¸¡ì— ëœ¨ëŠ” ë‘¥ê·¼ ì§ì‚¬ê°í˜• */
    .login-card {
      position: static;
      /* ê³ ì • í•´ì œ */
      width: 100%;
      /* ì˜¤ë¥¸ìª½ ì¹¼ëŸ¼ ë„ˆë¹„ ê½‰ ì±„ìš°ê¸° */
      background: linear-gradient(180deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .05));
      border: 1px solid rgba(255, 255, 255, .16);
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0, 0, 0, .45), inset 0 0 0 6px rgba(110, 168, 255, .06);
      padding: 14px 16px;
      backdrop-filter: blur(2px);
    }

    .login-title {
      font-weight: 700;
      margin: 2px 0 8px;
      font-size: 15px;
      letter-spacing: .2px;
    }

    .login-desc {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .login-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .login-hint {
      color: #a2ffcf;
      font-size: 12px;
    }

    /* ===== ì˜¤ë¥¸ìª½: ì—…ë°ì´íŠ¸/ê³µì§€ ===== */
    .notice {
      background: linear-gradient(180deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .03));
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 14px;
      padding: 14px 14px 18px;
    }

    .notice h3 {
      margin: 6px 0 10px;
      font-size: 18px;
    }

    .notice .box {
      background: var(--soft);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }

    .notice ul {
      margin: 6px 0 0 18px;
      padding: 0;
      line-height: 1.5;
    }

    .badge-danger {
      color: #ff8b8b;
      font-weight: 700
    }

    /* ğŸ”¹ ê³µì§€ ìƒë‹¨ í–‰ (ë°°í¬ í…ìŠ¤íŠ¸ + ë²„íŠ¼ ë‚˜ë€íˆ) */
    .notice-top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    /* ğŸ”¹ íŒ¨ì¹˜ë‚´ì—­ ë²„íŠ¼ ì‘ê²Œ */
    .patch-log-btn {
      font-size: 11px;
      padding: 4px 8px;
      white-space: nowrap;
    }

    /* ğŸ”¹ íŒ¨ì¹˜ ëª¨ë‹¬ ë‚´ìš© ì˜ì—­ */
    .patch-log-body {
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.6;
      overflow-y: auto;
    }

    /* ğŸ”¹ íŒ¨ì¹˜ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .patch-log-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .patch-log-list li {
      margin-bottom: 6px;
    }


    .upgrade {
      margin-top: 10px;
      background: #172233;
      border: 1px solid #253148;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
    }

    .upgrade a {
      color: #8fbaff;
      text-decoration: underline;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 980px) {
      .grid {
        grid-template-columns: 1fr;
      }

      .hero {
        min-height: 420px;
      }

      .login-card {
        left: 12px;
        right: 12px;
        width: auto;
      }
    }

    /*í´ë˜ìŠ¤ì„ íƒì(ìƒ‰ìƒì„¸íŠ¸)*/
    .shell {
      height: 100dvh;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    /*ë§¨ ìœ„ ì œëª©ì„*/
    /*headerëŠ” ì œëª©, headëŠ” ë©”íƒ€ì •ë³´*/
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      /*ì •ë ¬*/
      padding: 12px 18px;
      /*ì•ˆìª½ ì—¬ë°±*/
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0));
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(4px);
    }

    /* ì œëª© + ì•„ì´ì½˜ ì •ë ¬ */
    header .title {
      display: flex;
      align-items: center;
      gap: 8px;
      /* ì•„ì´ì½˜ê³¼ ì œëª© ì‚¬ì´ ê°„ê²© */
    }

    /* ìƒë‹¨ ì œëª© ì˜† ê´€ë¦¬ì ë¬¸ì˜ ì•„ì´ì½˜ ë²„íŠ¼ */
    header .title .contact-btn {
      margin-left: 18px;
      /* ì œëª©ê³¼ ì•„ì´ì½˜ ì‚¬ì´ ì—¬ìœ ë¥¼ í¬ê²Œ ì¤Œ */
      border: none;
      padding: 0;
      background: transparent;
      display: none;
      /* ë¡œê·¸ì¸ í›„ JSì—ì„œ inline-flexë¡œ ë³€ê²½ */
      cursor: pointer;
      line-height: 0;
      display: none;
      align-items: center;
      gap: 6px;
      /* ì•„ì´ì½˜ê³¼ 'ë¬¸ì˜í•˜ê¸°' í…ìŠ¤íŠ¸ ê°„ê²© */
    }

    /* ì•„ì´ì½˜ í¬ê¸° */
    header .title .contact-btn svg {
      width: 20px;
      height: 20px;
    }

    /* ë´‰íˆ¬ ì„  ìŠ¤íƒ€ì¼ (ë¼ì¸ ì•„ì´ì½˜) */
    header .title .contact-btn svg rect,
    header .title .contact-btn svg path {
      fill: none;
      stroke: #e5e7eb;
      stroke-width: 1.6;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* 'ë¬¸ì˜í•˜ê¸°' í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    header .title .contact-btn .contact-label {
      font-size: 12px;
      color: #e5e7eb;
    }

    /* í˜¸ë²„ ì‹œ ì‚´ì§ ê°•ì¡° */
    header .title .contact-btn:hover svg rect,
    header .title .contact-btn:hover svg path {
      stroke: #ffffff;
    }

    header .title .contact-btn:hover .contact-label {
      color: #ffffff;
    }

    /* ë¬¸ì˜í•˜ê¸° ì˜¤ë¥¸ìª½ì— ì‚´ì§ ë¶™ì´ê¸° */
.site-header .title .faq-btn { margin-left: 10px; }

/* FAQ ëª©ë¡ */
.faq-list { display:flex; flex-direction:column; gap:8px; margin-top: 10px; }
.faq-q-btn{
  width:100%;
  text-align:left;
  padding:10px 12px;
  border-radius:10px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.16);
  color:#e5e7eb;
  cursor:pointer;
}
.faq-q-btn:hover{ background: rgba(255,255,255,0.12); }

/* âœ… FAQ ì´ë¯¸ì§€: ì ˆëŒ€ "ëŠ˜ë¦¬ì§€ ì•Šê¸°" (ì›ë³¸ë³´ë‹¤ ì»¤ì§€ì§€ ì•ŠìŒ) */
.faq-answer-text .faq-img{
  width: auto;                          /* í•µì‹¬: 100% ê¸ˆì§€ */
  max-width: min(100%, 520px);          /* í™”ë©´ ë°–ìœ¼ë¡œë§Œ ì•ˆ ë‚˜ê°€ê²Œ + ìµœëŒ€í­ ìº¡ */
  height: auto;
  display: block;
  margin: 10px 0;
  border-radius: 10px;
}

/* âœ… ìë™ ê·¸ë¦¬ë“œ(ê°œìˆ˜ì— ë”°ë¼ ìë™ ë°°ì¹˜) */
.faq-img-grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); /* ì¹¸ ìµœì†Œ 260px, ë˜ë©´ 2~3ì—´ */
  gap: 10px;
  margin: 10px 0;
  justify-items: start; /* ì´ë¯¸ì§€ê°€ ì¹¸ì„ ê½‰ ì±„ìš°ì§€ ì•Šê³  ì™¼ìª½ ì •ë ¬ */
  align-items: start;
}

/* ê·¸ë¦¬ë“œ ì•ˆì—ì„œëŠ” ìœ„/ì•„ë˜ ë§ˆì§„ì´ ê²¹ì¹˜ë‹ˆê¹Œ 0ìœ¼ë¡œ */
.faq-img-grid .faq-img{
  margin: 0;
}

/* âœ… Q&A ë‹µë³€ ê¸€ì í¬ê¸°(ë‹µë³€ë§Œ) */
#faqAnswerModal .faq-answer-text{
  font-size: 13px;   /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì ˆ (ì˜ˆ: 12~14px) */
  line-height: 1.6;
}




    .notice-list .job-highlight {
      font-weight: 700;
      color: #f97316;
      /* í¬ì¸íŠ¸ ìƒ‰ (ì£¼í™© ê³„ì—´) */
      background: rgba(249, 115, 22, 0.08);
      padding: 2px 6px;
      border-radius: 999px;
      /* ë™ê·¸ë€ ì•Œì•½ ëª¨ì–‘ */
      border: 1px solid rgba(249, 115, 22, 0.35);
    }

    .notice-list .notice-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 10px;
      border-radius: 999px;
      /* ì•Œì•½ í˜•íƒœ */
      font-weight: 700;
      font-size: 0.9rem;
      background: linear-gradient(135deg, #fff7dd, #ffe6a3);
      /* ì‚´ì§ ê³¨ë“œí†¤ ê·¸ë¼ë°ì´ì…˜ */
      color: #92400e;
      box-shadow:
        0 0 0 1px rgba(248, 191, 88, 0.7),
        0 2px 6px rgba(0, 0, 0, 0.12);
      /* ìˆ˜ì„ í•œë§ˆë””ì²˜ëŸ¼ ì‚´ì§ ë–  ë³´ì´ëŠ” íš¨ê³¼ */
    }

    .notice-list .notice-badge::before {
      content: "â˜…";
      font-size: 0.8rem;
      margin-top: -1px;
    }

    /* ë©”ì¸ ê³µì§€ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , íŒ¨ì¹˜ë‚´ì—­ ëª¨ë‹¬ ì•ˆì—ì„œë§Œ ë” ì‘ê²Œ */
    #patchLogModal .notice-list .notice-badge {
      font-size: 0.8rem;
      /* ê¸°ì¡´ë³´ë‹¤ ì¡°ê¸ˆ ì‘ê²Œ */
      padding: 1px 8px;
      /* í•„ìš”í•˜ë©´ íŒ¨ë”©ë„ ì‚´ì§ ì¤„ì´ê¸° */
    }

    #patchLogModal .notice-list .notice-badge::before {
      font-size: 0.7rem;
      /* ë³„ ì•„ì´ì½˜ë„ ê°™ì´ ì¤„ì´ê³  ì‹¶ìœ¼ë©´ */
    }

/* ê³µì§€ ëª¨ë‹¬ í•­ëª©ë“¤ ì‚¬ì´ ì—¬ë°± ì¶”ê°€ */
#noticeModal .notice-list li {
  line-height: 1.6;     /* ì¤„ ìì²´ ê°„ê²© */
  margin-bottom: 16px;   /* í•­ëª© ì‚¬ì´ ê°„ê²© */
}



    /* ë¡œê³  ì•„ì´ì½˜ ë°•ìŠ¤ */
    header .title .logo-box {
      width: 24px;
      /* ì•„ì´ì½˜ í¬ê¸° */
      height: 24px;
      border-radius: 6px;
      /* ì‚´ì§ ë‘¥ê¸€ê²Œ */
      overflow: hidden;
      /* ì´ë¯¸ì§€ê°€ ë°•ìŠ¤ ë°–ìœ¼ë¡œ ì•ˆ íŠ€ì–´ë‚˜ì˜¤ê²Œ */
      background: rgba(255, 255, 255, 0.06);
      /* ë°°ê²½ ì‚´ì§ */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ë¡œê³  ì´ë¯¸ì§€ ìì²´ ìŠ¤íƒ€ì¼ */
    header .title .logo-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ë°•ìŠ¤ ì•ˆì— ë§ì¶”ê¸° */
      display: block;
    }


    /*header : íƒœê·¸ì„ íƒì, title : í´ë˜ìŠ¤, h1 : íƒœê·¸ì„ íƒì, headerì•ˆ -> titleì•ˆ -> h1ë§Œ ì„ íƒ*/
    header .title h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }

    /*ì•ìª½ì— íƒœê·¸ì„ íƒìê°€ ì—†ìœ¼ë¯€ë¡œ, ì „ì—­ì— actions í´ë˜ìŠ¤ ì‚¬ìš©ê°€ëŠ¥*/
    .actions {
      font-size: 12px;
      color: var(--muted);
    }

    /* ë ˆì´ì•„ì›ƒ: ì˜¤ë¥¸ìª½ì— í•©ì‚° íŒ¨ë„ ì—´ ì¶”ê°€ (ê³ ì •í­) */
    .layout {
      display: grid;
      grid-template-columns:
        minmax(220px, 1fr)
        /* 1ë²ˆì§¸ ì—´ (ì™¼ìª½) */
        minmax(320px, 36vw)
        /* 2ë²ˆì§¸ ì—´ (ìºë¦­í„°) */
        minmax(220px, 1fr)
        /* 3ë²ˆì§¸ ì—´ (ì˜¤ë¥¸ìª½) */
        300px
        /* 4ë²ˆì§¸ ì—´ (ì˜µì…˜) */
        300px;
      /* 5ë²ˆì§¸ ì—´ (í•©ì‚°ìŠ¤íƒ¯) */
      grid-template-rows: auto auto;
      gap: clamp(8px, 2vw, 24px);

      grid-template-areas:
        "left char right options stats"
        "save save right options stats";
    }

    .left-col {
      grid-area: left;
    }

    .char-col {
      grid-area: char;
    }

    .right-col {
      display: flex;
      flex-direction: column;
    }

    .options-col {
      grid-area: options;
      grid-row: 1 / span 2;
    }

    .stats-col {
      grid-area: stats;
      grid-row: 1 / span 2;
    }

    .save-box {
      background: rgba(110, 168, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 18px;
      padding: 12px 44px;
      display: flex;
      justify-content: flex-start;
      /* â† ì™¼ìª½ ì •ë ¬ */
      gap: 10px;
      position: relative;
      transform: translateY(-100px);
      /* -6 ~ -20px ë“±ìœ¼ë¡œ ì¡°ì ˆ */
      z-index: 2;
      /* ê²¹ì¹  ë•Œ ìœ„ì— ë³´ì´ê²Œ */
      overflow: hidden;        /* âœ… ë°•ìŠ¤ ë°–ìœ¼ë¡œ ì‚ì ¸ë‚˜ì˜¤ë©´ ìˆ¨ê¹€ */
    }

    /* ê°€ìš´ë° ìºë¦­í„° ì•„ë˜ì— ì˜¤ëŠ” í”„ë¦¬ì…‹ ë²„íŠ¼ë“¤ ì •ë ¬ */
    .center .save-box {
      margin-top: 15px;
      /* ë¯¸ë‹ˆìŠ¬ë¡¯ê³¼ì˜ ê°„ê²© (ì›í•˜ë©´ ì¡°ì ˆ ê°€ëŠ¥) */
      justify-content: center;
      /* ê°€ë¡œ ê°€ìš´ë° ì •ë ¬ */
      transform: none;
      /* ìœ„ë¡œ ëŒì–´ì˜¬ë¦¬ë˜ íš¨ê³¼ ì œê±° */
    }

    .save-box .preset-btn {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      /* ğŸ”¹ í˜¸ë²„ ì• ë‹ˆë©”ì´ì…˜ìš© ì „í™˜ */
      transition:
        background 0.2s,
        transform 0.15s ease-out,
        box-shadow 0.15s ease-out,
        border-color 0.15s ease-out,
        background-color 0.15s ease-out;
    }

    .save-box .preset-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* ì €ì¥ ìŠ¬ë¡¯ ìƒíƒœ í‘œì‹œ */
    .save-box .preset-btn.has-data {
      background: rgba(207, 162, 79, 0.25);
      border-color: #cfa24f;
      color: #ffe9ac;
      font-size: 18px;

      /* â˜… ì €ì¥ëœ ìºë¦­í„° ì´ë¯¸ì§€ìš© (ì´ë¯¸ì§€ ì‚¬ìš©ì‹œ) */
      background-size: cover;
      background-position: 13% center;
      /* â† í•„ìš”í•˜ë©´ ì´ë ‡ê²Œ */
      background-repeat: no-repeat;
      overflow: hidden;
    }

    /* ğŸ”¹ í”„ë¦¬ì…‹ ë²„íŠ¼ í˜¸ë²„ ì‹œ ì‚´ì§ ë– ì˜¤ë¥´ëŠ” íš¨ê³¼ */
    .save-box .preset-btn:hover:not(:disabled),
    .save-box .preset-btn:focus-visible:not(:disabled) {
      transform: translateY(-2px);
      /* ìœ„ë¡œ 2px ë– ì˜¤ë¥´ê²Œ */
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
      /* ì•„ë˜ìª½ì— ì‚´ì§ ì§„í•œ ê·¸ë¦¼ì */
      border-color: #facc6b;
      /* ì‚´ì§ ë” ê°•ì¡°ë˜ëŠ” í…Œë‘ë¦¬ (ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ë°”ê¿”ë„ ë¨) */
    }

    /* í”„ë¦¬ì…‹ ìŠ¬ë¡¯+íœ´ì§€í†µ ë˜í¼ */
    .save-box {
      /* ê¸°ì¡´ ì†ì„±ë“¤ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , align-items ì •ë„ë§Œ ì¶”ê°€ */
      align-items: center;
    }

    .save-box .preset-slot {
      position: relative;
      width: 48px;
      height: 48px;
      flex-shrink: 0;
    }

    /* ë©”ì¸ ë²„íŠ¼ì€ ë˜í¼ ê¸°ì¤€ 100% ì±„ìš°ê¸° */
    .save-box .preset-slot .preset-btn {
      width: 100%;
      height: 100%;
    }

    /* íœ´ì§€í†µ ë²„íŠ¼ ê¸°ë³¸ ìƒíƒœ: ìˆ¨ê¹€ */
    .save-box .preset-slot .preset-trash {
      position: absolute;
      right: -4px;
      top: -4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: none;
      background: rgba(15, 23, 42, 0.85);
      color: #9ca3af;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;

      opacity: 0;
      pointer-events: none;
    }

    /* í•´ë‹¹ ìŠ¬ë¡¯ì— ë°ì´í„°ê°€ ìˆì„ ë•Œë§Œ íœ´ì§€í†µ í‘œì‹œ */
    .save-box .preset-slot .preset-btn.has-data+.preset-trash {
      opacity: 1;
      pointer-events: auto;
    }

/* âœ… í”„ë¦¬ì…‹ ìŠ¬ë¡¯ í˜ì´ì§€ í™”ì‚´í‘œ(ë°•ìŠ¤ ì•ˆìª½ ì¢Œ/ìš°) */
.save-box .preset-page-btn{
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 30px;
  height: 30px;
  border-radius: 999px;

  /* ë³´ê¸° ì¢‹ì€ ë°˜íˆ¬ëª… ê¸€ë˜ìŠ¤ ëŠë‚Œ */
  background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
  border: 1px solid rgba(255,255,255,0.18);
  box-shadow:
    0 8px 20px rgba(0,0,0,0.25),
    inset 0 1px 0 rgba(255,255,255,0.12);

  color: rgba(255,255,255,0.92);
  font-size: 18px;
  line-height: 1;
  cursor: pointer;

  display: flex;
  align-items: center;
  justify-content: center;

  z-index: 5;              /* âœ… ìŠ¬ë¡¯ ìœ„ë¡œ */
  user-select: none;
  -webkit-tap-highlight-color: transparent;

  transition: transform .15s ease, filter .15s ease, opacity .15s ease, background .15s ease;
}

/* âœ… ë°•ìŠ¤ ì•ˆìª½ ëì— â€œë¶™ì—¬ë„£ê¸°â€ */
.save-box .preset-page-btn.prev{ left: 8px; }
.save-box .preset-page-btn.next{ right: 8px; }

/* hover / active */
.save-box .preset-page-btn:hover{
  filter: brightness(1.08);
  transform: translateY(-50%) scale(1.04);
}
.save-box .preset-page-btn:active{
  transform: translateY(-50%) scale(0.96);
  filter: brightness(0.98);
}

/* disabled */
.save-box .preset-page-btn:disabled{
  opacity: 0.28;
  cursor: default;
  filter: none;
  transform: translateY(-50%);
  box-shadow:
    0 4px 10px rgba(0,0,0,0.18),
    inset 0 1px 0 rgba(255,255,255,0.08);
}

/* í˜ì´ì§€ í‘œì‹œ(1/2) - ê°€ìš´ë° ì•„ë˜, ì˜ˆì˜ê²Œ */
.save-box .preset-page-ind{
  position: absolute;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 999px;
  background: rgba(0,0,0,0.25);
  border: 1px solid rgba(255,255,255,0.10);
  color: rgba(255,255,255,0.80);
  pointer-events: none;
  display: none; /* JSì—ì„œ í•„ìš”í•  ë•Œ ì¼¬ */
}



    .save-box button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* í”„ë¦¬ì…‹ ëª¨ë‹¬ ì „ìš© í¬ê¸°/ë ˆì´ì•„ì›ƒ */
    #presetModal .preset-dialog {
      width: min(420px, 95vw);
      height: auto;
      padding: 14px 18px 16px;
      grid-template-rows: auto 1fr;
    }

    .preset-body {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 10px 4px 4px;
    }

    .preset-clear-btn {
      align-self: flex-start;
      /* ì™¼ìª½ ìœ„ ë¶™ê²Œ */
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(15, 23, 42, 0.85);
      /* ì–´ë‘ìš´ ì› ë°°ê²½ */
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
      font-size: 20px;
      /* ì´ê²Œ ì‹¤ì œ ğŸ—‘ í¬ê¸° */
      padding: 0;
      margin-bottom: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .preset-clear-btn:hover {
      color: #f97373;
      border-color: #f97373;
    }

    .preset-thumb {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid #cfa24f;
      background: #15100c;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preset-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: 13% center;
    }

    .preset-char-name {
      margin-top: 6px;
      font-weight: 700;
      color: #f0e6d2;
      font-size: 15px;
      text-align: center;
    }

    .preset-user-name {
      font-size: 13px;
      color: #c7b589;
      text-align: center;
    }

    .preset-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .preset-actions .btn {
      flex: 1;
      height: 34px;
      border-radius: 999px;
      border: 1px solid #3a2c21;
      background: #1a130f;
      color: #f0e6d2;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }

    .preset-actions .btn.main {
      background: #cfa24f;
      color: #0b0f15;
      border-color: #facc15;
    }

    /* ê´€ë¦¬ì ë¬¸ì˜ ëª¨ë‹¬ */
    .contact-dialog {
      width: min(620px, 95vw);
      height: auto;
      padding: 14px 18px 16px;
      grid-template-rows: auto 1fr;
    }

    .contact-body {
      padding: 12px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .contact-notice {
      font-size: 13px;
      line-height: 1.6;
      color: #f5e3c3;
      background: #1a130f;
      border: 1px solid #3a2c21;
      border-radius: 8px;
      padding: 10px 12px;
      white-space: normal;
    }

    .contact-textarea {
      min-height: 140px;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid #3a2c21;
      background: #0f1115;
      color: #f0e6d2;
      padding: 8px 10px;
      font-size: 13px;
      font-family: inherit;
    }

    .contact-textarea::placeholder {
      color: #6b7280;
    }

    /* âœ… Q&A(FAQ) ëª¨ë‹¬: ë‚´ìš©ì´ ê¸¸ë©´ ë³¸ë¬¸ì—ì„œ ìŠ¤í¬ë¡¤ */
.dialog.faq-dialog{
  display: flex;          /* header + bodyë¥¼ ì„¸ë¡œë¡œ ìŒ“ê¸° */
  flex-direction: column;
  overflow: hidden;       /* ë°”ê¹¥ìœ¼ë¡œ ì‚ì ¸ë‚˜ê°€ëŠ” ê²ƒ ë°©ì§€ */
}

.dialog.faq-dialog .contact-body{
  flex: 1;                /* ë‚¨ëŠ” ë†’ì´ë¥¼ ë³¸ë¬¸ì´ ì°¨ì§€ */
  min-height: 0;          /* â­ ì´ê²Œ ìˆì–´ì•¼ overflow ìŠ¤í¬ë¡¤ì´ ì •ìƒ ì‘ë™ */
  overflow-y: auto;       /* ë‚´ìš© ê¸¸ë©´ ìŠ¤í¬ë¡¤ */
}

    .reply-block {
      margin-top: 6px;
    }

    .reply-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .reply-text {
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      border-radius: 6px;
      padding: 6px 8px;
    }

    .reply-text.original {
      background: #111827;
      border: 1px solid #1f2937;
    }

    .reply-text.answer {
      background: #0f172a;
      border: 1px solid #1d4ed8;
      min-height: 330px;
      /* â˜… ë‹µë³€ ìƒì ê¸°ë³¸ ë†’ì´ ëŠ˜ë¦¬ê¸° */
    }

    .reply-actions {
      margin-top: 4px;
      /* ë‹µë³€ ìƒìì— ê½¤ ë¶™ê²Œ */
      display: flex;
      flex-direction: column;
      /* ìœ—ì¤„: ì²´í¬ë°•ìŠ¤, ì•„ë«ì¤„: ë²„íŠ¼ */
      align-items: center;
      /* ë²„íŠ¼ì„ ê°€ìš´ë°ë¡œ */
      gap: 8px;
    }

    .reply-dontshow {
      align-self: flex-start;
      /* ì²´í¬ë°•ìŠ¤ëŠ” ì™¼ìª½ìœ¼ë¡œ ë¶™ì´ê³  */
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #e5e7eb;
    }

    .reply-dontshow input[type="checkbox"] {
      width: 14px;
      height: 14px;
    }

    /* (ì˜µì…˜) ë²„íŠ¼ í­ ì‚´ì§ í‚¤ìš°ê³  ì‹¶ìœ¼ë©´ */
    .reply-actions .ui-btnetc {
      min-width: 120px;
    }

    .reply-actions .btn {
      flex: 0 0 auto;
      min-width: 72px;
      height: 30px;
      font-size: 12px;
    }

    /* âœ… Q&A ë‹µë³€ ëª¨ë‹¬: ë‚´ìš©ë§Œí¼ë§Œ ë†’ì´ + ê¸¸ë©´ ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
#faqAnswerModal .dialog {
  height: auto;
  min-height: 0;
  max-height: min(700px, 90vh); /* ê¸°ì¡´ ì˜ë„ ìœ ì§€ */
  display: flex;               /* header + body ì„¸ë¡œ ë°°ì¹˜ */
  flex-direction: column;
}

#faqAnswerModal .contact-body {
  overflow-y: auto;            /* ë‚´ìš©ì´ ê¸¸ë©´ ì—¬ê¸°ë§Œ ìŠ¤í¬ë¡¤ */
}



    #btnRune,
    #btnSkillTree,
    #btn-sum-all-final,
    #btn-sum-all-final2 {
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    /* ìŠ¤í‚¬ë£¬ ì„¤ì • ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
    #btnRune.rune-highlight,
    #btnSkillTree.rune-highlight {
      border-color: #fbbf24;
      box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.45);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    /* ìŠ¤í‚¬ë£¬ ì„¤ì • ë²„íŠ¼ì— ë§ˆìš°ìŠ¤ë¥¼ ì§ì ‘ ì˜¬ë ¸ì„ ë•Œ í•˜ì´ë¼ì´íŠ¸ */
    #btnRune:hover,
    #btnSkillTree:hover {
      border-color: #cfa24f;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .25);
    }

    /* â“˜ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ë„ ìŠ¤í‚¬ë£¬ ì„¤ì • ë²„íŠ¼ì„ ê°™ì´ í•˜ì´ë¼ì´íŠ¸ */
    .opt-box:has(.opt-title .info-tip:hover) #btnRune,
    .opt-box:has(.opt-title .info-tip:hover) #btnSkillTree {
      border-color: #fbbf24;
      box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.45);
    }


    /* justify-content ëŠ” ê°€ë¡œë°©í–¥ì •ë ¬, align-items ì€ ì„¸ë¡œë°©í–¥ì •ë ¬
 flex-startëŠ” ì•„ì´í…œë“¤ì„ ì‹œì‘ì§€ì ì— ë¶™ì—¬ì„œì •ë ¬ ê°€ë¡œë©´ ì™¼ìª½ì •ë ¬, ì„¸ë¡œë©´ ìœ„ìª½ì •ë ¬
 flex-endëŠ” ì•„ì´í…œë“¤ì„ ëì§€ì ì— ë¶™ì—¬ì„œ ì •ë ¬, ê°€ë¡œë©´ ì˜¤ë¥¸ìª½ì •ë ¬, ì„¸ë¡œë©´ ì•„ë˜ìª½ì •ë ¬*/
    .column {

      display: flex;
      flex-direction: column;
      align-self: start !important;
      /* ì„¸ë¡œì¶• ìœ„ìª½ ì •ë ¬ */
      height: max-content !important;
      /* ë‚´ìš©ë§Œí¼ë§Œ ë†’ì´ */
      gap: 12px;
      padding: 10px 6px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    /* ì˜¤ë¥¸ìª½ ì¥ë¹„ ì»¬ëŸ¼ì˜ ì„¸ë¡œ ê°„ê²©ë§Œ ë”°ë¡œ ì¡°ì ˆ */
    .column.right {
      width: 255px;
      gap: 7px;
      /* ì›ë˜ 12pxì—ì„œ ì¤„ì¸ ê°’. ì›í•˜ëŠ” ìˆ«ìë¡œ ë°”ê¿”ë„ ë¨ */
    }

    .column.left {
      width: 255px;
      gap: 13px;
      /* ì›ë˜ 12pxì—ì„œ ì¤„ì¸ ê°’. ì›í•˜ëŠ” ìˆ«ìë¡œ ë°”ê¿”ë„ ë¨ */
    }

    .slot-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /*slot-row ì™€ left ë‘ê°€ì§€ í´ë˜ìŠ¤ ëª¨ë‘ë¥¼ ê°€ì§€ê³  ìˆëŠ”ê²ƒ, slot-rowì™€ left ì¤‘ í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ ì ìš©ë˜ì§€ ì•ŠëŠ”ë‹¤)
//slot-row left ì ì´ ì•„ë‹Œ ë„ì–´ì“°ê¸°ë¥¼ í•˜ë©´, leftê°€ ì• ìš”ì†Œ ì•ˆì˜ ìš”ì†Œê°€ ë˜ëŠ”ë°, ì´ë•Œ leftëŠ” íƒœê·¸ì´ë‹¤. .leftë¡œ ì“°ê²Œë˜ë©´ í´ë˜ìŠ¤ê°€ ëœë‹¤.
//html(í´ë˜ìŠ¤)ì— ë„£ì–´ì„œ ì“¸ë•ŒëŠ” ë„ì–´ì“°ê¸°ë¡œ ì“´ë‹¤. class = "slot-row left" */
    .slot-row.left {
      justify-content: flex-end;
    }

    .slot-row.right {
      justify-content: flex-start;
    }

    /* âœ… ë¬´ê¸° í–‰ ì „ìš©: 3ì—´ ê·¸ë¦¬ë“œ (ì— ë¸”ë ˜ / ì»¤ìŠ¤í…€+ë¬´ê¸° / ê°•í™”Â·ë§ˆë´‰Â·ë§ˆë²•Â·ì—°ë§ˆ) */
    .slot-row.weapon-row {
      display: grid;
      grid-template-columns: auto auto auto;
      /* ì— ë¸”ë ˜ / ê°€ìš´ë° / ì˜¤ë¥¸ìª½ ë²„íŠ¼ */
      grid-auto-rows: auto;
      column-gap: 10px;
      row-gap: 8px;
      align-items: center;
    }

    /* ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ì„ ë¬´ê¸° ìŠ¬ë¡¯ê³¼ ê°™ì€ ê°€ë¡œê¸¸ì´ë¡œ */
    .slot-row.weapon-row #btnCustomOpt {
      width: 100%;
      /* í•´ë‹¹ ê·¸ë¦¬ë“œ ì—´ ì „ì²´ ë„ˆë¹„ */
      box-sizing: border-box;
      justify-self: stretch;
    }

    /* ê¸°ë³¸ ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ ë² ì´ìŠ¤ ìŠ¤íƒ€ì¼ */
    .slot-row.weapon-row #btnCustomOpt {
      width: 100%;
      box-sizing: border-box;
      justify-self: stretch;
      border-color: var(--line);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
    }

    /* ê°•íƒ€: ë…¸ë€ìƒ‰ ê³„ì—´ */
    .slot-row.weapon-row #btnCustomOpt.customopt-ê°•íƒ€ {
      border-color: #facc15;
      background: rgba(250, 204, 21, 0.15);
      color: #facc15;
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.35);
    }

    /* ê´‘ì±„: íŒŒë€ìƒ‰ ê³„ì—´ */
    .slot-row.weapon-row #btnCustomOpt.customopt-ê´‘ì±„ {
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.15);
      color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
    }

    /* ë¶„ì‡„: ë¹¨ê°„ìƒ‰ ê³„ì—´ */
    .slot-row.weapon-row #btnCustomOpt.customopt-ë¶„ì‡„ {
      border-color: #f97373;
      background: rgba(248, 113, 113, 0.15);
      color: #f97373;
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.35);
    }

    /* ì„ ëª…: ì´ˆë¡ìƒ‰ ê³„ì—´ */
    .slot-row.weapon-row #btnCustomOpt.customopt-ì„ ëª… {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.15);
      color: #4ade80;
      box-shadow: 0 0 0 1px rgba(74, 222, 128, 0.35);
    }

    /* ì—†ìŒ: ì‚´ì§ í†¤ ë‹¤ìš´ëœ ì¤‘ë¦½ */
    .slot-row.weapon-row #btnCustomOpt.customopt-ì—†ìŒ {
      border-color: var(--line);
      background: rgba(15, 23, 42, 0.6);
      color: var(--muted);
      box-shadow: none;
    }


    /* (ì„ íƒ) ë¬´ê¸° ìŠ¬ë¡¯ë„ ì—´ í­ì— ë§ì¶°ì„œ ì •ë ¬ */
    /*.slot-row.weapon-row .slot[data-slot="R1"] {
  justify-self: stretch;
}*/

    .slot-row.weapon-row .emblem-stack {
      grid-column: 1;
      grid-row: 1 / span 2;
      /* ì»¤ìŠ¤í…€+ë¬´ê¸° ë†’ì´ë§Œí¼ ê°™ì´ ì°¨ì§€ */
    }

    .slot-row.weapon-row .slot[data-slot="R1"] {
      grid-column: 2;
      grid-row: 2;
      /* ê°€ìš´ë° ì—´, ì•„ë˜ í–‰ â†’ ë¬´ê¸° ìŠ¬ë¡¯ */
    }

    .slot-row.weapon-row #btnCustomOpt {
      grid-column: 2;
      grid-row: 1;
      /* ê°€ìš´ë° ì—´, ìœ„ í–‰ â†’ ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ */
      justify-self: flex-start;
    }

    .slot-row.weapon-row .outer-rects {
      grid-column: 3;
      grid-row: 1 / span 2;
      /* ì˜¤ë¥¸ìª½ ì—´ ì „ì²´ â†’ ê°•í™”/ë§ˆë´‰/ë§ˆë²•/ì—°ë§ˆ */
    }

    /* âœ… ìƒì˜ í–‰ ì „ìš©: 3ì—´ ê·¸ë¦¬ë“œ (ë³´ì¡°ìŠ¬ë¡¯ / ì»¤ìŠ¤í…€+ìƒì˜ / ì— ë¸”ë ˜) */
    .slot-row.armor-row {
      display: grid;
      grid-template-columns: auto auto auto;
      /* 1: ê°•í™”/ë§ˆë´‰/ë§ˆë¶€, 2: ì»¤ìŠ¤í…€+ìƒì˜, 3: ì— ë¸”ë ˜ */
      grid-auto-rows: auto;
      column-gap: 10px;
      row-gap: 8px;
      align-items: center;
    }

    /* 1ì—´: ë³´ì¡°ìŠ¬ë¡¯ ë¬¶ìŒ */
    .slot-row.armor-row .outer-rects {
      grid-column: 1;
      grid-row: 1 / span 2;
      /* ì»¤ìŠ¤í…€+ìƒì˜ ë†’ì´ë§Œí¼ ì„¸ë¡œë¡œ ì°¨ì§€ */
    }

    /* 2ì—´: ìƒì˜ ìŠ¬ë¡¯(ì•„ë˜) */
    .slot-row.armor-row .slot[data-slot="L2"] {
      grid-column: 2;
      grid-row: 2;
      justify-self: stretch;
    }

    /* 2ì—´: ì»¤ìŠ¤í…€ì˜µ(ìƒì˜) ë²„íŠ¼(ìœ„) */
    .slot-row.armor-row #btnCustomOptArmor {
      grid-column: 2;
      grid-row: 1;
      width: 100%;
      box-sizing: border-box;
      justify-self: stretch;

      /* ë¬´ê¸° ì»¤ìŠ¤í…€ì˜µê³¼ í†¤ ë§ì¶˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
      border-color: var(--line);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);

      padding: 4px 6px;
    }

    /* 3ì—´: ì— ë¸”ë ˜ ìŠ¤íƒ (2ì†Œì¼“ ì„¸ë¡œ ìŠ¤íƒ) */
    .slot-row.armor-row .emblem-stack {
      grid-column: 3;
      grid-row: 1 / span 2;
    }

    /* âœ… ê·€ê±¸ì´ í–‰ ì „ìš©: 3ì—´ ê·¸ë¦¬ë“œ (ë³´ì¡°ìŠ¬ë¡¯ / ì»¤ìŠ¤í…€+ê·€ê±¸ì´ / ì— ë¸”ë ˜) */
    .slot-row.earring-row {
      display: grid;
      grid-template-columns: auto auto auto;
      /* 1: ê°•í™”/ë§ˆë´‰/ë§ˆë¶€, 2: ì»¤ìŠ¤í…€+ê·€ê±¸ì´, 3: ì— ë¸”ë ˜ */
      grid-auto-rows: auto;
      column-gap: 10px;
      row-gap: 8px;
      align-items: center;
    }

    /* 1ì—´: ë³´ì¡°ìŠ¬ë¡¯ ë¬¶ìŒ */
    .slot-row.earring-row .outer-rects {
      grid-column: 1;
      grid-row: 1 / span 2;
    }

    /* 2ì—´: ê·€ê±¸ì´ ìŠ¬ë¡¯(ì•„ë˜) */
    .slot-row.earring-row .slot[data-slot="L6"] {
      grid-column: 2;
      grid-row: 2;
      justify-self: stretch;
    }

    /* 2ì—´: ì»¤ìŠ¤í…€ì˜µ(ê·€ê±¸ì´) ë²„íŠ¼(ìœ„) */
    .slot-row.earring-row #btnCustomOptEarring {
      grid-column: 2;
      grid-row: 1;
      width: 100%;
      box-sizing: border-box;
      justify-self: stretch;

      border-color: var(--line);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
      padding: 4px 6px;
    }

    /* 3ì—´: ì— ë¸”ë ˜ ìŠ¤íƒ */
    .slot-row.earring-row .emblem-stack {
      grid-column: 3;
      grid-row: 1 / span 2;
    }


    /* ğŸ”» ì„ íƒê°’ì— ë”°ë¥¸ ìƒ‰ìƒ */

    /* ì„ ë´‰: ë¶„ì‡„ì™€ ë™ì¼í•œ ë¹¨ê°„ ê³„ì—´ */
    .slot-row.armor-row #btnCustomOptArmor.armor-customopt-ì„ ë´‰,
    .slot-row.right.bracelet-row #btnCustomOptBracelet.bracelet-customopt-ì„ ë´‰,
    .slot-row.earring-row #btnCustomOptEarring.earring-customopt-ì„ ë´‰ {
      border-color: #f97373;
      background: rgba(248, 113, 113, 0.15);
      color: #f97373;
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.35);
    }

    /* ì˜ì§€: ê´‘ì±„ì™€ ë™ì¼í•œ íŒŒë€ ê³„ì—´ */
    .slot-row.armor-row #btnCustomOptArmor.armor-customopt-ì˜ì§€,
    .slot-row.right.bracelet-row #btnCustomOptBracelet.bracelet-customopt-ì˜ì§€,
    .slot-row.earring-row #btnCustomOptEarring.earring-customopt-ì˜ì§€ {
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.15);
      color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
    }

    /* ì´ìƒ: ì„ ëª…ê³¼ ë™ì¼í•œ ì´ˆë¡ ê³„ì—´ */
    .slot-row.armor-row #btnCustomOptArmor.armor-customopt-ì´ìƒ,
    .slot-row.right.bracelet-row #btnCustomOptBracelet.bracelet-customopt-ì´ìƒ,
    .slot-row.earring-row #btnCustomOptEarring.earring-customopt-ì´ìƒ {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.15);
      color: #4ade80;
      box-shadow: 0 0 0 1px rgba(74, 222, 128, 0.35);
    }

    /* ì—†ìŒ: ê¸°ë³¸ ì¤‘ë¦½ ëŠë‚Œ */
    .slot-row.armor-row #btnCustomOptArmor.armor-customopt-ì—†ìŒ,
    .slot-row.right.bracelet-row #btnCustomOptBracelet.bracelet-customopt-ì—†ìŒ,
    .slot-row.earring-row #btnCustomOptEarring.earring-customopt-ì—†ìŒ {
      border-color: var(--line);
      background: rgba(15, 23, 42, 0.6);
      color: var(--muted);
      box-shadow: none;
    }


    /* âœ… íŒ”ì°Œ í–‰: 1ì—´ ì— ë¸”ë ˜ / 2ì—´ ì»¤ìŠ¤í…€ì˜µ+íŒ”ì°Œ / 3ì—´ ë³´ì¡°ìŠ¬ë¡¯ */
    .slot-row.right.bracelet-row {
      display: grid;
      grid-template-columns: auto auto auto;
      grid-auto-rows: auto;
      column-gap: 10px;
      row-gap: 6px;
      align-items: center;
    }

    /* 1ì—´: ì— ë¸”ë ˜ ìŠ¤íƒ (2ì†Œì¼“ ì„¸ë¡œ) */
    .slot-row.right.bracelet-row .emblem-stack {
      grid-column: 1;
      grid-row: 1 / span 2;
    }

    /* 2ì—´ 1í–‰: íŒ”ì°Œ ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ */
    .slot-row.right.bracelet-row #btnCustomOptBracelet {
      grid-column: 2;
      grid-row: 1;
      width: 100%;
      box-sizing: border-box;
      justify-self: stretch;
      border-color: var(--line);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
      padding: 4px 6px;
    }

    /* 2ì—´ 2í–‰: íŒ”ì°Œ ìŠ¬ë¡¯ */
    .slot-row.right.bracelet-row .slot[data-slot="R2"] {
      grid-column: 2;
      grid-row: 2;
      justify-self: stretch;
    }

    /* 3ì—´: ë³´ì¡°ìŠ¬ë¡¯(ê°•í™”/ë§ˆë´‰/ë§ˆë¶€) */
    .slot-row.right.bracelet-row .outer-rects {
      grid-column: 3;
      grid-row: 1 / span 2;
    }



    .slot {
      width: clamp(64px, 10vh, 120px);
      aspect-ratio: 1/1;
      border-radius: 12px;
      background: radial-gradient(120px 120px at 40% 35%, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02) 50%, rgba(255, 255, 255, 0.01) 100%);
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: grid;
      place-items: center;
      position: relative;
      cursor: pointer;
      user-select: none;
      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25) inset, 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    /* :ëŠ” ì˜ì‚¬í´ë˜ìŠ¤, hoverëŠ” ë§ˆìš°ìŠ¤ë¥¼ ìœ„ì— ì˜¬ë¦° ìƒíƒœë¥¼ ëœ»í•¨. ë”°ë¼ì„œ slot í´ë˜ìŠ¤ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì´ë¼ëŠ” ëœ»
// ê·¸ì™¸ì—ë„ active : í´ë¦­í•œ ìˆœê°„(ë§ˆìš°ìŠ¤ ë²„íŠ¼ ëˆ„ë¥´ê³  ìˆì„ë•Œ), focus : ì…ë ¥ì°½ í´ë¦­í–ˆì„ë•Œ, visited : ë°©ë¬¸í•œ ë§í¬, link : ë°©ë¬¸í•˜ì§€ ì•Šì€ ë§í¬
// first-child : ë¶€ëª¨ ì•ˆì—ì„œ ì²«ë²ˆì§¸ ìì‹, last-child : ë¶€ëª¨ ì•ˆì—ì„œ ë§ˆì§€ë§‰ ìì‹, ntn-child(n) : ë¶€ëª¨ ì•ˆì—ì„œ në²ˆì§¸ ìì‹
//checked : ì²´í¬ë°•ìŠ¤ë‚˜ ë¼ë””ì˜¤ë²„íŠ¼ì— ì²´í¬ëœìƒíƒœ, valid, invalid : ì…ë ¥ê°’ì´ ìœ íš¨ì„± ê²€ì‚¬ì— ë§ê±°ë‚˜ ì•„ë‹ë•Œ
//root : ë¬¸ì„œ ìµœìƒìœ„ ìš”ì†Œ */
    .slot:hover {
      transform: translateY(-2px);
      border-color: rgba(110, 168, 255, 0.5);
      box-shadow: 0 0 0 4px var(--ring), 0 10px 24px rgba(0, 0, 0, 0.35) inset;
    }

    /* slot-label í´ë˜ìŠ¤ëŠ” slotì˜ ìì†ì„ íƒìì´ë‹¤. ë”°ë¼ì„œ slot í´ë˜ìŠ¤ë¥¼ ì„ ì–¸í•˜ê³  ê·¸ ì•ˆì— ë˜ slot-label í´ë˜ìŠ¤ë¥¼ ì„ ì–¸í•´ì•¼í•œë‹¤. */
    .slot .slot-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      color: var(--muted);
      background: rgba(0, 0, 0, 0.35);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      white-space: nowrap;
      max-width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ì¥ë¹„ ì ‘ë‘ì‚¬ ë¼ë²¨ (ìŠ¬ë¡¯ ì¢Œì¸¡ ìƒë‹¨) */
    .slot .equip-prefix {
      position: absolute;
      top: 4px;
      left: 4px;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 9px;
      line-height: 1.2;
      font-weight: 700;
      letter-spacing: 0.03em;
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.95), rgba(37, 99, 235, 0.95));
      color: #fff;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
      pointer-events: none;
      z-index: 3;
    }

    .outer-rects {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .rect {
      width: clamp(52px, 8vh, 96px);
      height: clamp(18px, 3vh, 28px);
      border-radius: 10px;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.06) inset, 0 6px 16px rgba(0, 0, 0, 0.25) inset;
      color: var(--text);
      font-size: 10px;
    }

    .rect:hover {
      border-color: rgba(110, 168, 255, 0.55);
      box-shadow: 0 0 0 3px var(--ring), 0 8px 18px rgba(0, 0, 0, 0.35) inset;
    }

    .rect.disabled {
      opacity: .45;
      pointer-events: none;
    }

    .center {
      /* ìºë¦­í„° ì¹´ë“œ / mini-bar / save-box ë¥¼ ìœ„ì—ì„œ ì•„ë˜ë¡œ ì„¸ë¡œë¡œ ë°°ì¹˜ */
      display: flex;
      flex-direction: column;
      align-items: center;
      /* ê°€ë¡œ ê°€ìš´ë° ì •ë ¬ */
      justify-content: flex-start;
      /* ìœ„ì—ì„œë¶€í„° ìŒ“ê¸° */
      min-width: min(34vw, 460px);
      height: 100%;
    }

    /* âœ… ìºë¦­í„° ì¹´ë“œ + ì „ìš© ë²„íŠ¼ì„ ê°€ë¡œë¡œ ë°°ì¹˜í•˜ëŠ” ë˜í¼ */
    .center-top-row {
      display: flex;
      align-items: center;
      justify-content: center;
      /* ì¤‘ì•™ ê¸°ì¤€ìœ¼ë¡œ ëª¨ìœ¼ê¸° */
      gap: 8px;
      width: 100%;
    }

    /* âœ… ì™¼ìª½ ë²„íŠ¼ ë‘ ê°œ ì„¸ë¡œì •ë ¬ */
    .center-special-col {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: stretch;
    }

    /* âœ… íŠ¹ì • ê³„ì • ì „ìš© ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì¡°ê¸ˆ ì‘ê³  ê¹”ë”í•˜ê²Œ) */
    .btn-special-patch {
      font-size: 11px;
      padding: 4px 8px;
      white-space: nowrap;
    }

    .character-card {
      /*ë©”ì¸ ìºë¦­í„° ë°•ìŠ¤*/
      /*margin-top: 0px;  /* ì›í•˜ëŠ” ê°’(px, %, rem ë“±) */
      align-self: center;
      /* â† ì„¸ë¡œì¶• ìœ„ìª½ì— ë¶™ìŒ */
      width: clamp(20px, 25vw, 520px);
      aspect-ratio: 3/4;
      border-radius: 22px;
      background: radial-gradient(60% 40% at 50% 10%, rgba(110, 168, 255, 0.08), transparent 60%),
        linear-gradient(180deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      box-shadow: 0 0 0 6px rgba(110, 168, 255, 0.08) inset, 0 20px 50px rgba(0, 0, 0, 0.45);
    }

    .character-ghost {
      width: 80%;
      height: 80%;
      border-radius: 24px;
      border: 2px dashed rgba(255, 255, 255, 0.18);
      display: grid;
      place-items: center;
      color: var(--muted);
      text-align: center;
    }

    .character-img {
      position: absolute;
      inset: 0;
      /* ìŠ¬ë¡¯ì„ ëê¹Œì§€ ì±„ìš°ê¸° */
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* ê½‰ ì±„ìš°ë˜, ë¹„ìœ¨ ìœ ì§€ â€“ ë„˜ì¹˜ëŠ” ë¶€ë¶„ì€ ì˜ë¼ëƒ„ */
      object-position: center;
      /* ê°€ìš´ë° ê¸°ì¤€ìœ¼ë¡œ ì˜ë¼ì„œ í‘œì‹œ */
      filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.45));
      display: none;
      /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€, ìºë¦­í„° ì„ íƒ ì‹œ JSì—ì„œ blockìœ¼ë¡œ ë³€ê²½ */
    }

    /* â–¼ í•˜ë‹¨ 4ê°œ ìŠ¬ë¡¯ */
    .mini-bar {
      align-self: start;
      /* ê·¸ë¦¬ë“œ ì¹¸ì—ì„œ ìœ„ìª½ì— ë¶™ì„ */
      /*margin-top: 10px;*/
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    /* ìºë¦­í„° ë°”ë¡œ ì•„ë˜ë¡œ, ì ë‹¹í•œ ê°„ê²© ë‘ê³  ê°€ìš´ë° ì •ë ¬ */
    .center .mini-bar {
      align-self: center;
      /* ì™¼ìª½ ë§ê³  ê°€ìš´ë° */
      margin-top: 25px;
      /* ìºë¦­í„°ì™€ì˜ ê°„ê²© */
      margin-bottom: 8px;
      /* ì•„ë˜ save-boxì™€ ê±°ë¦¬ (ì›í•˜ë©´ ì¡°ì ˆ) */
    }

    .mini-cell {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .slot.mini {
      width: clamp(64px, 10vh, 120px);
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      flex: 0 0 auto;
    }

    /*slotí´ë˜ìŠ¤ì™€ minií´ë˜ìŠ¤ ë™ì‹œì— ì ìš©í•˜ë©° ê·¸ ë‘ í´ë˜ìŠ¤ì˜ ìì†í´ë˜ìŠ¤ê°€ slot-labelì´ ëœë‹¤.*/
    .slot.mini .slot-label {
      position: absolute;
      top: 50%;
      left: 50%;
      bottom: auto;
      transform: translate(-50%, -50%);
      white-space: nowrap;
      max-width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      z-index: 50;
    }

    .modal.show {
      display: grid;
    }

    .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(2px);
    }

    .dialog {
      position: relative;
      width: min(1100px, 95vw);
      height: min(720px, 92vh);
      background: #0e0b09;
      border: 1px solid #2a211a;
      border-radius: 18px;
      padding: 12px 14px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
    }


    /*headerì™€ h2ëŠ” dialogì˜ ìì†íƒœê·¸ë“¤ì´ë‹¤. íƒœê·¸ëŠ” ì“°ë ¤ë©´ <header> </header>ì„ ì¨ì•¼í•œë‹¤.
//ì´ ì½”ë“œë§Œ ë³´ê³ ëŠ” ì¢…ì†ê´€ê³„ë¥¼ ì•Œìˆ˜ëŠ” ì—†ë‹¤. headerê°€ ë” ë†’ì€ì§€, h2ê°€ ë†’ì€ì§€ ì•Œìˆ˜ì—†ë‹¤. */
    .dialog header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 6px 4px 8px;
      border-bottom: 1px solid #2a211a;
    }

    .dialog h2 {
      margin: 0;
      margin-left: 20px;
      font-size: 23px;
      font-weight: 700;
      color: #f0e6d2;
    }

    #skillTreeModal .modal-foot {
      display: flex;
      gap: 8px;
    }

    .input {
      height: 34px;
      border-radius: 10px;
      border: 1px solid #3a2c21;
      padding: 0 10px;
      background: #1a130f;
      color: #f0e6d2;
    }

    /* ìºë¦­í„° ì¹´íƒˆë¡œê·¸ */
    .catalog {
      overflow: auto;
      padding: 10px 6px 14px;
    }

    .row {
      display: grid;
      grid-template-columns: 56px 1fr 56px;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .badge-img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      background: #20170f;
      border: 2px solid #6e5124;
    }

    .cards {
      /* ì¹´ë“œì˜ ìŠ¤íƒ€ì¼ */
      display: grid;
      /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ë°°ì¹˜*/
      grid-template-columns: repeat(5, minmax(160px, 1fr));
      /* ê°€ë¡œì¹¸(columns) 4ê°œ, ê°ì¹¸ì€ ìµœì†Œ 160px, ìµœëŒ€ 1fr(=ë‚¨ëŠ” ê³µê°„ ê· ë“± ë¶„ë°°) í¬ê¸° */
      gap: 12px;
      /*ì¹´ë“œë“¤ ì‚¬ì´ ê°€ë¡œ/ì„¸ë¡œ ê°„ê²© */
    }

    .char-card {
      position: relative;
      display: grid;
      grid-template-rows: auto auto;
      /*ì„¸ë¡œë¡œ 2ì¤„ ê·¸ë¦¬ë“œ (ì²«ì¤„ ì´ë¯¸ì§€, ë‘ë²ˆì§¸ì¤„ ì´ë¦„*/
      gap: 6px;
      /* ì¤„ ì‚¬ì´ 6px ê°„ê²© */
      padding: 8px;
      /* ì•ˆìª½ ì—¬ë°± */
      border-radius: 12px;
      background: var(--card-bg);
      cursor: pointer;
      /*ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì†ê°€ë½ ëª¨ì–‘*/
      border: 1px solid var(--gold-2);
      /* ì¹´ë“œ í…Œë‘ë¦¬ (ê¸ˆìƒ‰ ê³„ì—´ ë³€ìˆ˜) */
    }

    .char-card:hover {
      /*ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ë•Œ íš¨ê³¼ */
      box-shadow: inset 0 0 0 2px rgba(207, 162, 79, 0.22), 0 8px 22px rgba(0, 0, 0, 0.55);
    }

    .char-card.disabled {
      filter: grayscale(1) saturate(0) brightness(.8);
      opacity: .6;
      cursor: not-allowed;
    }

    .char-card.disabled:hover {
      box-shadow: none;
      /* í˜¸ë²„ íš¨ê³¼ ì œê±° */
    }

    .char-card.disabled .char-img {
      filter: grayscale(1) contrast(.9);
    }

    .char-img {
      width: 100%;
      /* ë¶€ëª¨ ì¹´ë“œì˜ ê°€ë¡œí­ì„ ì „ë¶€ ì°¨ì§€ */
      aspect-ratio: 16/7;
      /* ê°€ë¡œ:ì„¸ë¡œ ë¹„ìœ¨ 16:7 ìœ ì§€ */
      object-fit: cover;
      /* ì´ë¯¸ì§€ ì˜ë¦¬ë”ë¼ë„ ì˜ì—­ ê½‰ ì±„ì›€ */
      border-radius: 8px;
      border: 1px solid rgba(207, 162, 79, 0.35);
      background: #0c0a08;
    }

    .char-name {
      font-size: 14px;
      color: #f0e6d2;
      font-weight: 700;
    }

    /* ë¬´ê¸° íƒ­ */
    .weapon-tabs {
      display: flex;
      gap: 8px;
      margin: 0 10px;
      flex-wrap: wrap
    }

    .weapon-tabs .tab-btn {
      height: 30px;
      padding: 0 12px;
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid #3a2c21;
      background: #1a130f;
      color: #c7b589
    }

    .weapon-tabs .tab-btn.active {
      background: #2a211a;
      border-color: #cfa24f;
      color: #f0e6d2;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .25) inset
    }

    /* ë§ˆë²•ë´‰ì¸ ëª¨ë‹¬ ì•ˆì—ì„œëŠ” .items ìŠ¤í¬ë¡¤ ë” */
    #sealModal .items {
      overflow: visible;
      /* ë˜ëŠ” overflow: hidden; ìœ¼ë¡œ í•´ë„ ë¬´ë°© */
    }

    /* ì¼ë°˜ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ë§Œ ìŠ¤í¬ë¡¤ */
    #sealListGeneral1 {
      max-height: calc(88vh - 220px);
      /* í•„ìš”í•˜ë©´ ìˆ«ì ì¡°ì ˆ */
      overflow-y: auto;
    }

    /*overflowëŠ” ìš”ì†Œí¬ê¸°ë³´ë‹¤ ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ë¥¼ ë‚˜íƒ€ëƒ„
//autoëŠ” ìë™ ìŠ¤í¬ë¡¤ë°” ìƒê¹€, visibleì€ ê·¸ëƒ¥ ë°–ìœ¼ë¡œ ì‚ì ¸ë‚˜ì˜´, hiddenì€ ë„˜ì¹˜ëŠ” ë¶€ë¶„ ì˜ë¼ëƒ„, scrollì€ í•­ìƒ ìŠ¤í¬ë¡¤ë°” í‘œì‹œ */
    /* ë¦¬ìŠ¤íŠ¸í˜• ì¹´ë“œ */
    .items {
      overflow: auto;
      padding: 12px 8px 16px;
      display: grid;
      gap: 14px;
    }

    .item-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(280px, 1fr));
      gap: 12px
    }

    .item-row {
      display: grid;
      grid-template-columns: 72px 1fr 64px;
      align-items: center;
      gap: 12px;
      background: #15100c;
      border: 1px solid #3a2c21;
      border-radius: 12px;
      padding: 10px;
      cursor: pointer
    }

    .item-row:hover {
      border-color: #7c5b37;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .25) inset
    }

    .item-row.is-auto { outline: 2px solid rgba(37, 99, 235, .6); }
    #customOptModal .opt-btn.is-auto { outline: 2px dashed rgba(22,163,74,.85); }


    .iconbox {
      position: relative;
      width: 64px;
      height: 64px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(207, 162, 79, .35);
      background: #0c0a08
    }

    .iconbox .icon {
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    .badge-lv {
      position: absolute;
      left: 4px;
      top: 4px;
      font-size: 11px;
      padding: 2px 5px;
      border-radius: 6px;
      background: #1e2b1e;
      color: #9fe19f;
      border: 1px solid #254c25
    }

    .meta .meta-top {
      display: flex;
      align-items: baseline;
      gap: 8px
    }

    .meta .lvl {
      color: #9fe19f;
      font-weight: 700;
      font-size: 13px
    }

    .meta .name {
      color: #f0e6d2;
      font-weight: 800;
      font-size: 15px
    }

    .meta-sub {
      color: #c7b589;
      font-size: 12px;
      margin-top: 4px
    }

    /* ê³µí†µ ë ˆì–´ë¦¬í‹° ì¹© ë² ì´ìŠ¤ */
    .rarity-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 64px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .25px;
      text-align: center;
      /* ê¸€ì ë¹› */
      text-shadow:
        0 0 3px rgba(0, 0, 0, .9),
        0 0 8px rgba(0, 0, 0, .9);
      /* ê¸°ë³¸ ì•ˆìª½ ê·¸ë¦¼ì */
      box-shadow:
        0 0 0 1px rgba(0, 0, 0, .6),
        0 0 16px rgba(0, 0, 0, .55) inset;
      overflow: hidden;
      transition:
        transform .15s ease,
        box-shadow .15s ease,
        filter .15s ease;
    }

    /* ì¹© ìƒë‹¨ í•˜ì´ë¼ì´íŠ¸ */
    .rarity-chip::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at 50% 0%,
          rgba(255, 255, 255, .24),
          transparent 60%);
      mix-blend-mode: screen;
      opacity: .85;
      pointer-events: none;
    }

    /* í˜¸ë²„ ì‹œ ì‚´ì§ ë– ì˜¤ë¥´ëŠ” ëŠë‚Œ */
    .item-row:hover .rarity-chip {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    /* ì—í”½ : ë…¸ë€ìƒ‰ ê³„ì—´ */
    .rarity-chip.rarity-epic {
      border: 1px solid #cfa24f;
      background:
        linear-gradient(135deg, #4b320f, #2a211a 45%, #1a130a 100%);
      color: #ffe9ac;
      box-shadow:
        0 0 12px rgba(207, 162, 79, .7),
        0 0 0 1px rgba(0, 0, 0, .85) inset;
    }


    /* ìµì‹œë“œ : í‘¸ë¥¸ìƒ‰ ê³„ì—´ */
    .rarity-chip.rarity-exceed {
      border: 1px solid #3b82f6;
      background:
        linear-gradient(135deg, #0b1024, #111827 45%, #020617 100%);
      color: #dbeafe;
      box-shadow:
        0 0 14px rgba(59, 130, 246, .7),
        0 0 0 1px rgba(15, 23, 42, .9) inset;
    }


    /* ë ˆì–´ : ë³´ë¼ìƒ‰ ê³„ì—´ */
    .rarity-chip.rarity-rare {
      border: 1px solid #8b5cf6;
      background:
        linear-gradient(135deg, #1b1033, #20113f 45%, #140826 100%);
      color: #f5e9ff;
      box-shadow:
        0 0 14px rgba(139, 92, 246, .7),
        0 0 0 1px rgba(12, 10, 24, .9) inset;
    }


    /* ìœ ë‹ˆí¬ : ìì£¼ìƒ‰ ê³„ì—´ */
    .rarity-chip.rarity-unique {
      border: 1px solid #ec4899;
      background:
        linear-gradient(135deg, #3b081e, #4a1029 45%, #220212 100%);
      color: #ffe4f5;
      box-shadow:
        0 0 14px rgba(236, 72, 153, .75),
        0 0 0 1px rgba(15, 6, 10, .9) inset;
    }



    /* === Options panel (ìš°ì¸¡ ì˜µì…˜ ì—´) === */
    .column.options {
      align-items: stretch;
      /* ë„ˆë¹„ ê½‰ ì°¨ê²Œ */
      gap: 12px;
    }

    .opt-box {
      width: 100%;
      border-radius: 14px;
      padding: 12px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: grid;
      gap: 10px;
    }

    .opt-title {
      margin: 0 0 2px;
      font-size: 13px;
      font-weight: 800;
      color: #f0e6d2;
      letter-spacing: .2px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field .label {
      font-size: 11px;
      color: var(--muted);
    }

    /* ë¼ë²¨ + ì •ë³´ ì•„ì´ì½˜ ì¤„ ë°°ì¹˜ */
    .label-with-tip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    /* â“˜ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
    .info-tip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 11px;
      height: 11px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.28);
      background: rgba(0, 0, 0, 0.45);
      font-size: 8px;
      color: var(--muted);
      cursor: help;
      flex-shrink: 0;
    }

    .info-tip:hover {
      border-color: var(--accent);
      color: #fff;
      box-shadow: 0 0 0 1px rgba(110, 168, 255, 0.35);
    }


    /* íˆ´íŒ ë³¸ë¬¸ */
    .info-tip-content {
      position: absolute;
      top: 50%;
      left: 100%;
      transform: translateX(14px) translateY(-50%);
      background: var(--panel);
      color: var(--text);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      padding: 8px 10px;
      font-size: 11px;
      line-height: 1.4;

      white-space: normal;
      z-index: 50;

      /* ğŸ”½ í­ ê´€ë ¨ ë‹¤ ì—†ì• ê³  ì´ê±¸ë¡œ í†µì¼ */
      display: inline-block;
      /* ë‚´ìš© ê¸¸ì´ë§Œí¼ë§Œ ë°•ìŠ¤ í¬ê¸° */
      white-space: nowrap;
      /* ìë™ ì¤„ë°”ê¿ˆ X, <br> ë§Œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì¸ì • */

      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease, transform 0.15s ease;
    }

    .info-tip:hover .info-tip-content {
      opacity: 1;
      transform: translateX(5%) translateY(-50%);
      pointer-events: auto;
    }

    /* ì¥ë¹„ ì„¤ëª… / í•©ì‚° ìŠ¤íƒ¯ í—¤ë” ì „ìš©: íˆ´íŒì„ ì•„ë˜ë¡œ ë„ìš°ê¸° */
    .info-tip.info-tip-bottom .info-tip-content {
      top: 100%;
      /* ì•„ë˜ìª½ìœ¼ë¡œ */
      bottom: auto;
      /* ìœ„ìª½ ê¸°ì¤€ ì œê±° */
      left: 50%;
      /* ê°€ìš´ë° ì •ë ¬ */
      right: auto;
      transform: translate(-50%, 8px);
      /* ì•½ê°„ ì•„ë˜ë¡œ ê°„ê²© */
    }

    .select {
      height: 34px;
      border-radius: 10px;
      border: 1px solid #3a2c21;
      padding: 0 10px;
      background: #1a130f;
      color: #f0e6d2;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .select:focus {
      border-color: #cfa24f;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .25) inset;
    }

    /* â“˜ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´, í•´ë‹¹ í•­ëª©ì˜ select ë°•ìŠ¤ í•˜ì´ë¼ì´íŠ¸ */
    label.field:has(.info-tip:hover) .select {
      border-color: #fbbf24;
      box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.45);
    }

    /* ìµœì¢…ë°ë¯¸ì§€ â“˜ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ 'ê³„ì‚°í•˜ê¸°' ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸ */
    section.layout:has(.final-damage .info-tip:hover) #btn-sum-all-final,
    section.layout:has(.final-damage .info-tip:hover) #btn-sum-all-final2 {
      border-color: #fbbf24;
      box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.45);
    }

    /*@ëŠ” ëª¨ë°”ì¼ ì „í™˜ì‹œ ì‚¬ìš©í•˜ëŠ” ë¶€í˜¸. ì •í™•íˆëŠ” í­ì´ ì¢ì•„ì§€ë©´.
    /* ëª¨ë°”ì¼ 1ì—´ ì „í™˜ ì‹œ ìì—°ìŠ¤ëŸ½ê²Œ íë¥´ë„ë¡(ê¸°ì¡´ ê·œì¹™ ìœ ì§€) */
    @media (max-width: 900px) {
      .column.options {
        order: 3;
      }

      /* ì¤‘ì•™/ì˜¤ë¥¸ìª½ ë‹¤ìŒì— ìœ„ì¹˜ */
    }

    /* â–¶ í•©ì‚° íŒ¨ë„ (ìš°ì¸¡ ê³ ì • + ìµœì¢…ë°ë¯¸ì§€) */
    aside.stats {
      align-self: start;
      /* ê·¸ë¦¬ë“œ ì•ˆì—ì„œ ìœ„ìª½ ì •ë ¬ */
      width: 100%;
      position: static;
      /* ê¸°ë³¸ íë¦„ìœ¼ë¡œ */
      top: auto;
      /* sticky ê¸°ì¤€ ì œê±° */
      height: 100%;
      /* ë¶ˆí•„ìš”í•œ 100% ë†’ì´ ì œê±° */
    }

    .stats-panel {
      width: 100%;
      height: 890px;
      border-radius: 18px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: grid;
      /* 1í–‰: ì„±ì•ˆ(ìë™) / 2í–‰: ì¥ë¹„ì„¤ëª…Â·í•©ì‚°ìŠ¤íƒ¯(1fr) / 3í–‰: ìµœì¢…ë°ë¯¸ì§€(ìë™) */
      grid-template-rows: auto 1fr auto;
      gap: 10px;
    }

    /* í•©ì‚°ìŠ¤íƒ¯ ê°€ìš´ë° ì˜ì—­ (ì¥ë¹„ì„¤ëª… / í•©ì‚°ìŠ¤íƒ¯) */
    .stats-main {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      /* flex ë‚´ë¶€ì—ì„œ ìŠ¤í¬ë¡¤ ë˜ë„ë¡ */
    }

    .stats-panel h3 {
      margin: 4px 0 0;
      font-size: 14px;
      color: #f0e6d2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .stats-toggle-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 12px;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .stats-toggle-btn:hover {
      background: rgba(148, 163, 184, 0.25);
    }



    /* ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ë°•ìŠ¤ */
    .stat-preview {
      flex: 1;
      min-height: 0;
      overflow-y: auto;

      padding: 6px 8px;
      margin-bottom: 0;
      /* ì•„ë˜ìª½ ì—¬ë°±ì€ stats-main gapìœ¼ë¡œ ì²˜ë¦¬ */
      font-size: 12px;
      line-height: 1.5;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);

      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
    }


    .stat-preview-empty {
      color: #9ca3af;
      font-style: italic;
    }

    .stat-preview-line {
      margin-bottom: 10px;
    }

    .stat-preview-line .slot-tag {
      display: inline-block;
      margin-bottom: 4px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(148, 163, 184, 0.35);
      color: #e5e7eb;
      font-size: 11px;
      /* ë¼ë²¨ ê¸€ì í¬ê¸° */
      font-weight: 600;
    }

    .stat-preview-line .desc-text {
      font-size: 11px;
      /* ì„¤ëª… ê¸€ì í¬ê¸° */
      line-height: 1.7;
      /* ì¤„ ê°„ê²© ì—¬ìœ  ìˆê²Œ */
      color: #e5e7eb;
      white-space: pre-line;
      /* ì„¤ëª…ì— ì¤„ë°”ê¿ˆ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚´ë¦¬ê¸° */
    }

    /* ì»¤ìŠ¤í…€ì˜µ ë¼ë²¨ ì „ìš© ìƒ‰ìƒ */
    .stat-preview-line .slot-tag.custom-tag {
      border: 1px solid transparent;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.45);
    }

    /* ë¹¨ê°„ ê³„ì—´: ë¶„ì‡„ / ì„ ë´‰ */
    .stat-preview-line .slot-tag.custom-tag.tag-red {
      border-color: #f97373;
      background: rgba(248, 113, 113, 0.15);
      color: #fecaca;
    }

    /* ì´ˆë¡ ê³„ì—´: ì„ ëª… / ì´ìƒ */
    .stat-preview-line .slot-tag.custom-tag.tag-green {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.15);
      color: #bbf7d0;
    }

    /* íŒŒë€ ê³„ì—´: ì˜ì§€ / ê´‘ì±„ */
    .stat-preview-line .slot-tag.custom-tag.tag-blue {
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.15);
      color: #e0f2fe;
    }

    /* ë…¸ë€ ê³„ì—´: ê°•íƒ€ */
    .stat-preview-line .slot-tag.custom-tag.tag-yellow {
      border-color: #facc15;
      background: rgba(250, 204, 21, 0.15);
      color: #facc15;
    }

    /* ê¸°íƒ€/ê¸°ë³¸ */
    .stat-preview-line .slot-tag.custom-tag.tag-neutral {
      border-color: var(--line);
      background: rgba(148, 163, 184, 0.35);
      color: #e5e7eb;
    }

    /* âœ… ì¹´í…Œê³ ë¦¬ ë¼ë²¨ ìƒ‰ìƒ (ê³ ìœ íš¨ê³¼(custom-tag)ì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ ë¶„ë¦¬) */
.stat-preview-line .slot-tag.slot-armor:not(.custom-tag) {
  border: 1px solid rgba(168, 85, 247, 0.55);
  background: rgba(168, 85, 247, 0.16); /* ë³´ë¼ */
  color: #f3e8ff;
}

.stat-preview-line .slot-tag.slot-acc:not(.custom-tag) {
  border: 1px solid rgba(249, 115, 22, 0.55);
  background: rgba(249, 115, 22, 0.16); /* ì£¼í™© */
  color: #ffedd5;
}

.stat-preview-line .slot-tag.slot-spec:not(.custom-tag) {
  border: 1px solid rgba(236, 72, 153, 0.55);
  background: rgba(236, 72, 153, 0.16); /* í•‘í¬ */
  color: #fce7f3;
}


    .stat-list {
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding-right: 6px;
      display: grid;
      gap: 8px;
      overflow-y: auto;
      /* ë‚´ìš© ë§ìœ¼ë©´ ì•ˆìª½ì—ì„œ ìŠ¤í¬ë¡¤ */
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      padding: 8px 10px;
    }

    .stat-label {
      color: var(--muted);
      font-size: 12px;
    }

    .stat-value {
      color: #e8edd6;
      font-weight: 800;
      font-size: 14px;
      text-align: right;
    }

    .final-damage {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 6px;
    }

    .final-damage .label {
      color: #f0e6d2;
      font-size: 13px;
      line-height: 1;
      text-align: left;
    }

    .final-damage .value {
      color: #ff5a6a;
      font-weight: 900;
      font-size: 25px;
      letter-spacing: .3px;
      line-height: 1.15;
      align-self: flex-end;
      text-align: right;
    }

    /* #ì€ ê³ ìœ  idë¥¼ ëœ»í•œë‹¤. í´ë˜ìŠ¤ì™€ ë‹¤ë¥¸ì ì€ ê³ ìœ í•˜ê¸°ë•Œë¬¸ì— ë‹¨í•œë²ˆë§Œ ì‚¬ìš©í•œë‹¤ëŠ” ì°¨ì´ê°€ ìˆìŒ */
    /* ê°•í™” ì„ íƒ ëª¨ë‹¬(í…ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸) */
    #enhanceModal .dialog {
      width: min(320px, 95vw);
      height: min(520px, 85vh);
    }


    .enh-list {
      overflow: auto;
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    /* ë§ˆë²•ë¶€ì—¬ ëª¨ë‹¬ ì•ˆì—ì„œë§Œ: ë¦¬ìŠ¤íŠ¸ê°€ ê¸¸ì–´ì§ˆ ë•Œë§Œ ìŠ¤í¬ë¡¤ */
#enchantModal .enh-list {
  max-height: 60vh;   /* í™”ë©´ ë†’ì´ì˜ 60%ë¥¼ ë„˜ìœ¼ë©´ ê·¸ ì´ìƒì€ ìŠ¤í¬ë¡¤ */
  overflow-y: auto;
}

    .enh-option {
      height: 36px;
      padding: 0 12px;
      text-align: left;
      border-radius: 10px;
      border: 1px solid #3a2c21;
      background: #1a130f;
      color: #f0e6d2;
      cursor: pointer;
    }

    .enh-option:hover {
      border-color: #cfa24f;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .25) inset;
    }

    
/* ë§ˆë²•ë¶€ì—¬ ì„ íƒ ëª¨ë‹¬(í…ìŠ¤íŠ¸ ë¦¬ìŠ¤íŠ¸) - ê³µí†µ dialog ë ˆì´ì•„ì›ƒ ì™„ì „ ë®ì–´ì“°ê¸° */
#enchantModal .dialog {
  width: min(420px, 95vw);

  /* ê³µí†µ .dialogì˜ height: min(720px,92vh) ë®ì–´ì“°ê¸° */
  height: auto;
  min-height: 0;
  max-height: none;

  /* ê³µí†µ .dialogì˜ grid ë ˆì´ì•„ì›ƒë„ ë„ê¸° */
  display: block;
}

/* í•„ìš”í•˜ë©´ ì•½ê°„ì˜ ì—¬ë°± ì •ë„ë§Œ */
#enchantModal .items {
  margin-top: 8px;
}

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        grid-auto-rows: max-content;
        gap: 18px;
        height: auto;
        overflow: auto;
      }

      .cards,
      .item-list {
        grid-template-columns: repeat(2, 1fr);
      }

      .row {
        grid-template-columns: 40px 1fr 40px;
      }

      .badge-img {
        width: 40px;
        height: 40px;
      }

      aside.stats {
        position: static;
      }
    }

    /* â”€â”€â”€â”€â”€ ìë™ ê´€ë ¨ ëª¨ë‹¬ë“¤ â”€â”€â”€â”€â”€ */
    .auto-box {
      width: 240px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
      margin-bottom: 2px;
    }

    .auto-box h4 {
      margin: 0 0 8px;
      font-size: 14px;
      color: #e7c27a;
    }

    .btnetc {
      /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤ ... */
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .auto-box .btnetc {
      width: 100%;
      height: 34px;
      border-radius: 10px;
      border: 1px solid #3a2c21;
      background: #1a130f;
      color: #f0e6d2;
      cursor: pointer;
    }

    .auto-box:has(h4 .info-tip:hover) .btnetc {
      border-color: #fbbf24;
      box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.45);
    }

    .auto-box .btnetc:hover {
      border-color: #cfa24f;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .25) inset;
    }

    .auto-box .btnetc[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }

    /* â”€â”€â”€â”€â”€ ê¸°ë³¸ ëª¨ë‹¬ í¬ê¸° ì¡°ì • â”€â”€â”€â”€â”€ */
    .dialogetc {
      position: relative;
      background: #0e0b09;
      border: 1px solid #2a211a;
      border-radius: 18px;
      padding: 12px 14px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
    }

    #autoEnhModal .dialogetc {
      width: min(300px, 95vw);
      height: min(720px, 92vh);
    }

    #autoSealModal .dialogetc {
      width: min(550px, 95vw);
      height: min(250px, 85vh);
    }

    #autoEnchantModal .dialogetc {
      width: min(1000px, 96vw);
      height: min(250px, 85vh);
    }

    #autoEmblemModal .dialogetc {
      width: min(1200px, 96vw);
      /* âœ… 5~10 (6ê°œ) 1ì¤„ë„ ì—¬ìœ  */
      height: min(400px, 90vh);
      /* âœ… ë‘ ì¤„ êµ¬ì¡°ì— ë§ê²Œ ë†’ì´ ì¡°ì • */
    }

    #castleSealModal .dialogetc {
      width: min(870px, 95vw);
      height: min(770px, 92vh);
    }

    #refineModal .dialogetc {
      width: min(300px, 95vw);
      height: min(680px, 92vh);
    }

    /* ìƒì˜ ì»¤ìŠ¤í…€ ì˜µì…˜ ëª¨ë‹¬ ê°€ë¡œí­ */
    #armorCustomOptModal .dialogetc,
    #braceletCustomOptModal .dialogetc,
    #earringCustomOptModal .dialogetc {
      width: min(500px, 95vw);
      /* ìˆ«ìë§Œ ì¡°ì ˆí•´ì„œ ì›í•˜ëŠ” ë§Œí¼ ë„“íˆë©´ ë¨ */
    }

    /* ê¸°ë³¸ ì»¬ëŸ¼ ì¤‘ì•™ ì •ë ¬ */
    .cols {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 14px;
    }

    /* â”€â”€â”€â”€â”€ ê¸°ë³¸ ì†Œì œëª© ì¡°ì • â”€â”€â”€â”€â”€ */
    .cols .titles {
      margin-bottom: 12px;
      font-size: 16px;
      font-weight: 700;
      color: #e7c27a;
      text-align: center;
    }

    #autoSealModal .cols .titles {
      margin-bottom: 12px;
      font-size: 16px;
      font-weight: 700;
      color: #e7c27a;
      text-align: center;
    }

    /* íƒ€ì´í‹€ ì—¬ë°±/ìŠ¤íƒ€ì¼ë„ ê°•í™”ì„¤ì • ëª¨ë‹¬ê³¼ í†¤ì„ ë§ì¶¤ */
    #autoEnchantModal .cols .titles {
      margin-bottom: 12px;
      font-size: 16px;
      font-weight: 700;
      color: #e7c27a;
      text-align: center;
    }

    /* â”€â”€â”€â”€â”€ ê¸°ë³¸ ë²„íŠ¼ë¦¬ìŠ¤íŠ¸ ì¡°ì • â”€â”€â”€â”€â”€ */
    .cols .lists {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }

    #refineModal .cols .lists {
      flex-direction: column;
    }

    #autoSealModal .cols .lists {
      align-items: center;
    }

    #autoSealModal .cols {
      display: flex;
      flex-direction: column;
      /* ì„¸ë¡œë¡œ ìŒ“ì´ê²Œ */
      align-items: center;
      width: 100%;
    }

    #autoEnchantModal .cols .lists {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }

    #castleSealModal .cols .lists {
      flex-direction: column;
    }

    #autoEnhModal .cols .lists {
      flex-direction: column;
    }

    #autoEmblemModal .lists.attrs,
    #autoEmblemModal .lists.tiers {
      display: flex;
      flex-direction: column;
      /* ê° í–‰(row)ì„ ì„¸ë¡œë¡œ ìŒ“ê¸° */
      align-items: center;
      /* í–‰ ìì²´ë¥¼ ì¤‘ì•™ ë°°ì¹˜ */
      row-gap: 1px;
    }

    #autoEmblemModal .lists.attrs .row,
    #autoEmblemModal .lists.tiers .row {
      display: flex;
      justify-content: center;
      /* í–‰ ì•ˆì˜ ë²„íŠ¼ì„ ì¤‘ì•™ ì •ë ¬ */
      row-gap: 6px;
      flex-wrap: nowrap;
      /* ì •í™•íˆ 1ì¤„ ìœ ì§€ */
    }

    /* â”€â”€â”€â”€â”€ ì»¤ìŠ¤í…€ì˜µ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ â”€â”€â”€â”€â”€ */
    #customOptModal .body {
      padding: 10px 6px 4px;
    }

    #customOptModal .titles {
      font-size: 13px;
      margin-bottom: 6px;
      color: var(--muted);
    }

    #customOptModal .list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      padding: 8px;
    }

    #customOptModal .opt-btn {
      min-width: 90px;
    }

    #customOptModal .opt-btn.active {
      border-color: #6ea8ff;
      box-shadow: 0 0 0 2px rgba(110, 168, 255, .3) inset;
    }

    /* â”€â”€â”€â”€â”€ ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ â”€â”€â”€â”€â”€ */
    /* ê°•íƒ€: ë…¸ë€ìƒ‰ ê³„ì—´ */
    #customOptModal .opt-btn[data-value="ê°•íƒ€"] {
      border-color: #facc15;
      /* ë…¸ë€ ê²½ê³„ */
      background: rgba(250, 204, 21, 0.08);
      color: #facc15;
    }

    #customOptModal .opt-btn[data-value="ê°•íƒ€"].active {
      background: rgba(250, 204, 21, 0.18);
      box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.35) inset;
    }

    /* ê´‘ì±„: íŒŒë€ìƒ‰ ê³„ì—´ */
    #customOptModal .opt-btn[data-value="ê´‘ì±„"] {
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.08);
      color: #38bdf8;
    }

    #customOptModal .opt-btn[data-value="ê´‘ì±„"].active {
      background: rgba(56, 189, 248, 0.18);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.35) inset;
    }

    /* ë¶„ì‡„: ë¹¨ê°„ìƒ‰ ê³„ì—´ */
    #customOptModal .opt-btn[data-value="ë¶„ì‡„"] {
      border-color: #f97373;
      background: rgba(248, 113, 113, 0.08);
      color: #f97373;
    }

    #customOptModal .opt-btn[data-value="ë¶„ì‡„"].active {
      background: rgba(248, 113, 113, 0.18);
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.35) inset;
    }

    /* ì„ ëª…: ì´ˆë¡ìƒ‰ ê³„ì—´ */
    #customOptModal .opt-btn[data-value="ì„ ëª…"] {
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.08);
      color: #4ade80;
    }

    #customOptModal .opt-btn[data-value="ì„ ëª…"].active {
      background: rgba(74, 222, 128, 0.18);
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.35) inset;
    }

    /* ì—†ìŒ: ê¸°ë³¸ ì¤‘ë¦½ ìŠ¤íƒ€ì¼(ì›ë˜ opt-btn ìŠ¤íƒ€ì¼ ìœ ì§€, í•„ìš”í•˜ë©´ ì‚´ì§ í†¤ ë‹¤ìš´) */
    #customOptModal .opt-btn[data-value="ì—†ìŒ"] {
      opacity: 0.9;
    }

    /* ===== ìƒì˜ ì „ìš© ì»¤ìŠ¤í…€ì˜µ ëª¨ë‹¬ ===== */
    #armorCustomOptModal .opt-btn,
    #braceletCustomOptModal .opt-btn,
    #earringCustomOptModal .opt-btn {
      min-width: 90px;
    }

    #armorCustomOptModal .opt-btn.active,
    #braceletCustomOptModal .opt-btn.active,
    #earringCustomOptModal .opt-btn.active {
      border-color: #6ea8ff;
      box-shadow: 0 0 0 2px rgba(110, 168, 255, .3) inset;
    }

    /* ì˜ì§€: ê´‘ì±„ì™€ ê°™ì€ íŒŒë€ìƒ‰ ê³„ì—´ */
    #armorCustomOptModal .opt-btn[data-value="ì˜ì§€"],
    #braceletCustomOptModal .opt-btn[data-value="ì˜ì§€"],
    #earringCustomOptModal .opt-btn[data-value="ì˜ì§€"] {
      border-color: #38bdf8;
      /* ê´‘ì±„ì™€ ë™ì¼ */
      background: rgba(56, 189, 248, 0.08);
      color: #38bdf8;
    }

    #armorCustomOptModal .opt-btn[data-value="ì˜ì§€"].active,
    #braceletCustomOptModal .opt-btn[data-value="ì˜ì§€"].active,
    #earringCustomOptModal .opt-btn[data-value="ì˜ì§€"].active {
      background: rgba(56, 189, 248, 0.18);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.35) inset;
    }

    /* ì„ ë´‰: ë¶„ì‡„ì™€ ê°™ì€ ë¹¨ê°„ìƒ‰ ê³„ì—´ */
    #armorCustomOptModal .opt-btn[data-value="ì„ ë´‰"],
    #braceletCustomOptModal .opt-btn[data-value="ì„ ë´‰"],
    #earringCustomOptModal .opt-btn[data-value="ì„ ë´‰"] {
      border-color: #f97373;
      /* ë¶„ì‡„ì™€ ë™ì¼ */
      background: rgba(248, 113, 113, 0.08);
      color: #f97373;
    }

    #armorCustomOptModal .opt-btn[data-value="ì„ ë´‰"].active,
    #braceletCustomOptModal .opt-btn[data-value="ì„ ë´‰"].active,
    #earringCustomOptModal .opt-btn[data-value="ì„ ë´‰"].active {
      background: rgba(248, 113, 113, 0.18);
      box-shadow: 0 0 0 2px rgba(248, 113, 113, 0.35) inset;
    }

    /* ì´ìƒ: ì„ ëª…ê³¼ ê°™ì€ ì´ˆë¡ìƒ‰ ê³„ì—´ */
    #armorCustomOptModal .opt-btn[data-value="ì´ìƒ"],
    #braceletCustomOptModal .opt-btn[data-value="ì´ìƒ"],
    #earringCustomOptModal .opt-btn[data-value="ì´ìƒ"] {
      border-color: #4ade80;
      /* ì„ ëª…ê³¼ ë™ì¼ */
      background: rgba(74, 222, 128, 0.08);
      color: #4ade80;
    }

    #armorCustomOptModal .opt-btn[data-value="ì´ìƒ"].active,
    #braceletCustomOptModal .opt-btn[data-value="ì´ìƒ"].active,
    #earringCustomOptModal .opt-btn[data-value="ì´ìƒ"].active {
      background: rgba(74, 222, 128, 0.18);
      box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.35) inset;
    }

    /* ì—†ìŒ: ê¸°ë³¸ ì¤‘ë¦½ ìŠ¤íƒ€ì¼ (ì‚´ì§ í†¤ ë‹¤ìš´) */
    #armorCustomOptModal .opt-btn[data-value="ì—†ìŒ"],
    #braceletCustomOptModal .opt-btn[data-value="ì—†ìŒ"],
    #earringCustomOptModal .opt-btn[data-value="ì—†ìŒ"] {
      opacity: 0.9;
      /* customOptModal ì˜ 'ì—†ìŒ'ê³¼ ë™ì¼ ëŠë‚Œ */
    }

    /* ìƒì˜ ì»¤ìŠ¤í…€ì˜µ ëª¨ë‹¬: ë²„íŠ¼ë“¤ì„ ê°€ë¡œ í•œ ì¤„ë¡œ ë°°ì¹˜ */
    #armorCustomOptModal #armorCustomOptList,
    #braceletCustomOptModal #braceletCustomOptList,
    #earringCustomOptModal #earringCustomOptList {
      display: flex;
      /* ê³µí†µ .listì˜ grid ëŒ€ì‹  flexë¡œ ë®ì–´ì“°ê¸° */
      flex-wrap: nowrap;
      /* ì¤„ë°”ê¿ˆ ì—†ì´ í•œ ì¤„ */
      gap: 8px;
      /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
      justify-content: space-between;
      /* í•„ìš”ì— ë”°ë¼ center/space-around ë¡œ ì¡°ì ˆ ê°€ëŠ¥ */
    }


    /* ----- ì œëª© ëª¨ì–‘ ì •ë¦¬ -----*/
    .dialogetc header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      /* ê°€ìš´ë° ì •ë ¬ */
      padding: 6px 0 8px;
      border-bottom: 1px solid #2a211a;
    }

    #castleSealModal .dialogetc header {
      font-size: 17px;
    }

    .dialogetc header h2 {
      margin: 0;
      font-size: 15px;
      color: #f0e6d2;
      font-weight: 700;
      flex: none;
      text-align: center;
    }


    /* ê¸°ë³¸ ë‹«ê¸° ë²„íŠ¼ í¬ê¸°Â·ëª¨ì–‘ ì •ë¦¬ */
    .dialogetc header button {
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: #f0e6d2;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 26px;
      height: 26px;
    }

    .dialogetc header button:hover {
      background: rgba(255, 255, 255, 0.16);
      border-color: rgba(255, 255, 255, 0.3);
    }


    /* â”€â”€â”€â”€â”€ ê¸°ë³¸ ë²„íŠ¼ í¬ê¸° í†µì¼ â”€â”€â”€â”€â”€ */
    .opt-btnetc {
      width: 110px;
      height: 38px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      background: #1a130f;
      color: #f0e6d2;
      border: 1px solid #3a2c21;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    #autoEnhModal .opt-btnetc {
      flex-direction: column;
    }

    #autoEnchantModal .opt-btnetc {
      width: 100px;
    }

    #castleSealModal .opt-btnetc {
      width: 300px;
      height: 80px;
      font-size: 15px;
    }

    .opt-btnetc:hover {
      border-color: #cfa24f;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, 0.25) inset;
    }

    .opt-btnetc.active {
      border-color: #cfa24f;
      background: rgba(207, 162, 79, 0.1);
      box-shadow: 0 0 0 2px rgba(207, 162, 79, 0.25) inset;
    }

    #castleSealModal .opt-btnetc .name {
      gap: 2px;
    }

    .ui-btnetc {
      display: inline-block;
      padding: 14px 34px;
      border-radius: 6px;
      /* ëì´ ì•„ì£¼ ì‚´ì§ ë‘¥ê¸€ê²Œ */
      background: #ecc947;
      /* ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë…¸ë€ìƒ‰ */
      color: #111;
      /* ê¸€ìëŠ” ê²€ì€ìƒ‰ */
      font-size: 17px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
      margin: 12px auto;
      /* ê°€ìš´ë° ì •ë ¬ */
      display: block;
      /* ì¤‘ì•™ ë°°ì¹˜ */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ë°ì•„ì§€ëŠ” íš¨ê³¼ */
    .ui-btnetc:hover {
      background: #ffe263;
      /* ì¡°ê¸ˆ ë” ë°ì€ ë…¸ë€ìƒ‰ */
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    }

    /* í´ë¦­ ì‹œ ì‚´ì§ ëˆŒë¦¬ëŠ” íš¨ê³¼ (ì„ íƒ ì‚¬í•­) */
    .st-apply-btn:active {
      transform: scale(0.98);
    }

    .st-apply-btn {
      display: inline-block;
      padding: 14px 34px;
      border-radius: 6px;
      /* ëì´ ì•„ì£¼ ì‚´ì§ ë‘¥ê¸€ê²Œ */
      background: #ecc947;
      /* ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ë…¸ë€ìƒ‰ */
      color: #111;
      /* ê¸€ìëŠ” ê²€ì€ìƒ‰ */
      font-size: 17px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
      margin: 12px auto;
      /* ê°€ìš´ë° ì •ë ¬ */
      display: block;
      /* ì¤‘ì•™ ë°°ì¹˜ */
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ ë°ì•„ì§€ëŠ” íš¨ê³¼ */
    .st-apply-btn:hover {
      background: #ffe263;
      /* ì¡°ê¸ˆ ë” ë°ì€ ë…¸ë€ìƒ‰ */
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    }

    /* í´ë¦­ ì‹œ ì‚´ì§ ëˆŒë¦¬ëŠ” íš¨ê³¼ (ì„ íƒ ì‚¬í•­) */
    .st-apply-btn:active {
      transform: scale(0.98);
    }


    /* â”€â”€â”€â”€â”€ ëª¨ë°”ì¼ ëŒ€ì‘ (1ì—´ ì „í™˜ ì‹œ) â”€â”€â”€â”€â”€ */
    @media (max-width: 520px) {
      #autoSealModal .body.two-col {
        grid-template-columns: 1fr;
      }

      #autoSealModal .body.two-col::after {
        display: none;
      }
    }

    /* (ê¸°ì¡´) #autoEnchantModal ì „ìš© â†“ ì´ ì¤„ì„ ì´ë ‡ê²Œ ë°”ê¾¼ë‹¤ */
    @media (max-width: 520px) {

      #autoEnchantModal .body.two-col,
      #autoEmblemModal .body.two-col {
        /* âœ… ì¶”ê°€ */
        grid-template-columns: 1fr;
      }

      #autoEnchantModal .body.two-col::after,
      #autoEmblemModal .body.two-col::after {
        /* âœ… ì¶”ê°€ */
        display: none;
      }
    }



    /* ì¶”ì²œ ë§ˆë²•ë¶€ì—¬ ëª¨ë‹¬: ì†ì„±ì„ íƒ â†” ì¶”ì²œí‹°ì–´ êµ¬ë¶„ì„  */
    .body.two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      position: relative;
      /* êµ¬ë¶„ì„  ê¸°ì¤€ ìœ„ì¹˜ ì§€ì • */
    }

    .body.two-col::after {
      content: "";
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      /* ì •í™•íˆ ê°€ìš´ë° ë°°ì¹˜ */
      width: 1px;
      background: rgba(255, 255, 255, 0.12);
      /* ì€ì€í•œ ë¼ì¸ ìƒ‰ */
      pointer-events: none;
      /* í´ë¦­ ë°©í•´ ì—†ìŒ */
    }

    /* ëª¨ë°”ì¼ ì¢ì€ í™”ë©´ì—ì„  1ì—´ë¡œ ë–¨ì–´ì§€ë„ë¡ */
    @media (max-width: 520px) {
      #autoEnchantModal .body.two-col {
        grid-template-columns: 1fr;
      }

      #autoEnchantModal .body.two-col::after {
        display: none;
      }
    }

    /* âœ… ê³ ìœ íš¨ê³¼ ì¼ê´„ ì ìš© ëª¨ë‹¬ ë ˆì´ì•„ì›ƒ */
    .unique-dialog {
      width: min(600px, 95vw);
      max-height: 80vh;
    }

    .unique-body {
      padding: 12px 10px 14px;
      display: grid;
      gap: 12px;
    }

    .unique-section {
      border-radius: 10px;
      border: 1px solid #3a2c21;
      background: #15100c;
      padding: 8px 10px;
    }

    .unique-section-title {
      font-size: 14px;
      margin: 0 0 12px;
      color: #facc6b;
    }

   /* ê³ ìœ íš¨ê³¼ ëª¨ë‹¬: ì˜µì…˜ ëª©ë¡ í•œ ì¤„ì”© ì„¸ë¡œë¡œ ë°°ì¹˜ */
.unique-options {
  display: flex;
  flex-direction: column;  /* ğŸ”¹ ì´ê²Œ í•µì‹¬! */
  gap: 12px;
}

/* í•œ ì¤„: [ë²„íŠ¼] [ì„¤ëª…] */
.unique-row {
  display: flex;
  align-items: flex-start;
  gap: 16px;

  padding: 4px 6px;
  border-radius: 8px;
  transition: background 0.12s ease, box-shadow 0.12s ease;
}

/* ì¤„ ì „ì²´ hover / ì„ íƒ ì‹œ ê°•ì¡° */
.unique-row:hover,
.unique-row.is-selected {
  background: rgba(148, 163, 184, 0.12);        /* ì‚´ì§ ë°ê²Œ */
  box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.25);
}

/* hover ë˜ëŠ” ì„ íƒì¼ ë•Œ ë²„íŠ¼ ì‚´ì§ íŠ€ì–´ë‚˜ì˜¤ëŠ” ëŠë‚Œ */
.unique-row:hover .unique-btn,
.unique-row.is-selected .unique-btn {
  transform: translateY(-1px);
  box-shadow: 0 0 0 1px rgba(248, 250, 252, 0.35);
}

/* hover ë˜ëŠ” ì„ íƒì¼ ë•Œ ì„¤ëª… ê¸€ì ì¡°ê¸ˆ ë” ë°ê²Œ */
.unique-row:hover .unique-desc,
.unique-row.is-selected .unique-desc {
  color: #e5e7eb;
}



    /* ëª¨ë‹¬ ë‚´ ê³ ìœ íš¨ê³¼ ì„ íƒ ë²„íŠ¼ ê¸°ë³¸ ëª¨ì–‘ */
    .unique-btn {
      min-width: 60px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #3a2c21;
      background: rgba(15, 23, 42, 0.85);
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      align-self: flex-start;
      transition: background 0.12s ease, color 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }

/* ì„¤ëª… í…ìŠ¤íŠ¸ ì˜ì—­ */
.unique-desc {
  flex: 1;
  font-size: 12px;
  color: var(--muted);
  line-height: 1.4;
  white-space: normal;
}

    .unique-btn:hover {
      background: rgba(15, 23, 42, 1);
    }

    .unique-btn.is-active {
      /* í™œì„±í™”ì¼ ë•Œ ê¸°ë³¸ í…Œë‘ë¦¬ë§Œ ì‚´ì§ ê°•ì¡° (ìƒ‰ì€ ì•„ë˜ í•­ëª©ë³„ì—ì„œ ë®ì–´ì”€) */
      box-shadow: 0 0 0 1px rgba(250, 250, 250, 0.12);
    }

    .unique-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

       /* â”€â”€â”€â”€â”€ ë¬´ê¸° ê³ ìœ íš¨ê³¼ ìƒ‰ìƒ â”€â”€â”€â”€â”€ */

    /* ê¸°ë³¸: í…Œë‘ë¦¬ + ê¸€ì ìƒ‰ + ì•„ì£¼ ì˜…ì€ ë°°ê²½ */
    .unique-options-weapon .unique-btn[data-value="ê°•íƒ€"] {
      border-color: #facc15;
      color: #facc15;
      background: rgba(250, 204, 21, 0.08);
    }
    .unique-options-weapon .unique-btn[data-value="ê´‘ì±„"] {
      border-color: #38bdf8;
      color: #38bdf8;
      background: rgba(56, 189, 248, 0.08);
    }
    .unique-options-weapon .unique-btn[data-value="ë¶„ì‡„"] {
      border-color: #f97373;
      color: #f97373;
      background: rgba(248, 113, 113, 0.08);
    }
    .unique-options-weapon .unique-btn[data-value="ì„ ëª…"] {
      border-color: #4ade80;
      color: #4ade80;
      background: rgba(74, 222, 128, 0.08);
    }
    .unique-options-weapon .unique-btn[data-value="ì—†ìŒ"] {
      border-color: var(--line);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.6);
    }

    /* ì„ íƒ(.is-active)ì¼ ë•Œ: ë°°ê²½ + í…Œë‘ë¦¬/ê·¸ë¦¼ì ì¡°ê¸ˆ ë” ì§„í•˜ê²Œ (ê¸°ì¡´ btnCustomOpt ëŠë‚Œ) */
    .unique-options-weapon .unique-btn.is-active[data-value="ê°•íƒ€"] {
      background: rgba(250, 204, 21, 0.15);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.35);
    }
    .unique-options-weapon .unique-btn.is-active[data-value="ê´‘ì±„"] {
      background: rgba(56, 189, 248, 0.15);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
    }
    .unique-options-weapon .unique-btn.is-active[data-value="ë¶„ì‡„"] {
      background: rgba(248, 113, 113, 0.15);
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.35);
    }
    .unique-options-weapon .unique-btn.is-active[data-value="ì„ ëª…"] {
      background: rgba(74, 222, 128, 0.15);
      box-shadow: 0 0 0 1px rgba(74, 222, 128, 0.35);
    }
    .unique-options-weapon .unique-btn.is-active[data-value="ì—†ìŒ"] {
      /* ì—†ìŒì€ ì„ íƒë˜ì–´ë„ ê·¸ëƒ¥ ì¤‘ë¦½ ëŠë‚Œ */
      box-shadow: none;
    }

    /* â”€â”€â”€â”€â”€ ê¸°íƒ€ ê³ ìœ íš¨ê³¼ ìƒ‰ìƒ (ì„ ë´‰/ì˜ì§€/ì´ìƒ) â”€â”€â”€â”€â”€ */

    /* ê¸°ë³¸ */
    /* ì„ ë´‰: ë¶„ì‡„(ë¹¨ê°„ ê³„ì—´) */
    .unique-options-other .unique-btn[data-value="ì„ ë´‰"] {
      border-color: #f97373;
      color: #f97373;
      background: rgba(248, 113, 113, 0.08);
    }
    /* ì˜ì§€: ê´‘ì±„(íŒŒë€ ê³„ì—´) */
    .unique-options-other .unique-btn[data-value="ì˜ì§€"] {
      border-color: #38bdf8;
      color: #38bdf8;
      background: rgba(56, 189, 248, 0.08);
    }
    /* ì´ìƒ: ì„ ëª…(ì´ˆë¡ ê³„ì—´) */
    .unique-options-other .unique-btn[data-value="ì´ìƒ"] {
      border-color: #4ade80;
      color: #4ade80;
      background: rgba(74, 222, 128, 0.08);
    }
    .unique-options-other .unique-btn[data-value="ì—†ìŒ"] {
      border-color: var(--line);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.6);
    }

    /* ì„ íƒ(.is-active)ì¼ ë•Œ ê°•ì¡° */
    .unique-options-other .unique-btn.is-active[data-value="ì„ ë´‰"] {
      background: rgba(248, 113, 113, 0.15);
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.35);
    }
    .unique-options-other .unique-btn.is-active[data-value="ì˜ì§€"] {
      background: rgba(56, 189, 248, 0.15);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.35);
    }
    .unique-options-other .unique-btn.is-active[data-value="ì´ìƒ"] {
      background: rgba(74, 222, 128, 0.15);
      box-shadow: 0 0 0 1px rgba(74, 222, 128, 0.35);
    }
    .unique-options-other .unique-btn.is-active[data-value="ì—†ìŒ"] {
      box-shadow: none;
    }



    /* âœ… ë°©ì–´êµ¬ ì„¸íŠ¸ ì„ íƒ ëª¨ë‹¬ */

    #armorSetModal .dialog.armor-set-dialog {
      width: min(1200px, 96vw);
      height: min(640px, 90vh);
    }

    .armor-set-body {
      overflow: auto;
      padding: 6px 4px 12px;
    }

    /* ì„¸íŠ¸ ì¹´ë“œë“¤ì„ 2ì—´ ê·¸ë¦¬ë“œë¡œ ë°°ì¹˜ (ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼ ì¢Œ/ìš° 2ê°œì”©) */
    .armor-set-list {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      /* ğŸ” í•œ ì¤„ì— 3ê°œ */
      gap: 10px;
    }

    /* ì²« ì¤„ 3ë²ˆì§¸ ì¹¸ì„ ì°¨ì§€í•  ë¹ˆ ì¹¸ìš© */
    .armor-set-spacer {
      visibility: hidden;
      /* í™”ë©´ì— ì•ˆ ë³´ì´ê²Œ */
      pointer-events: none;
      /* í´ë¦­ ë¶ˆê°€ */
      margin: 0;
      padding: 0;
    }

    .armor-set-card {
      background: #15100c;
      border: 1px solid #3a2c21;
      border-radius: 12px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .armor-set-header {
      font-size: 13px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 8px;
      background: #25180f;
      border: 1px solid #4b3624;
      color: #f7e3b8;
    }

    /* ì„¸íŠ¸ ì¹´ë“œ í—¤ë”ë¥¼ ì¢Œìš° ì •ë ¬ë¡œ ë³€ê²½ */
.armor-set-header {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* ì´ë¦„ ë¶€ë¶„ì´ ì™¼ìª½ì„ ì°¨ì§€í•˜ë„ë¡ */
.armor-set-header-title {
  flex: 1;
}

/* ìë™ê³„ì‚° ëŒ€ìƒ í† ê¸€ ë²„íŠ¼ */
.set-auto-toggle {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 999px;
  border: 1px solid #facc6b;
  background: rgba(250, 204, 21, 0.08);
  color: #facc6b;
  cursor: pointer;
  white-space: nowrap;
}

.set-auto-toggle.is-selected {
  background: rgba(250, 204, 21, 0.25);
}


    .armor-set-items {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 4px 2px 2px;
    }

    .armor-set-item {
      background: none;
      border: 0;
      padding: 0;
      cursor: pointer;
    }

    /* ì„¸íŠ¸ ì•ˆ ì•„ì´ì½˜ í¬ê¸° ì•½ê°„ ì¤„ì´ê¸° */
    .armor-set-item .iconbox {
      width: 56px;
      height: 56px;
    }

    .armor-set-item .badge-lv {
      font-size: 10px;
      padding: 1px 4px;
    }

    /* ì œëª©ì¤„: ì œëª© + í† ê¸€ + ë‹«ê¸°ë²„íŠ¼ */
    .armor-set-titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .armor-set-titlebar h2 {
      flex: 1;
      font-size: 15px;
    }

    /* âœ… í† ê¸€ ì „ì²´ íŠ¸ë™ */
    .armor-toggle {
      position: relative;
      width: 120px;
      height: 26px;
      border-radius: 999px;
      padding: 2px;
      display: flex;
      align-items: stretch;
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.3),
        0 3px 8px rgba(0, 0, 0, 0.35);
      cursor: pointer;
      user-select: none;
      overflow: hidden;
    }

    /* ìµì‹œë“œ ON (íŒŒë€ ê³„ì—´) */
    .armor-toggle.mode-exceed {
      background: linear-gradient(135deg, #1d4ed8, #38bdf8);
    }

    /* ì—í”½ ON (ë…¸ë‘ ê³„ì—´) */
    .armor-toggle.mode-epic {
      background: linear-gradient(135deg, #facc15, #f97316);
    }

    /* ì•ˆì˜ í…ìŠ¤íŠ¸ ì˜ì—­ */
    .armor-toggle-label {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      z-index: 2;
      transition: color 0.18s ease, opacity 0.18s ease;
    }

    /* ê° ìƒíƒœë³„ í…ìŠ¤íŠ¸ ìƒ‰ */
    .armor-toggle.mode-exceed .armor-toggle-label-exceed {
      color: #0f172a;
      font-weight: 600;
    }

    .armor-toggle.mode-exceed .armor-toggle-label-epic {
      color: rgba(15, 23, 42, 0.45);
    }

    .armor-toggle.mode-epic .armor-toggle-label-exceed {
      color: rgba(15, 23, 42, 0.45);
    }

    .armor-toggle.mode-epic .armor-toggle-label-epic {
      color: #0f172a;
      font-weight: 600;
    }

    /* ë™ê·¸ë€ ì†ì¡ì´ */
    .armor-toggle-thumb {
      position: absolute;
      top: 2px;
      bottom: 2px;
      width: 50%;
      border-radius: 999px;
      background: #ffffff;
      box-shadow:
        0 2px 4px rgba(15, 23, 42, 0.4),
        0 0 0 1px rgba(148, 163, 184, 0.7);
      transform: translateX(0%);
      transition: transform 0.18s ease-out;
    }

    /* ìµì‹œë“œ â†’ ì™¼ìª½, ì—í”½ â†’ ì˜¤ë¥¸ìª½ */
    .armor-toggle.mode-exceed .armor-toggle-thumb {
      transform: translateX(0%);
    }

    .armor-toggle.mode-epic .armor-toggle-thumb {
      transform: translateX(100%);
    }
    /* âœ… ê³ ìœ íš¨ê³¼ ON/OFF í† ê¸€ ì¤„ */
    .unique-onoff-row {
      margin-top: 6px;
      display: flex;
      justify-content: flex-start;
    }

    /* âœ… ON/OFF ì „ìš© ìƒ‰ìƒ (ì—í”½/ìµì‹œë“œì™€ ë¹„ìŠ·í•œ ëŠë‚Œ) */
    .armor-toggle.mode-off {
      background: linear-gradient(135deg, #111827, #1f2937); /* ì–´ë‘ìš´ íšŒìƒ‰ */
    }

    .armor-toggle.mode-on {
      background: linear-gradient(135deg, #16a34a, #4ade80); /* ë…¹ìƒ‰ê³„ì—´ ON */
    }

    /* OFF â†’ ì™¼ìª½, ON â†’ ì˜¤ë¥¸ìª½ */
    .armor-toggle.mode-off .armor-toggle-thumb {
      transform: translateX(0%);
    }

    .armor-toggle.mode-on .armor-toggle-thumb {
      transform: translateX(100%);
    }

    /* OFF/ON ë¼ë²¨ ìƒ‰ìƒ */
    .armor-toggle.mode-off .armor-toggle-label-off {
      color: #e5e7eb;
      font-weight: 600;
    }

    .armor-toggle.mode-off .armor-toggle-label-on {
      color: rgba(226, 232, 240, 0.5);
    }

    .armor-toggle.mode-on .armor-toggle-label-off {
      color: rgba(15, 23, 42, 0.55);
    }

    .armor-toggle.mode-on .armor-toggle-label-on {
      color: #0f172a;
      font-weight: 600;
    }



    /* ê³ ì • ë†’ì´ ì•„ì´í…œ ëª¨ë‹¬ */
    #itemModal .dialog {
      grid-template-rows: auto auto;
    }

    #itemModal .items {
      height: clamp(420px, 60vh, 560px);
      max-height: clamp(420px, 60vh, 560px);
      overflow: auto;
    }

    /* === Emblem sockets & modal â€” FINAL MERGED === */

    /* Stack of 2 sockets (vertical) */
    .emblem-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      justify-content: center;
    }

    /* Socket dot (small circular button) */
    .emblem-dot {
      width: 28px;
      height: 28px;
      position: relative;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, .25);
      background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .02));
      box-shadow: 0 2px 8px rgba(0, 0, 0, .35) inset, 0 0 0 3px rgba(110, 168, 255, 0);
      display: grid;
      place-items: center;
      /* Hard guarantee: perfect circle in every browser */
      border-radius: 999px !important;
      overflow: hidden !important;
      clip-path: circle(50% at 50% 50%) !important;
      -webkit-mask-image: radial-gradient(circle, #000 99%, transparent 100%) !important;
      mask-image: radial-gradient(circle, #000 99%, transparent 100%) !important;
      -webkit-mask-size: 100% 100%;
      mask-size: 100% 100%;
      background-clip: padding-box;
    }

    .emblem-dot:hover {
      box-shadow: 0 0 0 3px var(--ring);
    }

    /* When an emblem image is applied from JS as CSS var */
    .emblem-dot.has-img {
      background:
        var(--emblem) center/cover no-repeat,
        linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .02)) !important;
    }

    .emblem-dot.has-img::after {
      display: none !important;
    }

    /* hide dashed guide when filled */

    /* Empty socket guide */
    .emblem-dot.empty {
      opacity: .45;
    }

    .emblem-dot.empty::after {
      content: "";
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px dashed rgba(255, 255, 255, .3);
    }

    /* Images inside sockets always clipped to circle */
    .emblem-dot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 999px !important;
      -webkit-mask-image: radial-gradient(circle, #000 99%, transparent 100%) !important;
      mask-image: radial-gradient(circle, #000 99%, transparent 100%) !important;
      -webkit-mask-size: 100% 100%;
      mask-size: 100% 100%;
    }

    /* Center number (socket & picker) â€” bright & legible */
    .emblem-dot .num,
    .em-thumb .num {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 900;
      letter-spacing: .2px;
      -webkit-text-stroke: 1px rgba(0, 0, 0, .35);
      text-shadow:
        0 1px 1px rgba(0, 0, 0, .55),
        0 0 4px rgba(255, 255, 255, .65),
        0 0 10px rgba(255, 255, 255, .45);
    }

    .emblem-dot .num {
      font-size: 16px;
    }

    /* 28px socket */
    .em-thumb .num {
      font-size: 22px;
    }

    /* 56px picker */

    /* Subtle center darkening behind number (not too strong) */
    .emblem-dot .num::before,
    .em-thumb .num::before {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 80%;
      border-radius: 999px;
      pointer-events: none;
      background: radial-gradient(circle,
          rgba(0, 0, 0, .18) 0%,
          rgba(0, 0, 0, .10) 45%,
          rgba(0, 0, 0, 0) 70%);
    }

    /* Hover: enhance number legibility */
    .emblem-dot:hover .num,
    .em-thumb:hover .num {
      -webkit-text-stroke: 1px rgba(0, 0, 0, .45);
      text-shadow:
        0 1px 2px rgba(0, 0, 0, .75),
        0 0 6px rgba(255, 255, 255, .60),
        0 0 14px rgba(255, 255, 255, .50);
    }

    /* === Emblem picker rows (horizontal scrollers) === */
    .em-rows {
      display: grid;
      gap: 12px;
      padding: 12px;
    }

    .em-row {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 6px;
    }

    /* Picker thumbnail (badge-like) */
    .em-thumb {
      width: 56px;
      height: 56px;
      position: relative;
      cursor: pointer;
      border-radius: 999px;
      padding: 0;
      border: 1px solid #3a2c21;
      background: #1a130f;
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .em-thumb:hover {
      border-color: #cfa24f;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .25) inset;
    }

    /* Always circular images */
    .em-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 999px !important;
      -webkit-mask-image: radial-gradient(circle, #000 99%, transparent 100%) !important;
      mask-image: radial-gradient(circle, #000 99%, transparent 100%) !important;
      -webkit-mask-size: 100% 100%;
      mask-size: 100% 100%;
    }

    /* 'None' option as a circular crossed badge */
    .em-thumb.none {
      background: linear-gradient(135deg, #1a130f 0%, #0c0a08 100%);
      border-radius: 999px;
    }

    .em-thumb.none::before,
    .em-thumb.none::after {
      content: "";
      position: absolute;
      left: 10px;
      right: 10px;
      top: 50%;
      height: 2px;
      background: rgba(255, 255, 255, .35);
    }

    .em-thumb.none::after {
      transform: rotate(90deg);
    }

    /* Caption (for accessary/title slots) */
    .emblem-caption {
      white-space: pre-line;
      /* âœ… \n ì¤„ë°”ê¿ˆ í—ˆìš© */
      margin-top: 4px;
      font-size: 11px;
      line-height: 1.1;
      color: #e7c27a;
      text-align: center;
      max-width: 84px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      pointer-events: none;
    }

    /* === Seal text captions inside slots === */
    .seal-captions {
      position: absolute;
      left: 6px;
      bottom: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      /* í–‰ ê°„ê²© 2px */
      pointer-events: none;
      /* ë¹„í´ë¦­ */
    }

    .seal-captions .seal-row {
      display: flex;
      gap: 2px;
      justify-content: flex-start;
    }

    /* ì¢Œì¸¡ì •ë ¬ */
    .seal-captions .seal-chip {
      /*max-width: calc(100% - 12px);*/
      font-size: 9px;
      line-height: 1.2;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(207, 162, 79, 0.35);
      /* ê¸°ì¡´ ê³¨ë“œ í†¤ê³¼ ì–´ìš¸ë¦¬ê²Œ */
      color: inherit;
      white-space: nowrap;
      overflow: visible;
      text-overflow: unset;
    }



    /* === Skill Rune === */
    .rune-head {
      display: flex;
      gap: 8px;
      align-items: center;
      white-space: nowrap;
      /* âœ… ì¤„ë°”ê¿ˆ ë°©ì§€ */
    }

    .rune-head div {
      font-size: 12px;
      color: var(--muted, #6b7280);
      white-space: nowrap;
      /* âœ… ì¹´ìš´í„°ë„ ì¤„ë°”ê¿ˆ ì—†ìŒ */
    }

    .rune-head b {
      color: #e7c27a;
    }

    .rune-grid {
      --col-w: minmax(64px, 1fr);
      display: grid;
      /* ê° í–‰ ë†’ì´ë¥¼ ì—¬ìœ  ìˆê²Œ í™•ë³´ */
      grid-auto-rows: minmax(60px, auto);
      /* ìŠ¬ë¡¯ ê°„ ê°„ê²© ì‚´ì§ ë„“ê²Œ */
      gap: 10px;
      overflow: auto;
    }

    .rune-grid .row {
      display: grid;
      grid-template-columns: 120px repeat(8, var(--col-w));
      align-items: center;
      gap: 8px;
    }

    .rune-grid .head {
      position: sticky;
      left: 0;
      z-index: 1;
      padding: 0 10px;
      border: 1px solid #3a2c21;
      border-radius: 10px;
      background: #1a130f;
      color: #f0e6d2;
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
    }

    /* â–¼ ìŠ¤í‚¬ë£¬ ì¹´í…Œê³ ë¦¬(ê°ì„±/ë§ˆë ¥/í—ˆìƒ/ìˆ™ë ¨/ê¸°êµ) í—¤ë”ìš© */
    .rune-cat-head {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-top: 6px;
      padding-bottom: 6px;
    }

    .rune-cat-icon {
      width: 32px;
      height: 32px;
      object-fit: contain;
      margin-bottom: 4px;
      pointer-events: none;
    }

    .rune-cat-label {
      font-size: 12px;
      font-weight: 800;
    }


    .rune-grid .cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rune-select {
      width: 100%;
      height: 30px;
      border-radius: 8px;
      border: 1px solid #3a2c21;
      background: #15100c;
      color: #f0e6d2;
      padding: 0 8px;
    }

    .rune-select:focus {
      border-color: #cfa24f;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .25) inset;
    }

    /* â–¼ íŠ¹ìˆ˜ ìŠ¤í‚¬ë£¬(ê°€í˜¸/ì§€í˜œ/ì™œê³¡) ë ˆì´ì•„ì›ƒ */
    .special-runes {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px dashed #3a2c21;
      text-align: center;
      /* ì•ˆìª½ í…ìŠ¤íŠ¸ ê¸°ë³¸ ì¤‘ì•™ ì •ë ¬ */
    }

    .special-runes-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #e7c27a;
      font-size: 13px;
    }

    /* ë¼ë²¨ + ë“œë¡­ë‹¤ìš´ì„ í•œ ë©ì–´ë¦¬ë¡œ ê°€ìš´ë° ì •ë ¬ */
    .special-rune-row {
      display: flex;
      align-items: center;
      justify-content: center;
      /* ê°€ìš´ë° ì •ë ¬ */
      gap: 8px;
      margin-bottom: 6px;
    }

    .special-rune-row label {
      margin: 0;
      font-size: 13px;
    }

    /* â–¼ ì™œê°€ì§€ ì•„ì´ì½˜ */
    .special-rune-icon {
      width: 22px;
      height: 22px;
      object-fit: contain;
      flex: 0 0 auto;
    }

    /* ë“œë¡­ë‹¤ìš´ í¬ê¸° ì ë‹¹íˆ ê³ ì • */
    .special-rune-row .rune-select,
    #specialRune_gaho,
    #specialRune_jihe,
    #specialRune_waegok {
      min-width: 70px;
      max-width: 90px;
    }

    /* ë£¬ ê°ì¸ UI */
    .rune-engrave-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .field.compact {
      flex: 1 1 220px;
    }

    /* === Skill Tree UI â€” FINAL MERGED === */

    /* Header row */
    .skilltree-head {
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 15px;
      white-space: nowrap;
      /* âœ… ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
    }

    .st-counters {
      display: flex;
      flex-direction: column;
      /* âœ… ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ */
      align-items: flex-start;
      gap: 6px;
      /* ìœ„ì•„ë˜ ê°„ê²© */
      white-space: nowrap;
    }

    .skilltree-head .st-counters span {
      display: inline-flex;
      align-items: center;
      font-size: 14px;
      color: var(--muted, #6b7280);
    }

    .skilltree-head .st-counters b {
      margin-left: 4px;
      color: var(--text, #1f2937);
    }

    /* ê³µí†µ ë²„íŠ¼(ì–‡ì€ ë¼ìš´ë“œ, ëŒ€ë¹„ í™•ë³´) */
    .ui-btn {
      --ui-bg: #fff;
      --ui-fg: #1f2937;
      --ui-bd: #e5e7eb;
      --ui-ring: rgba(37, 99, 235, .15);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid var(--ui-bd);
      background: var(--ui-bg);
      color: var(--ui-fg);
      font-size: 13px;
      font-weight: 600;
      letter-spacing: .1px;
      white-space: nowrap;
      /* âœ… ë²„íŠ¼ ìì²´ë„ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
      user-select: none;
      cursor: pointer;
      transition: transform .06s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
    }

    .ui-btn:hover {
      box-shadow: 0 4px 14px rgba(31, 41, 55, .08);
    }

    .ui-btn:active {
      transform: translateY(1px);
    }

    .ui-btn:focus-visible {
      outline: 0;
      box-shadow: 0 0 0 3px var(--ui-ring);
    }

    /* ë‹´ë°±í•œ ë³€í˜• */
    .ui-btn.ghost {
      background: #f8fafc;
    }

    /* ë‹¤í¬ í…Œë§ˆ ëŒ€ë¹„(ìˆìœ¼ë©´ ì ìš©) */
    @media (prefers-color-scheme: dark) {
      .ui-btn {
        --ui-bg: #0f1115;
        --ui-fg: #e6e9ef;
        --ui-bd: #273041;
      }

      .ui-btn.ghost {
        background: #151922;
      }
    }

    .ui-btn.primary {
      --ui-bg: #2563eb;
      /* íŒŒë€ ë°°ê²½ */
      --ui-fg: #fff;
      /* í° ê¸€ì”¨ */
      --ui-bd: #2563eb;
      background: var(--ui-bg);
      color: var(--ui-fg);
      border: 1px solid var(--ui-bd);
    }

    /* Top utility bar */
    .st-topbar {
      display: flex;
      gap: 14px;
      align-items: center;
      font-size: 12px;
      color: #c7b589;
    }

    /* ===== Universal counter styles (base) ===== */
    .st-counter {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(0, 0, 0, .25);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 10px;
      font-size: 13px;
      /* base size; overridden in modal scope */
    }

    .st-counter .label {
      font-weight: 800;
      letter-spacing: .3px;
      font-size: 13px;
    }

    .st-counter .label.sp {
      color: #6ec6ff;
    }

    /* cyan-like */
    .st-counter .label.tp {
      color: #ff4444;
    }

    /* red */
    .st-counter .val {
      min-width: 18px;
      text-align: right;
      color: #e6e9ef;
      font-variant-numeric: tabular-nums;
      font-size: 13px;
    }

    /* Keep modal header balanced */
    .modal .dialog header {
      justify-content: space-between;
    }

    /* ===== Optional large pills elsewhere (kept for compatibility) ===== */
    :root {
      --sp-blue: #2BCCED;
      --tp-red: #F03231;
    }

    .actions .sp-tp {
      display: none;
      gap: 18px;
      align-items: center;
      font-size: 20pt;
    }

    .counter-pill {
      display: flex;
      align-items: baseline;
      gap: 8px;
      font-weight: 800;
      letter-spacing: .1px;
      color: var(--text);
      text-shadow: 0 1px 2px rgba(0, 0, 0, .55);
    }

    .counter-pill .lab {
      font-size: 1em;
      font-style: italic;
      font-weight: 900;
    }

    .counter-pill.sp .lab {
      color: var(--sp-blue);
    }

    .counter-pill.tp .lab {
      color: var(--tp-red);
    }

    /* ===== Modal-only: big counters aligned to the right ===== */
    #skillTreeModal .st-counters {
      margin-left: auto;
      font-size: 20pt;
    }

    #skillTreeModal .st-counter,
    #skillTreeModal .st-counter .label,
    #skillTreeModal .st-counter .val {
      font-size: 20pt;
    }

    /* Modal size */
    #skillTreeModal .dialog {
      width: min(1600px, 98vw) !important;
      height: min(920px, 95vh) !important;
    }

    /* ===== SkillTree v1 (legacy banded columns) ===== */
    .st-grid {
      grid-auto-flow: column;
      grid-auto-columns: 320px;
      /* generous column width */
      gap: 12px;
      padding: 12px;
    }

    .st-col {
      gap: 8px;
      align-content: start;
    }

    .st-band {
      position: sticky;
      top: 0;
      z-index: 2;
      padding: 6px 10px;
      border: 1px solid #3a2c21;
      border-radius: 10px;
      background: #1a130f;
      color: #e7c27a;
      font-weight: 800;
      font-size: 13px;
      text-align: center;
    }

    /* ===== SkillTree v2 (bands / coordinate grid) ===== */

    /* Wrapper for bands */
    .st2-wrap {
      display: grid;
      gap: 14px;
    }

    /* Each band's grid sits a bit below its dashed label line */
    .st2-band>.st2-grid {
      margin-top: 3px;
    }

    /* Band container: prevent clipping; add room above/below */
    .st2-band {
      position: relative;
      margin: 1px 0;
      padding-top: 10px;
      /* room for label/dashed line */
      padding-bottom: 1px;
      /* room for controls */
      overflow: visible;
    }

    /* Band dashed line */
    .st2-band::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      border-top: 1px dashed rgba(207, 162, 79, .55);
    }

    /* Band label sitting over dashed line */
    .st2-band-label {
      position: absolute;
      left: 0;
      top: 0;
      transform: translateY(-50%);
      padding: 0 6px;
      border-radius: 8px;
      background: #0e0b09;
      color: #e7c27a;
      font-weight: 800;
      font-size: 12px;
      line-height: 1.4;
      z-index: 1;
    }

    /* 6-column responsive grid; variable row height */
    .st2-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(100px, 1fr));
      grid-auto-rows: minmax(164px, max-content);
      gap: 10px;
    }

    /* ===== Skill tiles ===== */

    /* Tile: icon (top) / name (middle) / controls (bottom) */
    .st2-tile {
      display: grid;
      grid-template-rows: auto auto auto;
      align-items: center;
      justify-items: center;
      gap: 6px;
      max-width: 100%;
      overflow: hidden;
    }

    /* Skill name */
    .st2-name {
      width: 100%;
      max-width: 340px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 17px;
      font-weight: 800;
      line-height: 1.1;
      color: #e7c27a;
    }

    /* ğŸ”¹ ìŠ¤í‚¬ ì¹´ë“œ ë‚´ë¶€ SP / TP ë¼ë²¨ */
    .st2-tags {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 0 0 3px;
      font-size: 11px;
      font-weight: 800;
    }

    .st2-tags .tag-sp,
    .st2-tags .tag-tp {
      font-weight: 800;
      letter-spacing: .3px;
    }

    .st2-tags .tag-sp {
      color: #6ec6ff;
      /* ìš°ì¸¡ ìƒë‹¨ SP ìƒ‰ìƒê³¼ ë™ì¼ */
    }

    .st2-tags .tag-tp {
      color: #ff4444;
      /* ìš°ì¸¡ ìƒë‹¨ TP ìƒ‰ìƒê³¼ ë™ì¼ */
    }

    /* Circular icon */
    .st2-skill {
      width: clamp(68px, 7.6vw, 92px);
      height: clamp(68px, 7.6vw, 92px);
      border-radius: 999px;
      border: 1px solid #3a2c21;
      background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .02));
      box-shadow: 0 2px 8px rgba(0, 0, 0, .35) inset;
      display: grid;
      place-items: center;
      overflow: hidden;
      -webkit-mask-image: radial-gradient(circle, #000 99%, transparent 100%);
      mask-image: radial-gradient(circle, #000 99%, transparent 100%);
    }

    .st2-skill img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 999px;
    }

    /* TPê°€ ì—†ëŠ” ìŠ¤í‚¬ì€ ì•„ì´ì½˜ + ìŠ¤í‚¬ëª…ë§Œ ì‚´ì§ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ */
    .st2-tile.no-tp .st2-skill,
    .st2-tile.no-tp .st2-name {
      transform: translateX(23px);
      /* 4~10px ì‚¬ì´ë¡œ ì·¨í–¥ê» ì¡°ì ˆ ê°€ëŠ¥ */
    }

    /* Controls: left stack / center level box / right stack */
    .st2-ctrl2 {
      display: grid;
      grid-template-columns: max-content auto max-content;
      grid-template-rows: auto auto;
      align-items: center;
      justify-items: center;
      column-gap: 8px;
      row-gap: 2px;
    }

    /* Left/Right button stacks */
    .st2-side-left,
    .st2-side-right {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    /* Central level box */
    .st2-lv {
      grid-column: 2;
      grid-row: 1 / span 2;
      min-width: 110px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #3a2c21;
      background: #1a130f;
      color: #f0e6d2;
      text-align: center;
      font-weight: 800;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      margin-top: -50px;
      /* -2 ~ -6px ì •ë„ì—ì„œ ëˆˆìœ¼ë¡œ ë§ì¶°ë´ */
    }

    .st2-lvnums {
      display: flex;
      align-items: baseline;
      gap: 8px;
    }

    .st2-lv .cur,
    .st2-lv .tp {
      font-size: 16px;
      line-height: 1;
    }


    .st2-lv .sep {
      opacity: .6;
      margin: 0;
    }

    /* Buttons */
    .st2-btn {
      height: 24px;
      padding: 0 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid #3a2c21;
      background: #1a130f;
      color: #c7b589;
      cursor: pointer;
      white-space: nowrap;
    }

    .st2-btn:hover {
      border-color: #cfa24f;
      box-shadow: 0 0 0 2px rgba(207, 162, 79, .18) inset;
    }

    .st2-btn:disabled {
      opacity: .5;
      cursor: default;
      border-color: #2a211a;
      box-shadow: none;
    }

    /* Simple list modal */
    .simple-modal .dialog {
      width: min(420px, 92vw);
    }

    .simple-modal .list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      padding: 10px;
    }

    .simple-modal .list .opt-btn {
      height: 38px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: #1a1b27;
      color: #e6e9ef;
      cursor: pointer;
    }

    .simple-modal .list .opt-btn:hover {
      border-color: #6ea8ff;
      box-shadow: 0 0 0 2px rgba(110, 168, 255, .25) inset;
    }

    /* ========== ë¡œê·¸ì¸ ì´í›„ ë ˆì´ì•„ì›ƒ ì •ë¦¬(PC/Mobile ê³µí†µ) ========== */

    /* ê³µí†µ: hiddenì€ ì™„ì „ ì œê±° */
    [hidden] {
      display: none !important;
    }

    /* 1) ë¡œê·¸ì¸ ë·° ê³„ì—´ í†µì§¸ë¡œ ì ‘ê¸° (.login-wrap, #main-view, .hero) */
    body:is(.pc, .mobile) :is(.login-wrap, #main-view, section.hero) {
      display: none !important;
      height: 0 !important;
      min-height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    /* 2) .shellì€ ì»¨í…Œì´ë„ˆ ë°•ìŠ¤ ì œê±°(ìì‹ë§Œ íë¥´ê²Œ) */
    body:is(.pc, .mobile) .shell {
      display: contents !important;
      height: auto !important;
      min-height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      gap: 0 !important;
      grid-template-rows: none !important;
      grid-auto-rows: auto !important;
    }

    /* 3) ë³¸ë¬¸ ì‹œì‘ ê°„ê²©(í•„ìš” ì‹œ ìˆ«ìë§Œ ì¡°ì ˆ) */
    body:is(.pc, .mobile) #calc-view {
      margin-top: 12px !important;
    }

    /* 4) ì•ˆì „í•€: calc-viewëŠ” ìœ„ë¡œ ë”± ë¶™ê²Œ(ìƒë‹¨ ë§ˆì§„ ì´ˆê¸°í™”) */
    #calc-view {
      margin-top: 0 !important;
    }

    /* ===== Header ê´‘ê³ (ì˜¤ë¥¸ìª½ í…ìŠ¤íŠ¸) ===== */
    .header-ads {
      margin-left: auto;
      /* ìš°ì¸¡ ì •ë ¬ */
      margin-right: 40px;
      /* â† ìš°ì¸¡ ì—¬ë°± (ì›í•˜ë©´ 12~24px ì¡°ì ˆ) */
      display: flex;
      align-items: center;
      max-width: 40vw;
    }

    .header-ads .ad-text {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 32vw;
      transition: opacity .25s ease;
      opacity: 1;
    }

    .header-ads .fade-out {
      opacity: 0;
    }

    /* í•œë§ˆë”” ê³µí†µ */
    .header-ads .line .hdrmsg {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .header-ads .line .hdrmsg .msg-bullet {
      opacity: 0.6;
    }

    .header-ads .line .hdrmsg .msg-text {
      opacity: 0.95;
    }

    /* ë°°ì§€ ê¸°ë³¸ */
    .header-ads .line .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
      white-space: nowrap;
    }

    /* ì±…ì„ = ì°¨ë¶„í•œ ì¤‘ë¦½í†¤ */
    .header-ads .line .tag-lead {
      background: rgba(120, 120, 120, 0.12);
      color: rgba(120, 120, 120, 1);
      border: 1px solid rgba(120, 120, 120, 0.25);
    }

    /* ìˆ˜ì„ = ê³¨ë“œ ê·¸ë¼ë°ì´ì…˜ + ì€ì€í•œ ê´‘íƒ */
    /* ê³µí†µ ë ˆì´ì•„ì›ƒ */
    .hdrmsg {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .hdrmsg .msg-bullet {
      opacity: 0.6;
    }

    .hdrmsg .msg-text {
      opacity: 0.95;
    }

    /* ìˆ˜ì„ í•œë§ˆë”” ë„¤ì˜¨ íš¨ê³¼ (ì§ì±…ì´ ìˆ˜ì„ì¸ ê²½ìš°ë§Œ) */
    .header-ads .hdrmsg.senior {
      position: relative;
      /* í•œ ì¤„ ì „ì²´ê°€ ì€ì€í•˜ê²Œ ë¹›ë‚˜ë„ë¡ ë“œë ì„€ë„ìš° */
      filter: drop-shadow(0 0 4px rgba(250, 204, 21, 0.35));
    }

    /* ìˆ˜ì„ í•œë§ˆë””ì˜ ë³¸ë¬¸ í…ìŠ¤íŠ¸ ë„¤ì˜¨ */
    .header-ads .hdrmsg.senior .msg-text {
      color: #fef9c3;
      /* ì‚´ì§ ë” ë°ì€ ë…¸ë‘ */
      text-shadow:
        0 0 4px rgba(250, 204, 21, 0.65),
        0 0 8px rgba(250, 204, 21, 0.82),
        0 0 14px rgba(250, 204, 21, 0.95);
    }

    /* ìˆ˜ì„ í•œë§ˆë””ì—ì„œ ë‹‰ë„¤ì„ë„ ì‚´ì§ í‘¸ë¥¸ ë„¤ì˜¨ ëŠë‚Œ */
    .header-ads .hdrmsg.senior .msg-nick {
      color: #e5e7eb;
      text-shadow:
        0 0 3px rgba(59, 130, 246, 0.55),
        0 0 7px rgba(59, 130, 246, 0.75);
    }

    /* ìˆ˜ì„ í•œë§ˆë””ì˜ Â· êµ¬ë¶„ìš© ì ë„ ì‚´ì§ ê°•ì¡° */
    .header-ads .hdrmsg.senior .msg-bullet {
      color: #facc15;
      opacity: 0.9;
    }


    /* ìˆ˜ì„ ë°°ì§€(ğŸ‘‘ë§Œ ë“¤ì–´ê°€ë„ ì˜ˆì˜ê²Œ ë³´ì´ê²Œ) */
    .tag-senior {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 10px;
      /* pill ëª¨ì–‘ì´ ë³´ì´ë„ë¡ íŒ¨ë”© */
      min-width: 32px;
      /* ë„ˆë¬´ ì‘ê²Œ ë¶™ì§€ ì•Šê²Œ ìµœì†Œ í­ */
      height: 20px;
      border-radius: 999px;
      font-size: 13px;
      /* ğŸ‘‘ í¬ê¸° */
      line-height: 1;
      background: linear-gradient(135deg, #ffe08a 0%, #ffd257 45%, #ffc63a 100%);
      border: 1px solid rgba(172, 124, 22, 0.55);
      color: #2a1b00;
      /* ì´ëª¨ì§€ ì™¸ ê¸€ììƒ‰(í˜¹ì‹œ í…ìŠ¤íŠ¸ê°€ ì¶”ê°€ë˜ì–´ë„) */
      position: relative;
      overflow: hidden;
    }

    /* ì€ì€í•œ ë°˜ì§ì„ */
    .tag-senior::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, .45) 35%, transparent 70%);
      transform: translateX(-120%);
      animation: shimmer 2.4s linear infinite;
      pointer-events: none;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-120%);
      }

      100% {
        transform: translateX(120%);
      }
    }

    /* ì±…ì„ ë°°ì§€: ì•„ì£¼ ì‘ì€ íšŒìƒ‰ ì  */
    .tag-lead {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(120, 120, 120, .7);
      box-shadow: 0 0 0 1px rgba(120, 120, 120, .25);
      margin-right: 2px;
      /* ë‹‰ë„¤ì„ê³¼ ì‚´ì§ ê°„ê²© */
      vertical-align: middle;
    }

    /* ì±…ì„ ì§ì±… í•œë§ˆë””: ì´ë¦„ë§Œ ì§„í•˜ê²Œ */
    .hdrmsg.lead .msg-nick {
      font-weight: 700;
    }

    /* ìˆ˜ì„ ë‹‰ë„¤ì„ ì‚´ì§ ê°•ì¡° (ì˜µì…˜) */
    .hdrmsg.senior .msg-nick {
      font-weight: 600;
      text-decoration: underline;
      text-decoration-color: rgba(255, 198, 58, .7);
      text-underline-offset: 2px;
    }


    /* ì±…ì„ì€ ë°°ì§€ ì—†ìœ¼ë‹ˆ ë³„ë„ ìŠ¤íƒ€ì¼ ë¶ˆí•„ìš” (ì›í•˜ë©´ ì•„ì£¼ ì˜…ì€ ì  ë°°ì§€ ì¶”ê°€ ê°€ëŠ¥) */
    .loading {
      opacity: 0.7;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(0, 0, 0, .55);
      display: grid;
      place-items: center;
    }

    .loading-box {
      width: min(480px, 90vw);
      background: #0f1115;
      color: #e6e9ef;
      border: 1px solid rgba(255, 255, 255, .2);
      border-radius: 14px;
      padding: 20px 24px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .45);
    }

    .loading-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .loading-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .12);
      overflow: hidden;
    }

    .loading-bar__fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #6ea8ff, #8fe3ff);
      transition: width .2s ease;
    }

    .loading-info {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      opacity: .9;
    }

    /* ì„±ì•ˆì˜ ë´‰ì¸ ëª¨ë‹¬ ë ˆì´ì•„ì›ƒ */


    #castleSealModal .opt-row {
      display: block;
      width: 100%;
      text-align: left;
      border: 1px solid rgba(255, 255, 255, .15);
      background: #0f1115;
      border-radius: 8px;
      padding: 12px 14px;
      margin: 8px 0;
    }

    #castleSealModal .opt-row .name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    #castleSealModal .opt-row .desc {
      opacity: .9;
      font-size: 12px;
      line-height: 1.3;
    }

    #castleSealModal .opt-row.active {
      outline: 2px solid #8fe3ff;
      background: #121521;
    }

    .seal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      /* ì œëª© ì™¼ìª½, ë²„íŠ¼ ì˜¤ë¥¸ìª½ */
      gap: 8px;
    }

    #optSeal .opt-title {
      margin: 0;
      font-size: 14px;
    }
  .sign-row{
    display: flex;
    align-items: center;   /* ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬ */
    gap: 10px;             /* ì´ë¯¸ì§€-ë¬¸êµ¬ ê°„ê²© */
    justify-content: center; /* ê°€ìš´ë° ì •ë ¬ (ì™¼ìª½ ì •ë ¬ ì›í•˜ë©´ ì œê±°) */
  }
  .seal-stamp{
    width: 90px;           /* í•„ìš” ì‹œ í¬ê¸°ë§Œ ì¡°ì ˆ */
    height: auto;
    display: block;
  }
  .sign-text{
    font-weight: 600;
    font-size: 15px;
    white-space: nowrap;   /* ì¤„ë°”ê¿ˆ ë°©ì§€ (ì¢ì€ í™”ë©´ì—ì„œ ì¤„ë°”ê¿ˆ í—ˆìš©í•˜ë ¤ë©´ ì§€ìš°ê¸°) */
  }

  /* ì›Œë¦¬ì–´ ì™€ì¼ë“œë² ì¸: ìŠ¤í‚¬íŠ¸ë¦¬(2ì•ˆ) ì„ íƒ ëª¨ë‹¬ */
.wb-tree-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
  margin-bottom:4px;  /* âœ… ì‚¬ì´í´ ì…ë ¥ì´ ë°”ë¡œ ì•„ë˜ ë¶™ë„ë¡ */
}
.wb-tree-btn{
  height:44px;
  border-radius:12px;
  border:1px solid #e5e7eb;
  background:#fff;
  font-weight:800;
  cursor:pointer;
}
.wb-tree-btn.wb-active{
  /* âœ… ì„ íƒ ê°•ì¡°: ë…¸ë€ìƒ‰ í…Œë‘ë¦¬ */
  border-color:#facc15;                 /* ë…¸ë€ìƒ‰ */
  box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.35) inset;

  /* ë°°ê²½/ê¸€ììƒ‰ì€ ì·¨í–¥ëŒ€ë¡œ: 'í…Œë‘ë¦¬ë§Œ ë…¸ë—ê²Œ'ë¥¼ ì›í•˜ë©´ ì•„ë˜ 2ì¤„ì€ ì§€ì›Œë„ ë¨ */
  background: rgba(250, 204, 21, 0.10);
  color:#fff;
}

/* ì›Œë¦¬ì–´ ì™€ì¼ë“œë² ì¸: ì‚¬ì´í´ íšŸìˆ˜ ì…ë ¥ UI (pretty ver.) */
.wb-cycle-wrap{
  /* âœ… í° ìƒì ì œê±° + ë²„íŠ¼ ë°”ë¡œ ì•„ë˜ ë¶™ì´ê¸° */
  margin-top: 2px;
  padding: 0;
  border: none;
  border-radius: 0;
  background: transparent;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}


.wb-cycle-label{
  font-size: 13px;
  font-weight: 900;
  letter-spacing: -0.2px;
  color: #fff;                  /* âœ… í…ìŠ¤íŠ¸ ìƒ‰ ë³€ê²½ */
  text-shadow: 0 1px 0 rgba(0,0,0,0.25);
  text-align: center;           /* âœ… ê°€ìš´ë° ì •ë ¬ */
}

.wb-cycle-row{
  display: flex;
  align-items: center;
  justify-content: center;      /* âœ… ê°€ìš´ë° ì •ë ¬ */
  gap: 10px;
}

.wb-cycle-input{
  width: 120px;                 /* âœ… ê°€ë¡œ ê¸¸ì´ ì¤„ì´ê¸° (ì›í•˜ë©´ 100~160 ì¡°ì ˆ) */
  height: 42px;
  border-radius: 12px;
  border: 1px solid rgba(250, 204, 21, 0.45);
  background: rgba(17,24,39,0.75);
  color: #fff;
  text-align: center;           /* âœ… ìˆ«ì ê°€ìš´ë° ì •ë ¬ */
  font-size: 15px;
  font-weight: 900;
  outline: none;
}

.wb-cycle-input::placeholder{
  color: rgba(255,255,255,0.55);
}

.wb-cycle-input:focus{
  border-color: rgba(250, 204, 21, 0.95);
  box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.28);
}



  /* í™”ë©´ì´ ì•„ì£¼ ì¢ì„ ë•ŒëŠ” ì„¸ë¡œë¡œ ìŒ“ê¸° (ì„ íƒ) */
  @media (max-width: 420px){
    .sign-row{ flex-direction: column; gap: 6px; }
    .sign-text{ white-space: normal; }
  }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

<body>
  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ (ê¸°ë³¸ hidden) -->
  <div id="loadingOverlay" class="loading-overlay" hidden>
    <div class="loading-box">
      <div class="loading-title">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      <div class="loading-bar">
        <div class="loading-bar__fill" style="width:0%"></div>
      </div>
      <div class="loading-info">
        <span id="loadingLabel">ì´ˆê¸°í™”â€¦</span>
        <span id="loadingPct">0%</span>
      </div>
    </div>
  </div>
  <div class="shell">
    <header>
      <div class="title">
        <div class="logo-box">
          <img src="img/gametestlab.png" alt="ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ ë¡œê³ ">
        </div>
        <h1>ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ ê³„ì‚°ê¸° (ì‹œì¦Œ5)</h1>
        <!-- ê´€ë¦¬ì ë¬¸ì˜ ì•„ì´ì½˜ ë²„íŠ¼ (ë¡œê·¸ì¸ í›„ì—ë§Œ ë³´ì´ë„ë¡ JSì—ì„œ í‘œì‹œ) -->
        <button id="btnContactAdmin" class="contact-btn" type="button" title="ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œì— ë¬¸ì˜">
          <svg viewBox="0 0 24 24" aria-hidden="true" class="icon-mail">
            <rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect>
            <path d="M3 7l9 6 9-6"></path>
          </svg>
          <span class="contact-label">ë¬¸ì˜í•˜ê¸°</span>
        </button>
        <button id="btnFaq" class="contact-btn faq-btn" type="button" title="ë¬¸ì˜í•˜ê¸° ì „ ìì£¼í•˜ëŠ” Q&A">
  <svg viewBox="0 0 24 24" aria-hidden="true" class="icon-mail">
    <path d="M12 18h.01"></path>
    <path d="M9.1 9a3 3 0 1 1 5.8 1c-.6.7-1.4 1.1-1.9 1.5-.4.4-.5.6-.5 1.5"></path>
    <path d="M12 22c5.5 0 10-4.5 10-10S17.5 2 12 2 2 6.5 2 12s4.5 10 10 10z"></path>
  </svg>
  <span class="contact-label">Q&amp;A</span>
</button>
      </div>
      <!--span ì€ í•œì¤„ì—ì„œ íŠ¹ë³„íˆ ê°•ì¡° í• ë•Œ ì“´ë‹¤. divëŠ” í•œì¤„ì´ ê°•ì œë¡œ ë‚˜ë‰˜ê¸°ë•Œë¬¸ì— ì“´ë‹¤.-->
      <div class="actions">
        <div class="sp-tp" id="spTpTop">
          <span class="counter-pill sp"><span class="lab">SP</span><span id="spLeftTop"
              style="min-width:24px;display:inline-block;text-align:right;">â€”</span></span>
          <span class="counter-pill tp"><span class="lab">TP</span><span id="tpLeftTop"
              style="min-width:24px;display:inline-block;text-align:right;">â€”</span></span>

        </div>
      </div>
    </header>
    <section id="main-view">
      <!-- ì—¬ê¸°ì— ë„¤ê°€ ë§Œë“  ë©”ì¸(ë°°ê²½/ìš°ì¸¡ ê³µì§€/ë¹¨ê°„ íƒ€ì› ìœ„ì¹˜ ë¡œê·¸ì¸ ì¹´ë“œ) ë§ˆí¬ì—… -->
      <!-- PC / ëª¨ë°”ì¼ ë²„íŠ¼ë„ ì—¬ê¸° -->
      <div class="wrap">
        <h1 class="top-title">ë˜ì „ì•¤íŒŒì´í„° ëª¨ë°”ì¼ <span style="color:#ffdf6b">ì‹œì¦Œ 5</span> ë°ë¯¸ì§€ ê³„ì‚°ê¸°</h1>
        <div class="main2">â€» ë³¸ ê³„ì‚°ê¸°ëŠ” ê²Œì„í”Œë ˆì´ì— ë„ì›€ì´ ë˜ê³ ì ë§Œë“  ê²ƒì…ë‹ˆë‹¤. ìˆœìˆ˜í•œ ì •ë³´ê³µìœ ê°€ ì•„ë‹Œ, ìƒì—…ì  ëª©ì ìœ¼ë¡œì˜ ë¸”ë¡œê·¸ ê²Œì¬, ê°œì¸ë°©ì†¡, ìœ íŠœë¸Œ ì˜ìƒì œì‘ ë“±ì˜ ì œì‘ì ë™ì˜ì—†ëŠ”
          ì´ìš©ì„ ê¸ˆí•˜ë©°, ë¬´ë‹¨ìˆ˜ì • ë° ë„ìš©ë„ ì—„ê²©íˆ ê¸ˆì§€í•©ë‹ˆë‹¤.</div>

        <div class="grid">
          <!-- ì™¼ìª½: ë©”ì¸ ë¹„ì£¼ì–¼ -->
          <section class="hero">
            <!-- ë„¤ê°€ ì“°ë ¤ëŠ” ë©”ì¸ ì´ë¯¸ì§€ë¥¼ ë„£ì–´ì¤˜ -->
            <img class="hero-img" src="img/main/main.png" alt="ë©”ì¸ ë¹„ì£¼ì–¼" />
          </section>
          <!-- ì˜¤ë¥¸ìª½: ê³µì§€/ì—…ë°ì´íŠ¸ -->
          <div class="sidebar">
            <aside class="notice">
              <h3>* ê³„ì‚°ê¸°ëŠ” ê³„ì†í•´ì„œ ì—…ë°ì´íŠ¸ë  ì˜ˆì •ì…ë‹ˆë‹¤!</h3>
              <div class="box">
                <div class="notice-top-row">
                  <div class="badge-danger">25.11.29 ì‹œì¦Œ5 ì‹ ê·œ ê³„ì‚°ê¸° ë°°í¬</div>
                  <button type="button" id="btnPatchLog" class="btn patch-log-btn">
                    íŒ¨ì¹˜ë‚´ì—­ ì „ì²´ë³´ê¸°
                  </button>
                </div>
                <ul class="notice-list">
                  <li>ê³„ì‚°ê¸° ì‚¬ìš©ë²• <a href="https://www.youtube.com/channel/UCijUV3SuVe_qErzBpdOmKIA/join" target="_blank"
                      rel="noopener">ì˜ìƒ</a> ë³´ëŸ¬ê°€ê¸°! </li> 
                  <li>01.18 <span class="notice-badge">'ë‚¨ë©”ì¹´ë‹‰'</span> ìºë¦­ ì¶”ê°€</li>
                  <li>01.19 <span class="notice-badge">'ì¿ ë…¸ì´ì¹˜'</span> ìºë¦­ ì¶”ê°€</li>
                  <li>01.20 <span class="notice-badge">'ë§ˆë„í•™ì'</span> ìºë¦­ ì¶”ê°€</li>
                  <li>01.21 <span class="notice-badge">'ì¸ì±ˆíŠ¸ë¦¬ìŠ¤'</span> <span class="notice-badge">'ì—¬ëŸ°ì²˜'</span> ìºë¦­ ì¶”ê°€</li>
                  <li>01.23 ì¼ë¶€ ë§ˆë²•ë¶€ì—¬, ì˜¤ë¼, í¬ë¦¬ì³ ì¶”ê°€</li>
                </ul>
              </div>
              <div class="upgrade">
                ë©¤ë²„ì‹­ ì—…ê·¸ë ˆì´ë“œ ì‹œ <span class="main2" style="font-size:16px;">ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥</span> ì´ìš©ê°€ëŠ¥ <br> â†’
                <!--ë©¤ë²„ì‹­ ì—…ê·¸ë ˆì´ë“œ ì‹œ <span class="main2" style="font-size:16px;">ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°</span> ë“± í¸ì˜ ê¸°ëŠ¥ ì´ìš© ê°€ëŠ¥ <br> â†’-->
                <a href="https://www.youtube.com/channel/UCijUV3SuVe_qErzBpdOmKIA/join" target="_blank"
                  rel="noopener">ì§€ê¸ˆ ë©¤ë²„ì‹­ ì—…ê·¸ë ˆì´ë“œ!!!</a>
              </div>
            </aside>
            <div class="login-card">
              <div class="login-title">ê³„ì‚°ê¸° ì ‘ê·¼ì„ ìœ„í•´ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</div>
              <div class="login-desc">
                í—ˆìš©ëœ ê³„ì •ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ìë™ìœ¼ë¡œ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤.
              </div>

              <div class="login-row">
                <!-- Google Sign-In ë²„íŠ¼ -->
                <!-- 1) onload ì„¸íŒ…: client_id êµì²´ í•„ìˆ˜ -->
                <div id="g_id_onload"
                  data-client_id="110486887643-3c136grpud2llf2b31d24fqr40s1p44g.apps.googleusercontent.com"
                  data-callback="onGoogleCredential" data-auto_select="true" data-auto_prompt="false"
                  data-itp_support="true">
                </div>
                <!-- 2) ë²„íŠ¼ ë Œë” -->
                <div class="g_id_signin" data-type="standard" data-size="large" data-shape="pill" data-theme="outline"
                  data-text="signin_with" data-logo_alignment="left">
                </div>

                <div class="login-hint">â€» ë²„íŠ¼ì´ ë³´ì´ì§€ ì•Šìœ¼ë©´ íŒì—…/ì¶”ì ì°¨ë‹¨ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
  </section>
  <section id="calc-view" hidden>
    <section class="layout">
      <div class="column left">
        <div class="auto-box">
          <h4>
            <span class="label-with-tip">
              ìë™ ì…ë ¥
              <span class="info-tip" tabindex="0" aria-label="ê°•í™” Â· ë§ˆë²•ë´‰ì¸ ìë™ ì…ë ¥ ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ì¥ë¹„ ê°•í™”ì™€ ë§ˆë²•ë´‰ì¸ ì˜µì…˜ì„ ì†ì„±ì— ë§ëŠ” ì¶”ì²œ ì¡°í•©ìœ¼ë¡œ í•œ ë²ˆì— ì±„ì›ë‹ˆë‹¤.<br>
                  ìë™ ì…ë ¥ í›„ì—ë„ ê°œë³„ ìŠ¬ë¡¯ì€ ììœ ë¡­ê²Œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </span>
              </span>
            </span>
          </h4>
          <button id="btnAutoEnh" class="btnetc">ê°•í™” ìë™ ì…ë ¥</button>
          <div style="height:8px;"></div>
          <button id="btnAutoSeal" class="btnetc">ì¶”ì²œ ë§ˆë²•ë´‰ì¸ ìë™ ì…ë ¥</button>
        </div>

        <div class="slot-row left">
          <div class="outer-rects"><button class="rect">ì„ íƒ</button><button class="rect">ì„ íƒ</button><button
              class="rect">ì„ íƒ</button></div>
          <div class="slot" data-slot="L1"><span class="slot-label">ë¨¸ë¦¬ì–´ê¹¨</span></div>
        </div>
        <!-- âœ… ìƒì˜ í–‰: 1ì—´ ë³´ì¡°ìŠ¬ë¡¯ / 2ì—´ ì»¤ìŠ¤í…€ì˜µ+ìƒì˜ / 3ì—´ ì— ë¸”ë ˜ìŠ¤íƒ -->
        <div class="slot-row left armor-row">
          <!-- 1ì—´: ë³´ì¡°ìŠ¬ë¡¯ë“¤ (ê°•í™”/ë§ˆë´‰/ë§ˆë¶€) -->
          <div class="outer-rects">
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
          </div>

          <!-- 2ì—´: ìƒì˜ ìŠ¬ë¡¯ (ì•„ë˜), ì»¤ìŠ¤í…€ì˜µ(ìƒì˜) ë²„íŠ¼ (ìœ„) -->
          <div class="slot" data-slot="L2">
            <span class="slot-label">ìƒì˜</span>
          </div>
          <button class="rect" id="btnCustomOptArmor">ê³ ìœ íš¨ê³¼(ìƒì˜)</button>

          <!-- 3ì—´: ì— ë¸”ë ˜ ìŠ¤íƒì€ JSê°€ ìë™ìœ¼ë¡œ <div class="emblem-stack">...</div> ë¥¼ appendChild í•´ì¤Œ -->
        </div>
        <div class="slot-row left">
          <div class="outer-rects"><button class="rect">ì„ íƒ</button><button class="rect">ì„ íƒ</button><button
              class="rect">ì„ íƒ</button></div>
          <div class="slot" data-slot="L3"><span class="slot-label">í•˜ì˜</span></div>
        </div>
        <div class="slot-row left">
          <div class="outer-rects"><button class="rect">ì„ íƒ</button><button class="rect">ì„ íƒ</button><button
              class="rect">ì„ íƒ</button></div>
          <div class="slot" data-slot="L4"><span class="slot-label">í—ˆë¦¬</span></div>
        </div>
        <div class="slot-row left">
          <div class="outer-rects"><button class="rect">ì„ íƒ</button><button class="rect">ì„ íƒ</button><button
              class="rect">ì„ íƒ</button></div>
          <div class="slot" data-slot="L5"><span class="slot-label">ì‹ ë°œ</span></div>
        </div>
        <!-- âœ… ê·€ê±¸ì´ í–‰: 1ì—´ ë³´ì¡°ìŠ¬ë¡¯ / 2ì—´ ì»¤ìŠ¤í…€ì˜µ+ê·€ê±¸ì´ / 3ì—´ ì— ë¸”ë ˜ -->
        <div class="slot-row left earring-row">
          <!-- 1ì—´: ê°•í™”/ë§ˆë´‰/ë§ˆë¶€ ë“± ë³´ì¡°ìŠ¬ë¡¯ -->
          <div class="outer-rects">
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
          </div>

          <!-- 2ì—´: ê·€ê±¸ì´ ìŠ¬ë¡¯(ì•„ë˜) -->
          <div class="slot" data-slot="L6">
            <span class="slot-label">ê·€ê±¸ì´</span>
          </div>

          <!-- 2ì—´: ì»¤ìŠ¤í…€ì˜µ(ê·€ê±¸ì´) ë²„íŠ¼(ìœ„) -->
          <button class="rect" id="btnCustomOptEarring">ê³ ìœ íš¨ê³¼(ê·€ê±¸ì´)</button>

          <!-- 3ì—´: ì— ë¸”ë ˜ ìŠ¤íƒì€ JSê°€ <div class="emblem-stack">ë¥¼ appendChild í•´ì¤Œ -->
        </div>
      </div>

      <div class="center">
        <div class="center-top-row">
          <!-- âœ… ì™¼ìª½: í…ŒìŠ¤íŠ¸ ì „ìš© ë²„íŠ¼ë“¤ (ë°©ì–´êµ¬ / ì•…ì„¸ì‚¬ë¦¬) -->
          <div class="center-special-col">
            <button id="btnSpecialPatch" class="btn btn-special-patch" type="button" style="display: none;">
              ë°©ì–´êµ¬ ì„¸íŠ¸
            </button>

            <button id="btnSpecialAcc" class="btn btn-special-patch" type="button" style="display: none;">
              ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸
            </button>

              <!-- âœ… ìƒˆë¡œ ì¶”ê°€ -->
    <button id="btnSpecialSpec"
            class="btn btn-special-patch"
            type="button"
            style="display:none;">
      íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸
    </button>

      <!-- âœ… ê³ ìœ íš¨ê³¼ ì¼ê´„ì ìš© ë²„íŠ¼ -->
  <button id="btnUniqueBulk"
          class="btn btn-special-patch"
          type="button"
          style="display:none;">
    ê³ ìœ íš¨ê³¼ ì¼ê´„ì ìš©
  </button>

  <!-- âœ… ì§€ì • ì„¸íŠ¸ ìë™ê³„ì‚° ë²„íŠ¼ -->
<button id="btnAutoSetSweepSelected"
        class="btn btn-special-patch"
        type="button"
        style="display:none;">
  ì„ íƒ ì„¸íŠ¸ ìë™ê³„ì‚°
</button>

<button id="btnAutoSetSweepMissing" class="ui-btnetc" style="display:none;">
  ëˆ„ë½ë§Œ ì¬ê³„ì‚°(ë°©ì–´êµ¬ ê³ ì •)
</button>

<button id="btnAutoWeaponSweepSelected" class="special-btn" style="display:none;">
  ë¬´ê¸°/ë¬´ê¸°ê³ ìœ íš¨ê³¼ ìë™ê³„ì‚°
</button>



    <!-- âœ… ê³ ìœ íš¨ê³¼ ON/OFF í† ê¸€ -->
  <div id="uniqueOnOffRow" class="unique-onoff-row" style="display:none;">
    <div id="uniqueOnOffToggle"
         class="armor-toggle mode-off"
         role="button"
         tabindex="0"
         aria-label="ON / OFF ì „í™˜">
      <span class="armor-toggle-label armor-toggle-label-off">OFF</span>
      <span class="armor-toggle-label armor-toggle-label-on">ON</span>
      <div class="armor-toggle-thumb"></div>
    </div>
  </div>
</div>

          <!-- ì˜¤ë¥¸ìª½: ìºë¦­í„° ì¹´ë“œ -->
          <div id="characterCard" class="character-card">
            <img id="characterImg" class="character-img" alt="ìºë¦­í„°" />
            <div id="characterGhost" class="character-ghost">í´ë¦­í•˜ì—¬ ìºë¦­í„° ì„ íƒ</div>
          </div>
        </div>
        <div class="mini-bar">
          <div class="mini-cell">
            <div class="outer-rects">
              <button class="rect" data-unused="true">ì„ íƒ</button>
              <button class="rect" data-unused="true">ì„ íƒ</button>
            </div>
            <div class="slot mini" data-slot="C2"><span class="slot-label">ì¹­í˜¸</span></div>
          </div>
          <div class="slot mini" data-slot="C1"><span class="slot-label">ì˜¤ë¼</span></div>
          <div class="slot mini" data-slot="C3"><span class="slot-label">í¬ë¦¬ì³</span></div>
          <div class="slot mini" data-slot="C4"><span class="slot-label">ì•„í‹°íŒ©íŠ¸</span></div>
        </div>
        <div class="save-box">
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="1">+</button>
            <button type="button" class="preset-trash" data-slot="1" aria-label="ìŠ¬ë¡¯ 1 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="2">+</button>
            <button type="button" class="preset-trash" data-slot="2" aria-label="ìŠ¬ë¡¯ 2 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="3">+</button>
            <button type="button" class="preset-trash" data-slot="3" aria-label="ìŠ¬ë¡¯ 3 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="4">+</button>
            <button type="button" class="preset-trash" data-slot="4" aria-label="ìŠ¬ë¡¯ 4 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="5">+</button>
            <button type="button" class="preset-trash" data-slot="5" aria-label="ìŠ¬ë¡¯ 5 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="6">+</button>
            <button type="button" class="preset-trash" data-slot="6" aria-label="ìŠ¬ë¡¯ 6 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="7">+</button>
            <button type="button" class="preset-trash" data-slot="7" aria-label="ìŠ¬ë¡¯ 7 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="8">+</button>
            <button type="button" class="preset-trash" data-slot="8" aria-label="ìŠ¬ë¡¯ 8 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="9">+</button>
            <button type="button" class="preset-trash" data-slot="9" aria-label="ìŠ¬ë¡¯ 9 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <div class="preset-slot">
            <button type="button" class="preset-btn" data-slot="10">+</button>
            <button type="button" class="preset-trash" data-slot="10" aria-label="ìŠ¬ë¡¯ 10 ì´ˆê¸°í™”">ğŸ—‘</button>
          </div>
          <button type="button" class="preset-page-btn prev" id="presetPagePrev" aria-label="ì´ì „ ì €ì¥ìŠ¬ë¡¯ í˜ì´ì§€">â€¹</button>
<button type="button" class="preset-page-btn next" id="presetPageNext" aria-label="ë‹¤ìŒ ì €ì¥ìŠ¬ë¡¯ í˜ì´ì§€">â€º</button>
<div class="preset-page-ind" id="presetPageInd" aria-hidden="true"></div>
        </div>

      </div>

      <div class="column right">
        <div class="auto-box">
          <h4>
            <span class="label-with-tip">
              ìë™ ì…ë ¥
              <span class="info-tip" tabindex="0" aria-label="ê°•í™” Â· ë§ˆë²•ë´‰ì¸ ìë™ ì…ë ¥ ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ë§ˆë²•ë¶€ì—¬ì™€ ì— ë¸”ë ˜ì„ ì†ì„±Â·í‹°ì–´Â·ë‹¨ê³„ì— ë§ì¶˜ ì¶”ì²œ ì¡°í•©ìœ¼ë¡œ ìë™ ë°°ì¹˜í•©ë‹ˆë‹¤.<br>
                  ì¶”ì²œ ì¡°í•© ì„¸íŒ…ì´ë‹ˆ, ì‚¬ìš©í•˜ê³  ìˆëŠ” ì„¸ë¶€ ì„¤ì •ì€ ì§ì ‘ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.
                </span>
              </span>
            </span>
          </h4>
          <button id="btnAutoEnchant" class="btnetc">ì¶”ì²œ ë§ˆë²•ë¶€ì—¬ ìë™ ì…ë ¥</button>
          <div style="height:8px;"></div>
          <button id="btnAutoEmblem" class="btnetc">ì— ë¸”ë ˜ ìë™ ì…ë ¥</button>
        </div>

        <!-- âœ… ë¬´ê¸° í–‰: ì— ë¸”ë ˜ / (ì»¤ìŠ¤í…€ì˜µ+ë¬´ê¸°) / ê°•í™”Â·ë§ˆë´‰Â·ë§ˆë²•Â·ì—°ë§ˆ -->
        <div class="slot-row right weapon-row">
          <!-- ì´ slot ì„ ê¸°ì¤€ìœ¼ë¡œ ì— ë¸”ë ˜ ìŠ¤íƒì´ ìë™ ì£¼ì…ë¨ (1ì—´) -->
          <div class="slot" data-slot="R1">
            <span class="slot-label">ë¬´ê¸°</span>
          </div>

          <!-- 3ì—´: ê¸°ì¡´ ê°•í™”/ë§ˆë´‰/ë§ˆë²•/ì—°ë§ˆ ë²„íŠ¼ -->
          <div class="outer-rects">
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
          </div>

          <!-- 2ì—´: ìœ„ì— ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼, ì•„ë˜ì— ë¬´ê¸° ìŠ¬ë¡¯ (ê·¸ë¦¬ë“œì—ì„œ ìœ„ì¹˜ ì§€ì •) -->
          <button class="rect" id="btnCustomOpt">ì»¤ìŠ¤í…€ì˜µ</button>
        </div>

        <div class="slot-row right bracelet-row">
          <!-- ì´ slot ì„ ê¸°ì¤€ìœ¼ë¡œ ì— ë¸”ë ˜ ìŠ¤íƒì´ ìë™ ì£¼ì…ë¨ (1ì—´) -->
          <div class="slot" data-slot="R2">
            <span class="slot-label">íŒ”ì°Œ</span>
          </div>

          <!-- 3ì—´: ê¸°ì¡´ ê°•í™”/ë§ˆë´‰/ë§ˆë²•/ì—°ë§ˆ ë²„íŠ¼ -->
          <div class="outer-rects">
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
          </div>

          <!-- 2ì—´: ìœ„ì— ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼, ì•„ë˜ì— ë¬´ê¸° ìŠ¬ë¡¯ (ê·¸ë¦¬ë“œì—ì„œ ìœ„ì¹˜ ì§€ì •) -->
          <button class="rect" id="btnCustomOptBracelet">ê³ ìœ íš¨ê³¼(íŒ”ì°Œ)</button>
        </div>

        <div class="slot-row right">
          <div class="slot" data-slot="R3"><span class="slot-label">ëª©ê±¸ì´</span></div>
          <div class="outer-rects"><button class="rect">ì„ íƒ</button><button class="rect">ì„ íƒ</button><button
              class="rect">ì„ íƒ</button></div>
        </div>
        <div class="slot-row right">
          <div class="slot" data-slot="R4"><span class="slot-label">ë°˜ì§€</span></div>
          <div class="outer-rects"><button class="rect">ì„ íƒ</button><button class="rect">ì„ íƒ</button><button
              class="rect">ì„ íƒ</button></div>
        </div>
        <div class="slot-row right">
          <div class="slot" data-slot="R5"><span class="slot-label">ë³´ì¡°ì¥ë¹„</span></div>
          <div class="outer-rects"><button class="rect">ì„ íƒ</button><button class="rect">ì„ íƒ</button><button
              class="rect">ì„ íƒ</button><button class="rect">ì„ íƒ</button></div>
        </div>
        <!-- ë§ˆë²•ì„ ìŠ¬ë¡¯ (R6) -->
        <div class="slot-row right">
          <div class="slot" data-slot="R6"><span class="slot-label">ë§ˆë²•ì„</span></div>
          <div class="outer-rects">
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
            <button class="rect">ì„ íƒ</button>
          </div>
        </div>

      </div>

      <div class="column options">
        <div class="opt-box">
          <h4 class="opt-title">ì•„ë°”íƒ€ ì„¸ë¶€ ì„ íƒ</h4>
          <label class="field">
            <span class="label label-with-tip">
              ì•„ë°”íƒ€
              <span class="info-tip" tabindex="0" aria-label="ì•„ë°”íƒ€ ì˜µì…˜ ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ì„ íƒí•œ ì•„ë°”íƒ€ì˜ ëŠ¥ë ¥ì¹˜, ìŠ¤í‚¬ë ˆë²¨ ì¦ê°€ ë“±ì˜ ì˜µì…˜ì„<br>
                  ìµœì¢… ë°ë¯¸ì§€ ê³„ì‚°ì— í¬í•¨í•©ë‹ˆë‹¤.
                </span>
              </span>
            </span>
            <select id="selAvatar" class="select" aria-label="ì•„ë°”íƒ€ ì„ íƒ">

            </select>
          </label>
          <label class="field">
            <span class="label label-with-tip">
              ë¬´ê¸°ì••
              <span class="info-tip" tabindex="0" aria-label="ë¬´ê¸°ì•• ì˜µì…˜ ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ì°©ìš©í•˜ê³  ìˆëŠ” ë¬´ê¸°ì•„ë°”íƒ€ì˜ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”<br>
                  í•´ë‹¹ ëŠ¥ë ¥ì¹˜ë¥¼ ìµœì¢… ë°ë¯¸ì§€ì— ë°˜ì˜í•©ë‹ˆë‹¤.
                </span>
              </span>
            </span>
            <select id="selImprint" class="select" aria-label="ë¬´ê¸°ì•• ì„ íƒ">

            </select>
          </label>
        </div>

        <div class="opt-box">
          <h4 class="opt-title">ê³„ì‚° ì„¸ë¶€ ì˜µì…˜ ì¡°ì ˆ</h4>
          <label class="field">
            <span class="label label-with-tip">
              ì‹œê°„ ê¸°ì¤€
              <span class="info-tip" tabindex="0" aria-label="ì‹œê°„ ê¸°ì¤€ ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ì„ íƒí•œ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ìŠ¤í‚¬ ì‚¬ìš© íšŸìˆ˜ì™€ ìµœì¢… ë°ë¯¸ì§€ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.<br>
                  ì˜ˆ) 30ì´ˆë”œì€ 30ì´ˆ ê¸°ì¤€ ë¡œí…Œì´ì…˜, 3ë¶„ë”œì€ 180ì´ˆ ê¸°ì¤€ì…ë‹ˆë‹¤.
                </span>
              </span>
            </span>
            <select id="selTime" class="select" aria-label="ì‹œê°„ ê¸°ì¤€">
              <option value="" disabled>ì‹œê°„ ê¸°ì¤€</option>
              <option value="30s">30ì´ˆë”œ</option>
              <option value="1m" selected>1ë¶„ë”œ</option>
              <option value="3m">3ë¶„ë”œ</option>
              <option value="5m">5ë¶„ë”œ</option>
              <option value="10m">10ë¶„ë”œ</option>
            </select>
          </label>
          <!--document.getElementById("selMonster").value ë¼ê³  ì“°ë©´ ì„¤ì •ëœ ëª¬ìŠ¤í„°ê°’ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŒ-->
          <label class="field">
            <span class="label label-with-tip">
              ëª¬ìŠ¤í„° ì„¤ì •
              <span class="info-tip" tabindex="0" aria-label="ëª¬ìŠ¤í„° ì„¤ì • ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ëª¬ìŠ¤í„°ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ëª¬ìŠ¤í„°ì˜ ì†ì„±ì €í•­ê³¼ ëª¬ìŠ¤í„° ë ˆë²¨ì´ ê²°ì •ë©ë‹ˆë‹¤.<br>
                  ë°©ì–´ë ¥ì€ ê·¼ì‚¬ê°’ìœ¼ë¡œ ì„ì˜ì§€ì •ë˜ì–´ ì‹¤ì œ ë°ë¯¸ì§€ì™€ëŠ” ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </span>
              </span>
            </span>
            <select id="selMonster" class="select" aria-label="ëª¬ìŠ¤í„° ì„¤ì •">
              <option value="" selected disabled>ëª¬ìŠ¤í„° ì„¤ì •</option>
            </select>
          </label>

          <label class="field">
            <span class="label label-with-tip">
              ë˜ì „ ë‚œì´ë„(ë¯¸êµ¬í˜„)
              <span class="info-tip" tabindex="0" aria-label="ë˜ì „ ë‚œì´ë„ ì„¤ëª…">
                i
                <span class="info-tip-content">
                  í˜„ì¬ëŠ” ê³ ì •ë˜ì–´ìˆëŠ” ëˆ„ê³¨ë°© ê¸°ì¤€ìœ¼ë¡œë§Œ ê³„ì‚°í•©ë‹ˆë‹¤.<br>
                  ì¶”í›„ ë‚œì´ë„ë³„ ìŠ¤í‚¬/í‰íƒ€ ì‚¬ìš©íšŸìˆ˜ ë³´ì • ê¸°ëŠ¥ì´ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.
                </span>
              </span>
            </span>
            <select id="selDifficulty" class="select" aria-label="ë˜ì „ ë‚œì´ë„ ì„¤ì •">
              <option value="" disabled>ë˜ì „ ë‚œì´ë„ ì„¤ì •</option>
              <option value="hard" disabled>ì–´ë ¤ì›€</option>
              <option value="normal" disabled>ë³´í†µ</option>
              <option value="easy" disabled>ì‰¬ì›€</option>
              <option value="nugol_room" selected>ëˆ„ê³¨ë°©</option>
            </select>
          </label>
        </div>
        <div class="opt-box">
          <h4 class="opt-title">
            <span class="label-with-tip">
              ìŠ¤í‚¬ë£¬
              <span class="info-tip" id="runeInfoTip" tabindex="0" aria-label="ìŠ¤í‚¬ë£¬ ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ìŠ¤í‚¬ë£¬ì€ ìµœëŒ€ 20ê°œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                  ê°€í˜¸/ì§€í˜œë£¬ì€ ìƒì‹œì ìš©ë˜ë©°, ì™œê³¡ë£¬ì€ ì˜µì…˜ì´ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </span>
              </span>
            </span>
          </h4>
          <div class="rune-head">
            <button id="btnRune" class="ui-btn ghost" type="button" aria-label="ìŠ¤í‚¬ë£¬ ì„¤ì •">
              ìŠ¤í‚¬ë£¬ ì„¤ì •
            </button>
            <div style="font-size:12px;color:var(--muted);">
              ì„ íƒí•œ ìŠ¤í‚¬ë£¬ ê°œìˆ˜: <b id="runeCount" style="color:#e7c27a;">0</b>
            </div>
          </div>
          <div class="rune-engrave-row">
            <label class="field compact">
              <span class="label label-with-tip">
                ë£¬ ê°ì¸ ì„¤ì •
                <span class="info-tip" tabindex="0" aria-label="ë£¬ ê°ì¸ ì„¤ì • ì„¤ëª…">
                  i
                  <span class="info-tip-content">
                    ì„ íƒí•œ ë£¬ ê°ì¸ ì˜µì…˜ì— ë”°ë¼ ìµœì¢… ë”œ ê³„ì‚°ì— ë°˜ì˜ë©ë‹ˆë‹¤.<br>
                    ì„¸ë¶€ ì„¤ì •ì„ ê¼­ ì„¤ì •í•´ì£¼ì„¸ìš”.
                  </span>
                </span>
              </span>
              <select id="selRuneEngrave" class="select" aria-label="ë£¬ ê°ì¸ ì„¤ì •">
                <option value="" selected disabled>ë£¬ ê°ì¸ ì„¤ì •</option>
              </select>
            </label>

            <label class="field compact">
              <span class="label">ì„¸ë¶€ ì„¤ì •</span>
              <select id="selRuneDetail" class="select" aria-label="ì„¸ë¶€ ì„¤ì •" disabled>
                <option value="" selected disabled>ì„¸ë¶€ ì„¤ì •</option>
              </select>
            </label>
          </div>


        </div>

        <div class="opt-box">
          <h4 class="opt-title">
            <span class="label-with-tip">
              ìŠ¤í‚¬íŠ¸ë¦¬
              <span class="info-tip" tabindex="0" aria-label="ìŠ¤í‚¬íŠ¸ë¦¬ ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ì„ íƒí•œ ì§ì—…ì˜ ìŠ¤í‚¬Â·TP ë ˆë²¨, ë ˆë²¨ë§ íš¨ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ<br>
                  ì‹¤ì œ ë”œ ì‚¬ì´í´ì— ì‚¬ìš©ë˜ëŠ” ìŠ¤í‚¬ êµ¬ì„±ì„ ê³„ì‚°ì— ë°˜ì˜í•©ë‹ˆë‹¤.
                </span>
              </span>
            </span>
          </h4>
          <div class="skilltree-head">
            <button id="btnSkillTree" class="ui-btn primary" type="button" aria-label="ìŠ¤í‚¬íŠ¸ë¦¬ ì„¤ì •"
              style="margin-top:2px;">ìŠ¤í‚¬íŠ¸ë¦¬ ì„¤ì •</button>
            <div class="st-counters">
              <span>ë‚¨ì€ SP: <b id="stSpLeft">â€”</b></span>
              <span>ë‚¨ì€ TP: <b id="stTpLeft">â€”</b></span>
            </div>
          </div>
        </div>
        <div class="final-damage">
          <span class="label label-with-tip">
            ìµœì¢…ë°ë¯¸ì§€
            <span class="info-tip" tabindex="0" aria-label="ìµœì¢… ë°ë¯¸ì§€ ì„¤ëª…">
              i
              <span class="info-tip-content">
                í˜„ì¬ ì„ íƒí•œ ëª¨ë“  íš¨ê³¼ë¥¼ í•©ì‚°í•˜ì—¬ ì´ ë°ë¯¸ì§€ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.<br>
                ì¢Œì¸¡ê³¼ ìš°ì¸¡ì˜ ê³„ì‚°í•˜ê¸°ëŠ” ë”°ë¡œ ë™ì‘ì´ ê°€ëŠ¥í•˜ë©°, ë°ë¯¸ì§€ë¥¼ ë¹„êµí•´ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </span>
            </span>
          </span>
          <strong class="value" id="finalDamageValue2">&nbsp;</strong>
          <button id="btn-sum-all-final2" type="button">ê³„ì‚°í•˜ê¸°</button>
        </div>
      </div>

      <aside class="stats">
        <div class="stats-panel">
          <!-- â–¼ ì„±ì•ˆì˜ ë´‰ì¸ -->
          <div class="opt-box" id="optSeal">
            <div class="seal-head">
              <h4 class="opt-title">ì„±ì•ˆì˜ ë´‰ì¸</h4>
              <button id="btnCastleSeal" class="ui-btn primary" type="button" aria-label="ì˜µì…˜ ì„ íƒ">
                ì˜µì…˜ ì„ íƒ
              </button>
            </div>
          </div>

          <!-- â–² ì—¬ê¸°ê¹Œì§€ 1í–‰ / ì•„ë˜ë¶€í„° 2í–‰(1fr) -->
          <div class="stats-main">
            <h3>
              <span class="label-with-tip">
                <span id="statsHeaderLabel">ì¥ë¹„ ì„¤ëª…</span>
                <span class="info-tip info-tip-bottom" tabindex="0" aria-label="ì¥ë¹„ ì„¤ëª… / í•©ì‚° ìŠ¤íƒ¯ íŒ¨ë„ ì„¤ëª…">
                  i
                  <span class="info-tip-content">
                    ì´ íŒ¨ë„ì—ì„œëŠ” ì¥ë¹„ ê°œë³„ ì˜µì…˜ ì„¤ëª…ê³¼ í•©ì‚° ìŠ¤íƒ¯ì„ ë²ˆê°ˆì•„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    ì˜¤ë¥¸ìª½ â–¶ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¥ë¹„ ì„¤ëª…ê³¼ í•©ì‚° ìŠ¤íƒ¯ í™”ë©´ì„ ì „í™˜í•˜ì„¸ìš”.
                  </span>
                </span>
              </span>
              <button id="btnToggleStatsPanel" type="button" class="stats-toggle-btn" aria-label="ì¥ë¹„ ì„¤ëª… / í•©ì‚° ìŠ¤íƒ¯ ì „í™˜">
                â–¶
              </button>
            </h3>


            <!-- ì¥ë¹„ ì„¤ëª… / í•©ì‚° ìŠ¤íƒ¯ ì˜ì—­ (2í–‰ 1fr ì•ˆì—ì„œë§Œ ìŠ¤í¬ë¡¤) -->
            <div id="equipDescPreview" class="stat-preview"></div>
            <div id="statList" class="stat-list"></div>
          </div>

          <!-- â–¼ í•­ìƒ ë§¨ ì•„ë˜ í–‰(3í–‰ auto) -->
          <div class="final-damage">
            <span class="label">ìµœì¢…ë°ë¯¸ì§€</span>
            <strong class="value" id="finalDamageValue">&nbsp;</strong>
            <button id="btn-sum-all-final" type="button">ê³„ì‚°í•˜ê¸°</button>
          </div>
        </div>
      </aside>

    </section>
  </section>
  </div>
  <!--ã…‡-->
  <div id="charModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div><!--ëª¨ë‹¬ ë’¤ ë°°ê²½ ê²€ì •, data-close ì†ì„± ë¶™ì€ ìš”ì†Œ í´ë¦­í•˜ë©´ ëª¨ë‹¬ ë‹«í˜-->
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <header>
        <h2 id="dlgTitle">ìºë¦­í„° ì„ íƒ</h2>
        <div></div>
      </header>
      <div id="catalog" class="catalog"></div>
    </div>
  </div>

  <div id="itemModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="itemDlgTitle">
      <header>
        <h2 id="itemDlgTitle">ì•„ì´í…œ ì„ íƒ</h2>
        <nav id="weaponTabs" class="weapon-tabs" style="display:none"></nav>
        <input id="itemSearch" class="input" type="text" placeholder="ì•„ì´í…œ ê²€ìƒ‰ (ì´ë¦„ / ì¢…ë¥˜)" />
      </header>
      <div class="items">
        <div id="itemList" class="item-list"></div>
      </div>
    </div>
  </div>


  <!-- âœ… ë°©ì–´êµ¬ ì„¸íŠ¸ ì„ íƒ ëª¨ë‹¬ -->
  <div id="armorSetModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-close></div>
    <div class="dialog armor-set-dialog" role="dialog" aria-modal="true" aria-labelledby="armorSetTitle">
      <header class="armor-set-titlebar">
        <h2 id="armorSetTitle">ë°©ì–´êµ¬ ì„¸íŠ¸ ì„ íƒ</h2>

        <!-- âœ… ìµì‹œë“œ / ì—í”½ í† ê¸€ ìŠ¤ìœ„ì¹˜ -->
        <div id="armorSetToggle" class="armor-toggle mode-exceed" role="button" tabindex="0" aria-label="ìµì‹œë“œ / ì—í”½ ì „í™˜">
          <span class="armor-toggle-label armor-toggle-label-exceed">ìµì‹œë“œ</span>
          <span class="armor-toggle-label armor-toggle-label-epic">ì—í”½</span>
          <div class="armor-toggle-thumb"></div>
        </div>

        <button type="button" class="btn" data-close style="font-size:12px;padding:4px 8px;">
          ë‹«ê¸°
        </button>
      </header>

      <div class="armor-set-body">
        <div id="armorSetList" class="armor-set-list">
          <!-- JSì—ì„œ ì„¸íŠ¸ ì¹´ë“œê°€ ë Œë”ë§ë¨ -->
        </div>
      </div>
    </div>
  </div>

    <!-- âœ… ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ ì„ íƒ ëª¨ë‹¬ -->
    <div id="accSetModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialog armor-set-dialog" role="dialog" aria-modal="true" aria-labelledby="accSetTitle">
       <header class="armor-set-titlebar">
  <h2 id="accSetTitle">ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ ì„ íƒ</h2>

  <!-- âœ… ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ìš© ìµì‹œë“œ / ì—í”½ í† ê¸€ -->
  <div
    id="accSetToggle"
    class="armor-toggle mode-exceed"
    role="button"
    tabindex="0"
    aria-label="ìµì‹œë“œ / ì—í”½ ì „í™˜ (ì•…ì„¸)"
  >
    <span class="armor-toggle-label armor-toggle-label-exceed">ìµì‹œë“œ</span>
    <span class="armor-toggle-label armor-toggle-label-epic">ì—í”½</span>
    <div class="armor-toggle-thumb"></div>
  </div>

  <button
    type="button"
    class="btn"
    data-close
    style="font-size:12px;padding:4px 8px;"
  >
    ë‹«ê¸°
  </button>
</header>

        <div class="armor-set-body">
          <div id="accSetList" class="armor-set-list"></div>
        </div>
      </div>
    </div>

    <!-- âœ… íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸ ì„ íƒ ëª¨ë‹¬ -->
<div id="specSetModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog armor-set-dialog" role="dialog" aria-modal="true" aria-labelledby="specSetTitle">
    <header class="armor-set-titlebar">
      <h2 id="specSetTitle">íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸ ì„ íƒ</h2>

      <!-- ìµì‹œë“œ / ì—í”½ í† ê¸€ (ë°©ì–´êµ¬/ì•…ì„¸ì™€ ê°™ì€ ëª¨ë“œ ê³µìœ ) -->
      <div
        id="specSetToggle"
        class="armor-toggle mode-exceed"
        role="button"
        tabindex="0"
        aria-label="ìµì‹œë“œ / ì—í”½ ì „í™˜ (íŠ¹ìˆ˜ì¥ë¹„)"
      >
        <span class="armor-toggle-label armor-toggle-label-exceed">ìµì‹œë“œ</span>
        <span class="armor-toggle-label armor-toggle-label-epic">ì—í”½</span>
        <div class="armor-toggle-thumb"></div>
      </div>

      <button
        type="button"
        class="btn"
        data-close
        style="font-size:12px;padding:4px 8px;"
      >
        ë‹«ê¸°
      </button>
    </header>

    <div class="armor-set-body">
      <div id="specSetList" class="armor-set-list"></div>
    </div>
  </div>
</div>

<!-- âœ… ê³ ìœ íš¨ê³¼ ì¼ê´„ ì ìš© ëª¨ë‹¬ -->
<div id="uniqueEffectModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog unique-dialog" role="dialog" aria-modal="true" aria-labelledby="uniqueEffectTitle">
    <header class="armor-set-titlebar">
      <h2 id="uniqueEffectTitle">ê³ ìœ íš¨ê³¼ ì¼ê´„ ì ìš©</h2>
      <button type="button" class="btn" data-close style="font-size:12px;padding:4px 8px;">
        ë‹«ê¸°
      </button>
    </header>

    <div class="unique-body">
      <!-- ë¬´ê¸° ê³ ìœ íš¨ê³¼ -->
<section class="unique-section">
  <h3 class="unique-section-title">ë¬´ê¸° ê³ ìœ íš¨ê³¼</h3>
  <div class="unique-options unique-options-weapon">
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ê°•íƒ€">ê°•íƒ€</button>
      <div class="unique-desc" data-kind="weapon" data-value="ê°•íƒ€"></div>
    </div>
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ê´‘ì±„">ê´‘ì±„</button>
      <div class="unique-desc" data-kind="weapon" data-value="ê´‘ì±„"></div>
    </div>
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ë¶„ì‡„">ë¶„ì‡„</button>
      <div class="unique-desc" data-kind="weapon" data-value="ë¶„ì‡„"></div>
    </div>
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ì„ ëª…">ì„ ëª…</button>
      <div class="unique-desc" data-kind="weapon" data-value="ì„ ëª…"></div>
    </div>
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ì—†ìŒ">ì—†ìŒ</button>
      <div class="unique-desc" data-kind="weapon" data-value="ì—†ìŒ"></div>
    </div>
  </div>
</section>

<!-- ê¸°íƒ€ ê³ ìœ íš¨ê³¼ -->
<section class="unique-section">
  <h3 class="unique-section-title">ê¸°íƒ€ ê³ ìœ íš¨ê³¼</h3>
  <div class="unique-options unique-options-other">
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ì„ ë´‰">ì„ ë´‰</button>
      <div class="unique-desc" data-kind="other" data-value="ì„ ë´‰"></div>
    </div>
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ì˜ì§€">ì˜ì§€</button>
      <div class="unique-desc" data-kind="other" data-value="ì˜ì§€"></div>
    </div>
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ì´ìƒ">ì´ìƒ</button>
      <div class="unique-desc" data-kind="other" data-value="ì´ìƒ"></div>
    </div>
    <div class="unique-row">
      <button type="button" class="unique-btn" data-value="ì—†ìŒ">ì—†ìŒ</button>
      <div class="unique-desc" data-kind="other" data-value="ì—†ìŒ"></div>
    </div>
  </div>
</section>


      <div class="unique-actions">
        <button type="button" class="btn" data-close>ì·¨ì†Œ</button>
        <button type="button" class="btn" id="btnUniqueApply">ì„ íƒ ì ìš©</button>
      </div>
    </div>
  </div>
</div>



    <div id="enhanceModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="enhDlgTitle">
        <header>
          <h2 id="enhDlgTitle">ê°•í™” ì„ íƒ</h2>
        </header>
        <div class="items">
          <div id="enhanceList" class="enh-list"></div>
        </div>
      </div>
    </div>

    <div id="enchantModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="enchantDlgTitle">
        <header>
          <h2 id="enchantDlgTitle">ë§ˆë²•ë¶€ì—¬ ì„ íƒ</h2>
        </header>
        <div class="items">
          <div id="enchantList" class="enh-list"></div>
        </div>
      </div>
    </div>

    <div id="refineModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="refinetitle">
        <header>
          <h3 id="refinetitle">ì—°ë§ˆ ì„¤ì •</h3><button class="close" data-close>âœ•</button>
        </header>
        <div class="cols">
          <div class="titles">ì—°ë§ˆ ì„ íƒ</div> <!-- âœ… ì¶”ê°€ -->
          <div class="lists" id="refineList"></div>
        </div>
      </div>
    </div>


    <div id="emblemModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="emblemDlgTitle"
        style="width:min(920px,95vw);height:min(620px,88vh);">
        <header>
          <h2 id="emblemDlgTitle">ì— ë¸”ë ˜ ì„ íƒ</h2>
        </header>
        <div id="emblemRows" class="em-rows"></div>
      </div>
    </div>

    <div id="runeModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="runeDlgTitle"
        style="width:min(980px,95vw);height:min(820px,88vh);">
        <header>
          <h2 id="runeDlgTitle">
            <span class="label-with-tip">
              ìŠ¤í‚¬ë£¬ ì„¤ì •
              <span class="info-tip" tabindex="0" aria-label="ìŠ¤í‚¬ë£¬ ì„¤ì • ì„¤ëª…">
                i
                <span class="info-tip-content">
                  ìŠ¤í‚¬ë£¬ì€ ìµœëŒ€ 20ê°œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                  ê°€í˜¸/ì§€í˜œë£¬ì€ ìƒì‹œì ìš©ë˜ë©°, ì™œê³¡ë£¬ì€ ì˜µì…˜ì´ ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </span>
              </span>
            </span>
          </h2>
          <div style="justify-self:end;font-size:12px;color:#c7b589;">
            ì„ íƒí•œ ìŠ¤í‚¬ë£¬ ê°œìˆ˜: <b id="runeCountLabel" style="color:#ff6b6b;">0</b> / 20
          </div>
        </header>
        <div class="items" style="padding:10px;">
          <div id="runeGrid" class="rune-grid"></div>

          <!-- ê°€í˜¸ / ì§€í˜œ / ì™œê³¡ íŠ¹ìˆ˜ ìŠ¤í‚¬ë£¬ -->
          <div class="special-runes">
            <div class="special-runes-title">íŠ¹ìˆ˜ ìŠ¤í‚¬ë£¬</div>

            <div class="special-rune-row">
              <img src="/img/etc/skillrune/ì™œê°€ì§€.png" alt="ì™œê°€ì§€" class="special-rune-icon">
              <label for="specialRune_gaho">ê°€í˜¸</label>
              <select id="specialRune_gaho" class="rune-select">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>

            <div class="special-rune-row">
              <img src="/img/etc/skillrune/ì™œê°€ì§€.png" alt="ì™œê°€ì§€" class="special-rune-icon">
              <label for="specialRune_jihe">ì§€í˜œ</label>
              <select id="specialRune_jihe" class="rune-select">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>

            <div class="special-rune-row">
              <img src="/img/etc/skillrune/ì™œê°€ì§€.png" alt="ì™œê°€ì§€" class="special-rune-icon">
              <label for="specialRune_waegok">ì™œê³¡</label>
              <select id="specialRune_waegok" class="rune-select">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>
          </div>
        </div>
        <div class="modal-foot">
          <button id="runeCommit" class="ui-btnetc">ì„¤ì • í•˜ê¸°</button>
        </div>

      </div>
    </div>

    <div id="skillTreeModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="stDlgTitle"
        style="width:min(1100px,96vw);height:min(720px,92vh);">
        <header>
          <h2 id="stDlgTitle">ìŠ¤í‚¬íŠ¸ë¦¬ ì„¤ì •</h2>
          <div class="modal-foot">
            <button id="btnSkillApply" class="st-apply-btn">ì„¤ì • í•˜ê¸°</button>
          </div>
          <div class="st-counters">
            <div class="st-counter"><span class="label sp">SP</span><span class="val" id="stSpLeftMini">0</span></div>
            <div class="st-counter"><span class="label tp">TP</span><span class="val" id="stTpLeftMini">0</span></div>
          </div>
        </header>
        <div class="items" style="padding:10px;">
          <div id="stGrid"></div>
        </div>
      </div>
    </div>

    <!-- â–¼ ì›Œë¦¬ì–´ ì™€ì¼ë“œë² ì¸: ìŠ¤í‚¬íŠ¸ë¦¬ 2ì•ˆ ì„ íƒ ëª¨ë‹¬ -->
<div id="wildbaneTreeModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="wbTreeTitle"
    style="width:min(520px,92vw);">
    <header style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <h2 id="wbTreeTitle" style="margin:0;">ìŠ¤í‚¬íŠ¸ë¦¬ ì„ íƒ</h2>
      <button class="close" data-close style="font-size:18px;">âœ•</button>
    </header>

    <div class="items" style="padding:14px;">
      <div style="font-size:13px;color:#fff;line-height:1.45;">
        ì›Œë¦¬ì–´ ì™€ì¼ë“œë² ì¸ì€ <b>ìŠ¤í‚¬ì„ ì§ì ‘ ì°ì„ ìˆ˜ ì—†ê³ </b>,<br>
        ì •í˜•í™”ëœ 2ê°€ì§€ ìŠ¤í‚¬íŠ¸ë¦¬ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ í•œ ë’¤ <b>ì‚¬ì´í´ íšŸìˆ˜</b>ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.<br><br>
        í˜„ì¬ ì™€ì¼ë“œë² ì¸ ìºë¦­í„°ëŠ” ë‹¤ë¥¸ ìºë¦­í„°ì™€ ë²„í”„ ì ìš© ë°©ì‹ì´ ìƒì´í•˜ê³ ,<br>
        ë…ë¦½ì ì¸ ë”œ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.<br>
        ë˜í•œ ì¼ë¶€ ë²„ê·¸ë¡œ ì¸í•´ ìºë¦­í„° ê°„, ìŠ¤í‚¬íŠ¸ë¦¬ ê°„ ê³„ì‚° ì •í™•ë„ì— ì°¨ì´ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ,<br>
        íƒ€ ìºë¦­í„°ì™€ì˜ ë°ë¯¸ì§€ ì§ì ‘ ë¹„êµëŠ” <b>ì§€ì–‘</b>í•´ ì£¼ì‹œê³ ,<br>
        ë™ì¼í•œ ìŠ¤í‚¬íŠ¸ë¦¬ë‚´ì—ì„œ ì•„ì´í…œ ì„¸íŒ…ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br><br>
        ì¶”í›„ ë¦¬ë‰´ì–¼ì´ ì§„í–‰ë˜ë©´ <b>ë³´ë‹¤ ì •í™•í•œ ì™€ì¼ë“œë² ì¸ ê³„ì‚°ê¸°</b>ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤.
      </div>

  <div class="wb-tree-grid">
    <button type="button" class="wb-tree-btn" data-wb-tree="íŒŒíŒŒì´ˆ">íŒŒíŒŒì´ˆ</button>
    <button type="button" class="wb-tree-btn" data-wb-tree="íŒŒë¹¨ì´ˆ">íŒŒë¹¨ì´ˆ</button>
  </div>

  <!-- âœ… ì‚¬ì´í´ íšŸìˆ˜ ì…ë ¥ (ì¶”í›„ ë°±ì—”ë“œ uses ê³„ì‚°ì— í™œìš©) -->
  <div class="wb-cycle-wrap">
    <div class="wb-cycle-label">ì‚¬ì´í´ íšŸìˆ˜ ì§ì ‘ ì…ë ¥</div>
    <div class="wb-cycle-row">
      <input id="wbCycleCount" class="wb-cycle-input"
             type="number" inputmode="numeric"
             min="0" step="1" value="0" placeholder="0">
    </div>
  </div>
</div>

    <div class="modal-foot">
      <button id="btnWildbaneTreeApply" class="st-apply-btn" type="button" style="padding:12px 26px;">ì„ íƒí•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- â–¼ ì›Œë¦¬ì–´ ìœˆë“œì‹œì–´: ìŠ¤í‚¬íŠ¸ë¦¬ 3ì•ˆ ì„ íƒ ëª¨ë‹¬ -->
<div id="windshearTreeModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="wsTreeTitle"
    style="width:min(520px,92vw);">
    <header style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <h2 id="wsTreeTitle" style="margin:0;">ìŠ¤í‚¬íŠ¸ë¦¬ ì„ íƒ</h2>
      <button class="close" data-close style="font-size:18px;">âœ•</button>
    </header>

    <div class="items" style="padding:14px;">
      <div style="font-size:13px;color:#fff;line-height:1.45;">
        ì›Œë¦¬ì–´ ìœˆë“œì‹œì–´ëŠ” <b>ìŠ¤í‚¬ì„ ì§ì ‘ ì°ì„ ìˆ˜ ì—†ê³ </b>,<br>
        ì •í˜•í™”ëœ 3ê°€ì§€ ìŠ¤í‚¬íŠ¸ë¦¬ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ í•œ ë’¤ <b>ì‚¬ì´í´ íšŸìˆ˜</b>ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.<br><br>
        í˜„ì¬ ìœˆë“œì‹œì–´ ìºë¦­í„°ëŠ” ë‹¤ë¥¸ ìºë¦­í„°ì™€ ë²„í”„ ì ìš© ë°©ì‹ì´ ìƒì´í•˜ê³ ,<br>
        ë…ë¦½ì ì¸ ë”œ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.<br>
        ë˜í•œ ì¼ë¶€ ë²„ê·¸ë¡œ ì¸í•´ ìºë¦­í„° ê°„, ìŠ¤í‚¬íŠ¸ë¦¬ ê°„ ê³„ì‚° ì •í™•ë„ì— ì°¨ì´ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ,<br>
        íƒ€ ìºë¦­í„°ì™€ì˜ ë°ë¯¸ì§€ ì§ì ‘ ë¹„êµëŠ” <b>ì§€ì–‘</b>í•´ ì£¼ì‹œê³ ,<br>
        ë™ì¼í•œ ìŠ¤í‚¬íŠ¸ë¦¬ë‚´ì—ì„œ ì•„ì´í…œ ì„¸íŒ…ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.<br><br>
        ì¶”í›„ ë¦¬ë‰´ì–¼ì´ ì§„í–‰ë˜ë©´ <b>ë³´ë‹¤ ì •í™•í•œ ìœˆë“œì‹œì–´ ê³„ì‚°ê¸°</b>ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤.
      </div>

      <div style="height:10px;"></div>

      <!-- âœ… ë²„íŠ¼ 3ê°œ (ë¼ë²¨/ê°’ì€ ì›í•˜ëŠ”ëŒ€ë¡œ êµì²´) -->
      <div class="wb-tree-grid">
        <button type="button" class="wb-tree-btn" data-ws-tree="A">íŒŒíŒŒíŒŒíŒŒë¹¨</button>
        <button type="button" class="wb-tree-btn" data-ws-tree="B">ì´ˆì´ˆì´ˆì´ˆíŒŒíŒŒë¹¨</button>
        <button type="button" class="wb-tree-btn" data-ws-tree="C">íŒŒíŒŒíŒŒì´ˆë¹¨</button>
      </div>

      <!-- âœ… ì‚¬ì´í´ íšŸìˆ˜ ì…ë ¥: ì™€ì¼ë“œë² ì¸ê³¼ ë™ì¼ -->
      <div class="wb-cycle-wrap">
        <div class="wb-cycle-label">ì‚¬ì´í´ íšŸìˆ˜ ì§ì ‘ ì…ë ¥</div>
        <div class="wb-cycle-row">
          <input id="wsCycleCount" class="wb-cycle-input"
                 type="number" inputmode="numeric"
                 min="0" step="1" value="0">
        </div>
      </div>

      <div class="modal-foot">
        <button id="btnWindshearTreeApply" class="st-apply-btn" style="width:100%;">ì„¤ì • í•˜ê¸°</button>
      </div>
    </div>
  </div>
</div>


    <!-- â–¼ ì„±ì•ˆì˜ ë´‰ì¸ ëª¨ë‹¬ -->
    <div id="castleSealModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="castleSealTitle">
        <header>
          <h3 id="castleSealTitle">ì„±ì•ˆì˜ ë´‰ì¸</h3>
          <button class="close" data-close>âœ•</button>
        </header>
        <div class="body two-col">
          <section class="cols left">
            <div class="titles">â—ˆ ì£¼ìš” ì˜µì…˜ â—ˆ</div>
            <div id="sealMainList" class="lists"></div>
          </section>
          <section class="cols right">
            <div class="titles">â—ˆ ì¶”ê°€ ì˜µì…˜ â—ˆ</div>
            <div id="sealSubList" class="lists"></div>
          </section>
        </div>

        <div class="modal-foot">
          <button id="sealCommit" class="ui-btnetc">ì„ íƒ í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- â–¼ ì»¤ìŠ¤í…€ ì˜µì…˜ ëª¨ë‹¬ -->
    <div id="customOptModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="customOptTitle">
        <header>
          <h3 id="customOptTitle">ì»¤ìŠ¤í…€ ì˜µì…˜ ì„ íƒ</h3>
          <button class="close" data-close>âœ•</button>
        </header>

        <div class="body">
          <div class="titles">ì ìš©í•  ì»¤ìŠ¤í…€ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.</div>
          <!-- simple-modal ê³µìš© ìŠ¤íƒ€ì¼ì„ ì“°ê¸° ìœ„í•´ class="list" ì‚¬ìš© -->
          <div id="customOptList" class="list">
            <button class="opt-btn opt-btnetc" data-value="ê°•íƒ€">ê°•íƒ€</button>
            <button class="opt-btn opt-btnetc" data-value="ê´‘ì±„">ê´‘ì±„</button>
            <button class="opt-btn opt-btnetc" data-value="ë¶„ì‡„">ë¶„ì‡„</button>
            <button class="opt-btn opt-btnetc" data-value="ì„ ëª…">ì„ ëª…</button>
            <button class="opt-btn opt-btnetc" data-value="ì—†ìŒ">ì—†ìŒ</button>
          </div>
        </div>

        <div class="modal-foot">
          <!-- ì„±ì•ˆì˜ ë´‰ì¸ê³¼ ë™ì¼ ìŠ¤íƒ€ì¼(ui-btnetc) -->
          <button id="customOptApply" class="ui-btnetc">ì„ íƒ í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- â–¼ ìƒì˜ ì „ìš© ì»¤ìŠ¤í…€ ì˜µì…˜ ëª¨ë‹¬ -->
    <div id="armorCustomOptModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="armorCustomOptTitle">
        <header>
          <h3 id="armorCustomOptTitle">ì»¤ìŠ¤í…€ ì˜µì…˜ ì„ íƒ (ìƒì˜)</h3>
          <button class="close" data-close>âœ•</button>
        </header>

        <div class="body">
          <div class="titles">ìƒì˜ì— ì ìš©í•  ì»¤ìŠ¤í…€ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.</div>

          <div id="armorCustomOptList" class="list">
            <!-- ì„ ë´‰: ë¶„ì‡„ì™€ ê°™ì€ ëŠë‚Œ (ë¹¨ê°• ê³„ì—´) -->
            <button class="opt-btn opt-btnetc" data-value="ì„ ë´‰">ì„ ë´‰</button>
            <!-- ì˜ì§€: ê´‘ì±„ì™€ ê°™ì€ ëŠë‚Œ (íŒŒë‘ ê³„ì—´) -->
            <button class="opt-btn opt-btnetc" data-value="ì˜ì§€">ì˜ì§€</button>
            <!-- ì´ìƒ: ì„ ëª…ê³¼ ê°™ì€ ëŠë‚Œ (ì´ˆë¡ ê³„ì—´) -->
            <button class="opt-btn opt-btnetc" data-value="ì´ìƒ">ì´ìƒ</button>
            <!-- ì—†ìŒ: ì¤‘ë¦½ -->
            <button class="opt-btn opt-btnetc" data-value="ì—†ìŒ">ì—†ìŒ</button>
          </div>
        </div>

        <div class="modal-foot">
          <!-- ë‚˜ì¤‘ì— ì‹¤ì œ ì ìš© ë¡œì§ ë¶™ì¼ ë²„íŠ¼ -->
          <button id="armorCustomOptApply" class="ui-btnetc">ì„ íƒ í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- â–¼ íŒ”ì°Œ ì»¤ìŠ¤í…€ ì˜µì…˜ ëª¨ë‹¬ -->
    <div id="braceletCustomOptModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="braceletCustomOptTitle">
        <header>
          <h3 id="braceletCustomOptTitle">ì»¤ìŠ¤í…€ ì˜µì…˜ ì„ íƒ (íŒ”ì°Œ)</h3>
          <button class="close" data-close>âœ•</button>
        </header>

        <div class="body">
          <div class="titles">íŒ”ì°Œì— ì ìš©í•  ì»¤ìŠ¤í…€ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.</div>
          <div id="braceletCustomOptList" class="list">
            <button class="opt-btn opt-btnetc" data-value="ì„ ë´‰">ì„ ë´‰</button>
            <button class="opt-btn opt-btnetc" data-value="ì˜ì§€">ì˜ì§€</button>
            <button class="opt-btn opt-btnetc" data-value="ì´ìƒ">ì´ìƒ</button>
            <button class="opt-btn opt-btnetc" data-value="ì—†ìŒ">ì—†ìŒ</button>
          </div>
        </div>

        <div class="modal-foot">
          <button id="braceletCustomOptApply" class="ui-btnetc">ì„ íƒ í•˜ê¸°</button>
        </div>
      </div>
    </div>

    <!-- â–¼ ê·€ê±¸ì´ ì»¤ìŠ¤í…€ ì˜µì…˜ ëª¨ë‹¬ -->
    <div id="earringCustomOptModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="earringCustomOptTitle">
        <header>
          <h3 id="earringCustomOptTitle">ì»¤ìŠ¤í…€ ì˜µì…˜ ì„ íƒ (ê·€ê±¸ì´)</h3>
          <button class="close" data-close>âœ•</button>
        </header>

        <div class="body">
          <div class="titles">ê·€ê±¸ì´ì— ì ìš©í•  ì»¤ìŠ¤í…€ ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”.</div>

          <div id="earringCustomOptList" class="list">
            <button class="opt-btn opt-btnetc" data-value="ì„ ë´‰">ì„ ë´‰</button>
            <button class="opt-btn opt-btnetc" data-value="ì˜ì§€">ì˜ì§€</button>
            <button class="opt-btn opt-btnetc" data-value="ì´ìƒ">ì´ìƒ</button>
            <button class="opt-btn opt-btnetc" data-value="ì—†ìŒ">ì—†ìŒ</button>
          </div>
        </div>

        <div class="modal-foot">
          <button id="earringCustomOptApply" class="ui-btnetc">ì„ íƒ í•˜ê¸°</button>
        </div>
      </div>
    </div>


    <!-- â˜… ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ìŠ¬ë¡¯ ëª¨ë‹¬ -->
    <div id="presetModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-preset-close></div>

      <div class="dialog preset-dialog" role="dialog" aria-modal="true" aria-labelledby="presetTitle">
        <header>
          <div style="width:32px;"></div>
          <h2 id="presetTitle">ì €ì¥ ìŠ¬ë¡¯ ê´€ë¦¬</h2>
          <button type="button" class="btn" data-preset-close style="font-size:12px;padding:4px 8px;">
            ë‹«ê¸°
          </button>
        </header>

        <div class="preset-body">
          <!-- ğŸ”½ ìŠ¬ë¡¯ ì´ˆê¸°í™” ë²„íŠ¼ (ë‚´ìš© ì˜ì—­ ì™¼ìª½ ìƒë‹¨) -->
          <button type="button" id="btnPresetClear" class="preset-clear-btn" title="ì´ ìŠ¬ë¡¯ì˜ ì €ì¥ëœ ìŠ¤í™ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤">
            ğŸ—‘
          </button>
          <div class="preset-thumb">
            <img id="presetCharThumb" alt="ìºë¦­í„° ì¸ë„¤ì¼" />
          </div>

          <div id="presetCharName" class="preset-char-name">
            ì„ íƒëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
          </div>

          <div id="presetUserName" class="preset-user-name">
            ì €ì¥ëœ ì´ë¦„ ì—†ìŒ
          </div>

          <div class="preset-actions">
            <button type="button" id="btnPresetSave" class="btn main">
              ì €ì¥í•˜ê¸°
            </button>
            <button type="button" id="btnPresetLoad" class="btn">
              ë¶ˆëŸ¬ì˜¤ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ê´€ë¦¬ì ë¬¸ì˜ ëª¨ë‹¬ -->
    <div id="contactModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-contact-close></div>
      <div class="dialog contact-dialog" role="dialog" aria-modal="true" aria-labelledby="contactTitle"
        style="width:min(620px,96vw);max-height:min(430px,90vh);">
        <header>
          <div style="width:32px;"></div>
          <h2 id="contactTitle">ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œì— ë¬¸ì˜í•˜ê¸°</h2>
          <button type="button" class="close" data-contact-close>âœ•</button>
          </button>
        </header>

        <div class="contact-body">
          <div class="contact-notice">
            ê³„ì‚°ê¸° ì´ìš© ì¤‘ ì •ìƒì ì´ì§€ ì•Šì€ ë™ì‘ë“¤ì´ë‚˜ ì˜¤ë¥˜, ë²„ê·¸ë“¤ì„ ì œë³´í•´ì£¼ì„¸ìš”.<br>
            ê³„ì‚°ê¸° ì—…ë°ì´íŠ¸ì— í° í˜ì´ ë©ë‹ˆë‹¤!<br>
            ê·¸ ì™¸ ë©¤ë²„ì‹­ ê´€ë ¨, í•œë§ˆë”” ë¬¸êµ¬ ë³€ê²½ ë“±ë„ ì ì–´ì£¼ì‹œë©´ í™•ì¸í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.<br>
            ì‹¤ì‹œê°„ ë¬¸ì˜ëŠ” ì €í¬ ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ <a href="https://open.kakao.com/o/sEvtIGpf" target="_blank" rel="noopener">ì˜¤í”ˆì±„íŒ…</a> ìœ¼ë¡œ
            ë¬¸ì˜ì£¼ì‹œë©´ ë˜ê² ìŠµë‹ˆë‹¤.
          </div>

          <textarea id="contactTalk" class="contact-textarea" placeholder="ë¬¸ì˜í•˜ì‹¤ ë‚´ìš©ì„ ìµœëŒ€í•œ ìƒì„¸í•˜ê²Œ ì ì–´ì£¼ì…”ì•¼ ë¹ ë¥´ê³  ì •í™•í•œ ë‹µë³€ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì†Œìš¸ë¸Œë§ì–´ ê³„ì‚°ì´ ì•ˆë©ë‹ˆë‹¤.  (X)
ì†Œìš¸ë¸Œë§ì–´, ì•”í‘ì˜ ë³„ ì„ íƒì‹œ ê³„ì‚°ê°’ì´ 0ìœ¼ë¡œ ë‚˜ì˜µë‹ˆë‹¤.  (O)"></textarea>
          <div class="contact-actions">
            <button id="btnContactSend" class="ui-btnetc">ë¬¸ì˜ ë³´ë‚´ê¸°</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¬¸ì˜í•˜ê¸° ì „ ìì£¼í•˜ëŠ” Q&A (ëª©ë¡) -->
<div id="faqModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-faq-close></div>
  <div class="dialog contact-dialog faq-dialog" role="dialog" aria-modal="true" aria-labelledby="faqTitle"
    style="width:min(720px,96vw);max-height:min(700px,90vh);">
    <header>
      <div style="width:32px;"></div>
      <h2 id="faqTitle">ë¬¸ì˜í•˜ê¸° ì „ ìì£¼í•˜ëŠ” Q&amp;A</h2>
      <button type="button" class="close" data-faq-close>âœ•</button>
    </header>

    <div class="contact-body">
      <div class="contact-notice">
        ê³„ì‚°ê¸° ì‚¬ìš© ì¤‘, í˜¹ì‹œ ì´ëŸ° ì ë“¤ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”? ê°€ì¥ ë§ì´ í•˜ì‹œëŠ” ì§ˆë¬¸ë“¤ì„ ëª¨ì•„ë‘ì—ˆìŠµë‹ˆë‹¤.
      </div>
      <div id="faqList" class="faq-list"></div>
    </div>
  </div>
</div>

<!-- Q&A ë‹µë³€ ëª¨ë‹¬ -->
<div id="faqAnswerModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-faqans-close></div>
  <div class="dialog contact-dialog faq-dialog" role="dialog" aria-modal="true" aria-labelledby="faqAnswerTitle"
    style="width:min(920px,96vw);max-height:min(700px,90vh);">
    <header>
      <button type="button" class="btn" data-faqans-back style="font-size:12px;padding:4px 8px;">â† ëª©ë¡</button>
      <h2 id="faqAnswerTitle">Q&amp;A</h2>
      <button type="button" class="close" data-faqans-close>âœ•</button>
    </header>

    <div class="contact-body">
      <div id="faqAnswerQ" style="font-weight:800;margin-bottom:10px;"></div>
      <div id="faqAnswerA" class="faq-answer-text"></div>
    </div>
  </div>
</div>


    <!-- ê´€ë¦¬ì ë‹µì¥ íŒì—… -->
    <div id="replyModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-reply-close></div>
      <div class="dialog contact-dialog" role="dialog" aria-modal="true" aria-labelledby="replyTitle"
        style="width:min(620px,96vw);max-height:min(820px,90vh);">
        <header>
          <div style="width:32px;"></div>
          <h2 id="replyTitle">ê´€ë¦¬ì ë‹µì¥ ë„ì°©</h2>
          <button type="button" class="close" data-reply-close>âœ•</button>
          </button>
        </header>

        <div class="contact-body">
          <div class="contact-notice">
            ìµœê·¼ì— ë‚¨ê¸°ì‹  ë¬¸ì˜ì— ëŒ€í•œ ë‹µì¥ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.
          </div>

          <div class="reply-block">
            <div class="reply-label">ë‚´ ë¬¸ì˜</div>
            <div class="reply-text original" id="replyOriginal"></div>
          </div>

          <div class="reply-block">
            <div class="reply-label">ê´€ë¦¬ì ë‹µì¥</div>
            <div class="reply-text answer" id="replyAnswer"></div>
          </div>
          <!-- â˜… ì•„ë˜ ì¶”ê°€ -->
          <div class="reply-actions">
            <label class="reply-dontshow">
              <input type="checkbox" id="replyDontShow">
              ë” ì´ìƒ ë³´ì§€ ì•Šê¸°
            </label>
            <button type="button" id="replyConfirmBtn" class="ui-btnetc">í™•ì¸</button>
          </div>
        </div>
      </div>
    </div>

    <!-- âœ… íƒˆí‡´ ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="withdrawModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog"
       role="dialog"
       aria-modal="true"
       aria-labelledby="withdrawModalTitle"
         style="width:min(740px,95vw); height:auto; max-height:min(400px,70vh); display:flex; flex-direction:column;">
    <header>
      <div style="width:32px;"></div>
      <h2 id="withdrawModalTitle">ì—°êµ¬ì› ë§Œë£Œì•ˆë‚´</h2>
      <button type="button" class="btn" data-close>ë‹«ê¸°</button>
    </header>

    <div class="patch-log-body" style="flex:1; min-height:0; overflow-y:auto;">
  <div id="withdrawModalMsg"
     style="white-space:pre-wrap; line-height:1.55; margin-top:24px; margin-bottom:46px;"></div>

  <!-- âœ… ì„±ì•ˆì˜ ë´‰ì¸ 'ì„ íƒ í•˜ê¸°'ì™€ ë™ì¼ ìŠ¤íƒ€ì¼(ui-btnetc) ë²„íŠ¼ -->
  <a
    href="https://www.youtube.com/channel/UCijUV3SuVe_qErzBpdOmKIA/join"
    target="_blank"
    rel="noopener noreferrer"
    class="ui-btnetc"
    style="text-decoration:none;"
  >ì—°êµ¬ì› ì¬ê°€ì… í•˜ê¸°!</a>
</div>
    </div>
  </div>
</div>


        <!-- PC ê³„ì‚°ê¸° ë¡œë”© í›„ ì•ˆë‚´ ê³µì§€ ëª¨ë‹¬ -->
     <div id="noticeModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialog"
           role="dialog"
           aria-modal="true"
           aria-labelledby="noticeModalTitle"
           style="width:min(740px,95vw);max-height:min(500px,85vh);">
        <header>
          <div style="width:32px;"></div>
          <h2 id="noticeModalTitle">ì•ˆë‚´ì‚¬í•­</h2>
          <button type="button" class="btn" data-close>ë‹«ê¸°</button>
        </header>

        <div class="patch-log-body">
          <ul class="patch-log-list notice-list">
            <li></li>
            <li>
              <strong style="font-size:18px;">[2026 ì‹ ë…„ ì¸ì‚¬ë“œë¦½ë‹ˆë‹¤]</strong>
            </li>
              <li></li>
              <li><br>ì•ˆë…•í•˜ì„¸ìš” ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ ì…ë‹ˆë‹¤. ìƒˆí•´ ë³µ ë§ì´ ë°›ìœ¼ì„¸ìš” !<br><br>
ì €í¬ <span style="color: yellow;">ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ</span> <strong style="color: #ff4444; font-size:15px;">'ë˜íŒŒëª¨ë°”ì¼ ì‹œì¦Œ5 ê³„ì‚°ê¸°'</strong> ë°œì „ì— í•¨ê»˜í•´ì£¼ì‹  ëª¨ë“  ì—°êµ¬ì› ì—¬ëŸ¬ë¶„ê»˜ ê¹Šì€ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.<br>
ì—¬ëŸ¬ë¶„ì˜ <strong style="color: white;">í›„ì›ê³¼ ê´€ì‹¬, ê·¸ë¦¬ê³  ì„¸ì‹¬í•œ ì˜¤ë¥˜Â·ë²„ê·¸ ì œë³´</strong> ë•ë¶„ì—<br> 
ì¶œì‹œ ì´ˆê¸°ë³´ë‹¤ ê³„ì‚°ê¸°ê°€ í›¨ì”¬ ì•ˆì •ì ì´ê³ , ì„±ëŠ¥ ë˜í•œ í¬ê²Œ í–¥ìƒ ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>   
2026ë…„ì—ëŠ” <strong><u>ë³´ë‹¤ ë” ì •í™•í•˜ê³  í¸ë¦¬í•œ ê³„ì‚° í™˜ê²½</u></strong>ì„ ìœ„í•´ ê¾¸ì¤€íˆ ì—…ë°ì´íŠ¸ë¥¼ ì´ì–´ê°€ê² ìŠµë‹ˆë‹¤.<br>
ì˜¬ í•œ í•´ë„ ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ ê³„ì‚°ê¸°ì™€ í•¨ê»˜, íš¨ìœ¨ì ì¸ í…œì„¸íŒ… í•´ë³´ì‹œê¸¸ ë°”ëë‹ˆë‹¤.<br><br>
<li class="sign-row">
  <span class="sign-text">- ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œì¥ ë“œë¦¼ -</span>
  <img src="/img/sign.png" alt="ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œì¥ ì§ì¸" class="seal-stamp">
</li>
              <!--<li>
               <span style="color: yellow;">'10ë ˆë²¨ ìŠ¤í‚¬ ê³µê²©ë ¥ ì¦ê°€'</span> ì˜µì…˜ì´ <strong style="color: #ff4444;">í‰íƒ€ ë°ë¯¸ì§€ì—ë„ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ë²„ê·¸</strong>ë¥¼ ë°œê²¬í•˜ì˜€ìŠµë‹ˆë‹¤.<br> 
            </li>
            <li>
              ë˜í•œ <span style="color: yellow;">'ì¡°í™”: ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜'</span> ì„¸íŠ¸ ì˜µì…˜ ì¤‘, <br>
              <span style="color: #ff4444;">'ë˜ì „ ì…ì¥ ì‹œ ì•…ì„¸ì„œë¦¬ ê°•í™” ìˆ˜ì¹˜ í•©ì´ 45ì´ìƒì¼ ê²½ìš°, ëª¨ë“  íƒ€ì… í”¼í•´ 3% ì¦ê°€'</span> ì˜µì…˜ì´,<br>
              ì¼ë°˜ <span style="color: yellow;">'ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜'</span> ì„¸íŠ¸ì™€, <span style="color: yellow;">'ê°€ì†: ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜'</span> ì„¸íŠ¸ì— <br>
              <strong style="color: #ff4444;">ë™ì¼í•˜ê²Œ ì ìš©ë˜ëŠ” ë²„ê·¸</strong>ë¥¼ ë°œê²¬í•˜ì˜€ìŠµë‹ˆë‹¤.
            </li>
            <li>
              íŒ¨ì¹˜ ì´ì „ì— í•´ë‹¹ ì„¸íŠ¸ë¡œ ë°ë¯¸ì§€ ê³„ì‚°ì„ ì§„í–‰í•˜ì‹  ê²½ìš°, <br>
              ìœ„ ë‚´ìš©ì„ ì°¸ê³ í•˜ì‹œì–´ ë‹¤ì‹œ í•œë²ˆ ë°ë¯¸ì§€ ê°’ì„ ê³„ì‚°í•´ ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤.
            </li>
            <li>
              ì´ìš©ì— í˜¼ë€ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤. <br>
              ì¡°ê·¸ë§ˆí•œ ì´ìƒí•œ ì ì´ë¼ë„ ì œë³´ í•´ ì£¼ì‹œë©´, ë¹ ë¥´ê²Œ í™•ì¸í•˜ê³  ìˆ˜ì •ì¡°ì¹˜ ì§„í–‰í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
            </li>
            <li>
              ê°ì‚¬í•©ë‹ˆë‹¤.
            </li>-->
          </ul>
        </div>
      </div>
    </div>


    <!-- íŒ¨ì¹˜ë‚´ì—­ ì „ì²´ë³´ê¸° ëª¨ë‹¬ -->
    <div id="patchLogModal" class="modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="patchLogTitle"
        style="width:min(600px,95vw);height:min(600px,85vh);">
        <header>
          <div style="width:32px;"></div>
          <h2 id="patchLogTitle">íŒ¨ì¹˜ë‚´ì—­ ì „ì²´ë³´ê¸°</h2>
          <button type="button" class="btn" data-close>
            ë‹«ê¸°
          </button>
        </header>

        <div class="patch-log-body">
          <ul class="patch-log-list notice-list">
            <li>26.01.23 ì¼ë¶€ ë§ˆë²•ë¶€ì—¬, ì˜¤ë¼, í¬ë¦¬ì³ ì¶”ê°€</li>
            <li>26.01.21 <span class="notice-badge">'ì¸ì±ˆíŠ¸ë¦¬ìŠ¤'</span> <span class="notice-badge">'ì—¬ëŸ°ì²˜'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.20 <span class="notice-badge">'ë§ˆë„í•™ì'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.19 <span class="notice-badge">'ì¿ ë…¸ì´ì¹˜'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.18 <span class="notice-badge">'ë‚¨ë©”ì¹´ë‹‰'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.17 <span class="notice-badge">'ìœˆë“œì‹œì–´'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.17 <span style="color: yellow;">ì„œë¡œ ë‹¤ë¥¸ ì ‘ë‘ì‚¬ ì¥ë¹„ë“¤ë§Œ ì°©ìš©</span>ì‹œ <span style="color: #ff4444;">ê¸°ë³¸ ì¥ë¹„ ì„¸íŠ¸íš¨ê³¼ ë¯¸ì ìš© ë²„ê·¸</span> ìˆ˜ì • </li>
            <li>26.01.16 <span class="notice-badge">'ë‚¨í¬ë£¨ì„¸ì´ë”'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.15 <span class="notice-badge">'ì—¬í¬ë£¨ì„¸ì´ë”'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.13 <span class="notice-badge">'ì™€ì¼ë“œë² ì¸'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.11 <span class="notice-badge">'ë‹¤í¬í…œí”ŒëŸ¬'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.09 <span class="notice-badge">'ì—¬ë©”ì¹´ë‹‰'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.05 <span class="notice-badge">'ë‹¤í¬ëœì„œ'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.03 <span class="notice-badge">'ê·¸ë˜í”ŒëŸ¬'</span> ìºë¦­ ì¶”ê°€</li>
            <li>26.01.01 <span class="notice-badge">'ë¡œê·¸'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.30 <span class="notice-badge">'ë‚¨ì¸íŒŒì´í„°'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.28 ì¼ë¶€ ì„¸íŠ¸ì˜µì…˜ì˜ <span style="color: yellow;">'ë°©ì–´ë ¥ ê°ì†Œ'</span> ì˜µì…˜ <span style="color: #ff4444;">ë¯¸ì ìš© ì˜¤ë¥˜</span> ìˆ˜ì •</li>
            <li>25.12.27 <span class="notice-badge">'ë¬´ë…€'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.26 ì—¬ì¸íŒŒì´í„° <span style="color: yellow;">'í•˜íŠ¸ ë¸Œë ˆì´ì»¤'</span> ìŠ¤í‚¬ <span style="color: #ff4444;">ë§ˆìŠ¤í„° ë ˆë²¨ ì˜¤ë¥˜</span> ìˆ˜ì •</li>
            <li>25.12.25 <span class="notice-badge">'ì—¬ìŠ¤í•íŒŒì´ì–´'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.24 ì‹ ê·œ í¬ë¦¬ì³ <span style="color: yellow;">'ë“œë˜ê³¤í…Œì´ë¨¸ ì†Œí”¼ì•„'</span> ì™¸ 2ì¢… <span style="color: #ff4444;">ì¶”ê°€</span> </li>
            <li>25.12.22 <span class="notice-badge">'ë°°í‹€ë©”ì´ì§€'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.18 <span class="notice-badge">'ìŠ¤íŠ¸ë¦¬íŠ¸íŒŒì´í„°'</span> ìºë¦­ ì¶”ê°€</li>
	          <li>25.12.17 <span style="color: yellow;">'10ë ˆë²¨ ìŠ¤í‚¬ ê³µê²©ë ¥ ì¦ê°€/ê°ì†Œ'</span> ì˜µì…˜ì´ <span style="color: #ff4444;">í‰íƒ€ì—ë„ ì ìš©ë˜ëŠ” ë²„ê·¸ ìˆ˜ì •</span> </li>
            <li>25.12.16 <span class="notice-badge">'ë² ê°€ë³¸ë“œ'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.15 <span style="color: yellow;">'ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜'</span> ì„¸íŠ¸ ì˜µì…˜ <span style="color: #ff4444;">ë²„ê·¸ ìˆ˜ì •</span> </li>
            <li>25.12.14 <span style="color: yellow;">'ì¥ë¹„ì„¤ëª…'</span> ë¶€ìœ„ë³„ <span style="color: #ff4444;">ì‹œì¸ì„± ê°œì„ </span> </li>
            <li>25.12.13 <span class="notice-badge">'ì—¬ì¸íŒŒì´í„°'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.12 <span style="color: yellow;">'ê±°ëŒ€ëˆ„ê³¨'</span> ì‹œì¦Œ5 ê¸°ì¤€ìœ¼ë¡œ <span style="color: #ff4444;">ëª¬ìŠ¤í„° ë ˆë²¨, ë°©ì–´ë ¥ ì¡°ì ˆ</span> </li>
            <!--<br>ã€€ã€€ã€€ã€€ê¸°ì¡´ 80ë ™ ê±°ëŒ€ëˆ„ê³¨ì€ <span style="color: yellow;">'(êµ¬)ê±°ëŒ€ëˆ„ê³¨'</span> ë¡œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤>-->
            <li>25.12.12 ê° ì¥ë¹„ <span style="color: yellow;">ê°œë³„ ë§ˆë²•ë¶€ì—¬ ì°½</span> <span style="color: #ff4444;">í¬ê¸° ì¡°ì ˆ ë° ìŠ¤í¬ë¡¤ ë°” ì¶”ê°€</span></li>
            <li>25.12.11 <span class="notice-badge">'ë¸”ë ˆì´ë“œ'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.09 <span class="notice-badge">'ì—¬ë ˆì¸ì €'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.07 <span class="notice-badge">'ì›¨í€ë§ˆìŠ¤í„°'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.07 <span style="color: yellow;">ë‚¨ìŠ¤í•</span>, ë¨¸ìŠ¤ì¼“ ì°©ìš©ì‹œ <span style="color: #ff4444;">í‰íƒ€, í‰íƒ€(íƒ„ë²„í”„)
                ë¯¸ì ìš©</span> ë²„ê·¸ ìˆ˜ì •</li>
            <li>25.12.06 <span style="color: yellow;">ë‚¨ìŠ¤í•</span>, <span style="color: #ff4444;">'ì–¼ìŒ ë¶ˆê½ƒ ë³´ìš°ê±´'</span> ìµœê³  ì†ì„±
              ì¶”ê°€ ë°ë¯¸ì§€ê°€ ì•”ì†ì„± ì¶”ê°€ ë°ë¯¸ì§€ë¡œ ì ìš©ë˜ë˜ í˜„ìƒ ìˆ˜ì •</li>
            <li>25.12.05 <span class="notice-badge">'ìŠ¤íŠ¸ë¼ì´ì»¤'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.04 ìŠ¤í‚¬íŠ¸ë¦¬ <span style="color: #ff4444;">MAX ë²„íŠ¼ í¸ì˜ì„±</span> ê°œì„ , TP ë¶ˆê°€ëŠ¥ ìŠ¤í‚¬, TP ì»¨íŠ¸ë¡¤ ì‚­ì œ</li>
            <li>25.12.03 <span class="notice-badge">'ë„¨ë§ˆìŠ¤í„°'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.12.01 <span class="notice-badge">'ë¯¸ìŠ¤íŠ¸ë¦¬ìŠ¤'</span> ìºë¦­ ì¶”ê°€</li>
            <li>25.11.30 <span style="color: yellow;">ë‚¨ìŠ¤í•, ì•„ìˆ˜ë¼,</span> <span style="color: #ff4444;">SP ì´ëŸ‰ ëª¨ìëŒ í˜„ìƒ</span>
              ìˆ˜ì •</li>
            <li>25.11.30 <span style="color: yellow;">ë‚¨ë ˆì¸ì €</span> í—¤ë“œìƒ·, ì›¨ìŠ¤í„´íŒŒì´ì–´ <span style="color: #ff4444;">ì¿¨íƒ€ì„ ê°œë³„
                ì ìš©</span></li>
            <li>25.11.30 ìµì‹œë“œ ê³ ìœ íš¨ê³¼ <span style="color: #ff4444;">ë³µë¦¬ ì ìš©</span> ìœ¼ë¡œ ê³„ì‚° ìˆ˜ì •</li>
            <li>25.11.29 <span style="color: yellow;">ì•„ìˆ˜ë¼</span> <span style="color: #ff4444;">'ë¶„ì‡„'</span> ì˜µì…˜ ì˜¤ë¥˜ íŒ¨ì¹˜</li>
            <li>25.11.29 <span style="color: yellow;">ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ ê³„ì‚°ê¸°</span> <span style="color: #ff4444;"> ì˜¤í”ˆ!</span></li>






          </ul>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      window.WEBAPP_URL = window.WEBAPP_URL || 'https://dnf-backend.gogo456654.workers.dev';
      const WEBAPP_URL = window.WEBAPP_URL;   // ê¸°ì¡´ ì½”ë“œë“¤ì´ ì“°ëŠ” ì‹ë³„ì ë³´ì¡´
      // DB
      const DB = { itemsBySlot: {}, loaded: {}, chars: { loaded: false, groups: [] } };
      // âœ… ì „ì—­ì´ ì—†ìœ¼ë©´ ë§Œë“¤ê³ 
      window.DBEnh = window.DBEnh || { loaded: false, list: [], byType: {} };
      // âœ… ì§€ì—­ ë³„ì¹­ì€ ì „ì—­ì„ ê°€ë¦¬í‚¤ê²Œ
      const DBEnh = window.DBEnh;
      // 1) í† í°ë§Œ ë³´ë‚´ëŠ” API (ì‹œíŠ¸/ëª©ë¡ ë¡œë”© ê³„ì—´)
      async function apiText(type) {
        const token = await waitForIdToken();
        const res = await fetch(`${WEBAPP_URL}?type=${encodeURIComponent(type)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
            'Authorization': `Bearer ${token}`,
          },
          body: token, // í•˜ìœ„í˜¸í™˜
        });
        if (!res.ok) throw new Error(`${type}_http_${res.status}`);
        return res.json();
      }

      // 2) JSON í˜ì´ë¡œë“œ ë™ë°˜ API (compute, sum_stats, enh_select, enchant_select ë“±)
      async function apiJSON(type, payload = {}) {
        const token = await waitForIdToken();
        const body = { id_token: token, ...payload };

        const res = await fetch(`${WEBAPP_URL}?type=${encodeURIComponent(type)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,       // í—¤ë”
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) throw new Error(`${type}_http_${res.status}`);
        return res.json();        // í•­ìƒ JSON ê°ì²´ë¥¼ ëŒë ¤ì¤Œ
      }

      async function populateMonsterSelect() {
        const sel = document.getElementById('selMonster');
        if (!sel) return;

        try {
          // 1) init ì‘ë‹µì— ì‹¤ë ¤ì˜¨ ê²½ëŸ‰ ë¦¬ìŠ¤íŠ¸ ì‚¬ìš© (ë‘˜ ë‹¤ ëŒ€ì‘)
          const src =
            (CORE?.lists?.['monster:list']) ||
            (window.CORE_DATA?.['monster:list']) || [];

          // shape: { monName, base }
          const names = [...new Set(
            src.map(x => String(x?.monName || '').trim()).filter(Boolean)
          )];

          // ê¸°ë³¸ ëª¬ìŠ¤í„° ê²°ì •: base==='ê¸°ë³¸' â†’ 'ê±°ëŒ€ëˆ„ê³¨' â†’ ì²« í•­ëª©
          const def =
            (src.find(x => String(x?.base || '').trim() === 'ê¸°ë³¸')?.monName) ||
            (names.includes('ê±°ëŒ€ëˆ„ê³¨') ? 'ê±°ëŒ€ëˆ„ê³¨' : (names[0] || ''));

          // 2) ì˜µì…˜ êµ¬ì„±
          sel.innerHTML = '';
          for (const nm of names) {
            const opt = document.createElement('option');
            opt.value = opt.textContent = nm;
            sel.appendChild(opt);
          }

          // 3) ë³€ê²½ ì´ë²¤íŠ¸ ì—°ê²°(í•œ ë²ˆë§Œ)
          sel.onchange = onMonsterChange;

          // 4) ê¸°ë³¸ê°’ 1íšŒ ì ìš© (ì„¸ì…˜ ë°˜ì˜ + í•©ì‚°/ë Œë”)
          if (names.length) {
            sel.value = def;
            await onMonsterChange();
          } else {
            console.warn('[MON] monster:list empty from CORE.lists/CORE_DATA');
          }
        } catch (e) {
          console.error('[MON] populate failed', e);
        }
      }



      function detectIsMobile() {
        const uaData = navigator.userAgentData;
        if (uaData && 'mobile' in uaData) return !!uaData.mobile;

        const ua = navigator.userAgent.toLowerCase();
        const isPhoneUA = /iphone|ipod|android.*mobile|windows phone|blackberry|bb10/.test(ua);
        const isTabletUA = /ipad|android(?!.*mobile)/.test(ua);
        const coarsePtr = matchMedia?.('(pointer:coarse)')?.matches;
        const narrowSide = Math.min(screen.width, screen.height) <= 820;
        return isPhoneUA || isTabletUA || (coarsePtr && narrowSide);
      }

      // íŒŒì¼ ìƒë‹¨ ì–´ë”˜ê°€(ì „ì—­)
      window.__loginPingSent = false;
      window.__loginPingResult = null;

      // ğŸ”¹ ë¡œê·¸ì¸í•œ ì´ìš©ìì˜ ì§ì±… ì •ë³´ (0=ì „ì„, 1=ì±…ì„, 2=ìˆ˜ì„)
      window.__userRole = window.__userRole || { level: 0, label: 'ì „ì„' };

      // ğŸ”¹ ì§ì±…ë³„ í”„ë¦¬ì…‹ ì‚¬ìš© ê°€ëŠ¥ ìµœëŒ€ ìŠ¬ë¡¯ ìˆ˜
      function getUserPresetLimit() {
        const info = window.__userRole || {};

        // 1ìˆœìœ„: ê³„ì‚°ê¸°ëª©ë¡ ì‹œíŠ¸ì˜ 'ìŠ¬ë¡¯' ì»¬ëŸ¼ ê°’
        if (typeof info.presetSlots === 'number' && info.presetSlots >= 0) {
          return Math.max(0, Math.min(20, info.presetSlots));
        }

        // 2ìˆœìœ„: ê¸°ì¡´ ì§ì±…ë³„ ê¸°ë³¸ê°’ (ë°±ì›Œë“œ í˜¸í™˜ìš©)
        const lvl = (typeof info.level === 'number') ? info.level : 0;

        if (lvl >= 3) return 10;  // ìˆ˜ì„
        if (lvl === 2) return 3;  // ì±…ì„
        if (lvl === 1) return 1;  // ì„ ì„
        return 0;                 // ì „ì„
      }

      async function loginPingOnce() {
        if (window.__loginPingSent && window.__loginPingResult) {
          return window.__loginPingResult;
        }
        window.__loginPingSent = true;

        try {
          const data = await apiJSON('login_ping', {
            ua: navigator.userAgent,
            screen: `${screen.width}x${screen.height}@${(window.devicePixelRatio || 1)}`,
            is_mobile: detectIsMobile()
          });

          // âœ… ok ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ, íƒˆí‡´ ì•ˆë‚´ëŠ” ìˆìœ¼ë©´ ë¬´ì¡°ê±´ 1íšŒ ë…¸ì¶œ
if (data && data.withdrawn) {
  window.showWithdrawNoticeOnce(data.withdrawMessage || '');
}

          //console.log('login_ping success:', data);


          if (data && data.ok) {
            const lvl = (typeof data.roleLevel === 'number') ? data.roleLevel : 0;
            const label = data.roleLabel || (lvl >= 2 ? 'ìˆ˜ì„' : (lvl >= 1 ? 'ì±…ì„' : 'ì „ì„'));

            // â˜… ë°±ì—”ë“œì—ì„œ ë‚´ë ¤ì¤€ ì‚¬ìš©ìë³„ í”„ë¦¬ì…‹ ìŠ¬ë¡¯ ìˆ˜
            const slots = (typeof data.presetSlots === 'number' && data.presetSlots >= 0)
              ? Math.min(20, data.presetSlots)        // 0~10 ì‚¬ì´ë¡œ í´ë¨í”„
              : 0;

            // ğŸ”¹ ì „ì—­ ì§ì±…/ìŠ¬ë¡¯ ìƒíƒœ ì €ì¥
            window.__userRole = { level: lvl, label, presetSlots: slots };

            // ğŸ”¹ í”„ë¦¬ì…‹ ë²„íŠ¼ ê¶Œí•œ UI ê°±ì‹ 
            if (typeof updatePresetButtonsUI === 'function') {
              try { updatePresetButtonsUI(); } catch (e) {
                console.warn('[preset UI] update ì‹¤íŒ¨:', e);
              }
            }
            // âœ… íƒˆí‡´ ì•ˆë‚´ ëª¨ë‹¬
if (data.withdrawn) {
  window.showWithdrawNoticeOnce(data.withdrawMessage || '');
}
            // â˜… ì—¬ê¸°! pendingReply ìˆìœ¼ë©´ íŒì—… ë„ìš°ê¸°
            if (data.pendingReply && data.pendingReply.reply) {
              openReplyPopup(data.pendingReply);
            }
            // ğŸ”¹ ë¡œê·¸ì¸ ì„±ê³µ í›„ì—ë§Œ ê´€ë¦¬ì ë¬¸ì˜ ì•„ì´ì½˜ ë³´ì—¬ì£¼ê¸°
            const contactBtn = document.getElementById('btnContactAdmin');
            if (contactBtn) {
              contactBtn.style.display = 'inline-flex';
            }
            const b = document.getElementById('btnFaq');
            if (b) b.style.display = 'inline-flex';
          }

          window.__loginPingResult = data;
          return data;
        } catch (e) {
          console.warn('login_ping failed:', e);
          window.__loginPingResult = { ok: false, error: e.message };
          return window.__loginPingResult;
        }
      }

      // ë¬¸ì˜ ì „ì†¡ ì„¸íŒ…
      (function setupContactForm() {
        const btnContact = document.getElementById('btnContact');      // ì œëª© ìš°ì¸¡ ì•„ì´ì½˜ ë²„íŠ¼
        const modal = document.getElementById('contactModal');
        const textarea = document.getElementById('contactTalk');
        const btnSend = document.getElementById('btnContactSend');

        if (!modal || !textarea || !btnSend) return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì¢…ë£Œ

        // (ì•„ì´ì½˜ ë²„íŠ¼ìœ¼ë¡œ ëª¨ë‹¬ ì—´ê¸° â€“ ì´ë¯¸ ìˆìœ¼ì‹œë©´ ìƒëµ)
        if (btnContact && !btnContact._bound) {
          btnContact._bound = true;
          btnContact.addEventListener('click', () => {
            modal.classList.add('show');
            textarea.focus();
          });
        }

        // ë³´ë‚´ê¸° ë²„íŠ¼ í´ë¦­ â†’ contact_admin í˜¸ì¶œ
        if (!btnSend._bound) {
          btnSend._bound = true;
          btnSend.addEventListener('click', async () => {
            const talk = textarea.value.trim();
            if (!talk) {
              (window.toast || alert)('ë¬¸ì˜ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
              return;
            }

            try {
              btnSend.disabled = true;

              const roleInfo = window.__userRole || {};
              const res = await apiJSON('contact_admin', {
                talk,
                // í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ì¸ê²Œì„ / ìœ íŠœë¸Œë„ ê°™ì´ ë„˜ê¸¸ ìˆ˜ ìˆìŒ
                ingame: '...',
                youtube: '...',
                role: roleInfo.label || '',
              });

              if (!res || !res.ok) {
                throw new Error(res?.error || 'contact_fail');
              }

              textarea.value = '';
              modal.classList.remove('show');
              (window.toast || alert)('ë¬¸ì˜ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');
            } catch (e) {
              console.error('[contact_admin] ì‹¤íŒ¨:', e);
              (window.toast || alert)('ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
            } finally {
              btnSend.disabled = false;
            }
          });
        }
      })();


      // --- [ENCHANT] ë§ˆë¶€ íƒ€ì…ë§Œ í—ˆìš© ---
      const ENCHANT_TYPES = new Set([
        'ë¬´ê¸°ë§ˆë¶€', 'ë¨¸ë¦¬ì–´ê¹¨ë§ˆë¶€', 'ìƒì˜ë§ˆë¶€', 'í•˜ì˜ë§ˆë¶€', 'í—ˆë¦¬ë§ˆë¶€', 'ì‹ ë°œë§ˆë¶€',
        'íŒ”ì°Œë§ˆë¶€', 'ëª©ê±¸ì´ë§ˆë¶€', 'ë°˜ì§€ë§ˆë¶€', 'ë³´ì¥ë§ˆë¶€', 'ì¹­í˜¸ë§ˆë¶€',
        'ê·€ê±¸ì´ë§ˆë¶€', 'ë§ˆë²•ì„ë§ˆë¶€'
      ]);
      const fix = s => String(s || '').replace(/\s+/g, '').trim();
      function normalizeEnchantType(v) {
        const k = fix(v);
        if (ENCHANT_TYPES.has(k)) return k;
        const alias = { 'ë¨¸ë¦¬/ì–´ê¹¨ë§ˆë¶€': 'ë¨¸ë¦¬ì–´ê¹¨ë§ˆë¶€', 'ë³´ì¡°ì¥ë¹„ë§ˆë¶€': 'ë³´ì¥ë§ˆë¶€' };
        return alias[k] || null;
      }
      // 'ì¢…ë¥˜' ë¬¸ìì—´ í‘œì¤€í™”: ê³µë°±/í•˜ì´í”ˆ ì œê±° + ë™ì˜ì–´ í†µì¼
      // 'ì¢…ë¥˜' ë¬¸ìì—´ì„ í‘œì¤€ í‚¤ë¡œ ë³€í™˜
      function normalizeSealType(s) {
        const raw = String(s ?? '');
        const t = raw.replace(/\s+|-/g, '').replace(/[()]/g, '').trim();

        const has = (w) => t.includes(w);
        const isDef = /ë°©ì–´êµ¬|ë°©ì–´/.test(t);
        const isAks = /ì•…ì„¸|ì•…ì„¸ì„œë¦¬|ì•¡ì„¸/.test(t);
        const isBoj = /ë³´ì¥|ë³´ì¡°ì¥ë¹„|ë³´ì¡°/.test(t);

        const isUni = /ê³ ìœ /.test(t) || /ê³ ìœ ì˜µì…˜/.test(t);
        const isGen = /ì¼ë°˜/.test(t) || /ì¼ë°˜ì˜µì…˜/.test(t);

        let out = null;
        if (has('ë¬´ê¸°') && isUni) out = 'ë¬´ê¸°ê³ ìœ ';
        else if (has('ë¬´ê¸°') && isGen) out = 'ë¬´ê¸°ì¼ë°˜';
        else if (isDef && isUni) out = 'ë°©ì–´ê³ ìœ ';
        else if (isDef && isGen) out = 'ë°©ì–´ì¼ë°˜';
        else if (isAks && isUni) out = 'ì•…ì„¸ê³ ìœ ';
        else if (isAks && isGen) out = 'ì•…ì„¸ì¼ë°˜';
        else if (isBoj && isUni) out = 'ë³´ì¥ê³ ìœ ';
        else if (isBoj && isGen) out = 'ë³´ì¥ì¼ë°˜';

        if (!out) {
          // í‘œì¤€í™” ì‹¤íŒ¨í•œ ì›ë¬¸ ì¢…ë¥˜ë¥¼ í•œ ë²ˆë§Œ ë¡œê·¸
          dbgOnce('sealType_unmatched_' + raw, 'âš ï¸ normalizeSealType unmatched:', { raw, t });
          return raw.trim();
        }
        return out;
      }
      // ì „ì—­ ë°”ì¸ë”©(ë‹¤ë¥¸ ìŠ¤ì½”í”„/ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë°˜ë“œì‹œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
      if (typeof window !== 'undefined') window.normalizeSealType = normalizeSealType;

      async function apiCastleSealInit() {    // ì„±ì•ˆì˜ë´‰ì¸ ê¸°ë³¸ í•¨ìˆ˜
        const id_token = await waitForIdToken();
        const r = await fetch(`${WEBAPP_URL}?type=castleSeal_init`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id_token })
        });
        return r.json();
      }

      // ì „ì—­ í”Œë˜ê·¸
      let __calcInited = false;
      // í•„ìš”ì‹œ í† ìŠ¤íŠ¸ ëŒ€ì²´
      window.toast = window.toast || function (msg) { alert(msg); };


      async function initCalculatorOnce() {
        if (window.__calcInited) return;
        window.__calcInited = true;

        delete state.CurrentSumStats;
        delete state.Skills;

        try {

          // 0) ë¡œê·¸ì¸ í† í° í™•ë³´
          const id_token = await waitForIdToken(); // í† í° ë¨¼ì € í™•ë³´



          await loginPingOnce().catch(() => { });   // í† í° í™•ë³´ í›„ì— í•‘

          setProgressExactMonotonic(0, 'ê¸°ë³¸ ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');

          // 1-1) init ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ 15 â†’ 40% ì‚¬ì´ë¥¼ ê°€ì§œë¡œ ì„œì„œíˆ ì˜¬ë ¤ì¤Œ
          const stopInitProgress = startFakeProgress(
            0,  // from
            70,  // to (ì—¬ê¸°ê¹Œì§€ë§Œ ê°€ê²Œ)
            'ê¸°ë³¸ ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦',
            400, // 0.3ì´ˆë§ˆë‹¤
            7    // 1%ì”© ì¦ê°€
          );

          const res = await apiJSON('init', {}).catch((e) => {
            // ì—ëŸ¬ë‚˜ë„ íƒ€ì´ë¨¸ ì •ë¦¬
            stopInitProgress();
            throw e;
          });

          // ì •ìƒ ì‘ë‹µì´ë©´ íƒ€ì´ë¨¸ ì •ë¦¬
          stopInitProgress();

          if (!res || !res.ok) {
            window.__calcInited = false;
            throw new Error(res?.error || 'init_failed');
          }
          setProgressExactMonotonic(75, 'ê¸°ë³¸ ë°ì´í„° ì ìš© ì¤‘â€¦');
          // 2) CORE.lists ì£¼ì… (char:list, set:list, weapon:list, ...)
          window.CORE = window.CORE || {};
          CORE.lists = res.lists || {};
          CORE.userEmail = res.email || null;

          // âœ… ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë©”ì¼ì— ë”°ë¼ ì „ìš© ë²„íŠ¼ í† ê¸€
          updateSpecialUserButton();

          setProgressExactMonotonic(79, 'ì„±ì•ˆ/ë²„í”„ ìƒíƒœ ë°˜ì˜ ì¤‘â€¦');

          // âœ… init ì‘ë‹µì—ì„œ ê¸°ë³¸ ì„±ì•ˆ ì¦‰ì‹œ ë°˜ì˜
          if (res.CastleSeal || res.CastleStats) {
            state.CastleStats = res.CastleStats || null;
            state.castleSeal = {
              main: res.CastleSeal?.main ? { name: res.CastleSeal.main } : null,
              sub: res.CastleSeal?.sub ? { name: res.CastleSeal.sub } : null,
            };
            if (typeof refreshSealLabelsFromState === 'function') {
              refreshSealLabelsFromState();
            }
          }
          setProgressExactMonotonic(85, 'ì•„ë°”íƒ€/ëª¬ìŠ¤í„° ì„¤ì • ì¤€ë¹„ ì¤‘â€¦');
          // ì•„ë°”íƒ€/ë¬´ê¸°ì•• ë“œë¡­ë‹¤ìš´ ì±„ìš°ê³ , ì²« ì¤„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„œë²„ì— ë°˜ì˜
          await populateAvatarImprintDropdowns(); // ë“œë¡­ë‹¤ìš´ ê°±ì‹ (ì²« ì¤„ ì„ íƒ)
          setProgressExactMonotonic(99, 'ì•„ë°”íƒ€/ë¬´ê¸°ì•• ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
          const $selA = document.getElementById('selAvatar');
          const $selW = document.getElementById('selImprint');
          try {
            // if ($selA?.value) await postAvatarSelect('ì•„ë°”íƒ€', $selA.value);  // ì•„ë°”íƒ€ ëª©ë¡ ìƒì„±
            // if ($selW?.value) await postAvatarSelect('ë¬´ê¸°ì••', $selW.value);  // ë¬´ê¸°ì•• ëª©ë¡ ìƒì„±
          } catch (_) { /* ë¬´ì‹œ */ }

          await populateMonsterSelect();    // ëª¬ìŠ¤í„° ì„¤ì • ëª©ë¡ ìƒì„±

          //await ensureEnchantCache();     // ?? ê°ì¸ ì„¤ì • ëª©ë¡ ìƒì„±
          await buildRuneEngraveNameOptions();    // ë£¬ ê°ì¸ ì„¤ì • ëª©ë¡ ìƒì„±
          bindRuneEngraveEvents();    // ë£¬ ê°ì¸ ì„¸ë¶€ ì„¤ì • ëª©ë¡ ìƒì„±
          setProgressExactMonotonic(100, 'ë£¬ ê°ì¸ ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
          //await recalcAndRenderPanel();
          // (ì•ˆì „ê°€ë“œ) ë°˜ë“œì‹œ í•„ìš”í•œ í‚¤ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
          if (!Array.isArray(CORE.lists['char:list'])) {
            console.warn('[init] char:list missing in CORE.lists');
          }

        } catch (err) {
          console.error('[initCalculatorOnce] failed:', err);
          window.__calcInited = false;  // ì¬ì‹œë„ ê°€ëŠ¥í•˜ê²Œ
          (typeof toast === 'function' ? toast : alert)('ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          throw err;
        }
      }



      /* ===== ìƒíƒœ/ìƒìˆ˜ ===== */
      const state = {
        CurrentSumStats: null,   // í˜„ì¬ total(íŒ¨ë„ìš©)
        SumBuckets: null,        // ì „ì²´ ë²„í‚·(raw ì„œë²„ ê°’)
        currentCharacter: { jobGroup: null, jobGroupLabel: null, name: null, imgSrc: null, power: null },
        selections: {}, // ì¥ë¹„
        enh: {},   // ìŠ¬ë¡¯ë³„ ê°•í™” ì„ íƒ
        enchants: {},   // ìŠ¬ë¡¯ë³„ ë§ˆë²•ë¶€ì—¬ ì„ íƒ
        ui: { weaponTypeTab: null, enhTargetSlot: null, enhTargetBtn: null },
        currentSlotKey: null,

          // ğŸ”¹ ìë™ê³„ì‚°ì— ì‚¬ìš©í•  ì„¸íŠ¸ ì„ íƒ ìƒíƒœ
  autoSweep: {
    armor: [], // ë°©ì–´êµ¬ ì„¸íŠ¸ ì´ë¦„ ë°°ì—´
    acc:   [], // ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ ì´ë¦„ ë°°ì—´
    spec:  [],  // íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸ ì´ë¦„ ë°°ì—´
     // â˜… ì¶”ê°€
  weapon: [],        // ë¬´ê¸° ì´ë¦„ ë°°ì—´
  weaponCustom: []   // ë¬´ê¸° ê³ ìœ íš¨ê³¼(ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…/ì—†ìŒ) ë°°ì—´
  }
      };


      //ë°©ì–´êµ¬
      //1ì°¨ 'ì™œê³¡: ìŠ¤í‹±í‚¤ ì• ì‹œë“œ ì›¨í€ ì„¸íŠ¸','ìˆ˜í˜¸: ë¹›ì˜ í—Œì‹ ì ì„¸íŠ¸','ì—°ê²©: ë¹›ì˜ í—Œì‹ ì ì„¸íŠ¸','ë³´í˜¸: ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€ ì„¸íŠ¸','ì‹ ì†: ê·¸ë€ë° ì „íˆ¬ê¸°ê°‘ íŒŒì¸  ì„¸íŠ¸','ë ˆê±°ì‹œ: ìì—°ì˜ ìˆ˜í˜¸ì ì„¸íŠ¸',
      //2ì°¨ 'í—ˆìƒ: ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ ì„¸íŠ¸', 'ë³´í˜¸: ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ ì„¸íŠ¸', 'ììƒ: ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ” ì ì„¸íŠ¸',  'ë§¹ë…: ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ” ì ì„¸íŠ¸', 'ìˆ˜í˜¸: ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸ ì„¸íŠ¸',
      //3ì°¨ 'í—ˆìƒ: ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ì„¸íŠ¸','ì™œê³¡: ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸ ì„¸íŠ¸',

      //ì•…ì„¸
      //

      // âœ… íŠ¹ì • êµ¬ê¸€ ê³„ì •ë§Œ ì „ìš© ë²„íŠ¼ì„ ë³´ì´ê²Œ í•˜ëŠ” í—ˆìš© ë¦¬ìŠ¤íŠ¸
      //  ğŸ‘‰ ì—¬ê¸°ì— ë³¸ì¸ êµ¬ê¸€ ë©”ì¼ ì£¼ì†Œë¥¼ ë„£ìœ¼ë©´ ë¨
      const SPECIAL_USER_EMAILS = [
        //'gametestlab0201@gmail.com',
        'gogo456654@gmail.com',
        'gogo4566546@gmail.com',
        'ionix4566541@gmail.com',
        'ionix4566542@gmail.com',
        'ssm941112@gmail.com',
        'ionix4566543@gmail.com',
        'ionix4566544@gmail.com',
        
        // 'another.account@example.com',
      ];

      // âœ… ë¡œê·¸ì¸í•œ ì´ë©”ì¼ì— ë”°ë¼ ë²„íŠ¼ì„ ë³´ì˜€ë‹¤/ìˆ¨ê²¼ë‹¤ í•˜ëŠ” í•¨ìˆ˜
function updateSpecialUserButton() {
  const btnArmor  = document.getElementById('btnSpecialPatch');
  const btnAcc    = document.getElementById('btnSpecialAcc');
  const btnSpec   = document.getElementById('btnSpecialSpec');
  const btnUnique = document.getElementById('btnUniqueBulk');
  const rowUnique = document.getElementById('uniqueOnOffRow');
  const btnAutoSet = document.getElementById('btnAutoSetSweepSelected'); // â† ì¶”ê°€
  const btnAutoSetMissing = document.getElementById('btnAutoSetSweepMissing');
  const btnAutoWeapon = document.getElementById('btnAutoWeaponSweepSelected');

  const emailRaw = (window.CORE && CORE.userEmail) ? CORE.userEmail : null;
  const email = emailRaw ? String(emailRaw).toLowerCase() : '';
  const isAllowed = SPECIAL_USER_EMAILS.includes(email);

  [btnArmor, btnAcc, btnSpec, btnUnique, btnAutoSet, btnAutoSetMissing, btnAutoWeapon].forEach(btn => {
    if (!btn) return;
    btn.style.display = isAllowed ? 'inline-flex' : 'none';
    btn.disabled = !isAllowed;
  });

  if (rowUnique) {
    rowUnique.style.display = isAllowed ? 'flex' : 'none';
  }
}

      // (ì›í•˜ë©´ ì½˜ì†”ì—ì„œ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆê²Œ ì „ì—­ì— ë…¸ì¶œ)
      window.updateSpecialUserButton = updateSpecialUserButton;

      // ğŸ”§ ì „ì—­ì—ì„œë„ ê°™ì€ ê°ì²´ë¥¼ ë°”ë¼ë³´ê²Œ
      window.state = state;

      state.slotVer = state.slotVer || {};   // { weapon: 1, ring: 3 ... }
      state.skillLv = state.skillLv || {}; // {skillId: í˜„ì¬ë ˆë²¨}
      state.stUsedSP = state.stUsedSP || 0;
      state.stUsedTP = state.stUsedTP || 0;
      // ===== SP/TP ìƒíƒœ ë° ë Œë” =====
      state.sp = state.sp || { total: 0, left: 0 };
      state.tp = state.tp || { total: 0, left: 0 };
      state.skillTpLv = state.skillTpLv || {};   // TP ë ˆë²¨ ì €ì¥(ì‚¬ìš© ì¤‘ì´ ì•„ë‹ˆì–´ë„ ë¬´í•´)
      // ===== ë ˆë²¨ë§(ì¥ë¹„/ìŠ¤íƒ¯ í•©ì‚°) =====
      state.leveling = state.leveling || {}; // { 15: n, 20: n, 25: n, ... }
      state.skillDmg = state.skillDmg || {};   // â˜… ìŠ¤í‚¬ í˜„ì¬ ë°ë¯¸ì§€ ìºì‹œ {id: { per, flat, lv }}

      // ===== ì•„ë°”íƒ€ / ìŠ¤í‚¬ë£¬ / ë£¬ê°ì¸ ë²„í‚· =====
      state.avatar = state.avatar || {};             // ì•„ë°”íƒ€/ë¬´ê¸°ì•• ì„ íƒ ì •ë³´
      state.skillrune = state.skillrune || null;           // ìŠ¤í‚¬ë£¬ ì „ì²´ í…Œì´ë¸”(= state.runes ë¯¸ëŸ¬)
      state.runeEngrave = state.runeEngrave || {               // ë£¬ê°ì¸ ì„ íƒ ì •ë³´
        name: null,
        level: null,
      };
      // ê°€í˜¸ / ì§€í˜œ / ì™œê³¡ íŠ¹ìˆ˜ ìŠ¤í‚¬ë£¬ ê°’
      state.specialRunes = state.specialRunes || {
        gaho: 0,
        jihe: 0,
        waegok: 0,
      };

      let __progressPct = 0;

      function setProgressExactMonotonic(nextPct, label) {
        const p = Math.max(__progressPct, Math.min(100, Math.round(nextPct)));
        __progressPct = p;
        const bar = document.querySelector('.loading-bar__fill');
        const txt = document.getElementById('loadingPct');
        const lbl = document.getElementById('loadingLabel');
        if (bar) bar.style.width = p + '%';
        if (txt) txt.textContent = p + '%';
        if (lbl && label) lbl.textContent = String(label);
      }
      function resetProgress(label) {
        __progressPct = 0;
        setProgressExactMonotonic(0, label ?? 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
      }

      function incProgress(dx, label) {
        const next = Math.min(100, Math.max(0, Math.round(__progressPct + dx)));
        setProgressExactMonotonic(next, label);
      }
      function showOverlay(label) {
        __progressPct = 0;
        setProgressExactMonotonic(0, label || 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
        document.getElementById('loadingOverlay')?.removeAttribute('hidden');
      }
      function hideOverlay() {
        document.getElementById('loadingOverlay')?.setAttribute('hidden', '');
      }
      function hideOverlay() {
        const ov = document.getElementById('loadingOverlay');
        if (ov) ov.setAttribute('hidden', '');
      }
      function setProgress(pct, label) {
        const bar = document.querySelector('.loading-bar__fill');
        const l = document.getElementById('loadingLabel');
        const t = document.getElementById('loadingPct');
        const p = Math.max(0, Math.min(100, Math.round(pct)));
        if (bar) bar.style.width = p + '%';
        if (t) t.textContent = p + '%';
        if (l && label) l.textContent = label;
      }
      // from% ~ to% ì‚¬ì´ë¥¼ ì¼ì • ê°„ê²©ìœ¼ë¡œ "ìŠ¬ì©ìŠ¬ì©" ì˜¬ë ¤ì£¼ëŠ” ê°€ì§œ ì§„í–‰ë¥ 
      function startFakeProgress(from, to, label, intervalMs = 300, step = 1) {
        let cur = from;
        let stopped = false;

        const id = setInterval(() => {
          if (stopped) {
            clearInterval(id);
            return;
          }
          if (cur >= to) {
            clearInterval(id);
            return;
          }
          cur += step;
          setProgressExactMonotonic(cur, label);
        }, intervalMs);

        // ë‚˜ì¤‘ì— í˜¸ì¶œí•´ì„œ ì •ì§€í•˜ëŠ” í•¨ìˆ˜ ë°˜í™˜
        return function stopFakeProgress() {
          stopped = true;
          clearInterval(id);
        };
      }

      // ëª¨ë“  ì‹œíŠ¸ í•œ ë²ˆì— í”„ë¦¬ë¡œë“œ (ë¡œê·¸ì¸ í›„ì—ë§Œ í˜¸ì¶œ)
      // ëª¨ë“  ì‹œíŠ¸ í•œ ë²ˆì— í”„ë¦¬ë¡œë“œ (ë¡œê·¸ì¸ í›„ì—ë§Œ í˜¸ì¶œ)
      async function preloadAllSheets({ weightCore = 30, weightSlots = 70 } = {}) {
        await waitForIdToken();

        const slots = [
          'weapon', 'headshoulder', 'top', 'bottom', 'belt', 'shoes',
          'bracelet', 'necklace', 'ring', 'sub', 'aura', 'title',
          'creature', 'artifact', 'earring', 'magestone'
        ];
        const totalSlots = slots.length;

        const coreW = Math.max(0, Math.min(100, weightCore | 0));
        const slotsW = Math.max(0, Math.min(100 - coreW, weightSlots | 0));
        // â”€â”€ ë™ì  ì½”ì–´ ë‹¨ê³„ êµ¬ì„± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const steps = [];
        if (typeof loadCharacterSheet === 'function') steps.push(['ìºë¦­í„°', () => loadCharacterSheet()]);
        //if (typeof ensureSkillLoaded2 === 'function') steps.push(['ìŠ¤í‚¬', () => ensureSkillLoaded2()]);
        //else if (typeof loadSkillSheet === 'function') steps.push(['ìŠ¤í‚¬', () => loadSkillSheet()]);
        if (typeof BuffLeveling?.preload === 'function') steps.push(['ë²„í”„', () => BuffLeveling.preload()]);
        if (typeof ensureEnhLoaded === 'function') steps.push(['ê°•í™”/ì— ë¸”ë ˜', () => ensureEnhLoaded()]);
        if (typeof ensureSetLoaded === 'function') steps.push(['ì„¸íŠ¸', () => ensureSetLoaded()]);
        if (typeof ensureExceptionLoaded === 'function') steps.push(['ì˜ˆì™¸ê·œì¹™', () => ensureExceptionLoaded()]);
        const perCore = steps.length ? (coreW / steps.length) : coreW;
        // ìŠ¬ë¡¯ì€ **done/total ê¸°ë°˜ìœ¼ë¡œ í¼ì„¼íŠ¸ ë°˜ì˜**
        let slotProgress = 0;

        // â”€â”€ 1. ì½”ì–´ ë‹¨ê³„(ë™ì ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const runStep = async (label, fn) => {
          setProgressExactMonotonic(__progressPct, `${label} ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
          await fn();
          __progressPct += perCore;
          setProgressExactMonotonic(__progressPct, `${label} ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
        };
        for (const [label, fn] of steps) {
          await runStep(label, fn);
        }


        // â”€â”€ 2. ìŠ¬ë¡¯ë“¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const loadSlot = (s) => ensureLoaded(s);

        let done = 0;
        const promises = slots.map(s =>
          Promise.resolve()
            .then(() => {
              const label = labelForSlot(s);
              setProgressExactMonotonic(__progressPct, `${label} ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
            })
            .then(() => loadSlot(s))
            .then(() => {
              done += 1;
              // âœ… ë¹„ìœ¨ ê¸°ë°˜ ì§„í–‰ë„
              slotProgress = (done / totalSlots) * slotsW;
              setProgressExactMonotonic(coreW + slotProgress, `ì•„ì´í…œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦ (${done}/${totalSlots})`);
            })
        );

        await Promise.all(promises);

        // â”€â”€ 3. ë”± ë§ì¶°ì„œ 100% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        __progressPct = 100;
        setProgressExactMonotonic(100, 'ëª¨ë“  ë°ì´í„° ë¡œë”© ì™„ë£Œ');
      }






      // === [ENCHANT] ì „ì—­ ìºì‹œ & í”„ë¦¬ë¡œë“œ ===
      const ENCHANT_CACHE = {
        ready: false,            // í”„ë¦¬ë¡œë“œ ì™„ë£Œ ì—¬ë¶€
        byType: new Map(),       // 'ë¬´ê¸°ë§ˆë¶€' -> [{name, typeKey}, ...]
        version: 'v1',           // ìºì‹œ ë²„ì „(ì‹œíŠ¸ê°€ ë°”ë€Œë©´ ì—¬ê¸° ë¬¸ìì—´ë§Œ ë°”ê¿” ìƒˆë¡œ ë°›ë„ë¡)
      };

      const DBSkill = { loaded: false, headers: [], rows: [] };

      // ê°•í™”/ë§ˆë´‰/ë§ˆë¶€(ENHANCE_SHEET) ì‚¬ì „ ë¡œë“œ: ë°±ì—”ë“œ(JSON) ë²„ì „
      // ì „ì—­ì—ì„œ ë””ë²„ê·¸ on/off (í•„ìš”í•  ë•Œë§Œ trueë¡œ)
      window.__SEAL_DBG ??= false;

      // ë§ˆë²•ë¶€ì—¬ ìºì‹œ í”„ë¦¬ë¡œë“œ: CORE.lists['enh:list']ë§Œ ì‚¬ìš© (ë°±ì—”ë“œ í˜¸ì¶œ ì—†ìŒ)
      async function preloadEnchantSheet() {
        // ì´ë¯¸ ì¤€ë¹„ë˜ì–´ ìˆìœ¼ë©´ ìŠ¤í‚µ
        if (ENCHANT_CACHE.ready) return;

        // ë””ë²„ê·¸ ì‹œì‘
        const _t0 = performance.now();
        if (window.__SEAL_DBG) {

        }

        // 1) CORE.lists['enh:list'] í™•ë³´
        const rows = Array.isArray(CORE?.lists?.['enh:list']) ? CORE.lists['enh:list'] : null;
        if (!rows) {
          if (window.__SEAL_DBG) console.groupEnd();
          throw new Error('core_enh_list_missing'); // init ì „ì— í˜¸ì¶œë˜ë©´ ì—¬ê¸°ì„œ ë§‰í˜
        }

        // 2) ë§ˆë²•ë¶€ì—¬ íƒ€ì…ë§Œ í•„í„° (ê°•í™”/ë§ˆë´‰ ì œì™¸)
        const ENCHANT_TYPES = new Set([
          'ë¬´ê¸°ë§ˆë¶€', 'ë¨¸ë¦¬ì–´ê¹¨ë§ˆë¶€', 'ìƒì˜ë§ˆë¶€', 'í•˜ì˜ë§ˆë¶€', 'í—ˆë¦¬ë§ˆë¶€', 'ì‹ ë°œë§ˆë¶€',
          'íŒ”ì°Œë§ˆë¶€', 'ëª©ê±¸ì´ë§ˆë¶€', 'ë°˜ì§€ë§ˆë¶€', 'ë³´ì¥ë§ˆë¶€', 'ì¹­í˜¸ë§ˆë¶€',
          'ê·€ê±¸ì´ë§ˆë¶€', 'ë§ˆë²•ì„ë§ˆë¶€'
        ]);
        const byType = new Map();

        const fix = (v) => String(v ?? '').trim();
        const normType = (v) => {
          const s = (typeof normalizeEnchantType === 'function')
            ? normalizeEnchantType(v)
            : fix(v);
          return s;
        };

        for (const r of rows) {
          // CORE ê¸°ë³¸ í‚¤: { type, name, jobGroup, ... } ë¼ê³  ê°€ì •
          const t = normType(r?.type ?? r?.['ì¢…ë¥˜'] ?? r?.['íƒ€ì…'] ?? r?.['ë¶„ë¥˜']);
          if (!ENCHANT_TYPES.has(t)) continue;           // ë§ˆë²•ë¶€ì—¬ê°€ ì•„ë‹ˆë©´ ì œì™¸

          const name = fix(r?.name ?? r?.['ì´ë¦„']);
          if (!name) continue;

          const jobGroup = fix(r?.jobGroup ?? r?.['ì§ì—…êµ°']);
          if (!byType.has(t)) byType.set(t, []);
          byType.get(t).push({
            name,            // ë²„íŠ¼ ë¼ë²¨ë¡œ ì‚¬ìš©
            typeKey: t,      // 'ë¬´ê¸°ë§ˆë¶€' ë“±
            stats: null,     // í”„ë¡ íŠ¸ëŠ” ë¯¸ë¦¬ ìŠ¤íƒ¯ ì‚¬ìš© ì•ˆ í•¨ (ì„œë²„ buildStatsFromRow ì‚¬ìš©)
            jobGroup,        // í•„í„°/í‘œì‹œìš© (ìˆìœ¼ë©´)
            raw: r           // í•„ìš” ì‹œ ì›ë³¸ ì ‘ê·¼
          });
        }

        // 3) ì „ì—­ ìºì‹œì— ë°˜ì˜
        ENCHANT_CACHE.byType = byType;
        ENCHANT_CACHE.ready = true;

        // ë””ë²„ê·¸ ìš”ì•½

      }


      async function ensureEnchantCache() {
        if (ENCHANT_CACHE.ready) return;
        if (!Array.isArray(CORE?.lists?.['enh:list'])) return; // CORE ì¤€ë¹„ ì „ì´ë©´ ìŠ¤í‚µ(ë‹¤ìŒì— ë‹¤ì‹œ í˜¸ì¶œ)
        await preloadEnchantSheet(); // ì‹¤íŒ¨ ì‹œ ready=trueë¡œ ë‘ì§€ ë§ ê²ƒ
      }


      // === [ENCHANT] 0) ì„¸ë¶€ìƒì(3ë²ˆì§¸) ê¸°ë³¸ ë¼ë²¨ "ë§ˆë²• ë¶€ì—¬"ë¡œ ì„¸íŒ… ===
      // === [ENCHANT] 0) ì„¸ë¶€ìƒì ê¸°ë³¸ ë¼ë²¨/ì—­í•  ì„¸íŒ… ===
      function setDefaultEnchantLabels() {
        // â‘  ì¥ë¹„ ìŠ¬ë¡¯ í–‰: ì„¸ ë²ˆì§¸ ì„¸ë¶€ìƒì â†’ "ë§ˆë²• ë¶€ì—¬"
        document.querySelectorAll('.slot-row').forEach(row => {
          const third = row.querySelector('.outer-rects .rect:nth-child(3)');
          if (third) {
            third.textContent = 'ë§ˆë²• ë¶€ì—¬';
            third.dataset.role = 'enchant';
            third.removeAttribute('data-unused');
            third.removeAttribute('aria-disabled');
            third.disabled = false;
            third.classList.remove('disabled', 'is-disabled');
            third.style.pointerEvents = ''; // í˜¹ì‹œ ë§‰í˜€ ìˆìœ¼ë©´ í•´ì œ
          }
        });

        // â‘¡ C2(ì¹­í˜¸) mini-cell: ì²« ë²ˆì§¸ ì„¸ë¶€ë²„íŠ¼ í™œì„±í™” â†’ "ë§ˆë²• ë¶€ì—¬"
        const c2cell = document.querySelector('.slot.mini[data-slot="C2"]')?.closest('.mini-cell');
        if (c2cell) {
          const firstBtn = c2cell.querySelector('.outer-rects .rect:nth-child(1)');
          if (firstBtn) {
            firstBtn.textContent = 'ë§ˆë²• ë¶€ì—¬';
            firstBtn.dataset.role = 'enchant';
            firstBtn.removeAttribute('data-unused');
            firstBtn.removeAttribute('aria-disabled');
            firstBtn.disabled = false;
            firstBtn.classList.remove('disabled', 'is-disabled');
            firstBtn.style.pointerEvents = '';
          }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        setDefaultEnchantLabels();
        //ensureEnchantCache();
      });

      // === [ENCHANT] 1) ìŠ¬ë¡¯í‚¤ â†’ ë§ˆë²•ë¶€ì—¬ ì¢…ë¥˜í‚¤ ë§¤í•‘ ===


      // === [ENCHANT] 2) ENHANCE_SHEET ë¡œë”© & ì˜µì…˜ ì¶”ì¶œ ===
      // === [ENCHANT] ìºì‹œ ìš°ì„  ì˜µì…˜ ë¡œë” ===
      async function loadEnchantOptions(typeKey) {
        await ensureEnchantCache();
        return ENCHANT_CACHE.byType.get(typeKey) ?? [];
      }



      // === [ENCHANT] 3) ëª¨ë‹¬ í•¸ë“¤ëŸ¬ ===
      function slotCodeToServerSlot(code) {
        const c = String(code).toUpperCase();
        const map = {
          R1: 'weapon', L1: 'headshoulder', L2: 'top', L3: 'bottom', L4: 'belt', L5: 'shoes', L6: 'earring',
          R2: 'bracelet', R3: 'necklace', R4: 'ring', R5: 'sub', R6: 'magestone', C2: 'title'
        };
        return map[c] || c; // ì´ë¯¸ ì„œë²„ í‚¤ë©´ ê·¸ëŒ€ë¡œ
      }
      // UI ìŠ¬ë¡¯ì½”ë“œ(R1â€¦C2) â†’ 'â€¦ë§ˆë¶€' ë¬¸ìì—´
      function enchantTypeForSlot(slotKey) {
        const map = {
          'R1': 'ë¬´ê¸°ë§ˆë¶€',
          'L1': 'ë¨¸ë¦¬ì–´ê¹¨ë§ˆë¶€',
          'L2': 'ìƒì˜ë§ˆë¶€',
          'L3': 'í•˜ì˜ë§ˆë¶€',
          'L4': 'í—ˆë¦¬ë§ˆë¶€',
          'L5': 'ì‹ ë°œë§ˆë¶€',
          'L6': 'ê·€ê±¸ì´ë§ˆë¶€',    // â˜… ì¶”ê°€

          'R2': 'íŒ”ì°Œë§ˆë¶€',
          'R3': 'ëª©ê±¸ì´ë§ˆë¶€',
          'R4': 'ë°˜ì§€ë§ˆë¶€',
          'R5': 'ë³´ì¥ë§ˆë¶€',
          'R6': 'ë§ˆë²•ì„ë§ˆë¶€',    // â˜… ì¶”ê°€

          'C2': 'ì¹­í˜¸ë§ˆë¶€',
        };
        return map[String(slotKey).toUpperCase()] || null;
      }

      const $enchantModal = document.getElementById('enchantModal');
      const $enchantList = document.getElementById('enchantList');

      // âœ… ë°©ì–´êµ¬ ì„¸íŠ¸ ì„ íƒ ëª¨ë‹¬ DOM ì°¸ì¡°
      const $armorSetModal = document.getElementById('armorSetModal');
      const $armorSetList = document.getElementById('armorSetList');
      const $armorSetToggle = document.getElementById('armorSetToggle');

      const $accSetModal = document.getElementById('accSetModal');
      const $accSetList = document.getElementById('accSetList');
      const $accSetToggle = document.getElementById('accSetToggle');

      const $specSetModal   = document.getElementById('specSetModal');
      const $specSetList    = document.getElementById('specSetList');
      const $specSetToggle  = document.getElementById('specSetToggle');

      const $uniqueEffectModal = document.getElementById('uniqueEffectModal');
      const $btnUniqueApply    = document.getElementById('btnUniqueApply');
      const $btnUniqueBulk     = document.getElementById('btnUniqueBulk');
      const $uniqueOnOffToggle = document.getElementById('uniqueOnOffToggle');

function updateUniqueEffectDescriptions() {
  if (!$uniqueEffectModal) return;

  let customList =
    (window.CORE && window.CORE.lists && window.CORE.lists['custom:list']) || [];
  if (!Array.isArray(customList) || !customList.length) {
    // ì»¤ìŠ¤í…€ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì„¤ëª… ë¹„ìš°ê¸°
    $uniqueEffectModal.querySelectorAll('.unique-desc').forEach(el => {
      el.textContent = '';
    });
    return;
  }

  const norm = (v) => String(v ?? '').trim();

  const char = (window.state && window.state.currentCharacter) || {};
  const jobGroup = norm(char.jobGroupLabel || char.jobGroup || '');
  const charName = norm(char.name || '');

  // ì£¼ì–´ì§„ ì˜µì…˜ ì´ë¦„ì— ëŒ€í•´, custom:listì—ì„œ ê°€ì¥ ì ë‹¹í•œ í•œ ì¤„ ê³¨ë¼ì„œ ì„¤ëª… ë¬¸ìì—´ë¡œ ë§Œë“¤ê¸°
  const pickDescByCustomName = (customName) => {
    const t = norm(customName);
    if (!t) return '';

    // 1) ì¢…ë¥˜(type == customName) í•„í„°
    let rowsBase = customList.filter(r => norm(r.type) === t);
    if (!rowsBase.length) return '';

    // 2) ì§ì—…êµ°/ìºë¦­ëª… ìš°ì„  ë§¤ì¹­ (ì—†ìœ¼ë©´ ê³µìš©/ì „ì²´ í–‰ í—ˆìš©)
    let candidates = rowsBase.filter(r =>
      (!jobGroup || norm(r.jobGroup) === jobGroup || !norm(r.jobGroup)) &&
      (!charName || norm(r.name) === charName || !norm(r.name))
    );
    if (!candidates.length) {
      candidates = rowsBase;
    }

    // 3) ì„¤ëª…1~3(í˜¹ì€ ~5ê¹Œì§€) ì¤‘ ìˆëŠ” ê²ƒë§Œ ì´ì–´ë¶™ì´ê¸°
    const r = candidates[0];
    const parts = [
      r.desc1, r.desc2, r.desc3,
      r.desc4, r.desc5
    ]
      .map(v => norm(v))
      .filter(Boolean);

    return parts.join('\n');
  };

  // ì‹¤ì œ DOMì— ì±„ìš°ê¸° (ë¬´ê¸° / ê¸°íƒ€)
  const fillGroup = (selector, names) => {
    names.forEach(name => {
      const descEl = $uniqueEffectModal.querySelector(
        `${selector} .unique-desc[data-value="${name}"]`
      );
      if (!descEl) return;

      if (name === 'ì—†ìŒ') {
        descEl.textContent = '';   // ì—†ìŒì€ ì„¤ëª… ë¹„ì›€
        return;
      }

      const raw = pickDescByCustomName(name);
      descEl.innerHTML = raw
        ? raw.replace(/\n/g, '<br>')
        : '';
    });
  };

  // ë¬´ê¸°: ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…
  fillGroup('.unique-options-weapon', ['ê°•íƒ€', 'ê´‘ì±„', 'ë¶„ì‡„', 'ì„ ëª…', 'ì—†ìŒ']);
  // ê¸°íƒ€: ì„ ë´‰/ì˜ì§€/ì´ìƒ
  fillGroup('.unique-options-other', ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ']);
}


      function initUniqueEffectButtons() {
  if (!$uniqueEffectModal) return;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¬´ê¸° ê·¸ë£¹ (ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…/ì—†ìŒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const weaponRows = Array.from(
    $uniqueEffectModal.querySelectorAll('.unique-options-weapon .unique-row')
  );
  const weaponBtns = weaponRows
    .map(row => row.querySelector('.unique-btn'))
    .filter(Boolean);

  function setWeaponActive(targetBtn) {
    weaponBtns.forEach(b => b.classList.remove('is-active'));
    weaponRows.forEach(r => r.classList.remove('is-selected'));

    if (!targetBtn) return;
    targetBtn.classList.add('is-active');

    const row = targetBtn.closest('.unique-row');
    if (row) row.classList.add('is-selected');
  }

  // ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
  weaponBtns.forEach(btn => {
    btn.addEventListener('click', () => setWeaponActive(btn));
  });

  // ì„¤ëª…/ì¤„ ì˜ì—­ì„ ëˆŒë €ì„ ë•Œë„ ë™ì¼í•˜ê²Œ ì„ íƒë˜ë„ë¡
  weaponRows.forEach(row => {
    row.addEventListener('click', (e) => {
      // ë²„íŠ¼ ìì²´ë¥¼ í´ë¦­í•œ ê²½ìš°ì—” ì—¬ê¸°ì„œ ë‹¤ì‹œ ì²˜ë¦¬í•  í•„ìš” ì—†ìŒ
      if (e.target.closest('.unique-btn')) return;
      const btn = row.querySelector('.unique-btn');
      if (btn) setWeaponActive(btn);
    });
  });

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê¸°íƒ€ ê·¸ë£¹ (ì„ ë´‰/ì˜ì§€/ì´ìƒ/ì—†ìŒ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const otherRows = Array.from(
    $uniqueEffectModal.querySelectorAll('.unique-options-other .unique-row')
  );
  const otherBtns = otherRows
    .map(row => row.querySelector('.unique-btn'))
    .filter(Boolean);

  function setOtherActive(targetBtn) {
    otherBtns.forEach(b => b.classList.remove('is-active'));
    otherRows.forEach(r => r.classList.remove('is-selected'));

    if (!targetBtn) return;
    targetBtn.classList.add('is-active');

    const row = targetBtn.closest('.unique-row');
    if (row) row.classList.add('is-selected');
  }

  otherBtns.forEach(btn => {
    btn.addEventListener('click', () => setOtherActive(btn));
  });

  otherRows.forEach(row => {
    row.addEventListener('click', (e) => {
      if (e.target.closest('.unique-btn')) return;
      const btn = row.querySelector('.unique-btn');
      if (btn) setOtherActive(btn);
    });
  });
}

initUniqueEffectButtons();

if ($btnUniqueApply && $uniqueEffectModal) {
  $btnUniqueApply.addEventListener('click', () => {
    const activeWeaponBtn = $uniqueEffectModal.querySelector('.unique-options-weapon .unique-btn.is-active');
    const activeOtherBtn  = $uniqueEffectModal.querySelector('.unique-options-other .unique-btn.is-active');

    const weapon = activeWeaponBtn ? activeWeaponBtn.dataset.value : 'ì—†ìŒ';  // ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…/ì—†ìŒ
    const other  = activeOtherBtn  ? activeOtherBtn.dataset.value  : 'ì—†ìŒ';  // ì„ ë´‰/ì˜ì§€/ì´ìƒ/ì—†ìŒ

    if (!window.state) window.state = {};
    const state = window.state;
    if (!state.customSkills) state.customSkills = {};
    const cs = state.customSkills;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1) ë¬´ê¸° ê³ ìœ íš¨ê³¼ â†’ ë¬´ê¸° ì»¤ìŠ¤í…€ ë²„íŠ¼ì— ë°˜ì˜
    //    (btnCustomOpt + state.customSkills.type / weaponName)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    {
      const picked = weapon; // ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…/ì—†ìŒ
      const btn = document.getElementById('btnCustomOpt');
      const allNames = ['ê°•íƒ€', 'ê´‘ì±„', 'ë¶„ì‡„', 'ì„ ëª…', 'ì—†ìŒ'];

      let weaponName = '';

      if (picked === 'ì—†ìŒ') {
        // ìƒíƒœ ì´ˆê¸°í™”
        cs.type = '';
        cs.weaponName = '';
        if (typeof state.customOptLabel !== 'undefined') {
          state.customOptLabel = null;
        }
      } else {
        if (typeof getCurrentWeaponName === 'function') {
          try {
            weaponName = getCurrentWeaponName() || '';
          } catch (_) { }
        }
        if (!weaponName) {
          if (typeof toast === 'function') {
            toast('ë¬´ê¸° ì´ë¦„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¬´ê¸°ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.');
          }
          // ë¬´ê¸° ë¶€ë¶„ì€ ê±´ë„ˆë›°ê³ , ê¸°íƒ€ ê³ ìœ íš¨ê³¼(ìƒì˜/íŒ”ì°Œ/ê·€ê±¸ì´)ë§Œ ì ìš© ê³„ì† ì§„í–‰
        } else {
          cs.type = picked;          // ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…
          cs.weaponName = weaponName;
        }
      }

      if (btn) {
        // ë²„íŠ¼ ë¼ë²¨/ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ë¬´ê¸° ì»¤ìŠ¤í…€ì˜µ ë¡œì§ê³¼ ë™ì¼)
        btn.textContent = picked || 'ê³ ìœ íš¨ê³¼(ë¬´ê¸°)';

        allNames.forEach(name => {
          btn.classList.remove('customopt-' + name);
        });
        if (picked) {
          btn.classList.add('customopt-' + picked); // customopt-ê°•íƒ€ / customopt-ì—†ìŒ ë“±
        }
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2) ê¸°íƒ€ ê³ ìœ íš¨ê³¼ â†’ ìƒì˜/íŒ”ì°Œ/ê·€ê±¸ì´ ë™ì‹œì— ë°˜ì˜
    //    (armorType / braceletType / earringType + ê° ë²„íŠ¼ UI)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    {
      const picked = other; // ì„ ë´‰/ì˜ì§€/ì´ìƒ/ì—†ìŒ
      const armorNames     = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];
      const braceletNames  = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];
      const earringNames   = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];

      // 2-1) customSkillsì— ë°˜ì˜ (ë°±ì—”ë“œìš©)
      const otherValue = (picked === 'ì—†ìŒ') ? '' : picked;
      cs.armorType    = otherValue;
      cs.braceletType = otherValue;
      cs.earringType  = otherValue;

      // 2-2) UIìš© ìƒíƒœ(state.*Label) ê°±ì‹ 
      // ìƒì˜ëŠ” í•­ìƒ ë¼ë²¨ì„ ê·¸ëŒ€ë¡œ ë“¤ê³ ê° (ì—†ìŒ í¬í•¨)
      state.customArmor       = { type: picked };
      state.customArmorLabel  = picked;

      // íŒ”ì°Œ/ê·€ê±¸ì´ëŠ” 'ì—†ìŒ'ì¼ ë•Œ null ë¡œ ì²˜ë¦¬ (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
      state.customBraceletLabel = (picked === 'ì—†ìŒ') ? null : picked;
      state.customEarringLabel  = (picked === 'ì—†ìŒ') ? null : picked;

      // 2-3) ìƒì˜ ë²„íŠ¼
      const btnArmor = document.getElementById('btnCustomOptArmor');
      if (btnArmor) {
        btnArmor.textContent = picked || 'ê³ ìœ íš¨ê³¼(ìƒì˜)';

        armorNames.forEach(name => {
          btnArmor.classList.remove('armor-customopt-' + name);
        });
        if (picked) {
          btnArmor.classList.add('armor-customopt-' + picked);
        }
      }

      // 2-4) íŒ”ì°Œ ë²„íŠ¼
      const btnBracelet = document.getElementById('btnCustomOptBracelet');
      if (btnBracelet) {
        btnBracelet.textContent = picked || 'ê³ ìœ íš¨ê³¼(íŒ”ì°Œ)';

        braceletNames.forEach(name => {
          btnBracelet.classList.remove('bracelet-customopt-' + name);
        });
        if (picked) {
          btnBracelet.classList.add('bracelet-customopt-' + picked);
        }
      }

      // 2-5) ê·€ê±¸ì´ ë²„íŠ¼
      const btnEarring = document.getElementById('btnCustomOptEarring');
      if (btnEarring) {
        btnEarring.textContent = picked || 'ê³ ìœ íš¨ê³¼(ê·€ê±¸ì´)';

        earringNames.forEach(name => {
          btnEarring.classList.remove('earring-customopt-' + name);
        });
        if (picked) {
          btnEarring.classList.add('earring-customopt-' + picked);
        }
      }
    }

    // 3) ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ê°±ì‹ 
    if (typeof updateEquipDescPreview === 'function') {
      updateEquipDescPreview();
    }

    // 4) ëª¨ë‹¬ ë‹«ê¸°
    showModal($uniqueEffectModal, false);
  });
}


if ($btnUniqueBulk && $uniqueEffectModal) {
  $btnUniqueBulk.addEventListener('click', () => {
    // 1ï¸âƒ£ í˜„ì¬ ì„ íƒ ìºë¦­í„° ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª… ì±„ìš°ê¸°
    updateUniqueEffectDescriptions();

    // 2ï¸âƒ£ ê¸°ë³¸ ì„ íƒê°’ ì„¸íŒ… (ë‘˜ ë‹¤ 'ì—†ìŒ' ì„ íƒ)
    const weaponBtns = Array.from(
      $uniqueEffectModal.querySelectorAll('.unique-options-weapon .unique-btn')
    );
    const otherBtns = Array.from(
      $uniqueEffectModal.querySelectorAll('.unique-options-other .unique-btn')
    );

    if (!weaponBtns.some(b => b.classList.contains('is-active'))) {
      const noneWeapon = weaponBtns.find(b => b.dataset.value === 'ì—†ìŒ');
      if (noneWeapon) noneWeapon.classList.add('is-active');
    }

    if (!otherBtns.some(b => b.classList.contains('is-active'))) {
      const noneOther = otherBtns.find(b => b.dataset.value === 'ì—†ìŒ');
      if (noneOther) noneOther.classList.add('is-active');
    }

    showModal($uniqueEffectModal, true);
  });
}




      // âœ… í˜„ì¬ ë°©ì–´êµ¬ ì„¸íŠ¸ ëª¨ë“œ (ìµì‹œë“œ / ì—í”½)
      //   - ì§€ê¸ˆì€ ëª¨ì–‘ë§Œ ë°”ê¾¸ê³ , ë‚˜ì¤‘ì— ì´ ê°’ ë³´ê³  í•„í„°ë§ì— í™œìš© ê°€ëŠ¥
      let armorSetMode = 'exceed'; // 'exceed' = ìµì‹œë“œ, 'epic' = ì—í”½
      let uniqueToggleMode = 'off'; // 'off' | 'on' : ê³ ìœ íš¨ê³¼ ON/OFF í† ê¸€ ìƒíƒœ

      function updateArmorToggleUI() {
  // ë°©ì–´êµ¬ í† ê¸€
  if ($armorSetToggle) {
    if (armorSetMode === 'exceed') {
      $armorSetToggle.classList.add('mode-exceed');
      $armorSetToggle.classList.remove('mode-epic');
    } else {
      $armorSetToggle.classList.add('mode-epic');
      $armorSetToggle.classList.remove('mode-exceed');
    }
  }

  // âœ… ì•…ì„¸ í† ê¸€ë„ ë™ì¼ ìƒíƒœë¡œ ìœ ì§€
  if ($accSetToggle) {
    if (armorSetMode === 'exceed') {
      $accSetToggle.classList.add('mode-exceed');
      $accSetToggle.classList.remove('mode-epic');
    } else {
      $accSetToggle.classList.add('mode-epic');
      $accSetToggle.classList.remove('mode-exceed');
    }
  }

    // âœ… íŠ¹ìˆ˜ì¥ë¹„
  if ($specSetToggle) {
    if (armorSetMode === 'exceed') {
      $specSetToggle.classList.add('mode-exceed');
      $specSetToggle.classList.remove('mode-epic');
    } else {
      $specSetToggle.classList.add('mode-epic');
      $specSetToggle.classList.remove('mode-exceed');
    }
  }
}

      // âœ… ê³ ìœ íš¨ê³¼ ON/OFF í† ê¸€ UI ë°˜ì˜
      function updateUniqueOnOffUI() {
        if (!$uniqueOnOffToggle) return;

        if (uniqueToggleMode === 'on') {
          $uniqueOnOffToggle.classList.add('mode-on');
          $uniqueOnOffToggle.classList.remove('mode-off');
        } else {
          $uniqueOnOffToggle.classList.add('mode-off');
          $uniqueOnOffToggle.classList.remove('mode-on');
        }
      }

      function toggleArmorMode() {
  armorSetMode = (armorSetMode === 'exceed') ? 'epic' : 'exceed';
  updateArmorToggleUI();

  // âœ… ë°©ì–´êµ¬/ì•…ì„¸ ì„¸íŠ¸ ëª©ë¡ ëª¨ë‘ í˜„ì¬ ëª¨ë“œì— ë§ê²Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  if ($armorSetList) renderArmorSetModal();
  if ($accSetList)   renderAccSetModal();
  if ($specSetList)  renderSpecSetModal(); 
}


      if ($armorSetToggle) {
        $armorSetToggle.addEventListener('click', () => {
          toggleArmorMode();
        });

        // ìŠ¤í˜ì´ìŠ¤/ì—”í„°ë¡œë„ í† ê¸€ ê°€ëŠ¥í•˜ê²Œ (ì ‘ê·¼ì„±)
        $armorSetToggle.addEventListener('keydown', (e) => {
          if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            toggleArmorMode();
          }
        });
      }

      if ($accSetToggle) {
  $accSetToggle.addEventListener('click', () => {
    toggleArmorMode();
  });

  $accSetToggle.addEventListener('keydown', (e) => {
    if (e.key === ' ' || e.key === 'Enter') {
      e.preventDefault();
      toggleArmorMode();
    }
  });
}

if ($specSetToggle) {
  $specSetToggle.addEventListener('click', () => {
    toggleArmorMode();
  });
  $specSetToggle.addEventListener('keydown', (e) => {
    if (e.key === ' ' || e.key === 'Enter') {
      e.preventDefault();
      toggleArmorMode();
    }
  });
}

      if ($uniqueOnOffToggle) {
        const toggleUnique = () => {
          uniqueToggleMode = (uniqueToggleMode === 'on') ? 'off' : 'on';

          // ìƒíƒœì— ê°™ì´ ì €ì¥í•´ ë‘ê¸° (ë‚˜ì¤‘ì— ê³„ì‚°ì— í™œìš© ê°€ëŠ¥)
          if (!window.state) window.state = {};
          window.state.uniqueOnOff = (uniqueToggleMode === 'on');

          updateUniqueOnOffUI();
          // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ console.logë¡œ í™•ì¸ë„ ê°€ëŠ¥:
          // console.log('[ê³ ìœ íš¨ê³¼ ON/OFF]', window.state.uniqueOnOff);
        };

        $uniqueOnOffToggle.addEventListener('click', () => {
          toggleUnique();
        });

        $uniqueOnOffToggle.addEventListener('keydown', (e) => {
          if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            toggleUnique();
          }
        });
      }



      // ì´ˆê¸° ìƒíƒœ ë°˜ì˜
      updateArmorToggleUI();
      updateUniqueOnOffUI();


      // âœ… ë°©ì–´êµ¬ ì„¸íŠ¸ ëª¨ë‹¬ ë Œë”ë§ (ì‹¤ì œ ì‹œíŠ¸ ë°ì´í„° ì‚¬ìš©)
      function renderArmorSetModal() {
        if (!$armorSetList) return;
        $armorSetList.innerHTML = '';

        const sets = buildArmorSetCardsFromSheets();
        if (!sets.length) {
          $armorSetList.innerHTML =
            '<div class="empty-hint" style="padding:16px;font-size:13px;color:#ddd;">' +
            'ë°©ì–´êµ¬ ì„¸íŠ¸ ì‹œíŠ¸(set:list) ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' +
            '</div>';
          return;
        }

        // â˜… í´ë¦­ ì‹œ ì‚¬ìš©í•  ì „ì—­ ìºì‹œ
        window._armorSetCardsCache = sets;

        sets.forEach((set, idx) => {
          // âœ… ì„¸ ë²ˆì§¸ ì„¸íŠ¸ ì•ì—ë§Œ ìŠ¤í˜ì´ì„œ í•œ ì¹¸ ì‚½ì… â†’ ì²« ì¤„ ì„¸ ë²ˆì§¸ ì¹¸ ë¹„ìš°ê¸°
          if (idx === 2 && sets.length >= 3) {
            const spacer = document.createElement('div');
            spacer.className = 'armor-set-spacer';
            $armorSetList.appendChild(spacer);
          }
          const card = document.createElement('div');
          card.className = 'armor-set-card';
          card.dataset.setType = set.type;
          card.dataset.setIndex = String(idx);

          const header = document.createElement('div');
header.className = 'armor-set-header';

// í˜„ì¬ ìë™ê³„ì‚° ì„ íƒ ìƒíƒœ
const auto = state.autoSweep || (state.autoSweep = { armor: [], acc: [], spec: [], weapon: [], weaponCustom: [] });
const armorSelected = auto.armor || [];
const isSelected = armorSelected.includes(set.name);

// ì™¼ìª½: ì„¸íŠ¸ ì´ë¦„
const titleSpan = document.createElement('span');
titleSpan.className = 'armor-set-header-title';
titleSpan.textContent = set.name;
header.appendChild(titleSpan);

// ì˜¤ë¥¸ìª½: ìë™ê³„ì‚° í† ê¸€ ë²„íŠ¼
const autoBtn = document.createElement('button');
autoBtn.type = 'button';
autoBtn.className = 'set-auto-toggle';
if (isSelected) autoBtn.classList.add('is-selected');
autoBtn.textContent = isSelected ? 'ìë™ê³„ì‚° ëŒ€ìƒ' : 'ìë™ê³„ì‚° ëŒ€ìƒ';

autoBtn.addEventListener('click', (e) => {
  e.stopPropagation(); // í—¤ë” í´ë¦­ì´ ì„¸íŠ¸ ì ìš©ìœ¼ë¡œ ë²ˆì§€ì§€ ì•Šê²Œ
  const list = state.autoSweep.armor;
  const name = set.name;
  const idx = list.indexOf(name);

  if (idx >= 0) {
    // ì„ íƒ í•´ì œ
    list.splice(idx, 1);
    autoBtn.classList.remove('is-selected');
  } else {
    // ì„ íƒ
    list.push(name);
    autoBtn.classList.add('is-selected');
  }
});

header.appendChild(autoBtn);
card.appendChild(header);


          const itemsRow = document.createElement('div');
          itemsRow.className = 'armor-set-items';

          set.pieces.forEach((piece) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'armor-set-item';
            btn.dataset.setType = set.type;
            btn.dataset.slot = piece.slot;
            btn.title = piece.name || '';

            const box = document.createElement('div');
            box.className = 'iconbox';

            const img = document.createElement('img');
            img.className = 'icon';
            img.src = piece.img || PLACEHOLDER_IMG;
            img.alt = piece.name || piece.slot || '';

            const badge = document.createElement('div');
            badge.className = 'badge-lv';
            badge.textContent = piece.level ? `Lv.${piece.level}` : '';

            box.appendChild(img);
            if (badge.textContent) box.appendChild(badge);
            btn.appendChild(box);
            itemsRow.appendChild(btn);
          });

          card.appendChild(itemsRow);
          $armorSetList.appendChild(card);
        });
      }

      function getArmorSetListForSweep() {
  let sets = window._armorSetCardsCache;
  if (!Array.isArray(sets)) {
    sets = buildArmorSetCardsFromSheets();
    window._armorSetCardsCache = sets;
  }
  return Array.isArray(sets) ? sets : [];
}

function getAccSetListForSweep() {
  let sets = window._accSetCardsCache;
  if (!Array.isArray(sets)) {
    sets = buildAccSetCardsFromSheets();
    window._accSetCardsCache = sets;
  }
  return Array.isArray(sets) ? sets : [];
}

function getSpecSetListForSweep() {
  let sets = window._specSetCardsCache;
  if (!Array.isArray(sets)) {
    sets = buildSpecSetCardsFromSheets();
    window._specSetCardsCache = sets;
  }
  return Array.isArray(sets) ? sets : [];
}

      // âœ… ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ ëª¨ë‹¬ ë Œë”ë§
      function renderAccSetModal() {
        if (!$accSetList) return;
        $accSetList.innerHTML = '';

        const sets = buildAccSetCardsFromSheets();
        if (!sets.length) {
          $accSetList.innerHTML =
            '<div class="empty-hint" style="padding:16px;font-size:13px;color:#ddd;">' +
            'ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ ì‹œíŠ¸(set:list) ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' +
            '</div>';
          return;
        }

        // í´ë¦­ìš© ìºì‹œ
        window._accSetCardsCache = sets;

        // ì²« ì¤„ ì„¸ ë²ˆì§¸ ì¹¸ ë¹„ìš°ëŠ” ìŠ¤í˜ì´ì„œ (ë°©ì–´êµ¬ì™€ ë™ì¼ íŒ¨í„´)
        sets.forEach((set, idx) => {
          if (idx === 2 && sets.length >= 3) {
            const spacer = document.createElement('div');
            spacer.className = 'armor-set-spacer';
            $accSetList.appendChild(spacer);
          }

          const card = document.createElement('div');
          card.className = 'armor-set-card';
          card.dataset.setType = set.type;
          card.dataset.setIndex = String(idx);

          const header = document.createElement('div');
header.className = 'armor-set-header';

const auto = state.autoSweep || (state.autoSweep = { armor: [], acc: [], spec: [], weapon: [], weaponCustom: [] });
const selected = auto.acc || [];
const isSelected = selected.includes(set.name);

const titleSpan = document.createElement('span');
titleSpan.className = 'armor-set-header-title';
titleSpan.textContent = set.name;
header.appendChild(titleSpan);

const autoBtn = document.createElement('button');
autoBtn.type = 'button';
autoBtn.className = 'set-auto-toggle';
if (isSelected) autoBtn.classList.add('is-selected');
autoBtn.textContent = 'ìë™ê³„ì‚° ëŒ€ìƒ';

autoBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  const list = state.autoSweep.acc;
  const name = set.name;
  const idx = list.indexOf(name);
  if (idx >= 0) {
    list.splice(idx, 1);
    autoBtn.classList.remove('is-selected');
  } else {
    list.push(name);
    autoBtn.classList.add('is-selected');
  }
});

header.appendChild(autoBtn);
card.appendChild(header);


          const itemsRow = document.createElement('div');
          itemsRow.className = 'armor-set-items';

          set.pieces.forEach((piece) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'armor-set-item';
            btn.dataset.setType = set.type;
            btn.dataset.slot = piece.slot;
            btn.title = piece.name || '';

            const box = document.createElement('div');
            box.className = 'iconbox';

            const img = document.createElement('img');
            img.className = 'icon';
            img.src = piece.img || PLACEHOLDER_IMG;
            img.alt = piece.name || piece.slot || '';

            const badge = document.createElement('div');
            badge.className = 'badge-lv';
            badge.textContent = piece.level ? `Lv.${piece.level}` : '';

            box.appendChild(img);
            if (badge.textContent) box.appendChild(badge);
            btn.appendChild(box);
            itemsRow.appendChild(btn);
          });

          card.appendChild(itemsRow);
          $accSetList.appendChild(card);
        });
      }

      function renderSpecSetModal() {
  if (!$specSetList) return;
  $specSetList.innerHTML = '';

  const sets = buildSpecSetCardsFromSheets();
  if (!sets.length) {
    $specSetList.innerHTML =
      '<div class="empty-hint" style="padding:16px;font-size:13px;color:#ddd;">' +
      'íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸ ì‹œíŠ¸(set:list) ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' +
      '</div>';
    return;
  }

  window._specSetCardsCache = sets;

  sets.forEach((set, idx) => {
    const card = document.createElement('div');
    card.className = 'armor-set-card';
    card.dataset.setType = set.type;
    card.dataset.setIndex = String(idx);

    const header = document.createElement('div');
header.className = 'armor-set-header';

const auto = state.autoSweep || (state.autoSweep = { armor: [], acc: [], spec: [], weapon: [], weaponCustom: [] });
const selected = auto.spec || [];
const isSelected = selected.includes(set.name);

const titleSpan = document.createElement('span');
titleSpan.className = 'armor-set-header-title';
titleSpan.textContent = set.name;
header.appendChild(titleSpan);

const autoBtn = document.createElement('button');
autoBtn.type = 'button';
autoBtn.className = 'set-auto-toggle';
if (isSelected) autoBtn.classList.add('is-selected');
autoBtn.textContent = 'ìë™ê³„ì‚° ëŒ€ìƒ';

autoBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  const list = state.autoSweep.spec;
  const name = set.name;
  const idx = list.indexOf(name);
  if (idx >= 0) {
    list.splice(idx, 1);
    autoBtn.classList.remove('is-selected');
  } else {
    list.push(name);
    autoBtn.classList.add('is-selected');
  }
});

header.appendChild(autoBtn);
card.appendChild(header);


    const itemsRow = document.createElement('div');
    itemsRow.className = 'armor-set-items';

    set.pieces.forEach((piece) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'armor-set-item';
      btn.dataset.setType = set.type;
      btn.dataset.slot = piece.slot;
      btn.title = piece.name || '';

      const box = document.createElement('div');
      box.className = 'iconbox';

      const img = document.createElement('img');
      img.className = 'icon';
      img.src = piece.img || PLACEHOLDER_IMG;
      img.alt = piece.name || piece.slot || '';

      const badge = document.createElement('div');
      badge.className = 'badge-lv';
      badge.textContent = piece.level ? `Lv.${piece.level}` : '';

      box.appendChild(img);
      if (badge.textContent) box.appendChild(badge);
      btn.appendChild(box);
      itemsRow.appendChild(btn);
    });

    card.appendChild(itemsRow);
    $specSetList.appendChild(card);
  });
}




      function openEnchantModalFor(slotKey) {
        state.currentSlotKey = slotKey;
        const typeKey = enchantTypeForSlot(slotKey);
        if (!typeKey) { alert('í•´ë‹¹ ìŠ¬ë¡¯ì˜ ë§ˆë²•ë¶€ì—¬ ì¢…ë¥˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
        renderEnchantList(typeKey);
        showModal($enchantModal, true);
      }

      async function renderEnchantList(typeKey) {
        const list = await loadEnchantOptions(typeKey);
        if (!list.length) {
          $enchantList.innerHTML = '<div style="color:#c7b589;">í•´ë‹¹ ë¶€ìœ„ì˜ ë§ˆë²•ë¶€ì—¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        // ìº¡ì…˜ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ(ìš”êµ¬ 5). ì´ë¦„ë§Œ ë²„íŠ¼ìœ¼ë¡œ.
        $enchantList.innerHTML = '';
        list.forEach(opt => {
          const btn = document.createElement('button');
          btn.className = 'enh-option';
          btn.type = 'button';
          btn.textContent = opt.name;
          btn.addEventListener('click', () => applyEnchantSelection(opt));
          $enchantList.appendChild(btn);
        });
      }

      // ê¸°ì¡´ ì„ ì–¸ì„ êµì²´
      // â˜… í•¨ìˆ˜ ì„ ì–¸ ìì²´ë¥¼ asyncë¡œ ë°”ê¾¼ë‹¤
      // â˜… ë§ˆë²•ë¶€ì—¬ ì„ íƒ ì ìš© (ì„œë²„ í˜¸ì¶œ ì—†ì´ stateë§Œ ê°±ì‹ )
      async function applyEnchantSelection(opt) {
        const slotCode = state.currentSlotKey;
        if (!slotCode) return;

        // UIì—ì„œ ì“°ëŠ” ì½”ë“œ(L1, R2, C2...) ê¸°ì¤€ìœ¼ë¡œ íƒ€ì… êµ¬í•¨
        const typeKey = enchantTypeForSlot(slotCode); // 'ë¬´ê¸°ë§ˆë¶€' ë“±
        if (!typeKey) {
          alert('í•´ë‹¹ ìŠ¬ë¡¯ì˜ ë§ˆë²•ë¶€ì—¬ ì¢…ë¥˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // 1) ë²„íŠ¼ ë¼ë²¨ ì¦‰ì‹œ ë°˜ì˜ (ê¸°ì¡´ DOM íƒìƒ‰ ê·¸ëŒ€ë¡œ ìœ ì§€)
        const rowEl = document.querySelector(`.slot-row .slot[data-slot="${slotCode}"]`)?.closest('.slot-row');
        if (rowEl) {
          const target = rowEl.querySelector('.outer-rects .rect[data-role="enchant"]')
            || rowEl.querySelector('.outer-rects .rect:nth-child(3)');
          if (target) target.textContent = opt.name;
        } else {
          const cellEl = document.querySelector(`.mini-cell .slot.mini[data-slot="${slotCode}"]`)?.closest('.mini-cell');
          if (cellEl) {
            const target = cellEl.querySelector('.outer-rects .rect[data-role="enchant"]')
              || cellEl.querySelector('.outer-rects .rect:nth-child(1)');
            if (target) target.textContent = opt.name;
          }
        }

        // 2) ë¡œì»¬ ìƒíƒœ ê°±ì‹  (â˜… calc_allì—ì„œ í•œ ë²ˆì— ë³´ë‚¼ ê°’)
        window.state = window.state || {};
        state.enchants ||= {};

        // payloadì—ì„œëŠ” ì„œë²„ ìŠ¬ë¡¯í‚¤(weapon, top, ...)ë¥¼ ì“°ê³  ì‹¶ìœ¼ë‹ˆ ì—¬ê¸°ì„œ ì •ê·œí™”
        const serverSlot = (typeof slotCodeToServerSlot === 'function')
          ? slotCodeToServerSlot(slotCode)
          : slotCode;

        state.enchants[serverSlot] = {
          name: opt.name,
          typeKey,               // 'ë¬´ê¸°ë§ˆë¶€', 'ë¨¸ë¦¬ì–´ê¹¨ë§ˆë¶€' ë“±
          stats: opt.stats || null,
          raw: opt.raw || null,
        };

        // 3) ëª¨ë‹¬ ë‹«ê¸° (ì‹¤ì œ ìŠ¤íƒ¯ ë°˜ì˜ì€ calc_all + computeViaBackendì—ì„œ ì²˜ë¦¬)
        showModal($enchantModal, false);
        // ì—¬ê¸°ì„œëŠ” recalcAndRenderPanel / sum_stats ì•ˆ ë¶€ë¦„
      }



      // ë²„íŠ¼ ë¼ë²¨ë§Œ ë°”ê¾¸ëŠ” ìœ í‹¸ (ê¸°ì¡´ DOM íƒìƒ‰ ì½”ë“œ ì¬ì‚¬ìš©)
      function updateEnchantLabel(slotKey, name) {
        const row = document.querySelector(`.slot-row .slot[data-slot="${slotKey}"]`)?.closest('.slot-row');
        if (row) {
          const target = row.querySelector('.outer-rects .rect[data-role="enchant"]')
            || row.querySelector('.outer-rects .rect:nth-child(3)');
          if (target) target.textContent = name;
        } else {
          const cell = document.querySelector(`.mini-cell .slot.mini[data-slot="${slotKey}"]`)?.closest('.mini-cell');
          if (cell) {
            const target = cell.querySelector('.outer-rects .rect[data-role="enchant"]')
              || cell.querySelector('.outer-rects .rect:nth-child(1)');
            if (target) target.textContent = name;
          }
        }
      }



      // ê³µìš© ëª¨ë‹¬ show/hide ìœ í‹¸(íŒŒì¼ ë‚´ ë‹¤ë¥¸ ëª¨ë‹¬ê³¼ ë™ì¼ ë°©ì‹ ì‚¬ìš©)
      function showModal(modal, on) {
        if (!modal) return;
        if (on) { modal.classList.add('show'); modal.setAttribute('aria-hidden', 'false'); }
        else { modal.classList.remove('show'); modal.setAttribute('aria-hidden', 'true'); }
      }

            // ğŸ”¹ ê³µì§€ ëª¨ë‹¬ (ì½°íŠ¸ë¡œ ì•ˆë‚´ ë“±)
      const $noticeModal = document.getElementById('noticeModal');
      if ($noticeModal) {
        $noticeModal.querySelectorAll('[data-close]').forEach(el => {
          el.addEventListener('click', () => showModal($noticeModal, false));
        });
      }

      // âœ… íƒˆí‡´ ì•ˆë‚´ ëª¨ë‹¬ ë‹«ê¸°
const $withdrawModal = document.getElementById('withdrawModal');
if ($withdrawModal) {
  $withdrawModal.querySelectorAll('[data-close]').forEach(el => {
    el.addEventListener('click', () => showModal($withdrawModal, false));
  });
}

// âœ… íƒˆí‡´ ì•ˆë‚´ë¥¼ "í•œ ë²ˆë§Œ" ë„ìš°ëŠ” ì „ì—­ í•¨ìˆ˜
window.showWithdrawNoticeOnce = function (msg) {
  const modal = document.getElementById('withdrawModal');
  const box = document.getElementById('withdrawModalMsg');
  if (!modal || !box) return;

  if (window.__withdrawNoticeShown) return;
  window.__withdrawNoticeShown = true;

  box.textContent = String(msg || 'í•´ë‹¹ ê³„ì •ì€ íƒˆí‡´ ì²˜ë¦¬ëœ ê³„ì •ì…ë‹ˆë‹¤.').trim();
  showModal(modal, true);
};


      // PC ê³„ì‚°ê¸° ë¡œë”© í›„ ê³µì§€ ëª¨ë‹¬ì„ ë„ìš°ëŠ” ì „ì—­ í•¨ìˆ˜
      window.showQuatroNoticeOnce = function () {
        const modal = document.getElementById('noticeModal');
        if (!modal) return;
        showModal(modal, true);
      };


      // âœ… ë°©ì–´êµ¬ ì„¸íŠ¸ ëª¨ë‹¬ ë‹«ê¸° (ë’¤ ë°°ê²½ + ë‹«ê¸° ë²„íŠ¼)
$armorSetModal?.querySelectorAll('[data-close]').forEach(el => {
  el.addEventListener('click', () => showModal($armorSetModal, false));
});

// âœ… ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
$accSetModal?.querySelectorAll('[data-close]').forEach(el => {
  el.addEventListener('click', () => showModal($accSetModal, false));
});

// âœ… íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
$specSetModal?.querySelectorAll('[data-close]').forEach(el => {
  el.addEventListener('click', () => showModal($specSetModal, false));
});

// âœ… ê³ ìœ íš¨ê³¼ ì¼ê´„ ì ìš© ëª¨ë‹¬ ë‹«ê¸°
$uniqueEffectModal?.querySelectorAll('[data-close]').forEach(el => {
  el.addEventListener('click', () => showModal($uniqueEffectModal, false));
});


      /* ğŸ”¹ íŒ¨ì¹˜ë‚´ì—­ ì „ì²´ë³´ê¸° ëª¨ë‹¬ */
      const $patchLogModal = document.getElementById('patchLogModal');
      const $btnPatchLog = document.getElementById('btnPatchLog');

      if ($patchLogModal) {
        // ë‹«ê¸° (ë°°ê²½/ë²„íŠ¼ ëª¨ë‘ data-close ë‹¬ì•„ë‘ )
        $patchLogModal.querySelectorAll('[data-close]').forEach(el => {
          el.addEventListener('click', () => showModal($patchLogModal, false));
        });
      }

      if ($btnPatchLog && $patchLogModal) {
        $btnPatchLog.addEventListener('click', () => {
          showModal($patchLogModal, true);
        });
      }

      /* ê¸°ì¡´ ENCHANT ëª¨ë‹¬ ì½”ë“œ */
      $enchantModal?.querySelector('.backdrop[data-close]')?.addEventListener('click', () => showModal($enchantModal, false));


      // === [ENCHANT] 4) ì„¸ ë²ˆì§¸ ì„¸ë¶€ìƒì í´ë¦­ ì‹œ ëª¨ë‹¬ ===
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.rect');
        if (!btn) return;

        // 3ë²ˆì§¸ ë²„íŠ¼ë§Œ ì²˜ë¦¬ (dataset.role='enchant'ëŠ” Aë‹¨ê³„ì—ì„œ ë¶€ì—¬)
        if (btn.dataset.role === 'enchant') {
          // â˜… slot-row ë˜ëŠ” mini-cell(í•˜ë‹¨ C1~C4 ì˜ì—­) ëª¨ë‘ ì§€ì›
          const container = btn.closest('.slot-row, .mini-cell, .mini-bar');
          const slotKey = container?.querySelector('.slot')?.getAttribute('data-slot');
          if (!slotKey) return;
          openEnchantModalFor(slotKey);
        }
      });

      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.rect');
        if (!btn) return;

        // [REFINE] 4ë²ˆì§¸ ë²„íŠ¼
        if (btn.dataset.role === 'refine') {
          const container = btn.closest('.slot-row, .mini-cell');
          const slotCode = container?.querySelector('.slot')?.getAttribute('data-slot'); // R1/R5
          if (!slotCode) return;

          // 1ë‹¨ê³„: ë¬´ê¸°(R1)ë§Œ ë¨¼ì € ë™ì‘. R5ëŠ” ì¶”í›„ ì ìš©.
          if (slotCode === 'R1') {
            openRefineModalForWeapon(btn);
          } else if (slotCode === 'R5') {
            openRefineModalForSub(btn);   // â˜… ìƒˆë¡œìš´ í•¨ìˆ˜ë¡œ ì—°ê²°
          }
        }
      });


      const $refineModal = document.getElementById('refineModal');
      const $refineList = document.getElementById('refineList');

      function showRefineModal(on) {
        if (!$refineModal) return;
        if (on) { $refineModal.classList.add('show'); $refineModal.setAttribute('aria-hidden', 'false'); }
        else { $refineModal.classList.remove('show'); $refineModal.setAttribute('aria-hidden', 'true'); }
      }
      $refineModal?.addEventListener('click', (e) => {
        if (e.target.dataset.close != null || e.target.classList.contains('backdrop')) {
          showRefineModal(false);
        }
      });

      async function openRefineModalForWeapon(btnEl) {    //ë¬´ê¸°ì—°ë§ˆ
        if (typeof ensureEnhLoaded === 'function') await ensureEnhLoaded();

        // ë²„íŠ¼ ëª©ë¡ ë§Œë“¤ê¸°
        const labels = ['ì—°ë§ˆì—†ìŒ', '1ì—°ë§ˆ', '2ì—°ë§ˆ', '3ì—°ë§ˆ', '4ì—°ë§ˆ', '5ì—°ë§ˆ', '6ì—°ë§ˆ', '7ì—°ë§ˆ', '8ì—°ë§ˆ', '9ì—°ë§ˆ'];
        $refineList.innerHTML = '';
        labels.forEach(name => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'opt-btnetc';    // ë„¤ ë²„íŠ¼ ê·œì¹™ì— ë§ì¶° block í‘œì‹œ
          b.textContent = name;
          b.addEventListener('click', () => applyWeaponRefine(name, btnEl));
          $refineList.appendChild(b);
        });

        showRefineModal(true);
      }

      async function openRefineModalForSub(btnEl) {     //ë³´ì¥ì—°ë§ˆ
        if (typeof ensureEnhLoaded === 'function') await ensureEnhLoaded();

        const labels = ['ì—°ë§ˆì—†ìŒ', '1ì—°ë§ˆ', '2ì—°ë§ˆ', '3ì—°ë§ˆ', '4ì—°ë§ˆ', '5ì—°ë§ˆ', '6ì—°ë§ˆ', '7ì—°ë§ˆ', '8ì—°ë§ˆ', '9ì—°ë§ˆ'];
        $refineList.innerHTML = '';
        labels.forEach(name => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'opt-btnetc';
          b.textContent = name;
          b.addEventListener('click', () => applySubRefine(name, btnEl));
          $refineList.appendChild(b);
        });

        showRefineModal(true);
      }


      // ë¬´ê¸° ì—°ë§ˆ ì ìš© (ì„œë²„ í˜¸ì¶œ X, state.refinesë§Œ ê°±ì‹ )
      async function applyWeaponRefine(name, btnEl) {
        window.state = window.state || {};
        state.refines = state.refines || {};

        const refineType = 'ë¬´ê¸°ì—°ë§ˆ';
        const slotKey = 'weapon';

        if (name === 'ì—°ë§ˆì—†ìŒ') {
          // ì—°ë§ˆ í•´ì œ
          delete state.refines[slotKey];
        } else {
          // ìŠ¤ëƒ…ìƒ· ì •ë³´ë§Œ ì €ì¥ (ì‹¤ì œ ìŠ¤íƒ¯ ê³„ì‚°ì€ ë°±ì—”ë“œ calc_allì—ì„œ)
          state.refines[slotKey] = {
            name,
            refineType,
          };
        }

        if (btnEl) {
          btnEl.textContent = name;
        }

        // ëª¨ë‹¬ ë‹«ê¸° (í•©ì‚°/ë”œê³„ì‚°ì€ calc_all + computeë¡œë§Œ)
        showRefineModal(false);
      }

      // ë³´ì¡°ì¥ë¹„ ì—°ë§ˆ ì ìš© (ì„œë²„ í˜¸ì¶œ X, state.refinesë§Œ ê°±ì‹ )
      async function applySubRefine(name, btnEl) {
        window.state = window.state || {};
        state.refines = state.refines || {};

        const refineType = 'ë³´ì¥ì—°ë§ˆ';
        const slotKey = 'sub';

        if (name === 'ì—°ë§ˆì—†ìŒ') {
          // ì—°ë§ˆ í•´ì œ
          delete state.refines[slotKey];
        } else {
          state.refines[slotKey] = {
            name,
            refineType,
          };
        }

        if (btnEl) {
          btnEl.textContent = name;
        }

        showRefineModal(false);
      }





      function _setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = String(v); }

      function renderSpTp() {
        const sp = state.sp || {};
        const tp = state.tp || {};
        const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = String(v); };
        // Top header (if visible)
        set('spLeftTop', sp.left ?? 0);
        set('tpLeftTop', tp.left ?? 0);
        // Modal right-top mini counters
        set('stSpLeftMini', sp.left ?? 0);
        set('stTpLeftMini', tp.left ?? 0);
        // Any small counters near the button (outside modal)
        set('stSpLeft', sp.left ?? 0);
        set('stTpLeft', tp.left ?? 0);
        // Used/Total for detailed displays
        set('stSpUsed', (sp.total ?? 0) - (sp.left ?? 0));
        set('stSpTotal', sp.total ?? 0);
        set('stTpUsed', (tp.total ?? 0) - (tp.left ?? 0));
        set('stTpTotal', tp.total ?? 0);
      }

      function setTotals(spTotal, tpTotal) {
        const spt = Number(spTotal || 0), tpt = Number(tpTotal || 0);
        state.sp.total = spt;
        state.sp.left = spt;
        state.tp.total = tpt; state.tp.left = tpt;
        renderSpTp();
      }

      function canSpendSp(cost) { return (state.sp.left ?? 0) >= (Number(cost) || 0); }
      function spendSp(cost) { state.sp.left = Math.max(0, (state.sp.left ?? 0) - (Number(cost) || 0)); renderSpTp(); }
      function refundSp(cost) { state.sp.left = Math.min((state.sp.total ?? 0), (state.sp.left ?? 0) + (Number(cost) || 0)); renderSpTp(); }
      function canSpendTp(cost) { return (state.tp.left ?? 0) >= (Number(cost) || 0); }
      function spendTp(cost) { state.tp.left = Math.max(0, (state.tp.left ?? 0) - (Number(cost) || 0)); renderSpTp(); }
      function refundTp(cost) { state.tp.left = Math.min((state.tp.total ?? 0), (state.tp.left ?? 0) + (Number(cost) || 0)); renderSpTp(); }
      function noSpFeedback() { alert('SPê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'); }
      function noTpFeedback() { alert('TPê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'); }


      /* ===== ìŠ¤í‚¬ ì‹œíŠ¸ ë¡œë” & ê²Œì„í˜•(ê°€ë¡œ ì¹¼ëŸ¼) ë Œë”ëŸ¬ ===== */
      // CSV -> JSON ì „í™˜: ST2.rows ë¥¼ JSON ì‘ë‹µìœ¼ë¡œ ì±„ì›€
      async function loadSkillSheet() {
        if (DBSkill.loaded) return;

        const token = await waitForIdToken();

        const r = await fetch(window.WEBAPP_URL + '?type=skill', {
          method: 'POST',
          mode: 'cors',
          cache: 'no-store',
          headers: { 'Content-Type': 'text/plain' },
          body: token
        });
        if (!r.ok) throw new Error('skill_fetch_failed');
        const data = await r.json();
        if (!data.ok || !Array.isArray(data.rows)) throw new Error('bad_skill_payload');

        // ê·¸ëŒ€ë¡œ ë³´ê´€ (CSV header:true ê²°ê³¼ì™€ ë™ì¼í•œ êµ¬ì¡°)
        DBSkill.headers = Array.isArray(data.headers) ? data.headers : [];
        DBSkill.rows = data.rows;

        // ë„¤ê°€ ê¸°ì¡´ì— ì“°ë˜ ì „ì—­ í•¸ë“¤(ST2)ì„ ìœ ì§€í•˜ê³  ì‹¶ë‹¤ë©´:
        window.ST2 = { rows: DBSkill.rows, headers: DBSkill.headers };

        DBSkill.loaded = true;
      }


      const onSkillTreeChanged = (() => {
        let dirty = false;
        return () => { dirty = true; };  // ìŠ¤í‚¬ ìƒíƒœê°€ ë°”ë€Œì—ˆë‹¤ëŠ” í‘œì‹œë§Œ
      })();

      const ST_BANDS = [10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 65, 70, 75, 80];
      const DBSkills = { loaded: false, rows: [] };

      function parseNumber(v) {
        if (v == null) return 0;
        const m = String(v).match(/-?\d+(\.\d+)?/);
        return m ? Number(m[0]) : 0;
      }
      function bandOf(v) {
        const n = parseNumber(v);
        if (!n) return 'ê¸°ë³¸';
        let best = ST_BANDS[0], dmin = 1e9;
        for (const b of ST_BANDS) { const d = Math.abs(n - b); if (d < dmin) { dmin = d; best = b; } }
        return best;
      }

      function skillsForCurrentChar(rows) {
        const key = (state.currentCharacter?.jobGroupLabel || '') + (state.currentCharacter?.name || '');
        const want = key.replace(/\s+/g, '');
        if (!want) return rows;
        const fil = rows.filter(s => !s.ownerKey || s.ownerKey === want);
        return fil.length ? fil : rows;
      }

      /* 25.09.20 ìŠ¤í‚¬íŠ¸ë¦¬ ì¶”ê°€S */
      /* ===== SkillTree v2: ë¡œë”/í•„í„°/ë Œë” ===== */
      /** ìºì‹œ */
      const ST2 = { loaded: false, rows: [] };
      /** ìœ í‹¸: ì•ˆì „ ìˆ«ì */
      const toInt = (v, def = 0) => {
        const n = Number(String(v || '').trim()); return Number.isFinite(n) ? n : def;
      };
      /** ì‹œíŠ¸ â†’ í‘œì¤€ ìŠ¤í‚¬ ê°ì²´ ë§¤í•‘ */
      // êµì²´í•  í•¨ìˆ˜
      function mapRowToSkill2(r) {        // ì‹œíŠ¸ ì»¬ëŸ¼ë“¤ì„ ì½ìŠµë‹ˆë‹¤. who = ìºë¦­í„°ëª…, show = ë…¸ì¶œì—¬ë¶€, ...
        // 1) ìºë¦­í„° í‚¤(ì‹œíŠ¸ 'ìºë¦­í„°ëª…'ê³¼ ì •í™•íˆ ì¼ì¹˜, ê³µë°± ì œê±°)
        const who = String(r['ìºë¦­í„°ëª…'] || '').replace(/\s+/g, '');
        // 2) ë…¸ì¶œ/ì •ë ¬/ì¢Œí‘œ
        const show = Number(String(r['ë…¸ì¶œì—¬ë¶€'] || '').trim()) === 1;
        const level = Number(String(r['ìŠ¤í‚¬ë ™ì œ'] || '').trim()) || 0;
        const x = Math.min(6, Math.max(1, Number(String(r['ê°€ë¡œìœ„ì¹˜'] || '').trim()) || 1));
        const y = Math.max(1, Number(String(r['ì„¸ë¡œìœ„ì¹˜'] || '').trim()) || 1);
        const cd = toNum(r['ì¿¨íƒ€ì„']);
        const castFrames = toNum(r['ì‹œì „í”„ë ˆì„']);
        // â˜… ì¶”ê°€: êµ¬ë¶„(í‰íƒ€/ì—°ê²°í‰íƒ€/ìŠ¤í‚¬/ê°ì„±ê¸°)
        const rawKind = String(r['êµ¬ë¶„'] || '').trim();
        // ê¸°ë³¸ê°’ì€ 'ìŠ¤í‚¬' (ì‹œíŠ¸ì—ì„œ ë¹„ì›Œë‘ë©´ ìŠ¤í‚¬ë¡œ ì·¨ê¸‰)
        const kind = rawKind || 'ìŠ¤í‚¬';
        // 3) í•µì‹¬ í•„ë“œ(ìŠ¤í™: ìŠ¤í‚¬ëª…/ì´ë¯¸ì§€ ì‚¬ìš©)
        const name = String(r['ìŠ¤í‚¬ëª…'] || '').trim();
        const img = cleanUrl(r['ì´ë¯¸ì§€'] || '') || PLACEHOLDER_IMG;
        // 4) ìµœì†Œ/ìµœëŒ€ ìŠ¤í‚¬ ë ˆë²¨
        const minLv = Math.max(0, Number(String(r['ìµœì†ŒìŠ¤í‚¬ë ˆë²¨'] || '').trim()) || 0);
        const maxLv = Math.max(minLv, Number(String(r['ìµœëŒ€ìŠ¤í‚¬ë ˆë²¨'] || '').trim()) || minLv); // ìµœì†Œë³´ë‹¤ ì‘ì§€ ì•Šê²Œ

        // 5) ID(ì—†ìœ¼ë©´ ìŠ¤í‚¬ëª… ê¸°ë°˜ ëŒ€ì²´)
        const idSrc = String(r['ID'] ?? r['id'] ?? name).trim();
        const id = idSrc || ('SK_' + Math.random().toString(36).slice(2));

        // 6) SP/TP ì½”ìŠ¤íŠ¸
        const sp = toInt(r['ì†Œëª¨ SP'] ?? r['ì†Œëª¨SP'] ?? r['SP'] ?? r['sp'] ?? 0, 0);
        const tpCost = toInt(r['tpì„¤ì •'] ?? r['TPì„¤ì •'] ?? r['tp ì„¤ì •'] ?? r['TP ì„¤ì •'] ?? r['tp'] ?? r['TP'] ?? 0, 0);

        // 7) â˜… í¼ë€/ê³ ë€ ì„ í˜• ëª¨ë¸(ì‹œíŠ¸ ì»¬ëŸ¼ ê·¸ëŒ€ë¡œ)
        //    - '1ë ™ë°ë¯¸ì§€'   : minLv ê¸°ì¤€ í¼ë€
        //    - '1ë ™ê³ ì •ë€'   : minLv ê¸°ì¤€ ê³ ë€
        //    - '1ë ™ë‹¹ ë°ë¯¸ì§€': ë ˆë²¨ +1ë‹¹ í¼ë€ ì¦ê°€ì¹˜
        //    - '1ë ™ë‹¹ ê³ ì •ë€': ë ˆë²¨ +1ë‹¹ ê³ ë€ ì¦ê°€ì¹˜
        const dmg1Base = toNum(r['1ë ™ë°ë¯¸ì§€'], NaN);
        const fix1Base = toNum(r['1ë ™ê³ ì •ë€'], NaN);
        const dmg1PerLv = toNum(r['1ë ™ë‹¹ ë°ë¯¸ì§€'], NaN);
        const fix1PerLv = toNum(r['1ë ™ë‹¹ ê³ ì •ë€'], NaN);

        return {
          id, name, img, who, show, level, x, y, minLv, maxLv, sp, tpCost,
          // â˜… ì¶”ê°€ëœ 4ê°œ í•„ë“œ
          dmg1Base, fix1Base, dmg1PerLv, fix1PerLv, band: level, levelGate: level, cd,             // â˜… ì¶”ê°€: ê³„ì‚°ì—ì„œ ë°”ë¡œ ì“°ë„ë¡
          cooldown: cd,
          castFrames,    // â˜… í˜¸í™˜ìš© í‚¤
          kind
        };
      }




      /** í˜„ì¬ ìºë¦­í„° í‚¤ ì–»ê¸° (ë‚¨ê·€ê²€ì‚¬+ì´ë¦„) */
      function currentCharKey() {
        const k = currentSkillOwnerKey?.() || '';      // ì´ë¯¸ ì½”ë“œì— ìˆëŠ” í•¨ìˆ˜ ì¬í™œìš©
        return String(k).replace(/\s+/g, '') || null;
      }

      /* ===== TP ë²”ìœ„ & ìƒíƒœ ===== */
      const TP_MIN = 0, TP_MAX = 5;
      state.skillTpLv = state.skillTpLv || {}; // { skillId: tpLevel }

      /* ===== ìŠ¤í‚¬ ë°ë¯¸ì§€ ìœ í‹¸(ì„ í˜• + TP ë°°ìœ¨) ===== */
      // 0) (ì—†ìœ¼ë©´ ì¶”ê°€) í˜„ì¬ ë°ë¯¸ì§€ ìºì‹œ
      state.skillDmg = state.skillDmg || {};   // { skillId: {per, flat, lv, tpLv, tpIncPercent} }

      // 1) (ì—†ìœ¼ë©´ ì¶”ê°€) ì„ í˜• í¼ë€/ê³ ë€ ê³„ì‚°
      function calcSkillDamageLinear(skill, lv) {
        // 0ê³¼ null/undefined ë¥¼ êµ¬ë¶„: 0ì€ ìœ íš¨ ë ˆë²¨
        const maxLv = Number(skill.maxLv ?? 0);
        const rawLv = Number(lv ?? 0);

        // 1) ë ˆë²¨ í•˜í•œì€ 0ìœ¼ë¡œ í´ë¨í”„ (0ë ˆë²¨ í—ˆìš©)
        // âœ… ê³„ì‚°ìƒ ìƒí•œ ì œê±°
        const curLv = Math.max(0, rawLv);

        // 2) 0ë ˆë²¨ì´ë©´ ë°ë¯¸ì§€ 0 í™•ì •
        if (curLv === 0) return { per: 0, flat: 0, lv: 0 };

        // 3) '1ë ™ë°ë¯¸ì§€'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„ í˜• ì¦ê°€
        //    stepì€ í•­ìƒ (í˜„ì¬ë ˆë²¨ - 1)
        const dmg1Base = Number.isFinite(skill.dmg1Base) ? skill.dmg1Base : 0;
        const fix1Base = Number.isFinite(skill.fix1Base) ? skill.fix1Base : 0;
        const dmg1PerLv = Number.isFinite(skill.dmg1PerLv) ? skill.dmg1PerLv : 0;
        const fix1PerLv = Number.isFinite(skill.fix1PerLv) ? skill.fix1PerLv : 0;

        const step = curLv - 1; // â˜… 1ë ™ ê¸°ì¤€
        const per = dmg1Base + dmg1PerLv * step;  // í¼ë€
        const flat = fix1Base + fix1PerLv * step;  // ê³ ë€

        return { per, flat, lv: curLv };
      }

      // 2) ì™¸ë¶€(ì•„ì´í…œ/ë£¬ ë“±) TP ë³´ë„ˆìŠ¤ í•©ì‚° â€“ ì´ˆê¸°ëŠ” 0ìœ¼ë¡œ ë‘ê³  ë‚˜ì¤‘ì— êµ¬í˜„
      // TP ì¶”ê°€ ë³´ì •ì¹˜(ê¸°êµë£¬ ë“±)
      function getTpBonusFromSources(skillId) {
        // â‘  ì‚¬ìš©ìê°€ ì°ì€ 'ê¸°ë³¸ TP'ê°€ 0ì´ë©´ â†’ ê¸°êµë£¬ ë³´ë„ˆìŠ¤ ì°¨ë‹¨
        const baseUiTp = Number(state.skillTpLv?.[skillId] ?? 0);
        if (!(baseUiTp > 0)) return 0;

        // â‘¡ ê¸°êµë£¬(+TP) í•©ì‚°
        const s = (ST2?.rows || []).find(r => r.id === skillId);
        if (!s) return 0;
        const { enhLvAdd } = runeLevelAdds(s); // ê¸°êµë£¬ ìˆ˜ëŸ‰
        return Number(enhLvAdd || 0);
      }

      // 3) tpì„¤ì •(1/2)ì— ë”°ë¥¸ TP ì¦ê°€ìœ¨(%) ê³„ì‚° (ìµœëŒ€ 7ë ˆë²¨)
      function tpIncreasePercent(tpSetting, tpLevel) {
        const lv = Math.max(0, Math.min(7, Number(tpLevel) || 0));
        if (lv === 0 || !Number.isFinite(tpSetting) || tpSetting <= 0) return 0;

        if (tpSetting === 1) return 5 + (lv - 1) * 2; // 1ë ˆë²¨ 5%, ì´í›„ +2%
        if (tpSetting === 2) return 8 + (lv - 1) * 3; // 1ë ˆë²¨ 8%, ì´í›„ +3%
        return 0;
      }

      // 4) ì„ í˜• ë°ë¯¸ì§€ì— TP ë¹„ìœ¨ì„ ê³±í•´ ìµœì¢…ì¹˜ ì‚°ì¶œ

      /* ===== ê¸¸ê²Œëˆ„ë¥´ê¸°(ë¯¼ê° ì™„í™”): pointer ì´ë²¤íŠ¸ ê¸°ë°˜ ===== */
      function attachPressRepeat(btn, stepFn) {
        let timer = null, active = false, interval = 180;
        const start = (e) => {
          e.preventDefault();
          if (btn.disabled) return;
          active = true;
          stepFn(); // ì²« ëˆŒë¦¼ ì¦‰ì‹œ 1íšŒ
          let firstDelay = 500; // ì´ˆê¸° ì§€ì—°
          timer = setTimeout(function kick() {
            if (!active) return;
            stepFn();
            interval = Math.max(120, interval);     // ìµœì†Œ 120ms
            timer = setTimeout(kick, interval);
          }, firstDelay);
        };
        const stop = () => {
          active = false;
          if (timer) { clearTimeout(timer); timer = null; interval = 180; }
        };

        // pointer ê³„ì—´ë§Œ ì‚¬ìš©í•´ ì¤‘ë³µ ì´ë²¤íŠ¸ ë°©ì§€
        btn.addEventListener('pointerdown', start);
        ['pointerup', 'pointerleave', 'pointercancel', 'blur'].forEach(ev => btn.addEventListener(ev, stop));
        window.addEventListener('pointerup', stop);
      }

      /* ===== ë Œë”ëŸ¬ êµì²´ ===== */
      async function renderSkillTreeBands() {
        const wrap = document.getElementById('stGrid');
        wrap.className = 'st2-wrap';
        wrap.innerHTML = '';


        // (1) ownerKey ê²°ì •: ìš°ì„  í”„ë¡ íŠ¸ í˜„ì¬ ìºë¦­í„° â†’ ì—†ìœ¼ë©´ í•©ì‚° ê²°ê³¼
        let ownerKey = '';

        const cc = state.currentCharacter || {};
        const job = (cc.jobGroupLabel || cc.jobGroup || '').trim();
        const nm = (cc.name || '').trim();
        if (job || nm) {
          // ì˜ˆ: 'ë‚¨ê·€ê²€ì‚¬ ì†Œìš¸ë¸Œë§ì–´' â†’ 'ë‚¨ê·€ê²€ì‚¬ì†Œìš¸ë¸Œë§ì–´'
          ownerKey = (job + nm).replace(/\s+/g, '');
        }

        if (!ownerKey) {
          ownerKey = String(state?.CurrentSumStats?.ownerKey || '').trim();
        }

        // ì•„ì§ë„ ì—†ìœ¼ë©´: ìºë¦­í„° ì•„ì˜ˆ ì„ íƒ ì•ˆ ëœ ìƒíƒœ
        if (!ownerKey) {
          wrap.innerHTML = `<div style="color:#c7b589; padding:8px;">ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.</div>`;
          ST2.rows = [];
          ST2.loaded = false;
          return;
        }

        // (2) CORE.lists['skill:list'] ë¶ˆëŸ¬ì˜¤ê¸°
        const src = CORE?.lists?.['skill:list'] || [];
        if (!Array.isArray(src) || src.length === 0) {
          wrap.innerHTML = `<div style="color:#c7b589; padding:8px;">ìŠ¤í‚¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
          ST2.rows = [];
          ST2.loaded = false;
          return;
        }

        // (2-1) í˜„ì¬ ì°©ìš© ë¬´ê¸° ì¢…ë¥˜ (ë³´ìš°ê±´ / ë¨¸ìŠ¤ì¼“ ë“±)
        const weaponTypeRaw = state?.selections?.weapon?.type || '';
        const weaponType = String(weaponTypeRaw).trim();

        // (3) ownerKey + ë…¸ì¶œì—¬ë¶€ + (ë¬´ê¸°ì¢…ë¥˜) í•„í„°ë§ í›„ ë§¤í•‘
        const list = src
          .filter(r => {
            const charKey = String(r.charName || '').replace(/\s+/g, '');
            const visible = String(r.show || '').trim() === '1';
            if (charKey !== ownerKey || !visible) return false;

            // â˜… ì¶”ê°€: ë¬´ê¸°ì¢…ë¥˜ í•„í„°
            //  - weaponKind ë¹„ì–´ ìˆìœ¼ë©´ â†’ ëª¨ë“  ë¬´ê¸°ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš© (ê·¸ëŒ€ë¡œ ë…¸ì¶œ)
            //  - weaponKindê°€ ìˆìœ¼ë©´ â†’ í˜„ì¬ ë¬´ê¸° ì¢…ë¥˜ì™€ ì¼ì¹˜í•  ë•Œë§Œ ë…¸ì¶œ
            const rowWeapon = String(r.weaponKind || '').trim();

            // ê³µí†µ ìŠ¤í‚¬(ë¬´ê¸°ì¢…ë¥˜ ê³µë€)ì€ í•­ìƒ í‘œì‹œ
            if (!rowWeapon) return true;

            // ì•„ì§ ë¬´ê¸°ë¥¼ ì•ˆ ê³¨ëë‹¤ë©´ ì¼ë‹¨ ë‹¤ ë³´ì—¬ì¤€ë‹¤ (ì›ë˜ì²˜ëŸ¼)
            if (!weaponType) return true;

            // ë¬´ê¸°ì¢…ë¥˜ê°€ ì§€ì •ëœ ìŠ¤í‚¬ì€ í˜„ì¬ ë¬´ê¸°ì¢…ë¥˜ì™€ ì¼ì¹˜í•˜ëŠ” ê²ƒë§Œ
            return rowWeapon === weaponType;
          })
          .map((r, idx) => ({
            id: 'SK_' + idx + '_' + (r.name || ''),
            name: r.name || '',
            img: r.image || '',
            who: ownerKey,
            show: true,
            level: Number(r.reqLevel || 0),      // ìŠ¤í‚¬ë ™ì œ
            x: Math.min(6, Math.max(1, Number(r.x || 1))),
            y: Math.max(1, Number(r.y || 1)),
            minLv: Number(r.minLevel || 0),
            maxLv: Number(r.maxLevel || 0),
            sp: Number(r.costSP || 0),
            tpCost: Number(r.tp || 0),
          }));


        // (4) ST2 ì „ì—­ì— ë°˜ì˜
        ST2.rows = list;
        ST2.loaded = true;

        if (!list.length) {
          wrap.innerHTML = `<div style="color:#c7b589; padding:8px;">í•´ë‹¹ ìºë¦­í„°ì˜ ìŠ¤í‚¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          return;
        }

        // (4) ì¢Œí‘œ ë° ë°´ë“œ ê³„ì‚°
        list.forEach(s => {
          s.x = Math.min(6, Math.max(1, Number(s.x || 1)));
          s.y = Math.max(1, Number(s.y || 1));
        });
        const levels = [...new Set(list.map(s => Number(s.level || 0)))].sort((a, b) => a - b);

        // (5) SP/TP ìƒíƒœ ë³´ì •
        state.sp = state.sp || { total: 0, left: 0 };
        state.tp = state.tp || { total: 0, left: 0 };
        state.skillLv = state.skillLv || {};
        state.skillTpLv = state.skillTpLv || {};

        const TP_MIN = 0, TP_MAX = 5;
        const canSpendSp = need => (state.sp.left || 0) >= need;
        const canSpendTp = need => (state.tp.left || 0) >= need;
        const spendSp = v => {
          state.sp.left = Math.max(0, (state.sp.left || 0) - v); renderSpTp();
          onSkillTreeChanged();
        };
        const refundSp = v => {
          state.sp.left = Math.min(state.sp.total || 0, (state.sp.left || 0) + v); renderSpTp();
          onSkillTreeChanged();
        };
        const spendTp = v => {
          state.tp.left = Math.max(0, (state.tp.left || 0) - v); renderSpTp();
          onSkillTreeChanged();

        };
        const refundTp = v => {
          state.tp.left = Math.min(state.tp.total || 0, (state.tp.left || 0) + v); renderSpTp();
          onSkillTreeChanged();
        };

        const clampSkill = (s, v) => Math.max(s.minLv ?? 0, Math.min(s.maxLv ?? 0, Number(v) || 0));
        const clampTp = v => Math.max(TP_MIN, Math.min(TP_MAX, Number(v) || 0));
        const getSkill = s => {
          if (state.skillLv[s.id] === undefined) state.skillLv[s.id] = clampSkill(s, s.minLv ?? 0);
          return clampSkill(s, state.skillLv[s.id]);
        };
        const setSkill = (s, v) => {
          const target = clampSkill(s, v);
          const cur = getSkill(s);
          const delta = target - cur;
          const perSp = Number(s.sp || 0);
          if (delta > 0) {
  // â˜… íŒ”ì½˜ 4ì¢… ìƒí˜¸ë°°ì œ: ì´ë¯¸ ë‹¤ë¥¸ íŒ”ì½˜ì´ ì°í˜€ ìˆìœ¼ë©´ ì¦ê°€ ì°¨ë‹¨
  if (isFalconGroupedSkill(s)) {
    const other = pickedOtherFalconExcept(s);
    if (other) {
      alert(`
      íŒ”ì½˜ ê³„ì—´ì€ ë™ì‹œì— ë‘˜ ì´ìƒ ì°ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n
      [ì¸ì„œíŠ¸ : íŒ”ì½˜], [G-SP íŒ”ì½˜(ì½”ë¡œë‚˜ í¼)], \n
      [G-SP íŒ”ì½˜(ë¡¤ë§ ì¬ë” í¼)], [G-SP íŒ”ì½˜(ë©í„° í¼)] \n
      ì¤‘ì— ì‚¬ìš©í•˜ì‹¤ í•˜ë‚˜ì˜ ìŠ¤í‚¬ë§Œ ì„ íƒí•´ì„œ ì˜¬ë ¤ì£¼ì„¸ìš”.\n\n
      í˜„ì¬ [${other.name}]ì´(ê°€) ì„ íƒë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
      return;
    }
  }

  // â˜… G-2 ë¡¤ë§ì¬ë” â†” G-3 ë©í„° ìƒí˜¸ë°°ì œ: ì´ë¯¸ ë‹¤ë¥¸ ìª½ì— SP/TPê°€ íˆ¬ìë˜ì–´ ìˆìœ¼ë©´ ì¦ê°€ ì°¨ë‹¨
if (isRollingRaptorGroupedSkill(s)) {
  const other = pickedOtherRollingRaptorExcept(s);
  if (other) {
    alert(`G-2 ë¡¤ë§ì¬ë”ì™€ G-3 ë©í„°ëŠ” ë™ì‹œì— ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní˜„ì¬ [${other.name}]ì— SP ë˜ëŠ” TPê°€ íˆ¬ìë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
    return;
  }
}

  const need = perSp * delta;
  if (!canSpendSp(need)) return;
  state.skillLv[s.id] = target;
  spendSp(need);
} else if (delta < 0) {
            state.skillLv[s.id] = target;
            refundSp(perSp * (-delta));
          } else {
            state.skillLv[s.id] = target;
            //onSkillTreeChanged();
          }
          // â˜… ë©”ì¹´ë‹‰(ì—¬) ì „ìš©: G ë§ˆê·¸ë„¤í‹± â†” ì‹±í¬ë¡œ : ì½”ë¡œë‚˜ SP ì—°ë™
if (isMagneticCoronaLinkedSkill(s)) {
  syncMagneticCoronaSpFrom(s);
}
        };
        const getTp = s => {
          if (state.skillTpLv[s.id] === undefined) state.skillTpLv[s.id] = TP_MIN;
          return clampTp(state.skillTpLv[s.id]);
        };
        const setTp = (s, v) => {
          const unit = Number(s.tpCost || 0);
          if (!(unit > 0)) return;
          const target = clampTp(v);
          const cur = getTp(s);
          if (target > cur) {
  // â˜… íŒ”ì½˜ 4ì¢… ìƒí˜¸ë°°ì œ: SP ë¯¸ìŠµë“ ìƒíƒœì—ì„œ ë‹¤ë¥¸ íŒ”ì½˜ì´ ì´ë¯¸ ì°í˜€ ìˆìœ¼ë©´ TP ì¦ê°€ ì°¨ë‹¨
  if (isFalconGroupedSkill(s)) {
    const baseLv = Number(state.skillLv?.[s.id] ?? 0) || 0;
    const other  = pickedOtherFalconExcept(s);
    if (baseLv <= 0 && other) {
      alert(`íŒ”ì½˜ ê³„ì—´ì€ ë™ì‹œì— ë‘˜ ì´ìƒ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜„ì¬ [${other.name}]ì´(ê°€) ì„ íƒë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
      return;
    }
  }

  // â˜… G-2 ë¡¤ë§ì¬ë” â†” G-3 ë©í„° ìƒí˜¸ë°°ì œ: ë‹¤ë¥¸ ìª½ì— SP/TPê°€ íˆ¬ìë˜ì–´ ìˆìœ¼ë©´ TP ì¦ê°€ ì°¨ë‹¨
if (isRollingRaptorGroupedSkill(s)) {
  const other = pickedOtherRollingRaptorExcept(s);
  if (other) {
    alert(`G-2 ë¡¤ë§ì¬ë”ì™€ G-3 ë©í„°ëŠ” ë™ì‹œì— ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní˜„ì¬ [${other.name}]ì— SP ë˜ëŠ” TPê°€ íˆ¬ìë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
    return;
  }
}

  const need = (target - cur) * unit;
  if (!canSpendTp(need)) return;
  state.skillTpLv[s.id] = target;
  spendTp(need);
} else if (target < cur) {
            state.skillTpLv[s.id] = target;
            refundTp((cur - target) * unit);
          } else {
            state.skillTpLv[s.id] = target;
          }
          // â˜… ë©”ì¹´ë‹‰(ì—¬) ì „ìš©: G ë§ˆê·¸ë„¤í‹± â†” ì‹±í¬ë¡œ : ì½”ë¡œë‚˜ TP ì—°ë™
if (isMagneticCoronaLinkedSkill(s)) {
  syncMagneticCoronaTpFrom(s);
}
        };

// ===== ë©”ì¹´ë‹‰(ì—¬) ì „ìš©: G-4 í˜¸ë„· â†’ G í’€ ë¸”ë£¸ ìë™ ì—°ë™ =====
let hornetSkill = null;
let fullBloomSkill = null;
let fullBloomSpanCur = null; // í’€ ë¸”ë£¸ ë ˆë²¨ í‘œê¸° span

function syncFullBloomAutoFromHornet() {
  if (!hornetSkill || !fullBloomSkill) return;

  const curMap = state.skillLv || {};
  let autoLv = Number(curMap[hornetSkill.id] ?? 0) || 0;

  autoLv = clampSkill(fullBloomSkill, autoLv);
  state.skillLv[fullBloomSkill.id] = autoLv;

  if (fullBloomSpanCur) {
    fullBloomSpanCur.textContent = String(autoLv);
  }
}


        // ===== ìŠ¤íŠ¸ë¼ì´ì»¤ ì „ìš©: ë¡œí‚¥ â†’ ë³¸ í¬ëŸ¬ì…” ìë™ ì—°ë™ =====
        const skillNameKey = (txt) =>
          String(txt || '').normalize('NFC').replace(/\s+/g, '');

        let lowKickSkill = null;
        let boneCrusherSkill = null;
        let boneCrusherSpanCur = null; // ë³¸ í¬ëŸ¬ì…” ë ˆë²¨ í‘œì‹œ span

        function syncBoneCrusherAutoFromLowKick() {
          if (!lowKickSkill || !boneCrusherSkill) return;

          const curMap = state.skillLv || {};
          const lowLv = Number(curMap[lowKickSkill.id] ?? 0) || 0;

          // ë¡œí‚¥ 11 â†’ ë³¸ í¬ëŸ¬ì…” 1, ì´í›„ 1ë ˆë²¨ë‹¹ +1
          let autoLv = lowLv - 10;
          if (autoLv < 0) autoLv = 0;

          autoLv = clampSkill(boneCrusherSkill, autoLv);
          state.skillLv[boneCrusherSkill.id] = autoLv;

          if (boneCrusherSpanCur) {
            boneCrusherSpanCur.textContent = String(autoLv);
          }
        }

        // ===== ë©”ì¹´ë‹‰(ì—¬) ì „ìš©: íŒ”ì½˜ 4ì¢… ìƒí˜¸ë°°ì œ =====
let falconInsertSkill = null;      // 'ì¸ì„œíŠ¸ : íŒ”ì½˜'
let gspFalconCorona   = null;      // 'G-SP íŒ”ì½˜(ì½”ë¡œë‚˜ í¼)'
let gspFalconRolling  = null;      // 'G-SP íŒ”ì½˜(ë¡¤ë§ ì¬ë” í¼)'
let gspFalconRaptor   = null;      // 'G-SP íŒ”ì½˜(ë©í„° í¼)'

// í˜„ì¬ íŒ”ì½˜ 4ì¢… ì¤‘ 'ë‚˜(sTry)'ë¥¼ ì œì™¸í•˜ê³  ì´ë¯¸ ì°íŒ(ë ˆë²¨>0) ìŠ¤í‚¬ì´ ìˆëŠ”ì§€ ê²€ì‚¬
function pickedOtherFalconExcept(sTry) {
  const curMap = state.skillLv || {};
  const group = [falconInsertSkill, gspFalconCorona, gspFalconRolling, gspFalconRaptor].filter(Boolean);
  for (const sk of group) {
    if (!sk) continue;
    if (sTry && sk.id === sTry.id) continue;
    const lv = Number(curMap[sk.id] ?? 0) || 0;
    if (lv > 0) return sk;            // ì´ë¯¸ í•˜ë‚˜ ì°í˜€ ìˆìŒ â†’ ìœ„ë°˜ ëŒ€ìƒ ë°˜í™˜
  }
  return null;                         // ì—†ìŒ
}

// ì´ ìŠ¤í‚¬ì´ íŒ”ì½˜ 4ì¢…ì— ì†í•˜ëŠ”ê°€
function isFalconGroupedSkill(s) {
  if (!s) return false;
  const id = s.id;
  return !![falconInsertSkill, gspFalconCorona, gspFalconRolling, gspFalconRaptor]
          .filter(Boolean)
          .find(sk => sk.id === id);
}

// ===== ë©”ì¹´ë‹‰(ì—¬) ì „ìš©: G ë§ˆê·¸ë„¤í‹± â†” ì‹±í¬ë¡œ : ì½”ë¡œë‚˜ SP/TP ì—°ë™ =====
let gMagneticSkill = null;        // 'G ë§ˆê·¸ë„¤í‹±'
let syncroCoronaSkill = null;     // 'ì‹±í¬ë¡œ : ì½”ë¡œë‚˜'
let gMagneticSpanCur = null;
let gMagneticSpanTp  = null;
let syncroCoronaSpanCur = null;
let syncroCoronaSpanTp  = null;

function isMagneticCoronaLinkedSkill(s) {
  if (!s) return false;
  const id = s.id;
  return !![gMagneticSkill, syncroCoronaSkill]
    .filter(Boolean)
    .find(sk => sk.id === id);
}

// SP ì—°ë™: í•œ ìª½ì„ ì˜¬ë¦¬ê±°ë‚˜ ë‚´ë¦¬ë©´ ë‹¤ë¥¸ ìª½ SP ë ˆë²¨ë„ ë™ì¼í•˜ê²Œ ë§ì¶¤ (SP ì†Œëª¨/í™˜ê¸‰ì€ 1íšŒë§Œ ë°œìƒ)
function syncMagneticCoronaSpFrom(srcSkill) {
  if (!gMagneticSkill || !syncroCoronaSkill) return;
  if (!srcSkill) return;

  const srcId = srcSkill.id;
  const other = (gMagneticSkill && srcId === gMagneticSkill.id) ? syncroCoronaSkill : gMagneticSkill;
  if (!other) return;

  const lv = Number(state.skillLv?.[srcId] ?? 0) || 0;
  const newLv = clampSkill(other, lv);
  state.skillLv[other.id] = newLv;

  if (other.id === gMagneticSkill.id && gMagneticSpanCur) gMagneticSpanCur.textContent = String(newLv);
  if (other.id === syncroCoronaSkill.id && syncroCoronaSpanCur) syncroCoronaSpanCur.textContent = String(newLv);
}

// TP ì—°ë™: í•œ ìª½ì„ ì˜¬ë¦¬ê±°ë‚˜ ë‚´ë¦¬ë©´ ë‹¤ë¥¸ ìª½ TP ë ˆë²¨ë„ ë™ì¼í•˜ê²Œ ë§ì¶¤ (TP ì†Œëª¨/í™˜ê¸‰ì€ 1íšŒë§Œ ë°œìƒ)
function syncMagneticCoronaTpFrom(srcSkill) {
  if (!gMagneticSkill || !syncroCoronaSkill) return;
  if (!srcSkill) return;

  const srcId = srcSkill.id;
  const other = (gMagneticSkill && srcId === gMagneticSkill.id) ? syncroCoronaSkill : gMagneticSkill;
  if (!other) return;

  const tp = Number(state.skillTpLv?.[srcId] ?? 0) || 0;
  const newTp = clampTp(tp);
  state.skillTpLv[other.id] = newTp;

  if (other.id === gMagneticSkill.id && gMagneticSpanTp) gMagneticSpanTp.textContent = String(newTp);
  if (other.id === syncroCoronaSkill.id && syncroCoronaSpanTp) syncroCoronaSpanTp.textContent = String(newTp);
}

// ===== ë©”ì¹´ë‹‰(ì—¬) ì „ìš©: G-2 ë¡¤ë§ì¬ë” â†” G-3 ë©í„° ìƒí˜¸ë°°ì œ =====
let mechRollingSkill = null;  // 'G-2 ë¡¤ë§ì¬ë”'
let mechRaptorSkill  = null;  // 'G-3 ë©í„°'

// í˜„ì¬ (ë¡¤ë§/ë©í„°) 2ì¢… ì¤‘ 'ë‚˜(sTry)'ë¥¼ ì œì™¸í•˜ê³  ì´ë¯¸ íˆ¬ìëœ(SP>0 ë˜ëŠ” TP>0) ìŠ¤í‚¬ì´ ìˆëŠ”ì§€ ê²€ì‚¬
function pickedOtherRollingRaptorExcept(sTry) {
  const curMap = state.skillLv || {};
  const tpMap  = state.skillTpLv || {};
  const group  = [mechRollingSkill, mechRaptorSkill].filter(Boolean);

  for (const sk of group) {
    if (!sk) continue;
    if (sTry && sk.id === sTry.id) continue;

    const lv = Number(curMap[sk.id] ?? 0) || 0;
    const tp = Number(tpMap[sk.id] ?? 0) || 0;

    if (lv > 0 || tp > 0) return sk;   // ì´ë¯¸ ë‹¤ë¥¸ ìª½ì— íˆ¬ìë¨
  }
  return null;
}

function isRollingRaptorGroupedSkill(s) {
  if (!s) return false;
  const id = s.id;
  return !![mechRollingSkill, mechRaptorSkill]
    .filter(Boolean)
    .find(sk => sk.id === id);
}


        let hurricaneSkill = null;
let deathHurricaneSkill = null;

// âœ… ë„ì  ë¡œê·¸: í—ˆë¦¬ì¼€ì¸ ì„ í–‰ì¡°ê±´(í—ˆë¦¬ì¼€ì¸ 0ì´ë©´ ë°ìŠ¤ í—ˆë¦¬ì¼€ì¸ ê°•ì œ 0)
function enforceDeathHurricanePrereq() {
  if (!hurricaneSkill || !deathHurricaneSkill) return;
  const hLv = Number(state.skillLv?.[hurricaneSkill.id] ?? 0) || 0;
  const dLv = Number(state.skillLv?.[deathHurricaneSkill.id] ?? 0) || 0;
  if (hLv <= 0 && dLv > 0) {
    setSkill(deathHurricaneSkill, 0);
  }
}


        // (6) ìŠ¤í‚¬ ë°´ë“œ UI êµ¬ì„±
        wrap.innerHTML = '';
        levels.forEach(lvl => {
          const group = list.filter(s => Number(s.level || 0) === lvl);
          const band = document.createElement('div');
          band.className = 'st2-band';
          const label = document.createElement('div');
          label.className = 'st2-band-label';
          label.textContent = String(lvl);
          const grid = document.createElement('div');
          grid.className = 'st2-grid';

          group.forEach(s => {
            const tile = document.createElement('div');
            tile.className = 'st2-tile';
            tile.style.gridColumn = String(s.x);
            tile.style.gridRow = String(s.y || 1);
            tile.dataset.skillId = s.id;   // â˜… ìŠ¤í‚¬ IDë¥¼ DOMì— ë°•ì•„ì„œ ë‚˜ì¤‘ì— ì°¾ì•„ì˜¤ê¸°

            const keyName = skillNameKey(s.name);
const isLowKick = (keyName === skillNameKey('ë¡œí‚¥'));
const isBoneCrusher = (keyName === skillNameKey('ë³¸ í¬ëŸ¬ì…”'));
const isHurricane = (keyName === skillNameKey('í—ˆë¦¬ì¼€ì¸'));
const isDeathHurricane = (keyName === skillNameKey('ë°ìŠ¤ í—ˆë¦¬ì¼€ì¸'));
const isHornet    = (keyName === skillNameKey('G-4 í˜¸ë„·'));
const isFullBloom = (keyName === skillNameKey('G í’€ ë¸”ë£¸'));
const isFalconInsert = (keyName === skillNameKey('ì¸ì„œíŠ¸ : íŒ”ì½˜') || keyName === skillNameKey('ì¸ì„œíŠ¸: íŒ”ì½˜'));
const isGspCorona    = (keyName === skillNameKey('G-SP íŒ”ì½˜(ì½”ë¡œë‚˜ í¼)'));
const isGspRolling   = (keyName === skillNameKey('G-SP íŒ”ì½˜(ë¡¤ë§ ì¬ë” í¼)'));
const isGspRaptor    = (keyName === skillNameKey('G-SP íŒ”ì½˜(ë©í„° í¼)'));
const isMechRolling = (keyName === skillNameKey('G-2 ë¡¤ë§ì¬ë”'));
const isMechRaptor  = (keyName === skillNameKey('G-3 ë©í„°'));
const isGMagnetic = (keyName === skillNameKey('G ë§ˆê·¸ë„¤í‹±') || keyName === skillNameKey('G-ë§ˆê·¸ë„¤í‹±') || keyName === skillNameKey('G - ë§ˆê·¸ë„¤í‹±') || keyName === skillNameKey('G- ë§ˆê·¸ë„¤í‹±'));
const isSyncroCorona = (keyName === skillNameKey('ì‹±í¬ë¡œ : ì½”ë¡œë‚˜') || keyName === skillNameKey('ì‹±í¬ë¡œ: ì½”ë¡œë‚˜') || keyName === skillNameKey('ì‹±í¬ë¡œ:ì½”ë¡œë‚˜') || keyName === skillNameKey('ì‹±í¬ë¡œ :ì½”ë¡œë‚˜'));



if (isFalconInsert) falconInsertSkill = s;
if (isGspCorona)    gspFalconCorona   = s;
if (isGspRolling)   gspFalconRolling  = s;
if (isGspRaptor)    gspFalconRaptor   = s;
if (isMechRolling)  mechRollingSkill = s;
if (isMechRaptor)   mechRaptorSkill  = s;

if (isGMagnetic)    gMagneticSkill = s;
if (isSyncroCorona) syncroCoronaSkill = s;

if (isLowKick) lowKickSkill = s;
if (isBoneCrusher) boneCrusherSkill = s;

if (isHurricane) hurricaneSkill = s;
if (isDeathHurricane) deathHurricaneSkill = s;

if (isHornet)    hornetSkill = s;
if (isFullBloom) fullBloomSkill = s;

            const spanCur = document.createElement('span');
            spanCur.className = 'cur';

            if (isBoneCrusher) {
              boneCrusherSpanCur = spanCur;
            }

            if (isFullBloom) {
              fullBloomSpanCur = spanCur;
            }

            if (isGMagnetic) {
              gMagneticSpanCur = spanCur;
            }

            if (isSyncroCorona) {
              syncroCoronaSpanCur = spanCur;
            }


            // âœ… ì´ ìŠ¤í‚¬ì´ TPë¥¼ ì“¸ ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€
            const hasTp1 = (s.tpCost || 0) > 0;

            // TPê°€ ì—†ëŠ” ìŠ¤í‚¬ì´ë©´ íƒ€ì¼ì— í‘œì‹œìš© í´ë˜ìŠ¤ ì¶”ê°€
            if (!hasTp1) {
              tile.classList.add('no-tp');
            }

            const icon = document.createElement('div');
            icon.className = 'st2-skill';
            const img = document.createElement('img');
            img.alt = s.name;
            img.src = s.img || '';
            icon.appendChild(img);

            const nameEl = document.createElement('div');
            nameEl.className = 'st2-name';
            nameEl.textContent = s.name;

            // ì»¨íŠ¸ë¡¤ UI
            const ctrl = document.createElement('div');
            ctrl.className = 'st2-ctrl2';

            const LTop = document.createElement('div'); LTop.className = 'st2-side-left';
            const LBot = document.createElement('div'); LBot.className = 'st2-side-left';
            const RTop = document.createElement('div'); RTop.className = 'st2-side-right';
            const RBot = document.createElement('div'); RBot.className = 'st2-side-right';

            const btnSkillMax = document.createElement('button'); btnSkillMax.className = 'st2-btn'; btnSkillMax.textContent = 'Max';
            const btnSkillPlus = document.createElement('button'); btnSkillPlus.className = 'st2-btn'; btnSkillPlus.textContent = '+';
            const btnSkillMinus = document.createElement('button'); btnSkillMinus.className = 'st2-btn'; btnSkillMinus.textContent = 'âˆ’';
            const btnSkillMin = document.createElement('button'); btnSkillMin.className = 'st2-btn'; btnSkillMin.textContent = 'Min';

            const btnTpMax = document.createElement('button'); btnTpMax.className = 'st2-btn'; btnTpMax.textContent = 'Max';
            const btnTpPlus = document.createElement('button'); btnTpPlus.className = 'st2-btn'; btnTpPlus.textContent = '+';
            const btnTpMinus = document.createElement('button'); btnTpMinus.className = 'st2-btn'; btnTpMinus.textContent = 'âˆ’';
            const btnTpMin = document.createElement('button'); btnTpMin.className = 'st2-btn'; btnTpMin.textContent = 'Min';

            const lvBox = document.createElement('div'); lvBox.className = 'st2-lv';
            const nums = document.createElement('div'); nums.className = 'st2-lvnums';
            // const spanCur = document.createElement('span'); spanCur.className = 'cur';
            const spanSep = document.createElement('span'); spanSep.className = 'sep'; spanSep.textContent = 'â”‚';
            const spanTp = document.createElement('span'); spanTp.className = 'tp';
            if (isGMagnetic) gMagneticSpanTp = spanTp;
            if (isSyncroCorona) syncroCoronaSpanTp = spanTp;
            // âœ… ì´ ìŠ¤í‚¬ì´ TPë¥¼ ì“¸ ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€
            const hasTp = (s.tpCost || 0) > 0;

            // í˜„ì¬ ë ˆë²¨ì€ í•­ìƒ í‘œì‹œ
            nums.appendChild(spanCur);

            // TPë¥¼ ì˜¬ë¦´ ìˆ˜ ìˆëŠ” ìŠ¤í‚¬ë§Œ TP êµ¬ë¶„ì„ /ìˆ«ì í‘œì‹œ
            if (hasTp) {
              nums.appendChild(spanSep);
              nums.appendChild(spanTp);
            }
            lvBox.appendChild(nums);

            LTop.appendChild(btnSkillMax); LTop.appendChild(btnSkillPlus);
            LBot.appendChild(btnSkillMinus); LBot.appendChild(btnSkillMin);
            // âœ… TP ê°€ëŠ¥í•œ ìŠ¤í‚¬ë§Œ TP ë²„íŠ¼ ë³´ì´ê¸°
            if (hasTp) {
              RTop.appendChild(btnTpMax); RTop.appendChild(btnTpPlus);
              RBot.appendChild(btnTpMinus); RBot.appendChild(btnTpMin);
            } else {
              // TPê°€ ì—†ëŠ” ìŠ¤í‚¬ì´ë©´ ì˜¤ë¥¸ìª½ ì¹¸ ìì²´ë¥¼ ìˆ¨ê²¨ë„ ë¨
              RTop.style.display = 'none';
              RBot.style.display = 'none';
            }

            // ğŸ”¹ SP / TP íƒœê·¸ â€“ ë ˆë²¨ë°•ìŠ¤ ë°”ë¡œ ìœ„ ì¤‘ì•™ì— ë†“ì„ ê²ƒ
            const tags = document.createElement('div');
            tags.className = 'st2-tags';
            const tagSp = document.createElement('span');
            tagSp.className = 'tag-sp';
            tagSp.textContent = 'SP';
            const tagTp = document.createElement('span');
            tagTp.className = 'tag-tp';
            tagTp.textContent = 'TP';

            tags.appendChild(tagSp);
            // âœ… TP ê°€ëŠ¥í•œ ìŠ¤í‚¬ë§Œ TP íƒœê·¸ í‘œì‹œ
            if (hasTp) {
              tags.appendChild(tagTp);
            }

            tags.style.gridColumn = '2';
            tags.style.gridRow = '1';

            LTop.style.gridColumn = '1'; LTop.style.gridRow = '1';
            LBot.style.gridColumn = '1'; LBot.style.gridRow = '2';
            lvBox.style.gridColumn = '2'; lvBox.style.gridRow = '2';
            RTop.style.gridColumn = '3'; RTop.style.gridRow = '1';
            RBot.style.gridColumn = '3'; RBot.style.gridRow = '2';

            ctrl.appendChild(LTop); ctrl.appendChild(LBot);
            ctrl.appendChild(tags); ctrl.appendChild(lvBox);
            ctrl.appendChild(RTop); ctrl.appendChild(RBot);

            tile.appendChild(icon);
            tile.appendChild(nameEl);
            tile.appendChild(ctrl);
            grid.appendChild(tile);

            const refresh = () => {
              const cur = getSkill(s);
              const tp = getTp(s);
              spanCur.textContent = String(cur);
              spanTp.textContent = String(tp);

              // â˜… ë³¸ í¬ëŸ¬ì…”/í’€ ë¸”ë£¸: SPëŠ” ìë™ìŠµë“ â†’ ë²„íŠ¼ ì™„ì „ ë¹„í™œì„±í™”
              if (isBoneCrusher || isFullBloom) {
                btnSkillPlus.disabled = true;
                btnSkillMax.disabled = true;
                btnSkillMinus.disabled = true;
                btnSkillMin.disabled = true;
              } else {
                btnSkillPlus.disabled = (cur >= s.maxLv);
                btnSkillMax.disabled = (cur >= s.maxLv);
                btnSkillMinus.disabled = (cur <= s.minLv);
                btnSkillMin.disabled = (cur <= s.minLv);
              }

              const unit = Number(s.tpCost || 0);
              if (!(unit > 0)) {
                btnTpPlus.disabled = true; btnTpMax.disabled = true;
                btnTpMinus.disabled = true; btnTpMin.disabled = true;
              } else {
                btnTpPlus.disabled = (tp >= TP_MAX) || ((state.tp.left || 0) < unit);
                btnTpMax.disabled = (tp >= TP_MAX) || ((state.tp.left || 0) < (TP_MAX - tp) * unit);
                btnTpMinus.disabled = (tp <= 0);
                btnTpMin.disabled = (tp <= 0);
              }
            };
            refresh();

            const stepSkillUp = () => {
  if (isDeathHurricane && hurricaneSkill && getSkill(hurricaneSkill) <= 0) {
    alert('ë°ìŠ¤ í—ˆë¦¬ì¼€ì¸ì€ í—ˆë¦¬ì¼€ì¸ì„ ë¨¼ì € ì°ì–´ì•¼ í•©ë‹ˆë‹¤.');
    return;
  }
  setSkill(s, getSkill(s) + 1);
  if (isLowKick) syncBoneCrusherAutoFromLowKick();
  if (isHornet)  syncFullBloomAutoFromHornet();   // â† ì´ ì¤„ ì¶”ê°€
  enforceDeathHurricanePrereq();
  refresh();
};

            const stepSkillDn = () => {
  setSkill(s, getSkill(s) - 1);
  if (isLowKick) syncBoneCrusherAutoFromLowKick();
  if (isHornet)  syncFullBloomAutoFromHornet();   // â† ì´ ì¤„ ì¶”ê°€
  enforceDeathHurricanePrereq();
  refresh();
};

            // âœ… ê°€ì§„ SP í•œë„ ë‚´ì—ì„œ ê°€ëŠ¥í•œ ë§Œí¼ MAX
            const toSkillMax = () => {
  if (isDeathHurricane && hurricaneSkill && getSkill(hurricaneSkill) <= 0) {
    alert('ë°ìŠ¤ í—ˆë¦¬ì¼€ì¸ì€ í—ˆë¦¬ì¼€ì¸ì„ ë¨¼ì € ì°ì–´ì•¼ í•©ë‹ˆë‹¤.');
    return;
  }
              const perSp = Number(s.sp || 0);
              const cur = getSkill(s);
              const maxTarget = clampSkill(s, s.maxLv);

              // ë ˆë²¨ë‹¹ SP 0ì´ë©´ ê·¸ëƒ¥ í’€ë¡œ ì°ì–´ë„ ìƒê´€ ì—†ìŒ
              if (!(perSp > 0)) {
                setSkill(s, maxTarget);
                if (isLowKick) syncBoneCrusherAutoFromLowKick();
                if (isHornet)  syncFullBloomAutoFromHornet();   // â† ì¶”ê°€
                enforceDeathHurricanePrereq();
                refresh();
                return;
              }

              const left = state.sp.left || 0;               // ë‚¨ì€ SP
              const maxDeltaByCap = maxTarget - cur;         // ë ˆë²¨ ìƒí•œê¹Œì§€ í•„ìš”í•œ ì¦ê°€ëŸ‰
              const maxDeltaBySp = Math.floor(left / perSp); // SPë¡œ ì˜¬ë¦´ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë ˆë²¨ ìˆ˜

              if (maxDeltaBySp <= 0) return; // ì˜¬ë¦´ SPê°€ 1ë ˆë²¨ë¶„ë„ ì—†ìœ¼ë©´ ì•„ë¬´ ê²ƒë„ ì•ˆ í•¨

              const target = cur + Math.min(maxDeltaByCap, maxDeltaBySp);
              setSkill(s, target);
              if (isLowKick) syncBoneCrusherAutoFromLowKick();
              if (isHornet)  syncFullBloomAutoFromHornet();   // â† ì¶”ê°€
              enforceDeathHurricanePrereq();
              refresh();
            };

            const toSkillMin = () => {
  setSkill(s, s.minLv);
  if (isLowKick) syncBoneCrusherAutoFromLowKick();
  if (isHornet)  syncFullBloomAutoFromHornet();   // â† ì¶”ê°€
  enforceDeathHurricanePrereq();
  refresh();
};

            const stepTpUp = () => { setTp(s, getTp(s) + 1); refresh(); };
            const stepTpDn = () => { setTp(s, getTp(s) - 1); refresh(); };
            // âœ… ê°€ì§„ TP í•œë„ ë‚´ì—ì„œ ê°€ëŠ¥í•œ ë§Œí¼ MAX
            const toTpMax = () => {
              const unit = Number(s.tpCost || 0);
              const cur = getTp(s);
              const maxTarget = clampTp(TP_MAX);  // ë³´í†µ 5

              // TP ì†Œëª¨ê°€ ì—†ë‹¤ë©´ ê·¸ëƒ¥ í’€ë¡œ ì˜¬ë ¤ë„ ë¨
              if (!(unit > 0)) {
                setTp(s, maxTarget);
                refresh();
                return;
              }

              const left = state.tp.left || 0;               // ë‚¨ì€ TP
              const maxDeltaByCap = maxTarget - cur;         // ë ˆë²¨ ìƒí•œê¹Œì§€ í•„ìš”ëŸ‰
              const maxDeltaByTp = Math.floor(left / unit); // TPë¡œ ì˜¬ë¦´ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë ˆë²¨ ìˆ˜

              if (maxDeltaByTp <= 0) return; // ì˜¬ë¦´ TPê°€ ì—†ìœ¼ë©´ ì•„ë¬´ ê²ƒë„ ì•ˆ í•¨

              const target = cur + Math.min(maxDeltaByCap, maxDeltaByTp);
              setTp(s, target);
              refresh();
            };
            const toTpMin = () => { setTp(s, 0); refresh(); };

            attachPressRepeat(btnSkillPlus, stepSkillUp);
            attachPressRepeat(btnSkillMinus, stepSkillDn);
            attachPressRepeat(btnSkillMax, toSkillMax);
            attachPressRepeat(btnSkillMin, toSkillMin);

            attachPressRepeat(btnTpPlus, stepTpUp);
            attachPressRepeat(btnTpMinus, stepTpDn);
            attachPressRepeat(btnTpMax, toTpMax);
            attachPressRepeat(btnTpMin, toTpMin);
          });

          band.appendChild(label);
          band.appendChild(grid);
          wrap.appendChild(band);
        });
      }





      // ìŠ¤í‚¬íŠ¸ë¦¬ 'ì„¤ì •í•˜ê¸°' ë²„íŠ¼: ë‹¨ìˆœíˆ ëª¨ë‹¬ë§Œ ë‹«ê¸° (ì‹¤ì œ ê³„ì‚°ì€ "ê³„ì‚°í•˜ê¸°"ì—ì„œ)
      {
        const $btnApply = document.getElementById('btnSkillApply');
        if ($btnApply) {
          $btnApply.addEventListener('click', () => {
            const stModal = document.getElementById('skillTreeModal');
            if (stModal) {
              stModal.classList.remove('show');
              stModal.setAttribute('aria-hidden', 'true');
            }
          });
        }
      }

      // ì›Œë¦¬ì–´ ì™€ì¼ë“œë² ì¸: ìŠ¤í‚¬íŠ¸ë¦¬ 2ì•ˆ(íŒŒíŒŒì´ˆ/ë¹¨íŒŒì´ˆ) ì„ íƒ ëª¨ë‹¬
const openWildbaneTreeModal = () => {
  const wbModal = document.getElementById('wildbaneTreeModal');
  if (!wbModal) return false;

  // âœ… ìŠ¤í‚¬íŠ¸ë¦¬
  state.wildbaneTreePreset = state.wildbaneTreePreset || 'íŒŒíŒŒì´ˆ';
  state._wbTreeTemp = state.wildbaneTreePreset;

  wbModal.querySelectorAll('[data-wb-tree]').forEach(btn => {
    btn.classList.toggle('wb-active', btn.dataset.wbTree === state._wbTreeTemp);
  });

// âœ… ì‚¬ì´í´ ì…ë ¥(ì„ì‹œê°’) - ì²´í¬ë°•ìŠ¤ ì œê±° ë²„ì „
state.wildbaneCycleCount = Number.isFinite(+state.wildbaneCycleCount)
  ? Math.max(0, Math.floor(+state.wildbaneCycleCount))
  : 0;

// enabledëŠ” UI ì—†ì´ "ê°’ì´ ìˆìœ¼ë©´ true"ë¡œë§Œ ìœ ì§€(ë°±ì—”ë“œì—ì„œ í•„ìš”í•˜ë©´ ì‚¬ìš©)
state.wildbaneCycleEnabled = state.wildbaneCycleCount > 0;

state._wbCycleCountTemp = state.wildbaneCycleCount;
state._wbCycleEnabledTemp = state.wildbaneCycleEnabled;

const inp = wbModal.querySelector('#wbCycleCount');
if (inp) inp.value = String(state._wbCycleCountTemp ?? 0);

  wbModal.classList.add('show');
  wbModal.setAttribute('aria-hidden', 'false');
  return true;
};

// ì›Œë¦¬ì–´ ìœˆë“œì‹œì–´: ìŠ¤í‚¬íŠ¸ë¦¬ 3ì•ˆ ì„ íƒ ëª¨ë‹¬
const openWindshearTreeModal = () => {
  const wsModal = document.getElementById('windshearTreeModal');
  if (!wsModal) return false;

  // âœ… ê¸°ë³¸ê°’
  state.windshearTreePreset = state.windshearTreePreset || 'A';

  // ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
  wsModal.querySelectorAll('[data-ws-tree]').forEach(b2 => {
    b2.classList.toggle('wb-active', b2.dataset.wsTree === state.windshearTreePreset);
  });

  // âœ… ì‚¬ì´í´ ê°’ ë³´ì •(ì™€ì¼ë“œë² ì¸ê³¼ ë™ì¼í•œ ì •ì±…)
  state.windshearCycleCount = Number.isFinite(+state.windshearCycleCount)
    ? Math.max(0, Math.floor(+state.windshearCycleCount))
    : 0;

  state.windshearCycleEnabled = state.windshearCycleCount > 0;

  state._wsCycleCountTemp = state.windshearCycleCount;
  state._wsCycleEnabledTemp = state.windshearCycleEnabled;

  const inp = wsModal.querySelector('#wsCycleCount');
  if (inp) inp.value = String(state._wsCycleCountTemp ?? 0);

  wsModal.classList.add('show');
  wsModal.setAttribute('aria-hidden', 'false');
  return true;
};


(() => {
  const wbModal = document.getElementById('wildbaneTreeModal');
  if (!wbModal) return;

  const close = () => {
    wbModal.classList.remove('show');
    wbModal.setAttribute('aria-hidden', 'true');
  };

  // ë‹«ê¸°(ë°°ê²½/âœ•)
  wbModal.querySelectorAll('[data-close]').forEach(el => {
    el.addEventListener('click', close);
  });

  // ì˜µì…˜ ì„ íƒ(ë²„íŠ¼ í´ë¦­)
  wbModal.querySelectorAll('[data-wb-tree]').forEach(btn => {
    btn.addEventListener('click', () => {
      state._wbTreeTemp = btn.dataset.wbTree || 'íŒŒíŒŒì´ˆ';
      wbModal.querySelectorAll('[data-wb-tree]').forEach(b2 => {
        b2.classList.toggle('wb-active', b2.dataset.wbTree === state._wbTreeTemp);
      });
    });
  });

// âœ… ì‚¬ì´í´ ì…ë ¥(ìˆ«ì) ë³€ê²½ ì‹œ ì„ì‹œê°’ ê°±ì‹  (ì²´í¬ë°•ìŠ¤ ì œê±° ë²„ì „)
const inp = wbModal.querySelector('#wbCycleCount');

if (inp) {
  inp.addEventListener('input', () => {
    const v = Math.floor(Number(inp.value || 0));
    state._wbCycleCountTemp = Math.max(0, isFinite(v) ? v : 0);
    state._wbCycleEnabledTemp = state._wbCycleCountTemp > 0; // count ê¸°ë°˜
  });
}

// ì„ íƒ í™•ì •
document.getElementById('btnWildbaneTreeApply')?.addEventListener('click', () => {
  state.wildbaneTreePreset = state._wbTreeTemp || state.wildbaneTreePreset || 'íŒŒíŒŒì´ˆ';

// âœ… ì‚¬ì´í´ ì…ë ¥ í™•ì • (ì²´í¬ë°•ìŠ¤ ì œê±° ë²„ì „)
state.wildbaneCycleCount = Math.max(0, Math.floor(Number(state._wbCycleCountTemp || 0)));
state.wildbaneCycleEnabled = state.wildbaneCycleCount > 0;

  close();
});

})();

(() => {
  const wsModal = document.getElementById('windshearTreeModal');
  if (!wsModal) return;

  const close = () => {
    wsModal.classList.remove('show');
    wsModal.setAttribute('aria-hidden', 'true');
  };

  // ë‹«ê¸°(ë°°ê²½/âœ•)
  wsModal.querySelectorAll('[data-close]').forEach(el => {
    el.addEventListener('click', close);
  });

  // ì˜µì…˜ ì„ íƒ(ë²„íŠ¼ í´ë¦­)
  wsModal.querySelectorAll('[data-ws-tree]').forEach(btn => {
    btn.addEventListener('click', () => {
      state._wsTreeTemp = btn.dataset.wsTree || 'A';
      wsModal.querySelectorAll('[data-ws-tree]').forEach(b2 => {
        b2.classList.toggle('wb-active', b2.dataset.wsTree === state._wsTreeTemp);
      });
    });
  });

  // âœ… ì‚¬ì´í´ ì…ë ¥(ìˆ«ì) ë³€ê²½ ì‹œ ì„ì‹œê°’ ê°±ì‹ 
  const inp = wsModal.querySelector('#wsCycleCount');
  if (inp) {
    inp.addEventListener('input', () => {
      const v = Math.floor(Number(inp.value || 0));
      state._wsCycleCountTemp = Math.max(0, isFinite(v) ? v : 0);
      state._wsCycleEnabledTemp = state._wsCycleCountTemp > 0;
    });
  }

  // ì„ íƒ í™•ì •
  document.getElementById('btnWindshearTreeApply')?.addEventListener('click', () => {
    state.windshearTreePreset = state._wsTreeTemp || state.windshearTreePreset || 'A';

    state.windshearCycleCount = Math.max(0, Math.floor(Number(state._wsCycleCountTemp || 0)));
    state.windshearCycleEnabled = state.windshearCycleCount > 0;

    close();
  });
})();


      /* ESCë¡œ ë‹«ê¸°(ì„ íƒ ì‚¬í•­) */
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal.show').forEach(m => {
            m.classList.remove('show'); m.setAttribute('aria-hidden', 'true');
          });
        }
      });
      /* 25.09.20 ìŠ¤í‚¬íŠ¸ë¦¬ ì¶”ê°€ F*/

      /* ìŠ¤í‚¬íŠ¸ë¦¬ ì—´ê¸° */
      document.getElementById('btnSkillTree')?.addEventListener('click', async () => {
        const stModal = document.getElementById('skillTreeModal');

        // (í•„ìš”í•˜ë©´ í•©ì‚° ê°±ì‹ , ì§€ê¸ˆì€ ë§‰ì•„ë‘” ìƒíƒœ)
        // if (!state.CurrentSumStats) {
        //   try { await recalcAndRenderPanel(); } catch (_) { }
        // }

        const raw = state.CurrentSumStats || {};

        // 1) ìš°ì„  í”„ë¡ íŠ¸ì˜ í˜„ì¬ ìºë¦­í„° ì •ë³´ë¡œ ownerKey ìƒì„±
        //    ì˜ˆ: jobGroup = 'ë‚¨ê·€ê²€ì‚¬', name = 'ì†Œìš¸ë¸Œë§ì–´' â†’ 'ë‚¨ê·€ê²€ì‚¬ì†Œìš¸ë¸Œë§ì–´'
        let ownerKey = '';
        if (state.currentCharacter) {
          const cc = state.currentCharacter;
          const job = String(cc.jobGroupLabel || cc.jobGroup || '').trim();
          const nm = String(cc.name || '').trim();
          if (job || nm) {
            ownerKey = (job + nm).replace(/\s+/g, '');
          }
        }

        // 2) currentCharacter ê°€ ì—†ì„ ë•Œë§Œ, í•©ì‚° ê²°ê³¼ì˜ ownerKey ë¥¼ ë³´ì¡°ë¡œ ì‚¬ìš©
        if (!ownerKey) {
          ownerKey = String(raw.ownerKey || '').trim();
        }

        // 3) ì—¬ì „íˆ ì—†ìœ¼ë©´: ìºë¦­í„° ì„ íƒ ì•ˆ ëœ ìƒíƒœ â†’ ì•ˆë‚´ í›„ ì¢…ë£Œ
        if (!ownerKey) {
          alert('ìŠ¤í‚¬íŠ¸ë¦¬ë¥¼ ë³´ë ¤ë©´ ë¨¼ì € ìºë¦­í„°ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
          return;
        }
        // âœ… ì›Œë¦¬ì–´ ì™€ì¼ë“œë² ì¸: ìŠ¤í‚¬ì„ ì§ì ‘ ì°ëŠ” ìŠ¤í‚¬íŠ¸ë¦¬ê°€ ì•„ë‹ˆë¼,
//    ì •í˜•í™”ëœ 2ê°œ ìŠ¤í‚¬íŠ¸ë¦¬(íŒŒíŒŒì´ˆ / ë¹¨íŒŒì´ˆ) ì¤‘ í•˜ë‚˜ë¥¼ ê³ ë¥´ëŠ” ëª¨ë‹¬ì„ ë„ìš´ë‹¤.
if (ownerKey === 'ì›Œë¦¬ì–´ì™€ì¼ë“œë² ì¸') {
  openWildbaneTreeModal();
  return;
}
// âœ… ì›Œë¦¬ì–´ ìœˆë“œì‹œì–´: ì™€ì¼ë“œë² ì¸ê³¼ ë™ì¼í•œ í˜•íƒœì˜ ì „ìš© ì„ íƒ ëª¨ë‹¬ì„ ë„ìš´ë‹¤.
if (ownerKey === 'ì›Œë¦¬ì–´ìœˆë“œì‹œì–´') {
  openWindshearTreeModal();
  return;
}


        // ğŸ” ìºë¦­í„°ê°€ ë°”ë€ ê²½ìš°: ìŠ¤í‚¬íŠ¸ë¦¬ ìƒíƒœë§Œ ì´ˆê¸°í™” (SP/TPëŠ” ìºë¦­í„° ì„ íƒ ì‹œ ê°’ ìœ ì§€)
        if (state._stOwnerKey && state._stOwnerKey !== ownerKey) {
          state.skillLv = {};
          state.skillTpLv = {};
          // state.sp / state.tp ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠëŠ”ë‹¤. (ìºë¦­í„° ì„ íƒ ì‹œ setTotals(sp,tp)ë¡œ ì´ë¯¸ ì„¸íŒ…ë¨)
        }
        // í˜„ì¬ ìºë¦­í„° key ì €ì¥
        state._stOwnerKey = ownerKey;

        // SP/TP í‘œì‹œ ê°±ì‹  (í˜„ì¬ state.sp/state.tp ê¸°ì¤€ìœ¼ë¡œ UIë§Œ ë‹¤ì‹œ ê·¸ë¦¼)
        if (typeof renderSpTp === 'function') {
          renderSpTp();
        }

        // ìŠ¤í‚¬ ê·¸ë¦¬ë“œ ë Œë”
        await renderSkillTreeBands();


        // ëª¨ë‹¬ ì˜¤í”ˆ
        if (stModal) {
          stModal.classList.add('show');
          stModal.setAttribute('aria-hidden', 'false');
        }
      });



      async function saveSkillSelections() {
        const arr = [];
        for (const s of (ST2.rows || [])) {
          const lv = Number(state.skillLv?.[s.id] ?? 0);
          const tp = Number(state.skillTpLv?.[s.id] ?? 0);
          if (lv > 0) arr.push({ name: s.name, lv, tp });
        }

        try {
          // ownerKey ê³„ì‚° (1ìˆœìœ„: í˜„ì¬ ìºë¦­ ì •ë³´, 2ìˆœìœ„: í•©ì‚°ìºì‹œ)
          const raw = state.CurrentSumStats || {};

          let ownerKey = '';
          if (state.currentCharacter) {
            const jg = String(state.currentCharacter.jobGroupLabel || state.currentCharacter.jobGroup || '').trim();
            const nm = String(state.currentCharacter.name || '').trim();
            if (jg || nm) {
              ownerKey = (jg + nm).replace(/\s+/g, '');
            }
          }

          if (!ownerKey) {
            ownerKey = String(raw.ownerKey || '').trim();
          }

          // â˜… skill_state_set í˜¸ì¶œ (ì´ë¯¸ JSON ê°ì²´ ë°˜í™˜)
          const res = await apiJSON('skill_state_set', { ownerKey, skills: arr });

          if (Array.isArray(res?.dbgLightDevotee)) {
            console.table(res.dbgLightDevotee);
          }
          // â˜… ì—¬ê¸°ì„œ ë¸Œë¼ìš°ì € ì½˜ì†”ì— ìŠ¤í‚¬ ì •ë³´ ì¶œë ¥
          // if (Array.isArray(res?.skillsDebug)) {
          //  console.log('[skill_state_set] skillsDebug =', res.skillsDebug);
          // }

          // SumStats ì¦ë°œ ë“±ìœ¼ë¡œ no_ownerKeyê°€ ì˜¤ë©´ 1íšŒ ë³µêµ¬ í›„ ì¬ì‹œë„
          if (res?.error === 'no_ownerKey') {
            const raw2 = state.CurrentSumStats || {};
            ownerKey = String(raw2.ownerKey || ownerKey || '').trim();

            const res2 = await apiJSON('skill_state_set', { ownerKey, skills: arr });

            if (Array.isArray(res2?.skillsDebug)) {
              //console.log('[skill_state_set] skillsDebug (retry) =', res2.skillsDebug);
            }
          }
        } catch (e) {
          console.error('[saveSkillSelections] skill_state_set ì‹¤íŒ¨', e);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const stModal = document.getElementById('skillTreeModal');
        if (!stModal) return;   // ëª¨ë‹¬ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì¢…ë£Œ

        stModal.addEventListener('click', (e) => {
          if (
            e.target.classList?.contains('backdrop') ||
            e.target.hasAttribute?.('data-close')
          ) {
            stModal.classList.remove('show');
            stModal.setAttribute('aria-hidden', 'true');
          }
        });
      });


      // ì „ì—­ state ë³´ê°•
      state.runes = state.runes || null;  // nullì´ë©´ ì„œë²„ê°’ ë¡œë“œ
      const RUNE_LEVELS = [15, 20, 25, 30, 35, 40, 45, 65];
      const RUNE_CATS = [
        { key: 'awakening', label: 'ê°ì„±' },
        { key: 'magic', label: 'ë§ˆë ¥' },
        { key: 'illusion', label: 'í—ˆìƒ' },
        { key: 'training', label: 'ìˆ™ë ¨' },
        { key: 'technique', label: 'ê¸°êµ' },
      ];
      function emptyRunes() {
        const o = {};
        RUNE_CATS.forEach(c => { o[c.key] = {}; RUNE_LEVELS.forEach(lv => o[c.key][lv] = 0); });
        return o;
      }
      function ensureRunesInitialized() {
        // 1) runesê°€ ì—†ëŠ”ë° skillruneë§Œ ìˆë‹¤ë©´,
        //    í”„ë¦¬ì…‹ì—ì„œ ê°€ì ¸ì˜¨ ìŠ¤í‚¬ë£¬ì´ë¯€ë¡œ ê·¸ê±¸ ê·¸ëŒ€ë¡œ runesë¡œ ì‚¬ìš©
        if (!state.runes) {
          if (state.skillrune) {
            // ê°™ì€ ê°ì²´ë¥¼ ê°€ë¦¬í‚¤ê²Œ í•´ì„œ í•­ìƒ ë™ê¸°í™”
            state.runes = state.skillrune;
          } else {
            state.runes = emptyRunes();
          }
        }

        // 2) í•­ìƒ skillruneì€ runesë¥¼ ë”°ë¼ê°€ê²Œ (ì†ŒìŠ¤ ì˜¤ë¸Œ íŠ¸ë£¨ìŠ¤ = runes)
        state.skillrune = state.runes;
      }
      /* ===== ìŠ¤í‚¬ë£¬ ì½”ì–´ ===== */
      // ì¹´í…Œê³ ë¦¬ í‚¤: RUNE_CATSì—ì„œ ì“°ëŠ” í‚¤ ê·¸ëŒ€ë¡œ ì‚¬ìš©(ê°ì„±/ë§ˆë ¥/í—ˆìƒ/ìˆ™ë ¨/ê¸°êµ)
      const RUNE_KEYS = {
        awakening: 'ê°ì„±ë£¬',   // ë°ë¯¸ì§€ Ã—1.04^n
        magic: 'ë§ˆë ¥ë£¬',   // ë°ë¯¸ì§€ Ã—1.03^n
        illusion: 'í—ˆìƒë£¬',   // ì¿¨íƒ€ì„ Ã—0.96^n
        training: 'ìˆ™ë ¨ë£¬',   // ìŠ¤í‚¬ë ˆë²¨ +n
        technique: 'ê¸°êµë£¬',   // ìŠ¤í‚¬ê°•í™”ë ˆë²¨ +n
      };

      // ì„ íƒ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°: state.runes[catKey][tier] (ì—†ìœ¼ë©´ 0)
      function getRuneCountByKey(catKey, tier) {
        const row = (state.runes?.[catKey]) || {};
        return Number(row[tier] || 0);
      }

      // ìŠ¤í‚¬ì˜ ë ™ì œ(ë°´ë“œ) ì•Œì•„ë‚´ê¸°: mapRowToSkillì—ì„œ band í•„ë“œë¥¼ ì±„ì›€
      // (ìŠ¤í‚¬ ê°ì²´ì— bandê°€ ì—†ìœ¼ë©´ 0/ê¸°ë³¸ ì·¨ê¸‰)
      function skillTierOf(skill) {
        const b = Number(skill?.band || 0);
        return b > 0 ? b : null;
      }

      // (skillTierOf ë°”ë¡œ ì•„ë˜ì—)
      function getLevelingCountByTier(tier) {
        return Number(state.leveling?.[tier] || 0);
      }

      // cd ê°’ì„ 'ì´ˆ' ìˆ«ìë¡œë§Œ ì–»ê¸° (ë¬¸ì ì„ì—¬ ìˆì–´ë„ ìˆ«ìë§Œ ì¶”ì¶œ)
      function toSec(v) {
        const n = Number(String(v ?? '').replace(/[^\d.]/g, ''));
        return Number.isFinite(n) ? n : 0;
      }

      // 1) ìµœì¢… ê³µê²©ë ¥ ë°°ìˆ˜: ê°ì„±(1.04^n) Ã— ë§ˆë ¥(1.03^n)
      function runeDamageMultiplier(skill) {
        const tier = skillTierOf(skill);
        if (!tier) return 1;
        const nA = getRuneCountByKey('awakening', tier);
        const nM = getRuneCountByKey('magic', tier);
        return Math.pow(1.04, nA) * Math.pow(1.03, nM);
      }

      // 2) ì¿¨íƒ€ì„ ë³´ì •: í—ˆìƒë£¬ â†’ baseCd Ã— (0.96^n)
      function runeCooldown(skill, baseCd) {
        const tier = skillTierOf(skill);
        if (!tier) return baseCd;
        const nH = getRuneCountByKey('illusion', tier);
        return baseCd * Math.pow(0.96, nH);
      }

      // 3) ë ˆë²¨ ë³´ì •: ìˆ™ë ¨(+n), ê¸°êµ(+n)
      function runeLevelAdds(skill) {
        const tier = skillTierOf(skill);
        if (!tier) return { skillLvAdd: 0, enhLvAdd: 0 };
        const nS = getRuneCountByKey('training', tier);
        const nT = getRuneCountByKey('technique', tier);
        return { skillLvAdd: nS, enhLvAdd: nT };
      }

      function countSelectedRunes() {
        let sum = 0;

        // 1) ì¼ë°˜ ìŠ¤í‚¬ë£¬ í•©ì‚°
        Object.values(state.runes || {}).forEach(row =>
          Object.values(row).forEach(v => sum += (Number(v) || 0))
        );

        // 2) ê°€í˜¸ / ì§€í˜œ / ì™œê³¡ íŠ¹ìˆ˜ ìŠ¤í‚¬ë£¬ í•©ì‚°
        const sr = state.specialRunes || {};
        ['gaho', 'jihe', 'waegok'].forEach(k => {
          const v = Number(sr[k] || 0);
          if (Number.isFinite(v)) sum += v;
        });

        return sum;
      }

      function updateRuneCountSummary() {
        const n = countSelectedRunes();
        const a = document.getElementById('runeCountLabel'); if (a) a.textContent = n;
        const b = document.getElementById('runeCount'); if (b) b.textContent = n; // (ì˜µì…˜) ëª¨ë‹¬ ë°– ì¹´ìš´í„°
      }
      // ë£¬ ë³€ê²½ ì‹œ ì‚´ì§ ë””ë°”ìš´ìŠ¤í•´ì„œ ì „ì²´ ì¬ê³„ì‚°
      const onRunesChanged = (() => {
        let t = null;
        return () => {
          clearTimeout(t);
          t = setTimeout(() => {
            // ì „ì²´ í•©ì‚°/ìŠ¤í‚¬ ìºì‹œ/í‘œì‹œê¹Œì§€ í•œ ë²ˆì— ì²˜ë¦¬
            if (typeof recalcAndRenderPanel === 'function') {
              //recalcAndRenderPanel();
            }
          }, 60);
        };
      })();

      state.options = state.options || {
        avatar: null,        // 'rare' | 'advanced'
        weaponImprint: null, // 'add5' | 'patkmatk5' | 'patkmatk3' | 'monster' | 'quest'
        timeWindow: null,    // '30s' | '1m' | '3m' | '5m' | '10m'
        monster: null,       // 'nugol' | 'blackdragon' | 'asmar_calix'
        difficulty: null     // 'hard' | 'normal' | 'easy' | 'nugol_room'
      };

      // â˜… C) íš¨ê³¼ì  ìŠ¤í‚¬ ë ˆë²¨(ë ˆë²¨ë§ + ìˆ™ë ¨ë£¬ ì ìš©, 0ë ˆë²¨ì€ í™œì„±í™” ì•ˆ í•¨)
      function effectiveSkillLevelForDamage(skill) {
        // 1) ê¸°ë³¸ ìŠ¤í‚¬ ë ˆë²¨
        let baseLv = Number(state.skillLv?.[skill.id] ?? 0);
        const kind = String(skill?.kind || '').trim();

        // í‰íƒ€/ì—°ê²°í‰íƒ€ëŠ” ê¸°ë³¸ ë ˆë²¨ì´ ì—†ìœ¼ë©´ 1ë¡œ ë³´ì •
        const isNormal = (kind === 'í‰íƒ€' || kind === 'ì—°ê²°í‰íƒ€' || kind.startsWith('í‰íƒ€'));
        if ((!Number.isFinite(baseLv) || baseLv <= 0) && isNormal) {
          baseLv = 1;
        }
        // í‰íƒ€ê°€ ì•„ë‹ˆê³ , ìœ íš¨ ë² ì´ìŠ¤ë ˆë²¨ì´ ì—†ìœ¼ë©´ 0 (ê¸°ì¡´ ê·œì¹™ ìœ ì§€)
        if (!Number.isFinite(baseLv) || baseLv <= 0) {
          return 0;
        }

        // 2) ìŠ¤í‚¬ë ™ì œ(ë ˆë²¨ë§ ê²Œì´íŠ¸) ê²°ì •: levelGate â†’ band â†’ ê¸°ì¡´ helper ìˆœ
        const gate =
          Number(skill?.levelGate ?? 0) ||
          Number(skill?.band ?? 0) ||
          (skillTierOf ? (Number(skillTierOf(skill)) || 0) : 0);

        const lvlAddByLeveling = gate ? getLevelingCountByTier(gate) : 0;

        // 3) ìˆ™ë ¨ë£¬(+n)
        const { skillLvAdd } = runeLevelAdds ? runeLevelAdds(skill) : { skillLvAdd: 0 };

        // â˜… ì˜ˆì™¸ê·œì¹™: ìŠ¤í‚¬ë ˆë²¨ ê°€ì‚°
        const excAdd = Number(__EXC?.addLv?.[skill.id] || 0);
        if (excAdd) baseLv = Math.max(0, baseLv + excAdd);

        // 4) ìµœì¢… ìœ íš¨ ë ˆë²¨(ìƒí•œ ì—†ìŒ, 1 ì´ìƒìœ¼ë¡œ ë³´ì •)
        const eff = baseLv + (lvlAddByLeveling || 0) + (skillLvAdd || 0);
        return Math.max(1, eff);
      }

      // â˜… D) ìµœì¢… ë°ë¯¸ì§€: (ì„ í˜• ë°ë¯¸ì§€ at íš¨ê³¼ì  ë ˆë²¨) Ã— (TP ë°°ìœ¨) Ã— (ë£¬ ë°°ìœ¨)
      function calcSkillDamageWithTp(skill, baseTpLv) {
        // 1) ì´ˆ ë‹¨ìœ„ ì¿¨ ê³„ì‚° (â˜… ìˆœì„œ ì¤‘ìš”)
        const cdBase = (typeof toSec === 'function') ? toSec(skill.cd) : Number(skill.cd || 0);

        // â˜… (A) 'ì¿¨íƒ€ì„ê³ ì •ê°ì†Œ'(ì´ˆ) â€” ê°€ì¥ ë¨¼ì € ì ìš©
        const excCdFlat = Number(__EXC?.addCdFlat?.[skill.id] || 0);
        const cdAfterFlat = (cdBase > 0) ? Math.max(0, cdBase - excCdFlat) : 0;

        // â˜… (B) í—ˆìƒë£¬/ë£¬ ë³´ì • â€” ê³ ì •ê°ì†Œ ì ìš©ëœ ê°’ì— ëŒ€í•´ ìˆ˜í–‰
        let cdFinal = (cdAfterFlat > 0) ? runeCooldown(skill, cdAfterFlat) : 0;

        // â˜… (C) 'ì¿¨íƒ€ì„ê°ì†Œ'(%) â€” ê·¸ ë‹¤ìŒ ê³±
        const excCdPct = Number(__EXC?.addCdPct?.[skill.id] || 0);
        if (cdFinal > 0 && excCdPct) {
          cdFinal *= Math.max(0, 1 - excCdPct / 100);
        }

        // â˜… (D) 'ì¿¨ì´ˆí™•ë¥ '(%) â€” ê¸°ëŒ€ê°’ ê·¼ì‚¬
        const resetPct = Math.max(0, Math.min(100, Number(__EXC?.resetPct?.[skill.id] || 0)));
        if (cdFinal > 0 && resetPct) {
          cdFinal *= (1 - resetPct / 100);
        }

        // ìµœì¢… ë°°ìˆ˜(ì›ë˜ ê¸°ë³¸ ì¿¨ ëŒ€ë¹„)
        const cdMul = (cdBase > 0) ? (cdFinal / cdBase) : 1;

        // 2) ì‹œì „ í”„ë ˆì„
        const castFrames = Number(skill.castFrames || 0);

        // 3) ìœ íš¨ ìŠ¤í‚¬ ë ˆë²¨
        let effLv = effectiveSkillLevelForDamage(skill);     // â† (A) let ìœ¼ë¡œ ë³€ê²½ (ë³´ì • ìœ„í•´)
        const kindNorm = String(skill?.kind || 'ìŠ¤í‚¬').trim();

        // â˜… ì˜µì…˜ B: í‰íƒ€(ë˜ëŠ” ì—°ê²°í‰íƒ€)ëŠ” ë ˆë²¨ ë¯¸ì§€ì •ì´ì–´ë„ 1ë ˆë²¨ë¡œ ë³´ì •
        if (effLv === 0 && (kindNorm === 'í‰íƒ€' || kindNorm === 'ì—°ê²°í‰íƒ€' || kindNorm.startsWith('í‰íƒ€'))) {
          effLv = 1;
        }
        if (effLv === 0) {
          return {
            per: 0,
            flat: 0,
            lv: 0,
            tpLv: 0,
            tpIncPercent: 0,
            runeMul: 1,
            cdBase,
            cdFinal,
            cdMul,
            castFrames,
            dps: 0,            // â˜… ì¡°ê¸° ë¦¬í„´ì—ë„ dps ëª…ì‹œ
            uses: 0,           // â˜… ì‹œë®¬ í›„ ë®ì–´ì”€
            kind: kindNorm,
          };
        }

        // 4) ì„ í˜• ë°ë¯¸ì§€ ê¸°ë°˜
        const base = calcSkillDamageLinear(skill, effLv); // {per, flat, lv}

        // 5) TP (TP 0ì´ë©´ ê¸°êµë£¬ ë¬´íš¨ ê·œì¹™ ìœ ì§€)

        // ê¸°ì¡´ íŒ¨í„´ ìœ ì§€: ìˆ˜ë™ TPëŠ” 0~5
        const tpBase = Math.max(0, Math.min(5, Number(state.skillTpLv?.[skill.id] ?? 0)));

        // ì˜ˆì™¸ ê·œì¹™ì—ì„œ ì˜¨ tpë ˆë²¨ ë³´ë„ˆìŠ¤
        const tpExc = Number(__EXC?.addTp?.[skill.id] || 0);

        // â˜… ë³´ë„ˆìŠ¤ì— ì–¹ì–´ì£¼ê¸° (ìˆ˜ë™ TP>0ì¼ ë•Œë§Œ ë£¬/ë³´ë„ˆìŠ¤ ì ìš© ê·œì¹™ ìœ ì§€)
        const tpBonus = (tpBase > 0) ? (getTpBonusFromSources(skill.id) + tpExc) : 0;

        // ìµœì¢… TP 0~7
        const tpLv = Math.max(0, Math.min(7, tpBase + tpBonus));

        const tpPct = tpIncreasePercent(Number(skill.tpCost || 0), tpLv);
        const tpMul = 1 + (tpPct / 100);

        // 6) ë£¬ ë°°ìˆ˜
        const rMul = runeDamageMultiplier(skill);

        // 7) ìµœì¢… per/flat ë¨¼ì € ì‚°ì¶œ
        let per = (base.per || 0) * tpMul * rMul;
        let flat = (base.flat || 0) * tpMul * rMul;

        // â˜… ì˜ˆì™¸: ë°ë¯¸ì§€ì¦ê°€(%) ì ìš© (ì—¬ëŸ¬ ì¤„ í•©ì‚° â†’ 1 + í•©ê³„/100)
        const excDmgPct = Number(__EXC?.addDmgPct?.[skill.id] || 0);
        if (excDmgPct) {
          const m = 1 + excDmgPct / 100;
          per *= m;
          flat *= m;
        }

        // 8) ì´ì œ dps ê³„ì‚° (ê³ ë€ ì œì™¸, perë§Œ)
        const dps = cdFinal > 0 ? (per / cdFinal) : 0;

        // 9) ë°˜í™˜
        return {
          per,
          flat,
          lv: base.lv,
          tpLv,
          tpIncPercent: tpPct,
          runeMul: rMul,
          cdBase,
          cdFinal,
          cdMul,
          castFrames,
          dps,            // â˜… ì—¬ê¸°ì„œ ì •ì˜ëœ dps ì‚¬ìš©
          uses: 0,        // â˜… ì‹œë®¬ í›„ ë®ì–´ì”€
          kind: kindNorm,
        };
      }

      /* ===== Uses ì‹œë®¬ë ˆì´í„°(ë°±ì—”ë“œ í˜¸ì¶œ) ===== */
      (function () {
        function getTimeKey() {
          const el = document.getElementById('selTime');
          const v = el?.value || '';
          return v || '1m';
        }
        function currentOwnerKey() {
          const k = (typeof currentSkillOwnerKey === 'function' ? currentSkillOwnerKey() : null)
            ?? [state.currentCharacter?.jobGroupLabel, state.currentCharacter?.name].filter(Boolean).join('');
          return String(k || '').replace(/\s+/g, '');
        }
        async function simulateSkillUsage() {
          const token = await waitForIdToken();
          // 1) ìš°ì„  í•©ì‚° ê°’ì—ì„œ ì‹œë„
          let ownerKey = String(state?.CurrentSumStats?.ownerKey || '').trim();

          // 2) ì—†ìœ¼ë©´ ìºë¦­í„° ì„ íƒê°’ìœ¼ë¡œ ë³´ê°•
          if (!ownerKey) {
            const k = [state.currentCharacter?.jobGroupLabel, state.currentCharacter?.name]
              .filter(Boolean).join('');
            ownerKey = k.replace(/\s+/g, '');
          }

          // 3) ì—¬ì „íˆ ì—†ìœ¼ë©´ í•©ì‚° í•œ ë²ˆ ê°±ì‹ í•´ì„œ í™•ë³´
          if (!ownerKey) {
            //try { await recalcAndRenderPanel(); } catch (_) { }
            ownerKey = String(state?.CurrentSumStats?.ownerKey || '').trim();
          }
          const payload = { ownerKey, window: getTimeKey() };

if (ownerKey === 'ì›Œë¦¬ì–´ì™€ì¼ë“œë² ì¸') {
  payload.wildbaneTreePreset = state.wildbaneTreePreset || 'íŒŒíŒŒì´ˆ';

  // âœ… ì‚¬ì´í´ íšŸìˆ˜(í”„ë¡ íŠ¸ ì…ë ¥ê°’)ë„ ê°™ì´ ë³´ëƒ„
  const cc = Math.max(0, Math.floor(Number(state.wildbaneCycleCount || 0)));
  payload.wildbaneCycleCount = cc;
  payload.wildbaneCycleEnabled = (cc > 0); // ì²´í¬ë°•ìŠ¤ ì—†ìœ¼ë‹ˆ 0ì´ë©´ false
}
if (ownerKey === 'ì›Œë¦¬ì–´ìœˆë“œì‹œì–´') {
  // í”„ë¦¬ì…‹(íŠ¸ë¦¬A/B/C)
  payload.windshearTreePreset = state.windshearTreePreset || 'íŠ¸ë¦¬A';

  // âœ… ì‚¬ì´í´ íšŸìˆ˜(í”„ë¡ íŠ¸ ì…ë ¥ê°’)ë„ ê°™ì´ ë³´ëƒ„
  const cc = Math.max(0, Math.floor(Number(state.windshearCycleCount || 0)));
  payload.windshearCycleCount = cc;
  payload.windshearCycleEnabled = (cc > 0); // ì²´í¬ë°•ìŠ¤ ì—†ìœ¼ë‹ˆ 0ì´ë©´ false
}

const j = await apiJSON('skill_uses', payload);



          if (j?.ok) {
            // â‘  ì›ë³¸ usesë¥¼ ë³´ê´€ (í‰íƒ€/ì—°ê²°í‰íƒ€ í¬í•¨)
            state.lastUses = j.uses || {};
            //state.lastDamage = j.damage || {};
            // ì„œë²„ ê²°ê³¼ â†’ state.skillDmg[].uses ë°˜ì˜
            for (const s of (ST2.rows || [])) {
              state.skillDmg[s.id] ||= {};
              state.skillDmg[s.id].uses = Number(j.uses?.[s.name] || 0);
            }
            //state.skillSimLog = Array.isArray(j.log) ? j.log : [];
          }
        }
        // (A) ëª¨ë“  ê²°ê³¼(í‰íƒ€/ì—°ê²°í‰íƒ€ í¬í•¨)ë¥¼ ê·¸ëŒ€ë¡œ í‘œë¡œ ë³´ê¸°
        window.printUses = function () {
          const u = state?.lastUses || {};
          const rows = Object.entries(u).map(([name, uses]) => ({ name, uses }));
          if (!rows.length) { console.log('[uses] ë¹ˆ ê²°ê³¼'); return; }
          rows.sort((a, b) => b.uses - a.uses);
          console.table(rows);
        };
        // (B) í”„ë ˆì„ ë¡œê·¸ ìš”ì•½ (ìˆìœ¼ë©´)
        window.printSkillSimLog = function () {
          const L = state?.skillSimLog || [];
          if (!L.length) {
            //console.log('[SIM] ë¡œê·¸ ì—†ìŒ'); 
            return;
          }
          for (const row of L) {
            //console.log(`[f=${row.fStart}~${row.fEnd}] ì‚¬ìš©: [${row.kind}] ${row.name}`);
          }
          // ìš”ì•½: lastUses ê¸°ì¤€(í‰íƒ€ í¬í•¨)
          window.printUses?.();
        };
        window.simulateSkillUsage = simulateSkillUsage;
        window.getTimeKey = getTimeKey;

        // ì‹œê°„ì°½ ë³€ê²½ ì‹œ ì¬ì‹œë®¬
        document.getElementById('selTime')?.addEventListener('change', () => {
          queueMicrotask(simulateSkillUsage);
        });
        // ì´ˆê¸° ì„ íƒê°’ ë³´ì • + 1íšŒ ì‹¤í–‰
        const el = document.getElementById('selTime');
        if (el && !el.value) el.value = '1m';
        simulateSkillUsage();
      })();




      let __monsterApplyingDefault = false;
      // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì‹œ í˜¸ì¶œ
      async function onMonsterChange() {
        const sel = document.getElementById('selMonster');
        const name = sel?.value || 'ê±°ëŒ€ëˆ„ê³¨';

        // 1) ì„œë²„ í˜¸ì¶œ ì—†ì´, ë¡œì»¬ stateì—ë§Œ ë°˜ì˜
        window.state = window.state || {};
        state.monster = { name };

        // 2) í•©ì‚° ìŠ¤íƒ¯(sum_stats)ì€ ëª¬ìŠ¤í„°ì™€ ë¬´ê´€í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ ì„œë²„ í˜¸ì¶œì€ í•˜ì§€ ì•ŠëŠ”ë‹¤.
        //    ìµœì¢… ë°ë¯¸ì§€ ê³„ì‚° ì‹œ computeViaBackendì—ì„œ ì´ state.monsterë¥¼ ì„œë²„ ì„¸ì…˜(s.MonStats)ì— ë°˜ì˜í•œë‹¤.
      }

      /* ì„ íƒëœ ì‹œíŠ¸ ì•„ì´í…œ(ìŠ¤íƒ¯ ë¬¶ìŒ) ë³´ê´€ ìŠ¬ë¡¯ */
      state.options.avatarEnh = state.options.avatarEnh || null; // {name,type,img,stats...}
      state.options.imprintEnh = state.options.imprintEnh || null;
      /* ëª¬ìŠ¤í„° ì„ íƒ ê²°ê³¼ ì €ì¥ ìŠ¬ë¡¯(ì •ë³´/ì €í•­ ë“±) */
      state.monster = state.monster || null; // { name, info, stats, raw }
      // ìŠ¬ë¡¯ í‚¤ ë§¤í•‘
      const SLOT_MAP = {    //ìŠ¬ë¡¯ ì•½ì–´, ì‚¬ìš©í• ë• SLOT_MAP["L1"]; ì²˜ëŸ¼ ì”€
        L1: 'headshoulder', L2: 'top', L3: 'bottom', L4: 'belt', L5: 'shoes',
        R1: 'weapon', R2: 'bracelet', R3: 'necklace', R4: 'ring', R5: 'sub',
        C1: 'aura', C2: 'title', C3: 'creature', C4: 'artifact', L6: 'earring', R6: 'magestone'
      };
      window.SLOT_MAP = SLOT_MAP;   // ë¸Œë¼ìš°ì € ì „ì—­ ê°ì²´, SLOT_MAPì„ ì „ì—­ ë³€ìˆ˜ë¡œ ë“±ë¡ = ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì´ë‚˜ ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥

      const ALLOWED_WEAPON_TYPES = {
        slayer: ['ì†Œê²€', 'ë„', 'ë‘”ê¸°', 'ëŒ€ê²€', 'ê´‘ê²€'],
        gunner: ['ë¦¬ë³¼ë²„', 'ìë™ê¶Œì´', 'ë¨¸ìŠ¤ì¼“', 'í•¸ë“œìºë„Œ', 'ë³´ìš°ê±´'],
        fighter: ['ë„ˆí´', 'ê±´í‹€ë¦¿', 'í´ë¡œ', 'ê¶Œíˆ¬ê¸€ëŸ¬ë¸Œ', 'í†µíŒŒ'],
        priest: ['ì‹­ìê°€', 'ì—¼ì£¼', 'í† í…œ', 'ë‚«', 'ë°°í‹€ì•¡ìŠ¤'],
        warrior: ['ë½ì†Œë“œ', 'ìœ™ë¸”ë ˆì´ë“œ'],
        mage: ['ìŠ¤íƒœí”„', 'ë¡œë“œ', 'ë´‰', 'ì°½', 'ë¹—ìë£¨'],
        spear: ['ë¯¸ëŠ˜ì°½', 'íˆ¬ì°½'],
        thief: ['ë‹¨ê²€', 'ìŒê²€', 'ì°¨í¬ë¼ì›¨í€']
      };

      /* ===== ìœ í‹¸ ===== */
      const num = v => (v === '' || v == null ? 0 : Number(v));
      const pct = v => { if (v === '' || v == null) return 0; const s = String(v).trim().replace('%', ''); const n = Number(s); return isNaN(n) ? 0 : n / 100; };
      const list = v => (v ? String(v).replaceAll(';', ',').split(',').map(s => s.trim()).filter(Boolean) : []);
      const normalizeJobGroup = (s) => {
        s = (s || '').toLowerCase();
        if (['ë‚¨ê·€ê²€ì‚¬', 'ì—¬ê·€ê²€ì‚¬', 'ê·€ê²€ì‚¬', 'slayer'].some(k => s.includes(k))) return 'slayer';
        if (['ë§ˆë²•ì‚¬', 'ì—¬ë§ˆë²•ì‚¬', 'ë‚¨ë§ˆë²•ì‚¬', 'mage'].some(k => s.includes(k))) return 'mage';
        if (['ë‚¨ê±°ë„ˆ', 'ì—¬ê±°ë„ˆ'].some(k => s.includes(k))) return 'gunner';
        if (['ê²©íˆ¬ê°€', 'ë‚¨ê²©íˆ¬ê°€', 'ì—¬ê²©íˆ¬ê°€'].some(k => s.includes(k))) return 'fighter';
        if (['í”„ë¦¬ìŠ¤íŠ¸', 'ì—¬í”„ë¦¬ìŠ¤íŠ¸', 'ë‚¨í”„ë¦¬ìŠ¤íŠ¸'].some(k => s.includes(k))) return 'priest';
        if (['ì›Œë¦¬ì–´'].some(k => s.includes(k))) return 'warrior';
        if (['ë§ˆì°½ì‚¬'].some(k => s.includes(k))) return 'spear';
        if (['ë„ì '].some(k => s.includes(k))) return 'thief';
        return s || 'slayer';
      };
      const normalizePower = (s) => {     //ë¬¼ ì„ phys ë¡œ ë³€ê²½, ë§ˆ ë¥¼ mag ë¡œ ë³€ê²½
        s = (s || '').toLowerCase();
        if (['ë¬¼', 'phys', 'str', 'physical'].some(k => s.includes(k))) return 'phys';
        if (['ë§ˆ', 'mag', 'int', 'magic', 'ë§ˆë²•'].some(k => s.includes(k))) return 'mag';
        return null;
      };
      const powerLabel = (p) => p === 'phys' ? 'ë¬¼ë¦¬' : p === 'mag' ? 'ë§ˆë²•' : 'ë¬¼ë¦¬/ë§ˆë²•';   // phys ë¥¼ ë¬¼ë¦¬ ë¡œ ë³€ê²½, magë¥¼ ë§ˆë²•, ?(ì´ë©´), :(ì•„ë‹ˆë©´) ë”°ë¼ì„œ pê°€ phys ì´ë©´ ë¬¼ë¦¬, ì•„ë‹ˆë©´ pê°€ mag ì´ë©´ ë§ˆë²• ì•„ë‹ˆë©´ ë¬¼ë¦¬/ë§ˆë²•

      // ëª¨ë“  PLACEHOLDERë¥¼ ê³µí†µ ì´ë¯¸ì§€ë¡œ êµì²´
      const PLACEHOLDER_IMG = 'img/gametestlab.png';

      // âœ… ë°©ì–´êµ¬ ì„¸íŠ¸: CORE.lists['set:list'] + ê° ë¶€ìœ„ ì‹œíŠ¸ì—ì„œ ì•„ì´ì½˜/ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
      function buildArmorSetCardsFromSheets() {
        // í˜„ì¬ í† ê¸€ ìƒíƒœ (ê¸°ë³¸ê°’ì€ ìµì‹œë“œ)
        const mode = (typeof armorSetMode === 'string') ? armorSetMode : 'exceed';
        // --- CORE.lists ì ‘ê·¼ ---
        const lists = (function _coreRoot() {
          const core =
            (window.CORE && (window.CORE.data || window.CORE)) ||
            (window.CORE_DATA && (window.CORE_DATA.data || window.CORE_DATA)) ||
            null;
          return core ? (core.lists || {}) : null;
        })();
        if (!lists) return [];

        // 1) ì„¸íŠ¸ ì‹œíŠ¸ ë¡œìš°ë“¤
        let setRows = lists['set:list'];
        if (setRows && typeof setRows === 'object' && Array.isArray(setRows.rows)) {
          setRows = setRows.rows;
        }
        if (!Array.isArray(setRows)) setRows = [];

        const norm = (v) => String(v ?? '').trim();
        const toNum = (v) => {
          const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
          return Number.isFinite(n) ? n : 0;
        };

        // 2) ë°©ì–´êµ¬ ì„¸íŠ¸ë§Œ type ê¸°ì¤€ìœ¼ë¡œ ëŒ€í‘œ 1ê°œì”© ë½‘ê¸° (ë³´í†µ 5ì„¸íŠ¸ í–‰)
        const armorSetByType = new Map(); // type -> { type, name, num }

        for (const r of setRows) {
          const category = norm(r.category || r['ë¶„ë¥˜'] || '');
          const armp = toNum(r.armpoint);

          // ë°©ì–´êµ¬ ì„¸íŠ¸ë§Œ ëŒ€ìƒìœ¼ë¡œ
          if (!category && !armp) continue;
          if (category && category !== 'ë°©ì–´êµ¬') continue;

          const type = norm(r.type);
          if (!type) continue;

          const rarity = norm(r.rarity || r['ë ˆì–´ë¦¬í‹°'] || '');
          const num = toNum(r.num);
          const name = norm(r.name || r['ì´ë¦„'] || type);

          const prev = armorSetByType.get(type);
          if (!prev || num > prev.num) {
            armorSetByType.set(type, { type, name, num, rarity });
          }
        }


        if (!armorSetByType.size) return [];

        // 3) ê° ë¶€ìœ„ ì‹œíŠ¸ì—ì„œ, í•´ë‹¹ ì„¸íŠ¸ type ê³¼ ê°™ì€ 'ì¢…ë¥˜' ë¥¼ ê°€ì§„ ì¥ë¹„ ì°¾ê¸°
        const slotKeys = ['top', 'bottom', 'headshoulder', 'belt', 'shoes'];

        // itemModal ìª½ì—ì„œ ì“°ëŠ” í—¬í¼ ì¬ì‚¬ìš©
        function _getListArray(slotKey) {
          const lists2 =
            (window.CORE && (window.CORE.data || window.CORE)?.lists) ||
            (window.CORE_DATA && (window.CORE_DATA.data || window.CORE_DATA)?.lists) ||
            null;
          if (!lists2) return [];
          const key1 = `${slotKey}:list`;
          const key2 = `${slotKey}:lists`;
          const key3 = slotKey;
          let arr = lists2[key1] ?? lists2[key2] ?? lists2[key3] ?? [];
          if (arr && typeof arr === 'object' && Array.isArray(arr.rows)) arr = arr.rows;
          return Array.isArray(arr) ? arr : [];
        }

        function _mapEquipRow(row) {
          const S = (v) => (v == null ? '' : String(v));
          const N = (v) => {
            const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
            return Number.isFinite(n) ? n : 0;
          };
          const ì´ë¦„ = row['ì´ë¦„'] ?? row.name ?? row.title ?? '';
          const ì¢…ë¥˜ = row['ì¢…ë¥˜'] ?? row.type ?? row.category ?? '';
          const ë ™ì œ = row['ë ˆë²¨ì œí•œ'] ?? row['ë ™ì œ'] ?? row.level ?? row.reqLevel ?? 0;
          const ì´ë¯¸ì§€ = row['ì´ë¯¸ì§€'] ?? row.image ?? row.img ?? '';
          const ë ˆì–´ë¦¬í‹° = row['ë ˆì–´ë¦¬í‹°'] ?? row.rarity ?? '';
          return {
            name: S(ì´ë¦„),
            type: S(ì¢…ë¥˜),
            level: N(ë ™ì œ),
            img: S(ì´ë¯¸ì§€),
            rarity: S(ë ˆì–´ë¦¬í‹°),
            _raw: row,
          };
        }

        const equipBySlot = {};
        for (const slotKey of slotKeys) {
          equipBySlot[slotKey] = _getListArray(slotKey).map(_mapEquipRow);
        }

        // 4) ì„¸íŠ¸ë³„ ì¹´ë“œ ë°ì´í„° êµ¬ì„±
        const cards = [];

        armorSetByType.forEach((info, typeKey) => {
          const pieces = [];

          for (const slotKey of slotKeys) {
            const rows = equipBySlot[slotKey] || [];

            let row;

            if (mode === 'epic') {
              // âœ… ì—í”½ ëª¨ë“œ: ì¢…ë¥˜ê°€ ì„¸íŠ¸ type ì´ê³ , ë ˆì–´ë¦¬í‹°ê°€ 'ì—í”½' ì¸ ì¥ë¹„ ìš°ì„  ì„ íƒ
              row = rows.find(
                (r) =>
                  norm(r.type) === norm(typeKey) &&
                  norm(r.rarity || r['ë ˆì–´ë¦¬í‹°']) === 'ì—í”½'
              );

              // í˜¹ì‹œ ì—í”½ ì¥ë¹„ê°€ ì—†ìœ¼ë©´(ë°ì´í„° ëˆ„ë½ ë“±) ê·¸ëƒ¥ ì¢…ë¥˜ë§Œ ë§ëŠ” ì²« ì¥ë¹„ë¡œ fallback
              if (!row) {
                row = rows.find((r) => norm(r.type) === norm(typeKey));
              }
            } else {
              // âœ… ìµì‹œë“œ ëª¨ë“œ: ê¸°ì¡´ê³¼ ë™ì¼ (ì¢…ë¥˜ë§Œ ë§ìœ¼ë©´ ì‚¬ìš©)
              row = rows.find((r) => norm(r.type) === norm(typeKey));
            }

            if (row) {
              pieces.push({
                slot: slotKey,
                name: row.name,
                level: row.level,
                img: row.img || PLACEHOLDER_IMG,
                rarity: row.rarity,
                item: row,              // â˜… ì‹¤ì œ ì¥ë¹„ ê°ì²´ ì €ì¥
              });
            } else {
              pieces.push({
                slot: slotKey,
                name: '',
                level: null,
                img: PLACEHOLDER_IMG,
                rarity: '',
                item: null,             // ì—†ìœ¼ë©´ null
              });
            }
          }

          cards.push({
            id: typeKey,
            type: typeKey,
            name: info.name,
            num: info.num,
            pieces,
          });
        });

        // ë³´ê¸° ì¢‹ê²Œ ì„¸íŠ¸ ì´ë¦„ ìˆœ ì •ë ¬
        //cards.sort((a, b) => a.name.localeCompare(b.name, 'ko'));

        // ë””ë²„ê·¸ìš©ìœ¼ë¡œ í•œ ë²ˆ ë³¼ ìˆ˜ ìˆê²Œ
        window._debugArmorSets = cards;

        return cards;
      }

      // âœ… ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸: CORE.lists['set:list'] + íŒ”ì°Œ/ëª©ê±¸ì´/ë°˜ì§€ ì‹œíŠ¸ì—ì„œ ì•„ì´ì½˜/ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
      function buildAccSetCardsFromSheets() {
        const mode = (typeof armorSetMode === 'string') ? armorSetMode : 'exceed';

        const lists = (function _coreRoot() {
          const core =
            (window.CORE && (window.CORE.data || window.CORE)) ||
            (window.CORE_DATA && (window.CORE_DATA.data || window.CORE_DATA)) ||
            null;
          return core ? (core.lists || {}) : null;
        })();
        if (!lists) return [];

        // 1) ì„¸íŠ¸ ì‹œíŠ¸
        let setRows = lists['set:list'];
        if (setRows && typeof setRows === 'object' && Array.isArray(setRows.rows)) {
          setRows = setRows.rows;
        }
        if (!Array.isArray(setRows)) setRows = [];

        const norm = (v) => String(v ?? '').trim();
        const toNum = (v) => {
          const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
          return Number.isFinite(n) ? n : 0;
        };

        // 2) ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ë§Œ type ê¸°ì¤€ìœ¼ë¡œ ëŒ€í‘œ 1ê°œì”© ë½‘ê¸°
        const accSetByType = new Map(); // type -> { type, name, num }

        for (const r of setRows) {
          const category = norm(r.category || r['ë¶„ë¥˜'] || '');
          const acp = toNum(r.accpoint); // ì•…ì„¸ í¬ì¸íŠ¸

          // ë¶„ë¥˜ê°€ 'ì•…ì„¸ì‚¬ë¦¬' ì´ê±°ë‚˜, accpoint ê°€ ìˆëŠ” í–‰ë§Œ ì•…ì„¸ ì„¸íŠ¸ ì·¨ê¸‰
          if (!category && !acp) continue;
          if (category && category !== 'ì•…ì„¸') continue;

          const type = norm(r.type);
          if (!type) continue;

          const rarity = norm(r.rarity || r['ë ˆì–´ë¦¬í‹°'] || '');
          const num = toNum(r.num);
          const name = norm(r.name || r['ì´ë¦„'] || type);

          const prev = accSetByType.get(type);
          if (!prev || num > prev.num) {
            accSetByType.set(type, { type, name, num, rarity });
          }
        }

        if (!accSetByType.size) return [];

        // 3) ì¥ë¹„ ì‹œíŠ¸ì—ì„œ íŒ”ì°Œ/ëª©ê±¸ì´/ë°˜ì§€ ì°¾ê¸°
        const slotKeys = ['bracelet', 'necklace', 'ring'];

        function _getListArray(slotKey) {
          const lists2 =
            (window.CORE && (window.CORE.data || window.CORE)?.lists) ||
            (window.CORE_DATA && (window.CORE_DATA.data || window.CORE_DATA)?.lists) ||
            null;
          if (!lists2) return [];
          const key1 = `${slotKey}:list`;
          const key2 = `${slotKey}:lists`;
          const key3 = slotKey;
          let arr = lists2[key1] ?? lists2[key2] ?? lists2[key3] ?? [];
          if (arr && typeof arr === 'object' && Array.isArray(arr.rows)) arr = arr.rows;
          return Array.isArray(arr) ? arr : [];
        }

        function _mapEquipRow(row) {
          const S = (v) => (v == null ? '' : String(v));
          const N = (v) => {
            const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
            return Number.isFinite(n) ? n : 0;
          };
          const ì´ë¦„ = row['ì´ë¦„'] ?? row.name ?? row.title ?? '';
          const ì¢…ë¥˜ = row['ì¢…ë¥˜'] ?? row.type ?? row.category ?? '';
          const ë ™ì œ = row['ë ˆë²¨ì œí•œ'] ?? row['ë ™ì œ'] ?? row.level ?? row.reqLevel ?? 0;
          const ì´ë¯¸ì§€ = row['ì´ë¯¸ì§€'] ?? row.image ?? row.img ?? '';
          const ë ˆì–´ë¦¬í‹° = row['ë ˆì–´ë¦¬í‹°'] ?? row.rarity ?? '';
          return {
            name: S(ì´ë¦„),
            type: S(ì¢…ë¥˜),
            level: N(ë ™ì œ),
            img: S(ì´ë¯¸ì§€),
            rarity: S(ë ˆì–´ë¦¬í‹°),
            _raw: row,
          };
        }

        const equipBySlot = {};
        for (const slotKey of slotKeys) {
          equipBySlot[slotKey] = _getListArray(slotKey).map(_mapEquipRow);
        }

        const cards = [];

        accSetByType.forEach((info, typeKey) => {
          const pieces = [];

          for (const slotKey of slotKeys) {
            const rows = equipBySlot[slotKey] || [];
            let row;

            if (mode === 'epic') {
              // ì—í”½ ëª¨ë“œ: ì¢…ë¥˜ + ë ˆì–´ë¦¬í‹° 'ì—í”½' ìš°ì„ 
              row = rows.find(
                (r) =>
                  norm(r.type) === norm(typeKey) &&
                  norm(r.rarity || r['ë ˆì–´ë¦¬í‹°']) === 'ì—í”½'
              );
              if (!row) {
                row = rows.find((r) => norm(r.type) === norm(typeKey));
              }
            } else {
              // ìµì‹œë“œ ëª¨ë“œ: ì¢…ë¥˜ë§Œ ë§ìœ¼ë©´ OK
              row = rows.find((r) => norm(r.type) === norm(typeKey));
            }

            if (row) {
              pieces.push({
                slot: slotKey,
                name: row.name,
                level: row.level,
                img: row.img || PLACEHOLDER_IMG,
                rarity: row.rarity,
                item: row,
              });
            } else {
              pieces.push({
                slot: slotKey,
                name: '',
                level: null,
                img: PLACEHOLDER_IMG,
                rarity: '',
                item: null,
              });
            }
          }

          cards.push({
            id: typeKey,
            type: typeKey,
            name: info.name,
            num: info.num,
            pieces,
          });
        });

        // ì‹œíŠ¸ ìˆœì„œ ìœ ì§€ (ì •ë ¬ ì•ˆ í•¨)
        window._debugAccSets = cards;
        return cards;
      }

// âœ… íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸: set:list + sub / magestone / earring
function buildSpecSetCardsFromSheets() {
  const mode = (typeof armorSetMode === 'string') ? armorSetMode : 'exceed';

  const lists = (function _coreRoot() {
    const core =
      (window.CORE && (window.CORE.data || window.CORE)) ||
      (window.CORE_DATA && (window.CORE_DATA.data || window.CORE_DATA)) ||
      null;
    return core ? (core.lists || {}) : null;
  })();
  if (!lists) return [];

  let setRows = lists['set:list'];
  if (setRows && typeof setRows === 'object' && Array.isArray(setRows.rows)) {
    setRows = setRows.rows;
  }
  if (!Array.isArray(setRows)) setRows = [];

  const norm = (v) => String(v ?? '').trim();
  const toNum = (v) => {
    const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
    return Number.isFinite(n) ? n : 0;
  };

  const specSetByType = new Map();

  for (const r of setRows) {
    const categoryRaw = r.category ?? r['ë¶„ë¥˜'] ?? '';
    const category = norm(categoryRaw);
    const categoryNoSpace = category.replace(/\s+/g, '');

    const subp = toNum(r.subpoint || r['subpoint'] || r['íŠ¹ìˆ˜ì¥ë¹„í¬ì¸íŠ¸'] || 0);

    // âœ… ë¶„ë¥˜ì— 'íŠ¹ìˆ˜', 'ë³´ì¡°', 'ë§ˆë²•ì„', 'ê·€ê±¸ì´' í¬í•¨ ë˜ëŠ” íŠ¹ìˆ˜ì¥ë¹„í¬ì¸íŠ¸ê°€ ìˆìœ¼ë©´ íŠ¹ìˆ˜ì„¸íŠ¸ë¡œ ì·¨ê¸‰
    const isSpecCategory =
      categoryNoSpace.includes('íŠ¹ìˆ˜') ||
      categoryNoSpace.includes('ë³´ì¡°') ||
      categoryNoSpace.includes('ë§ˆë²•ì„') ||
      categoryNoSpace.includes('ê·€ê±¸ì´');

    if (!isSpecCategory && !subp) continue;

    const type = norm(r.type);
    if (!type) continue;

    const rarity = norm(r.rarity || r['ë ˆì–´ë¦¬í‹°'] || '');
    const num = toNum(r.num);
    const name = norm(r.name || r['ì´ë¦„'] || type);

    const prev = specSetByType.get(type);
    if (!prev || num > prev.num) {
      specSetByType.set(type, { type, name, num, rarity });
    }
  }

  if (!specSetByType.size) return [];

  // âœ… íŠ¹ìˆ˜ì¥ë¹„ ìŠ¬ë¡¯ í‚¤: ë³´ì¡° / ë§ˆë²•ì„ / ê·€ê±¸ì´
  const slotKeys = ['sub', 'magestone', 'earring'];

  function _getListArray(slotKey) {
    const core =
      (window.CORE && (window.CORE.data || window.CORE)) ||
      (window.CORE_DATA && (window.CORE_DATA.data || window.CORE_DATA)) ||
      null;
    const lists2 = core ? (core.lists || {}) : {};
    let arr =
      lists2[`${slotKey}:list`] ??
      lists2[`${slotKey}:lists`] ??
      lists2[slotKey] ??
      [];
    if (arr && typeof arr === 'object' && Array.isArray(arr.rows)) arr = arr.rows;
    return Array.isArray(arr) ? arr : [];
  }

  function _mapEquipRow(row) {
    const S = (v) => (v == null ? '' : String(v));
    const N = (v) => {
      const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
      return Number.isFinite(n) ? n : 0;
    };
    const ì´ë¦„ = row['ì´ë¦„'] ?? row.name ?? row.title ?? '';
    const ì¢…ë¥˜ = row['ì¢…ë¥˜'] ?? row.type ?? row.category ?? '';
    const ë ™ì œ = row['ë ˆë²¨ì œí•œ'] ?? row['ë ™ì œ'] ?? row.level ?? row.reqLevel ?? 0;
    const ì´ë¯¸ì§€ = row['ì´ë¯¸ì§€'] ?? row.image ?? row.img ?? '';
    const ë ˆì–´ë¦¬í‹° = row['ë ˆì–´ë¦¬í‹°'] ?? row.rarity ?? '';
    return {
      name: S(ì´ë¦„),
      type: S(ì¢…ë¥˜),
      level: N(ë ™ì œ),
      img: S(ì´ë¯¸ì§€),
      rarity: S(ë ˆì–´ë¦¬í‹°),
      _raw: row,
    };
  }

  const equipBySlot = {};
  for (const slotKey of slotKeys) {
    equipBySlot[slotKey] = _getListArray(slotKey).map(_mapEquipRow);
  }

  const cards = [];

  specSetByType.forEach((info, typeKey) => {
    const pieces = [];

    for (const slotKey of slotKeys) {
      const rows = equipBySlot[slotKey] || [];
      let row;

      if (mode === 'epic') {
        // ì—í”½ ëª¨ë“œ: ì¢…ë¥˜ + ë ˆì–´ë¦¬í‹° 'ì—í”½' ìš°ì„ 
        row = rows.find(
          (r) =>
            norm(r.type) === norm(typeKey) &&
            norm(r.rarity || r['ë ˆì–´ë¦¬í‹°']) === 'ì—í”½'
        );
        if (!row) {
          row = rows.find((r) => norm(r.type) === norm(typeKey));
        }
      } else {
        // ìµì‹œë“œ ëª¨ë“œ: ì¢…ë¥˜ë§Œ ë§ìœ¼ë©´ OK
        row = rows.find((r) => norm(r.type) === norm(typeKey));
      }

      if (row) {
        pieces.push({
          slot: slotKey,
          name: row.name,
          level: row.level,
          img: row.img || PLACEHOLDER_IMG,
          rarity: row.rarity,
          item: row,
        });
      } else {
        pieces.push({
          slot: slotKey,
          name: '',
          level: null,
          img: PLACEHOLDER_IMG,
          rarity: '',
          item: null,
        });
      }
    }

    cards.push({
      id: typeKey,
      type: typeKey,
      name: info.name,
      num: info.num,
      pieces,
    });
  });

  window._debugSpecSets = cards;
  return cards;
}


      // âœ… ì„¸íŠ¸ ì¹´ë“œ í´ë¦­ â†’ í•´ë‹¹ ì„¸íŠ¸ì˜ 5ë¶€ìœ„ ì „ë¶€ ì ìš©
      $armorSetList?.addEventListener('click', (e) => {
        const card = e.target.closest('.armor-set-card');
        if (!card) return;

        const idx = parseInt(card.dataset.setIndex || '-1', 10);
        const sets = (window._armorSetCardsCache && Array.isArray(window._armorSetCardsCache))
          ? window._armorSetCardsCache
          : [];

        if (!(idx >= 0 && idx < sets.length)) return;

        const chosenSet = sets[idx];
        applyArmorSetToSlots(chosenSet);
      });

      $accSetList?.addEventListener('click', (e) => {
        const card = e.target.closest('.armor-set-card');
        if (!card) return;

        const idx = parseInt(card.dataset.setIndex || '-1', 10);
        const sets = (window._accSetCardsCache && Array.isArray(window._accSetCardsCache))
          ? window._accSetCardsCache
          : [];

        if (!(idx >= 0 && idx < sets.length)) return;

        const chosenSet = sets[idx];
        applyAccSetToSlots(chosenSet);
      });



      function cleanUrl(u) { if (!u) return ''; return String(u).replace(/^\s+|\s+$/g, '').replace(/^["']|["']$/g, '').replace(/\\/g, '/'); }

      /* ===== í–‰ â†’ ì•„ì´í…œ ë§¤í•‘ ===== */
      function mapRowToItem(r) {
        const pick = (...ks) => { for (const k of ks) { if (r[k] != null && String(r[k]).trim() !== '') return r[k]; } return ''; };  // ì´ê±´ ê·¸ëƒ¥ í—¬í¼ : ì²˜ìŒìœ¼ë¡œ ê°’ì´ ì œëŒ€ë¡œ ìˆëŠ” ì»¬ëŸ¼ ë°˜í™˜
        const skill_levels = [];    //ë ˆë²¨ë§(10), ë ˆë²¨ë (15) ê°™ì€ ì»¬ëŸ¼ ìˆìœ¼ë©´ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ëˆ„ì 
        [10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 65, 70, 75, 80].forEach(lv => {
          const v = Number(pick(`ë ˆë²¨ë§(${lv})`));
          if (!isNaN(v) && v !== 0) skill_levels.push({ skill_id: `LV${lv}`, delta: v });
        });
        const jgs = list(pick('ì§ì—…êµ°', 'job_groups')).map(normalizeJobGroup);    // ì§ì—…êµ° í…ìŠ¤íŠ¸ë¥¼ ë°°ì—´í™” í•˜ê³  í‘œì¤€ì½”ë“œë¡œ í†µì¼ (ê·€ê²€ì‚¬, ë‚¨ê±°ë„ˆ ë“±)
        return {        // ìµœì¢… ì•„ì´í…œ ê°ì²´ ë°˜í™˜
          id: String(r.id || r.ID || Date.now().toString(36) + Math.random().toString(36).slice(2)),
          slot: 'unknown',
          name: String(pick('ì´ë¦„', 'name')),
          img: cleanUrl(pick('ì´ë¯¸ì§€', 'img')) || PLACEHOLDER_IMG,
          job_groups: jgs,
          type: String(pick('ì¢…ë¥˜', 'type')),
          rarity: r.rarity || r.ë“±ê¸‰ || 'epic',
          rarity_kr: pick('ë“±ê¸‰') || undefined,
          level: num(pick('ë ™ì œ', 'ë ˆë²¨', 'level')) || 65,
          level_text: (() => { const v = pick('ë ™ì œ', 'ë ˆë²¨', 'level'); return (v === undefined || v === null || String(v).trim() === '') ? '' : String(v).trim(); })(),
          stats: {
            phys_atk: num(pick('ë¬¼ë¦¬ ë°ë¯¸ì§€', 'ë¬¼ë¦¬ë°ë¯¸ì§€', 'phys_atk')),
            mag_atk: num(pick('ë§ˆë²• ë°ë¯¸ì§€', 'ë§ˆë²•ë°ë¯¸ì§€', 'mag_atk')),
            str: num(pick('í˜', 'str')),
            int: num(pick('ì§€ëŠ¥', 'int')),
            acc: num(pick('ì ì¤‘', 'acc')),
            phys_crit: num(pick('ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬', 'ë¬¼ë¦¬í¬ë¦¬í‹°ì»¬', 'phys_crit')),
            mag_crit: num(pick('ë§ˆë²• í¬ë¦¬í‹°ì»¬', 'ë§ˆë²•í¬ë¦¬í‹°ì»¬', 'mag_crit')),
            phys_crit_rate: pct(pick('ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬(%)', 'phys_crit_rate%')),
            mag_crit_rate: pct(pick('ë§ˆë²• í¬ë¦¬í‹°ì»¬(%)', 'mag_crit_rate%')),
            add_damage: pct(pick('ì¶”ê°€ë°ë¯¸ì§€(%)', 'add_damage%')),
            counter_add_damage: pct(pick('ì¹´ìš´í„°ë€ì¦(%)', 'counter_add_damage%')) || pct(pick('ì¹´ìš´í„°ì¶”ë€(%)')),
            str_pct: pct(pick('í˜(%)', 'str_pct%')),
            int_pct: pct(pick('ì§€ëŠ¥(%)', 'int_pct%')),
            damage_inc: pct(pick('ë€ì¦(%)', 'damage_inc%')),
            counter_damage_inc: pct(pick('ì¹´ìš´í„°ë€ì¦(%)', 'counter_damage_inc%')),
            crit_damage_inc: pct(pick('í¬ì¦ë€(%)', 'crit_damage_inc%')),
            phys_atk_pct: pct(pick('ë¬¼ë¦¬ ê³µê²©ë ¥(%)', 'ë¬¼ë¦¬ê³µê²©ë ¥(%)', 'phys_atk_pct%')),
            mag_atk_pct: pct(pick('ë§ˆë²• ê³µê²©ë ¥(%)', 'ë§ˆë²•ê³µê²©ë ¥(%)', 'mag_atk_pct%')),
            skill_atk_inc: pct(pick('ìŠ¤ì¦(%)', 'skill_atk_inc%')),
            elem: { fire: num(pick('í™”', 'elem_fire')), water: num(pick('ìˆ˜', 'elem_water')), light: num(pick('ëª…', 'elem_light')), dark: num(pick('ì•”', 'elem_dark')), all: 0 },
            elem_add_damage: {
              fire: pct(pick('í™”ì†ì¶”', 'elem_add_fire%')),
              water: pct(pick('ìˆ˜ì†ì¶”', 'elem_add_water%')),
              light: pct(pick('ëª…ì†ì¶”', 'elem_add_light%')),
              dark: pct(pick('ì•”ì†ì¶”', 'elem_add_dark%'))
            },
            speed: { attack: pct(pick('ê³µì†', 'speed_attack%')), move: pct(pick('ì´ì†', 'speed_move%')), cast: pct(pick('ìºì†', 'speed_cast%')) },
            cdr: pct(pick('ì¿¨ê°')),
            dot_add: { poison: pct(pick('ì¤‘ë…ì¶”ë€')), bleed: pct(pick('ì¶œí˜ˆì¶”ë€')), burn: pct(pick('í™”ìƒì¶”ë€')), shock: pct(pick('ê°ì „ì¶”ë€')) },
            dot_inc: { poison: pct(pick('ì¤‘ë…ë€ì¦')), bleed: pct(pick('ì¶œí˜ˆë€ì¦')), burn: pct(pick('í™”ìƒë€ì¦')), shock: pct(pick('ê°ì „ë€ì¦')) },
            other: { def_break_inc: pct(pick('ë°©ê¹ë€ì¦')), enchant_bleed: num(pick('ì¸ì±ˆì¶œí˜ˆ')) }
          },
          effects: [],
          notes: [pick('ì„¤ëª…', 'notes1'), pick('ì„¤ëª…2', 'notes2'), pick('ì„¤ëª…3', 'notes3')].filter(Boolean),
          skill_levels,
          raw: r
        };
      }

      /* ===== ê°•í™” í–‰ ë§¤í•‘ (ì´ë¯¸ì§€/íƒœê·¸/ë‹¨ê³„ ì§€ì›) ===== */
      function mapRowToEnhance(r) {
        const get = (k) => r[k] ?? r[k?.toLowerCase()] ?? '';
        const num = (v) => (v === '' || v == null ? 0 : Number(v));
        const pct = (v) => { if (v === '' || v == null) return 0; const s = String(v).trim().replace('%', ''); const n = Number(s); return isNaN(n) ? 0 : n / 100; };
        const name = r['ì´ë¦„'] ?? r['ì˜µì…˜ëª…'] ?? r['ëª…ì¹­'] ?? r['Name'] ?? '';
        const rawType = r['ì¢…ë¥˜'] ?? r['íƒ€ì…'] ?? r['ë¶„ë¥˜'] ?? r['category'] ?? '';
        const type = (window.normalizeSealType || normalizeSealType)(rawType);
        const img = cleanUrl(get('ì´ë¯¸ì§€')) || PLACEHOLDER_IMG;
        const tag = r['íƒœê·¸'] ?? r['ë¶„ë¥˜'] ?? r['ì„¤ëª…'] ?? '';
        const level = r['ë ˆë²¨'] ?? r['ë ˆë²¨ì œí•œ'] ?? r['ë ™ì œ'] ?? '';
        const lvlMatch = name.match(/(\d+)\s*ë‹¨ê³„/);
        const level_num = lvlMatch ? parseInt(lvlMatch[1], 10) : null;

        const stats = {
          phys_atk: num(get('ë¬¼ë¦¬ ë°ë¯¸ì§€')) || num(get('ë¬¼ë¦¬ë°ë¯¸ì§€')),
          mag_atk: num(get('ë§ˆë²• ë°ë¯¸ì§€')) || num(get('ë§ˆë²•ë°ë¯¸ì§€')),
          str: num(get('í˜')), int: num(get('ì§€ëŠ¥')),
          phys_crit: num(get('ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬')) || num(get('ë¬¼ë¦¬í¬ë¦¬í‹°ì»¬')),
          mag_crit: num(get('ë§ˆë²• í¬ë¦¬í‹°ì»¬')) || num(get('ë§ˆë²•í¬ë¦¬í‹°ì»¬')),
          phys_crit_rate: pct(get('ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬(%)')),
          mag_crit_rate: pct(get('ë§ˆë²• í¬ë¦¬í‹°ì»¬(%)')),
          add_damage: pct(get('ì¶”ê°€ë°ë¯¸ì§€(%)')),
          str_pct: pct(get('í˜(%)')), int_pct: pct(get('ì§€ëŠ¥(%)')),
          damage_inc: pct(get('ë€ì¦(%)')),
          crit_damage_inc: pct(get('í¬ì¦ë€(%)')),
          phys_atk_pct: pct(get('ë¬¼ë¦¬ ê³µê²©ë ¥(%)')) || pct(get('ë¬¼ë¦¬ê³µê²©ë ¥(%)')),
          mag_atk_pct: pct(get('ë§ˆë²• ê³µê²©ë ¥(%)')) || pct(get('ë§ˆë²•ê³µê²©ë ¥(%)')),
          skill_atk_inc: pct(get('ìŠ¤ì¦(%)')),
          elem: { fire: num(get('í™”')), water: num(get('ìˆ˜')), light: num(get('ëª…')), dark: num(get('ì•”')), all: 0 },
          cdr: pct(get('ì¿¨ê°')),
          speed: { attack: pct(get('ê³µì†')), move: pct(get('ì´ì†')), cast: pct(get('ìºì†')) },
          other: { def_break_inc: pct(get('ë°©ê¹ë€ì¦')) }
        };

        return { name, type, tag, level, stats };
      }



      (function () {
        function _getTimeWindowSec() {
          // ë“œë¡­ë‹¤ìš´(#selTime)ì˜ ê°’: "30s" | "1m" | "3m" | "5m" | "10m"
          const el = document.getElementById('selTime');
          const v = (el && el.value) ? el.value : '1m'; // ê¸°ë³¸ 1ë¶„
          const n = Number(v.slice(0, -1));             // ì•ì˜ ìˆ«ì
          return v.endsWith('s') ? n : n * 60;           // sâ†’ì´ˆ, mâ†’ë¶„*60
        }

        // â˜… ì „ì—­ì— ë³´ì¦ (module ìŠ¤ì½”í”„/ì¤‘ë³µ ë¡œë“œ ëŒ€ë¹„)
        if (!window.getTimeWindowSec) window.getTimeWindowSec = _getTimeWindowSec;
      })();

      /* ===== ì‹œíŠ¸ ë¡œë” ===== */
      async function loadSheet(slotKey) {
        if (DB.loaded[slotKey]) return;

        const token = await waitForIdToken();
        const r = await fetch(window.WEBAPP_URL + '?type=' + slotKey, {
          method: 'POST',
          mode: 'cors',
          cache: 'no-store',
          headers: { 'Content-Type': 'text/plain' },
          body: token
        });
        if (!r.ok) throw new Error(`${slotKey}_fetch_failed`);
        const data = await r.json();
        if (!data.ok || !Array.isArray(data.rows)) throw new Error(`bad_${slotKey}_payload`);

        // rows(ì‹œíŠ¸ ì›ë¬¸ í–‰ ê°ì²´) â†’ í”„ë¡ íŠ¸ ë‚´ë¶€ ì•„ì´í…œ êµ¬ì¡°ë¡œ ë§¤í•‘
        const items = data.rows.map(mapRowToItem).map(it => ({ ...it, slot: slotKey }));
        DB.itemsBySlot[slotKey] = items;
        DB.loaded[slotKey] = true;

      }
      const __slotState = {};  // ì „ì—­ì— ì„ ì–¸

      async function ensureLoaded(slotKey) {
        const st = (__slotState[slotKey] ||= { loaded: false, inflight: null });

        if (st.loaded) return;             // ì´ë¯¸ ëë‚¬ìœ¼ë©´ ë°”ë¡œ ë¦¬í„´
        if (st.inflight) return st.inflight; // ì§„í–‰ ì¤‘ì´ë©´ ê°™ì€ Promise ë°˜í™˜

        st.inflight = (async () => {
          await loadSheet(slotKey);
          st.loaded = true;
          st.inflight = null;
        })();

        return st.inflight;
      }


      /* ê°•í™”/ì— ë¸”ë ˜ ì‹œíŠ¸ ë¡œë” */
      // ê°•í™”/ì— ë¸”ë ˜ ì‹œíŠ¸ ë¡œë” (ë°±ì—”ë“œ JSON ë²„ì „)

      //ëª¬ìŠ¤í„° ì‹œíŠ¸ ë¡œë”
      let DBMonster = { loaded: false, rows: [] };
      async function ensureMonsterLoaded() {
        if (DBMonster.loaded) return;
        const token = await waitForIdToken(); // ì´ë¯¸ ë„¤ ì½”ë“œì— ìˆìŒ (ë‹¤ë¥¸ ì‹œíŠ¸ ë¡œë”ì—ì„œ ì‚¬ìš©)
        const data = await apiText('monster');   // rows, headers í¬í•¨
        if (!data.ok || !Array.isArray(data.rows)) throw new Error('bad_monster_payload');
        // ë°±ì—”ë“œê°€ "í—¤ë”ëª…ì„ í‚¤ë¡œ í•œ ê°ì²´"ë¥¼ ê·¸ëŒ€ë¡œ ë‚´ë ¤ì£¼ë¯€ë¡œ ì¶”ê°€ ë§¤í•‘ ë¶ˆí•„ìš”
        DBMonster.rows = data.rows;
        DBMonster.loaded = true;

      }

      // ===== ì„¸íŠ¸ ì‹œíŠ¸ ë¡œë”/ìºì‹œ =====
      const DBSet = { loaded: false, list: [], byType: {} };

      // ì„¸íŠ¸ ì‹œíŠ¸ëŠ” 'ê°•í™”' ë§¤í•‘ê³¼ ì»¬ëŸ¼ êµ¬ì„±ì´ ë™ì¼í•˜ë‹¤ê³  ê°€ì •:
      // => íŒŒì‹± ë¡œì§ì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.
      function mapRowToSet(r) {
        // ê¸°ë³¸ íŒŒì‹±
        const base = mapRowToEnhance(r);

        // â–¶ ì„¸íŠ¸ ì „ìš©: type ê°•ì œ ë³´ì • (ì¢…ë¥˜ê°€ ë¹„ì–´ ìˆê±°ë‚˜ í—¤ë”ëª…ì´ ë‹¤ë¥¼ ë•Œ ëŒ€ë¹„)
        const get = (k) => r[k] ?? r[k?.toLowerCase()] ?? '';
        const rawType =
          (get('ì¢…ë¥˜') || get('ì„¸íŠ¸') || get('ë¶„ë¥˜') || get('íƒ€ì…') || get('ìœ í˜•') ||
            get('type') || get('Type') || get('ì´ë¦„') || '').toString().trim();

        // ì´ë¦„ë§Œ ìˆê³  ì¢…ë¥˜ê°€ ë¹„ì—ˆì„ ê°€ëŠ¥ì„±ê¹Œì§€ ì»¤ë²„
        base.type = rawType;

        return base;
      }

      async function ensureSetLoaded() {
        if (DBSet.loaded) return;
        const token = await waitForIdToken();
        const data = await apiText('set');
        if (!data.ok || !Array.isArray(data.rows)) throw new Error('bad_set_payload');

        const rows = data.rows.map(mapRowToSet).filter(x => (x?.name && x?.type));
        DBSet.list = rows;
        DBSet.byType = rows.reduce((acc, x) => {
          const k = String(x.type || '').trim();
          (acc[k] ||= []).push(x);
          return acc;
        }, {});
        DBSet.loaded = true;

      }

      // ===== ì˜ˆì™¸ê·œì¹™ ë¡œë”/ìºì‹œ =====
      const DBException = { loaded: false, rows: [], byItem: {}, skillIdByName: {} };

      function mapRowToException(r) {
        return {
          type: normalizeType(r['ìœ í˜•']),
          item: String(r['ì•„ì´í…œëª…'] || '').trim(),
          skillName: String(r['ì ìš©ìŠ¤í‚¬ëª…'] || '').trim(),
          value: toNum(r['ì˜µì…˜ìˆ˜ì¹˜'])
        };
      }

      async function ensureExceptionLoaded() {
        if (DBException.loaded) return;
        const token = await waitForIdToken();
        if (!token) { console.warn('[EXC] skip: no idToken yet'); return; }

        const js = await apiText('exception');   // rows, headers í¬í•¨
        if (!js?.ok) { console.warn('[EXC] load failed:', js); DBException.loaded = true; return; }

        DBException.rows = (js.rows || []).map(mapRowToException);
        DBException.byItem = {};
        DBException.rows.forEach(row => {
          const key = row.item; if (!key) return;
          (DBException.byItem[key] ||= []).push(row);
        });
        DBException.skillIdByName = {};
        DBException.loaded = true;

        DBException.rows.slice(0, 10).map(r => `${r.item} | ${r.type} | ${r.skillName} : ${r.value}`);
      }

      // ìŠ¤í‚¬ ì‹œíŠ¸(ST2.rows)ê°€ ì¤€ë¹„ëœ ë’¤, ìŠ¤í‚¬ëª… â†’ id ë§¤í•‘ êµ¬ì„±
      function refreshExceptionSkillIdMap() {
        if (!ST2?.loaded || !(ST2.rows?.length)) return;
        DBException.skillIdByName = {};
        ST2.rows.forEach(s => {
          const name = String(s?.name || '').trim();
          if (!name) return;
          DBException.skillIdByName[name] = s.id;  // ì´ë¦„ì´ ìœ ì¼í•˜ë‹¤ëŠ” ê°€ì • (ë™ëª…ì´ì¸ ì¡´ì¬ì‹œ ìš°ì„  ì¼ì¹˜ ì²« í•­ëª©)
        });
      }

      // í˜„ì¬ ì°©ìš© ì•„ì´í…œëª… ë°°ì—´
      function equippedItemNames() {
        return Object.values(state.selections || {}).map(it => String(it?.name || '').trim()).filter(Boolean);
      }

      // í™œì„± ì˜ˆì™¸íš¨ê³¼ ì§‘ê³„(ìŠ¤í‚¬ID í‚¤ ê¸°ì¤€)
      function collectActiveExceptionMaps() {
        const items = equippedItemNames();  // ì°©ìš© ì¤‘ ì•„ì´í…œ ì´ë¦„ ë°°ì—´
        const addLv = {};       // {skillId: +ë ˆë²¨}
        const addTp = {};       // {skillId: +tpë ˆë²¨}
        const addDmgPct = {};   // {skillId: +ë°ë¯¸ì§€ì¦ê°€%}
        const addCdPct = {};    // {skillId: +ì¿¨ê°%}  // ê°ì†Œìœ¨(%) ê·¸ëŒ€ë¡œ ì €ì¥
        const resetPct = {};    // ì¿¨ì´ˆ
        // â˜… ì¶”ê°€: ë²„í”„ë ˆë²¨ (ë²„í”„ "ì´ë¦„" ê¸°ì¤€)
        const buffLvByName = {};  // {'ë²„í”„ëª…': +ë ˆë²¨}
        // â˜… ì¶”ê°€: ê³ ì • ì¿¨ê°(ì´ˆ)
        const addCdFlat = {};   // { skillId: secondsToReduce }

        // ì´ë¦„ ì •ê·œí™”(ê³µë°±/ì œë¡œí­ ì œê±° ì •ë„ë§Œ)
        const normName = s => String(s ?? '')
          .normalize('NFC')
          .replace(/[\uFEFF\u00A0\u200B-\u200D\u2060\u180E]/g, '')
          .replace(/\s+/g, '');

        for (const nm of items) {
          const list = DBException.byItem[nm] || [];
          for (const r of list) {
            // 1) 'ë²„í”„ë ˆë²¨'ì€ ìŠ¤í‚¬ID ì—†ì´ "ë²„í”„ ì´ë¦„"ìœ¼ë¡œ í•©ì‚°
            if (r.type === 'ë²„í”„ë ˆë²¨') {
              const key = normName(r.skillName);
              if (key) buffLvByName[key] = (buffLvByName[key] || 0) + Number(r.value || 0);
              continue; // â˜… ì´ë¯¸ ì²˜ë¦¬í–ˆìœ¼ë‹ˆ ë‹¤ìŒ ê·œì¹™ìœ¼ë¡œ
            }
            const id = DBException.skillIdByName[r.skillName];
            if (!id) continue;
            switch (r.type) {
              case 'ìŠ¤í‚¬ë ˆë²¨':
                addLv[id] = (addLv[id] || 0) + r.value;
                break;
              case 'tpë ˆë²¨':
                addTp[id] = (addTp[id] || 0) + r.value;
                break;
              case 'ë°ë¯¸ì§€ì¦ê°€':
                addDmgPct[id] = (addDmgPct[id] || 0) + r.value;
                break;
              case 'ì¿¨íƒ€ì„ê°ì†Œ':
                addCdPct[id] = (addCdPct[id] || 0) + r.value;
                break;
              // â˜… ì¶”ê°€: ì¿¨ì´ˆí™•ë¥ (%) í•©ì‚°
              case 'ì¿¨ì´ˆí™•ë¥ ': resetPct[id] = (resetPct[id] || 0) + r.value; break;
              // â˜… ì‹ ê·œ: ì¿¨íƒ€ì„ê³ ì •ê°ì†Œ(ì´ˆ)
              case 'ì¿¨íƒ€ì„ê³ ì •ê°ì†Œ': addCdFlat[id] = (addCdFlat[id] || 0) + Number(r.value || 0); break;
            }
          }
        }
        return { addLv, addTp, addDmgPct, addCdPct, resetPct, buffLvByName, addCdFlat };
      }

      // ì „ì—­ ë³´ê´€(í”„ë ˆì„ ê³„ì‚°/ë°ë¯¸ì§€ ìºì‹œì— í™œìš©)
      let __EXC = { addLv: {}, addTp: {}, addDmgPct: {}, addCdPct: {}, resetPct: {}, buffLvByName: {}, addCdFlat: {} };
      function refreshActiveExceptions() {
        __EXC = collectActiveExceptionMaps();
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ì»¤ìŠ¤í…€ ì˜µì…˜ ëª¨ë‹¬ (ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…/ì—†ìŒ)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const $customOptModal = document.getElementById('customOptModal');
      const $customOptList = document.getElementById('customOptList');
      let __customOptSelected = null;

      // í”„ë¡ íŠ¸ì—ì„œ ë§ˆì§€ë§‰ìœ¼ë¡œ ì ìš©í•œ ì»¤ìŠ¤í…€ì˜µ ê¸°ì–µ(ëª¨ë‹¬ ì—´ ë•Œ í•˜ì´ë¼ì´íŠ¸ìš©)
      state.customOptLabel = state.customOptLabel || null;
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ì»¤ìŠ¤í…€ì˜µ UI ë¦¬ì…‹ (í…ìŠ¤íŠ¸/ìƒ‰ìƒ ì´ˆê¸°í™”)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function resetCustomOptUI() {
        const btn = document.getElementById('btnCustomOpt');
        if (!btn) return;

        // í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        btn.textContent = 'ê³ ìœ íš¨ê³¼(ë¬´ê¸°)';

        // ìƒ‰ìƒ í´ë˜ìŠ¤ ì œê±°
        const allNames = ['ê°•íƒ€', 'ê´‘ì±„', 'ë¶„ì‡„', 'ì„ ëª…', 'ì—†ìŒ'];
        allNames.forEach(name => {
          btn.classList.remove('customopt-' + name);
        });

        // í”„ë¡ íŠ¸ ìƒíƒœì— ë“¤ê³ ìˆëŠ” ë¼ë²¨ë„ ì´ˆê¸°í™”
        if (window.state) {
          state.customOptLabel = null;
        }
      }

      function applyCustomOptUIFromState() {
        const s = window.state || {};
        const cs = s.customSkills || {};

        // 1) ë¬´ê¸° ì»¤ìŠ¤í…€ ë²„íŠ¼
        {
          const btnMain = document.getElementById('btnCustomOpt');
          if (btnMain) {
            const allNames = ['ê°•íƒ€', 'ê´‘ì±„', 'ë¶„ì‡„', 'ì„ ëª…', 'ì—†ìŒ'];
            allNames.forEach(name => {
              btnMain.classList.remove('customopt-' + name);
            });

            const pickedMain = cs.type || cs.customType || '';
            if (!pickedMain) {
              btnMain.textContent = 'ê³ ìœ íš¨ê³¼(ë¬´ê¸°)';
            } else {
              btnMain.textContent = pickedMain;
              btnMain.classList.add('customopt-' + pickedMain);
            }
          }
        }

        // 2) ìƒì˜ ì»¤ìŠ¤í…€ ë²„íŠ¼
        {
          const btnArmor = document.getElementById('btnCustomOptArmor');
          if (btnArmor) {
            const armorNames = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];
            armorNames.forEach(name => {
              btnArmor.classList.remove('armor-customopt-' + name);
            });

            // í”„ë¦¬ì…‹ì—ëŠ” customSkills.armorTypeì´ ì €ì¥ë¨
            // ì˜ˆì „ ìŠ¤ëƒ…ìƒ· í˜¸í™˜ìš©ìœ¼ë¡œ customArmorLabelë„ ê°™ì´ ë´„
            let pickedArmor = cs.armorType || s.customArmorLabel || '';
            if (!pickedArmor) {
              btnArmor.textContent = 'ê³ ìœ íš¨ê³¼(ìƒì˜)';
            } else {
              btnArmor.textContent = pickedArmor;
              btnArmor.classList.add('armor-customopt-' + pickedArmor);
            }
          }
        }

        // 3) íŒ”ì°Œ ì»¤ìŠ¤í…€ ë²„íŠ¼
        {
          const btnBracelet = document.getElementById('btnCustomOptBracelet');
          if (btnBracelet) {
            const braceletNames = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];
            braceletNames.forEach(name => {
              btnBracelet.classList.remove('bracelet-customopt-' + name);
            });

            let pickedBracelet = cs.braceletType || s.customBraceletLabel || '';
            if (!pickedBracelet) {
              btnBracelet.textContent = 'ê³ ìœ íš¨ê³¼(íŒ”ì°Œ)';
            } else {
              btnBracelet.textContent = pickedBracelet;
              btnBracelet.classList.add('bracelet-customopt-' + pickedBracelet);
            }
          }
        }
        // 4) ê·€ê±¸ì´ ì»¤ìŠ¤í…€ ë²„íŠ¼
        {
          const btnEarring = document.getElementById('btnCustomOptEarring');
          if (btnEarring) {
            const earringNames = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];
            earringNames.forEach(name => {
              btnEarring.classList.remove('earring-customopt-' + name);
            });

            let pickedEarring = cs.earringType || s.customEarringLabel || '';
            if (!pickedEarring) {
              btnEarring.textContent = 'ê³ ìœ íš¨ê³¼(ê·€ê±¸ì´)';
            } else {
              btnEarring.textContent = pickedEarring;
              btnEarring.classList.add('earring-customopt-' + pickedEarring);
            }
          }
        }
      }
      // â˜…â˜…â˜… ì»¤ìŠ¤í…€ì˜µ ì¡°ê±´ ê°•ì œ ë¦¬ì…‹ í•¨ìˆ˜ ì¶”ê°€ â˜…â˜…â˜…

      function enforceCustomSkillConstraints() {
        if (!window.state) return;
        const state = window.state;
        state.selections = state.selections || {};
        state.customSkills = state.customSkills || {};

        const cs = state.customSkills;
        const sels = state.selections;

        const norm = (v) => String(v ?? '').trim();
        const toLevel = (v) => {
          if (v == null) return 0;
          const n = parseInt(String(v).replace(/[^\d.-]/g, ''), 10);
          return Number.isFinite(n) ? n : 0;
        };

        let changed = false;

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 1) ë¬´ê¸° ì»¤ìŠ¤í…€: ë ™ì œ 70 ì´ìƒ + ì—í”½ ì•„ë‹ˆë©´ ê°•ì œ ì œê±°
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
          const selWeapon = sels.weapon || null;
          let wLevel = 0;
          let wRarity = '';

          if (selWeapon) {
            wLevel = toLevel(selWeapon.level ?? selWeapon.levelVal);
            wRarity = norm(selWeapon.rarity);
          }

          const low = wRarity.toLowerCase();
          const isEpic = (wRarity === 'ì—í”½' || low === 'epic');

          const ok = !!selWeapon && isEpic && wLevel >= 70;

          if (!ok) {
            if (cs.type || cs.weaponName || state.customOptLabel) {
              changed = true;
            }
            cs.type = '';
            cs.weaponName = '';
            state.customOptLabel = null;   // ëª¨ë‹¬ í•˜ì´ë¼ì´íŠ¸ìš©
          }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 2) ìƒì˜ ì»¤ìŠ¤í…€: ë ˆì–´ë¦¬í‹° ìµì‹œë“œ ì•„ë‹ ë•Œ ì œê±°
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
          const selTop = sels.top || null;
          let r = '';
          if (selTop) r = norm(selTop.rarity);
          const low = r.toLowerCase();
          const isExceed = (r === 'ìµì‹œë“œ' || low === 'exceed');
          const ok = !!selTop && isExceed;

          if (!ok) {
            if (cs.armorType || state.customArmorLabel || (state.customArmor && state.customArmor.type)) {
              changed = true;
            }
            cs.armorType = '';
            state.customArmorLabel = null;
            if (state.customArmor) state.customArmor.type = '';
          }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 3) íŒ”ì°Œ ì»¤ìŠ¤í…€: ë ˆì–´ë¦¬í‹° ìµì‹œë“œ ì•„ë‹ ë•Œ ì œê±°
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
          const selBracelet = sels.bracelet || null;
          let r = '';
          if (selBracelet) r = norm(selBracelet.rarity);
          const low = r.toLowerCase();
          const isExceed = (r === 'ìµì‹œë“œ' || low === 'exceed');
          const ok = !!selBracelet && isExceed;

          if (!ok) {
            if (cs.braceletType || state.customBraceletLabel) {
              changed = true;
            }
            cs.braceletType = '';
            state.customBraceletLabel = null;
          }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 4) ê·€ê±¸ì´ ì»¤ìŠ¤í…€: ë ˆì–´ë¦¬í‹° ìµì‹œë“œ ì•„ë‹ ë•Œ ì œê±°
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        {
          const selEarring = sels.earring || null;
          let r = '';
          if (selEarring) r = norm(selEarring.rarity);
          const low = r.toLowerCase();
          const isExceed = (r === 'ìµì‹œë“œ' || low === 'exceed');
          const ok = !!selEarring && isExceed;

          if (!ok) {
            if (cs.earringType || state.customEarringLabel) {
              changed = true;
            }
            cs.earringType = '';
            state.customEarringLabel = null;
          }
        }

        // ë­”ê°€ í•˜ë‚˜ë¼ë„ ë¦¬ì…‹ëìœ¼ë©´ ë²„íŠ¼/ì„¤ëª… UI ê°±ì‹ 
        if (changed) {
          if (typeof applyCustomOptUIFromState === 'function') {
            applyCustomOptUIFromState();
          }
          if (typeof updateEquipDescPreview === 'function') {
            updateEquipDescPreview();
          }
        }
      }
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ìƒì˜ ì»¤ìŠ¤í…€ì˜µ ì ìš© ë²„íŠ¼ ì²˜ë¦¬
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const armorNames = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];

      const $armorCustomOptApply = document.getElementById('armorCustomOptApply');
      $armorCustomOptApply?.addEventListener('click', () => {
        if (!__armorCustomOptSelected) {
          toast('ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
          return;
        }

        const picked = __armorCustomOptSelected;
        if (!window.state) window.state = {};

        // â˜… customSkills ë³´ì¥
        if (!state.customSkills) state.customSkills = {};

        // â˜… ë°±ì—”ë“œì—ì„œ ì½ì–´ê°€ëŠ” armorType ì„¸íŒ…
        //    (ì—†ìŒì´ë©´ ë¹ˆ ë¬¸ìì—´ë¡œ ë³´ë‚´ë„ ë˜ê³ , 'ì—†ìŒ' ê·¸ëŒ€ë¡œ ë³´ë‚´ë„ ë°±ì—”ë“œ fixNoneì—ì„œ ì²˜ë¦¬í•¨)
        state.customSkills.armorType = (picked === 'ì—†ìŒ') ? '' : picked;

        // ê¸°ì¡´ UIìš© ìƒíƒœ ìœ ì§€
        state.customArmor = { type: picked };
        state.customArmorLabel = picked;

        // 2) ìƒì˜ ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ ë¼ë²¨/ìƒ‰ìƒ ê°±ì‹ 
        const btn = document.getElementById('btnCustomOptArmor');
        if (btn) {
          // ë¼ë²¨
          btn.textContent = picked || 'ê³ ìœ íš¨ê³¼(ìƒì˜)';

          // ìƒ‰ìƒ í´ë˜ìŠ¤(armor-customopt-*) ë¦¬ì…‹ í›„ ì„ íƒí•œ ê²ƒë§Œ ë¶€ì—¬
          armorNames.forEach(name => {
            btn.classList.remove('armor-customopt-' + name);
          });
          if (picked) {
            btn.classList.add('armor-customopt-' + picked);
          }
        }
        // â˜… ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ê°±ì‹ 
        if (typeof updateEquipDescPreview === 'function') {
          updateEquipDescPreview();
        }
        // 3) ëª¨ë‹¬ ë‹«ê¸°
        closeArmorCustomOptModal();
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ê·€ê±¸ì´ ì»¤ìŠ¤í…€ì˜µ ì ìš© ë²„íŠ¼ ì²˜ë¦¬ (UIìš©)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const earringNames = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];

      const $earringCustomOptApply = document.getElementById('earringCustomOptApply');
      $earringCustomOptApply?.addEventListener('click', () => {
        if (!__earringCustomOptSelected) {
          toast('ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
          return;
        }

        const picked = __earringCustomOptSelected;
        if (!window.state) window.state = {};
        if (!state.customSkills) state.customSkills = {};

        // â˜… ë‚˜ì¤‘ì— ë°±ì—”ë“œì—ì„œ ì“¸ ì—¬ì§€ë¥¼ ìœ„í•´ ë¯¸ë¦¬ ì„¸íŒ…ë§Œ í•´ë‘ 
        state.customSkills.earringType = (picked === 'ì—†ìŒ') ? '' : picked;

        // UIìš© ìƒíƒœ
        state.customEarringLabel = (picked === 'ì—†ìŒ') ? null : picked;

        // ë²„íŠ¼ í…ìŠ¤íŠ¸/ìƒ‰ìƒ ê°±ì‹ 
        const btn = document.getElementById('btnCustomOptEarring');
        if (btn) {
          btn.textContent = picked || 'ê³ ìœ íš¨ê³¼(ê·€ê±¸ì´)';

          earringNames.forEach(name => {
            btn.classList.remove('earring-customopt-' + name);
          });
          if (picked) {
            btn.classList.add('earring-customopt-' + picked);
          }
        }
        // â˜… ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ê°±ì‹ 
        if (typeof updateEquipDescPreview === 'function') {
          updateEquipDescPreview();
        }
        closeEarringCustomOptModal();
      });


      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ìƒì˜ ì „ìš© ì»¤ìŠ¤í…€ ì˜µì…˜ ëª¨ë‹¬ (ì„ ë´‰/ì˜ì§€/ì´ìƒ/ì—†ìŒ)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const $armorCustomOptModal = document.getElementById('armorCustomOptModal');
      const $armorCustomOptList = document.getElementById('armorCustomOptList');
      let __armorCustomOptSelected = null;

      // í”„ë¡ íŠ¸ì—ì„œ ë§ˆì§€ë§‰ìœ¼ë¡œ ì ìš©í•œ ìƒì˜ ì»¤ìŠ¤í…€ì˜µ ë¼ë²¨(í•˜ì´ë¼ì´íŠ¸ìš©)
      if (!window.state) window.state = {};
      state.customArmorLabel = state.customArmorLabel || null;

      function showArmorCustomOptModal(on) {
        if (!$armorCustomOptModal) return;
        if (on) {
          $armorCustomOptModal.classList.add('show');
          $armorCustomOptModal.setAttribute('aria-hidden', 'false');
        } else {
          $armorCustomOptModal.classList.remove('show');
          $armorCustomOptModal.setAttribute('aria-hidden', 'true');
        }
      }

      function openArmorCustomOptModal() {
        if (!$armorCustomOptModal) return;

        // ì´ì „ì— ì„ íƒí•œ ê°’ì´ ìˆìœ¼ë©´ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸ ë³µêµ¬
        __armorCustomOptSelected = state.customArmorLabel || null;

        if ($armorCustomOptList) {
          $armorCustomOptList.querySelectorAll('.opt-btn').forEach(btn => {
            const val = btn.dataset.value || btn.textContent.trim();
            btn.classList.toggle('active', !!__armorCustomOptSelected && val === __armorCustomOptSelected);
          });
        }

        showArmorCustomOptModal(true);
      }

      function closeArmorCustomOptModal() {
        showArmorCustomOptModal(false);
      }

      // ë°”ê¹¥ í´ë¦­/ë‹«ê¸° ë²„íŠ¼ìœ¼ë¡œ ë‹«ê¸°
      $armorCustomOptModal?.addEventListener('click', (e) => {
        if (e.target.dataset.close != null || e.target.classList.contains('backdrop')) {
          closeArmorCustomOptModal();
        }
      });
      // âœ… ìƒì˜ ê³ ìœ íš¨ê³¼(ì»¤ìŠ¤í…€ì˜µ) - ì˜µì…˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ í† ê¸€
$armorCustomOptList?.addEventListener('click', (e) => {
  const btn = e.target.closest('.opt-btn');
  if (!btn) return;

  const val = btn.dataset.value || btn.textContent.trim(); // ì„ ë´‰/ì˜ì§€/ì´ìƒ/ì—†ìŒ
  __armorCustomOptSelected = val;

  $armorCustomOptList.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
});


      // ì˜µì…˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ (ì¼ë°˜ í´ë¦­) / ìë™ê³„ì‚° ëŒ€ìƒ í† ê¸€ (Shift/Ctrl/Meta í´ë¦­)
$customOptList?.addEventListener('click', (e) => {
  const btn = e.target.closest('.opt-btn');
  if (!btn) return;

  const val = btn.dataset.value || btn.textContent.trim(); // ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…/ì—†ìŒ
  const isToggleAuto = (e.shiftKey || e.ctrlKey || e.metaKey);

  // âœ… Shift/Ctrl/Meta í´ë¦­: ìë™ê³„ì‚° ëŒ€ìƒ í† ê¸€ë§Œ (ì„ íƒ/activeëŠ” ê±´ë“œë¦¬ì§€ ì•Šì•„ë„ ë¨)
  if (isToggleAuto) {
    const auto = state.autoSweep || (state.autoSweep = { armor: [], acc: [], spec: [], weapon: [], weaponCustom: [] });
    auto.weaponCustom = Array.isArray(auto.weaponCustom) ? auto.weaponCustom : [];

    const idx = auto.weaponCustom.indexOf(val);
    if (idx >= 0) auto.weaponCustom.splice(idx, 1);
    else auto.weaponCustom.push(val);

    btn.classList.toggle('is-auto', idx < 0); // í‘œì‹œìš©
    toast?.(`ìë™ê³„ì‚° ì˜µì…˜ ${idx < 0 ? 'ì¶”ê°€' : 'í•´ì œ'}: ${val}`);
    return;
  }

  // âœ… ì¼ë°˜ í´ë¦­: ê¸°ì¡´ ë™ì‘(ë‹¨ì¼ ì„ íƒ active)
  __customOptSelected = val;
  $customOptList.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
});


      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ê·€ê±¸ì´ ì „ìš© ì»¤ìŠ¤í…€ ì˜µì…˜ ëª¨ë‹¬ (ì„ ë´‰/ì˜ì§€/ì´ìƒ/ì—†ìŒ)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const $earringCustomOptModal = document.getElementById('earringCustomOptModal');
      const $earringCustomOptList = document.getElementById('earringCustomOptList');
      let __earringCustomOptSelected = null;

      // ë§ˆì§€ë§‰ìœ¼ë¡œ ì ìš©í•œ ê·€ê±¸ì´ ì»¤ìŠ¤í…€ì˜µ ë¼ë²¨
      if (!window.state) window.state = {};
      state.customEarringLabel = state.customEarringLabel || null;

      function showEarringCustomOptModal(on) {
        if (!$earringCustomOptModal) return;
        if (on) {
          $earringCustomOptModal.classList.add('show');
          $earringCustomOptModal.setAttribute('aria-hidden', 'false');
        } else {
          $earringCustomOptModal.classList.remove('show');
          $earringCustomOptModal.setAttribute('aria-hidden', 'true');
        }
      }

      function openEarringCustomOptModal() {
        if (!$earringCustomOptModal) return;

        __earringCustomOptSelected = state.customEarringLabel || null;

        if ($earringCustomOptList) {
          $earringCustomOptList.querySelectorAll('.opt-btn').forEach(btn => {
            const val = btn.dataset.value || btn.textContent.trim();
            btn.classList.toggle('active', !!__earringCustomOptSelected && val === __earringCustomOptSelected);
          });
        }

        showEarringCustomOptModal(true);
      }

      function closeEarringCustomOptModal() {
        showEarringCustomOptModal(false);
      }

      // ë°”ê¹¥ í´ë¦­/ë‹«ê¸° ë²„íŠ¼ìœ¼ë¡œ ë‹«ê¸°
      $earringCustomOptModal?.addEventListener('click', (e) => {
        if (e.target.dataset.close != null || e.target.classList.contains('backdrop')) {
          closeEarringCustomOptModal();
        }
      });

      // ì˜µì…˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒ í† ê¸€
      $earringCustomOptList?.addEventListener('click', (e) => {
        const btn = e.target.closest('.opt-btn');
        if (!btn) return;

        const val = btn.dataset.value || btn.textContent.trim();
        __earringCustomOptSelected = val;

        $earringCustomOptList.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });


      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ë¬´ê¸° ì´ë¦„ ê°€ì ¸ì˜¤ê¸° í—¬í¼
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function getCurrentWeaponName() {
        // 1ìˆœìœ„: state.selections.weapon.name (ì¥ë¹„ ì„ íƒ ë¡œì§ê³¼ ë™ì¼)
        try {
          const nm = state?.selections?.weapon?.name;
          if (nm) return String(nm).trim();
        } catch (_) { }

        // 2ìˆœìœ„: DOMì—ì„œ weapon ìŠ¬ë¡¯ ì°¾ì•„ì„œ data-name / í…ìŠ¤íŠ¸ / img alt ì‚¬ìš©
        let weaponTile = null;
        if (typeof tileElForSlot === 'function') {
          weaponTile = tileElForSlot('weapon');   // ì„œë²„ ìŠ¬ë¡¯í‚¤ ê¸°ì¤€ ìœ í‹¸
        } else {
          weaponTile = document.querySelector('.slot[data-slot="R1"]');
        }
        if (!weaponTile) return '';

        const nm =
          weaponTile.getAttribute('data-name')
          || weaponTile.querySelector('.item-name')?.textContent
          || weaponTile.querySelector('img')?.alt
          || '';

        return String(nm || '').trim();
      }

      function showCustomOptModal(on) {
        if (!$customOptModal) return;
        if (on) {
          $customOptModal.classList.add('show');
          $customOptModal.setAttribute('aria-hidden', 'false');
        } else {
          $customOptModal.classList.remove('show');
          $customOptModal.setAttribute('aria-hidden', 'true');
        }
      }

      function openCustomOptModal() {
        if (!$customOptModal) return;

        // ì´ì „ì— ì ìš©í•œ ì˜µì…˜ì´ ìˆìœ¼ë©´ í•˜ì´ë¼ì´íŠ¸ ë³µêµ¬
        __customOptSelected = state.customOptLabel || null;
        if ($customOptList) {
          $customOptList.querySelectorAll('.opt-btn').forEach(btn => {
            const val = btn.dataset.value || btn.textContent.trim();
            btn.classList.toggle('active', !!__customOptSelected && val === __customOptSelected);

            const auto = state.autoSweep || {};
const autoList = Array.isArray(auto.weaponCustom) ? auto.weaponCustom : [];
btn.classList.toggle('is-auto', autoList.includes(val));
          });
        }
        showCustomOptModal(true);
      }

      function closeCustomOptModal() {
        showCustomOptModal(false);
      }

      // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­/ë‹«ê¸° ë²„íŠ¼ìœ¼ë¡œ ë‹«ê¸°
      $customOptModal?.addEventListener('click', (e) => {
        if (e.target.dataset.close != null || e.target.classList.contains('backdrop')) {
          closeCustomOptModal();
        }
      });


      // "ì„ íƒ í•˜ê¸°" ë²„íŠ¼ â†’ custom_select í˜¸ì¶œ + skill_state_set ì¬ê³„ì‚° + ë²„íŠ¼ ë¼ë²¨/ìƒ‰ ê°±ì‹ 
      document.getElementById('customOptApply')?.addEventListener('click', async () => {
        if (!__customOptSelected) {
          toast('ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
          return;
        }

        const picked = __customOptSelected;           // ê°•íƒ€ / ê´‘ì±„ / ë¶„ì‡„ / ì„ ëª… / ì—†ìŒ
        const btn = document.getElementById('btnCustomOpt');
        if (!btn) {
          closeCustomOptModal();
          return;
        }

        // "ì—†ìŒ"ì´ ì•„ë‹Œ ê²½ìš°ì—ëŠ” ë¬´ê¸° ì´ë¦„ì´ ê¼­ ìˆì–´ì•¼ í•œë‹¤
        let weaponName = '';
        if (picked !== 'ì—†ìŒ') {
          weaponName = getCurrentWeaponName();
          if (!weaponName) {
            toast('ë¬´ê¸° ì´ë¦„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¬´ê¸°ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            closeCustomOptModal();
            return;
          }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // â˜… 1) ë” ì´ìƒ custom_select í˜¸ì¶œ X
        //    â†’ í”„ë¡ íŠ¸ stateì—ë§Œ ì €ì¥
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (!window.state) window.state = {};
        if (!state.customSkills) state.customSkills = {};

        if (picked === 'ì—†ìŒ') {
          state.customSkills.type = '';
          state.customSkills.weaponName = '';
        } else {
          state.customSkills.type = picked;      // ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…
          state.customSkills.weaponName = weaponName;  // ì§€ê¸ˆì€ ë°±ì—”ë“œì—ì„œ ì•ˆ ì“°ì§€ë§Œ ê·¸ëŒ€ë¡œ ë‘¬ë„ ë¨
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 3) ë²„íŠ¼ í…ìŠ¤íŠ¸/ìƒ‰ìƒ ê°±ì‹ 
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const allNames = ['ê°•íƒ€', 'ê´‘ì±„', 'ë¶„ì‡„', 'ì„ ëª…', 'ì—†ìŒ'];
        btn.textContent = picked || 'ê³ ìœ íš¨ê³¼(ë¬´ê¸°)';

        allNames.forEach(name => {
          btn.classList.remove('customopt-' + name);
        });
        if (picked) {
          btn.classList.add('customopt-' + picked);   // customopt-ê°•íƒ€ / customopt-ê´‘ì±„ ... í´ë˜ìŠ¤
        }

        // â˜… ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ê°±ì‹ 
        if (typeof updateEquipDescPreview === 'function') {
          updateEquipDescPreview();
        }

        closeCustomOptModal();
      });


      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ + ì´ˆê¸°í™”
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      document.addEventListener('DOMContentLoaded', () => {
        const btnCustomOpt = document.getElementById('btnCustomOpt');
        if (!btnCustomOpt) return;

        // 1) í˜ì´ì§€ ë¡œë“œ ì‹œ UI ë¨¼ì € ì´ˆê¸°í™” (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
        resetCustomOptUI?.();

        // 2) í”„ë¡ íŠ¸ state ìª½ ì»¤ìŠ¤í…€ì˜µ ì´ˆê¸°í™”ë§Œ ìˆ˜í–‰ (ë°±ì—”ë“œ í˜¸ì¶œ X)
        //    í”„ë¡œì íŠ¸ ì „ì²´ì—ì„œ ì“°ëŠ” ì „ì—­ state ê°ì²´ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±
        if (!window.state) window.state = {};
        if (!state.customSkills) {
          state.customSkills = {
            // ë¬´ê¸° ì»¤ìŠ¤í…€
            type: '',
            weaponName: '',
            // ìƒì˜ ì»¤ìŠ¤í…€
            armorType: '',
            // íŒ”ì°Œ ì»¤ìŠ¤í…€
            braceletType: '',
          };
        }

        // 3) ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ í´ë¦­ ì‹œ: ë¬´ê¸° ì²´í¬ â†’ ëª¨ë‹¬ ì—´ê¸° (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
        btnCustomOpt.addEventListener('click', async (e) => {
          e.stopPropagation();

          // ë¬´ê¸° ìŠ¬ë¡¯ ì²´í¬
          let weaponTile = null;
          if (typeof tileElForSlot === 'function') {
            weaponTile = tileElForSlot('weapon');
          } else {
            weaponTile = document.querySelector('.slot[data-slot="R1"]');
          }
          const hasWeapon = !!(weaponTile && weaponTile.querySelector('img'));

          if (!hasWeapon) {
            toast('ë¬´ê¸°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
            if (typeof openItemPicker === 'function') {
              await openItemPicker('weapon');
            }
            return;
          }
          // â˜… ì»¤ìŠ¤í…€ì˜µ í™œì„± ì¡°ê±´: ë ™ì œ 70 ì´ìƒ + ì—í”½ ë¬´ê¸°
          const state = window.state || {};
          const selections = state.selections || {};
          const selWeapon = selections.weapon || null;

          let weaponLevel = 0;
          let weaponRarity = '';

          if (selWeapon) {
            if (selWeapon.level != null) {
              weaponLevel = parseInt(String(selWeapon.level), 10) || 0;
            }
            weaponRarity = String(selWeapon.rarity || '').trim();
          }

          const lowR = weaponRarity.toLowerCase();
          const isEpic = (weaponRarity === 'ì—í”½' || lowR === 'epic');

          if (!(isEpic && weaponLevel >= 70)) {
            toast('ê³ ìœ íš¨ê³¼ëŠ” 70ì œ ì—í”½ ë¬´ê¸°ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
          }
          // ì´ì œëŠ” ë‹¨ìˆœíˆ ëª¨ë‹¬ë§Œ ì—´ê³ ,
          // ì‹¤ì œ ì»¤ìŠ¤í…€ì˜µ ì ìš©ì€ ëª¨ë‹¬ ë‚´ "ì ìš©" ë²„íŠ¼ì—ì„œ state.customSkills ì—ë§Œ ê¸°ë¡
          openCustomOptModal();
        });
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // íŒ”ì°Œ ì»¤ìŠ¤í…€ì˜µ (UI ì „ìš© / ë‚˜ì¤‘ì— ë°±ì—”ë“œ ì—°ë™ ê°€ëŠ¥)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const $braceletCustomOptModal = document.getElementById('braceletCustomOptModal');
      const $braceletCustomOptList = document.getElementById('braceletCustomOptList');
      let __braceletCustomOptSelected = null;

      function showBraceletCustomOptModal(on) {
        if (!$braceletCustomOptModal) return;
        if (on) {
          $braceletCustomOptModal.classList.add('show');
          $braceletCustomOptModal.setAttribute('aria-hidden', 'false');
        } else {
          $braceletCustomOptModal.classList.remove('show');
          $braceletCustomOptModal.setAttribute('aria-hidden', 'true');
        }
      }

      function openBraceletCustomOptModal() {
        if (!$braceletCustomOptModal) return;

        // ì´ì „ ì„ íƒê°’ ë³µêµ¬
        __braceletCustomOptSelected = (window.state && state.customBraceletLabel) || null;

        if ($braceletCustomOptList) {
          $braceletCustomOptList.querySelectorAll('.opt-btn').forEach(btn => {
            const val = btn.dataset.value || btn.textContent.trim();
            btn.classList.toggle(
              'active',
              !!__braceletCustomOptSelected && val === __braceletCustomOptSelected
            );
          });
        }

        showBraceletCustomOptModal(true);
      }

      function closeBraceletCustomOptModal() {
        showBraceletCustomOptModal(false);
      }

      // ëª¨ë‹¬ ë°”ê¹¥/ë‹«ê¸°ë²„íŠ¼ìœ¼ë¡œ ë‹«ê¸°
      $braceletCustomOptModal?.addEventListener('click', (e) => {
        if (e.target.dataset.close != null || e.target.classList.contains('backdrop')) {
          closeBraceletCustomOptModal();
        }
      });

      // ì˜µì…˜ ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒê°’ ë³€ê²½
      $braceletCustomOptList?.addEventListener('click', (e) => {
        const btn = e.target.closest('.opt-btn');
        if (!btn) return;

        const val = btn.dataset.value || btn.textContent.trim();
        __braceletCustomOptSelected = val;

        $braceletCustomOptList.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });

      // "ì„ íƒ í•˜ê¸°" ë²„íŠ¼ â†’ state.customBraceletLabel + ë²„íŠ¼ ë¼ë²¨/ìƒ‰ìƒ ê°±ì‹ 
      document.getElementById('braceletCustomOptApply')?.addEventListener('click', () => {
        if (!__braceletCustomOptSelected) {
          toast('ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
          return;
        }

        const picked = __braceletCustomOptSelected;
        const btn = document.getElementById('btnCustomOptBracelet');
        if (!btn) {
          closeBraceletCustomOptModal();
          return;
        }

        if (!window.state) window.state = {};
        if (!state.customSkills) state.customSkills = {};

        // â˜… ë°±ì—”ë“œì—ì„œ ì½ì–´ê°€ëŠ” braceletType ì„¸íŒ…
        state.customSkills.braceletType = (picked === 'ì—†ìŒ') ? '' : picked;

        // ê¸°ì¡´ UIìš© ìƒíƒœ
        state.customBraceletLabel = (picked === 'ì—†ìŒ') ? null : picked;

        // ë²„íŠ¼ í…ìŠ¤íŠ¸/ìƒ‰ìƒ ê°±ì‹ 
        btn.textContent = picked || 'ê³ ìœ íš¨ê³¼(íŒ”ì°Œ)';

        const allNames = ['ì„ ë´‰', 'ì˜ì§€', 'ì´ìƒ', 'ì—†ìŒ'];
        allNames.forEach(name => {
          btn.classList.remove('bracelet-customopt-' + name);
        });
        if (picked) {
          btn.classList.add('bracelet-customopt-' + picked);
        }
        // â˜… ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ê°±ì‹ 
        if (typeof updateEquipDescPreview === 'function') {
          updateEquipDescPreview();
        }
        closeBraceletCustomOptModal();
      });

      // íŒ”ì°Œ ì»¤ìŠ¤í…€ ë²„íŠ¼ ì´ˆê¸°í™” + í´ë¦­
      document.addEventListener('DOMContentLoaded', () => {
        const btnBracelet = document.getElementById('btnCustomOptBracelet');
        if (!btnBracelet) return;

        if (!window.state) window.state = {};
        if (typeof state.customBraceletLabel === 'undefined') {
          state.customBraceletLabel = null;
        }

        // ì´ˆê¸° ë¼ë²¨
        btnBracelet.textContent = state.customBraceletLabel || 'ê³ ìœ íš¨ê³¼(íŒ”ì°Œ)';

        btnBracelet.addEventListener('click', async (e) => {
          e.stopPropagation();

          // íŒ”ì°Œ ìŠ¬ë¡¯ì— ì•„ì´í…œ ìˆëŠ”ì§€ ì²´í¬
          let braceletTile = null;
          if (typeof tileElForSlot === 'function') {
            braceletTile = tileElForSlot('bracelet');
          } else {
            braceletTile = document.querySelector('.slot[data-slot="R2"]');
          }
          const hasBracelet = !!(braceletTile && braceletTile.querySelector('img'));

          if (!hasBracelet) {
            toast('íŒ”ì°Œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
            if (typeof openItemPicker === 'function') {
              await openItemPicker('bracelet');
            }
            return;
          }

          // â˜… ë ˆì–´ë¦¬í‹° ì²´í¬: ìµì‹œë“œì¼ ë•Œë§Œ
          const state = window.state || {};
          const selections = state.selections || {};
          const selBracelet = selections.bracelet || null;

          let braceletRarity = '';
          if (selBracelet) {
            braceletRarity = String(selBracelet.rarity || '').trim();
          }
          const braceletLower = braceletRarity.toLowerCase();
          const isExceed = (braceletRarity === 'ìµì‹œë“œ' || braceletLower === 'exceed');

          if (!isExceed) {
            toast('íŒ”ì°Œ ê³ ìœ íš¨ê³¼ëŠ” ìµì‹œë“œ ì•„ì´í…œì—ë§Œ ë¶€ì—¬í•˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.');
            return;
          }

          openBraceletCustomOptModal();
        });
      });

      // ìƒì˜ ì „ìš© ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ â†’ ëª¨ë‹¬ ì—´ê¸°
      document.addEventListener('DOMContentLoaded', () => {
        const btnCustomOptArmor = document.getElementById('btnCustomOptArmor');
        if (!btnCustomOptArmor) return;

        btnCustomOptArmor.addEventListener('click', async (e) => {
          e.stopPropagation();

          // ìƒì˜ ìŠ¬ë¡¯ì— ì•„ì´í…œì´ ìˆëŠ”ì§€ í™•ì¸
          let topTile = null;
          if (typeof tileElForSlot === 'function') {
            topTile = tileElForSlot('top');          // ì„œë²„ ìŠ¬ë¡¯ í‚¤ 'top'
          } else {
            topTile = document.querySelector('.slot[data-slot="L2"]');
          }
          const hasTop = !!(topTile && topTile.querySelector('img'));

          if (!hasTop) {
            toast('ìƒì˜ ì•„ì´í…œì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
            if (typeof openItemPicker === 'function') {
              await openItemPicker('top');
            }
            return;
          }

          // â˜… ë ˆì–´ë¦¬í‹° ì²´í¬: ìµì‹œë“œì¼ ë•Œë§Œ
          const state = window.state || {};
          const selections = state.selections || {};
          const selTop = selections.top || null;

          let topRarity = '';
          if (selTop) {
            topRarity = String(selTop.rarity || '').trim();
          }
          const topLower = topRarity.toLowerCase();
          const isExceed = (topRarity === 'ìµì‹œë“œ' || topLower === 'exceed');

          if (!isExceed) {
            toast('ìƒì˜ ê³ ìœ íš¨ê³¼ëŠ” ìµì‹œë“œ ì•„ì´í…œì—ë§Œ ë¶€ì—¬í•˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.');
            return;
          }

          // ìƒì˜ ì»¤ìŠ¤í…€ì˜µ ëª¨ë‹¬ ì—´ê¸°
          openArmorCustomOptModal();
        });
      });

      // ê·€ê±¸ì´ ì „ìš© ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ â†’ ëª¨ë‹¬ ì—´ê¸°
      document.addEventListener('DOMContentLoaded', () => {
        const btnCustomOptEarring = document.getElementById('btnCustomOptEarring');
        if (!btnCustomOptEarring) return;

        btnCustomOptEarring.addEventListener('click', async (e) => {
          e.stopPropagation();

          // ê·€ê±¸ì´ ìŠ¬ë¡¯ì— ì•„ì´í…œì´ ìˆëŠ”ì§€ í™•ì¸
          let earringTile = null;
          if (typeof tileElForSlot === 'function') {
            earringTile = tileElForSlot('earring');   // ì„œë²„ ìŠ¬ë¡¯í‚¤
          } else {
            earringTile = document.querySelector('.slot[data-slot="L6"]');
          }
          const hasEarring = !!(earringTile && earringTile.querySelector('img'));

          if (!hasEarring) {
            toast('ê·€ê±¸ì´ ì•„ì´í…œì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
            if (typeof openItemPicker === 'function') {
              await openItemPicker('earring');
            }
            return;
          }

          // â˜… ë ˆì–´ë¦¬í‹° ì²´í¬: ìµì‹œë“œì¼ ë•Œë§Œ
          const state = window.state || {};
          const selections = state.selections || {};
          const selEarring = selections.earring || null;

          let earringRarity = '';
          if (selEarring) {
            earringRarity = String(selEarring.rarity || '').trim();
          }
          const earringLower = earringRarity.toLowerCase();
          const isExceed = (earringRarity === 'ìµì‹œë“œ' || earringLower === 'exceed');

          if (!isExceed) {
            toast('ê·€ê±¸ì´ ê³ ìœ íš¨ê³¼ëŠ” ìµì‹œë“œ ì•„ì´í…œì—ë§Œ ë¶€ì—¬í•˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤.');
            return;
          }

          openEarringCustomOptModal();
        });
      });



      /* ===== ì„±ì•ˆì˜ ë´‰ì¸ ===== */
      const $sealModal = document.getElementById('castleSealModal');
      const $sealMainList = document.getElementById('sealMainList');
      const $sealSubList = document.getElementById('sealSubList');
      let __sealPick = { main: null, sub: null };

      function showSealModal(on) {
        if (!$sealModal) return;
        if (on) { $sealModal.classList.add('show'); $sealModal.setAttribute('aria-hidden', 'false'); }
        else { $sealModal.classList.remove('show'); $sealModal.setAttribute('aria-hidden', 'true'); }
      }
      $sealModal?.addEventListener('click', (e) => {
        if (e.target.dataset.close != null || e.target.classList.contains('backdrop')) showSealModal(false);
      });

      document.getElementById('btnCastleSeal')?.addEventListener('click', openCastleSealModal);
      document.getElementById('sealCommit')?.addEventListener('click', commitCastleSealSelection);

      async function openCastleSealModal() {
        // ê°•í™”/ë§ˆë´‰/ë§ˆë¶€ ì‹œíŠ¸ ë¡œë“œ(ì—°ë§ˆì—ì„œ ì“°ë˜ ìºì‹œ ì¬ì‚¬ìš©)
        if (typeof ensureEnhLoaded === 'function') await ensureEnhLoaded();

        // ì‹œíŠ¸ì—ì„œ ì¢…ë¥˜ë³„ë¡œ ë¶„ë¦¬
        const mainList = (DBEnh?.byType?.['ì£¼ìš” ì˜µì…˜'] || (DBEnh?.list || []).filter(o => (o?.type || '') === 'ì£¼ìš” ì˜µì…˜'));
        const subList = (DBEnh?.byType?.['ì¶”ê°€ ì˜µì…˜'] || (DBEnh?.list || []).filter(o => (o?.type || '') === 'ì¶”ê°€ ì˜µì…˜'));

        // í˜„ì¬ ì„ íƒ ë³µêµ¬
        __sealPick = {
          main: state.CastleSeal?.main || null, // {name}ë§Œ ìˆì–´ë„ í•˜ì´ë¼ì´íŠ¸ì— ì¶©ë¶„
          sub: state.CastleSeal?.sub || null
        };

        fillSealList($sealMainList, mainList, 'main');
        fillSealList($sealSubList, subList, 'sub');

        showSealModal(true);
      }

      function fillSealList(host, list, which) {
        host.innerHTML = '';
        list.forEach(row => {
          const b = document.createElement('button');
          b.type = 'button';
          b.className = 'opt-btnetc';
          b.innerHTML = `
      <div class="name">${(row.name || '(ì´ë¦„ì—†ìŒ)').replace(/\n/g, '<br>')}</div>
      ${row.uiText ? `<div class="desc">${row.uiText}</div>` : ''}`;
          if (__sealPick[which]?.name === row.name) b.classList.add('active');
          b.addEventListener('click', () => {
            __sealPick[which] = row;
            host.querySelectorAll('.opt-btnetc').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
          });
          host.appendChild(b);
        });
      }

      function closecastleSealModal() {
        const modal = document.getElementById('castleSealModal');
        if (modal) { modal.classList.remove('show'); modal.setAttribute('aria-hidden', 'true'); }
        state.ui = state.ui || {};
        state.ui.sealTemp = null;
      }

      /** === [NEW] ì„±ì•ˆì˜ ë´‰ì¸ ì˜µì…˜ ì„ íƒ í™•ì • === */
      /** === [NEW] ì„±ì•ˆì˜ ë´‰ì¸ ì˜µì…˜ ì„ íƒ í™•ì • === */
      let __sealCommitPending = false;

      async function commitCastleSealSelection() {
        if (__sealCommitPending) return;
        __sealCommitPending = true;

        try {
          // â›” window.__sealPick ì‚¬ìš© ê¸ˆì§€. ì§€ì—­ __sealPickë§Œ ì‚¬ìš©
          if (!__sealPick || (!__sealPick.main && !__sealPick.sub)) {
            toast('ì„ íƒëœ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          // ê·œì¹™: undefined = ìœ ì§€, '' = í•´ì œ, 'ì´ë¦„' = ì„¤ì •
          const mainName = (__sealPick.main?.name ?? '').trim();
          const subName = (__sealPick.sub?.name ?? '').trim();

          // â˜… ì„œë²„ í˜¸ì¶œ ì—†ì´, í”„ë¡ íŠ¸ state ë§Œ ê°±ì‹ 
          state.castleSeal = {
            main: mainName ? { name: mainName } : null,
            sub: subName ? { name: subName } : null,
          };
          // CastleStats ëŠ” calc_all / compute ì‹œ ì„œë²„ì—ì„œ ë‹¤ì‹œ ê³„ì‚°í•˜ë¯€ë¡œ ì—¬ê¸°ì„  ê±´ë“œë¦¬ì§€ ì•ŠìŒ
          // state.CastleStats = null;   // êµ³ì´ ì´ˆê¸°í™”í•˜ê³  ì‹¶ìœ¼ë©´ ì´ ì¤„ ì¶”ê°€

          // ë¼ë²¨/ìº¡ì…˜ ë“± í•„ìš”ì‹œ ê°±ì‹  (ì§€ê¸ˆì€ íš¨ê³¼ ê±°ì˜ ì—†ìŒ)
          if (typeof refreshSealLabelsFromState === 'function') {
            refreshSealLabelsFromState();
          }

          // ë°”ë¡œ í•©ì‚° ìŠ¤íƒ¯ê¹Œì§€ ë‹¤ì‹œ ë•¡ê¸°ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ
          // if (typeof recalcAndRenderPanel === 'function') {
          //   await recalcAndRenderPanel();
          // }

          closecastleSealModal();

        } catch (err) {
          console.error('[commitCastleSealSelection] error', err);
          toast('ì„±ì•ˆì˜ ë´‰ì¸ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
          __sealCommitPending = false;
        }
      }


      /* ===== ë£¬ ê°ì¸ ë“œë¡­ë‹¤ìš´(ì‹œíŠ¸ ì—°ë™) ===== */

      // ì‹œíŠ¸ì—ì„œ 'ë£¬ê°ì¸'ë§Œ ì¶”ë¦¬ê¸° (byType ìš°ì„ , ì—†ìœ¼ë©´ filter)
      function getRuneEngraveRows() {
        const base = (DBEnh?.byType?.['ë£¬ê°ì¸']) || (DBEnh?.list || []).filter(x => x.type === 'ë£¬ê°ì¸');
        return base || [];
      }

      // ì´ë¦„ ëª©ë¡(ì¤‘ë³µ ì œê±°, â€œì‹œíŠ¸ ìˆœì„œ ìœ ì§€â€)
      async function buildRuneEngraveNameOptions() {
        await ensureEnhLoaded();
        const rows = getRuneEngraveRows();
        const seen = new Set();
        const names = [];

        rows.forEach(r => {
          const k = (r.name || r['ì´ë¦„'] || '').trim();
          if (k && !seen.has(k)) {
            seen.add(k);
            names.push(k);
          }
        });

        const sel1 = document.getElementById('selRuneEngrave');
        const sel2 = document.getElementById('selRuneDetail');
        if (!sel1 || !sel2) return;

        // ë£¬ ê°ì¸ ëª©ë¡ ì´ˆê¸°í™”
        sel1.innerHTML = `<option value="" selected disabled>ë£¬ ê°ì¸ ì„¤ì •</option>`;
        names.forEach(n => {
          const op = document.createElement('option');
          op.value = n;
          op.textContent = n;
          sel1.appendChild(op);
        });

        // ì„¸ë¶€ ì„¤ì •ì€ ì´ˆê¸°ì—” ë¹„í™œì„±í™”
        sel2.innerHTML = `<option value="" selected disabled>ì„¸ë¶€ ì„¤ì •</option>`;
        sel2.disabled = true;
      }

      // ì„¸ë¶€ ì„¤ì •(levelVal) ì˜µì…˜ ì±„ìš°ê¸° â€” ì´ë¦„ê³¼ ì¢…ë¥˜=ë£¬ê°ì¸ ì¼ì¹˜ í–‰ë“¤ì˜ levelVal(ì—†ìœ¼ë©´ tag)ë§Œ
      async function populateRuneDetailOptions(name) {

        await ensureEnhLoaded();
        const sel2 = document.getElementById('selRuneDetail');
        if (!sel2) return;

        sel2.disabled = true;
        sel2.innerHTML = `<option value="" selected disabled>ì„¸ë¶€ ì„¤ì •</option>`;
        if (!name) return;

        const rows = getRuneEngraveRows().filter(r => (r.name || '').trim() === String(name).trim());

        // ì¤‘ë³µ ì œê±° (ì‹œíŠ¸ ìˆœì„œ ìœ ì§€)
        const seenLevel = new Set();
        rows.forEach(r => {
          // â˜… levelVal ìš°ì„ , ì—†ìœ¼ë©´ tag ì‚¬ìš©
          const lv = (r.levelVal ?? r['levelVal'] ?? r.tag ?? r['ë ™ì œ'] ?? '').toString().trim();
          if (!lv) return;
          if (!seenLevel.has(lv)) {
            seenLevel.add(lv);
            const op = document.createElement('option');
            op.value = lv;
            op.textContent = lv;
            sel2.appendChild(op);
          }
        });

        sel2.disabled = false;
      }

      // ë£¬ ê°ì¸ ì ìš© í•¨ìˆ˜ (apiJSON ì‚¬ìš©)
      async function applyRuneEngraveByNameTag(name, tagOrLevelVal) {

        try {
          const res = await apiJSON('run_engrave_select', {
            type: 'ë£¬ê°ì¸',
            name: String(name || '').trim(),
            level: String(tagOrLevelVal || '').trim(),
          });

          if (res?.ok) {
            // ğŸ”¹ í”„ë¡ íŠ¸ ìƒíƒœì— í˜„ì¬ ë£¬ê°ì¸ ì„ íƒ ì •ë³´ ì €ì¥
            state.runeEngrave = state.runeEngrave || {};
            state.runeEngrave.name = String(name || '').trim();
            state.runeEngrave.level = String(tagOrLevelVal || '').trim();

            // res.runeEngrave ì— name/levelì´ ë“¤ì–´ì˜¤ë¯€ë¡œ í•„ìš”í•˜ë©´ ë®ì–´ì¨ë„ ë¨
            if (res.runeEngrave) {
              state.runeEngrave.name = String(res.runeEngrave.name || state.runeEngrave.name || '').trim();
              state.runeEngrave.level = String(res.runeEngrave.level || state.runeEngrave.level || '').trim();
            }

            // í•©ì‚°/ê³„ì‚° ìª½ì€ ê·¸ëŒ€ë¡œ (ì›ë˜ ì£¼ì„ ì²˜ë¦¬ëœ ë¶€ë¶„ ìœ ì§€)
            //await recalcAndRenderPanel();
            //toast('ë£¬ ê°ì¸ ì ìš© ì™„ë£Œ');
          } else {
            console.warn('[run_engrave_select] ì‹¤íŒ¨', res);
            toast('ë£¬ ê°ì¸ ì ìš© ì‹¤íŒ¨');
          }
        } catch (e) {
          console.error('ë£¬ ê°ì¸ ì ìš© ì¤‘ ì˜¤ë¥˜', e);
          toast('ë£¬ ê°ì¸ ì ìš© ì˜¤ë¥˜');
        }
      }

      // ì´ë²¤íŠ¸ ì—°ê²° (ë£¬ê°ì¸ ì„ íƒ â†’ ì„¸ë¶€ì„¤ì • ì±„ì›€ / ì„¸ë¶€ì„¤ì • ì„ íƒ â†’ stateì—ë§Œ ì €ì¥)
      function bindRuneEngraveEvents() {
        const sel1 = document.getElementById('selRuneEngrave');
        const sel2 = document.getElementById('selRuneDetail');
        if (!sel1 || !sel2) return;
        if (sel1._bound) return;

        // 1) ë£¬ê°ì¸ ì´ë¦„ ì„ íƒ ì‹œ â†’ ì„¸ë¶€ ì„¤ì • ì˜µì…˜ ì±„ìš°ê¸° + state.runeEngrave.name ê¸°ì–µ
        sel1.addEventListener('change', (e) => {
          const name = e.target.value || '';
          populateRuneDetailOptions(name); // ì´ë¦„ ì„ íƒ ì‹œ ì„¸ë¶€ ì„¤ì • í™œì„±í™”

          state.runeEngrave = state.runeEngrave || {};
          state.runeEngrave.name = String(name).trim();
          // ì´ë¦„ ë°”ê¾¸ë©´ levelì€ ì•„ì§ ë¯¸ì •ì´ë¯€ë¡œ ì´ˆê¸°í™”
          state.runeEngrave.level = null;
        });

        // 2) ì„¸ë¶€ ì„¤ì •(level) ì„ íƒ ì‹œ â†’ state.runeEngrave.level ê¹Œì§€ ì €ì¥
        sel2.addEventListener('change', (e) => {
          const levelVal = e.target.value || '';
          const name = sel1.value || '';
          if (!name || !levelVal) return;

          state.runeEngrave = state.runeEngrave || {};
          state.runeEngrave.name = String(name).trim();
          state.runeEngrave.level = String(levelVal).trim();

          // âš ï¸ ì—¬ê¸°ì„œëŠ” ë” ì´ìƒ ì„œë²„ í˜¸ì¶œ X
          // ì´ì „ ì½”ë“œ: await applyRuneEngraveByNameTag(name, levelVal);
          // â†’ ì‚­ì œ
        });

        sel1._bound = true;
      }

      // í”„ë¦¬ì…‹/ì´ˆê¸° ìƒíƒœì—ì„œ state.runeEngrave ê°’ì„ ë“œë¡­ë‹¤ìš´ UIì— ë°˜ì˜í•˜ëŠ” í—¬í¼
      function updateRuneEngraveUIFromState() {
        try {
          const sel1 = document.getElementById('selRuneEngrave');
          const sel2 = document.getElementById('selRuneDetail');
          if (!sel1 || !sel2) return;

          const s = window.state || {};
          const re = s.runeEngrave || s.runeengrave || {};
          const name = re.name ? String(re.name).trim() : '';
          const levelVal = re.level ? String(re.level).trim() : '';

          // ê¸°ë³¸ ìƒíƒœë¡œ ë¦¬ì…‹
          sel1.value = '';
          sel2.innerHTML = `<option value="" selected disabled>ì„¸ë¶€ ì„¤ì •</option>`;
          sel2.disabled = true;

          // í”„ë¦¬ì…‹ì— ë£¬ê°ì¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì¢…ë£Œ
          if (!name) return;

          // 1) ì´ë¦„ ë“œë¡­ë‹¤ìš´ ê°’ ë§ì¶”ê¸°
          const opt = Array.from(sel1.options || []).find(
            (o) => String(o.value).trim() === name
          );
          if (!opt) {
            // í”„ë¦¬ì…‹ì— ì €ì¥ëœ ì´ë¦„ì´ í˜„ì¬ ì˜µì…˜ ëª©ë¡ì—ëŠ” ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¬´ì‹œ
            return;
          }
          sel1.value = name;

          // 2) ì„¸ë¶€ ì„¤ì • ì˜µì…˜ ì±„ìš´ ë’¤ levelVal ì ìš©
          populateRuneDetailOptions(name)
            .then(() => {
              if (!levelVal) return;

              const sel2Now = document.getElementById('selRuneDetail');
              if (!sel2Now) return;

              const opt2 = Array.from(sel2Now.options || []).find(
                (o) => String(o.value).trim() === levelVal
              );
              if (opt2) {
                sel2Now.value = levelVal;
                sel2Now.disabled = false;
              }
            })
            .catch((e) => {
              console.warn('[updateRuneEngraveUIFromState] populate ì‹¤íŒ¨:', e);
            });
        } catch (e) {
          console.warn('[updateRuneEngraveUIFromState] ì‹¤íŒ¨:', e);
        }
      }



      /* ENHANCE_SHEETì—ì„œ 'ì´ë¦„' ì •í™• ì¼ì¹˜ë¡œ 1ê°œ ì°¾ê¸° */
      function findEnhByExactName(name) {
        if (!name) return null;
        const list = DBEnh?.list || [];
        const key = String(name).trim();
        return list.find(x => (x?.name || '').trim() === key) || null;
      }

      /* ì•„ë°”íƒ€/ë¬´ê¸°ì•• ì„ íƒ â†’ ì‹œíŠ¸ì—ì„œ ì°¾ì•„ ìƒíƒœì— ë³´ê´€ â†’ í•©ì‚° ê°±ì‹  */
      /* ë“œë¡­ë‹¤ìš´ value â†’ ì‹œíŠ¸ 'ì´ë¦„' ë§¤í•‘ (ì—†ìœ¼ë©´ ì¶”ê°€) */
      const AVATAR_NAME = {
        rare: 'ë ˆì–´ ì•„ë°”íƒ€',
        advanced: 'ìƒê¸‰ ì•„ë°”íƒ€',
        empty: 'ì—†ìŒ',
      };
      const IMPRINT_NAME = {
        add5: 'ì¶”ë€ 5% ë¬´ê¸°ì••',
        patkmatk5: 'ë¬¼/ë§ˆê³µ 5% ë¬´ê¸°ì••',
        patkmatk3: 'ë¬¼/ë§ˆê³µ 3% ë¬´ê¸°ì••',
        monster: 'ëª¬ìŠ¤í„° ë¬´ê¸°ì••',
        quest: 'í€˜ìŠ¤íŠ¸ ë¬´ê¸°ì••',
        empty: 'ì—†ìŒ',
      };

      /* ===== ìºë¦­í„° ì‹œíŠ¸ ë¡œë” ===== */
      const characterCard = document.getElementById('characterCard');
      characterCard.addEventListener('click', openCharacterPicker)
      const characterImg = document.getElementById('characterImg');
      const characterGhost = document.getElementById('characterGhost');
      const charModal = document.getElementById('charModal');
      const catalogEl = document.getElementById('catalog'); /*<div id="catalog" class="catalog"></div> ë¥¼ JSë³€ìˆ˜ catalogElë¡œ ì°¸ì¡°*/
      if (!window.DBChars) window.DBChars = { loaded: false, groups: [] };
      // ë¡œê·¸ì¸ í† í°ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ìœ í‹¸ (ìµœëŒ€ 15ì´ˆ)
      // - í† í°ì´ ì—†ìœ¼ë©´ google.accounts.id.prompt()ë¥¼ í˜¸ì¶œí•´ì„œ ë¡œê·¸ì¸/ì¬ë¡œê·¸ì¸ì„ ë„ì›€
      async function waitForIdToken(timeout = 15000) {
        // 1) ì´ë¯¸ í† í° ìˆìœ¼ë©´ ë°”ë¡œ ë°˜í™˜
        if (window.idToken) return window.idToken;

        // 2) ì—†ìœ¼ë©´ gsi:issued ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ë©´ì„œ, í•„ìš” ì‹œ ë¡œê·¸ì¸ í”„ë¡¬í”„íŠ¸ë„ ë„ì›€
        return new Promise((resolve, reject) => {
          let done = false;

          function cleanup() {
            if (done) return;
            done = true;
            clearTimeout(timer);
            document.removeEventListener('gsi:issued', onReady);
          }

          function onReady() {
            // Google GSIê°€ ìƒˆ í† í°ì„ ë°œê¸‰í•˜ë©´ onGoogleCredentialì—ì„œ
            // window.idTokenì„ ì„¸íŒ…í•˜ê³  gsi:issued ì´ë²¤íŠ¸ë¥¼ ì˜ê¸° ë•Œë¬¸ì— ì—¬ê¸°ë¡œ ì˜´
            if (window.idToken) {
              cleanup();
              resolve(window.idToken);
            }
          }

          // 3) ìµœëŒ€ timeout msê¹Œì§€ ê¸°ë‹¤ë¦¬ë‹¤ê°€ ëª» ë°›ìœ¼ë©´ login_timeout
          const timer = setTimeout(() => {
            cleanup();
            reject(new Error('login_timeout'));
          }, timeout);

          document.addEventListener('gsi:issued', onReady);

          // 4) ê°€ëŠ¥í•˜ë©´ ì¦‰ì‹œ ë¡œê·¸ì¸/ì¬ë¡œê·¸ì¸ íŒì—… ë„ìš°ê¸°
          try {
            if (window.google?.accounts?.id?.prompt) {
              window.google.accounts.id.prompt();
            } else {
              console.warn('[waitForIdToken] google.accounts.id.prompt ì—†ìŒ; One Tap í† í°ì„ ìˆ˜ë™ìœ¼ë¡œ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.');
            }
          } catch (err) {
            cleanup();
            reject(err);
          }
        });
      }


      // ID í† í°ì„ ê°•ì œë¡œ ë‹¤ì‹œ ë°›ëŠ” ìœ í‹¸ (ìë™ ì¬ë¡œê·¸ì¸ìš©)
      async function forceReissueIdToken(timeout = 15000) {
        // ì´ì „ í† í°ì€ ë²„ë¦¬ê³  ìƒˆë¡œ ë°›ëŠ”ë‹¤
        window.idToken = null;

        return new Promise((resolve, reject) => {
          const timer = setTimeout(() => {
            document.removeEventListener('gsi:issued', onReady);
            reject(new Error('relogin_timeout'));
          }, timeout);

          function onReady() {
            if (window.idToken) {
              clearTimeout(timer);
              document.removeEventListener('gsi:issued', onReady);
              resolve(window.idToken);
            }
          }

          document.addEventListener('gsi:issued', onReady);

          try {
            // Google One Tap / ë¡œê·¸ì¸ í”„ë¡¬í”„íŠ¸ ë‹¤ì‹œ ë„ìš°ê¸°
            if (window.google?.accounts?.id?.prompt) {
              window.google.accounts.id.prompt();
            } else {
              console.warn('[forceReissueIdToken] google.accounts.id.prompt ì—†ìŒ; ì‚¬ìš©ìê°€ ì§ì ‘ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.');
            }
          } catch (e) {
            clearTimeout(timer);
            document.removeEventListener('gsi:issued', onReady);
            reject(e);
          }
        });
      }

      // ===== ìºë¦­í„° ì‹œíŠ¸ ë¡œë” (init ì‘ë‹µì˜ ê²½ëŸ‰ ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©) =====
      async function ensureCharactersLoaded() {
        if (window.DBChars?.groups?.length) return true;

        try {
          const items = window.CORE?.lists?.['char:list'];
          if (!Array.isArray(items) || !items.length) {
            throw new Error('char:list not loaded in CORE.lists');
          }

          // âœ… ì§ì—…êµ° ê¸°ì¤€ìœ¼ë¡œ â€œëª¨ë“ â€ ìºë¦­í„°(í™œì„±/ë¹„í™œì„± í¬í•¨) ë¬¶ê¸°
          const grouped = {};
          for (const c of items) {
            const jg = String(c.jobGroup || '').trim();
            if (!grouped[jg]) grouped[jg] = [];
            grouped[jg].push(c);
          }

          // âœ… ë°°ì§€ ì´ë¯¸ì§€ëŠ” â€˜ì¢…ë¥˜(=ë°°ì§€ ì†ŒìŠ¤)â€™ë¥¼ ìš°ì„  ì‚¬ìš©
          //    ì•ˆì „í•˜ê²Œ ì—¬ëŸ¬ í‚¤ë¥¼ ìˆœíšŒ: ['ì¢…ë¥˜','kindSrc','badgeSrc','badge','kind']
          window.DBChars = {
            loaded: true,
            groups: Object.keys(grouped).map(job => {
              const first = grouped[job][0] || {};
              let badgeSrc = first['type'] || ''; // âœ… char:listì˜ ì¢…ë¥˜ ì»¬ëŸ¼

              // âœ… ì¸ë„¤ì¼ì²˜ëŸ¼ ìƒëŒ€ê²½ë¡œë¥¼ ìœ ì§€í•˜ë˜ ë™ì¼ baseì—ì„œ ë¡œë“œë˜ë„ë¡ ì •ê·œí™”
              if (badgeSrc && badgeSrc.startsWith('img/')) {
                badgeSrc = './' + badgeSrc.replace(/^\.?\//, '');
              }

              return {
                title: job,
                items: grouped[job],
                badgeSrc
              };
            })
          };

          return true;
        } catch (err) {
          console.error('[ensureCharactersLoaded]', err);
          (typeof toast === 'function' ? toast : alert)('ìºë¦­í„° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
          return false;
        }
      }

      function renderCatalog() {
        catalogEl.innerHTML = "";
        const groups = DBChars.groups || [];
        if (!groups.length) {
          const msg = document.createElement("div");
          msg.style.color = "#c7b589";
          msg.textContent = "ì‹œíŠ¸ì—ì„œ ìºë¦­í„° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          catalogEl.appendChild(msg);
          return;
        }

        groups.forEach(group => {
          const row = document.createElement("div");
          row.className = "row";

          const left = document.createElement("img");
          left.className = "badge-img";
          left.src = group.badgeSrc || PLACEHOLDER_IMG;
          left.alt = "ë°°ì§€";
          left.onerror = () => (left.src = PLACEHOLDER_IMG);

          const cards = document.createElement("div");
          cards.className = "cards";

          // âœ… ì•„ì´í…œ ë£¨í”„ë§Œ ë‚¨ê¹€
          group.items.forEach(item => {
            const card = document.createElement("button");
            card.className = "char-card";

            const img = document.createElement("img");
            img.className = "char-img";
            img.alt = item.name;
            img.src = item.thumbSrc || PLACEHOLDER_IMG;
            img.onerror = () => (img.src = PLACEHOLDER_IMG);

            const name = document.createElement("div");
            name.className = "char-name";
            name.textContent = item.name;

            card.appendChild(img);
            card.appendChild(name);

            const isDisabled =
              !(
                item.enabled === true ||
                item.enabled === 1 ||
                String(item.enabled).trim() === 'true' ||
                String(item.enabled).trim() === '1'
              );

            if (isDisabled) {
              card.classList.add("disabled");
              card.setAttribute("aria-disabled", "true");
            } else {
              card.addEventListener("click", async (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (card.dataset.loading === "1") return; // âœ… ì¤‘ë³µ í´ë¦­ ë°©ì§€
                card.dataset.loading = "1";
                card.classList.add("loading");

                try {
                  // 1) ì„ íƒí•œ ìºë¦­í„°ì˜ ì •ë³´ ì¶”ì¶œ
                  const jobGroup = group.title;
                  const name = item.name;
                  const sp = Number(String(item.sp ?? 0).replace(/[^\d.-]/g, "")) || 0;
                  const tp = Number(String(item.tp ?? 0).replace(/[^\d.-]/g, "")) || 0;
                  const power = String(item.power ?? item["ë¬¼ë§ˆê³µ"] ?? "").trim();

                  // 2) í”„ë¡ íŠ¸ stateì— ìºë¦­í„° ì •ë³´ ì €ì¥
                  state.currentCharacter = state.currentCharacter || {};
                  state.currentCharacter.jobGroupLabel = jobGroup || "";
                  state.currentCharacter.jobGroup = jobGroup || "";
                  state.currentCharacter.name = name || "";
                  state.currentCharacter.sp = sp;
                  state.currentCharacter.tp = tp;
                  state.currentCharacter.power = power;
                  state.currentCharacter.thumb = item.thumbSrc || "";
                  state.currentCharacter.full = item.fullSrc || item.thumbSrc || "";
                  state.currentCharacter.saveFace = item.faceSrc || item.thumbSrc || item.fullSrc || "";

                  // 3) ìºë¦­í„° ì´ë¯¸ì§€ / ê³ ìŠ¤íŠ¸ / ë¼ë²¨ UI ê°±ì‹ 
                  const characterImg = document.getElementById("characterImg");
                  const characterGhost = document.getElementById("characterGhost");
                  if (characterImg) {
                    characterImg.src = item.fullSrc || item.thumbSrc || PLACEHOLDER_IMG;
                    characterImg.style.display = "block";
                  }
                  if (characterGhost) {
                    characterGhost.style.display = "none";
                  }

                  const $charLabel = document.getElementById("charLabel");
                  if ($charLabel) {
                    if (name) {
                      $charLabel.textContent = jobGroup
                        ? `${jobGroup} / ${name}`
                        : name;
                    } else {
                      $charLabel.textContent = "ìºë¦­í„° ë¯¸ì„ íƒ";
                    }
                  }

                  // 3-1) ìºë¦­í„°ë¥¼ ë°”ê¾¸ë©´ ë¬´ê¸° ë¬´ì¡°ê±´ ë¹„ìš°ê¸°
                  (function () {
                    try {
                      const s = window.state || state || {};
                      s.selections = s.selections || {};

                      if (!s.selections.weapon) {
                        console.log('[char change] weapon: ì—†ìŒ, ê±´ë„ˆëœ€');
                        return;
                      }

                      console.log('[char change] ìºë¦­í„° ë³€ê²½ â†’ ë¬´ê¸° ì´ˆê¸°í™”');

                      // 1) ìƒíƒœì—ì„œ ë¬´ê¸° ì‚­ì œ
                      delete s.selections.weapon;

                      // 2) ìŠ¬ë¡¯ DOM ì°¾ì•„ì„œ ê¸°ë³¸ ë¼ë²¨ë¡œ ì´ˆê¸°í™”
                      let slotEl = null;
                      if (typeof tileElForSlot === 'function') {
                        slotEl = tileElForSlot('weapon');      // ì„œë²„ ìŠ¬ë¡¯í‚¤ ê¸°ì¤€
                      } else {
                        slotEl = document.querySelector('.slot[data-slot="R1"]');
                      }

                      if (slotEl) {
                        const domKey = slotEl.dataset.slot || 'R1';
                        const baseLabel =
                          (typeof SLOT_BASE_LABELS === 'object' && SLOT_BASE_LABELS[domKey]) ||
                          (typeof labelForSlot === 'function' ? labelForSlot('weapon') : 'ë¬´ê¸°');

                        const labelEl = document.createElement('span');
                        labelEl.className = 'slot-label';
                        labelEl.textContent = baseLabel;

                        slotEl.innerHTML = '';
                        slotEl.appendChild(labelEl);
                        slotEl.classList.remove('selected');
                        slotEl.removeAttribute('data-name');
                      }

                      // 3) ì¥ë¹„ ì„¤ëª…/ë„íŠ¸ ë“± ì˜ì¡´ UIë„ ê°™ì´ ë¦¬í”„ë ˆì‹œ (ìˆìœ¼ë©´)
                      try {
                        if (typeof updateEquipDescPreview === 'function') {
                          updateEquipDescPreview();
                        }
                        if (typeof refreshAllDots === 'function') {
                          refreshAllDots();
                        }
                        if (typeof refreshEnhLabelsFromState === 'function') {
                          refreshEnhLabelsFromState();
                        }
                        if (typeof refreshSealLabelsFromState === 'function') {
                          refreshSealLabelsFromState();
                        }
                      } catch (inner) {
                        console.warn('[char change] extra UI refresh error', inner);
                      }

                    } catch (e2) {
                      console.warn('[char change] weapon auto-reset failed', e2);
                    }
                  })();


                  // 4) ìŠ¤í‚¬íŠ¸ë¦¬ ìƒíƒœ ì´ˆê¸°í™” (ìºë¦­í„° ë°”ë€” ë•Œë§ˆë‹¤ ì´ˆê¸°í™”)
                  state.skillLv = {};
                  state.skillTpLv = {};



                  // 5) SP/TP í‘œì‹œë§Œ ë¡œì»¬ì—ì„œ ê°±ì‹  (í•©ì‚°ìŠ¤íƒ¯ì€ ì´ì œ ê³„ì‚°í•˜ê¸° ë²„íŠ¼ì—ì„œ)
                  if (typeof setTotals === "function") {
                    setTimeout(() => {
                      setTotals(sp, tp);
                    }, 0);
                  }

                  // 6) ëª¨ë‹¬ ë‹«ê¸°
                  setTimeout(closeCharacterPicker, 0);
                } catch (err) {
                  console.error("[char pick]", err);
                  alert("ìºë¦­í„° ì •ë³´ë¥¼ ì ìš©í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                } finally {
                  delete card.dataset.loading;
                  card.classList.remove("loading");
                }
              });

            }

            cards.appendChild(card);
          });

          // (ì„ íƒ) ì˜¤ë¥¸ìª½ ì¥ì‹ ì¶”ê°€í•˜ë ¤ë©´ ì£¼ì„ í•´ì œ
          // const right = document.createElement("div");
          // right.textContent = "âœ¶";
          // right.style.opacity = ".3";
          // right.style.textAlign = "center";
          // right.style.color = "#d8c088";

          row.appendChild(left);
          row.appendChild(cards);
          // row.appendChild(right); // í•„ìš” ì‹œ ì‚¬ìš©
          catalogEl.appendChild(row);
        });
      }

      function openReplyPopup(info) {   //ë¬¸ì˜ ë‹µì¥ íŒì—…
        const $m = document.getElementById('replyModal');
        if (!$m) return;

        const $orig = document.getElementById('replyOriginal');
        const $ans = document.getElementById('replyAnswer');
        const $chk = document.getElementById('replyDontShow');

        if ($orig) {
          $orig.textContent = info.talk || '(ë¬¸ì˜ ë‚´ìš© ì—†ìŒ)';
        }
        if ($ans) {
          $ans.textContent = info.reply || '';
        }
        if ($chk) {
          $chk.checked = false;   // í•­ìƒ ì²´í¬ í•´ì œ ìƒíƒœë¡œ ì‹œì‘
        }

        // â˜… í˜„ì¬ ë‹µì¥ í–‰ ë²ˆí˜¸ë¥¼ ì „ì—­ì— ê¸°ì–µ
        window.__pendingReplyRow = info.row || null;

        $m.classList.add('show');
        $m.setAttribute('aria-hidden', 'false');
      }

      // ë‹«ê¸° ì²˜ë¦¬
      (function bindReplyModalClose() {
        const $m = document.getElementById('replyModal');
        if (!$m) return;

        $m.addEventListener('click', (e) => {
          const t = e.target;
          if (t.hasAttribute('data-reply-close') || t.classList.contains('backdrop')) {
            $m.classList.remove('show');
            $m.setAttribute('aria-hidden', 'true');
          }
        });
      })();
      // ë‹µì¥ ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼ ì²˜ë¦¬
      (function bindReplyConfirm() {
        const btn = document.getElementById('replyConfirmBtn');
        const modal = document.getElementById('replyModal');
        const chk = document.getElementById('replyDontShow');
        if (!btn || !modal) return;
        if (btn._bound) return;
        btn._bound = true;

        btn.addEventListener('click', async () => {
          const dontShow = chk && chk.checked;
          const row = window.__pendingReplyRow;

          // ëª¨ë‹¬ ë‹«ê¸°
          modal.classList.remove('show');
          modal.setAttribute('aria-hidden', 'true');

          // ì²´í¬ ì•ˆ í–ˆìœ¼ë©´ ì„œë²„ì— ì•„ë¬´ê²ƒë„ ì•ˆ ë³´ë‚´ê³  ë
          if (!dontShow || !row) return;

          try {
            await apiJSON('contact_ack', { row });
          } catch (e) {
            console.warn('[replyConfirm] contact_ack ì‹¤íŒ¨:', e);
            // ì‹¤íŒ¨í•´ë„ ì‚¬ìš©ì ì…ì¥ì—ì„  ëª¨ë‹¬ì€ ì´ë¯¸ ë‹«í˜”ìœ¼ë‹ˆ, ì—¬ê¸°ì„  ì¡°ìš©íˆ ë¡œê·¸ë§Œ
          }
        });
      })();


      // ëª¨ë‹¬ ì—´ê¸° / ë‹«ê¸°
      async function openCharacterPicker() {
        const modal = document.getElementById('charModal');
        if (!modal) return;

        // ê¸°ì¡´ì—ëŠ” ë°”ë¡œ renderCatalog() í–ˆì„ ìˆ˜ë„ ìˆìŒ
        const ok = await ensureCharactersLoaded();
        if (ok) renderCatalog();

        modal.classList.add('show');
      }
      function closeCharacterPicker() {
        charModal.classList.remove("show");
        charModal.setAttribute("aria-hidden", "true");
      }
      charModal.addEventListener("click", (e) => { if (e.target.hasAttribute("data-close") || e.target.classList.contains("backdrop")) { closeCharacterPicker(); } });


      /* !@#$ */
      const norm = (v) => String(v ?? '').replace(/\s+/g, ' ').trim();
      /*function getCurrentJobGroup() {
        const v = state?.currentCharacter?.jobGroup ?? state?.currentCharacter?.jobGroupLabel ?? '';
        return String(v).replace(/\s+/g, ' ').trim();
      }*/
      // ì „ì—­ ìºì‹œ: ìŠ¬ë¡¯ë³„ ëª©ë¡ ë³´ê´€
      if (!window.DBEquip) window.DBEquip = {};  // { weapon:{loaded:true, items:[...]}, top:{...}, ... }


      // slotKey â†’ CORE.lists í‚¤ ì°¾ê¸° ('slot:list'ê°€ ì •ì‹, 'slot:lists'ë„ í—ˆìš©)
      function getListArray(slotKey) {
        const lists = getCoreListsRoot();
        if (!lists) return [];

        const key1 = `${slotKey}:list`;   // ì •ì‹

        let arr = lists[key1];
        // rows ë˜í•‘ë˜ì–´ ìˆì„ ìˆ˜ë„ ìˆìŒ
        if (arr && typeof arr === 'object' && Array.isArray(arr.rows)) arr = arr.rows;
        return Array.isArray(arr) ? arr : [];
      }

      // ì»¬ëŸ¼ ì •ê·œí™”(í”„ë¡ íŠ¸ê°€ ì“°ë˜ í˜•íƒœë¡œ í†µì¼)
      function mapEquipRow(row) {
        const S = (v) => (v == null ? '' : String(v));
        const N = (v) => {
          const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
          return Number.isFinite(n) ? n : 0;
        };
        const ì´ë¦„ = row['ì´ë¦„'] ?? row.name ?? row.title ?? '';
        const ì¢…ë¥˜ = row['ì¢…ë¥˜'] ?? row.type ?? row.category ?? '';
        const ë ™ì œ = row['ë ˆë²¨ì œí•œ'] ?? row['ë ™ì œ'] ?? row.level ?? row.reqLevel ?? 0;
        const ì´ë¯¸ì§€ = row['ì´ë¯¸ì§€'] ?? row.image ?? row.img ?? '';
        const ì§ì—…êµ° = row['ì§ì—…êµ°'] ?? row.jobGroup ?? '';
        return {
          name: S(ì´ë¦„),
          type: S(ì¢…ë¥˜),          // íƒ­/í—ˆìš©ë¬´ê¸° í•„í„°ìš©
          level: N(ë ™ì œ),
          img: S(ì´ë¯¸ì§€),
          jobGroup: S(ì§ì—…êµ°),    // ë¬´ê¸° ì§ì—…êµ° í•„í„°ìš©
          _raw: row
        };
      }

      // ì§ì—…êµ° ëŠìŠ¨ ë§¤ì¹­(ë°±ì—”ë“œ ë¡œì§ ë™ì¼)
      const _J = s => String(s ?? '').trim().replace(/\s+/g, '').replace(/[()]/g, '').toLowerCase();
      const _baseJG = s => _J(s).replace(/^(ë‚¨ì|ì—¬ì|ë‚¨|ì—¬)/, '');
      function matchJobGroup(cell, req) {
        const a = _baseJG(cell), b = _baseJG(req);
        if (!a || !b) return true; // í•œìª½ ë¹„ë©´ ë§¤ì¹˜ í—ˆìš©
        return a.includes(b) || b.includes(a);
      }



      // ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ìš© ë³„ì¹­ (openItemPickerê°€ í˜¸ì¶œ)
      async function ensureLoaded(slotKey) {
        const job = (slotKey === 'weapon') ? getCurrentJobGroup() : undefined;
        await ensureEquipListLoaded(slotKey, job);
      }





      /* ===== ì•„ì´í…œ í”¼ì»¤ (í”„ë¡ íŠ¸ ì „ìš© / CORE.lists ê¸°ë°˜) ===== */
      const itemModal = document.getElementById('itemModal');
      const itemList = document.getElementById('itemList');
      const itemSearch = document.getElementById('itemSearch');
      const weaponTabs = document.getElementById('weaponTabs');
      const itemDlgTitle = document.getElementById('itemDlgTitle');

      // --- CORE.lists ë£¨íŠ¸ ---
      function _coreRoot() {
        const core = (window.CORE && (window.CORE.data || window.CORE))
          || (window.CORE_DATA && (window.CORE_DATA.data || window.CORE_DATA))
          || null;
        return core ? (core.lists || {}) : null;
      }

      // --- slotKey â†’ ë°°ì—´ ---
      function _getListArray(slotKey) {
        const lists = _coreRoot();
        if (!lists) return [];
        const key1 = `${slotKey}:list`;     // ì •ì‹ í‚¤
        const key2 = `${slotKey}:lists`;    // ë³µìˆ˜í˜• ëŒ€ì‘
        const key3 = slotKey;               // í˜¹ì‹œ ë‹¨ë… í‚¤
        let arr = lists[key1] ?? lists[key2] ?? lists[key3] ?? [];
        if (arr && typeof arr === 'object' && Array.isArray(arr.rows)) arr = arr.rows;
        return Array.isArray(arr) ? arr : [];
      }

      // --- í–‰ ì •ê·œí™” ---
      function _mapEquipRow(row) {
        const S = (v) => (v == null ? '' : String(v));
        const N = (v) => {
          const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
          return Number.isFinite(n) ? n : 0;
        };
        const ì´ë¦„ = row['ì´ë¦„'] ?? row.name ?? row.title ?? '';
        const ì¢…ë¥˜ = row['ì¢…ë¥˜'] ?? row.type ?? row.category ?? '';
        const ë ™ì œ = row['ë ˆë²¨ì œí•œ'] ?? row['ë ™ì œ'] ?? row.level ?? row.reqLevel ?? 0;
        const ì´ë¯¸ì§€ = row['ì´ë¯¸ì§€'] ?? row.image ?? row.img ?? '';
        const ì§ì—…êµ° = row['ì§ì—…êµ°'] ?? row.jobGroup ?? '';
        const í¬ê·€ë„ = row['ë ˆì–´ë¦¬í‹°'] ?? row['í¬ê·€ë„'] ?? row['ë“±ê¸‰'] ?? row.rarity ?? '';
        const ë°©ì–´êµ¬í¬ì¸íŠ¸ = row['ë°©ì–´êµ¬í¬ì¸íŠ¸'] ?? row.armpoint ?? '';
        const ì•…ì„¸í¬ì¸íŠ¸ = row['ì•…ì„¸í¬ì¸íŠ¸'] ?? row.accpoint ?? '';
        const ë³´ì¡°ì¥ë¹„í¬ì¸íŠ¸ = row['ë³´ì¡°ì¥ë¹„í¬ì¸íŠ¸'] ?? row.subpoint ?? '';
        const ì ‘ë‘ì‚¬ = row['ì ‘ë‘ì‚¬'] ?? row.prefix ?? '';
        const ì„¤ëª… = row['ì„¤ëª…'] ?? row.desc ?? row.description ?? '';
        return {
          name: S(ì´ë¦„),
          type: S(ì¢…ë¥˜),
          level: N(ë ™ì œ),
          img: S(ì´ë¯¸ì§€),
          jobGroup: S(ì§ì—…êµ°),
          rarity: S(í¬ê·€ë„),
          armpoint: S(ë°©ì–´êµ¬í¬ì¸íŠ¸),
          accpoint: S(ì•…ì„¸í¬ì¸íŠ¸),
          subpoint: S(ë³´ì¡°ì¥ë¹„í¬ì¸íŠ¸),
          prefix: S(ì ‘ë‘ì‚¬),
          desc: S(ì„¤ëª…),
          _raw: row
        };
      }

      // ì¥ë¹„ ì ‘ë‘ì‚¬ í…ìŠ¤íŠ¸ë¥¼ ë¼ë²¨ìš©ìœ¼ë¡œ ì •ë¦¬ (ê³µë°±/ì½œë¡  ì œê±°)
      function makeEquipPrefixLabel(raw) {
        if (raw == null) return '';
        const txt = String(raw).trim();
        if (!txt) return '';
        return txt.replace(/\s+/g, '').replace(/:/g, '');
      }


      // --- ì§ì—…êµ° ë§¤ì¹­ ìœ í‹¸ ---

      function jgMatches(itemJG, charJG) {
        const a = _baseJG(itemJG), b = _baseJG(charJG);
        if (!a || !b) return true;
        return a.includes(b) || b.includes(a);
      }

      // âœ… ìºì‹œ ë¡œë”©ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë˜, job ë¬¸ìì—´ì€ í•­ìƒ trim
      async function ensureEquipListLoaded(slotKey, jobGroup) {
        const job = String(jobGroup ?? '').trim();
        const cacheKey = `${slotKey}::${slotKey === 'weapon' ? job : ''}`;

        window.DBEquip ||= {};
        const curVer = state.slotVer?.[slotKey] || 0;

        // ê¸°ì¡´ ìºì‹œ í™•ì¸
        const entry = window.DBEquip[cacheKey];

        // â˜… version-token ë¹„êµ
        if (entry && entry.loaded && entry.ver === curVer) {
          return; // ê·¸ëŒ€ë¡œ ì‚¬ìš©
        }

        // â˜… version-tokenì´ ë‹¤ë¥´ê±°ë‚˜ ìºì‹œê°€ ì—†ìœ¼ë©´ ê°•ì œ ì¬ë¡œë”©
        let rows = _getListArray(String(slotKey || '').trim());

        if (slotKey === 'weapon' && job) {
          const hasJG = rows.some(r => r && (r['ì§ì—…êµ°'] || r.jobGroup));
          if (hasJG) rows = rows.filter(r => jgMatches(r['ì§ì—…êµ°'] || r.jobGroup, job));
        }

        const items = rows
          .filter(r => r && (r['ì´ë¦„'] || r.name || r.title))
          .map(_mapEquipRow);

        // â˜… version-token ì €ì¥
        window.DBEquip[cacheKey] = {
          loaded: true,
          items,
          ver: curVer,
        };
      }

      // âœ… í•­ìƒ ë™ì¼í•œ í‚¤ ê·œì¹™ìœ¼ë¡œ DBEquipì—ì„œ ê°€ì ¸ì˜¤ê¸° (SumStats.JobGroup ì‚¬ìš©)
      function getItemsForSlot(slotKey, jobGroup) {
        window.DBEquip ||= {};
        const job = (slotKey === 'weapon')
          ? String(
            jobGroup
            ?? state?.currentCharacter?.jobGroup
            ?? state?.currentCharacter?.jobGroupLabel
            ?? ''
          ).trim()
          : '';
        const cacheKey = `${slotKey}::${slotKey === 'weapon' ? job : ''}`;
        return (window.DBEquip[cacheKey]?.items || []).slice();
      }

      // âœ… ë¬´ê¸° íƒ­ë„ SumStats.JobGroup ê¸°ì¤€ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ë„ë¡ ê³ ì •
      async function renderWeaponTabs(jobGroup) {
        const job = String(
          jobGroup
          || state?.currentCharacter?.jobGroup
          || state?.currentCharacter?.jobGroupLabel
          || ''
        ).trim();
        await ensureEquipListLoaded('weapon', job);

        const all = getItemsForSlot('weapon', job);

        const AWT = (window.ALLOWED_WEAPON_TYPES || {});
        const allowedSet = new Set(AWT[job] || AWT[_baseJG?.(job)] || []);

        const filtered = all.filter(it =>
          (!it.jobGroup || jgMatches(it.jobGroup, job)) &&
          (!allowedSet.size || allowedSet.has(it.type))
        );
        const types = [...new Set(filtered.map(it => it.type).filter(Boolean))];

        if (!weaponTabs) return;
        weaponTabs.innerHTML = '';

        if (!types.length) {
          weaponTabs.style.display = 'none';
          if (state?.ui) state.ui.weaponTypeTab = '';
          return;
        }
        weaponTabs.style.display = 'flex';

        state ||= {};
        state.ui ||= {};
        if (!state.ui.weaponTypeTab || !types.includes(state.ui.weaponTypeTab)) {
          state.ui.weaponTypeTab = types[0];
        }

        const updateActive = () => {
          [...weaponTabs.children].forEach(ch =>
            ch.classList.toggle('active', ch.getAttribute('data-type') === state.ui.weaponTypeTab)
          );
        };

        types.forEach(t => {
          const b = document.createElement('button');
          b.className = 'tab-btn' + (t === state.ui.weaponTypeTab ? ' active' : '');
          b.textContent = t;
          b.setAttribute('data-type', t);
          b.onclick = () => {
            state.ui.weaponTypeTab = t;
            const q = (itemSearch?.value || '');
            renderItems('weapon', q);
            updateActive();
          };
          weaponTabs.appendChild(b);
        });

        updateActive();
      }

      // âœ… ëª©ë¡ ë Œë”: ë¬´ê¸°ì¼ ë•Œë„ DBEquipì—ì„œë§Œ ê°€ì ¸ì˜¤ë„ë¡ í†µì¼
      function renderItems(slotKey, query = '') {
        itemList.innerHTML = '';

        const q = (query || '').trim().toLowerCase();
        const job = String(
          state?.currentCharacter?.jobGroup
          || state?.currentCharacter?.jobGroupLabel
          || ''
        ).trim();

        let items = getItemsForSlot(slotKey, job);
        if (slotKey === 'weapon' && state?.ui?.weaponTypeTab) {
          items = items.filter(it => it.type === state.ui.weaponTypeTab);
        }
        if (q) {
          items = items.filter(it =>
            (it.name || '').toLowerCase().includes(q) ||
            (it.type || '').toLowerCase().includes(q)
          );
        }

        if (!items.length) {
          const msg = document.createElement('div');
          msg.style.color = '#c7b589';
          msg.textContent = 'ì¡°ê±´ê³¼ ì¼ì¹˜í•˜ëŠ” ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.';
          itemList.appendChild(msg);
          return;
        }

        items.forEach(it => {
          const row = document.createElement('button');
          row.className = 'item-row';
          const isBottom = (slotKey === 'aura' || slotKey === 'title' || slotKey === 'creature' || slotKey === 'artifact');
          const badge = isBottom ? (it.level_text && String(it.level_text).trim()) : `Lv.${it.level ?? 65}`;
          const lvlLabel = isBottom ? (it.level_text && String(it.level_text).trim()) : `${it.level ?? 65}ë ˆë²¨`;

          // âœ… ë ˆì–´ë¦¬í‹° í…ìŠ¤íŠ¸ / í´ë˜ìŠ¤ ê²°ì •
          const rawRarity = String(
            (it.rarity ?? '') ||
            (it._raw && (it._raw.rarity || it._raw['ë ˆì–´ë¦¬í‹°'] || it._raw['í¬ê·€ë„'] || it._raw['ë“±ê¸‰'])) ||
            ''
          ).trim();

          let rarityLabel = rawRarity;
          let rarityClass = '';

          const lower = rarityLabel.toLowerCase();

          if (!rarityLabel) {
            // ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì—í”½ ì²˜ë¦¬
            rarityLabel = 'ì—í”½';
            rarityClass = 'rarity-epic';
          } else if (rarityLabel === 'ì—í”½' || lower === 'epic') {
            rarityLabel = 'ì—í”½';
            rarityClass = 'rarity-epic';
          } else if (rarityLabel === 'ìµì‹œë“œ' || lower === 'exceed') {
            rarityLabel = 'ìµì‹œë“œ';
            rarityClass = 'rarity-exceed';
          } else if (rarityLabel === 'ë ˆì–´' || lower === 'rare') {
            rarityLabel = 'ë ˆì–´';
            rarityClass = 'rarity-rare';
          } else if (rarityLabel === 'ìœ ë‹ˆí¬' || lower === 'unique') {
            rarityLabel = 'ìœ ë‹ˆí¬';
            rarityClass = 'rarity-unique';
          } else {
            // í˜¹ì‹œ ë‹¤ë¥¸ ê°’ì´ ë“¤ì–´ì™€ë„ ê¸°ë³¸ì¹© ì ìš©
            rarityClass = 'rarity-epic';
          }

          row.innerHTML = `
      <div class="iconbox">
        <img class="icon" src="${it.img || PLACEHOLDER_IMG}" alt="${it.name}">
        ${badge ? `<span class="badge-lv">${badge}</span>` : ``}
      </div>
      <div class="meta">
        <div class="meta-top">${lvlLabel ? `<span class="lvl">${lvlLabel}</span>` : ``}<span class="name">${it.name}</span></div>
        <div class="meta-sub">${it.type || ''}</div>
      </div>
      <div class="right"><span class="rarity-chip ${rarityClass}">${rarityLabel}</span></div>`;

          row.onclick = (e) => {
  const isWeapon = (slotKey === 'weapon');
  const isToggleAuto = isWeapon && (e.shiftKey || e.ctrlKey || e.metaKey);

  if (isToggleAuto) {
    const auto = state.autoSweep || (state.autoSweep = { armor: [], acc: [], spec: [], weapon: [], weaponCustom: [] });
    const name = String(it?.name || '').trim();
    if (!name) return;

    const idx = auto.weapon.indexOf(name);
    if (idx >= 0) auto.weapon.splice(idx, 1);
    else auto.weapon.push(name);

    row.classList.toggle('is-auto', idx < 0); // í‘œì‹œìš©(ì„ íƒ)
    toast?.(`ìë™ê³„ì‚° ë¬´ê¸° ${idx < 0 ? 'ì¶”ê°€' : 'í•´ì œ'}: ${name}`);
    return; // âœ… ì—¬ê¸°ì„œ ë (ì¥ì°© ì•ˆ í•¨, ëª¨ë‹¬ ë‹«ì§€ ì•ŠìŒ)
  }

  // âœ… ê¸°ì¡´ ë™ì‘ ê·¸ëŒ€ë¡œ
  applyItemToSlot(slotKey, it);
  closeItemPicker();
};


          const icon = row.querySelector('.icon');
          icon.onerror = () => { icon.src = PLACEHOLDER_IMG; };

          itemList.appendChild(row);
        });
      }

      async function openItemPicker(slotKey) {
        state.currentSlotKey = slotKey;

        // â˜… ìºë¦­í„° ë¯¸ì„ íƒ ê°€ë“œ (ëª¨ë“  ìŠ¬ë¡¯ ê³µí†µ)
        const job = String(
          state?.currentCharacter?.jobGroup
          || state?.currentCharacter?.jobGroupLabel
          || ''
        ).trim();
        if (!job) {
          try {
            if (typeof toast === 'function') toast('ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
            else alert('ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
          } catch (_) { }
          if (typeof openCharacterPicker === 'function') openCharacterPicker();
          return;
        }

        // ë¬´ê¸°ì¼ ë•Œë§Œ ì§ì—…êµ°ì„ ì„œë²„ì— ì „ë‹¬ (ë‚˜ë¨¸ì§€ ìŠ¬ë¡¯ì€ ì „ë‹¬ X)
        const passJob = (slotKey === 'weapon') ? job : undefined;
        await ensureEquipListLoaded(slotKey, passJob);

        if (slotKey === 'weapon') {
          itemDlgTitle.textContent = 'ë¬´ê¸° ì„ íƒ';
          if (!job) { openCharacterPicker(); return; }  // ìºë¦­ ë¯¸ì„ íƒ ë³´í˜¸
          await renderWeaponTabs(job);
        } else {
          itemDlgTitle.textContent = labelForSlot(slotKey) + ' ì„ íƒ';
          weaponTabs.style.display = 'none';
        }

        renderItems(slotKey);
        itemModal.classList.add('show');
        itemModal.setAttribute('aria-hidden', 'false');

        itemSearch.value = '';
        itemSearch.oninput = () => renderItems(slotKey, itemSearch.value);
      }
      function closeItemPicker() { itemModal.classList.remove('show'); itemModal.setAttribute('aria-hidden', 'true'); }
      itemModal.addEventListener('click', (e) => { if (e.target.hasAttribute('data-close') || e.target.classList.contains('backdrop')) closeItemPicker(); });
      // ì•„ì´í…œ ì„ íƒ í›„ ìŠ¬ë¡¯ì— ì ìš©
      async function applyItemToSlot(slotKey, item) {
        try {
          if (!window.state) window.state = {};
          const state = window.state;
          state.selections = state.selections || {};

          // â˜… ì ‘ë‘ì‚¬ ì›ë³¸ ë¬¸ìì—´ ê°€ì ¸ì˜¤ê¸°
          const rawPrefix =
            (item && item.prefix) ||
            (item && item._raw && (item._raw['ì ‘ë‘ì‚¬'] ?? item._raw.prefix)) ||
            '';

          // â˜… ìŠ¬ë¡¯ ë¼ë²¨ì— ì“¸ ì§§ì€ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
          const prefixLabel = makeEquipPrefixLabel(rawPrefix);

          // â˜… state.selections ì•ˆì—ë„ prefixLabel + ê¸°ë³¸ ë©”íƒ€(ë ˆë²¨/ë ˆì–´ë¦¬í‹°) ì €ì¥
          const rawLevel =
            (item && (item.level ?? item.levelVal ?? (item._raw && (item._raw['ë ™ì œ'] ?? item._raw.level)))) ?? '';
          const levelVal = parseInt(String(rawLevel).replace(/[^\d.-]/g, ''), 10);

          const rawRarity = String(
            (item && (item.rarity ?? '')) ||
            (item && item._raw && (item._raw.rarity || item._raw['ë ˆì–´ë¦¬í‹°'] || item._raw['í¬ê·€ë„'] || item._raw['ë“±ê¸‰'])) ||
            ''
          ).trim();

          let rarityNorm = rawRarity;
          const rarityLower = rarityNorm.toLowerCase();
          if (rarityNorm === 'ì—í”½' || rarityLower === 'epic') {
            rarityNorm = 'ì—í”½';
          } else if (rarityNorm === 'ìµì‹œë“œ' || rarityLower === 'exceed') {
            rarityNorm = 'ìµì‹œë“œ';
          }

          state.selections[slotKey] = {
            name: item.name,
            img: item.img || null,
            code: item.code || null,
            type: item.type || '',      // â˜… ì„¸íŠ¸ ë§¤ì¹­ìš© íƒ€ì… ì¶”ê°€
            prefixLabel: prefixLabel || null,
            desc:
              item.desc ||
              (item._raw && (item._raw['ì„¤ëª…'] ?? item._raw.desc)) ||
              '',
            level: Number.isFinite(levelVal) ? levelVal : null,
            rarity: rarityNorm || null,
          };


          // â˜… ì„¸íŠ¸ ê²½ëŸ‰ë¦¬ìŠ¤íŠ¸ í—¬í¼ (CORE.lists['set:list'] ì‚¬ìš©)
          function getLightSetList() {
            const core = (window.CORE && window.CORE.lists) || {};
            const list = core['set:list'];
            return Array.isArray(list) ? list : [];
          }
          // â˜… ìŠ¬ë¡¯ íƒ€ì¼ì— ë¼ë²¨ + ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
          const tile = tileElForSlot(slotKey);
          if (tile) {
            const safeAlt = String(item.name || '').replace(/"/g, '&quot;');
            const src = item.img || PLACEHOLDER_IMG;
            const labelHtml = prefixLabel
              ? `<div class="equip-prefix">${prefixLabel}</div>`
              : '';

            tile.innerHTML =
              labelHtml +
              `<img class="item-img" alt="${safeAlt}"` +
              ` src="${src}" style="width:70%;height:70%;border-radius:8px;">`;
            tile.classList.add('selected');
          }

          // ëª¨ë‹¬ ë‹«ê¸°
          const modal = document.getElementById('itemModal');
          if (modal) {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
          }

          // ì— ë¸”ë ˜/ì„±ì•ˆì˜ ë´‰ì¸/ê°•í™” ë¼ë²¨ ë“± ë¶€ê°€ UI ë¦¬í”„ë ˆì‹œ
          if (typeof refreshAllDots === 'function') {
            refreshAllDots();   // ì— ë¸”ë ˜ ë„íŠ¸
          }
          if (typeof refreshSealLabelsFromState === 'function') {
            refreshSealLabelsFromState();
          }
          if (typeof refreshEnhLabelsFromState === 'function') {
            refreshEnhLabelsFromState();
          }
          // â˜… ì»¤ìŠ¤í…€ì˜µ ì¡°ê±´ ê²€ì‚¬ â†’ ì•ˆ ë§ëŠ” ê±´ ìë™ ì´ˆê¸°í™”
          if (typeof enforceCustomSkillConstraints === 'function') {
            enforceCustomSkillConstraints();
          }
          // â˜… ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ê°±ì‹ 
          if (typeof updateEquipDescPreview === 'function') {
            updateEquipDescPreview();
          }
        } catch (e) {
          console.warn('[applyItemToSlot] ì‹¤íŒ¨:', e);
        }
      }

      // âœ… ë°©ì–´êµ¬ ì„¸íŠ¸ í•œ ë²ˆì— ì ìš©
      async function applyArmorSetToSlots(set) {
        try {
          if (!set || !Array.isArray(set.pieces)) return;

          for (const piece of set.pieces) {
            const slotKey = piece.slot;    // 'top', 'bottom', 'headshoulder', 'belt', 'shoes'
            const item = piece.item;       // buildArmorSetCardsFromSheets ì—ì„œ ë„£ì–´ë‘” row

            if (!slotKey || !item) continue;

            // ê¸°ì¡´ ê°œë³„ ì¥ë¹„ ì ìš© ë¡œì§ ì¬ì‚¬ìš©
            await applyItemToSlot(slotKey, item);
          }

          // ì„¸íŠ¸ ì ìš© ëë‚˜ë©´ ëª¨ë‹¬ ë‹«ê¸°
          showModal($armorSetModal, false);
        } catch (e) {
          console.warn('[applyArmorSetToSlots] ì‹¤íŒ¨:', e);
        }
      }

      // âœ… ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸ í•œ ë²ˆì— ì ìš©
      async function applyAccSetToSlots(set) {
        try {
          if (!set || !Array.isArray(set.pieces)) return;

          for (const piece of set.pieces) {
            const slotKey = piece.slot;  // 'bracelet', 'necklace', 'ring'
            const item = piece.item;
            if (!slotKey || !item) continue;

            await applyItemToSlot(slotKey, item);
          }

          showModal($accSetModal, false);
        } catch (e) {
          console.warn('[applyAccSetToSlots] ì‹¤íŒ¨:', e);
        }
      }

      // âœ… íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸ í•œ ë²ˆì— ì ìš©
async function applySpecSetToSlots(set) {
  try {
    if (!set || !Array.isArray(set.pieces)) return;

    for (const piece of set.pieces) {
      const slotKey = piece.slot;  // 'sub', 'magestone', 'earring'
      const item = piece.item;
      if (!slotKey || !item) continue;

      await applyItemToSlot(slotKey, item);
    }

    showModal($specSetModal, false);
  } catch (e) {
    console.warn('[applySpecSetToSlots] ì‹¤íŒ¨:', e);
  }
}

// ì¹´ë“œ í´ë¦­ â†’ ì„¸íŠ¸ ì ìš©
$specSetList?.addEventListener('click', (e) => {
  const card = e.target.closest('.armor-set-card');
  if (!card) return;

  const idx = parseInt(card.dataset.setIndex || '-1', 10);
  const sets = (window._specSetCardsCache && Array.isArray(window._specSetCardsCache))
    ? window._specSetCardsCache
    : [];

  if (!(idx >= 0 && idx < sets.length)) return;

  const chosenSet = sets[idx];
  applySpecSetToSlots(chosenSet);
});


      function tileElForSlot(slotKey) { const domKey = Object.keys(SLOT_MAP).find(k => SLOT_MAP[k] === slotKey); return document.querySelector(`.slot[data-slot="${domKey}"]`); }
      function labelForSlot(slotKey) {
        return ({
          weapon: 'ë¬´ê¸°', headshoulder: 'ë¨¸ë¦¬ì–´ê¹¨', top: 'ìƒì˜', bottom: 'í•˜ì˜', belt: 'í—ˆë¦¬', shoes: 'ì‹ ë°œ',
          bracelet: 'íŒ”ì°Œ', necklace: 'ëª©ê±¸ì´', ring: 'ë°˜ì§€', sub: 'ë³´ì¡°ì¥ë¹„',
          aura: 'ì˜¤ë¼', title: 'ì¹­í˜¸', creature: 'í¬ë¦¬ì³', artifact: 'ì•„í‹°íŒ©íŠ¸', earring: 'ê·€ê±¸ì´', magestone: 'ë§ˆë²•ì„'
        })[slotKey] || 'ì•„ì´í…œ';
      }
      // ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ê°±ì‹ 
      function updateEquipDescPreview() {
        const box = document.getElementById('equipDescPreview');
        if (!box) return;

        const state = window.state || {};
        const selections = state.selections || {};

        const lines = [];

        // ìŠ¬ë¡¯ ë¶„ë¥˜
        const ARMOR_SLOTS = new Set(['headshoulder', 'top', 'bottom', 'belt', 'shoes']);
        const ACC_SLOTS = new Set(['bracelet', 'necklace', 'ring']);
        const SPEC_SLOTS = new Set(['sub', 'magestone', 'earring']);

        const norm = (v) => String(v ?? '').trim();
        const toNum = (v) => {
          const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
          return Number.isFinite(n) ? n : 0;
        };

        // "ì‹ ì†: ë²„ë‹ í”Œë ˆì´íŠ¸" ê°™ì€ ë¬¸ìì—´ì—ì„œ ": " ë’¤ë§Œ ë‚¨ê¸°ëŠ” ìœ í‹¸
        const stripSetPrefix = (v) => {
          const s = String(v ?? '').trim();
          if (!s) return '';
          const marker = ': ';
          const idx = s.indexOf(marker);
          if (idx < 0) return s;
          return s.slice(idx + marker.length).trim();
        };


        // 1) typeë³„ ë°©ì–´êµ¬/ì•…ì„¸/íŠ¹ìˆ˜ ê°œìˆ˜ ì¹´ìš´íŠ¸
        //    + ë°©ì–´êµ¬/ì•…ì„¸/íŠ¹ìˆ˜ìš© ë² ì´ìŠ¤(ì ‘ë‘ì‚¬ ì œê±°) ì¹´ìš´íŠ¸
        const typeCounts = {};
        const armorBaseCounts = {}; // ë°©ì–´êµ¬: ë² ì´ìŠ¤ íƒ€ì… ê¸°ì¤€ ê°œìˆ˜
        const accBaseCounts = {}; // ì•…ì„¸:   ë² ì´ìŠ¤ íƒ€ì… ê¸°ì¤€ ê°œìˆ˜
        const specBaseCounts = {}; // íŠ¹ìˆ˜:   ë² ì´ìŠ¤ íƒ€ì… ê¸°ì¤€ ê°œìˆ˜

        for (const [slotKey, info] of Object.entries(selections)) {
          if (!info || !info.type) continue;

          const t = norm(info.type);      // ì›ë³¸ type (ì ‘ë‘ì‚¬ í¬í•¨)
          if (!t) continue;

          if (!typeCounts[t]) {
            typeCounts[t] = { armor: 0, acc: 0, spec: 0 };
          }

          const base = stripSetPrefix(t);

          if (ARMOR_SLOTS.has(slotKey)) {
            typeCounts[t].armor++;

            if (base) {
              armorBaseCounts[base] = (armorBaseCounts[base] || 0) + 1;
            }
          } else if (ACC_SLOTS.has(slotKey)) {
            typeCounts[t].acc++;

            if (base) {
              accBaseCounts[base] = (accBaseCounts[base] || 0) + 1;
            }
          } else if (SPEC_SLOTS.has(slotKey)) {
            typeCounts[t].spec++;

            if (base) {
              specBaseCounts[base] = (specBaseCounts[base] || 0) + 1;
            }
          }
        }


        // 2) ì„¸íŠ¸ ì‹œíŠ¸ ì •ë³´ ì¤€ë¹„
        let setList = [];
        try {
          setList =
            (window.CORE && window.CORE.lists && window.CORE.lists['set:list']) ||
            [];
          if (!Array.isArray(setList)) setList = [];
        } catch (e) {
          console.warn('[updateEquipDescPreview] set preview failed (load set:list):', e);
          setList = [];
        }

        const rowsByType = {};
        setList.forEach((r) => {
          const t = norm(r.type);
          if (!t) return;
          (rowsByType[t] = rowsByType[t] || []).push(r);
        });

        const activeArmorSetTypes = new Set(); // ë°©ì–´êµ¬ 5ì„¸íŠ¸ ì™„ì„±ëœ type/base
        const activeAccSetTypes = new Set(); // ì•…ì„¸ 3ì„¸íŠ¸ ì™„ì„±ëœ type/base
        const activeSpecSetTypes = new Set(); // íŠ¹ìˆ˜ 3ì„¸íŠ¸ ì™„ì„±ëœ type/base
        const setLines = [];

        // ë°©ì–´êµ¬: baseKey + n(3/5) ê¸°ë¡
        const prefixSetHit = {}; // baseKey â†’ { ì„¸íŠ¸ìˆ˜(n): true }

        // ì•…ì„¸/íŠ¹ìˆ˜: baseKey ë‹¨ìœ„ë¡œ "ì›ë³¸ë¬¸ìì—´ ì„¸íŠ¸ê°€ ì´ë¯¸ ìˆë‹¤"ëŠ” í‘œì‹œ
        const accPrefixSetHit = new Set(); // baseKey
        const specPrefixSetHit = new Set(); // baseKey



        const pushSetLine = (labelText, rawDesc) => {
          if (!rawDesc) return;
          const safeLabel = (typeof escapeHTML === 'function')
            ? escapeHTML(labelText)
            : String(labelText);
          const safeDesc = rawDesc.includes('<')
            ? rawDesc
            : ((typeof escapeHTML === 'function')
              ? escapeHTML(rawDesc)
              : String(rawDesc)
            ).replace(/\n/g, '<br>');

          const catClass =
  String(labelText).includes('ì•…ì„¸') ? 'slot-acc' :
  String(labelText).includes('íŠ¹ìˆ˜') ? 'slot-spec' :
  String(labelText).includes('ì„¸íŠ¸') ? 'slot-armor' : '';

setLines.push(
  `<div class="stat-preview-line">
     <div class="slot-tag ${catClass}">${safeLabel}</div>
     <div class="desc-text">${safeDesc}</div>
   </div>`
);

        };

        // 3) typeë³„ë¡œ ë°©ì–´êµ¬ / ì•…ì„¸ / íŠ¹ìˆ˜ ì„¸íŠ¸ í™œì„±í™” ì—¬ë¶€ + ì„¸íŠ¸ ì„¤ëª… ê³„ì‚°
        try {
          Object.entries(typeCounts).forEach(([t, counts]) => {
            const rows = rowsByType[t];
            if (!rows || !rows.length) return;

            const armorRows = [];
            const accRows = [];
            const specRows = [];

            rows.forEach((r) => {
              const cat = norm(r.category || r['ë¶„ë¥˜'] || '');
              if (cat === 'ë°©ì–´êµ¬') {
                armorRows.push(r);
              } else if (cat === 'ì•…ì„¸' || cat === 'ì•…ì„¸ì‚¬ë¦¬') {
                accRows.push(r);
              } else if (cat === 'íŠ¹ìˆ˜' || cat === 'íŠ¹ìˆ˜ì¥ë¹„') {
                specRows.push(r);
              } else {
                // ë¶„ë¥˜ê°€ ì—†ìœ¼ë©´ í¬ì¸íŠ¸ë¡œ ì¶”ì •
                const ap = toNum(r.armpoint);
                const acp = toNum(r.accpoint);
                const sp = toNum(r.subpoint);
                if (ap) armorRows.push(r);
                if (acp) accRows.push(r);
                if (sp) specRows.push(r);
              }
            });
            const armorCountPrefix = counts.armor;
            const accCount = counts.acc;
            const specCount = counts.spec;
            const baseKey = stripSetPrefix(t);

            // 3-1) ë°©ì–´êµ¬ ì ‘ë‘ì‚¬/ì›ë³¸ ì„¸íŠ¸: ì›ë³¸ type ê¸°ì¤€ìœ¼ë¡œ ì„¸íŠ¸ ë‹¬ì„± ê³„ì‚°
            if (armorCountPrefix >= 3 && armorRows.length) {
              let candidates = armorRows
                .map((r) => ({ row: r, n: toNum(r.num) }))
                .filter((x) => x.n > 0 && x.n <= armorCountPrefix);

              if (candidates.length) {
                // ì˜ˆ: 3ì„¸íŠ¸ â†’ 5ì„¸íŠ¸ ìˆœìœ¼ë¡œ
                candidates.sort((a, b) => a.n - b.n);

                candidates.forEach(({ row: r, n }) => {
                  const rawName = r.name || t;
                  const desc = r.desc || '';
                  const label = `${rawName} (${n}ì„¸íŠ¸)`;
                  pushSetLine(label, desc);

                  // ì´ baseKey + n ì„¸íŠ¸ëŠ” "ì ‘ë‘ì‚¬(or ì›ë³¸ type)"ë¡œ ì´ë¯¸ í•˜ë‚˜ ìˆëŠ” ìƒíƒœë¼ê³  ê¸°ë¡
                  const key = baseKey || rawName;
                  if (key) {
                    if (!prefixSetHit[key]) prefixSetHit[key] = {};
                    prefixSetHit[key][n] = true;
                  }

                  // 5ì„¸íŠ¸ ì´ìƒì´ë©´ í•´ë‹¹ ë² ì´ìŠ¤ íƒ€ì…ì— ëŒ€í•´ ê°œë³„ ì˜µì…˜ ìˆ¨ê¹€
                  if (n >= 5 && key) {
                    activeArmorSetTypes.add(key);
                  }
                });
              }
            }

            // 3-2) ì•…ì„¸ì‚¬ë¦¬ ì„¸íŠ¸: ì›ë³¸ë¬¸ìì—´(type) ê¸°ì¤€ 3ì„¸íŠ¸ ë¨¼ì € ì²˜ë¦¬
            if (accCount >= 3 && accRows.length) {
              // ì•…ì„¸ëŠ” 3ì„¸íŠ¸ë§Œ ì¡´ì¬í•œë‹¤ê³  ê°€ì •
              const r = accRows[0];
              const rawName = r.name || t;
              const desc = r.desc || '';
              const label = `${rawName} (ì•…ì„¸ 3ì„¸íŠ¸)`;
              pushSetLine(label, desc);

              const key = baseKey || rawName;
              if (key) {
                // ì´ baseKeyëŠ” "ì ‘ë‘ì‚¬/ì›ë³¸" ì•…ì„¸ ì„¸íŠ¸ê°€ ì´ë¯¸ ì¡´ì¬
                accPrefixSetHit.add(key);
                // ê°œë³„ ì¥ë¹„ ì„¤ëª… ìˆ¨ê¸¸ ë•Œë„ base ê¸°ì¤€ìœ¼ë¡œ ìˆ¨ê¸¸ ìˆ˜ ìˆê²Œ ì €ì¥
                activeAccSetTypes.add(key);
              }
            }

            // 3-3) íŠ¹ìˆ˜ì¥ë¹„ ì„¸íŠ¸: ì›ë³¸ë¬¸ìì—´(type) ê¸°ì¤€ 3ì„¸íŠ¸ ë¨¼ì € ì²˜ë¦¬
            if (specCount >= 3 && specRows.length) {
              const r = specRows[0];
              const rawName = r.name || t;
              const desc = r.desc || '';
              const label = `${rawName} (íŠ¹ìˆ˜ 3ì„¸íŠ¸)`;
              pushSetLine(label, desc);

              const key = baseKey || rawName;
              if (key) {
                specPrefixSetHit.add(key);
                activeSpecSetTypes.add(key);
              }
            }

          });

          // 3-4) ë² ì´ìŠ¤ ì´ë¦„(ì ‘ë‘ì‚¬ ì œê±° ë¬¸ìì—´) ê¸°ì¤€ ì„¸íŠ¸ ì„¤ëª… ì¶”ê°€
          //      â†’ ì—¬ê¸°ì„œëŠ” armorBaseCounts(ì „ì²´ ì¡°ê° ìˆ˜)ë¥¼ ì‚¬ìš©í•˜ê³ ,
          //         rowsByType[baseKey] ë¡œ "ì¼ë°˜ ì„¸íŠ¸" ì„¤ëª…ì„ ë‹¤ì‹œ ì°¾ì•„ì˜¨ë‹¤.
          Object.entries(armorBaseCounts).forEach(([baseKey, totalArmorCount]) => {
            const rows = rowsByType[baseKey];
            if (!rows || !rows.length) return;
            if (totalArmorCount < 3) return;

            const armorRows = [];
            rows.forEach((r) => {
              const cat = norm(r.category || r['ë¶„ë¥˜'] || '');
              if (cat === 'ë°©ì–´êµ¬') {
                armorRows.push(r);
              } else if (!cat) {
                const ap = toNum(r.armpoint);
                if (ap) armorRows.push(r);
              }
            });
            if (!armorRows.length) return;

            let candidates = armorRows
              .map((r) => ({ row: r, n: toNum(r.num) }))
              .filter((x) => x.n > 0 && x.n <= totalArmorCount);

            if (!candidates.length) return;

            candidates.sort((a, b) => a.n - b.n);

            candidates.forEach(({ row: r, n }) => {
              // ì ‘ë‘ì‚¬ ì„¸íŠ¸ì™€ ì¼ë°˜ ì„¸íŠ¸ê°€ "ê°™ì€ baseKey + ê°™ì€ n(3ì„¸íŠ¸/5ì„¸íŠ¸)"ë¼ë©´
              // â†’ ì¼ë°˜ ì„¸íŠ¸ëŠ” ìˆ¨ê¸°ê³ , ì ‘ë‘ì‚¬ ì„¸íŠ¸ë§Œ ë‚¨ê¸´ë‹¤.
              const hitMap = prefixSetHit[baseKey];
              if (hitMap && hitMap[n]) return;

              const name = r.name || baseKey;
              const desc = r.desc || '';
              const label = `${name} (${n}ì„¸íŠ¸)`;
              pushSetLine(label, desc);

              if (n >= 5) {
                activeArmorSetTypes.add(baseKey);
              }
            });
          });
          // 3-5) ì•…ì„¸ì‚¬ë¦¬: ë² ì´ìŠ¤ ì´ë¦„ ê¸°ì¤€ 3ì„¸íŠ¸ ì„¤ëª… (ì›ë³¸ë¬¸ìì—´ ì„¸íŠ¸ê°€ ì—†ì„ ë•Œë§Œ)
          Object.entries(accBaseCounts).forEach(([baseKey, totalAccCount]) => {
            if (totalAccCount < 3) return;

            const rows = rowsByType[baseKey];
            if (!rows || !rows.length) return;

            const accRows = [];
            rows.forEach((r) => {
              const cat = norm(r.category || r['ë¶„ë¥˜'] || '');
              if (cat === 'ì•…ì„¸' || cat === 'ì•…ì„¸ì‚¬ë¦¬') {
                accRows.push(r);
              } else if (!cat) {
                const acp = toNum(r.accpoint);
                if (acp) accRows.push(r);
              }
            });
            if (!accRows.length) return;

            // ì´ baseKeyì— ëŒ€í•´ ì´ë¯¸ ì ‘ë‘ì‚¬/ì›ë³¸ ì„¸íŠ¸ê°€ ìˆì—ˆë‹¤ë©´ ë² ì´ìŠ¤ ì„¸íŠ¸ëŠ” ìˆ¨ê¹€
            if (accPrefixSetHit.has(baseKey)) return;

            const r = accRows[0];
            const name = r.name || baseKey;
            const desc = r.desc || '';
            const label = `${name} (ì•…ì„¸ 3ì„¸íŠ¸)`;
            pushSetLine(label, desc);

            activeAccSetTypes.add(baseKey);
          });

          // 3-6) íŠ¹ìˆ˜ì¥ë¹„: ë² ì´ìŠ¤ ì´ë¦„ ê¸°ì¤€ 3ì„¸íŠ¸ ì„¤ëª… (ì›ë³¸ë¬¸ìì—´ ì„¸íŠ¸ê°€ ì—†ì„ ë•Œë§Œ)
          Object.entries(specBaseCounts).forEach(([baseKey, totalSpecCount]) => {
            if (totalSpecCount < 3) return;

            const rows = rowsByType[baseKey];
            if (!rows || !rows.length) return;

            const specRows = [];
            rows.forEach((r) => {
              const cat = norm(r.category || r['ë¶„ë¥˜'] || '');
              if (cat === 'íŠ¹ìˆ˜' || cat === 'íŠ¹ìˆ˜ì¥ë¹„') {
                specRows.push(r);
              } else if (!cat) {
                const sp = toNum(r.subpoint);
                if (sp) specRows.push(r);
              }
            });
            if (!specRows.length) return;

            if (specPrefixSetHit.has(baseKey)) return;

            const r = specRows[0];
            const name = r.name || baseKey;
            const desc = r.desc || '';
            const label = `${name} (íŠ¹ìˆ˜ 3ì„¸íŠ¸)`;
            pushSetLine(label, desc);

            activeSpecSetTypes.add(baseKey);
          });
        } catch (e) {
          console.warn('[updateEquipDescPreview] set preview failed (set calc):', e);
        }

        // 4) ê°œë³„ ì¥ë¹„ ì„¤ëª… ì¶”ê°€ (ì™„ì„±ëœ ì„¸íŠ¸ì— ì†í•œ ìŠ¬ë¡¯ì€ ê±´ë„ˆë›´ë‹¤)
//    âœ… ì¶œë ¥ ìˆœì„œ ê³ ì •: ë¬´ê¸° â†’ ë°©ì–´êµ¬ â†’ ì•…ì„¸ â†’ íŠ¹ìˆ˜ â†’ ê¸°íƒ€
const weaponLines = [];
const armorLines  = [];
const accLines    = [];
const specLines   = [];
const otherLines  = [];

const pickBucket = (slotKey) => {
  if (slotKey === 'weapon') return weaponLines;
  if (ARMOR_SLOTS.has(slotKey)) return armorLines;
  if (ACC_SLOTS.has(slotKey)) return accLines;
  if (SPEC_SLOTS.has(slotKey)) return specLines;
  return otherLines; // aura/title/creature/artifact ë“±
};

for (const [slotKey, info] of Object.entries(selections)) {
  if (!info) continue;

  const desc = info.desc || info.description || '';
  if (!desc) continue;

  const t = norm(info.type || '');
  const base = stripSetPrefix(t);

  // â˜… ë°©ì–´êµ¬ 5ì„¸íŠ¸ / ì•…ì„¸ 3ì„¸íŠ¸ / íŠ¹ìˆ˜ 3ì„¸íŠ¸ë©´ ê°œë³„ ì„¤ëª… ìˆ¨ê¹€
  if (t) {
    if (ARMOR_SLOTS.has(slotKey) && activeArmorSetTypes.has(base || t)) continue;

    if (ACC_SLOTS.has(slotKey) &&
      (activeAccSetTypes.has(t) || activeAccSetTypes.has(base || t))) {
      continue;
    }

    if (SPEC_SLOTS.has(slotKey) &&
      (activeSpecSetTypes.has(t) || activeSpecSetTypes.has(base || t))) {
      continue;
    }
  }

  const slotName = labelForSlot(slotKey);
  const safeSlot = (typeof escapeHTML === 'function')
    ? escapeHTML(slotName)
    : String(slotName);

  const safeDesc = desc.includes('<')
    ? desc
    : ((typeof escapeHTML === 'function')
      ? escapeHTML(desc)
      : String(desc)
    ).replace(/\n/g, '<br>');

  const catClass =
  ARMOR_SLOTS.has(slotKey) ? 'slot-armor' :
  ACC_SLOTS.has(slotKey)   ? 'slot-acc'   :
  SPEC_SLOTS.has(slotKey)  ? 'slot-spec'  :
  '';

const html =
  `<div class="stat-preview-line">
     <div class="slot-tag ${catClass}">${safeSlot}</div>
     <div class="desc-text">${safeDesc}</div>
   </div>`;

  pickBucket(slotKey).push(html);
}

// 5) ì»¤ìŠ¤í…€ì˜µ ì„¤ëª… ì¶”ê°€ (custom:list + state.customSkills)
const customLines = [];
try {
  let customList =
    (window.CORE && window.CORE.lists && window.CORE.lists['custom:list']) || [];
  if (!Array.isArray(customList)) customList = [];

  const char = state.currentCharacter || {};
  const jobGroup = norm(char.jobGroupLabel || char.jobGroup || '');
  const charName = norm(char.name || '');

  if (customList.length && (jobGroup || charName)) {
    const cs = state.customSkills || {};
    const picks = [];

    const addPick = (kind, val) => {
      const v = norm(val);
      if (!v || v === 'ì—†ìŒ') return;
      picks.push({ kind, label: v });
    };

    addPick('weapon', cs.type);
    addPick('armor', cs.armorType);
    addPick('bracelet', cs.braceletType);
    addPick('earring', cs.earringType);

    if (picks.length) {
      const counts = {};
      picks.forEach(p => { counts[p.label] = (counts[p.label] || 0) + 1; });

      Object.entries(counts).forEach(([customName, count]) => {
        // 1ì°¨ í•„í„°: ê°™ì€ ì»¤ìŠ¤í…€ ì´ë¦„
        let rowsBase = customList.filter(r => norm(r.type) === customName);
        if (!rowsBase.length) return;

        // 2ì°¨ í•„í„°: ì§ì—…êµ°/ìºë¦­ëª… ìš°ì„  ë§¤ì¹­, ì—†ìœ¼ë©´ ê³µìš©/ì „ì²´ í–‰ë„ í—ˆìš©
        let candidates = rowsBase.filter(r =>
          (!jobGroup || norm(r.jobGroup) === jobGroup || !norm(r.jobGroup)) &&
          (!charName || norm(r.name) === charName || !norm(r.name))
        );
        if (!candidates.length) candidates = rowsBase;

        // 3ì°¨: ê°¯ìˆ˜(num) ê¸°ì¤€ ì ìˆ˜ ë§¤ê¸°ê¸°
        candidates = candidates
          .map(r => {
            const rawNum = norm(r.num);
            const rowNum = rawNum ? (parseInt(rawNum, 10) || 0) : 1;
            return { r, rowNum };
          })
          .filter(x => x.rowNum > 0);

        if (!candidates.length) return;

        let best = candidates.find(x => x.rowNum === count);
        if (!best) best = candidates.find(x => x.rowNum === 1) || candidates[0];

        const r = best.r;
        const parts = [r.desc1, r.desc2, r.desc3, r.desc4, r.desc5]
          .map(v => norm(v))
          .filter(Boolean);
        if (!parts.length) return;

        const rawDesc = parts.join('\n');
        const labelText = `ê³ ìœ íš¨ê³¼ - ${customName} (${count}ê°œ)`;

        // ì»¤ìŠ¤í…€ ì´ë¦„ â†’ ìƒ‰ìƒ í´ë˜ìŠ¤ ë§¤í•‘ (ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ)
        const colorClass =
          (customName === 'ë¶„ì‡„' || customName === 'ì„ ë´‰') ? 'tag-red' :
          (customName === 'ì„ ëª…' || customName === 'ì´ìƒ') ? 'tag-green' :
          (customName === 'ì˜ì§€' || customName === 'ê´‘ì±„') ? 'tag-blue' :
          (customName === 'ê°•íƒ€') ? 'tag-yellow' :
          'tag-neutral';

        const safeLabel = (typeof escapeHTML === 'function')
          ? escapeHTML(labelText)
          : String(labelText);

        const safeDesc = rawDesc.includes('<')
          ? rawDesc
          : ((typeof escapeHTML === 'function')
            ? escapeHTML(rawDesc)
            : String(rawDesc)
          ).replace(/\n/g, '<br>');

        customLines.push(
          `<div class="stat-preview-line">
             <div class="slot-tag custom-tag ${colorClass}">${safeLabel}</div>
             <div class="desc-text">${safeDesc}</div>
           </div>`
        );
      });
    }
  }
} catch (e) {
  console.warn('[updateEquipDescPreview] custom preview failed:', e);
}

// 6) ì„¸íŠ¸ + ì»¤ìŠ¤í…€ ë¼ì¸ë“¤ì„ ì›í•˜ëŠ” ìˆœì„œë¡œ ë¶™ì¸ë‹¤
//    âœ… ì„¸íŠ¸ë„ ë°©ì–´êµ¬/ì•…ì„¸/íŠ¹ìˆ˜ë¡œ ë¶„ë¦¬í•´ì„œ í•´ë‹¹ êµ¬ê°„ ë’¤ì— ë°°ì¹˜
const armorSetLines = [];
const accSetLines   = [];
const specSetLines  = [];
const otherSetLines = [];

for (const html of setLines) {
  if (html.includes('ì•…ì„¸')) accSetLines.push(html);
  else if (html.includes('íŠ¹ìˆ˜')) specSetLines.push(html);
  else if (html.includes('ì„¸íŠ¸')) armorSetLines.push(html);
  else otherSetLines.push(html);
}

// âœ… ìµœì¢… ì¶œë ¥ ìˆœì„œ: ë¬´ê¸° â†’ ë°©ì–´êµ¬ â†’ (ë°©ì–´êµ¬ì„¸íŠ¸) â†’ ì•…ì„¸ â†’ (ì•…ì„¸ì„¸íŠ¸) â†’ íŠ¹ìˆ˜ â†’ (íŠ¹ìˆ˜ì„¸íŠ¸) â†’ ê¸°íƒ€ â†’ ê³ ìœ íš¨ê³¼
lines.push(...weaponLines);
lines.push(...armorLines);
lines.push(...armorSetLines);
lines.push(...accLines);
lines.push(...accSetLines);
lines.push(...specLines);
lines.push(...specSetLines);
lines.push(...otherLines);
lines.push(...otherSetLines);

// ê³ ìœ íš¨ê³¼(ì»¤ìŠ¤í…€)ëŠ” í•­ìƒ ë§¨ ì•„ë˜
lines.push(...customLines);

        // 7) ì¶œë ¥
        if (!lines.length) {
          box.innerHTML =
            '<div class="stat-preview-empty">ì¥ë¹„ë¥¼ ì„ íƒí•˜ë©´ ì—¬ê¸° ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>';
        } else {
          box.innerHTML = lines.join('');
        }
      }

// ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·°(equipDescPreview)ì—ì„œ ì„¸íŠ¸ ì´ë¦„ë§Œ ì¶”ì¶œ
function getCurrentSetSummaryFromPreview() {
  const box = document.getElementById('equipDescPreview');
  const result = { armorSet: '', accSet: '', specSet: '' };
  if (!box) return result;

  const armorNames = new Set();
  const accNames   = new Set();
  const specNames  = new Set();

  const normalizeName = (text) => {
    if (!text) return '';
    // ì˜ˆ: "ì„¸íŠ¸ì´ë¦„ (ë°©ì–´êµ¬ 5ì„¸íŠ¸)" â†’ "ì„¸íŠ¸ì´ë¦„"
    return String(text).split('(')[0].trim();
  };

  box.querySelectorAll('.stat-preview-line .slot-tag').forEach(el => {
    const t = (el.textContent || '').trim();
    if (!t) return;

    if (t.includes('ì•…ì„¸')) {
      accNames.add(normalizeName(t));
    } else if (t.includes('íŠ¹ìˆ˜')) {
      specNames.add(normalizeName(t));
    } else if (t.includes('ì„¸íŠ¸')) {
      // ê´„í˜¸ ì•ˆì— "ë°©ì–´êµ¬ 5ì„¸íŠ¸"ì²˜ëŸ¼ ì¹´í…Œê³ ë¦¬ í‘œì‹œê°€ ì—†ëŠ” ê²½ìš° â†’ ë°©ì–´êµ¬ ìª½ìœ¼ë¡œ ì·¨ê¸‰
      armorNames.add(normalizeName(t));
    }
  });

  result.armorSet = Array.from(armorNames).join(', ');
  result.accSet   = Array.from(accNames).join(', ');
  result.specSet  = Array.from(specNames).join(', ');
  return result;
}


      window.__DBG = window.__DBG || { once: new Set() };
      function dbgOnce(key, ...args) {
        if (!window.__DBG.once.has(key)) {
          window.__DBG.once.add(key);

        }
      }
      /* ===== ê°•í™” ì„ íƒ ===== */
      if (!window.DBEnh) window.DBEnh = { loaded: false, list: [], byType: {} };

      async function ensureEnhLoaded() {
        if (window.DBEnh?.loaded) return;

        // initì—ì„œ ë°›ì€ ê²½ëŸ‰ ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©
        const rows = (CORE?.lists?.['enh:list'] || []);
        const byType = {};
        for (const it of rows) {
          const name = String(it.name || '').trim();
          const type = String(it.type || '').trim();
          const img = String(it.image ?? it['ì´ë¯¸ì§€'] ?? '').trim();

          // CORE ê²½ëŸ‰ë¦¬ìŠ¤íŠ¸: 'ë ™ì œ'ê°€ level í‚¤ë¡œ ë“¤ì–´ì˜¤ëŠ” ìƒí™© ë°˜ì˜
          const levelVal = it.level ?? it['ë ™ì œ'] ?? '';
          const jobGroup = it.jobGroup;
          let level_num;

          // ì»¬ëŸ¬ ì— ë¸”ë ˜(ë¶‰/ë…¸/ë…¹/í‘¸ë¥¸ë¹›ì— ë¸”ë ˜)ì€ ë‹¨ê³„ ìˆ«ì(level_num)ë¡œ ì‚¬ìš©
          const isPlatinum = /í”Œë˜í‹°ë„˜/.test(type);
          if (!isPlatinum) {
            const num = Number(String(name).match(/\d+/)?.[0]);
            if (!Number.isNaN(num)) level_num = num;
          } else {
            const num = Number(String(name).match(/\d+/)?.[0]);
            if (!Number.isNaN(num)) level_num = num;
          }

          if (!name || !type) continue;
          (byType[type] ||= []).push({ name, type, image: img, levelVal, level_num, raw: it });
        }

        window.DBEnh = window.DBEnh || {};
        window.DBEnh.byType = byType;
        window.DBEnh.list = rows.slice(0);
        window.DBEnh.loaded = true;

        // ë””ë²„ê·¸: íƒ€ì…ë³„ ê°œìˆ˜
        // console.log('[Enh loaded (CORE.lists)]', Object.fromEntries(
        //   Object.keys(byType).map(k => [k, byType[k].length])
        // ));
      }

      // === ì•„ë°”íƒ€/ë¬´ê¸°ì•• ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° ===
      // === ì•„ë°”íƒ€/ë¬´ê¸°ì•• ë“œë¡­ë‹¤ìš´ì„ CORE.lists['enh:list']ë¡œ ì±„ìš°ê¸° ===
      async function populateAvatarImprintDropdowns() {
        // CORE.lists['enh:list']ë¥¼ ë³´ì¥ (ì´ë¯¸ ensureEnhLoadedê°€ ì´ë¥¼ ë§Œë“¦)
        if (typeof ensureEnhLoaded === 'function') {
          await ensureEnhLoaded();
        }

        const rows = Array.isArray(CORE?.lists?.['enh:list']) ? CORE.lists['enh:list'] : [];
        const avatarRows = rows.filter(r => String(r.type || r['ì¢…ë¥˜'] || '').trim() === 'ì•„ë°”íƒ€');
        const imprintRows = rows.filter(r => String(r.type || r['ì¢…ë¥˜'] || '').trim() === 'ë¬´ê¸°ì••');

        const $selAvatar = document.getElementById('selAvatar');
        const $selImprint = document.getElementById('selImprint');
        const fill = ($sel, list) => {
          if (!$sel) return;
          $sel.innerHTML = '';
          if (!list.length) {
            const opt = document.createElement('option');
            opt.value = ''; opt.textContent = '(ë°ì´í„° ì—†ìŒ)';
            $sel.appendChild(opt);
            return;
          }
          for (const r of list) {
            const name = String(r.name || r['ì´ë¦„'] || '').trim();
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            $sel.appendChild(opt);
          }
          // ê¸°ë³¸ê°’: ì²« ì¤„
          $sel.selectedIndex = 0;
        };

        fill($selAvatar, avatarRows);
        fill($selImprint, imprintRows);

        // â–¼ í˜„ì¬ ë“œë¡­ë‹¤ìš´ ì„ íƒê°’ì„ state.avatarì— ì´ˆê¸° ë¯¸ëŸ¬ë§
        state.avatar = state.avatar || {};
        if ($selAvatar && $selAvatar.value) {
          state.avatar.avatarName = String($selAvatar.value).trim();
        }
        if ($selImprint && $selImprint.value) {
          state.avatar.imprintName = String($selImprint.value).trim();
        }
      }

      // ë°±ì—”ë“œ avatar_select í˜¸ì¶œ ìœ í‹¸
      async function postAvatarSelect(kind, name) {
        // kind: 'ì•„ë°”íƒ€' | 'ë¬´ê¸°ì••'
        const payload = { type: kind, name };
        const res = await apiJSON('avatar_select', payload).catch(() => null);
        if (!res?.ok) throw new Error(res?.error || 'avatar_select failed');

        // ğŸ”¹ í”„ë¡ íŠ¸ ìƒíƒœì— ì„ íƒ ë‚´ìš© ì €ì¥
        state.avatar = state.avatar || {};
        if (kind === 'ì•„ë°”íƒ€') {
          // ì•„ë°”íƒ€ í–‰ ì´ë¦„
          state.avatar.avatarName = String(name || '').trim();
        } else if (kind === 'ë¬´ê¸°ì••') {
          // ë¬´ê¸°ì•• í–‰ ì´ë¦„
          state.avatar.imprintName = String(name || '').trim();
        }

        return res;
      }

      // ì•„ë°”íƒ€ change
      document.getElementById('selAvatar')?.addEventListener('change', (e) => {
        const name = e.target.value || '';
        if (!state.avatar) state.avatar = {};
        state.avatar.avatarName = String(name).trim();   // í”„ë¡ íŠ¸ ìƒíƒœë§Œ ê°±ì‹ 
        // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ë²„íŠ¼ ë¼ë²¨ë§Œ ê°±ì‹ 
        // updateAvatarImprintLabels?.();
      });

      // ë¬´ê¸°ì•• change
      document.getElementById('selImprint')?.addEventListener('change', (e) => {
        const name = e.target.value || '';
        if (!state.avatar) state.avatar = {};
        state.avatar.imprintName = String(name).trim();  // í”„ë¡ íŠ¸ ìƒíƒœë§Œ ê°±ì‹ 
        // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ë²„íŠ¼ ë¼ë²¨ë§Œ ê°±ì‹ 
        // updateAvatarImprintLabels?.();
      });




      const enhanceModal = document.getElementById('enhanceModal');
      const enhanceListEl = document.getElementById('enhanceList');

      function enhTypeForSlot(slotKey) {
        if (slotKey === 'weapon') return 'ë¬´ê¸°ê°•í™”';
        if (['headshoulder', 'top', 'bottom', 'belt', 'shoes'].includes(slotKey)) return 'ë°©ì–´êµ¬ê°•í™”';
        if (['bracelet', 'necklace', 'ring'].includes(slotKey)) return 'ì•…ì„¸ê°•í™”';
        if (slotKey === 'sub' || slotKey === 'magestone' || slotKey === 'earring') return 'ë³´ì¥ê°•í™”';
        return null;
      }

      async function openEnhPicker(slotKey, btnEl) {
        const type = enhTypeForSlot(slotKey);
        if (!type) return;

        await ensureEnhLoaded();

        // â˜… DBEnhì—ì„œ íƒ€ì…ë³„ ê°•í™” ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ë°°ì—´ ë³´ì¥)
        const rawList = window.DBEnh?.byType?.[type];
        const list = Array.isArray(rawList) ? rawList.slice() : [];

        enhanceListEl.innerHTML = '';

        if (!list.length) {
          const msg = document.createElement('div');
          msg.style.color = '#c7b589';
          msg.textContent = 'ì„ íƒ ê°€ëŠ¥í•œ ê°•í™”ê°€ ì—†ìŠµë‹ˆë‹¤.';
          enhanceListEl.appendChild(msg);
        } else {
          list.forEach((opt) => {
            const b = document.createElement('button');
            b.className = 'enh-option';
            b.textContent = opt.name || '(ì´ë¦„ì—†ìŒ)';

            b.onclick = () => {
              // â˜… calc_allìš© ë¡œì»¬ ìƒíƒœì—ë§Œ ê¸°ë¡ (ë°±ì—”ë“œ enh_select í˜¸ì¶œ ì—†ìŒ)
              state.enh ||= {};
              state.enh[slotKey] = {
                name: opt.name,
                type,
                level: opt.level_num ?? null,
                raw: opt.raw ?? null,
              };

              // ë²„íŠ¼ ë¼ë²¨ ì—…ë°ì´íŠ¸
              if (btnEl) btnEl.textContent = opt.name;

              // ëª¨ë‹¬ ë‹«ê¸°
              closeEnhPicker();
            };

            enhanceListEl.appendChild(b);
          });
        }

        // UI ìƒíƒœ ê¸°ë¡ (ë‹¤ë¥¸ ê³³ì—ì„œ ì“¸ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ìœ ì§€)
        state.ui ||= {};
        state.ui.enhTargetSlot = slotKey;
        state.ui.enhTargetBtn = btnEl || null;

        enhanceModal.classList.add('show');
        enhanceModal.setAttribute('aria-hidden', 'false');
      }

      function closeEnhPicker() {
        enhanceModal.classList.remove('show');
        enhanceModal.setAttribute('aria-hidden', 'true');
      }

      enhanceModal.addEventListener('click', (e) => {
        if (e.target.hasAttribute('data-close') || e.target.classList.contains('backdrop')) closeEnhPicker();
      });

      /* ===== í•©ì‚° íŒ¨ë„ ===== */
      // ì„œë²„ í•©ì‚°ìŠ¤íƒ¯(SUM_STATS) â†’ í”„ë¡ íŠ¸ í‘œì‹œìš© êµ¬ì¡°ë¡œ ë§µí•‘
      function mapServerSumToClient(sum) {
        const toNum = (v) => {
          const n = Number(String(v ?? '').replace(/[, ]/g, ''));
          return Number.isFinite(n) ? n : 0;
        };
        const pct = (v) => toNum(v) / 100;

        return {
          phys_atk: toNum(sum['ë¬¼ë¦¬ ë°ë¯¸ì§€']),
          mag_atk: toNum(sum['ë§ˆë²• ë°ë¯¸ì§€']),
          str: toNum(sum['í˜']),
          int: toNum(sum['ì§€ëŠ¥']),
          phys_crit: toNum(sum['ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬']),
          mag_crit: toNum(sum['ë§ˆë²• í¬ë¦¬í‹°ì»¬']),
          // %ëŠ” íŒ¨ë„ì—ì„œ í¼ì„¼íŠ¸ë¡œ ì¶œë ¥í•˜ë¯€ë¡œ 0~1 ìŠ¤ì¼€ì¼ì´ í¸í•¨
          phys_crit_rate: pct(sum['ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬(%)']),
          mag_crit_rate: pct(sum['ë§ˆë²• í¬ë¦¬í‹°ì»¬(%)']),

          // ì„ íƒì ìœ¼ë¡œ ì“°ì´ëŠ” ì¦/ì¶”ë€ë¥˜(ì—†ìœ¼ë©´ 0)
          add_damage: pct(sum['ì¶”ê°€ë°ë¯¸ì§€(%)']),
          counter_add_damage: pct(sum['ì¹´ìš´í„°ì¶”ë€(%)']),
          str_pct: pct(sum['í˜(%)']),
          int_pct: pct(sum['ì§€ëŠ¥(%)']),
          damage_inc: pct(sum['ë€ì¦(%)']),
          counter_damage_inc: pct(sum['ì¹´ìš´í„°ë€ì¦(%)']),
          crit_damage_inc: pct(sum['í¬ì¦ë€(%)']),
          phys_atk_pct: pct(sum['ë¬¼ë¦¬ ê³µê²©ë ¥(%)']),
          mag_atk_pct: pct(sum['ë§ˆë²• ê³µê²©ë ¥(%)']),
          skill_atk_inc: pct(sum['ìŠ¤ì¦(%)'] ?? sum['ìŠ¤í‚¬ ê³µê²©ë ¥(%)']),

          elem: {
            fire: toNum(sum['í™”']),
            water: toNum(sum['ìˆ˜']),
            light: toNum(sum['ëª…']),
            dark: toNum(sum['ì•”']),
          },
          elem_add: {
            fire: pct(sum['í™”ì†ì¶”']),
            water: pct(sum['ìˆ˜ì†ì¶”']),
            light: pct(sum['ëª…ì†ì¶”']),
            dark: pct(sum['ì•”ì†ì¶”']),
          },

          def_break_inc: pct(sum['ë°©ê¹ë€ì¦']),
          cdr: pct(sum['ì¿¨ê°']),
          speed: {
            attack: pct(sum['ê³µì†']),
            move: pct(sum['ì´ì†']),
            cast: pct(sum['ìºì†']),
          },
          // íŒ¨ë„ì—ì„œ ê·¸ëŒ€ë¡œ í¼ì„¼íŠ¸ ìˆ«ìë¥¼ ë³´ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ë„ ë³´ê´€
          final_phys_crit_pct: pct(sum['ìµœì¢… ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬(%)']),
          final_mag_crit_pct: pct(sum['ìµœì¢… ë§ˆë²• í¬ë¦¬í‹°ì»¬(%)']),
        };
      }

      // í•©ì‚°ìŠ¤íƒ¯ ë¶ˆëŸ¬ì˜¤ëŠ” í—¬í¼ (ë²„í‚· ì§€ì›)
      async function fetchServerSumStats({ map = false } = {}) {
        const token = await waitForIdToken(); // í† í° í™•ë³´ (í˜¸í™˜ìš©)
        const j = await apiJSON("sum_stats", {});

        if (!j?.ok) {
          throw new Error(`sum_stats failed: ${j?.error || "unknown"}`);
        }

        const isEmptyTotal = (T) => {
          if (!T || typeof T !== 'object') return true;

          const keys = Object.keys(T);
          if (!keys.length) return true;

          const ownerKey = String(T.ownerKey || '').trim();
          let hasNonZero = false;

          for (const k of keys) {
            if (k === 'ownerKey' || k === 'JobGroup' || k === 'CharName') continue;
            const v = T[k];
            if (typeof v === 'number' && v !== 0) {
              hasNonZero = true;
              break;
            }
          }

          return !ownerKey && !hasNonZero;
        };

        const rawTotal = j.sum || {};
        if (isEmptyTotal(rawTotal) && state.CurrentSumStats) {
          console.warn(
            "[fetchServerSumStats] empty/zero sum detected, keeping previous",
            rawTotal
          );
          // ê¸°ì¡´ í•©ì‚° ìŠ¤íƒ¯ ìœ ì§€ (ì„¸ì…˜ ê¹¨ì§„ íƒ€ì´ë° ë³´í˜¸)
          return state.CurrentSumStats;
        }


        // ğŸ”¹ ì „ì²´ ë²„í‚·ì„ stateì— ì €ì¥ (ì—†ìœ¼ë©´ totalë§Œ ë„£ì–´ë‘ )
        if (j.buckets && typeof j.buckets === "object") {
          state.SumBuckets = j.buckets;
        } else {
          state.SumBuckets = { total: rawTotal };
        }

        if (isEmptyTotal(rawTotal) && state.CurrentSumStats) {
          console.warn('[SUM-EMPTY-GUARD] keeping previous sum. rawTotal=', rawTotal);
        }
        // ê¸°ì¡´ í˜¸ì¶œë¶€ í˜¸í™˜: map=trueë©´ í´ë¼ì´ì–¸íŠ¸ìš©ìœ¼ë¡œ ë³€í™˜
        return map ? mapServerSumToClient(rawTotal) : rawTotal;
      }


      //!@#$
      const statListEl = document.getElementById('statList');
      function sumSelections() {
        const S = {     //ëª¨ë“  í•­ëª© 0ìœ¼ë¡œ ì‹œì‘
          phys_atk: 0, mag_atk: 0, str: 0, int: 0, phys_crit: 0, mag_crit: 0, phys_crit_rate: 0, mag_crit_rate: 0, add_damage: 0, counter_damage_inc: 0, elem_add_sum: 0,
          str_pct: 0, int_pct: 0, damage_inc: 0, crit_damage_inc: 0, phys_atk_pct: 0, mag_atk_pct: 0, skill_atk_inc: 0,
          elem: { fire: 0, water: 0, light: 0, dark: 0 }, cdr: 0, speed: { attack: 0, move: 0, cast: 0 }, def_break_inc: 0,
          counter_add_damage: 0,                        // ì¹´ìš´í„°ì¶”ë€(%)
          elem_add: { fire: 0, water: 0, light: 0, dark: 0 },     // ì†ì„±ë³„ â€˜ê¸°ë³¸â€™ ì†ì¶”(%) í•©
          elem_add_eff_sum: 0,           // ì‹ ì ìš© í›„ ìœ íš¨ ì†ì¶”(%) í•©
          fin_add_damage: 0,    //ìµœì¢…ì¶”ë€(%)
          final_phys_crit_pct: 0,   // ìµœì¢… ë¬¼ë¦¬í¬ë¦¬ìœ¨(0~1)
          final_mag_crit_pct: 0,    // ìµœì¢… ë§ˆë²•í¬ë¦¬ìœ¨(0~1)
          factor_phys: 1,           // ë¬¼ê³µ ê¸°ì¤€ í™•ë¥ ê³„ìˆ˜
          factor_mag: 1,             // ë§ˆê³µ ê¸°ì¤€ í™•ë¥ ê³„ìˆ˜
        };
        // â˜… ìŠ¤ì¦ ì „ìš© ì„ì‹œ ëˆ„ì ê¸°(ë² ì´ìŠ¤ë¶€í„° ëˆ„ì  ì‹œì‘)
        S.__skillMul = 1;        // ê³±ì—°ì‚° ëŒ€ìƒ(ì•„ì´í…œ/ê°•í™”/ì— ë¸”ë ˜/ì˜µì…˜/ë£¬/ë§ˆë´‰/ë§ˆë¶€ ë“±)
        S.__skillAddBuff = 0;    // í•©ì—°ì‚° ëŒ€ìƒ(ë²„í”„ ì‹œíŠ¸ì—ì„œ ì˜¨ ìŠ¤ì¦)
        const addStats = (s) => {   // ì•„ì´í…œ í•˜ë‚˜ì˜ statsë¥¼ ë°›ì•„ Sì— ëˆ„ì 
          if (!s) return;
          S.phys_atk += s.phys_atk || 0; S.mag_atk += s.mag_atk || 0;
          S.str += s.str || 0; S.int += s.int || 0;
          S.phys_crit += s.phys_crit || 0; S.mag_crit += s.mag_crit || 0;
          S.phys_crit_rate += s.phys_crit_rate || 0; S.mag_crit_rate += s.mag_crit_rate || 0;
          S.add_damage += s.add_damage || 0;
          S.counter_add_damage += s.counter_add_damage || 0;
          S.counter_damage_inc += s.counter_damage_inc || 0;

          if (s.elem_add_damage) {
            S.elem_add.fire += s.elem_add_damage.fire || 0;
            S.elem_add.water += s.elem_add_damage.water || 0;
            S.elem_add.light += s.elem_add_damage.light || 0;
            S.elem_add.dark += s.elem_add_damage.dark || 0;
          }

          S.str_pct += s.str_pct || 0; S.int_pct += s.int_pct || 0;
          S.damage_inc += s.damage_inc || 0; S.crit_damage_inc += s.crit_damage_inc || 0;
          S.phys_atk_pct += s.phys_atk_pct || 0; S.mag_atk_pct += s.mag_atk_pct || 0;

          // â˜… ìŠ¤ì¦ì€ ë”í•˜ì§€ ë§ê³  ê³± ëˆ„ì (ë²„í”„ëŠ” ì•„ì§ ì•ˆ ë“¤ì–´ì˜´)
          if (s.skill_atk_inc) {
            S.__skillMul *= (1 + (s.skill_atk_inc || 0));
          }

          if (s.elem) { S.elem.fire += s.elem.fire || 0; S.elem.water += s.elem.water || 0; S.elem.light += s.elem.light || 0; S.elem.dark += s.elem.dark || 0; }
          S.cdr += s.cdr || 0;
          if (s.speed) { S.speed.attack += s.speed.attack || 0; S.speed.move += s.speed.move || 0; S.speed.cast += s.speed.cast || 0; }
          if (s.other) { S.def_break_inc += s.other.def_break_inc || 0; }
        };

        // === [PATCH] ìºë¦­í„° ê¸°ë³¸ìŠ¤íƒ¯ 13ê°œ ì„ ì ìš© ===
        // state.currentCharacter.baseëŠ” ë°±ì—”ë“œ ?type=char ì‘ë‹µì— í¬í•¨ëœ base(í¼ì„¼íŠ¸ëŠ” 0~1ë¡œ ë³€í™˜)ë¼ê³  ê°€ì •
        {
          const B = state?.currentCharacter?.base;
          if (B) {
            addStats({
              // ì£¼ì˜: ë„ˆì˜ Sì—ëŠ” 'phys_dmg/mag_dmg' í‚¤ê°€ ì—†ìœ¼ë¯€ë¡œ 'ë¬¼ë¦¬/ë§ˆë²• ë°ë¯¸ì§€'ë¥¼ 'phys_atk/mag_atk'ë¡œ ë”í•œë‹¤
              phys_atk: Number(B.phys_dmg || 0),
              mag_atk: Number(B.mag_dmg || 0),

              str: Number(B.str || 0),
              int: Number(B.int || 0),

              phys_crit: Number(B.phys_crit || 0),
              mag_crit: Number(B.mag_crit || 0),
              phys_crit_rate: Number(B.phys_crit_rate || 0), // 0~1
              mag_crit_rate: Number(B.mag_crit_rate || 0), // 0~1

              // ì†ì„±ê°•í™”(ì ˆëŒ€ê°’)
              elem: {
                fire: Number(B.elem?.fire || 0),
                water: Number(B.elem?.water || 0),
                light: Number(B.elem?.light || 0),
                dark: Number(B.elem?.dark || 0),
              },

              // ì°¸ê³ : base.acc(ì ì¤‘)ëŠ” í˜„ì¬ S ìŠ¤í‚¤ë§ˆì— í‚¤ê°€ ì—†ì–´ í•©ì‚°ë˜ì§€ ì•ŠìŒ
            });
          }
        }

        Object.values(state.selections).forEach(it => addStats(it?.stats));   //ì„ íƒ ì¥ë¹„ë“¤ ëª¨ë‘ ëˆ„ì í•´ì„œ ìµœì¢… së°˜í™˜
        // ì¥ë¹„ í•©
        Object.values(state.upgrades).forEach(up => addStats(up?.stats));   // ì„ íƒ ê°•í™”ë“¤ ëª¨ë‘ ëˆ„ì í•´ì„œ ìµœì¢… së°˜í™˜
        // [REFINE] ë¬´ê¸°ì—°ë§ˆ (ê³±ì—°ì‚° ê³„ì—´ì€ addStats ë‚´ë¶€ì—ì„œ ìë™ ê³±)
        if (state.refines?.weapon?.stats) addStats(state.refines.weapon.stats);
        // [REFINE] ë³´ì¡°ì—°ë§ˆ (ë§ì—°ì‚°)
        if (state.refines?.sub?.stats) addStats(state.refines.sub.stats);
        // â–¼â–¼â–¼ ì—¬ê¸° ì¶”ê°€: ì„±ì•ˆì˜ ë´‰ì¸(ë§ì—°ì‚°) â–¼â–¼â–¼
        if (state.castleSeal?.main?.stats) addStats(state.castleSeal.main.stats);
        if (state.castleSeal?.sub?.stats) addStats(state.castleSeal.sub.stats);
        // ê°•í™” í•©(ìš”ì²­: í•©ì—°ì‚°)
        //Object.values(state.enchants || {}).forEach(en => addStats(en?.stats));
        // ë§ˆë²•ë¶€ì—¬ í•©ì‚°
        // ê¸°ë³¸(ì›ì‹œ) ì´í•©ë„ ìœ ì§€
        // â–¼â–¼â–¼ ì„¸íŠ¸ ì˜µì…˜ ê³„ì‚°/ì ìš© (ì¥ë¹„ ì„ íƒ ì´í›„) â–¼â–¼â–¼
        try {
          // ì„¸íŠ¸ ë°ì´í„°ê°€ ì•„ì§ì´ë©´ ë¹„ë™ê¸° ë¡œë”© ì‹œë„(ëŒ€ê¸°í•˜ì§€ ì•ŠìŒ)
          if (!DBSet.loaded) { ensureSetLoaded().catch(() => { }); }

          // ì„¸íŠ¸ ì¹´ìš´íŠ¸ ëŒ€ìƒ ìŠ¬ë¡¯(ë°©ì–´êµ¬ 5ë¶€ìœ„ + ì•…ì„¸ 3ë¶€ìœ„)

          const SET_SLOTS = ['headshoulder', 'top', 'bottom', 'belt', 'shoes', 'bracelet', 'necklace', 'ring'];

          // 1) ë‚´ê°€ ì°©ìš©í•œ ì•„ì´í…œë“¤ì˜ "ì¢…ë¥˜" ì¹´ìš´íŠ¸
          const counts = Object.create(null);
          for (const sk of SET_SLOTS) {
            const it = state?.selections?.[sk];
            const k = String(it?.type || '').trim();      // ê° ì•„ì´í…œ ì‹œíŠ¸ì˜ 'ì¢…ë¥˜' ì»¬ëŸ¼ ë§¤í•‘ ê°’
            if (!k) continue;
            counts[k] = (counts[k] || 0) + 1;
          }

          // 2) ì˜ˆì™¸ í”Œë˜ê·¸(ì°¨ë‹¨ ê·œì¹™)
          const blockBaseSets = (counts['ì—˜ë¦¬íŠ¸ìƒì˜'] || 0) >= 1; // ë§¹ê³µ/ê·œìœ¨/ìŒìœ¨ ë¯¸ì ìš©
          const blockKH = (counts['ì—˜ë¦¬íŠ¸íŒ”ì°Œ'] || 0) >= 1; // ì¹¼ë‚ /í•¨ì„± ë¯¸ì ìš©

          // 3) ì ìš©í•  ì„¸íŠ¸ íƒ€ì… ê²°ì •
          const want = [];

          if (!blockBaseSets) {
            if ((counts['ë§¹ê³µ'] || 0) >= 3) want.push('ë§¹ê³µ');
            if ((counts['ê·œìœ¨'] || 0) >= 3) want.push('ê·œìœ¨');
            if ((counts['ìŒìœ¨'] || 0) >= 3) want.push('ìŒìœ¨');
          }
          if (!blockKH) {
            const k = counts['ì¹¼ë‚ '] || 0;
            if (k >= 3) {                 // 3ê°œ ì´ìƒì´ë©´ 2ì…‹+3ì…‹ ëª¨ë‘
              want.push('ì¹¼ë‚ 2ì…‹', 'ì¹¼ë‚ 3ì…‹');
            } else if (k >= 2) {
              want.push('ì¹¼ë‚ 2ì…‹');
            }

            const h = counts['í•¨ì„±'] || 0;
            if (h >= 3) {                 // 3ê°œ ì´ìƒì´ë©´ 2ì…‹+3ì…‹ ëª¨ë‘
              want.push('í•¨ì„±2ì…‹', 'í•¨ì„±3ì…‹');
            } else if (h >= 2) {
              want.push('í•¨ì„±2ì…‹');
            }
          }

          // 4) ì„¸íŠ¸ ìŠ¤íƒ¯ ì ìš© (ì—¬ëŸ¬ í–‰ì´ë©´ ì „ë¶€ ë”í•¨)
          if (Array.isArray(DBSet.list) && want.length) {
            for (const t of want) {
              const tt = String(t).trim();
              const list = (DBSet.byType?.[tt] || DBSet.list.filter(o => String(o.type || '').trim() === tt));
              for (const o of list) addStats(o.stats);
            }
          }

          // (ë””ë²„ê·¸/í‘œì‹œìš©) ì´ë²ˆ í•©ì‚°ì— ì ìš©ëœ ì„¸íŠ¸ ëª©ë¡ ì €ì¥
          state.appliedSets = want.slice();
        } catch (e) {
          console.warn('Set bonus apply failed:', e);
        }
        // â–²â–²â–² ì„¸íŠ¸ ì˜µì…˜ ê³„ì‚°/ì ìš© ë â–²â–²â–²
        S.skill_atk_inc = (S.__skillMul - 1) + S.__skillAddBuff;
        return S;
      }

      // ìˆ«ì/í¼ì„¼íŠ¸ í¬ë§·
      function fmtInt(n) { n = Number(n || 0); return Number.isFinite(n) ? n.toLocaleString('ko-KR') : '0'; }
      function fmtPct(x, d = 1) { x = Number(x || 0); return `${(x).toFixed(d)}%`; }
      // í•œ ì¤„ DOM ìƒì„±
      function show(label, value) {
        const row = document.createElement('div');
        row.className = 'stat-row';
        const l = document.createElement('span'); l.className = 'stat-label'; l.textContent = label;
        const v = document.createElement('span'); v.className = 'stat-value'; v.textContent = value;
        row.append(l, v);
        return row;
      }

      function powerFrom(S) {
        const raw = String(
          S.PowerType ?? S.powerType ?? S.power ?? S['ë¬¼ë§ˆê³µ'] ?? ''
        ).trim();

        if (/^(phys|ë¬¼)/i.test(raw)) return 'phys';
        if (/^(mag|ë§ˆ)/i.test(raw)) return 'mag';

        // âš‘ ë°±ì—… ë¡œì§: ìˆ˜ì¹˜ê°€ í•œìª½ì—ë§Œ ìˆìœ¼ë©´ ê·¸ìª½ìœ¼ë¡œ ì¶”ì •
        const pa = Number(S.phys_atk ?? 0);
        const ma = Number(S.mag_atk ?? 0);
        if (pa > 0 && ma === 0) return 'phys';
        if (ma > 0 && pa === 0) return 'mag';

        return null; // ë¯¸ì •
      }

      // í•©ì‚° ë¦¬ìŠ¤íŠ¸ ë Œë”
      function renderStats(S) {
        const statListEl = document.getElementById('statList');
        if (!statListEl) { console.warn('#statList ê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
        statListEl.innerHTML = '';

        // âœ… í•©ì‚° ìŠ¤íƒ¯ ê°ì²´ Sì—ì„œ ì§ì ‘ ë¬¼/ë§ˆê³µ íŒë‹¨
        const pow = powerFrom(S);                 // 'phys' | 'mag' | null
        const undecided = (pow !== 'phys' && pow !== 'mag');
        const isPhys = pow === 'phys';
        const isMag = pow === 'mag';

        const label = (phys, mag, both) => (undecided ? both : (isPhys ? phys : mag));
        const pick = (physVal, magVal) => (undecided ? null : (isPhys ? physVal : magVal));
        const showInt = (v) => (v == null ? '0' : fmtInt(v));
        const showNumInt = (v) => {
          // 1) ìˆ«ìë¡œ ë³€í™˜
          const n = Number(v);

          // 2) ìˆ«ì ì•„ë‹Œ ê°’(NaN)ì´ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬
          if (!Number.isFinite(n)) return '0';

          // 3) ë°˜ì˜¬ë¦¼í•´ì„œ ì •ìˆ˜ë¡œ
          const rounded = Math.round(n);

          // 4) ì •ìˆ˜ í¬ë§·íŒ… (ì‰¼í‘œ ì°ëŠ” í•¨ìˆ˜ë¼ë©´)
          return fmtInt(rounded);
        };
        const showPct = (v) => (v == null ? '0' : fmtPct(v));

        // íŒŒì›Œ ì˜ì¡´ ë¼ë²¨/ê°’
        const atkLabel = label('ë¬¼ë¦¬ ë°ë¯¸ì§€', 'ë§ˆë²• ë°ë¯¸ì§€', 'ë¬¼ë¦¬/ë§ˆë²• ë°ë¯¸ì§€');
        const atkVal = pick(((S.phys_atk * (1 + S.str_rate / 100)) / 250 + 1) * (1 * (S.phys_atk) * (1 + S.phys_atk_rate / 100)),
          ((S.mag_atk * (1 + S.int_rate / 100)) / 250 + 1) * (1 * (S.mag_atk) * (1 + S.mag_atk_rate / 100)));

        const atkPctLabel = label('ë¬¼ë¦¬ ê³µê²©ë ¥(%)', 'ë§ˆë²• ê³µê²©ë ¥(%)', 'ë¬¼ë¦¬/ë§ˆë²• ê³µê²©ë ¥(%)');
        const atkPctVal = pick(S.phys_atk_rate, S.mag_atk_rate);

        const mainStatLabel = label('í˜', 'ì§€ëŠ¥', 'í˜/ì§€ëŠ¥');
        const mainStatVal = pick(S.str * (1 + S.str_rate / 100), S.int * (1 + S.int_rate / 100));

        const mainPctLabel = label('í˜(%)', 'ì§€ëŠ¥(%)', 'í˜/ì§€ëŠ¥(%)');
        const mainPctVal = pick(S.str_rate, S.int_rate);

        const critLabel = label('ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬', 'ë§ˆë²• í¬ë¦¬í‹°ì»¬', 'ë¬¼ë¦¬/ë§ˆë²• í¬ë¦¬í‹°ì»¬');
        const critVal = pick(S.phys_crit, S.mag_crit);

        const finalCritPct = pick(S.final_phys_crit, S.final_mag_crit);

        // ê¸°íƒ€ ê°’ (ë°±ì—”ë“œ flat ì˜ë¬¸ í‚¤ ì‚¬ìš©)
        const addDmgPct = (S.fin_add_damage ?? S.add_damage ?? 0);
        const elemText = `${fmtInt(S.fire ?? 0)}/${fmtInt(S.water ?? 0)}/${fmtInt(S.light ?? 0)}/${fmtInt(S.dark ?? 0)}`;
        const defBreak = S.def_break ?? S.def_break_inc ?? 0;
        const skillAtk = S.skill_dmg ?? S.skill_atk_inc ?? 0;
        const cdr = S.cdr ?? S.col_down ?? 0;
        const speedAtk = S.atk_spd ?? 0;
        const speedCast = S.cat_spd ?? 0;

        // ë Œë”
        statListEl.appendChild(show(atkLabel, showNumInt(atkVal)));
        statListEl.appendChild(show(atkPctLabel, showPct(atkPctVal)));
        statListEl.appendChild(show(mainStatLabel, showNumInt(mainStatVal)));
        statListEl.appendChild(show(mainPctLabel, showPct(mainPctVal)));
        statListEl.appendChild(show(critLabel, showNumInt(critVal)));
        statListEl.appendChild(show('ìµœì¢… í¬ë¦¬í‹°ì»¬(%)', fmtPct(finalCritPct)));
        statListEl.appendChild(show('ë°ë¯¸ì§€ì¦ê°€(%)', fmtPct(S.dmg_inc ?? 0)));
        statListEl.appendChild(show('í¬ë¦¬í‹°ì»¬ ë°ë¯¸ì§€ ì¦ê°€(%)', fmtPct(S.crit_dmg_inc ?? 0)));
        statListEl.appendChild(show('ìµœì¢… ì¶”ê°€ë°ë¯¸ì§€(%)', fmtPct(addDmgPct)));
        statListEl.appendChild(show('ìŠ¤í‚¬ ê³µê²©ë ¥ ì¦ê°€(%)', fmtPct(skillAtk)));
        statListEl.appendChild(show('ì†ì„±ê°•í™”', elemText));
        statListEl.appendChild(show('ë°©ì–´ë ¥ê°ì†Œ(%)', fmtPct(defBreak)));
        statListEl.appendChild(show('ì „ì²´ ì¿¨íƒ€ì„ ê°ì†Œ(%)', fmtPct(cdr)));
        statListEl.appendChild(show('ê³µê²©ì†ë„(%)', fmtPct(speedAtk)));
        statListEl.appendChild(show('ìºìŠ¤íŒ…ì†ë„(%)', fmtPct(speedCast)));
      }

      // === í•©ì‚°ìŠ¤íƒ¯ / ì¥ë¹„ì„¤ëª… í† ê¸€ ===
      let _statsPanelMode = 'desc'; // 'stats' | 'desc'

      function applyStatsPanelMode() {
        const labelEl = document.getElementById('statsHeaderLabel');
        const descEl = document.getElementById('equipDescPreview');
        const statListEl = document.getElementById('statList');

        if (!labelEl || !descEl || !statListEl) return;

        if (_statsPanelMode === 'desc') {
          // ì¥ë¹„ ì„¤ëª… ëª¨ë“œ
          labelEl.textContent = 'ì¥ë¹„ ì„¤ëª…';
          descEl.style.display = '';
          statListEl.style.display = 'none';
        } else {
          // í•©ì‚° ìŠ¤íƒ¯ ëª¨ë“œ
          labelEl.textContent = 'í•©ì‚° ìŠ¤íƒ¯';
          descEl.style.display = 'none';
          statListEl.style.display = '';
        }
      }

      function initStatsPanelToggle() {
        const btn = document.getElementById('btnToggleStatsPanel');
        if (!btn) return;

        // ì´ˆê¸° ëª¨ë“œëŠ” í•©ì‚° ìŠ¤íƒ¯
        applyStatsPanelMode();

        btn.addEventListener('click', () => {
          _statsPanelMode = (_statsPanelMode === 'stats') ? 'desc' : 'stats';
          applyStatsPanelMode();
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        initStatsPanelToggle();
      });


      // ì´ë¯¸ ìˆëŠ” í•¨ìˆ˜ ì´ë¦„ ì¬ì‚¬ìš© ê°€ëŠ¥
      async function recalcAndRenderPanel() {
        try {
          // 1) ì„œë²„ì—ì„œ total + buckets ê°€ì ¸ì˜¤ê¸°
          //    (map=false â†’ sum ê·¸ëŒ€ë¡œ ë°›ìŒ)
          const sum = await fetchServerSumStats();

          // 2) íŒ¨ë„ìš© total ì €ì¥
          state.CurrentSumStats = sum;

          /*// 3) SP/TP ì´ˆê¸°í™” ë°˜ì˜
          const spTotal = Number(sum['ì´SP'] ?? sum.TotalSP ?? 0);
          const tpTotal = Number(sum['ì´TP'] ?? sum.TotalTP ?? 0);
          if (typeof setTotals === 'function') {
            setTotals(spTotal, tpTotal);
          }*/

          // 4) ê¸°ë³¸ í‘œì‹œ source = total(=mapped)
          let panelSource = sum;

          // 5) bucketsê°€ ìˆë‹¤ë©´ ì„ íƒ ìƒíƒœì— ë”°ë¼ í‘œì‹œ
          const buckets = state.SumBuckets;
          if (buckets && typeof buckets === "object") {
            const sel = document.getElementById("statBucketSelect");
            const key = sel?.value || "total";

            if (key !== "total") {
              // total ì œì™¸ ë²„í‚·ì€ â€œraw ë²„í‚·â€ì„ ê·¸ëŒ€ë¡œ ë³´ì—¬ì¤„ì§€
              // ë§¤í•‘(mapServerSumToClient)ì„ ì¬ì ìš©í• ì§€ëŠ” ì„ íƒ ê°€ëŠ¥
              const raw = buckets[key] || buckets.total || sum;
              panelSource = raw;
            }
          }

          // 6) íŒ¨ë„ ë Œë”ë§
          renderStats(panelSource);


        } catch (err) {
          console.error("[recalcAndRenderPanel] í•©ì‚° ìŠ¤íƒ¯ ê°±ì‹  ì‹¤íŒ¨:", err);
        }
      }


      /* ===== ì— ë¸”ë ˜ ì‹œìŠ¤í…œ ===== */
      // ìŠ¬ë¡¯ì½”ë“œ â†’ ì— ë¸”ë ˜ í—ˆìš© type ëª©ë¡
      function emblemTypesForSlot(slotKey) {
        const k = String(slotKey).toUpperCase();
        // ì»¬ëŸ¬ ì— ë¸”ë ˜
        const RED = 'ë¶‰ì€ë¹›ì— ë¸”ë ˜';
        const YEL = 'ë…¸ë€ë¹›ì— ë¸”ë ˜';
        const GRN = 'ë…¹ìƒ‰ë¹›ì— ë¸”ë ˜';
        const BLU = 'í‘¸ë¥¸ë¹›ì— ë¸”ë ˜';
        const PLAT = 'í”Œë˜í‹°ë„˜ì— ë¸”ë ˜';

        switch (k) {
          case 'L2': // ìƒì˜
          case 'L3': // í•˜ì˜
            return [RED];
          case 'L1': // ë¨¸ë¦¬ì–´ê¹¨
          case 'L4': // í—ˆë¦¬
            return [YEL];
          case 'L5': // ì‹ ë°œ
          case 'R2': // íŒ”ì°Œ
            return [BLU];
          case 'R3': // ëª©ê±¸ì´
          case 'R4': // ë°˜ì§€
            return [GRN];
          case 'R1': // ë¬´ê¸°
            return [RED, YEL, GRN, BLU];
          case 'R5': // ë³´ì¡°ì¥ë¹„
          case 'C2': // ì¹­í˜¸
          case 'L6': // ê·€ê±¸ì´
          case 'R6': // ë§ˆë²•ì„
            return [PLAT];
          default:
            return [];
        }
      }

      /** ìŠ¬ë¡¯ë³„ í—ˆìš© ì— ë¸”ë ˜ íƒ€ì… */
      const SOCKET_RULES = {
        headshoulder: ['ë…¸ë€ë¹›ì— ë¸”ë ˜'],
        belt: ['ë…¸ë€ë¹›ì— ë¸”ë ˜'],
        top: ['ë¶‰ì€ë¹›ì— ë¸”ë ˜'],
        bottom: ['ë¶‰ì€ë¹›ì— ë¸”ë ˜'],
        shoes: ['í‘¸ë¥¸ë¹›ì— ë¸”ë ˜'],
        bracelet: ['í‘¸ë¥¸ë¹›ì— ë¸”ë ˜'],
        necklace: ['ë…¹ìƒ‰ë¹›ì— ë¸”ë ˜'],
        ring: ['ë…¹ìƒ‰ë¹›ì— ë¸”ë ˜'],
        weapon: ['ë¶‰ì€ë¹›ì— ë¸”ë ˜', 'ë…¸ë€ë¹›ì— ë¸”ë ˜', 'ë…¹ìƒ‰ë¹›ì— ë¸”ë ˜', 'í‘¸ë¥¸ë¹›ì— ë¸”ë ˜'],
        sub: ['í”Œë˜í‹°ë„˜ì— ë¸”ë ˜'],
        title: ['í”Œë˜í‹°ë„˜ì— ë¸”ë ˜'],  // ì¹­í˜¸ ì¢Œì¸¡ ì› 1ê°œ
        earring: ['í”Œë˜í‹°ë„˜ì— ë¸”ë ˜'],              // âœ… ê·€ê±¸ì´
        magestone: ['í”Œë˜í‹°ë„˜ì— ë¸”ë ˜'],            // âœ… ë§ˆë²•ì„
      };
      const SOCKET_COUNT = (slotKey) => (slotKey === 'sub' || slotKey === 'title' || slotKey === 'earring' || slotKey === 'magestone') ? 1 : 2;

      const emblemModal = document.getElementById('emblemModal');
      const emblemRows = document.getElementById('emblemRows');

      state.emblems = state.emblems || {};  // { slotKey: [null, null] }
      state.ui.emblemTarget = { slotKey: null, sockIndex: 0 };
      function ensureEmblemArray(slotKey) {
        if (!state.emblems[slotKey]) state.emblems[slotKey] = new Array(SOCKET_COUNT(slotKey)).fill(null);
      }

      /** ì‘ì€ ì› UI ì—…ë°ì´íŠ¸ */
      function paintEmblemDot(slotKey, sockIndex) {
        const dot = document.querySelector(`.emblem-dot[data-slot="${slotKey}"][data-sock="${sockIndex}"]`);
        if (!dot) return;
        const picked = (state.emblems[slotKey] || [])[sockIndex] || null;
        // ì´ˆê¸°í™”
        dot.innerHTML = '';
        dot.classList.toggle('empty', !picked);
        if (picked) {
          // ë°°ê²½ ì´ë¯¸ì§€ë¡œ ì£¼ì… (ì›í˜• í´ë¦¬í•‘ 100% ë³´ì¥)
          const src = (picked.img || PLACEHOLDER_IMG).replace(/"/g, '\\"');
          dot.style.setProperty('--emblem', `url("${src}")`);
          dot.classList.add('has-img');

          // ì¤‘ì•™ ìˆ«ì
          const n = document.createElement('span');
          n.className = 'num';
          n.textContent = picked.level_num ?? '';
          dot.appendChild(n);
        } else {
          // ë¹„ì›Œì§ ìƒíƒœ
          dot.classList.remove('has-img');
          dot.style.removeProperty('--emblem');
        }
        /* â–¼ ë³´ì¡°ì¥ë¹„/ì¹­í˜¸(í”Œë˜í‹°ë„˜)ì¼ ë•Œ ìº¡ì…˜ í‘œì‹œ */
        const isPlatSocket =
          SOCKET_RULES[slotKey] &&
          SOCKET_RULES[slotKey].length === 1 &&
          SOCKET_RULES[slotKey][0] === 'í”Œë˜í‹°ë„˜ì— ë¸”ë ˜';
        if (isPlatSocket) {
          // dot ë°”ë¡œ ì•„ë˜ì— .emblem-captionì„ ë§Œë“¤ê±°ë‚˜ ì°¾ì•„ì„œ ê°±ì‹ 
          let cap = dot.nextElementSibling;
          if (!cap || !cap.classList.contains('emblem-caption')) {
            cap = document.createElement('div');
            cap.className = 'emblem-caption';
            dot.parentNode.insertBefore(cap, dot.nextSibling);
          }
          // ì„ íƒ ì‹œì—” 'ë ™ì œ' í…ìŠ¤íŠ¸(item.tag), ë¯¸ì„ íƒì´ë©´ ìˆ¨ê¹€
          if (picked && picked.tag) {
            cap.innerHTML = picked.tag.replace(/\n/g, '<br>'); // âœ… ì¤„ë°”ê¿ˆ í—ˆìš©
            cap.style.display = 'block';
          } else {
            cap.textContent = '';
            cap.style.display = 'none';
          }
        }

      }

      /** ëª¨ë“  ì  ìƒˆë¡œê³ ì¹¨ */
      function refreshAllDots() {
        const keys = Object.keys(state.emblems || {});
        for (const sk of keys) {
          const arr = state.emblems[sk] || [];
          for (let i = 0; i < arr.length; i++) {
            paintEmblemDot(sk, i);
          }
        }
      }
      /** ì—†ìŒ ì¸ë„¤ì¼ */
      function makeNoneThumb(onPick) {
        const b = document.createElement('button');
        b.type = 'button'; b.className = 'em-thumb none'; b.title = 'ì—†ìŒ'; b.onclick = onPick; return b;
      }
      // ì¼ë°˜ ì¸ë„¤ì¼(ì´ë¯¸ì§€ ì¤‘ì•™ ìˆ«ì)
      function makeEmblemThumb(item, onPick) {
        const b = document.createElement('button');
        b.type = 'button'; b.className = 'em-thumb';
        const src = item.image || item['ì´ë¯¸ì§€'] || (item.raw && item.raw['ì´ë¯¸ì§€']) || PLACEHOLDER_IMG;
        const img = document.createElement('img');
        img.src = src;
        img.onerror = () => { img.src = PLACEHOLDER_IMG; };


        // '6ë‹¨ê³„', 'Lv.6' ë“±ì—ì„œ ìˆ«ì ì¶”ì¶œ (ì—†ìœ¼ë©´ ê³µë°±)
        const levelNum =
          (item.level_num != null ? String(item.level_num) : '') ||
          (item.level != null ? String(item.level) : '') ||
          (String(item.name || '').match(/(\d+)\s*ë‹¨ê³„/i)?.[1] || '') ||
          (String(item.name || '').match(/lv\.?\s*(\d+)/i)?.[1] || '');


        const num = document.createElement('span');
        num.className = 'num';
        num.textContent = levelNum;

        b.appendChild(img); b.appendChild(num);
        b.onclick = onPick;
        return b;
      }

      /** í”Œë˜í‹°ë„˜ 7ì¤„ ë¶„ë¥˜ í‚¤ì›Œë“œ */
      const PLAT_LINES = [
        { label: 'í™”', key: 'í™”' },
        { label: 'ìˆ˜', key: 'ìˆ˜' },
        { label: 'ëª…', key: 'ëª…' },
        { label: 'ì•”', key: 'ì•”' },
        { label: 'ëª¨ì†', key: 'ëª¨ì†' },
        { label: 'í˜', key: 'í˜' },
        { label: 'ì§€ëŠ¥', key: 'ì§€ëŠ¥' },
      ];
      async function openEmblemModalFor(slotKey, sockIndex = 0) {
        await ensureEnhLoaded();

        const allow = emblemTypesForSlot(slotKey);   // í—ˆìš© íƒ€ì…ë“¤
        const pool = [];
        for (const t of allow) {
          const arr = (window.DBEnh.byType && window.DBEnh.byType[t]) || [];
          for (const it of arr) pool.push({ ...it, emblemType: t });
        }

        const wrap = document.getElementById('emblemGrid');   // â† ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ
        if (!wrap) return;
        wrap.innerHTML = '';

        if (!pool.length) {
          wrap.innerHTML = `<div style="color:#c7b589; padding:8px;">ì„ íƒ ê°€ëŠ¥í•œ ì— ë¸”ë ˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        } else {
          for (const it of pool) {
            const btn = document.createElement('button');
            btn.className = 'emblem-tile';
            btn.type = 'button';
            btn.innerHTML = `
        <div class="emblem-img" style="background-image:url('${it.image || ''}')"></div>
        <div class="emblem-name">${it.name}</div>
        ${it.level ? `<div class="emblem-level">${it.level}</div>` : ''}
      `;
            btn.addEventListener('click', () => pickEmblem(slotKey, sockIndex, it));
            wrap.appendChild(btn);
          }
        }

        // ì„ íƒ ì¤‘ì¸ ì†Œì¼“ í‘œì‹œ/ì €ì¥
        window.state = window.state || {};
        state.enh = {}; // ìŠ¬ë¡¯ë³„ ê°•í™” ì„ íƒê°’ ì €ì¥ìš©
        // â˜… ìŠ¬ë¡¯ë³„ version-token ì €ì¥ ê³µê°„
        state.slotVer = state.slotVer || {};
        // ì˜ˆ: state.slotVer['weapon'] = 17;
        state.currentEmblemPick = { slotKey, sockIndex };

        // ëª¨ë‹¬ ì—´ê¸°
        document.getElementById('emblemModal')?.classList.add('show');
      }

      /** ì— ë¸”ë ˜ ëª¨ë‹¬ ì—´ê¸° */
      async function openEmblemPicker(slotKey, sockIndex) {
        await ensureEnhLoaded();
        ensureEmblemArray(slotKey);


        // ğŸ”¸ í˜¹ì‹œë¼ë„ uiê°€ ë‚ ì•„ê°„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë°©ì–´ ì½”ë“œ
        if (!state.ui || typeof state.ui !== 'object') {
          state.ui = {};
        }

        state.ui.emblemTarget = { slotKey, sockIndex };
        emblemRows.innerHTML = '';

        const allow = SOCKET_RULES[slotKey] || [];
        const isPlatSocket =
          SOCKET_RULES[slotKey]
          && SOCKET_RULES[slotKey].length === 1
          && SOCKET_RULES[slotKey][0] === 'í”Œë˜í‹°ë„˜ì— ë¸”ë ˜';
        const isPlatinumOnly = isPlatSocket || (allow.length === 1 && allow[0] === 'í”Œë˜í‹°ë„˜ì— ë¸”ë ˜');

        if (isPlatinumOnly) {
          // í”Œë˜í‹°ë„˜ ê´€ë ¨ í‚¤ë“¤ì´ 'í”Œë˜í‹°ë„˜ ì— ë¸”ë ˜', 'í”Œë˜í‹°ë„˜(ì¹­í˜¸)' ë“± ë³€í˜•ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì „ë¶€ ëª¨ì•„ì¤Œ
          const byType = (window.DBEnh && DBEnh.byType) || {};
          let base = byType['í”Œë˜í‹°ë„˜ì— ë¸”ë ˜'] || [];

          PLAT_LINES.forEach(line => {
            const row = document.createElement('div');
            row.className = 'em-row';
            row.appendChild(makeNoneThumb(() => pickEmblem(slotKey, sockIndex, null)));

            // â¬‡ï¸ í•µì‹¬: ë¼ì¸ ë¶„ë¥˜ë¥¼ tagê°€ ì—†ìœ¼ë©´ 'ë ™ì œ'ë¡œ ëŒ€ì²´
            // 'í™”' ë¼ì¸ì—ëŠ” 'í™”','í™”ì†','í™”ì†ì„±','ë¶ˆ' ë“±ë„ ë§¤ì¹­ë˜ê²Œ ë™ì˜ì–´ í—ˆìš©
            const SYNS = {
              'í™”': ['í™”', 'í™”ì†', 'í™”ì†ì„±', 'ë¶ˆ'],
              'ìˆ˜': ['ìˆ˜', 'ìˆ˜ì†', 'ìˆ˜ì†ì„±', 'ë¬¼'],
              'ëª…': ['ëª…', 'ëª…ì†', 'ëª…ì†ì„±', 'ë¹›'],
              'ì•”': ['ì•”', 'ì•”ì†', 'ì•”ì†ì„±', 'ì–´ë‘ '],
              'ëª¨ì†': ['ëª¨ì†', 'ì „ì²´', 'ëª¨ë“ ì†ì„±'],
              'í˜': ['í˜'],
              'ì§€ëŠ¥': ['ì§€ëŠ¥'],
            };

            base.filter(x => {
              const tag = String(x.levelVal);
              const cand = SYNS[line.key] || [line.key];
              return cand.some(w => tag.includes(w));
            }).forEach(item => {
              row.appendChild(makeEmblemThumb(item, () => pickEmblem(slotKey, sockIndex, item)));
            });

            emblemRows.appendChild(row);
          });
        } else {
          // ì¼ë°˜ ìƒ‰ ì— ë¸”ë ˜: ìŠ¬ë¡¯ ê·œì¹™ëŒ€ë¡œ í•œ ì¤„ì”© ê°€ë¡œ ë¦¬ìŠ¤íŠ¸
          const orderMap = { 'ë¶‰ì€ë¹›ì— ë¸”ë ˜': 0, 'ë…¸ë€ë¹›ì— ë¸”ë ˜': 1, 'ë…¹ìƒ‰ë¹›ì— ë¸”ë ˜': 2, 'í‘¸ë¥¸ë¹›ì— ë¸”ë ˜': 3 };
          allow.slice().sort((a, b) => (orderMap[a] ?? 9) - (orderMap[b] ?? 9)).forEach(type => {
            const row = document.createElement('div');
            row.className = 'em-row';
            row.appendChild(makeNoneThumb(() => pickEmblem(slotKey, sockIndex, null)));
            (DBEnh.byType[type] || []).forEach(item => {
              row.appendChild(makeEmblemThumb(item, () => pickEmblem(slotKey, sockIndex, item)));
            });
            emblemRows.appendChild(row);
          });
        }

        document.getElementById('emblemDlgTitle').textContent =
          `ì— ë¸”ë ˜ ì„ íƒ - ${labelForSlot(slotKey)} (ì†Œì¼“ ${sockIndex + 1})`;
        emblemModal.classList.add('show');
        emblemModal.setAttribute('aria-hidden', 'false');
      }

      /** ì— ë¸”ë ˜ ë‹¨ì¼ ì„ íƒ ì²˜ë¦¬ (ì„œë²„ í˜¸ì¶œ X, stateë§Œ ê°±ì‹ ) */
      async function pickEmblem(slotKey, sockIndex, item) {
        try {
          window.state = window.state || {};
          state.emblems = state.emblems || {};
          ensureEmblemArray(slotKey);  // ìŠ¬ë¡¯ë³„ ë°°ì—´ ì¤€ë¹„

          // ğŸ”¸ 1) 'ì—†ìŒ' / ë¹ˆ ì„ íƒ ì²˜ë¦¬
          if (!item || item?.name === '+' || item?.name === 'ì—†ìŒ') {
            state.emblems[slotKey][sockIndex] = null;
            paintEmblemDot(slotKey, sockIndex);
            closeEmblemPicker();
            return;
          }

          // ğŸ”¸ 2) í”„ë¡ íŠ¸ í‘œì‹œìš© ì— ë¸”ë ˜ ê°ì²´ ìƒì„±
          const img =
            item?.image ||
            item?.img ||
            item?.['ì´ë¯¸ì§€'] ||
            (item?.raw && item.raw['ì´ë¯¸ì§€']) ||
            '';

          const levelVal = String(item?.levelVal ?? '').trim();
          const levelNum = item?.level_num ?? '';
          const type = String(item?.type ?? '').trim();

          state.emblems[slotKey][sockIndex] = {
            img,
            tag: `${levelVal}`,   // ê¸°ì¡´ íƒœê·¸ í˜•ì‹ ìœ ì§€(ì¤„ë°”ê¿ˆ í¬í•¨)
            name: item?.name || '',
            level_num: levelNum,
            levelVal: levelVal,
            type: type
          };

          // ğŸ”¸ 3) ë„íŠ¸ UI ë°˜ì˜ + ëª¨ë‹¬ ë‹«ê¸°
          paintEmblemDot(slotKey, sockIndex);
          closeEmblemPicker();
          // sum_stats / compute ëŠ” calc_all ì´í›„ì—ë§Œ í˜¸ì¶œ (ì—¬ê¸°ì„œëŠ” ì•ˆ ë¶€ë¦„)
        } catch (e) {
          console.error('[pickEmblem] error:', e);
          alert('ì— ë¸”ë ˜ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }


      function closeEmblemPicker() { emblemModal.classList.remove('show'); emblemModal.setAttribute('aria-hidden', 'true'); }
      emblemModal.addEventListener('click', (e) => { if (e.target.hasAttribute('data-close') || e.target.classList.contains('backdrop')) closeEmblemPicker(); });
      /** ì‘ì€ ì›(ì†Œì¼“) ì£¼ì…: ì¢Œì¸¡ì—´ì€ slot ì˜¤ë¥¸ìª½, ìš°ì¸¡ì—´ì€ slot ì™¼ìª½. ë³´ì¡°ì¥ë¹„ëŠ” 1ê°œ. */
      function injectEmblemDots() {
        // ë©”ì¸ ì¢Œ/ìš° ì—´
        document.querySelectorAll('.slot-row').forEach(row => {
          const slotEl = row.querySelector('.slot');
          if (!slotEl) return;
          const code = slotEl.getAttribute('data-slot');
          const sk = SLOT_MAP[code];          // â† ë°˜ë“œì‹œ ìƒˆ ë³€ìˆ˜ë¡œ 'ì„ ì–¸'
          if (!sk) return;

          // ì¤‘ì•™ ë¯¸ë‹ˆ 4ì¹¸(C1~C4)ì€ ë’¤ì—ì„œ ë”°ë¡œ ì²˜ë¦¬
          if (['aura', 'title', 'creature', 'artifact'].includes(sk)) return;
          if (!SOCKET_RULES[sk]) return; // ì— ë¸”ë ˜ ë¯¸ì§€ì› ìŠ¬ë¡¯ì€ ìŠ¤í‚µ

          const stack = document.createElement('div');
          stack.className = 'emblem-stack';

          const count = SOCKET_COUNT(sk);
          for (let i = 0; i < count; i++) {
            const dot = document.createElement('button');
            dot.type = 'button';
            dot.className = 'emblem-dot empty';
            dot.setAttribute('data-slot', sk);
            dot.setAttribute('data-sock', String(i));
            dot.onclick = (e) => { e.stopPropagation(); openEmblemPicker(sk, i); };
            stack.appendChild(dot);
          }
          ensureEmblemArray(sk);
          // ì¢Œì¸¡ì—´(L*) â†’ slot ì˜¤ë¥¸ìª½ / ìš°ì¸¡ì—´(R*) â†’ slot ì™¼ìª½
          if (code.startsWith('L')) row.appendChild(stack);
          else if (code.startsWith('R')) row.insertBefore(stack, slotEl);
        });

        // ì¹­í˜¸(Title) ì²˜ë¦¬: ì™¼ìª½ 2ê°œ ì„ íƒì¹¸ ì¤‘ 'ì•„ë˜ ì„ íƒì¹¸' ì œê±°í•˜ê³  ì› 1ê°œ ë„£ê¸° (í”Œë˜í‹°ë„˜)
        const titleSlot = document.querySelector('.slot.mini[data-slot="C2"]');
        if (titleSlot) {
          const miniCell = titleSlot.closest('.mini-cell');
          if (miniCell) {
            const outer = miniCell.querySelector('.outer-rects');
            if (outer) {
              const btns = outer.querySelectorAll('.rect');
              if (btns[1]) btns[1].remove(); // ì•„ë˜ ë²„íŠ¼ ì œê±°
            }
            const stack = document.createElement('div');
            stack.className = 'emblem-stack';
            const dot = document.createElement('button'); dot.type = 'button'; dot.className = 'emblem-dot empty';
            dot.setAttribute('data-slot', 'title'); dot.setAttribute('data-sock', '0');
            dot.onclick = (e) => { e.stopPropagation(); openEmblemPicker('title', 0); };
            stack.appendChild(dot);
            ensureEmblemArray('title');
            miniCell.insertBefore(stack, miniCell.querySelector('.slot.mini'));
          }
        }

        refreshAllDots();
      }

      let __runeCommitInFlight = false;  // ìŠ¤í‚¬ë£¬ ì €ì¥/í•©ì‚° ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸
      const runeModal = document.getElementById('runeModal');
      const runeGridEl = document.getElementById('runeGrid');

      // ê°€í˜¸ / ì§€í˜œ / ì™œê³¡ íŠ¹ìˆ˜ ë£¬ ì •ì˜
      const specialRuneDefs = [
        { key: 'gaho', label: 'ê°€í˜¸' },
        { key: 'jihe', label: 'ì§€í˜œ' },
        { key: 'waegok', label: 'ì™œê³¡' },
      ];

      function ensureSpecialRunesInitialized() {
        if (!state.specialRunes) {
          state.specialRunes = { gaho: 0, jihe: 0, waegok: 0 };
        } else {
          ['gaho', 'jihe', 'waegok'].forEach(k => {
            if (typeof state.specialRunes[k] !== 'number') {
              const v = Number(state.specialRunes[k] || 0);
              state.specialRunes[k] = Number.isFinite(v) ? v : 0;
            }
          });
        }
      }

      function bindSpecialRuneSelects() {
        ensureSpecialRunesInitialized();
        specialRuneDefs.forEach(info => {
          const sel = document.getElementById(`specialRune_${info.key}`);
          if (!sel) return;

          sel.value = String(state.specialRunes[info.key] ?? 0);

          sel.onchange = (e) => {
            const before = Number(state.specialRunes[info.key] || 0);
            const after = Number(e.target.value) || 0;
            const diff = after - before;
            const total = countSelectedRunes(); // before ê°’ì´ í¬í•¨ëœ ì „ì²´ ê°œìˆ˜

            // ì „ì²´(ì¼ë°˜ + íŠ¹ìˆ˜) 20ê°œ ì´ˆê³¼ ì‹œ ë§‰ê¸°
            if (total + diff > 20) {
              e.target.value = String(before);
              // ì¼ë°˜ ìŠ¤í‚¬ë£¬ê³¼ ë™ì¼í•œ í”¼ë“œë°± ì• ë‹ˆë©”ì´ì…˜
              e.target.animate(
                [{ transform: 'scale(1)' }, { transform: 'scale(1.05)' }, { transform: 'scale(1)' }],
                { duration: 160 }
              );
              return;
            }

            state.specialRunes[info.key] = after;
            updateRuneCountSummary();
          };
        });
      }


      let __runesSnapshot = ''; // ì—´ì—ˆì„ ë•Œì˜ JSON ìŠ¤ëƒ…ìƒ·(ë‹«ì„ ë•Œ ë³€ê²½ ê°ì§€)
      function renderRuneGrid() {
        ensureRunesInitialized();
        runeGridEl.innerHTML = '';

        // í—¤ë” í–‰
        const header = document.createElement('div'); header.className = 'row';
        const headCell = document.createElement('div'); headCell.className = 'head'; headCell.textContent = 'ìŠ¤í‚¬ë£¬';
        header.appendChild(headCell);
        RUNE_LEVELS.forEach(lvl => {
          const c = document.createElement('div'); c.className = 'cell';
          const tag = document.createElement('div'); tag.className = 'head'; tag.textContent = String(lvl);
          tag.style.textAlign = 'center';
          c.appendChild(tag);
          header.appendChild(c);
        });
        runeGridEl.appendChild(header);

        // ì¹´í…Œê³ ë¦¬ í–‰ë“¤
        // ì¹´í…Œê³ ë¦¬ í–‰ë“¤
        RUNE_CATS.forEach(cat => {
          const row = document.createElement('div');
          row.className = 'row';

          // â–¼ ì¹´í…Œê³ ë¦¬ í—¤ë” (ì•„ì´ì½˜ + í…ìŠ¤íŠ¸)
          const head = document.createElement('div');
          head.className = 'head rune-cat-head';

          const icon = document.createElement('img');
          icon.className = 'rune-cat-icon';
          icon.alt = cat.label;

          // ë¼ë²¨ ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ ë§¤ì¹­
          if (cat.label === 'ê°ì„±') {
            icon.src = '/img/etc/skillrune/ê°ì„±.png';
          } else if (cat.label === 'ë§ˆë ¥') {
            icon.src = '/img/etc/skillrune/ë§ˆë ¥.png';
          } else if (cat.label === 'í—ˆìƒ') {
            icon.src = '/img/etc/skillrune/í—ˆìƒ.png';
          } else if (cat.label === 'ìˆ™ë ¨' || cat.label === 'ê¸°êµ') {
            icon.src = '/img/etc/skillrune/ìˆ™ë ¨ê¸°êµ.png';
          }

          const label = document.createElement('div');
          label.className = 'rune-cat-label';
          label.textContent = cat.label;

          head.appendChild(icon);
          head.appendChild(label);
          row.appendChild(head);

          // â–¼ ì˜¤ë¥¸ìª½ ë ˆë²¨ë³„ ì…€ë ‰íŠ¸ë“¤ì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ
          RUNE_LEVELS.forEach(lvl => {
            const c = document.createElement('div');
            c.className = 'cell';

            const sel = document.createElement('select');
            sel.className = 'rune-select';
            for (let i = 0; i <= 20; i++) {
              const o = document.createElement('option');
              o.value = String(i);
              o.textContent = String(i);
              sel.appendChild(o);
            }

            sel.value = String((state.runes?.[cat.key]?.[lvl]) || 0);
            sel.addEventListener('change', () => {
              const before = Number(state.runes[cat.key][lvl] || 0);
              const after = Number(sel.value) || 0;
              const diff = after - before;
              const total = countSelectedRunes();
              if (total + diff > 20) {
                sel.value = String(before);
                sel.animate(
                  [{ transform: 'scale(1)' }, { transform: 'scale(1.05)' }, { transform: 'scale(1)' }],
                  { duration: 160 }
                );
                return;
              }
              state.runes[cat.key][lvl] = after;
              updateRuneCountSummary();
            });

            c.appendChild(sel);
            row.appendChild(c);
          });

          runeGridEl.appendChild(row);
        });
      }

      // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° + ì €ì¥
      async function openRuneModal() {
        __runeCommitInFlight = false;
        await loadRunesFromServerOnce();     // ì„œë²„ê°’ ë³µêµ¬(ìµœì´ˆ 1íšŒ) â†’ state.runes ì±„ì›€
        if (typeof ensureRunesInitialized === 'function') ensureRunesInitialized();
        renderRuneGrid();
        updateRuneCountSummary();
        bindSpecialRuneSelects();            // â˜… ê°€í˜¸/ì§€í˜œ/ì™œê³¡ ì…€ë ‰íŠ¸ ë™ê¸°í™”
        __runesSnapshot = JSON.stringify(state?.runes || {});
        runeModal.classList.add('show');
        runeModal.setAttribute('aria-hidden', 'false');
      }
      function actuallyCloseRuneModal() {
        runeModal.classList.remove('show');
        runeModal.setAttribute('aria-hidden', 'true');
      }
      async function closeRuneModalAndMaybeSave() {
        if (__runeCommitInFlight) return;          // ğŸ”’ ì¤‘ë³µ ë°©ì§€
        __runeCommitInFlight = true;
        try {
          const $btn = document.getElementById('runeCommit');
          if ($btn) { $btn.disabled = true; $btn.textContent = 'ì ìš© ì¤‘â€¦'; }

          const current = state?.runes || {};
          const snapNow = JSON.stringify(current);
          const changed = (snapNow !== __runesSnapshot);
          if (changed) {
            // ğŸ”¸ ì´ì œëŠ” ì„œë²„ í˜¸ì¶œ ì—†ì´ í”„ë¡ íŠ¸ ìŠ¤ëƒ…ìƒ·ë§Œ ê°±ì‹ 
            __runesSnapshot = snapNow;
          }
          actuallyCloseRuneModal();               // ëª¨ë‹¬ ë‹«ê¸°
        } finally {
          __runeCommitInFlight = false;
          const $btn = document.getElementById('runeCommit');
          if ($btn) { $btn.disabled = false; $btn.textContent = 'ì„¤ì • í•˜ê¸°'; }
        }
      }

      // ë°”ê¹¥ í´ë¦­(= backdrop, data-close) ì‹œ ë‹«ê¸°
      runeModal?.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target.classList.contains('backdrop') || target.dataset.close != null)) return;
        if (__runeCommitInFlight) return;          // ğŸ”’ ì €ì¥ ì¤‘ì´ë©´ ë¬´ì‹œ
        closeRuneModalAndMaybeSave();
      });

      // ESC ë‹«ê¸°
      document.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape' && runeModal && runeModal.getAttribute('aria-hidden') === 'false') {
          if (__runeCommitInFlight) return;         // ğŸ”’ ì €ì¥ ì¤‘ì´ë©´ ë¬´ì‹œ
          closeRuneModalAndMaybeSave();
        }
      });

      document.getElementById('runeCommit')?.addEventListener('click', () => {
        if (__runeCommitInFlight) return;          // ğŸ”’ ì¤‘ë³µ ë°©ì§€
        closeRuneModalAndMaybeSave();
      });

      // (í•„ìš” ì‹œ) ì—´ê¸° ë²„íŠ¼ ë°”ì¸ë”© â€” ì´ë¯¸ ë‹¤ë¥¸ ë²„íŠ¼ì´ ìˆìœ¼ë©´ ê·¸ idë¡œ ë°”ê¿”ì¤˜
      document.getElementById('btnRune')?.addEventListener('click', openRuneModal);

      // ì•± ì§„ì… ì‹œ ì„œë²„ ìƒíƒœ ë³µêµ¬ (ìµœì´ˆ 1íšŒ)
      let __runesLoaded = false;
      async function loadRunesFromServerOnce() {
        if (__runesLoaded) return;
        try {
          const token = await waitForIdToken();
          const r = await fetch(window.WEBAPP_URL + '?type=rune_state_get', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id_token: token })
          });
          const j = await r.json().catch(() => null);
          if (j?.ok && j?.runes) {
            state.runes = j.runes;
            state.skillrune = state.runes;   // ğŸ”¹ ë¯¸ëŸ¬ë§
          }
          ensureRunesInitialized();
          updateRuneCountSummary();
        } catch {
          ensureRunesInitialized();
          updateRuneCountSummary();
        }
        __runesLoaded = true;
      }
      // ë¶€íŠ¸ìŠ¤íŠ¸ë© ì‹œ ë¯¸ë¦¬ í˜¸ì¶œí•´ë„ ë¨
      loadRunesFromServerOnce();

      /* ===== ìŠ¤í‚¬íŠ¸ë¦¬ ë¡œë” & UI (UI ì „ìš©, ê³„ì‚° ë¯¸ì—°ê²°) ===== */
      const DBTree = { loaded: false, rows: [], byChar: new Map() };
      const ST_CONF = { SP_TOTAL: 1210, TP_TOTAL: 35 };
      const LEVEL_BANDS_DEFAULT = [1, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 65, 70, 75, 80];
      function pickCol(r, ...ks) { for (const k of ks) { if (r[k] != null && String(r[k]).trim() !== '') return r[k]; } return ''; }
      function toNum(v) { if (v === '' || v == null) return 0; const n = Number(String(v).replace(/[, ]/g, '')); return isNaN(n) ? 0 : n; }
      function toList(v) { return (v ? String(v).split(/[,;]/).map(s => s.trim()).filter(Boolean) : []); }

      function mapRowToSkill(r) {
        // ë„¤ê°€ ì¤€ ì»¬ëŸ¼ í‚¤ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const whoRaw = r['ìºë¦­í„°ëª…'];
        const name = String(r['ìŠ¤í‚¬ëª…'] ?? '').trim();
        const band = toNum(r['ìŠ¤í‚¬ë ™ì œ']);
        const cd = toNum(r['ì¿¨íƒ€ì„']);
        const castFrames = toNum(r['ì‹œì „í”„ë ˆì„']);
        const minLv = toNum(r['ìµœì†ŒìŠ¤í‚¬ë ˆë²¨']);
        const maxLv = toNum(r['ìµœëŒ€ìŠ¤í‚¬ë ˆë²¨']);       // (= ë§ˆìŠ¤í„°ìŠ¤í‚¬ë ˆë²¨)
        const sp = toNum(r['ì†Œëª¨ SP']);               // SP ë¹„ìš©(ë ˆë²¨ë‹¹)
        const icon = cleanUrl(r['ì´ë¯¸ì§€']) || PLACEHOLDER_IMG;

        const who = String(whoRaw ?? '').replace(/\s+/g, '').trim();

        const idBase = (r['ìŠ¤í‚¬ID'] ?? name).toString().trim();
        const id = idBase ? `${idBase}#${band || 0}` : (Date.now().toString(36) + Math.random().toString(36).slice(2));

        return {
          id, who, name, icon,
          band: band || 1,
          levelGate: band || 1,     // â† ì¶”ê°€: ìŠ¤í‚¬ë ™ì œ(ë ˆë²¨ë§ ê²Œì´íŠ¸) í†µì¼ í‚¤
          min: Math.max(0, minLv || 0),
          max: Math.max(1, maxLv || 1),
          sp: Math.max(0, sp || 0),
          tp: 0,
          cd,
          castFrames,
          prereq: [],
          desc: ''
        };
      }



      /* ===== ì— ë¸”ë ˜ í•©ì—°ì‚° í¬í•¨ì„ ìœ„í•´ í•©ì‚° í•¨ìˆ˜ í™•ì¥ ===== */
      const _sumSelections_base = sumSelections;
      sumSelections = function () {
        const S = _sumSelections_base();

        // ëˆ„ì ê¸° ì•ˆì „ ë³´ì •(ë² ì´ìŠ¤ê°€ í•­ìƒ ë„£ì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥¼ ì¬ì •ì˜ ëŒ€ë¹„)
        S.__skillMul = S.__skillMul || 1;
        S.__skillAddBuff = S.__skillAddBuff || 0;

        const add = (st, src = 'other') => {
          if (!st) return;

          // 1) ìŠ¤ì¦ë§Œ ë¶„ê¸°
          if (st.skill_atk_inc) {
            if (src === 'buff') S.__skillAddBuff += (st.skill_atk_inc || 0);  // ë²„í”„ëŠ” í•©ì‚°
            else S.__skillMul *= (1 + (st.skill_atk_inc || 0)); // ë‚˜ë¨¸ì§€ëŠ” ê³±ì‚°
          }

          // 2) ë‚˜ë¨¸ì§€ ìŠ¤íƒ¯ì€ ê¸°ì¡´ì²˜ëŸ¼ ê°€ì‚°
          S.phys_atk += st.phys_atk || 0; S.mag_atk += st.mag_atk || 0;
          S.str += st.str || 0; S.int += st.int || 0;
          S.phys_crit += st.phys_crit || 0; S.mag_crit += st.mag_crit || 0;
          S.phys_crit_rate += st.phys_crit_rate || 0; S.mag_crit_rate += st.mag_crit_rate || 0;
          S.add_damage += st.add_damage || 0;
          S.str_pct += st.str_pct || 0; S.int_pct += st.int_pct || 0;
          S.damage_inc += st.damage_inc || 0; S.crit_damage_inc += st.crit_damage_inc || 0;
          S.phys_atk_pct += st.phys_atk_pct || 0; S.mag_atk_pct += st.mag_atk_pct || 0;
          if (st.elem) { S.elem.fire += st.elem.fire || 0; S.elem.water += st.elem.water || 0; S.elem.light += st.elem.light || 0; S.elem.dark += st.elem.dark || 0; }
          S.cdr += st.cdr || 0;
          if (st.speed) { S.speed.attack += st.speed.attack || 0; S.speed.move += st.speed.move || 0; S.speed.cast += st.speed.cast || 0; }
          if (st.other) { S.def_break_inc += st.other.def_break_inc || 0; }
        };


        // ì— ë¸”ë ˜(ê³± ëŒ€ìƒ)
        Object.keys(state.emblems || {}).forEach(slotKey => {
          (state.emblems[slotKey] || []).forEach(it => { if (it?.stats) add(it.stats, 'other'); });
        });

        // ì˜µì…˜(ì•„ë°”íƒ€/ë¬´ê¸°ì••)ë„ ê³± ëŒ€ìƒ
        if (state.options?.avatarEnh?.stats) add(state.options.avatarEnh.stats, 'other');
        if (state.options?.imprintEnh?.stats) add(state.options.imprintEnh.stats, 'other');

        // ë£¬ ê°ì¸(ê³± ëŒ€ìƒ)
        if (state.runeEngrave?.stats) add(state.runeEngrave.stats, 'other');

        // ë²„í”„ ì‹œíŠ¸(í•© ëŒ€ìƒ)
        if (state.__buffStats) add(state.__buffStats, 'buff');

        // â˜… ì•„ì§ S.skill_atk_inc í™•ì •í•˜ì§€ ì•ŠìŒ (5ë²ˆì§¸ì—ì„œ ë§ˆë´‰Â·ë§ˆë¶€ê¹Œì§€ í¬í•¨ í›„ ìµœì¢… í™•ì •)
        return S;
      };
      async function debugSessionBeforeOpenEquipModal() {
        try {
          const token = await waitForIdToken();
          const res = await apiJSON('session_dump', {});
          if (!res?.ok) {
            // console.warn('session_dump ì‹¤íŒ¨:', res);
            return;
          }

          const S = res.session;

          /* console.group('[ì¥ë¹„ ëª¨ë‹¬ ì˜¤í”ˆ â€” ì„¸ì…˜ ì „ì²´ ìƒíƒœ]');
           console.log('CharStats:', S.CharStats);
           console.log('MonStats:', S.MonStats);
           console.log('SumStats:', S.SumStats);
           console.log('WeaponStats:', S.WeaponStats);
           console.log('HeadshoulderStats:', S.HeadshoulderStats);
           console.log('TopStats:', S.TopStats);
           console.log('TitleStats:', S.TitleStats);
           console.log('AvatarStats:', S.AvatarStats);
           console.log('RunEngStats:', S.RunEngStats);
           console.log('BuffStats:', S.BuffStats);
           console.log('EnhStats:', S.EnhStats);
           console.log('SealStats:', S.SealStats);
           console.log('EnchantStats:', S.EnchantStats);
           console.log('EmblemStats:', S.EmblemStats);
           console.log('CastleStats:', S.CastleStats);
           console.groupEnd();*/
        } catch (err) {
          console.error('debug session error', err);
        }
      }

      // ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', () => {
        refreshEnhLabelsFromState();
        renderSpTp();
        // ìŠ¬ë¡¯ í´ë¦­ â†’ ì•„ì´í…œ ì„ íƒ
        document.querySelectorAll('.slot').forEach(el => {
          const code = el.getAttribute('data-slot'); const slotKey = SLOT_MAP[code]; if (!slotKey) return;
          el.addEventListener('click', async (e) => { e.stopPropagation(); await debugSessionBeforeOpenEquipModal(); openItemPicker(slotKey); });
        });



        // ì²« ë²ˆì§¸ ì„ íƒì¹¸ = ê°•í™” ì„ íƒ ì—°ê²°
        document.querySelectorAll('.slot-row').forEach(row => {
          const slotEl = row.querySelector('.slot'); const code = slotEl?.getAttribute('data-slot'); const slotKey = SLOT_MAP[code];
          const rects = row.querySelectorAll('.outer-rects .rect');
          if (!slotKey || !rects.length) return;
          const firstBtn = rects[0];
          /* â–¼ ì¶”ê°€: ê¸°ë³¸ ë¼ë²¨ì„ 'ê°•í™” ì„¤ì •'ìœ¼ë¡œ ë³´ì´ê²Œ */
          firstBtn.textContent = 'ê°•í™” ì„¤ì •';
          firstBtn.addEventListener('click', (e) => { e.stopPropagation(); openEnhPicker(slotKey, firstBtn); });
        });

        // ë‘ ë²ˆì§¸ ì„ íƒì¹¸ = ë§ˆë´‰ ì„ íƒ ì—°ê²°
        document.querySelectorAll('.slot-row').forEach(row => {
          const slotEl = row.querySelector('.slot');
          const code = slotEl?.getAttribute('data-slot');
          const slotKey = SLOT_MAP[code];
          const rects = row.querySelectorAll('.outer-rects .rect');
          if (!slotKey || rects.length < 2) return;

          const secondBtn = rects[1];
          // ê¸°ë³¸ ë¼ë²¨
          secondBtn.textContent = 'ë§ˆë´‰ ì„¤ì •';

          // ì¤‘ë³µ ë°”ì¸ë”© ë°©ì§€ (í˜ì´ì§€ ì¬ë Œë” ì‹œ ë‹¤ì¤‘ ë“±ë¡ ì˜ˆë°©)
          if (secondBtn.dataset.boundSeal === '1') return;
          secondBtn.dataset.boundSeal = '1';

          secondBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (typeof openSealModal === 'function') {
              // slotKeyì— ë§ëŠ” 3ë¶„í•  ëª¨ë‹¬ ì—´ê¸° (ê³ ìœ /ì¼ë°˜1/ì¼ë°˜2)
              openSealModal(slotKey, secondBtn);
            } else {
              console.warn('openSealModal í•¨ìˆ˜ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
          });
        });

        // === [REFINE] 4ë²ˆì§¸ ì„¸ë¶€ë²„íŠ¼ ë¼ë²¨/ì—­í•  ì„¸íŒ… ===
        document.querySelectorAll('.slot-row').forEach(row => {
          const slotEl = row.querySelector('.slot');
          const code = slotEl?.getAttribute('data-slot');       // ì˜ˆ: R1, R5 ...
          const rects = row.querySelectorAll('.outer-rects .rect');
          if (!code || rects.length < 4) return;

          // R1(ë¬´ê¸°)ê³¼ R5(ë³´ì¡°ì¥ë¹„)ë§Œ í™œì„±í™”
          if (code === 'R1' || code === 'R5') {
            const fourth = rects[3]; // 4ë²ˆì§¸ ë²„íŠ¼
            fourth.textContent = 'ì—°ë§ˆ ì„¤ì •';
            fourth.dataset.role = 'refine';
            fourth.removeAttribute('data-unused');
            fourth.removeAttribute('aria-disabled');
            fourth.disabled = false;
            fourth.classList.remove('disabled', 'is-disabled');
            fourth.style.pointerEvents = '';
          }
        });



        // ì¹­í˜¸ ì™¼ìª½ ë‘ ì„ íƒì¹¸ ë¹„í™œì„±í™”
        document.querySelectorAll('[data-unused="true"]').forEach(b => { b.classList.add('disabled'); b.title = 'ì¶”í›„ ì‚¬ìš© ì˜ˆì •'; });
        // ì— ë¸”ë ˜ ì†Œì¼“ ì£¼ì…
        injectEmblemDots();
        document.getElementById('btnRune')?.addEventListener('click', openRuneModal);
        loadRunesFromServerOnce();   // (ì„œë²„ ë£¬ ë³µêµ¬ + ì¹´ìš´íŠ¸ ê°±ì‹ ê¹Œì§€)
        /*
              // ë£¬ ê°ì¸ ë“œë¡­ë‹¤ìš´ ë°”ì¸ë”©
              const selRuneEngrave = document.getElementById('selRuneEngrave');
              const selRuneDetail = document.getElementById('selRuneDetail');
        
              selRuneEngrave?.addEventListener('change', async () => {
                selRuneDetail.innerHTML = `<option value="" selected disabled>ì„¸ë¶€ ì„¤ì •</option>`;
                selRuneDetail.disabled = true;
                const picked = selRuneEngrave.value || null;
               // if (picked) { await populateRuneDetailOptions(picked); selRuneDetail.disabled = false; }
              });
        
              selRuneDetail?.addEventListener('change', () => {
                const name = selRuneEngrave?.value || null;
                const tag = selRuneDetail.value || null;      // tag = ë ™ì œ
               // if (name && tag) applyRuneEngraveByNameTag(name, tag);
              });*/


      });

      // === ë°ì´í„° ë¡œë”ë“¤ (loadCharacterSheet, loadSkillSheet ë“±) ì •ì˜ ëë‚œ ë’¤ ===
      // ì „ì—­ í•œ ë²ˆë§Œ
      let __preloadingPromise = null;
      let __preloaded = false;

      async function preloadAllSheetsOnce() {
        if (window.__preloaded) return;

        // â˜… ë¡œê·¸ì¸/ì„¸ì…˜ ë³´ì¥
        await loginPingOnce()?.catch(() => { });
        const id_token = await waitForIdToken();

        const res = await fetch(`${WEBAPP_URL}?type=precache_all`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // ë°±ì—”ë“œê°€ id_token ë˜ëŠ” idToken ë‘˜ ë‹¤ ë°›ì„ ìˆ˜ ìˆê²Œ í•œìª½ë§Œ ë³´ë‚´ë„ ë¨
          body: JSON.stringify({ id_token })
        }).then(r => r.json());

        if (!res?.ok) throw new Error(res?.error || 'precache_all failed');
        window.__PRECACHE = res;
        window.__preloaded = true;
      }
      // â˜… ì¶”ê°€: ëª¨ë“  ì‹œíŠ¸ë¥¼ ë¯¸ë¦¬ ë¡œë“œ
      // â¬‡ ê¸°ì¡´ preloadAllSheets ì •ì˜ë¥¼ 'ì™„ì „íˆ' ì•„ë˜ ì½”ë“œë¡œ êµì²´


    </script>
    <div id="autoEnhModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="autoEnhTitle">
        <header>
          <h3 id="autoEnhTitle">ê°•í™” ìë™ ì…ë ¥</h3><button class="close" data-close>âœ•</button>
        </header>
        <div class="cols">
          <div class="titles">ê°•í™” ì„ íƒ</div> <!-- âœ… ì¶”ê°€ -->
          <div class="lists" id="autoEnhList"></div>
        </div>
      </div>
    </div>
    <div id="autoEnchantModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="autoEnchantTitle">
        <header>
          <h3 id="autoEnchantTitle">ì¶”ì²œ ë§ˆë²•ë¶€ì—¬</h3>
          <button class="close" data-close>âœ•</button>
        </header>
        <div class="body two-col">
          <div class="cols left">
            <div class="titles">ì†ì„± ì„ íƒ</div>
            <div class="lists attrs"></div>
          </div>
          <div class="cols right">
            <div class="titles">ì¶”ì²œ í‹°ì–´</div>
            <div class="lists tiers"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="autoEmblemModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="autoEmblemTitle">
        <header>
          <h3 id="autoEmblemTitle">ì— ë¸”ë ˜ ìë™ ì…ë ¥</h3>
          <button class="close" data-close>âœ•</button>
        </header>
        <!-- âœ… ì¶”ì²œ ë§ˆë²•ë¶€ì—¬ ìë™ì…ë ¥ê³¼ ë™ì¼í•œ 2ì—´ UI -->
        <div class="body two-col">
          <div class="cols left">
            <div class="titles">ì†ì„± ì„ íƒ</div>
            <div class="lists attrs" id="autoEmblemAttrs">
              <div class="row attr-row1">
                <button class="opt-btnetc" data-ele="fire">í™”ì†ì„±</button>
                <button class="opt-btnetc" data-ele="water">ìˆ˜ì†ì„±</button>
                <button class="opt-btnetc" data-ele="light">ëª…ì†ì„±</button>
                <button class="opt-btnetc" data-ele="dark">ì•”ì†ì„±</button>
              </div>
              <div class="row attr-row2">
                <button class="opt-btnetc" data-ele="all">ëª¨ì†</button>
                <button class="opt-btnetc" data-ele="str">í˜</button>
                <button class="opt-btnetc" data-ele="int">ì§€ëŠ¥</button>
              </div>
            </div>
          </div>

          <div class="cols right">
            <div class="titles">ë‹¨ê³„ ì„ íƒ</div>
            <div class="lists tiers" id="autoEmblemTiers"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="autoSealModal" class="modal simple-modal" aria-hidden="true">
      <div class="backdrop" data-close></div>
      <div class="dialogetc" role="dialog" aria-modal="true" aria-labelledby="autoSealTitle">
        <header>
          <h3 id="autoSealTitle">ì¶”ì²œ ë§ˆë²•ë´‰ì¸</h3>
          <button class="close" data-close>âœ•</button>
        </header>
        <div class="cols">
          <div class="titles">ì†ì„± ì„ íƒ</div> <!-- âœ… ì¶”ê°€ -->
          <div class="lists">
            <button class="opt-btnetc" data-ele="fire">í™”ì†ì„±</button>
            <button class="opt-btnetc" data-ele="water">ìˆ˜ì†ì„±</button>
            <button class="opt-btnetc" data-ele="light">ëª…ì†ì„±</button>
            <button class="opt-btnetc" data-ele="dark">ì•”ì†ì„±</button>
          </div>
        </div>
      </div>
    </div>

    <script>

      /* ===== Auto Input: Helpers ===== */

      /* Reflect chosen enhance names on first rect of each slot */
      function refreshEnhLabelsFromState() {
        const map = (window.SLOT_MAP || {});   // â¬… ì•ˆì „í•œ ì°¸ì¡°
        document.querySelectorAll('.slot-row').forEach(row => {
          const slotEl = row.querySelector('.slot');
          const code = slotEl?.getAttribute('data-slot');
          const slotKey = map[code];
          const rects = row.querySelectorAll('.outer-rects .rect');
          if (!slotKey || !rects.length) return;
          const up = state.enh?.[slotKey];
          rects[0].textContent = up?.name || 'ê°•í™” ì„¤ì •';
        });
      }

      // í•„ìš”í•  ë•Œë§ˆë‹¤ REVERSEë¥¼ ê³„ì‚° (SLOT_MAPì´ ì•„ì§ ì—†ì–´ë„ ì•ˆì „)
      function firstEnhButtonFor(slotKey) {
        const map = (window.SLOT_MAP || {});
        const reverse = Object.fromEntries(Object.entries(map).map(([k, v]) => [v, k]));
        const code = reverse[slotKey];
        if (!code) return null;

        const row = document
          .querySelector(`.slot-row .slot[data-slot="${code}"]`)
          ?.closest('.slot-row');
        if (!row) return null;
        return row.querySelector('.outer-rects .rect');
      }

      function findEnhByExactGang(list, lvl) {
        const L = String(Number(lvl));
        if (!Array.isArray(list)) return null;
        for (const o of list) {
          const raw = String(o?.name ?? '');
          const s = raw.replace(/\s+/g, '');             // ê³µë°± ì œê±°

          // ì•ì— '+' ê¸ˆì§€ (ì „ê° í”ŒëŸ¬ìŠ¤ í¬í•¨)
          const rxPlus = new RegExp(`[+ï¼‹]${L}ê°•`);
          if (rxPlus.test(s)) continue;

          // ì •í™•íˆ "<ìˆ«ì>ê°•" í¬í•¨ (ë’¤ì— 'í™”' ì˜¤ë©´ ì œì™¸: 'ê°•í™”' ë°©ì§€, ì•ì€ ìˆ«ì ê¸ˆì§€)
          const rxExact = new RegExp(`(^|\\D)${L}ê°•(?!í™”)`);
          if (!rxExact.test(s)) continue;

          return o;
        }
        return null;
      }



      function matchEnhByLevelName(list, level) {
        const want = Number(level);
        const pattern1 = new RegExp(String.raw`(?:^|[^\d])${want}\s*ê°•`);
        const pattern2 = new RegExp(String.raw`\+\s*${want}(?:[^\d]|$)`);
        const pattern3 = new RegExp(String.raw`(?:^|[^\d])${want}(?:[^\d]|$)`);
        let best = null;
        for (const o of list) {
          const name = (o.name || '').trim();
          if (pattern1.test(name) || pattern2.test(name)) return o;
          if (!best && pattern3.test(name)) best = o;
        }
        return best || list.find(o => String(o.name || '').includes(String(want))) || null;
      }


      let __autoEnhTxn = 0; // ë ˆì´ìŠ¤ ë°©ì§€

      async function autoEnhanceApply(level) {
        const tx = ++__autoEnhTxn;

        // 1) ê°•í™” ë¦¬ìŠ¤íŠ¸ ì¤€ë¹„
        await ensureEnhLoaded();
        const byType = (window.DBEnh && window.DBEnh.byType) || {};

        // 2) ëª¨ë“  ìŠ¬ë¡¯ ê¸°ì¤€ìœ¼ë¡œ ëŒë¦¬ê¸° (ì„ íƒ ì—¬ë¶€ ë¬´ì‹œ)
        //    SLOT_MAP: { L1:'headshoulder', ..., R1:'weapon', ... }
        const slotMap = window.SLOT_MAP || {};
        const allSlotKeys = Array.from(new Set(Object.values(slotMap)));

        state.enh ||= {};

        for (const slotKey of allSlotKeys) {
          // ìŠ¬ë¡¯ â†’ ê°•í™” ì¢…ë¥˜ ë§¤í•‘ (ë¬´ê¸°ê°•í™”/ë°©ì–´êµ¬ê°•í™”/ì•…ì„¸ê°•í™”/ë³´ì¥ê°•í™”)
          const type = enhTypeForSlot(slotKey);
          if (!type) continue; // ì˜¤ë¼/ì¹­í˜¸/í¬ë¦¬ì³/ì•„í‹°íŒ©íŠ¸ ë“±ì€ ìŠ¤í‚µ

          const rawList = byType[type];
          const list = Array.isArray(rawList) ? rawList : [];
          if (!list.length) continue;

          // 3) level ì— ë§ëŠ” ê°•í™” ì˜µì…˜ ì°¾ê¸°
          let opt = findEnhByExactGang(list, level);
          if (!opt) opt = matchEnhByLevelName(list, level);
          if (!opt) {
            console.warn('[autoEnhanceApply] í›„ë³´ ì—†ìŒ', { slotKey, type, level });
            continue;
          }

          // ì¤‘ê°„ì— ë” ìµœì‹  autoEnh ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì¤‘ë‹¨
          if (tx !== __autoEnhTxn) return;

          // 4) calc_all ì—ì„œ ì“¸ ê°•í™” ìŠ¤ëƒ…ìƒ· ì €ì¥
          state.enh[slotKey] = {
            name: opt.name,
            type: opt.type || type,            // ì‹œíŠ¸ì˜ 'ì¢…ë¥˜' ì»¬ëŸ¼ê³¼ ë§¤ì¹­
            levelVal: opt.levelVal ?? String(level),
            level: opt.level_num ?? Number(level),
            raw: opt.raw ?? null,
          };

          // 5) ìŠ¬ë¡¯ ì²« ë²ˆì§¸ ê°•í™” ë²„íŠ¼ ë¼ë²¨ ì—…ë°ì´íŠ¸
          const btn = firstEnhButtonFor(slotKey);
          if (btn) btn.textContent = opt.name;
        }

        //alert(`${level}ê°• ìë™ê°•í™”ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. (calc_all ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤)`);
      }





      /* ===== Auto Emblem Apply: stage 5~15 ===== */
      /* ===== [EMBLEM][AUTO] ìƒíƒœ & ë Œë” ===== */
      const autoEmblemState = { attr: null, stage: null };

      function renderAutoEmblemChoices() {
        const modal = document.getElementById('autoEmblemModal');
        const $attrs = modal?.querySelector('#autoEmblemAttrs');
        const $tiers = modal?.querySelector('#autoEmblemTiers');
        if (!$attrs || !$tiers) return;

        // ì†ì„± ë²„íŠ¼ (í™”/ìˆ˜/ëª…/ì•”)
        $attrs.querySelectorAll('button').forEach(btn => {
          const k = btn.getAttribute('data-ele'); // 'fire'|'water'|'light'|'dark'
          btn.classList.toggle('active', autoEmblemState.attr === k);
          btn.onclick = () => {
            autoEmblemState.attr = k;
            renderAutoEmblemChoices();
            tryApplyAutoEmblemIfReady();
          };
        });

        // ë‹¨ê³„ ë²„íŠ¼ (5~15) â†’ 2ì¤„(1ì¤„: 5~10, 2ì¤„: 11~15)
        $tiers.innerHTML = '';

        const makeRow = (from, to, cls) => {
          const row = document.createElement('div');
          row.className = `row ${cls}`;
          for (let lv = from; lv <= to; lv++) {
            const b = document.createElement('button');
            b.className = 'opt-btnetc';
            b.textContent = `${lv}ë‹¨ê³„`;
            if (autoEmblemState.stage === lv) b.classList.add('active');
            b.onclick = () => {
              autoEmblemState.stage = lv;
              renderAutoEmblemChoices();
              tryApplyAutoEmblemIfReady();
            };
            row.appendChild(b);
          }
          return row;
        };

        $tiers.appendChild(makeRow(5, 8, 'tier-row1'));
        $tiers.appendChild(makeRow(9, 12, 'tier-row2'));
        $tiers.appendChild(makeRow(13, 15, 'tier-row3'));

      }

      function closeAutoEmblemModal() {
        const modal = document.getElementById('autoEmblemModal');
        if (!modal) return;
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
      }

      async function tryApplyAutoEmblemIfReady() {
        const { attr, stage } = autoEmblemState;
        if (!attr || !stage) return;
        await autoEmblemApply(attr, stage);
        closeAutoEmblemModal();
      }

      /* ì†ì„± â†’ í”Œë˜í‹°ë„˜ ì— ë¸”ë ˜ ë§¤ì¹­ */
      function pickPlatForAttr(attrKey, stageNum) {
        const arr = DBEnh.byType['í”Œë˜í‹°ë„˜ì— ë¸”ë ˜'] || [];
        // 1ï¸âƒ£ ì†ì„± í‚¤ ì •ê·œí™”
        const normMap = {
          'fire': 'í™”',
          'water': 'ìˆ˜',
          'light': 'ëª…',
          'dark': 'ì•”',
          'all': 'ëª¨ì†',
          'str': 'í˜',
          'int': 'ì§€ëŠ¥'
        };
        const normAttr = normMap[attrKey] || attrKey;
        // 2ï¸âƒ£ í•„í„°ë§
        const match = arr.find(r =>
          String(r.levelVal ?? '').trim() === normAttr &&
          Number(r.level_num ?? 0) === Number(stageNum)
        );
        return match || null; // fallback ì œê±°
      }

      /* ===== Auto Emblem Apply (attr(ì†ì„±) + stage(ë‹¨ê³„)) ===== */
      /** ìë™ ì— ë¸”ë ˜ ì¼ê´„ ì ìš© (ì„œë²„ í˜¸ì¶œ X, í”„ë¡ íŠ¸ state/UIë§Œ ê°±ì‹ ) */
      async function autoEmblemApply(attrKey, stage) {
        await ensureEnhLoaded();

        const stageNum = Number(stage) || 0;

        // ì¼ë°˜ ì— ë¸”ë ˜ ëŒ€ìƒ ìŠ¬ë¡¯ë“¤
        const slots = [
          'headshoulder', 'top', 'bottom', 'belt', 'shoes',
          'bracelet', 'necklace', 'ring', 'weapon', 'earring', 'magestone'
        ];

        const uiUpdates = []; // { slot, sock, pickedObj } ë°°ì—´

        // ğŸ”¹ ì¼ë°˜ ì— ë¸”ë ˜ë“¤
        for (const sk of slots) {
          ensureEmblemArray(sk);

          const types = SOCKET_RULES[sk] || [];
          let useTypes = types.slice();
          // ë¬´ê¸°ëŠ” ë¶‰ì€ë¹›ë§Œ ì‚¬ìš©
          if (sk === 'weapon') useTypes = ['ë¶‰ì€ë¹›ì— ë¸”ë ˜'];

          const picks = [];
          useTypes.forEach(t => {
            const arr = (DBEnh?.byType?.[t] || []).filter(
              it => Number(it.level_num) === stageNum
            );
            if (arr.length) picks.push(arr[0]);
          });
          if (!picks.length) continue;

          const count = SOCKET_COUNT(sk);
          for (let i = 0; i < count; i++) {
            const pick = picks[i] || picks[0];
            const pickedObj = {
              img: pick.img || pick.image || pick['ì´ë¯¸ì§€'] || '',
              tag: pick.levelVal || pick['ë ™ì œ'] || '',
              name: pick.name || pick.ì´ë¦„ || '',
              level_num: pick.level_num ?? stageNum,
              levelVal: pick.levelVal,
              type: pick.type
            };
            uiUpdates.push({ slot: sk, sock: i, pickedObj });
          }
        }

        // ğŸ”¹ í”Œë˜í‹°ë„˜ ì— ë¸”ë ˜ (ì†ì„± + ë‹¨ê³„ ê¸°ì¤€)
        let plat = null;
        if (typeof pickPlatForAttr === 'function') {
          plat = pickPlatForAttr(attrKey, stageNum);
        }
        if (plat) {
          const platSlots = ['sub', 'title', 'earring', 'magestone'];
          for (const slot of platSlots) {
            const count = SOCKET_COUNT(slot); // ë³´í†µ 1ê°œì”©
            for (let i = 0; i < count; i++) {
              const pickedObj = {
                img: plat.img || plat.image || plat['ì´ë¯¸ì§€'] || '',
                tag: plat.levelVal || plat['ë ™ì œ'] || '',
                name: plat.name || plat.ì´ë¦„ || '',
                level_num: plat.level_num ?? stageNum,
                levelVal: plat.levelVal,
                type: plat.type
              };
              uiUpdates.push({ slot, sock: i, pickedObj });
            }
          }
        }

        // ğŸ”¹ í”„ë¡ íŠ¸ state + ë„íŠ¸ UIì— í•œ ë²ˆì— ë°˜ì˜
        window.state = window.state || {};
        state.emblems = state.emblems || {};

        for (const u of uiUpdates) {
          ensureEmblemArray(u.slot);
          state.emblems[u.slot][u.sock] = u.pickedObj;
          paintEmblemDot(u.slot, u.sock);
        }

        closeAutoEmblemModal();
      }

      const AUTO_ATTRS = ['í™”ì†ì„±', 'ìˆ˜ì†ì„±', 'ëª…ì†ì„±', 'ì•”ì†ì„±'];
      const AUTO_TIERS = ['ì¢…ê²°', 'ì¤€ì¢…ê²°', 'ë³´í†µ', 'ê°€ì„±ë¹„'];
      const autoEnchantState = { attr: null, tier: null };

      // DBEnh/ENCHANT_CACHE ì–´ëŠ ìª½ì´ë“  ì•ˆì „íˆ êº¼ë‚´ê¸°
      function getEnhListByType(typeKey) {
        const t = String(typeKey || '').trim();
        if (!t) return [];
        // ìš°ì„  DBEnh.byType ì‚¬ìš©
        const viaDB = (window.DBEnh && window.DBEnh.byType && window.DBEnh.byType[t]) || null;
        if (Array.isArray(viaDB)) return viaDB;
        // (í˜¹ì‹œ êµ¬ë²„ì „ ìºì‹œê°€ ìˆì„ ë•Œ)
        if (window.ENCHANT_CACHE && ENCHANT_CACHE.byType && ENCHANT_CACHE.byType.get) {
          return ENCHANT_CACHE.byType.get(t) || [];
        }
        return [];
      }
      // ì „ì—­ ìƒíƒœ ì˜ˆì‹œ:
      // const autoEnchantState = { attr: null, tier: null };

      function renderAutoEnchantChoices() {
        const m = document.getElementById('autoEnchantModal');
        const wrapAttrs = m.querySelector('.lists.attrs');
        const wrapTiers = m.querySelector('.lists.tiers');
        wrapAttrs.innerHTML = '';
        wrapTiers.innerHTML = '';

        const makeBtn = (txt, group) => {
          const b = document.createElement('button');
          b.className = 'opt-btnetc';
          b.type = 'button';
          b.textContent = txt;
          b.setAttribute('role', 'button');
          b.setAttribute('aria-pressed', 'false');

          // ë‚´ë¶€ ê°’: attrëŠ” ê·¸ëŒ€ë¡œ, tierëŠ” 'ì¤€ì¢…ê²°' ë²„íŠ¼ë§Œ 'ì¤€ê²°'ë¡œ ë“¤ê³ ë‹¤ë‹˜
          let internalVal = txt;
          if (group === 'tier' && txt.trim() === 'ì¤€ì¢…ê²°') {
            internalVal = 'ì¤€ê²°';
          }

          // í‹°ì–´ ë²„íŠ¼ì€ data-valueì— ë‚´ë¶€ê°’ ì €ì¥ (í•˜ì´ë¼ì´íŠ¸ìš©)
          if (group === 'tier') {
            b.dataset.value = internalVal;
          }

          b.addEventListener('click', () => {
            if (group === 'attr') {
              autoEnchantState.attr = txt;          // ì†ì„±ì€ ê·¸ëŒ€ë¡œ
            } else {
              autoEnchantState.tier = internalVal;  // í‹°ì–´ëŠ” 'ì¤€ê²°' ê°™ì€ ë‚´ë¶€ê°’
            }
            updateAutoActive();
            tryApplyAutoIfReady(); // ë‘ ê°’ì´ ì„ íƒë˜ë©´ ë°”ë¡œ ì ìš© í›„ ëª¨ë‹¬ ë‹«ê¸°
          });
          return b;
        };

        ['í™”ì†ì„±', 'ìˆ˜ì†ì„±', 'ëª…ì†ì„±', 'ì•”ì†ì„±'].forEach(a => wrapAttrs.appendChild(makeBtn(a, 'attr')));
        ['ì¢…ê²°', 'ì¤€ì¢…ê²°', 'ë³´í†µ', 'ê°€ì„±ë¹„'].forEach(t => wrapTiers.appendChild(makeBtn(t, 'tier')));


        updateAutoActive();
      }
      // === [ENCHANT][AUTO] ì§ì—…êµ° í…ìŠ¤íŠ¸ ì–»ê¸°
      function getJobGroupText(opt) {
        if (!opt) return '';
        if (opt.jobGroup) return String(opt.jobGroup).trim();
        const raw = opt.raw || {};
        return String(raw['ì§ì—…êµ°'] ?? raw.jobGroup ?? raw['ë¶„ë¥˜'] ?? '').trim();
      }

      // ì§ì—…êµ°/ì´ë¦„ ë§¤ì¹­ìš©
      function _N(v) { return String(v ?? '').replace(/\s+|-/g, '').replace(/[()]/g, '').trim(); }

      // typeKey(ì˜ˆ: 'ë¬´ê¸°ë§ˆë¶€')ì—ì„œ 'ì§ì—…êµ°' í¬í•¨ í‚¤ì›Œë“œë¡œ 1ê°œ ì°¾ê¸°
      // === [ENCHANT][AUTO] ì§ì—…êµ°ìœ¼ë¡œ ì˜µì…˜ ì°¾ê¸°  (â˜…êµì²´)
      function findEnchantByJobGroup(typeKey, keyword) {
        const list = ENCHANT_CACHE.byType.get(String(typeKey).trim()) || [];
        const kw = String(keyword || '').trim();
        if (!kw) return null;

        // ê³µë°±/í•˜ì´í”ˆ/ê´„í˜¸ ì œê±° ì •ê·œí™”
        const N = (v) => String(v ?? '').replace(/\s+|-/g, '').replace(/[()]/g, '').trim();

        const kwN = N(kw);

        // 1ìˆœìœ„: ì§ì—…êµ° í¬í•¨(ì •ê·œí™” ë¹„êµ)
        let hit = list.find(o => N(getJobGroupText(o)).includes(kwN));
        if (hit) return hit;

        // 2ìˆœìœ„(í´ë°±): ì´ë¦„ í¬í•¨(ì •ê·œí™” ë¹„êµ)
        hit = list.find(o => N(String(o.name || '')).includes(kwN));
        return hit || null;
      }

      function normalizeTier(t) {
        const s = String(t || '').replace(/\s+/g, '');
        if (!s) return 'ì¢…ê²°';

        // 'ì¤€ê²°', 'ì¤€ì¢…ê²°', 'ì¤€ ê²°' ë“±ì€ ì „ë¶€ 'ì¤€ê²°'ë¡œ í†µì¼
        if (s.includes('ì¤€ê²°') || s.includes('ì¤€ì¢…ê²°') || s === 'ì¤€') return 'ì¤€ê²°';
        if (s.includes('ì¢…ê²°')) return 'ì¢…ê²°';
        if (s.includes('ë³´í†µ')) return 'ë³´í†µ';
        if (s.includes('ê°€ì„±ë¹„')) return 'ê°€ì„±ë¹„';
        return s;
      }

      function updateAutoActive() {
        const modal = document.getElementById('autoEnchantModal');
        const mark = (selector, pickedValue) => {
          modal.querySelectorAll(selector).forEach(btn => {
            let val = btn.textContent.trim();

            // í‹°ì–´ ë²„íŠ¼ì´ë©´ data-value ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ (ì˜ˆ: ë¼ë²¨ 'ì¤€ì¢…ê²°' â†” ê°’ 'ì¤€ê²°')
            if (btn.closest('.lists.tiers')) {
              val = btn.dataset.value || val;
            }

            const on = (val === (pickedValue || ''));
            btn.classList.toggle('active', on);
            btn.setAttribute('aria-pressed', on ? 'true' : 'false');
          });
        };
        mark('.lists.attrs .opt-btnetc', autoEnchantState.attr);
        mark('.lists.tiers .opt-btnetc', autoEnchantState.tier);
      }



      // ë§¨ ìœ„ í¸í•œ ê³³ì— ì¶”ê°€
      const $autoEnchantModal = document.getElementById('autoEnchantModal');

      // ===== [ENCHANT][AUTO] ì¶”ì²œ ë§ˆë²•ë¶€ì—¬ ìë™ ì…ë ¥ (ì„œë²„ í˜¸ì¶œ ì—†ìŒ) =====
      async function applyAutoEnchant(attrPicked, tierPicked) {
        // 0) ìºì‹œ ë¡œë“œ ë³´ì¥ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
        if (typeof ensureEnchantCache === 'function') {
          await ensureEnchantCache();
        }

        // 1) ì…ë ¥ ì •ê·œí™”
        const normalizeTier = (t) => {
          const s = String(t || '').replace(/\s+/g, '');
          if (!s) return 'ì¢…ê²°';

          if (s.includes('ì¤€ê²°') || s.includes('ì¤€ì¢…ê²°') || s === 'ì¤€') return 'ì¤€ê²°';
          if (s.includes('ì¢…ê²°')) return 'ì¢…ê²°';
          if (s.includes('ë³´í†µ')) return 'ë³´í†µ';
          if (s.includes('ê°€ì„±ë¹„')) return 'ê°€ì„±ë¹„';
          return s;
        };
        const normalizeAttr = (a) => {
          const s = String(a || '').replace(/\s+/g, '');
          if (!s) return null;
          // ë²„íŠ¼ ì˜ë¬¸ data-ele ê¸°ì¤€ìœ¼ë¡œ ë§ì¶°ì¤„ í•„ìš” ìˆìœ¼ë©´ ì—¬ê¸°ì„œ ì¡°ì •
          return s;
        };

        const tier = normalizeTier(tierPicked);
        const attr = normalizeAttr(attrPicked);

        // 2) ëŒ€ìƒ ìŠ¬ë¡¯ ëª©ë¡ (ê¸°ì¡´ targets ìœ ì§€)
        const targets = [
          { code: 'R1', needAttr: true }, // ë¬´ê¸°
          { code: 'L1', needAttr: false }, // ë¨¸ë¦¬ì–´ê¹¨
          { code: 'L2', needAttr: false }, // ìƒì˜
          { code: 'L3', needAttr: false }, // í•˜ì˜
          { code: 'L4', needAttr: false }, // í—ˆë¦¬
          { code: 'L5', needAttr: false }, // ì‹ ë°œ
          { code: 'R2', needAttr: true }, // íŒ”ì°Œ (ì†ì„± ë”°ë¼ê°€ëŠ” ìë™ë§ˆë¶€ë¼ë©´ true)
          { code: 'R3', needAttr: true }, // ëª©ê±¸ì´
          { code: 'R4', needAttr: true }, // ë°˜ì§€
          { code: 'L6', needAttr: false }, // ê·€ê±¸ì´
          { code: 'R5', needAttr: false }, // ë³´ì¡°ì¥ë¹„
          { code: 'R6', needAttr: false }, // ë§ˆë²•ì„ 
          { code: 'C2', needAttr: false }
        ];

        // 3) í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ ê°±ì‹ 
        window.state = window.state || {};
        state.enchants ||= {};

        for (const { code, needAttr } of targets) {
          const typeKey = enchantTypeForSlot(code);          // 'ë¬´ê¸°ë§ˆë¶€', 'ë¨¸ë¦¬ì–´ê¹¨ë§ˆë¶€' ...
          const serverSlot = slotCodeToServerSlot(code);     // 'weapon', 'headshoulder' ...
          if (!typeKey || !serverSlot) continue;

          // í‚¤ì›Œë“œ êµ¬ì„±
          let pick = null;
          if (needAttr) {
            const attrFull = attr || '';                        // 'í™”ì†ì„±'
            const attrShort = attrFull.replace('ì†ì„±', '');      // 'í™”'

            // tier: ì •ê·œí™”ëœ í’€ë„¤ì„ ('ì¢…ê²°', 'ì¤€ì¢…ê²°', 'ë³´í†µ', 'ê°€ì„±ë¹„' ...)
            const tierFull = tier;
            const tierShort = (tier === 'ì¤€ì¢…ê²°') ? 'ì¤€ê²°' : tierFull;

            const keywords = [
              attrFull + tierFull,   // ì˜ˆ: 'í™”ì†ì„±ì¤€ì¢…ê²°'
              attrShort + tierFull,   // ì˜ˆ: 'í™”ì¤€ì¢…ê²°'
              attrFull + tierShort,  // ì˜ˆ: 'í™”ì†ì„±ì¤€ê²°'
              attrShort + tierShort,  // ì˜ˆ: 'í™”ì¤€ê²°'   â˜… ì´ê±° í¬í•¨
            ];

            for (const kw of keywords) {
              if (!kw) continue;
              pick = findEnchantByJobGroup(typeKey, kw);
              if (pick) break;
            }
          } else {
            pick = findEnchantByJobGroup(typeKey, tier);
          }
          if (!pick) continue;

          // 3-1) UI ë¼ë²¨ ì¦‰ì‹œ ê°±ì‹ 
          if (typeof updateEnchantLabel === 'function') {
            updateEnchantLabel(code, pick.name);
          }

          // 3-2) ë¡œì»¬ ìƒíƒœ ê°±ì‹  (â˜… calc_allì—ì„œ ì“¸ ê°’)
          state.enchants[serverSlot] = {
            name: pick.name,
            typeKey,
            stats: pick.stats || null,
            raw: pick.raw || null,
          };
        }

        // 4) ì—¬ê¸°ì„œëŠ” ì„œë²„ í˜¸ì¶œ ì—†ìŒ (enchant_bulk_select ì œê±°)
        //    ì‹¤ì œ ìŠ¤íƒ¯ ë°˜ì˜/í•©ì‚°ì€ calc_all + computeViaBackend ì—ì„œë§Œ ìˆ˜í–‰
      }


      function tryApplyAutoIfReady() {
        if (autoEnchantState.attr !== null && autoEnchantState.tier !== null) {
          applyAutoEnchant(autoEnchantState.attr, autoEnchantState.tier);
          autoEnchantState.attr = null;
          autoEnchantState.tier = null;
          showModal(document.getElementById('autoEnchantModal'), false);
        }
      }





      /* ===== Bind Auto Panels ===== */
      document.addEventListener('DOMContentLoaded', () => {
        const autoEnhModal = document.getElementById('autoEnhModal');
        const autoEnhList = document.getElementById('autoEnhList');
        const autoEmblemModal = document.getElementById('autoEmblemModal');
        const autoEmblemList = document.getElementById('autoEmblemList');
        const autoEnchantModal = document.getElementById('autoEnchantModal');
        // â–¼ ì¶”ì²œ ë§ˆë²•ë´‰ì¸ ìë™ ì…ë ¥ ë²„íŠ¼ í™œì„±í™” + ëª¨ë‹¬ ì˜¤í”ˆ
        const btnAutoSeal = document.getElementById('btnAutoSeal');
        if (btnAutoSeal) {
          // í˜¹ì‹œ ë‚¨ì•„ìˆì„ì§€ ëª¨ë¥´ëŠ” ì†ì„± ì •ë¦¬(ì´ì¤‘ì•ˆì „)
          btnAutoSeal.disabled = false;
          btnAutoSeal.removeAttribute('title');

          btnAutoSeal.addEventListener('click', () => {
            const modal = document.getElementById('autoSealModal');
            if (modal) {
              modal.classList.add('show');
              modal.setAttribute('aria-hidden', 'false');
            }
          });
        }

        // â–¼ ì¶”ì²œ ë§ˆë²•ë´‰ì¸ ëª¨ë‹¬ ë‹«ê¸° ë° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬(ì„ íƒ ì‹œ ë‹«ê¸°)
        const autoSealModal = document.getElementById('autoSealModal');
        if (autoSealModal) {
          autoSealModal.addEventListener('click', (e) => {
            if (
              e.target.hasAttribute('data-close') ||
              e.target.classList.contains('backdrop')
            ) {
              autoSealModal.classList.remove('show');
              autoSealModal.setAttribute('aria-hidden', 'true');
            }
          });

          // 4ê°œ ì†ì„± ë²„íŠ¼(í™”/ìˆ˜/ëª…/ì•”) í´ë¦­ ì‹œ ë™ì‘(í˜„ì¬ëŠ” ëª¨ë‹¬ë§Œ ë‹«ê¸°)
          autoSealModal.querySelectorAll('.opt-btnetc').forEach(btn => {
            btn.addEventListener('click', () => {
              // TODO: ì—¬ê¸°ì„œ ì„ íƒí•œ ì†ì„±ì— ë§ì¶° 'ì¶”ì²œ ë§ˆë²•ë´‰ì¸ ìë™ ì…ë ¥' ë¡œì§ì„ ì´ì–´ê°€ë©´ ë©ë‹ˆë‹¤.
              // const element = btn.dataset.ele; // "fire" | "water" | "light" | "dark"

              autoSealModal.classList.remove('show');
              autoSealModal.setAttribute('aria-hidden', 'true');
            });
          });
        }

        // Build level buttons 12~20
        if (autoEnhList) {
          autoEnhList.innerHTML = '';
          for (let lv = 12; lv <= 20; lv++) {
            const b = document.createElement('button');
            b.className = 'opt-btnetc';
            b.textContent = `${lv}ê°•`;
            b.addEventListener('click', async () => {
              b.disabled = true;
              try {
                await autoEnhanceApply(lv);
              } finally {
                b.disabled = false;
              }
              autoEnhModal.classList.remove('show');
              autoEnhModal.setAttribute('aria-hidden', 'true');
            });
            autoEnhList.appendChild(b);
          }
        }

        // Openers
        document.getElementById('btnAutoEnh')?.addEventListener('click', () => {
          autoEnhModal.classList.add('show'); autoEnhModal.setAttribute('aria-hidden', 'false');
        });
        document.getElementById('btnAutoEmblem')?.addEventListener('click', () => {
          const modal = document.getElementById('autoEmblemModal');
          autoEmblemState.attr = null;
          autoEmblemState.stage = null;
          renderAutoEmblemChoices();
          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
        });
        document.getElementById('btnAutoEnchant')?.addEventListener('click', () => {
          // ëª¨ë‹¬ ì—´ê¸°ë§Œ; ë‹«ê¸°ëŠ” tryApplyAutoIfReadyì—ì„œ ë‘ ê°’ì´ ëª¨ë‘ ì„ íƒëì„ ë•Œë§Œ
          autoEnchantState.attr = null;
          autoEnchantState.tier = null;
          renderAutoEnchantChoices();
          showModal(document.getElementById('autoEnchantModal'), true);
        });
        // Modal close bindings
        document.querySelectorAll('#autoEnhModal, #autoEmblemModal, #autoEnchantModal').forEach(modal => {
          modal.addEventListener('click', (e) => {
            if (e.target.hasAttribute('data-close') || e.target.classList.contains('close') || e.target.classList.contains('backdrop')) {
              modal.classList.remove('show'); modal.setAttribute('aria-hidden', 'true');
            }
          });
        });
        /* ===== [SEAL][AUTO] ì¶”ì²œ ë§ˆë²•ë´‰ì¸ ìë™ ì…ë ¥ ===== */

        // ìŠ¬ë¡¯ì½”ë“œ â†’ "ë§ˆë²•ë¶€ì—¬ ì¢…ë¥˜í‚¤"ì™€ ë³„ê°œë¡œ, ë´‰ì¸ìš© "ì¢…ë¥˜" ë§¤í•‘
        // - ë¬´ê¸°ë¶€ìœ„: ë¬´ê¸°ê³ ìœ  / ë¬´ê¸°ì¼ë°˜
        // - ë°©ì–´ë¶€ìœ„(L1~L5): ë°©ì–´ê³ ìœ  / ë°©ì–´ì¼ë°˜
        // - ë³´ì¡°ì¥ë¹„(R5): ë³´ì¥ê³ ìœ  / ë³´ì¥ì¼ë°˜
        // - ì•¡ì„¸ì„œë¦¬(R2~R4): ì•…ì„¸ê³ ìœ  / ì•…ì„¸ì¼ë°˜  (â† ì†ì„±ìœ¼ë¡œ ì°¾ê¸°)
        function sealTypeForSlot(slotCode) {
          switch (String(slotCode).toUpperCase()) {
            case 'R1': return { unique: 'ë¬´ê¸°ê³ ìœ ', general: 'ë¬´ê¸°ì¼ë°˜' };
            case 'R6':
            case 'L6':
            case 'R5': return { unique: 'ë³´ì¥ê³ ìœ ', general: 'ë³´ì¥ì¼ë°˜' };
            case 'R2':
            case 'R3':
            case 'R4': return { unique: 'ì•…ì„¸ê³ ìœ ', general: 'ì•…ì„¸ì¼ë°˜' };
            default: return { unique: 'ë°©ì–´ê³ ìœ ', general: 'ë°©ì–´ì¼ë°˜' }; // L1~L5
          }
        }

        // í˜„ì¬ ì„ íƒ ìºë¦­í„°ì˜ ê³µê²© ë¶„ë¥˜ë¥¼ 'ë¬¼ë¦¬' / 'ë§ˆë²•'ë¡œ ë³€í™˜
        function jobGroupKeyFromState() {
          const p = String(state?.currentCharacter?.power ?? '').trim();
          // ë‹¤ì–‘í•œ í‘œê¸° í—ˆìš©
          if (p === 'mag' || p === 'ë§ˆë²•' || p === 'magic') return 'ë§ˆë²•';
          if (p === 'phys' || p === 'ë¬¼ë¦¬' || p === 'physical') return 'ë¬¼ë¦¬';

          // ì—¬ë¶„ ì•ˆì „ì¥ì¹˜: baseì— 'ë¬¼ë§ˆê³µ'ì´ ìˆë‹¤ë©´ ê±°ê¸°ì„œë„ ì‹œë„
          const basePM = String(state?.currentCharacter?.base?.['ë¬¼ë§ˆê³µ'] ?? '').trim();
          if (basePM === 'ë§ˆë²•') return 'ë§ˆë²•';
          if (basePM === 'ë¬¼ë¦¬') return 'ë¬¼ë¦¬';

          // ë§ˆì§€ë§‰ ê¸°ë³¸ê°’
          return 'ë¬¼ë¦¬';
        }

        // ì§ì—…êµ° ë¬¸ìì—´ì—ì„œ ë¬¼ë¦¬/ë§ˆë²• í¬í•¨ ì—¬ë¶€ ì¶”ì¶œ
        function parseJobFlags(s) {
          const t = String(s ?? '').toLowerCase().replace(/\s+/g, '');
          const phys = /(ë¬¼ë¦¬|ë¬¼ê³µ)/.test(t);
          const magic = /(ë§ˆë²•|ë§ˆê³µ)/.test(t);
          const both = phys && magic;                       // "ë¬¼ë¦¬ë§ˆë²•", "ë¬¼ë¦¬ ë§ˆë²•" ë“±
          const common = /ê³µìš©|ëª¨ë‘|all/.test(t);            // ê³µìš© í‘œê¸°
          return { phys, magic, both, common };
        }
        // ì‹œíŠ¸ì˜ ì†ì„± í•œê¸€ í‚¤ ë§¤í•‘
        const ELEM_KOR = { fire: 'í™”', water: 'ìˆ˜', light: 'ëª…', dark: 'ì•”' };

        // byType ìºì‹œì—ì„œ ì¡°ê±´(ì§ì—…êµ°/ì†ì„±)ì— ë§ëŠ” "ì²« ë²ˆì§¸" ë´‰ì¸ ì˜µì…˜ì„ ì°¾ì•„ ë°˜í™˜
        function findSealOption(typeKey, { jobKey, elemKor }) {
          const key = String(typeKey).trim();

          // ëª©ë¡ í™•ë³´(byType ìš°ì„ , ì—†ìœ¼ë©´ listì—ì„œ typeìœ¼ë¡œ í•„í„°)
          let list = (DBEnh?.byType?.[key] || []).slice();
          if (!list.length && Array.isArray(DBEnh?.list)) {
            list = DBEnh.list.filter(o => String(o?.type || '').trim() === key);
          }

          const isAcc = key.startsWith('ì•…ì„¸');
          if (isAcc) {
            // ì•…ì„¸: ì†ì„± ì •í™• ë§¤ì¹­ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ)
            for (const it of list) {
              const v = (it.raw?.jobGroup ?? it.jobGroup ?? '').trim();
              if (v === elemKor) return it;
            }
            return null;
          }

          // ë¹„ì•…ì„¸(ë¬´ê¸°/ë°©ì–´/ë³´ì¥): "í¬í•¨ ë§¤ì¹­" ê·œì¹™
          const wantPhys = jobKey === 'ë¬¼ë¦¬';
          const wantMagic = jobKey === 'ë§ˆë²•';

          // 1) ìš°ì„ : í•´ë‹¹ ë‹¨ì–´ê°€ "í¬í•¨ëœ" í–‰
          for (const it of list) {
            const v = it.raw?.jobGroup ?? it.jobGroup ?? '';
            const f = parseJobFlags(v);
            if (wantPhys && (f.phys || f.both)) return it;   // "ë¬¼ë¦¬" í¬í•¨ ë˜ëŠ” "ë¬¼ë¦¬ ë§ˆë²•" í¬í•¨
            if (wantMagic && (f.magic || f.both)) return it;   // "ë§ˆë²•" í¬í•¨ ë˜ëŠ” "ë¬¼ë¦¬ ë§ˆë²•" í¬í•¨
          }

          // 2) ë‹¤ìŒ: ê³µìš©(ëª¨ë‘)ì— í•´ë‹¹í•˜ëŠ” í–‰
          for (const it of list) {
            const v = it.raw?.jobGroup ?? it.jobGroup ?? '';
            if (parseJobFlags(v).common) return it;
          }

          // 3) ë§ˆì§€ë§‰: ì§ì—…êµ° ë¯¸í‘œê¸°(ë¹ˆì¹¸)ì¸ í–‰ì„ ëŒ€ì²´ë¡œ í—ˆìš©
          for (const it of list) {
            const v = (it.raw?.jobGroup ?? it.jobGroup ?? '').trim();
            if (!v) return it;
          }

          return null;
        }


        // ë„ìš°ë¯¸: rawì—ì„œ ìµœì†Œí•œì˜ ìŠ¤íƒ¯ì„ ë½‘ì•„ë‚´ëŠ” ë³´ì¡° (ì‹œíŠ¸ì— statsê°€ ì—†ì„ ë•Œ ëŒ€ë¹„)
        function statsFrom(opt) {
          if (!opt) return null;
          // ENCHANT_CACHE í”„ë¦¬ë¡œë“œì—ì„œ ì´ë¯¸ obj.statsë¥¼ ì‚´ë ¤ë‘ . ì—†ìœ¼ë©´ rawì—ì„œ í•„ìš”í•œ í‚¤ë§Œ ìµœì†Œ ì¶”ì¶œ
          return opt.stats || null; // í•„ìš”ì‹œ raw ê¸°ë°˜ íŒŒì‹± ì¶”ê°€
        }

        // ì‹¤ì œ ì ìš©: ì†ì„± í´ë¦­ ì‹œ ì „ ìŠ¬ë¡¯ì— ë§ëŠ” ê³ ìœ /ì¼ë°˜ì„ ì°¾ì•„ state.sealsì— ì €ì¥ + ìº¡ì…˜ ê°±ì‹ 
        // ===== [SEAL][AUTO] ì¶”ì²œ ë§ˆë²•ë´‰ì¸ ìë™ ì…ë ¥ =====
        async function applyAutoSeal(elementKey) {
          // 0) ë§ˆë´‰ ë°ì´í„° ë¡œë“œ ë³´ì¥
          if (typeof ensureEnhLoaded === 'function') {
            await ensureEnhLoaded();
          }

          const elemKor = (ELEM_KOR && ELEM_KOR[elementKey]) || '';
          const jobKey = (typeof jobGroupKeyFromState === 'function')
            ? jobGroupKeyFromState()   // 'ë¬¼ë¦¬' ë˜ëŠ” 'ë§ˆë²•' ë¬¸ìì—´ ë°˜í™˜
            : 'ë¬¼ë¦¬';

          const targetCodes = ['R1', 'R2', 'R3', 'R4', 'R5', 'R6', 'L1', 'L2', 'L3', 'L4', 'L5', 'L6'];

          // 1) ìŠ¬ë¡¯ë³„ ì¶”ì²œì•ˆ ê³„ì‚° (ì„œë²„ìš© plans ëŒ€ì‹ , ë¡œì»¬ìš© newStateë§Œ ì‚¬ìš©)
          const newState = {};   // í´ë¼ì´ì–¸íŠ¸ state.seals ì— ë³‘í•©í•  ë¶€ë¶„ ìƒíƒœ

          for (const code of targetCodes) {
            const types = sealTypeForSlot(code);   // { unique:'ë¬´ê¸°ê³ ìœ ', general:'ë¬´ê¸°ì¼ë°˜' } ë“±
            if (!types) continue;

            const pickU = findSealOption(types.unique, { jobKey, elemKor });
            const pickG = findSealOption(types.general, { jobKey, elemKor });

            // ë‘˜ ë‹¤ ì •í™•íˆ ë§¤ì¹­ëœ ê²½ìš°ì—ë§Œ ì§„í–‰ (ìŠ¤íƒ¯ 0í™” ë°©ì§€)
            if (!pickU || !pickG) continue;

            const slotKey = (window.SLOT_MAP || {})[code]; // 'weapon','top',...
            if (!slotKey) continue;

            // ìƒíƒœìš© êµ¬ì¡° (refreshSealCaptionsForSlot ì—ì„œ ê¸°ëŒ€í•˜ëŠ” êµ¬ì¡°)
            newState[slotKey] = {
              unique: {
                name: pickU.name,
                typeKey: pickU.type || types.unique,
                stats: pickU.stats || null,
                raw: pickU.raw || null,
              },
              general1: {
                name: pickG.name,
                typeKey: pickG.type || types.general,
                stats: pickG.stats || null,
                raw: pickG.raw || null,
              },
            };
          }

          // ì ìš©í•  ê²Œ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì¢…ë£Œ
          if (!Object.keys(newState).length) {
            console.warn('[applyAutoSeal] ë§¤ì¹­ë˜ëŠ” ë§ˆë´‰ì´ ì—†ì–´ ì ìš©ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
            return;
          }

          // 2) ë¡œì»¬ ìƒíƒœ ì¼ê´„ ë°˜ì˜ + ë¼ë²¨/ìº¡ì…˜ ê°±ì‹ 
          window.state = window.state || {};
          state.seals ||= {};
          Object.assign(state.seals, newState);

          if (typeof refreshSealCaptionsFromState === 'function') {
            refreshSealCaptionsFromState();
          }
          if (typeof refreshSealLabelsFromState === 'function') {
            refreshSealLabelsFromState();
          }

          // 3) ì„œë²„ë¡œëŠ” ì•„ë¬´ê²ƒë„ ë³´ë‚´ì§€ ì•ŠëŠ”ë‹¤.
          //    ì‹¤ì œ ìŠ¤íƒ¯ ë°˜ì˜ì€ calc_all í˜¸ì¶œ ì‹œ payload.seals ë¡œ í•œ ë²ˆì—.

          // 4) í•„ìš”í•˜ë©´ í”„ë¡ íŠ¸ í•©ì‚°(ì˜µì…˜) â€” ì§€ê¸ˆì€ calc_all íë¦„ì— ë§¡ê¸°ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë‘ 
          // if (typeof recalcAndRenderPanel === 'function') {
          //   try { await recalcAndRenderPanel(); } catch (e) {
          //     console.warn('[applyAutoSeal] recalcAndRenderPanel ì‹¤íŒ¨', e);
          //   }
          // }

          // 5) ëª¨ë‹¬ ë‹«ê¸°
          const modal = document.getElementById('autoSealModal');
          if (modal) {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
          }
        }


        // â–¼ ëª¨ë‹¬ì˜ ì†ì„± ë²„íŠ¼ê³¼ ì—°ê²°
        const $autoSealModal = document.getElementById('autoSealModal');
        if ($autoSealModal) {
          $autoSealModal.querySelectorAll('.opt-btnetc[data-ele]').forEach(btn => {
            btn.addEventListener('click', () => {
              const ele = btn.getAttribute('data-ele'); // 'fire' | 'water' | 'light' | 'dark'
              applyAutoSeal(ele);
            });
          });
        }

      });

    </script>
    <script>
      // ===== BuffLeveling: "ë ˆë²¨ë§(N)" í•©ì‚° â†’ì˜ ìŠ¤í‚¬ë ™ì œ=Nì— ì ìš© =====
      // (ê¸°ì¡´ ëª¨ë“ˆ êµ¬ì¡° ìœ ì§€, preload()ë§Œ êµì²´)

      window.BuffLeveling = (() => {
        const cache = { ready: false, rows: [] };

        // ìˆ«ì/í¼ì„¼íŠ¸ íŒŒì„œ â€” ê·¸ëŒ€ë¡œ ìœ ì§€
        const num = v => {
          const n = Number(String(v ?? "").replace(/[, ]/g, ""));
          return Number.isFinite(n) ? n : 0;
        };
        const pct = v => num(v) / 100;

        // ë ˆë²¨0 ê¸°ì¤€ stats â€” ê·¸ëŒ€ë¡œ ìœ ì§€
        function rowToBaseStats(r) {
          return {
            phys_atk: num(r["ë¬¼ë€"]), mag_atk: num(r["ë§ˆë€"]),
            str: num(r["í˜"]), int: num(r["ì§€ëŠ¥"]),
            acc: num(r["ì ì¤‘"]),
            phys_crit: num(r["ë¬¼í¬"]) || num(r["ë¬¼/ë§ˆí¬"]),
            mag_crit: num(r["ë§ˆí¬"]) || num(r["ë¬¼/ë§ˆí¬"]),
            phys_crit_rate: pct(r["ë¬¼í¬(%)"]),
            mag_crit_rate: pct(r["ë§ˆí¬(%)"]),
            add_damage: pct(r["ì¶”ë€(%)"]),
            damage_inc: pct(r["ë€ì¦(%)"]),
            crit_damage_inc: pct(r["í¬ì¦ë€(%)"]),
            phys_atk_pct: pct(r["ë¬¼ê³µ(%)"]),
            mag_atk_pct: pct(r["ë§ˆê³µ(%)"]),
            skill_atk_inc: pct(r["ìŠ¤ì¦(%)"]),
            elem: {
              fire: num(r["í™”"]), water: num(r["ìˆ˜"]), light: num(r["ëª…"]), dark: num(r["ì•”"]), all: 0
            },
            elem_add_damage: {
              fire: pct(r["í™”ì†ì¶”"]), water: pct(r["ìˆ˜ì†ì¶”"]), light: pct(r["ëª…ì†ì¶”"]), dark: pct(r["ì•”ì†ì¶”"])
            },
            speed: { attack: pct(r["ê³µì†(%)"]), move: pct(r["ì´ì†(%)"]), cast: pct(r["ìºì†(%)"]) },
            cdr: (r["ì¿¨ê°"]),
            dot_add: { poison: 0, bleed: pct(r["ì¶œí˜ˆì¶”ë€"]), burn: pct(r["í™”ìƒì¶”ë€"]), shock: pct(r["ê°ì „ì¶”ë€"]) },
            dot_inc: { poison: 0, bleed: pct(r["ì¶œí˜ˆë€ì¦"]), burn: pct(r["í™”ìƒë€ì¦"]), shock: pct(r["ê°ì „ë€ì¦"]) },
            other: { def_break_inc: pct(r["ë°©ê¹ë€ì¦(%)"]), enchant_bleed: num(r["ì¸ì±ˆì¶œí˜ˆ"]) }
          };
        }

        // í‚¤ ì •ê·œí™” ìœ í‹¸
        function normVal(s) {
          return String(s ?? '')
            .normalize('NFC')
            .replace(/[\uFEFF\u00A0\u200B-\u200D\u2060\u180E]/g, '')
            .replace(/\s+/g, '');
        }

        // â˜… preload(): CSV â†’ (ë³€ê²½) í”„ë¡ì‹œ&ë°±ì—”ë“œ JSON
        async function preload() {
          if (cache.ready) return;

          // 1) ë¡œê·¸ì¸ í† í° í™•ë³´
          const token = await waitForIdToken();

          // 2) í”„ë¡ì‹œ â†’ Apps Script: ?type=buff
          const r = await fetch(window.WEBAPP_URL + '?type=buff', {
            method: 'POST',
            mode: 'cors',
            cache: 'no-store',
            headers: { 'Content-Type': 'text/plain' },
            body: token
          });
          if (!r.ok) throw new Error('buff_fetch_failed');
          const data = await r.json();
          if (!data.ok || !Array.isArray(data.rows)) throw new Error('bad_buff_payload');

          // 3) __charKey ìƒì„±(ì§ì—…êµ°+ìºë¦­í„°ëª… ì •ê·œí™”) + ì›ë³¸ ì»¬ëŸ¼ ìœ ì§€
          const normVal = (v) => String(v ?? '')
            .normalize('NFC')
            .replace(/[\uFEFF\u00A0\u200B-\u200D\u2060\u180E]/g, '')
            .replace(/\s+/g, '');

          cache.rows = data.rows.map(row => {
            const job = row['ì§ì—…êµ°'] || row['ì§ì—…'] || '';
            const name = row['ìºë¦­í„°'] || row['ìºë¦­í„°ëª…'] || row['ìºë¦­ëª…'] || row['ì§ì—…ëª…'] || '';
            const charKey = normVal(job + name) || normVal(name);
            return { ...row, __charKey: charKey };
          });
          cache.ready = true;
        }

        // (ì¤‘ëµ) â€” ë„¤ ì½”ë“œì˜ computeBuffStats(), addStats/scaleAdd ë“± ê¸°ì¡´ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        // ë‹¨, computeBuffStats()ê°€ cache.rowsë¥¼ ì°¸ì¡°í•˜ë„ë¡ ìœ ì§€í•˜ë©´ ë¨
        // base Ã— (1 + ì¦ê°€ìœ¨ Ã— level)
        function scale(base, rate, level) {
          const m = 1 + (Number(rate) || 0) * (level | 0);
          const c = structuredClone(base);

          c.phys_atk *= m; c.mag_atk *= m; c.str *= m; c.int *= m; c.acc *= m; c.phys_crit *= m; c.mag_crit *= m;
          c.phys_crit_rate *= m; c.mag_crit_rate *= m; c.add_damage *= m; c.damage_inc *= m; c.crit_damage_inc *= m;
          c.phys_atk_pct *= m; c.mag_atk_pct *= m; c.skill_atk_inc *= m;
          c.elem.fire *= m; c.elem.water *= m; c.elem.light *= m; c.elem.dark *= m;
          c.elem_add_damage.fire *= m; c.elem_add_damage.water *= m; c.elem_add_damage.light *= m; c.elem_add_damage.dark *= m;
          c.speed.attack *= m; c.speed.move *= m; c.speed.cast *= m; c.cdr *= m;
          c.dot_add.bleed *= m; c.dot_add.burn *= m; c.dot_add.shock *= m;
          c.dot_inc.bleed *= m; c.dot_inc.burn *= m; c.dot_inc.shock *= m;
          c.other.def_break_inc *= m; c.other.enchant_bleed *= m;
          return c;
        }

        // stats í•©ì¹˜ê¸° (ë„¤ sumSelectionsì˜ add ê·œì¹™ê³¼ ë™ì¼í•˜ê²Œ ê°€ì‚°)
        function addStats(dst, st) {
          if (!st) return dst;
          dst.phys_atk += st.phys_atk || 0; dst.mag_atk += st.mag_atk || 0;
          dst.str += st.str || 0; dst.int += st.int || 0;
          dst.phys_crit += st.phys_crit || 0; dst.mag_crit += st.mag_crit || 0;
          dst.phys_crit_rate += st.phys_crit_rate || 0; dst.mag_crit_rate += st.mag_crit_rate || 0;
          dst.add_damage += st.add_damage || 0; dst.damage_inc += st.damage_inc || 0; dst.crit_damage_inc += st.crit_damage_inc || 0;
          dst.phys_atk_pct += st.phys_atk_pct || 0; dst.mag_atk_pct += st.mag_atk_pct || 0;
          dst.skill_atk_inc += st.skill_atk_inc || 0;
          if (st.elem) { dst.elem.fire += st.elem.fire || 0; dst.elem.water += st.elem.water || 0; dst.elem.light += st.elem.light || 0; dst.elem.dark += st.elem.dark || 0; }
          dst.cdr += st.cdr || 0;
          if (st.speed) { dst.speed.attack += st.speed.attack || 0; dst.speed.move += st.speed.move || 0; dst.speed.cast += st.speed.cast || 0; }
          if (st.other) { dst.def_break_inc += st.other.def_break_inc || 0; }
          return dst;
        }

        function emptyStatsLikeSum() {
          return {
            phys_atk: 0, mag_atk: 0, str: 0, int: 0, acc: 0,
            phys_crit: 0, mag_crit: 0, phys_crit_rate: 0, mag_crit_rate: 0,
            add_damage: 0, damage_inc: 0, crit_damage_inc: 0,
            phys_atk_pct: 0, mag_atk_pct: 0, skill_atk_inc: 0,
            elem: { fire: 0, water: 0, light: 0, dark: 0, all: 0 },
            speed: { attack: 0, move: 0, cast: 0 },
            cdr: 0, def_break_inc: 0
          };
        }

        // ì„ íƒ ì•„ì´í…œì—ì„œ "ë ˆë²¨ë§(N)" ì»¬ëŸ¼ ì¶”ì¶œ â†’ {N: sum}
        // ë¶™ì¼ ìœ„ì¹˜: ë²„í”„ ëª¨ë“ˆ íŒŒì¼(í˜¹ì€ ê³µìš© util)ì— ì„ ì–¸
        function collectItemLevelings(selections) {
          const out = Object.create(null);

          // ìŠ¬ë¡¯ë³„ë¡œ ë°°ì—´/ë‹¨ì¼ê°ì²´ ì„ì—¬ë„ ëª¨ë‘ ìˆœíšŒ
          const eachItems = (sel) => (
            !sel ? [] :
              Array.isArray(sel) ? sel :
                [sel.selected || sel].filter(Boolean)
          );

          // ìˆ«ì íŒŒì„œ(ì‰¼í‘œ/ë¬¸ì ì œê±°)
          const toNum = (v) => {
            const n = Number(String(v ?? '').replace(/[^\d.-]/g, ''));
            return Number.isFinite(n) ? n : 0;
          };

          // "ë ˆë²¨ë§(10)", "ë ˆë²¨ë§10", "Lv10", "ë ˆë²¨ 10", "ë²„í”„ë ˆë²¨(10)" ë“± í—ˆìš©
          const isLevelCol = (k) => {
            const s = String(k || '').replace(/\s+/g, '');
            return /^(?:ë ˆë²¨ë§|ë ˆë²¨|ë²„í”„ë ˆë²¨|Lv|LV)\(?\d+\)?$/.test(s);
          };
          const pickLevel = (k) => {
            const m = String(k || '').replace(/\s+/g, '').match(/(\d+)/);
            return m ? Number(m[1]) : NaN;
          };

          for (const [, sel] of Object.entries(selections || {})) {
            for (const it of eachItems(sel)) {
              const raw = it?.raw || it;
              if (!raw || typeof raw !== 'object') continue;

              for (const [k, v] of Object.entries(raw)) {
                if (!isLevelCol(k)) continue;
                const N = pickLevel(k);           // 10 / 15 / 25 / â€¦
                const val = toNum(v);             // 1, 2, â€¦
                if (!Number.isFinite(N) || !val) continue;
                out[N] = (out[N] || 0) + val;

              }
            }
          }


          return out;
        }

        // 1) ê°•ë ¥ ì •ê·œí™” ìœ í‹¸ (ê¸°ì¡´ cleanUrl í¬í•¨ í™•ì¥)
        function norm(s) {
          // cleanUrl: ì•ë’¤ ê³µë°±/ë”°ì˜´í‘œ ì œê±°, ë°±ìŠ¬ë˜ì‹œ â†’ ìŠ¬ë˜ì‹œ
          const base = cleanUrl(s);
          // ì œë¡œí­/ë¹„ê°€ì‹œ ê³µë°±ë¥˜ ì¶”ê°€ ì œê±° + ëª¨ë“  ê³µë°± ì œê±°
          return String(base)
            .normalize('NFC')
            .replace(/[\uFEFF\u00A0\u200B-\u200D\u2060\u180E]/g, '')
            .replace(/\s+/g, '');
        }
        // 2) BUFF ë¡œë”: __charKey ìƒì„± ë³´ê°• + ë¡œê¹… ë³´ê°•

        // base ê°ì²´ì—ì„œ ìˆ«ì í•„ë“œ(0ì´ ì•„ë‹Œ ê³³)ì—ë§Œ deltaë¥¼ ë”í•¨ (ì¤‘ì²© ê°ì²´ë„ ì²˜ë¦¬)
        function addDeltaWherePresent(base, delta) {
          const walk = (obj) => {
            if (!obj || typeof obj !== 'object') return obj;
            const out = Array.isArray(obj) ? [] : {};
            for (const [k, v] of Object.entries(obj)) {
              if (v && typeof v === 'object') {
                out[k] = walk(v);
              } else if (typeof v === 'number') {
                out[k] = (v !== 0) ? (v + delta) : v;
              } else {
                out[k] = v;
              }
            }
            return out;
          };
          return walk(base);
        }

        // â˜… ê°€ì‚°í˜• ìŠ¤ì¼€ì¼: "ì›ë˜ê°’ + (ì¦ê°€ìœ¨ * ë ˆë²¨ë§í•©)"
        function scaleAdd(baseStats, incRaw, levelCount) {
          // ë„¤ê°€ ì´ë¯¸ ê°€ì§„ toNum() ì¬ì‚¬ìš© (%, ê¸€ì ë“± ìˆìœ¼ë©´ ìˆ«ìë§Œ ë‚¨ê¸°ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ í•œ ì¤„ í™œì„±í™”)
          // incRaw = String(incRaw).replace(/[^0-9.-]/g, '');
          const inc = toNum(incRaw);      // ì˜ˆ: "4" -> 4
          const steps = toNum(levelCount);  // ì˜ˆ: 8
          const delta = inc * steps;        // ì˜ˆ: 32
          return addDeltaWherePresent(baseStats, delta);
        }


        // 3) ë§¤ì¹­: í˜„ì¬ ì„ íƒ ìºë¦­í„° í‚¤ ë§Œë“¤ê¸° + í•„í„°
        async function computeBuffStats() {
          if (!(state.currentCharacter?.name)) {
            return null; // ìºë¦­í„° ì—†ìœ¼ë©´ ë²„í”„ ë¯¸ì ìš©
          }
          if (!cache.ready) await preload();
          // â˜… ì˜ˆì™¸ê·œì¹™: ë²„í”„ë ˆë²¨ ì ìš©ì„ ìœ„í•´ ë¡œë“œ/í™œì„±í™”
          await ensureExceptionLoaded();   // í† í° ë³´ì¥ í›„ ì˜ˆì™¸ ì‹œíŠ¸ ë¡œë“œ
          refreshActiveExceptions();       // __EXC.buffLvByName ê°±ì‹ 

          const fullName = normVal(
            (state.currentCharacter?.jobGroupLabel || '') +
            (state.currentCharacter?.name || '')
          );

          // __charKeyëŠ” ì´ë¯¸ ì •ê·œí™”ëœ ìƒíƒœ
          const rows = cache.rows.filter(r => r.__charKey === fullName);


          const levMap = collectItemLevelings?.(state.selections || {}) || {};
          state.leveling = levMap; // â˜… ì¼ë°˜ ìŠ¤í‚¬ ë ˆë²¨ë§ ì ìš©ì„ ìœ„í•œ ì „ì—­ ì €ì¥

          let total = emptyStatsLikeSum();
          for (const r of rows) {
            const skillName = String(r['ìŠ¤í‚¬ëª…'] || r['skillname'] || '').trim();
            const req = Number(r['ìŠ¤í‚¬ë ™ì œ'] || r['skillreq'] || 0);
            // (êµì²´ ì½”ë“œ: ê°€ì‚°í˜• ì ìš©)
            const incRaw = r['ì¦ê°€ìœ¨'] || r['rate'] || 0;  // ì›ë¬¸ ìœ ì§€
            const base = rowToBaseStats(r);
            // ë²„í”„ ì´ë¦„ ì •ê·œí™”(ê³µë°±/ì œë¡œí­ ì œê±°)
            const normName = s => String(s ?? '')
              .normalize('NFC')
              .replace(/[\uFEFF\u00A0\u200B-\u200D\u2060\u180E]/g, '')
              .replace(/\s+/g, '');

            const baseLevel = toNum(levMap[req] || 0);  // ì•„ì´í…œ ë ˆë²¨ë§ í•©
            const excBonus = Number(__EXC?.buffLvByName?.[normName(skillName)] || 0); // â˜… ì˜ˆì™¸ 'ë²„í”„ë ˆë²¨'
            const level = baseLevel + excBonus;     // â† í•©ì‚° ì ìš©
            const scaled = scaleAdd(base, incRaw, level);  // â˜… ê°€ì‚°í˜•
            // â˜… í™•ì¸ìš© ë¡œê·¸
            if (excBonus) {

            } else {

            }

            total = addStats(total, scaled);
          }

          return total;
        }
        return { preload, computeBuffStats };
      })();
    </script>

    <script>
      /* ======== ë§ˆë²•ë´‰ì¸(ìŠ¬ë¡¯ë³„ 3êµ¬ì—­ ë‹¨ì¼ ì„ íƒ) & ë§ˆë²•ë¶€ì—¬ ======== */
      (function () {
        // ìƒíƒœ ìŠ¬ë¡¯
        window.state = window.state || {};
        state.seals = state.seals || {}; // { [slotKey]: { unique, general1, general2 } }
        state.enchants = state.enchants || {}; // { [slotKey]: {name, stats...} }

        /* ===== ë§ˆë²•ë´‰ì¸: ëª¨ë‹¬/ìŠ¤íƒ€ì¼ ë™ì  ìƒì„± ===== */
        function ensureSealModalBuilt() {
          if (document.getElementById('sealModal')) return;
          const html = `
<div id="sealModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-close></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="sealDlgTitle"
       style="width:min(860px,95vw);height:min(900px,88vh);">
    <header>
      <h2 id="sealDlgTitle">ë§ˆë²•ë´‰ì¸ ì„¤ì •</h2>
    </header>
    <div class="items" style="padding:10px;">
      <div class="seal-grid">
        <div class="seal-col">
          <div class="seal-col-title">ê³ ìœ ì˜µì…˜</div>
          <div id="sealListUnique" class="seal-list"></div>
        </div>
        <div class="seal-col">
          <div class="seal-col-title">ì¼ë°˜ì˜µì…˜</div>
          <div id="sealListGeneral1" class="seal-list"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button id="sealApplyBtn" class="ui-btnetc">ì ìš©í•˜ê¸°</button>
    </div>
  </div>
</div>`;

          document.body.insertAdjacentHTML('beforeend', html);
          const modal = document.getElementById('sealModal');
          modal.addEventListener('click', (e) => {
            if (e.target.hasAttribute('data-close') || e.target.classList.contains('backdrop')) closeSealModal();
          });
        }

        function ensureSealStyles() {
          if (document.getElementById('sealStyles')) return;
          const css = `
.seal-grid {
  display: grid;
  background: #0e0b09;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  justify-content: center;
}
.seal-col { border:1px solid var(--border, #333); background: #0e0b09; border-radius:12px; padding:10px; }
.seal-col-title { font-weight:700; color: #f0e6d2; background: #0e0b09; margin-bottom:8px; }
.seal-option { display:grid; width:100%; text-align:left; padding:8px 10px; color: #f0e6d2; cousor: pointer; margin:4px 0; border-radius:10px;
  border:1px solid var(--border,#333); background:var(--card,#1a130f); cursor:pointer; font-size:13px; }
.seal-option:hover { border-color: #xfa24f; box-shadow: 0 0 0 2px rgba(207, 162, 79, .25) inset; filter:brightness(1.08); }
.seal-option.selected { outline:2px solid #e7c27a; }
`;
          const s = document.createElement('style'); s.id = 'sealStyles'; s.textContent = css;
          document.head.appendChild(s);
        }

        function closeSealModal() {
          const modal = document.getElementById('sealModal');
          if (modal) { modal.classList.remove('show'); modal.setAttribute('aria-hidden', 'true'); }
          state.ui = state.ui || {};
          state.ui.sealTemp = null;
        }

        // ìŠ¬ë¡¯í‚¤ â†’ ë§ˆë´‰ íƒ€ì… í‚¤ë“¤(ëª¨ë‹¬ì—ì„œ ê³ ìœ /ì¼ë°˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë½‘ì„ ë•Œ ì‚¬ìš©)
        function sealTypeKeysForSlot(slotKey) {
          if (slotKey === 'weapon') return { u: 'ë¬´ê¸°ê³ ìœ ', g: 'ë¬´ê¸°ì¼ë°˜' };
          if (['headshoulder', 'top', 'bottom', 'belt', 'shoes'].includes(slotKey))
            return { u: 'ë°©ì–´ê³ ìœ ', g: 'ë°©ì–´ì¼ë°˜' };
          if (['bracelet', 'necklace', 'ring'].includes(slotKey))
            return { u: 'ì•…ì„¸ê³ ìœ ', g: 'ì•…ì„¸ì¼ë°˜' };
          if (slotKey === 'sub' || slotKey === 'support' || slotKey === 'magestone' || slotKey === 'earring')
            return { u: 'ë³´ì¥ê³ ìœ ', g: 'ë³´ì¥ì¼ë°˜' };
          return null;
        }

        /* ===== ë§ˆë²•ë¶€ì—¬: ë¡œì§ ===== */


        /* ===== ê³µí†µ UI ê°±ì‹  ë¡œì§ ===== */


        function refreshSealLabelsFromState() {
          document.querySelectorAll('.slot-row').forEach(row => {
            const slotEl = row.querySelector('.slot'); const code = slotEl?.getAttribute('data-slot');
            const slotKey = (window.SLOT_MAP || {})[code]; const rects = row.querySelectorAll('.outer-rects .rect');
            if (!slotKey || rects.length < 2) return;
            const has = !!(state.seals?.[slotKey]?.unique && state.seals?.[slotKey]?.general1);
            rects[1].textContent = has ? 'ë§ˆë´‰ ì„¤ì •ì™„ë£Œ' : 'ë§ˆë´‰ ì„¤ì •';
            refreshSealCaptionsForSlot(slotKey);
          });
        }

        function getSealCaptionText(obj) {
          if (!obj) return "";
          return (obj.badge ?? obj.level ?? obj.label ?? obj.text ?? obj.caption ?? obj.name ?? obj.imgText ?? "").toString().trim();
        }

        function refreshSealCaptionsForSlot(slotKey) {
          if (!slotKey) return;
          const el = window.tileElForSlot(slotKey);
          if (!el) return;
          const code = el.getAttribute('data-slot') || "";
          if (el.classList.contains('mini') || /^C[1-4]$/.test(code)) return;

          let cap = el.querySelector('.seal-captions');
          if (!cap) {
            cap = document.createElement('div');
            cap.className = 'seal-captions';
            el.appendChild(cap);
          }
          cap.innerHTML = '';

          const sel = (state.seals || {})[slotKey] || {};
          const u = sel.unique || null;
          const g1 = sel.general1 || null;

          const uTxt = getSealCaptionText(u);
          const g1Txt = getSealCaptionText(g1);

          if (!uTxt && !g1Txt) { cap.style.display = 'none'; return; }
          cap.style.display = 'flex';

          if (uTxt) {
            const rowU = document.createElement('div');
            rowU.className = 'seal-row seal-row-unique';
            const chipU = document.createElement('div');
            chipU.className = 'seal-chip';
            chipU.textContent = uTxt;
            rowU.appendChild(chipU);
            cap.appendChild(rowU);
          }

          if (g1Txt) {
            const rowG = document.createElement('div');
            rowG.className = 'seal-row seal-row-general';
            if (g1Txt) {
              const chip1 = document.createElement('div');
              chip1.className = 'seal-chip';
              chip1.textContent = g1Txt;
              rowG.appendChild(chip1);
            }
            cap.appendChild(rowG);
          }
        }

        function refreshSealCaptionsFromState() {
          document.querySelectorAll('.slot-row .slot').forEach(slotEl => {
            const code = slotEl.getAttribute('data-slot');
            if (!code) return;
            const slotKey = (window.SLOT_MAP || {})[code];
            if (!slotKey) return;
            if (slotEl.classList.contains('mini') || /^C[1-4]$/.test(code)) return; // ë¯¸ë‹ˆ ì œì™¸
            refreshSealCaptionsForSlot(slotKey);
          });
        }

        function buildSealList(listEl, choices, current, onPick) {
          listEl.innerHTML = '';
          choices.forEach(opt => {
            const b = document.createElement('button');
            b.className = 'seal-option' + ((current && current.name === opt.name) ? ' selected' : '');
            b.textContent = opt.name || '(ì´ë¦„ì—†ìŒ)';
            b.title = opt.tag ? `ë¶„ë¥˜: ${opt.tag}` : '';
            b.addEventListener('click', () => onPick(opt, b));
            listEl.appendChild(b);
          });
        }

        // (ê¸°ì¡´ í•¨ìˆ˜ êµì²´ â€” ì„œë²„ í˜¸ì¶œ ì œê±° ë²„ì „)
        async function tryFinalizeSeal(slotKey, btnEl) {
          const tmp = state.ui?.sealTemp;
          if (!tmp) return;

          // ê³ ìœ /ì¼ë°˜ ë‘˜ ë‹¤ ì„ íƒë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì•ˆë‚´ë§Œ í•˜ê³  ì¢…ë£Œ
          if (!tmp.unique || !tmp.general1) {
            alert('ê³ ìœ ì˜µì…˜ê³¼ ì¼ë°˜ì˜µì…˜ì„ ëª¨ë‘ ì„ íƒí•´ ì£¼ì„¸ìš”.');
            return;
          }

          // 1) ë¡œì»¬ ìƒíƒœë§Œ ë°˜ì˜ (ì„œë²„ í˜¸ì¶œ ì—†ìŒ)
          state.seals = state.seals || {};
          state.seals[slotKey] = {
            unique: tmp.unique,
            general1: tmp.general1,
          };

          // 2) ë¼ë²¨/ì¹© ê°±ì‹ 
          if (typeof refreshSealCaptionsForSlot === 'function') {
            refreshSealCaptionsForSlot(slotKey);
          }
          if (btnEl) {
            btnEl.textContent = 'ë§ˆë´‰ ì„¤ì •ì™„ë£Œ';
          }

          // 3) (í•©ì‚°ì€ calc_all + computeViaBackendì—ì„œ ì²˜ë¦¬)
          // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œë„ í”„ë¡ íŠ¸ í•©ì‚°ì„ ëŒë¦´ ìˆ˜ ìˆìŒ:
          // if (typeof recalcAndRenderPanel === 'function') {
          //   try { await recalcAndRenderPanel(); } catch (_) {}
          // }

          closeSealModal();
        }


        async function openSealModal(slotKey, btnEl) {
          ensureSealStyles();
          ensureSealModalBuilt();
          if (typeof ensureEnhLoaded === 'function')
            await ensureEnhLoaded();

          const keys = sealTypeKeysForSlot(slotKey);

          if (!keys) return;

          const uniq = (DBEnh?.byType?.[keys.u] || (DBEnh?.list || []).filter(o => (o?.type || '') === keys.u)).slice();
          const gen = (DBEnh?.byType?.[keys.g] || (DBEnh?.list || []).filter(o => (o?.type || '') === keys.g)).slice();


          // â˜… ì—¬ê¸°ì„œ ì‹¤ì œ ëª¨ë‹¬ DOMì´ ìˆëŠ”ì§€ í™•ì¸
          const modals = document.getElementById('sealModal');

          if (!modals) { console.error('sealModal element is missing!'); return; }

          state.ui = state.ui || {};
          const prev = (state.seals?.[slotKey]) || {};
          state.ui.sealTemp = {
            unique: prev.unique || null, general1: prev.general1 || null, slotKey, btnEl
          };

          const $ = (id) => document.getElementById(id);
          const listU = $('sealListUnique');
          const listG1 = $('sealListGeneral1');
          const applyBtn = $('sealApplyBtn');

          // ì˜µì…˜ í´ë¦­ ì‹œ: ì„ íƒ ìƒíƒœë§Œ ê°±ì‹ , ì ìš©ì€ í•˜ì§€ ì•ŠìŒ
          buildSealList(listU, uniq, prev.unique, (opt, btn) => {
            state.ui.sealTemp.unique = opt;
            listU.querySelectorAll('.seal-option').forEach(x => x.classList.remove('selected'));
            btn.classList.add('selected');
          });

          buildSealList(listG1, gen, prev.general1, (opt, btn) => {
            state.ui.sealTemp.general1 = opt;
            listG1.querySelectorAll('.seal-option').forEach(x => x.classList.remove('selected'));
            btn.classList.add('selected');
          });

          // "ì„ íƒ í•˜ê¸°" ë²„íŠ¼ì—ë§Œ ìµœì¢… ì ìš© ì—°ê²°
          if (applyBtn) {
            applyBtn.onclick = () => {
              tryFinalizeSeal(slotKey, btnEl);
            };
          }

          const modal = document.getElementById('sealModal');
          modal.classList.add('show');
          modal.setAttribute('aria-hidden', 'false');
        }

        // DOM ë¡œë“œ í›„ ë°”ì¸ë”©
        document.addEventListener('DOMContentLoaded', () => {
          refreshSealLabelsFromState();

          document.querySelectorAll('.slot-row').forEach(row => {
            const slotEl = row.querySelector('.slot');
            if (!slotEl) return;

            // âœ… ë³€ìˆ˜ëª… í†µì¼ ë° ì„ ì–¸ ìˆœì„œ ë³´ì¥
            const uiCode = String(slotEl.getAttribute('data-slot') || '');     // L1/L2/... ê°™ì€ UI ì½”ë“œ
            const slotKey = (window.SLOT_MAP || {})[uiCode];                   // ì„œë²„ ìŠ¬ë¡¯ í‚¤(top, belt, ...)
            const rects = row.querySelectorAll('.outer-rects .rect');
            if (!uiCode || !slotKey) return;

            // ë§ˆë´‰ (ë‘ë²ˆì§¸ ë²„íŠ¼)
            if (rects.length >= 2) {
              const secondBtn = rects[1];
              secondBtn.textContent = 'ë§ˆë´‰ ì„¤ì •';
              secondBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // ë§ˆë´‰ ìª½ì€ ì„œë²„ ìŠ¬ë¡¯í‚¤ ê¸°ì¤€ìœ¼ë¡œ í•„í„°í•˜ëŠ” ë¡œì§ì´ ë³´í†µì´ë¼ slotKey ì „ë‹¬ ìœ ì§€
                openSealModal(slotKey, secondBtn);
              });
            }

            // ë§ˆë²•ë¶€ì—¬ (ì„¸ë²ˆì§¸ ë²„íŠ¼)
            if (rects.length >= 3) {
              const thirdBtn = rects[2];

              // âœ… UIì½”ë“œë¡œ íƒ€ì… íŒì • (ì¹­í˜¸ë§ˆë¶€ ë“± ì¼€ì´ìŠ¤ í¬í•¨)
              const typeKey = enchantTypeForSlot(uiCode);

              if (typeKey) {
                thirdBtn.textContent = 'ë§ˆë²• ë¶€ì—¬';
                thirdBtn.disabled = false;
                thirdBtn.classList.remove('disabled', 'is-disabled');
                thirdBtn.style.pointerEvents = '';
                thirdBtn.dataset.role = 'enchant';
                thirdBtn.dataset.enchantType = typeKey;

                thirdBtn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  openEnchantModalFor(uiCode);          // â† ìƒˆ ëª¨ë‹¬(flow): applyEnchantSelection â†’ fetch ?type=enchant_select
                });
              } else {
                thirdBtn.classList.add('disabled');
                thirdBtn.disabled = true;
                thirdBtn.style.pointerEvents = 'none';
              }
            }
          });
        });

        const runeInfoTip = document.getElementById('runeInfoTip');
        const btnRune = document.getElementById('btnRune');

        if (runeInfoTip && btnRune) {
          runeInfoTip.addEventListener('click', (e) => {
            e.preventDefault();

            // i í´ë¦­ í›„ íˆ´íŒì´ í¬ì»¤ìŠ¤ë¡œ ê³ ì •ë˜ì§€ ì•Šê²Œ í¬ì»¤ìŠ¤ ì œê±°
            runeInfoTip.blur();

            // ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
            btnRune.classList.add('rune-highlight');

            // 0.7ì´ˆ í›„ ìë™ìœ¼ë¡œ íš¨ê³¼ ì œê±°
            setTimeout(() => {
              btnRune.classList.remove('rune-highlight');
            }, 700);
          });
        }

        // í•©ì‚° í•¨ìˆ˜ í™•ì¥: ë§ˆë´‰, ë§ˆë¶€ ìŠ¤íƒ¯ í•©ì‚°
        // í•©ì‚° í•¨ìˆ˜ í™•ì¥: ë§ˆë´‰, ë§ˆë¶€ ìŠ¤íƒ¯ í•©ì‚°
        try {
          const _base = window.sumSelections;
          if (typeof _base === 'function') {
            window.sumSelections = function () {
              const S = _base();

              // ëˆ„ì ê¸° ì•ˆì „ ë³´ì •
              S.__skillMul = S.__skillMul || 1;
              S.__skillAddBuff = S.__skillAddBuff || 0;

              const add = (st, src = 'other') => {
                if (!st) return;

                // 1) ìŠ¤ì¦ ë¶„ê¸°
                if (st.skill_atk_inc) {
                  if (src === 'buff') S.__skillAddBuff += (st.skill_atk_inc || 0);   // (ì—¬ê¸°ì„  ì•ˆ ì”€)
                  else S.__skillMul *= (1 + (st.skill_atk_inc || 0));  // ë§ˆë´‰/ë§ˆë¶€ëŠ” ê³±
                }

                // 2) ë‚˜ë¨¸ì§€ ìŠ¤íƒ¯ ê°€ì‚°
                S.phys_atk += st.phys_atk || 0; S.mag_atk += st.mag_atk || 0;
                S.str += st.str || 0; S.int += st.int || 0;
                S.phys_crit += st.phys_crit || 0; S.mag_crit += st.mag_crit || 0;
                S.phys_crit_rate += st.phys_crit_rate || 0; S.mag_crit_rate += st.mag_crit_rate || 0;
                S.add_damage += st.add_damage || 0;
                if (st.elem_add_damage) {
                  S.elem_add.fire += st.elem_add_damage.fire || 0;
                  S.elem_add.water += st.elem_add_damage.water || 0;
                  S.elem_add.light += st.elem_add_damage.light || 0;
                  S.elem_add.dark += st.elem_add_damage.dark || 0;
                }
                S.str_pct += st.str_pct || 0; S.int_pct += st.int_pct || 0;
                S.damage_inc += st.damage_inc || 0; S.crit_damage_inc += st.crit_damage_inc || 0;
                S.phys_atk_pct += st.phys_atk_pct || 0; S.mag_atk_pct += st.mag_atk_pct || 0;
                if (st.elem) { S.elem.fire += st.elem.fire || 0; S.elem.water += st.elem.water || 0; S.elem.light += st.elem.light || 0; S.elem.dark += st.elem.dark || 0; }
                S.cdr += st.cdr || 0;
                if (st.speed) { S.speed.attack += st.speed.attack || 0; S.speed.move += st.speed.move || 0; S.speed.cast += st.speed.cast || 0; }
                if (st.other) { S.def_break_inc += st.other.def_break_inc || 0; }
                S.counter_add_damage += st.counter_add_damage || 0;
                S.counter_damage_inc += st.counter_damage_inc || 0;
              };

              // ë§ˆë´‰(ì‹œì¼/seal)
              Object.values(state.seals || {}).forEach(p => {
                if (p?.unique?.stats) add(p.unique.stats, 'other');
                if (p?.general1?.stats) add(p.general1.stats, 'other');
              });

              // ë§ˆë¶€(enchants)
              Object.values(state.enchants || {}).forEach(p => {
                if (p?.stats) add(p.stats, 'other');
              });

              // â˜… ì—¬ê¸°ì„œ ìµœì¢… ìŠ¤ì¦ í™•ì •: (ê³±-1) + ë²„í”„í•©
              S.skill_atk_inc = (S.__skillMul - 1) + S.__skillAddBuff;

              // ì„ì‹œ í‚¤ ì •ë¦¬(ì„ íƒ)
              // delete S.__skillMul; delete S.__skillAddBuff;

              return S;
            };
          }
        } catch (e) { console.warn('Seal/Enchant sumSelections extension failed', e); }


        // ì „ì—­ì—ì„œ ì ‘ê·¼ í•„ìš” ì‹œ export
        window.refreshSealLabelsFromState = refreshSealLabelsFromState;
        window.refreshSealCaptionsForSlot = refreshSealCaptionsForSlot;
        window.refreshSealCaptionsFromState = refreshSealCaptionsFromState;
        if (document.readyState !== 'loading') {
          refreshSealCaptionsFromState();
        } else {
          document.addEventListener('DOMContentLoaded', refreshSealCaptionsFromState);
        }

        window.openSealModal = openSealModal;
      })();

      /* === FINAL DERIVED STATS EXTENSION (do this LAST) === */
      try {
        const _base = window.sumSelections;
        if (typeof _base === 'function') {
          window.sumSelections = function () {
            const S = _base();

            // ---- (A) ì†ì¶” í•©ê³„ ì¬í™•ì¸(ì¤‘ë³µ ë°©ì§€: í•©ê³„ëŠ” ì˜¤ì§ ì—¬ê¸°ì„œë§Œ) ----
            S.elem_add_sum =
              (S.elem_add?.fire || 0) +
              (S.elem_add?.water || 0) +
              (S.elem_add?.light || 0) +
              (S.elem_add?.dark || 0);

            // ---- (B) ìœ íš¨ ì†ì¶”: ì†ì¶” * (1.05 + 0.0045 * (ì†ê°• - ì ì €)) ----
            const M = (state && state.monster) ? state.monster : {};
            const eff = (k) => {
              const base = (S.elem_add?.[k] || 0);
              const atk = (S.elem?.[k] || 0);
              const res = (M?.[k] || 0);
              return base * (1.05 + 0.0045 * (atk - res));
            };
            S.elem_add_eff = {
              fire: eff('fire'),
              water: eff('water'),
              light: eff('light'),
              dark: eff('dark'),
            };
            S.elem_add_eff_sum =
              S.elem_add_eff.fire +
              S.elem_add_eff.water +
              S.elem_add_eff.light +
              S.elem_add_eff.dark;

            // ---- (C) ìµœì¢…ì¶”ë€ ----
            S.fin_add_damage =
              (S.add_damage || 0) +
              (S.elem_add_eff_sum || 0) +
              (S.counter_add_damage || 0);

            // ---- (D) ìµœì¢… í¬ë¦¬ìœ¨(ëª¬ìŠ¤í„° ë ˆë²¨ ì ìš©) ----
            const monsterLevel = Number(state?.monster?.level ?? 80);
            const computeFinalCritPct = (critVal, critRateVal) => {
              if (critVal == null || critRateVal == null) return 0;
              const denom = (3.8665 * Math.pow(100 / 97.25, monsterLevel)) * 100;
              const percent = (((critVal || 0) / denom) * 100) + ((critRateVal || 0) * 100) + 0;
              const clamped = Math.max(0, Math.min(100, percent));
              return clamped / 100; // 0~1
            };
            S.final_phys_crit_pct = computeFinalCritPct(S.phys_crit, S.phys_crit_rate);
            S.final_mag_crit_pct = computeFinalCritPct(S.mag_crit, S.mag_crit_rate);

            // ---- (E) ì†ì„± ë³´ì •ê³„ìˆ˜: 4ì† ì¤‘ (ì†ê°•-ì ì €) ìµœëŒ€ ----
            const elemMul = Math.max(
              1.05 + 0.0045 * ((S.elem?.fire || 0) - (M.fire || 0)),
              1.05 + 0.0045 * ((S.elem?.water || 0) - (M.water || 0)),
              1.05 + 0.0045 * ((S.elem?.light || 0) - (M.light || 0)),
              1.05 + 0.0045 * ((S.elem?.dark || 0) - (M.dark || 0)),
            );

            // ---- (F) í™•ë¥ ê³„ìˆ˜ factor (ë¬¼/ë§ˆ ë³„ë„) ----
            // (1 + (ë€ì¦ + ì¹´ìš´í„°ë€ì¦))
            // * ( ìµœì¢…í¬ë¦¬ìœ¨*(1.5+í¬ì¦ë€) + (1-ìµœì¢…í¬ë¦¬ìœ¨) )
            // * (1.05 + 0.0045*(ì†ê°•-ì ì €))
            // * (1 + (ìµœì¢…ì¶”ë€)*1.015)
            const baseMul1 = 1 + (S.damage_inc || 0) + (S.counter_damage_inc || 0);
            const baseMul4 = 1 + (S.fin_add_damage || 0) * 1.015;

            const baseMul2_phys =
              (S.final_phys_crit_pct * (1.5 + (S.crit_damage_inc || 0))) +
              (1 - S.final_phys_crit_pct);

            const baseMul2_mag =
              (S.final_mag_crit_pct * (1.5 + (S.crit_damage_inc || 0))) +
              (1 - S.final_mag_crit_pct);

            S.factor_phys = baseMul1 * baseMul2_phys * elemMul * baseMul4;
            S.factor_mag = baseMul1 * baseMul2_mag * elemMul * baseMul4;
            // ====== [ì¶”ê°€] í˜/ì§€ëŠ¥ ê³„ìˆ˜ì‹ ë° í‰íƒ€/ìŠ¤í‚¬ ë°ë¯¸ì§€ ê³„ì—´ ======

            // 0) ì¤€ë¹„: ì´í•© í˜/ì§€ëŠ¥, ì´í•© ë¬¼/ë§ˆê³µ
            const totalSTR = (S.str || 0) * (1 + (S.str_pct || 0));
            const totalINT = (S.int || 0) * (1 + (S.int_pct || 0));

            const totalPhysAtk = (S.phys_atk || 0) * (1 + (S.phys_atk_pct || 0));
            const totalMagAtk = (S.mag_atk || 0) * (1 + (S.mag_atk_pct || 0));

            // 1) ìŠ¤ì¼€ì¼ëŸ¬(í˜/ì§€ëŠ¥)
            const strScaler = (totalSTR / 250) + 1;
            const intScaler = (totalINT / 250) + 1;

            // 2) ê³ ë€ ìƒìˆ˜(ì‹œíŠ¸ì˜ 100*3.43 ê·¸ëŒ€ë¡œ)
            const GODAM_CONST = 100 * 3.43;

            // 3) â€œì›ì´ˆì‹â€ (ì¥ë¹„/ë²„í”„ ë“±ìœ¼ë¡œ ë§Œë“  ê¸°ì´ˆ ë°°ìˆ˜)
            S.str_perdam = strScaler * totalPhysAtk;   // í˜ í¼ë€
            S.str_godam = strScaler * GODAM_CONST;    // í˜ ê³ ë€
            S.in_perdam = intScaler * totalMagAtk;    // ì§€ëŠ¥ í¼ë€
            S.in_godam = intScaler * GODAM_CONST;    // ì§€ëŠ¥ ê³ ë€

            // 4) ëª¬ìŠ¤í„° ë°©ì–´ ë³´ì •(ë°©ì–´ìœ¨): ê°’ ì—†ìœ¼ë©´ 1ë¡œ ë‘ 
            const armorMul = state?.monster?.defRate ?? 1;

            // 5) í‰íƒ€/ìŠ¤í‚¬ ìµœì¢…ì‹ (í™•ë¥ ê³„ìˆ˜ + ìŠ¤í‚¬ê³µê²©ë ¥ì¦ê°€ ë°˜ì˜)
            //   - í™•ë¥ ê³„ìˆ˜: ë¬¼ë¦¬ = S.factor_phys, ë§ˆë²• = S.factor_mag
            //   - ìŠ¤í‚¬ê³µê²©ë ¥ì¦ê°€: S.skill_atk_inc (ê³±ëˆ„ì -1 + ë²„í”„í•©) ìµœì¢… í™•ì •ê°’
            const skillMul = 1 + (S.skill_atk_inc || 0);

            // í˜(ë¬¼ë¦¬) ë¼ì¸
            S.nor_str_perdam = S.factor_phys * S.str_perdam * armorMul * 1.25;
            S.nor_str_godam = S.factor_phys * S.str_godam * armorMul * 1.25;

            S.ski_str_perdam = S.factor_phys * skillMul * S.str_perdam * 1.25;
            S.ski_str_godam = S.factor_phys * skillMul * S.str_godam * 1.25;

            // ì§€ëŠ¥(ë§ˆë²•) ë¼ì¸
            S.nor_int_perdam = S.factor_mag * S.in_perdam * armorMul * 1.25;
            S.nor_int_godam = S.factor_mag * S.in_godam * armorMul * 1.25;

            S.ski_int_perdam = S.factor_mag * skillMul * S.in_perdam * 1.25;
            S.ski_int_godam = S.factor_mag * skillMul * S.in_godam * 1.25;

            return S;
          };
        }
      } catch (e) {
        console.warn('Finalize(sumSelections) extension failed', e);
      }

      // === ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ìŠ¬ë¡¯ UI ìƒíƒœ ===
      const presetSlots = {
        currentSlot: null,
        // slot ë²ˆí˜¸ë³„ ë©”íƒ€: { slot, label, meta, savedAt }
        data: {}
      };
      // âœ… í”„ë¦¬ì…‹ ìŠ¬ë¡¯ í˜ì´ì§•(10ê°œì”©, ìµœëŒ€ 20ìŠ¬ë¡¯)
const PRESET_UI_TOTAL = 20;
const PRESET_UI_PER_PAGE = 10;
let presetPage = 0; // 0=1í˜ì´ì§€(1~10), 1=2í˜ì´ì§€(11~20)

function getPresetMaxPage(maxSlot){
  const total = Math.max(0, Math.min(PRESET_UI_TOTAL, Number(maxSlot||0)));
  return Math.max(0, Math.ceil(total / PRESET_UI_PER_PAGE) - 1);
}

function applyPresetPageToDom(){
  const base = presetPage * PRESET_UI_PER_PAGE;
  const wraps = document.querySelectorAll('.save-box .preset-slot');
  wraps.forEach((wrap, i) => {
    const n = base + i + 1;
    const btn = wrap.querySelector('.preset-btn');
    const trash = wrap.querySelector('.preset-trash');
    if (btn) btn.dataset.slot = String(n);
    if (trash){
      trash.dataset.slot = String(n);
      trash.setAttribute('aria-label', `ìŠ¬ë¡¯ ${n} ì´ˆê¸°í™”`);
    }
  });
}

function updatePresetPagerUI(maxSlot){
  const prev = document.getElementById('presetPagePrev');
  const next = document.getElementById('presetPageNext');
  const ind  = document.getElementById('presetPageInd');

  const maxPage = getPresetMaxPage(maxSlot);

  if (prev) prev.disabled = (presetPage <= 0);
  if (next) next.disabled = (presetPage >= maxPage);

  if (ind){
    if (maxPage <= 0){
      ind.style.display = 'none';
      ind.textContent = '';
    } else {
      ind.style.display = 'block';
      ind.textContent = `${presetPage + 1}/${maxPage + 1}`;
    }
  }
}

function setPresetPage(p){
  const maxSlot = getUserPresetLimit();
  const maxPage = getPresetMaxPage(maxSlot);
  presetPage = Math.max(0, Math.min(maxPage, (p|0)));
  applyPresetPageToDom();
  updatePresetButtonsUI();
}


      // â˜… ìŠ¬ë¡¯ ê¸°ë³¸ ë¼ë²¨ ë°±ì—… (ë‚˜ì¤‘ì— ë¦¬ì…‹ìš©)
      const SLOT_BASE_LABELS = {};
      document.querySelectorAll('.slot[data-slot]').forEach(slotEl => {
        const key = slotEl.dataset.slot;
        const labelEl = slotEl.querySelector('.slot-label');
        if (key && labelEl) {
          SLOT_BASE_LABELS[key] = labelEl.textContent.trim();
        }
      });

      // ìŠ¬ë¡¯ ë²„íŠ¼ UI(í…Œë‘ë¦¬/íˆ´íŒ) ê°±ì‹ 
      function updatePresetButtonsUI() {
  const maxSlot = getUserPresetLimit();   // ğŸ”¹ ì§ì±…ë³„ ì‚¬ìš© ê°€ëŠ¥ ìµœëŒ€ ìŠ¬ë¡¯ ìˆ˜

  // âœ… í˜ì´ì§€ê°€ í—ˆìš© ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ë³´ì •
  const maxPage = getPresetMaxPage(maxSlot);
  if (presetPage > maxPage) presetPage = maxPage;

  // âœ… í˜„ì¬ í˜ì´ì§€ì— ë§ì¶° data-slotì„ 1~10 ë˜ëŠ” 11~20ìœ¼ë¡œ ê°±ì‹ 
  applyPresetPageToDom();

  // ì´ì œ ë²„íŠ¼ ì¡°íšŒ(ê°±ì‹ ëœ data-slot ê¸°ì¤€)
  const btns = document.querySelectorAll('.save-box .preset-btn[data-slot]');

  btns.forEach((btn) => {
    const slotStr = btn.dataset.slot;
    const slotNum = Number(slotStr || '0');
    const info = presetSlots.data[slotStr];

    const meta = info && info.meta ? info.meta : null;
    const isAllowed = slotNum > 0 && slotNum <= maxSlot;

    btn.disabled = !isAllowed;

    if (info) {
      btn.classList.add('has-data');
      const label = info.label || '';
      const charName = info.meta?.charName || '';
      btn.title = label || charName || `ìŠ¬ë¡¯ ${slotNum}`;

      const thumb = meta && meta.thumb ? meta.thumb : '';
      if (thumb) {
        btn.style.backgroundImage = `url("${thumb}")`;
        btn.textContent = '';
      } else {
        btn.style.backgroundImage = '';
        btn.textContent = '+';
      }
    } else {
      btn.classList.remove('has-data');
      btn.style.backgroundImage = '';
      btn.textContent = '+';
      btn.title = isAllowed
        ? `ìŠ¬ë¡¯ ${slotNum}`
        : `ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ ë©¤ë²„ì‹­ ì—…ê·¸ë ˆì´ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤!`;
    }
  });

  // âœ… í™”ì‚´í‘œ/í˜ì´ì§€ í‘œì‹œ ì—…ë°ì´íŠ¸
  updatePresetPagerUI(maxSlot);
}


      // í˜„ì¬ í”„ë¡ íŠ¸ state ì „ì²´ë¥¼ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ë§Œë“¤ì–´ì„œ ì„œë²„ì— ë³´ë‚¼ ê°ì²´ë¡œ ë°˜í™˜
      function buildFrontPresetState() {
        const raw = window.state || {};
        const snap = {};

        // í•„ìš”í•œ í‚¤ë“¤ë§Œ ê³¨ë¼ì„œ ì €ì¥ (ëª¨ìë¼ë©´ ì—¬ê¸° í‚¤ë¥¼ ë” ì¶”ê°€í•´)
        const keys = [
          'currentCharacter',
          'charRow',

          // ì¥ë¹„/ê°•í™”/ë§ˆë¶€/ì—°ë§ˆ/ì— ë¸”ë ˜/ë£¬/ì•„ë°”íƒ€/ë²„í”„
          'selections',
          'enh',
          'enchants',
          'seals',
          'emblems',
          'refines',
          'skillrune',
          'runeEngrave',
          'castleSeal',
          'CastleSeal',
          'avatar',
          'buff',

          // â˜… ìŠ¤í‚¬/ìŠ¤í‚¬íŠ¸ë¦¬ ê´€ë ¨
          'sp',
          'tp',
          'stUsedSP',
          'stUsedTP',
          'skillLv',
          'skillTpLv',
          'skillDmg',
          'skillUseOpts',

          // ê¸°íƒ€ ì˜µì…˜/ëª¬ìŠ¤í„° ë“±
          'monster',
          'options',

          // â˜… ì»¤ìŠ¤í…€ì˜µ
          'customSkills',
          'specialRunes',  // â† ì´ ì¤„ ì¶”ê°€í•˜ë©´ í”„ë¦¬ì…‹ì— íŠ¹ìˆ˜ë£¬ë„ ê°™ì´ ì €ì¥
        ];

        for (const k of keys) {
          if (raw[k] !== undefined) {
            snap[k] = raw[k];
          }
        }

        return snap;
      }

      // í”„ë¦¬ì…‹ì—ì„œ ë¶ˆëŸ¬ì˜¨ state ìŠ¤ëƒ…ìƒ·ì„ í˜„ì¬ stateì— ì ìš© + ìŠ¬ë¡¯ UI/ìºë¦­í„° UI ê°±ì‹ 
      function applyFrontPresetState(snap) {
        if (!snap || typeof snap !== 'object') return;

        // ğŸ”¹ í•­ìƒ window.state ê¸°ì¤€ìœ¼ë¡œë§Œ ì²˜ë¦¬
        if (!window.state || typeof window.state !== 'object') {
          window.state = {};
        }
        const target = window.state;

        // 1) ìŠ¤ëƒ…ìƒ· ê¹Šì€ ë³µì‚¬ (ê³µìœ  ì°¸ì¡° ë°©ì§€)
        let src;
        try {
          if (typeof structuredClone === 'function') {
            src = structuredClone(snap);
          } else {
            src = JSON.parse(JSON.stringify(snap));
          }
        } catch (_) {
          src = snap;
        }

        // 2) ê¸°ì¡´ state ë‚´ìš©ì„ ì‹¹ ë¹„ìš°ê³ 
        Object.keys(target).forEach((k) => { delete target[k]; });
        // 3) ìƒˆ ìŠ¤ëƒ…ìƒ· ë‚´ìš©ìœ¼ë¡œ ì±„ì›€
        Object.entries(src).forEach(([k, v]) => {
          target[k] = v;
        });

        // ì—¬ê¸°ë¶€í„°ëŠ” targetì„ ë¡œì»¬ ë³€ìˆ˜ë¡œ ì‚¬ìš© (stateë¼ëŠ” ì´ë¦„ì€ ì“°ì§€ ì•ŠìŒ)
        const s = target;


        // ğŸ”¸ UI ì „ìš© ìƒíƒœëŠ” í”„ë¦¬ì…‹ ìŠ¤ëƒ…ìƒ·ì— ì•ˆ ë“¤ì–´ì˜¤ë¯€ë¡œ ì—¬ê¸°ì„œ ê¸°ë³¸ ê°ì²´ ë‹¤ì‹œ ì„¸íŒ…
        if (!s.ui || typeof s.ui !== 'object') {
          s.ui = {
            weaponTypeTab: null,
            enhTargetSlot: null,
            enhTargetBtn: null,
            emblemTarget: { slotKey: null, sockIndex: 0 },
          };
        } else {
          // í˜¹ì‹œ ì¼ë¶€ë§Œ ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ìµœì†Œí•œ ì•ˆì „ì¥ì¹˜
          if (typeof s.ui.weaponTypeTab === 'undefined') s.ui.weaponTypeTab = null;
          if (typeof s.ui.enhTargetSlot === 'undefined') s.ui.enhTargetSlot = null;
          if (typeof s.ui.enhTargetBtn === 'undefined') s.ui.enhTargetBtn = null;
          if (!s.ui.emblemTarget) {
            s.ui.emblemTarget = { slotKey: null, sockIndex: 0 };
          }
        }

        // â˜… SP/TP ê¸°ë³¸ êµ¬ì¡° ë³´ì • (ìŠ¤ëƒ…ìƒ·ì— ì—†ìœ¼ë©´ë¼ë„)
        if (!s.sp || typeof s.sp !== 'object') {
          s.sp = { total: 0, left: 0 };
        } else {
          s.sp.total = Number(s.sp.total || 0);
          s.sp.left = Number(s.sp.left ?? s.sp.total ?? 0);
        }
        if (!s.tp || typeof s.tp !== 'object') {
          s.tp = { total: 0, left: 0 };
        } else {
          s.tp.total = Number(s.tp.total || 0);
          s.tp.left = Number(s.tp.left ?? s.tp.total ?? 0);
        }

        // â˜… í”„ë¦¬ì…‹ ì ìš© ì§í›„ SP/TP UI ê°±ì‹ 
        try {
          if (typeof renderSpTp === 'function') {
            renderSpTp();
          }
        } catch (e) {
          console.warn('[applyFrontPresetState] renderSpTp ì‹¤íŒ¨:', e);
        }

        // 4) ìºë¦­í„° ë¼ë²¨/ì´ë¯¸ì§€ ë°˜ì˜
        try {
          const char = s.currentCharacter || {};
          const charName = char.name || '';
          const jobGroup = char.jobGroupLabel || '';

          const $charLabel = document.getElementById('charLabel');
          if ($charLabel) {
            if (charName) {
              $charLabel.textContent = jobGroup
                ? `${jobGroup} / ${charName}`
                : charName;
            } else {
              $charLabel.textContent = 'ìºë¦­í„° ë¯¸ì„ íƒ';
            }
          }

          const characterImg = document.getElementById('characterImg');
          const characterGhost = document.getElementById('characterGhost');
          if (characterImg) {
            const srcImg =
              char.full ||
              char.thumb ||
              characterImg.src ||
              (typeof PLACEHOLDER_IMG !== 'undefined' ? PLACEHOLDER_IMG : '');
            if (srcImg) {
              characterImg.src = srcImg;
              characterImg.style.display = charName ? 'block' : 'none';
            }
          }
          if (characterGhost) {
            characterGhost.style.display = charName ? 'none' : 'block';
          }
        } catch (e) {
          console.warn('[applyFrontPresetState] ìºë¦­í„° UI ê°±ì‹  ì‹¤íŒ¨:', e);
        }

        // 5) ì¥ë¹„ ìŠ¬ë¡¯ íƒ€ì¼ UI ë°˜ì˜
        try {
          const selections = s.selections || {};

          // 5-1) ëª¨ë“  ìŠ¬ë¡¯ ê¸°ë³¸ ë¼ë²¨ë¡œ ì´ˆê¸°í™”
          if (typeof SLOT_BASE_LABELS === 'object') {
            document.querySelectorAll('.slot[data-slot]').forEach((slotEl) => {
              const domKey = slotEl.dataset.slot;
              const base = (SLOT_BASE_LABELS && SLOT_BASE_LABELS[domKey]) || '';
              const labelEl = document.createElement('span');
              labelEl.className = 'slot-label';
              labelEl.textContent = base;
              slotEl.innerHTML = '';
              slotEl.appendChild(labelEl);
              slotEl.classList.remove('selected');
            });
          }

          // 5-2) equip â†’ DOM ìŠ¬ë¡¯ ë§¤í•‘
          const EQUIP_TO_DOM = {
            headshoulder: 'L1',
            top: 'L2',
            bottom: 'L3',
            belt: 'L4',
            shoes: 'L5',
            earring: 'L6',

            weapon: 'R1',
            bracelet: 'R2',
            necklace: 'R3',
            ring: 'R4',
            sub: 'R5',
            magestone: 'R6',

            aura: 'C1',
            title: 'C2',
            creature: 'C3',
            artifact: 'C4',
          };

          // 5-3) ê° selection ì„ ìŠ¬ë¡¯ì— ë°˜ì˜ (ì ‘ë‘ì‚¬ ë¼ë²¨ í¬í•¨)
          Object.entries(selections).forEach(([slotKey, info]) => {
            const domKey = EQUIP_TO_DOM[slotKey];
            if (!domKey) return;

            const slotEl = document.querySelector(`.slot[data-slot="${domKey}"]`);
            if (!slotEl) return;

            // ì ‘ë‘ì‚¬ ë¼ë²¨ ë³µì›
            const rawPrefix =
              info?.prefixLabel ||    // í”„ë¦¬ì…‹ ìŠ¤ëƒ…ìƒ·ì— ì´ë¯¸ ì €ì¥ëœ ê°’
              info?.prefix ||         // í˜¹ì‹œ prefix í•„ë“œë§Œ ìˆì„ ë•Œ
              '';
            const prefixLabel = makeEquipPrefixLabel(rawPrefix);
            const labelHtml = prefixLabel
              ? `<div class="equip-prefix">${prefixLabel}</div>`
              : '';

            const safeAlt = String(info?.name || '').replace(/"/g, '&quot;');
            const srcImg =
              info?.img ||
              (typeof PLACEHOLDER_IMG !== 'undefined' ? PLACEHOLDER_IMG : '');
            if (!srcImg) return;

            slotEl.innerHTML =
              labelHtml +
              `<img class="item-img" alt="${safeAlt}" src="${srcImg}"` +
              ` style="width:70%;height:70%;border-radius:8px;">`;
            slotEl.classList.add('selected');
          });

          // 5-4) ìºìŠ¬ ì”°/ì— ë¸”ë ˜/ê°•í™” ë¼ë²¨ ë“± ë¶€ê°€ UIë„ ìƒíƒœ ê¸°ë°˜ìœ¼ë¡œ ë¦¬í”„ë ˆì‹œ
          try {
            if (typeof refreshSealCaptionsFromState === 'function') {
              refreshSealCaptionsFromState();
            }
            if (typeof refreshSealLabelsFromState === 'function') {
              refreshSealLabelsFromState();
            }
            if (typeof refreshEnhLabelsFromState === 'function') {
              refreshEnhLabelsFromState();
            }
            if (typeof refreshAllDots === 'function') {
              refreshAllDots();   // ì— ë¸”ë ˜ ë„íŠ¸
            }
            // â˜… ì¥ë¹„ ì„¤ëª… í”„ë¦¬ë·° ê°±ì‹ 
            if (typeof updateEquipDescPreview === 'function') {
              updateEquipDescPreview();
            }
          } catch (e2) {
            console.warn('[applyFrontPresetState] extra UI refresh ì‹¤íŒ¨:', e2);
          }
        } catch (e) {
          console.warn('[applyFrontPresetState] ìŠ¬ë¡¯ UI ê°±ì‹  ì‹¤íŒ¨:', e);
        }



        // 4) ë§ˆë²•ë¶€ì—¬(ë§ˆë¶€) ë²„íŠ¼ ë¼ë²¨ ê°±ì‹ 
        try {
          const enchants = s.enchants || {};
          const slotMap = window.SLOT_MAP || {};
          const reverse = {};

          // ì„œë²„ ìŠ¬ë¡¯í‚¤(weapon, top, ...) â†’ UI ì½”ë“œ(R1, L2, ...) ì—­ë§¤í•‘
          Object.entries(slotMap).forEach(([uiCode, serverSlot]) => {
            reverse[serverSlot] = uiCode;
          });

          Object.entries(enchants).forEach(([serverSlot, info]) => {
            const name = info?.name || '';
            if (!name) return;

            // í‚¤ê°€ ì´ë¯¸ R1/L1 í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ, ì•„ë‹ˆë©´ ì—­ë§¤í•‘
            const uiCode = reverse[serverSlot] || serverSlot;

            if (typeof updateEnchantLabel === 'function') {
              // ì´ë¯¸ ìˆëŠ” í—¬í¼ í™œìš©
              updateEnchantLabel(uiCode, name);
            } else {
              // fallback: ìˆ˜ë™ìœ¼ë¡œ ë²„íŠ¼ ì°¾ì•„ì„œ í…ìŠ¤íŠ¸ ë³€ê²½
              const rowEl = document
                .querySelector(`.slot-row .slot[data-slot="${uiCode}"]`)
                ?.closest('.slot-row');
              if (rowEl) {
                const target = rowEl.querySelector('.outer-rects .rect[data-role="enchant"]')
                  || rowEl.querySelector('.outer-rects .rect:nth-child(3)');
                if (target) target.textContent = name;
              }

              const cellEl = document
                .querySelector(`.mini-cell .slot.mini[data-slot="${uiCode}"]`)
                ?.closest('.mini-cell');
              if (cellEl) {
                const target = cellEl.querySelector('.outer-rects .rect[data-role="enchant"]')
                  || cellEl.querySelector('.outer-rects .rect:nth-child(1)');
                if (target) target.textContent = name;
              }
            }
          });
        } catch (e) {
          console.warn('[applyFrontPresetState] enchant ë¼ë²¨ ê°±ì‹  ì‹¤íŒ¨:', e);
        }

        // 5) ì—°ë§ˆ ë²„íŠ¼ ë¼ë²¨ ê°±ì‹ 
        try {
          const refines = s.refines || {};
          const slotMap = window.SLOT_MAP || {};
          const reverse = {};

          Object.entries(slotMap).forEach(([uiCode, serverSlot]) => {
            reverse[serverSlot] = uiCode;
          });

          Object.entries(refines).forEach(([serverSlot, info]) => {
            const name = info?.name || '';
            if (!name) return;

            const uiCode = reverse[serverSlot] || serverSlot; // weapon â†’ R1, sub â†’ R5 ë“±

            const container =
              document
                .querySelector(`.slot-row .slot[data-slot="${uiCode}"]`)
                ?.closest('.slot-row')
              || document
                .querySelector(`.mini-cell .slot.mini[data-slot="${uiCode}"]`)
                ?.closest('.mini-cell');
            if (!container) return;

            const btn =
              container.querySelector('.outer-rects .rect[data-role="refine"]') ||
              container.querySelector('.outer-rects .rect:nth-child(4)');

            if (btn) btn.textContent = name;
          });
        } catch (e) {
          console.warn('[applyFrontPresetState] refine ë¼ë²¨ ê°±ì‹  ì‹¤íŒ¨:', e);
        }
        // ì»¤ìŠ¤í…€ì˜µ ë²„íŠ¼ UIë„ state ê¸°ì¤€ìœ¼ë¡œ ë™ê¸°í™”
        if (typeof applyCustomOptUIFromState === 'function') {
          applyCustomOptUIFromState();
        }
        // ğŸ”¹ í”„ë¦¬ì…‹ ì ìš© í›„ ìŠ¤í‚¬ë£¬ ê°œìˆ˜ UIë„ ê°±ì‹ 
        try {
          if (typeof ensureRunesInitialized === 'function') {
            // í”„ë¦¬ì…‹ ìŠ¤ëƒ…ìƒ·ì—ì„œ ê°€ì ¸ì˜¨ skillrune â†’ runes ë¡œ ë™ê¸°í™”
            ensureRunesInitialized();
          }
          if (typeof updateRuneCountSummary === 'function') {
            // runes ê¸°ì¤€ìœ¼ë¡œ "ì„ íƒí•œ ìŠ¤í‚¬ë£¬ ê°œìˆ˜" ë¼ë²¨ ì—…ë°ì´íŠ¸
            updateRuneCountSummary();
          }
        }
        catch (e) {
          console.warn('[applyFrontPresetState] runeCount ê°±ì‹  ì‹¤íŒ¨:', e);
        }
        // ğŸ”¹ í”„ë¦¬ì…‹ ì ìš© í›„ ë£¬ê°ì¸ ë“œë¡­ë‹¤ìš´ UIë„ state.runeEngrave ê¸°ì¤€ìœ¼ë¡œ ë™ê¸°í™”
        try {
          if (typeof updateRuneEngraveUIFromState === 'function') {
            updateRuneEngraveUIFromState();
          }
        } catch (e) {
          console.warn('[applyFrontPresetState] runeEngrave UI ê°±ì‹  ì‹¤íŒ¨:', e);
        }
      }


      // â˜… í”„ë¦¬ì…‹ ìŠ¤ëƒ…ìƒ· â†’ í™”ë©´ ìŠ¬ë¡¯/ìºë¦­í„° UI ë°˜ì˜
      // â˜… preset_load ì‘ë‹µì˜ snapshot â†’ ìºë¦­í„°/ìŠ¬ë¡¯ ì´ë¯¸ì§€ + ë¼ë²¨ê¹Œì§€ ì‹¹ ë°˜ì˜
      async function applyPresetSnapshotToUI(snapshot) {

        if (!snapshot || typeof snapshot !== 'object') return;

        const charStats = snapshot.CharStats || {};
        const meta = snapshot.meta || {};

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1) ìºë¦­í„° ì´ë¦„/ì¡êµ° ì •ë¦¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const charName =
          charStats.charName ||
          charStats.CharName ||
          meta.charName ||
          '';
        const jobGroup =
          charStats.jobGroup ||
          charStats.JobGroup ||
          meta.jobGroup ||
          '';

        // ìƒíƒœì— ê°„ë‹¨íˆ ê¸°ë¡ (ownerKey ê³„ì‚° ë“±ì— ì‚¬ìš©)
        if (!window.state || typeof window.state !== 'object') window.state = {};
        const s = window.state;
        s.currentCharacter = s.currentCharacter || {};
        s.currentCharacter.name = charName || '';
        s.currentCharacter.jobGroupLabel = jobGroup || '';

        // ë¼ë²¨ ë°•ìŠ¤ í…ìŠ¤íŠ¸ ê°±ì‹ 
        const $charLabel = document.getElementById('charLabel');
        if ($charLabel) {
          if (charName) {
            $charLabel.textContent = jobGroup
              ? `${jobGroup} / ${charName}`
              : charName;
          } else {
            $charLabel.textContent = 'ìºë¦­í„° ë¯¸ì„ íƒ';
          }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2) ìºë¦­í„° ì´ë¯¸ì§€ êµì²´ (DBChars ì´ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try {
          if (charName && jobGroup && typeof ensureCharactersLoaded === 'function') {
            await ensureCharactersLoaded();
            const groups = (window.DBChars && window.DBChars.groups) || [];
            const norm = (v) => String(v ?? '').replace(/\s+/g, ' ').trim();

            const g = groups.find(g =>
              norm(g.title) === norm(jobGroup)
            );
            let foundChar = null;
            if (g && Array.isArray(g.items)) {
              foundChar = g.items.find(it => norm(it.name) === norm(charName));
            }

            const characterImg = document.getElementById('characterImg');
            const characterGhost = document.getElementById('characterGhost');

            if (characterImg) {
              const src = (foundChar && (foundChar.fullSrc || foundChar.thumbSrc)) || PLACEHOLDER_IMG;
              characterImg.src = src;
              characterImg.style.display = 'block';
            }
            if (characterGhost) {
              characterGhost.style.display = charName ? 'none' : 'block';
            }

            // ìƒíƒœì—ë„ ì¸ë„¤ì¼/í’€ ì´ë¯¸ì§€ ì‚´ì§ ì €ì¥í•´ë‘ë©´ ë‚˜ì¤‘ì— ì¨ë¨¹ê¸° ì¢‹ìŒ
            if (foundChar) {
              state.currentCharacter.thumb = foundChar.thumbSrc || '';
              state.currentCharacter.full = foundChar.fullSrc || '';
            }
          }
        } catch (e) {
          console.warn('[preset] ìºë¦­í„° ì´ë¯¸ì§€ ë³µì› ì‹¤íŒ¨:', e);
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3) ì¥ë¹„ ìŠ¬ë¡¯ ì´ë¯¸ì§€/ë¼ë²¨ êµì²´ â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const equip = snapshot.equip || {};


        if (!window.SLOT_MAP) {
          console.warn('[preset] SLOT_MAP ì—†ìŒ, ìŠ¬ë¡¯ UI ê°±ì‹  ê±´ë„ˆëœ€');
          return;
        }

        // ë°±ì—”ë“œ equip í‚¤ â†’ ì¢Œ/ìš°/ì„¼í„° ë„ì‹ ìŠ¬ë¡¯ ì½”ë“œ
        const EQUIP_TO_DOM = {
          headshoulder: 'L1',
          top: 'L2',
          bottom: 'L3',
          belt: 'L4',
          shoes: 'L5',
          earring: 'L6',

          weapon: 'R1',
          bracelet: 'R2',
          necklace: 'R3',
          ring: 'R4',
          sub: 'R5',
          magestone: 'R6',

          aura: 'C1',
          title: 'C2',
          creature: 'C3',
          artifact: 'C4',
        };

        const norm = (v) => String(v ?? '').replace(/\s+/g, '').trim();

        // state.selections ì´ˆê¸°í™”
        state.selections = state.selections || {};

        // ë¬´ê¸° ë¦¬ìŠ¤íŠ¸ í•„í„°ì— jobGroupì„ ì“°ë¯€ë¡œ ë¯¸ë¦¬ ì •ë¦¬
        const job = String(jobGroup || '').trim() || null;

        // ê° equipKey ë§ˆë‹¤ ë°•ìŠ¤/ì´ë¯¸ì§€ ê°±ì‹ 
        for (const [equipKey, domKey] of Object.entries(EQUIP_TO_DOM)) {
          const statsRow = equip[equipKey];
          const wantedName =
            statsRow?._meta?.name ||
            statsRow?.name ||
            statsRow?.Name ||
            '';

          const slotEl = document.querySelector(`.slot[data-slot="${domKey}"]`);
          if (!slotEl) continue;

          // ë¹„ì–´ ìˆëŠ” ìŠ¬ë¡¯ì´ë©´ ê¸°ë³¸ ë¼ë²¨ë¡œ ë˜ëŒë¦¬ê¸°
          if (!wantedName) {
            const base = (window.SLOT_BASE_LABELS && window.SLOT_BASE_LABELS[domKey]) || '';
            slotEl.innerHTML = `<span class="slot-label">${base}</span>`;
            slotEl.classList.remove('selected');

            const slotKey = window.SLOT_MAP[domKey]; // 'weapon', 'top' ë“±
            if (slotKey && state.selections[slotKey]) {
              delete state.selections[slotKey];
            }
            continue;
          }

          // â”€ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê°™ì€ ì´ë¦„ ì°¾ê¸° â”€
          const slotKey = window.SLOT_MAP[domKey]; // 'weapon', 'top' ë“±
          if (!slotKey) continue;

          try {
            if (typeof ensureEquipListLoaded === 'function') {
              await ensureEquipListLoaded(slotKey, job);
            }
            const items = (typeof getItemsForSlot === 'function')
              ? getItemsForSlot(slotKey, job)
              : [];

            const found = items.find(it => norm(it.name) === norm(wantedName));

            const imgSrc = (found && found.img) || PLACEHOLDER_IMG;
            const safeAlt = String(wantedName).replace(/"/g, '&quot;');

            slotEl.innerHTML =
              `<img class="item-img" alt="${safeAlt}"` +
              ` src="${imgSrc}" style="width:70%;height:70%;border-radius:8px;">`;
            slotEl.classList.add('selected');

            // í”„ë¡ íŠ¸ ìƒíƒœì—ë„ ê¸°ì–µ (ì»¤ìŠ¤í…€ì˜µ / ê¸°íƒ€ì—ì„œ ì‚¬ìš©)
            state.selections[slotKey] = {
              name: found ? found.name : wantedName,
              img: found ? (found.img || null) : null,
              code: found ? (found.code || null) : null,
            };
          } catch (e) {
            console.warn('[preset] equip ìŠ¬ë¡¯ ë³µì› ì‹¤íŒ¨:', equipKey, e);
          }
        }

      }


      // ëª¨ë‹¬ ì—´ê¸°
      function openPresetModal(slot) {
        const n = Number(slot);
        if (!n) return;

        presetSlots.currentSlot = n;

        const $modal = document.getElementById('presetModal');
        const $thumb = document.getElementById('presetCharThumb');
        const $charNm = document.getElementById('presetCharName');
        const $userNm = document.getElementById('presetUserName');

        if (!$modal) return;

        const info = presetSlots.data[String(n)] || null;
        const meta = info && info.meta ? info.meta : null;

        // 1) ìºë¦­í„° ì¸ë„¤ì¼: "ì €ì¥ëœ ìºë¦­í„°" ê¸°ì¤€
        let thumbSrc = '';

        if (meta && meta.thumb) {
          thumbSrc = meta.thumb;
        } else {
          // ì˜›ë‚ ì— ì €ì¥ëœ í”„ë¦¬ì…‹(ë©”íƒ€ ì—†ëŠ” ê²½ìš°) ëŒ€ë¹„í•´ì„œ í˜„ì¬ ìºë¦­í„°ë¥¼ fallback
          const char = (window.state && window.state.currentCharacter) || null;
          if (char) {
            thumbSrc = char.full || char.thumb || char.imgSrc || '';
          }
          if (!thumbSrc) {
            const imgEl = document.getElementById('characterImg');
            if (imgEl && imgEl.src) thumbSrc = imgEl.src;
          }
        }

        if ($thumb) {
          $thumb.src = thumbSrc || PLACEHOLDER_IMG;
        }

        // 2) ìºë¦­í„° ì´ë¦„: "ì €ì¥ëœ ìºë¦­í„°ì˜ ì§ì—…êµ° / ìºë¦­í„°ëª…"
        if ($charNm) {
          if (meta && (meta.charName || meta.jobGroup || meta.jobName)) {
            const job = meta.jobGroup || meta.jobName || '';
            const name = meta.charName || '';
            if (job && name) {
              $charNm.textContent = `${job} / ${name}`;
            } else if (name || job) {
              $charNm.textContent = name || job;
            } else {
              $charNm.textContent = 'ì €ì¥ëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            }
          } else {
            // meta ì—†ëŠ” ì˜ˆì „ í”„ë¦¬ì…‹ â†’ í˜„ì¬ ìºë¦­í„°ë¡œ fallback
            const char = (window.state && window.state.currentCharacter) || null;
            if (char && char.name) {
              const job =
                char.jobGroupLabel ||
                char.jobGroup ||
                char.jobName ||
                '';
              $charNm.textContent = job
                ? `${job} / ${char.name}`
                : char.name;
            } else {
              $charNm.textContent = 'ì €ì¥ëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
            }
          }
        }

        // 3) ìŠ¬ë¡¯ ì´ë¦„(ì‚¬ìš©ìê°€ ë¶™ì¸ ë¼ë²¨)ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        if ($userNm) {
          $userNm.textContent = info?.label || 'ì €ì¥ëœ ì´ë¦„ ì—†ìŒ';
        }

        $modal.classList.add('show');
        $modal.setAttribute('aria-hidden', 'false');
      }

      // ëª¨ë‹¬ ë‹«ê¸°
      function closePresetModal() {
        const $modal = document.getElementById('presetModal');
        if ($modal) {
          $modal.classList.remove('show');
          $modal.setAttribute('aria-hidden', 'true');
        }
        presetSlots.currentSlot = null;
      }

      // ì„œë²„ì—ì„œ í”„ë¦¬ì…‹ ëª©ë¡ ë©”íƒ€ ê°€ì ¸ì™€ì„œ ë²„íŠ¼ UI ë™ê¸°í™”
      async function refreshPresetSlotsFromServer() {
        try {
          const res = await apiJSON('fpreset_list');
          if (!res.ok) {
            console.warn('fpreset_list ì‹¤íŒ¨:', res.error || res.message);
            return;
          }

          const list = Array.isArray(res.items) ? res.items : [];

          // ğŸ”§ const presetSlots ë¥¼ ì¬í• ë‹¹í•˜ì§€ ë§ê³ , dataë§Œ ê°ˆì•„ë¼ìš´ë‹¤
          presetSlots.data = {};
          for (const it of list) {
            const key = String(it.slot);
            presetSlots.data[key] = {
              slot: it.slot,
              label: it.label || `í”„ë¦¬ì…‹ ${it.slot}`,
              savedAt: it.savedAt || null,
              meta: it.meta || null,
            };
          }

          updatePresetButtonsUI();
        } catch (err) {
          console.error('[refreshPresetSlotsFromServer] error', err);
        }
      }

      // "ì €ì¥í•˜ê¸°" ë²„íŠ¼ â†’ ì„œë²„ì— ì„¸ì…˜ ì „ì²´ ì €ì¥
      // "ì €ì¥í•˜ê¸°" ë²„íŠ¼ â†’ í”„ë¡ íŠ¸ state ì „ì²´ë¥¼ KV í”„ë¦¬ì…‹ìœ¼ë¡œ ì €ì¥
      async function handlePresetSave() {
        const slot = presetSlots.currentSlot;
        if (!slot) return;

        // ê¸°ì¡´ ì´ë¦„ ìˆìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³´ì—¬ì¤Œ
        const oldLabel = presetSlots.data[String(slot)]?.label || '';
        const input = window.prompt(
          `ìºë¦­í„° ìŠ¬ë¡¯ ${slot}ë²ˆì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.`,
          oldLabel
        );

        // ì·¨ì†Œë©´ ì•„ë¬´ ê²ƒë„ ì•ˆ í•¨
        if (input === null) return;

        const label = (input || '').trim();

        try {
          const stateSnap = buildFrontPresetState();

          const res = await apiJSON('fpreset_save', {
            slot,
            label,
            state: stateSnap,
          });

          if (!res || !res.ok) {
            alert('í”„ë¦¬ì…‹ ì €ì¥ ì‹¤íŒ¨: ' + (res?.message || res?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          // ë¡œì»¬ ìŠ¬ë¡¯ ë©”íƒ€ ê°±ì‹ 
          // ë¡œì»¬ ìŠ¬ë¡¯ ë©”íƒ€ ê°±ì‹ 
          const key = String(slot);

          // â˜… í˜„ì¬ í”„ë¡ íŠ¸ stateì—ì„œ ìºë¦­í„° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const s = window.state || {};
          const cc = s.currentCharacter || {};
          const imgEl = document.getElementById('characterImg');

          const meta = {
            charName: cc.name || '',
            jobGroup: cc.jobGroupLabel || cc.jobGroup || '',
            jobName: cc.jobName || '',
            thumb: cc.saveFace || cc.thumb || cc.full || (imgEl && imgEl.src) || '',
          };

          presetSlots.data[key] = {
            slot,
            label: res.label || label || '',
            meta,
            savedAt: res.savedAt || Date.now(),
          };


          // ëª¨ë‹¬ ë‚´ë¶€ ì´ë¦„(ë¼ë²¨) ê°±ì‹ 
          const $userNm = document.getElementById('presetUserName');
          if ($userNm) {
            $userNm.textContent = presetSlots.data[key].label || 'ì €ì¥ëœ ì´ë¦„ ì—†ìŒ';
          }

          // ì•„ë˜ 5ê°œ ìŠ¬ë¡¯ ë²„íŠ¼ UI ê°±ì‹ 
          updatePresetButtonsUI();

          alert(`ìºë¦­í„° ìŠ¬ë¡¯ ${slot}ë²ˆì— í˜„ì¬ ìŠ¤í™ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.`);
        } catch (err) {
          console.error('[fpreset_save] ì—ëŸ¬:', err);
          alert('í”„ë¦¬ì…‹ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }

      // "ë¶ˆëŸ¬ì˜¤ê¸°" ë²„íŠ¼ â†’ KVì— ì €ì¥ëœ í”„ë¡ íŠ¸ state í”„ë¦¬ì…‹ì„ ë¶ˆëŸ¬ì™€ ì ìš©
      async function handlePresetLoad() {
        const slot = presetSlots.currentSlot;
        if (!slot) return;

        if (!window.confirm(`ìºë¦­í„° ìŠ¬ë¡¯ ${slot}ë²ˆì˜ ìŠ¤í™ì„ ë¶ˆëŸ¬ì™€ í˜„ì¬ ìƒíƒœë¡œ ë®ì–´ì“¸ê¹Œìš”?`)) return;

        try {
          const res = await apiJSON('fpreset_load', { slot });

          if (!res || !res.ok) {
            alert('í”„ë¦¬ì…‹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (res?.message || res?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          const snap = res.state;
          if (!snap || typeof snap !== 'object') {
            alert('ë¶ˆëŸ¬ì˜¨ í”„ë¦¬ì…‹ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
            return;
          }

          // 1) í”„ë¡ íŠ¸ state êµì²´ + ìŠ¬ë¡¯/ìºë¦­í„° UI ë°˜ì˜
          applyFrontPresetState(snap);

          // 1-1) ìŠ¤í‚¬íŠ¸ë¦¬ í”„ë¦¬ì…‹ë„ ë°”ë¡œ ë°˜ì˜ë˜ë„ë¡, ìŠ¤í‚¬íŠ¸ë¦¬ ê·¸ë¦¬ë“œ/ë°ì´í„° ë¯¸ë¦¬ ë¡œë”©
          if (typeof renderSkillTreeBands === 'function') {
            try {
              await renderSkillTreeBands();   // ST2.rows ë¡œë“œ + state.skillLv / TP ë°˜ì˜
            } catch (e) {
              console.warn('[fpreset_load] renderSkillTreeBands ì‹¤íŒ¨:', e);
            }
          }

          alert(`ìŠ¬ë¡¯ ${slot}ì˜ í”„ë¦¬ì…‹ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        } catch (err) {
          console.error('[fpreset_load] ì—ëŸ¬:', err);
          alert('í”„ë¦¬ì…‹ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
          closePresetModal();
        }
      }

      // "ì´ˆê¸°í™”" â†’ í•´ë‹¹ ìŠ¬ë¡¯ì˜ í”„ë¦¬ì…‹ ì‚­ì œ
      // í˜„ì¬ ì„ íƒëœ í”„ë¦¬ì…‹ ìŠ¬ë¡¯ì˜ ì €ì¥ëœ ìŠ¤í™ì„ ì´ˆê¸°í™”
      async function handlePresetClear() {
        const slot = presetSlots.currentSlot;
        if (!slot) return;

        const key = String(slot);
        const info = presetSlots.data[key];
        if (!info) {
          alert('ì´ ìŠ¬ë¡¯ì—ëŠ” ì €ì¥ëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // í™•ì¸ì°½
        if (!window.confirm('ì €ì¥ëœ ìºë¦­í„° ìŠ¬ë¡¯ì„ ì´ˆê¸°í™” í•©ë‹ˆë‹¤.\n\nì •ë§ ì´ˆê¸°í™” í• ê¹Œìš”?')) {
          return;
        }

        try {
          // ì„œë²„ì— í•´ë‹¹ ìŠ¬ë¡¯ í”„ë¦¬ì…‹ ì‚­ì œ ìš”ì²­
          const res = await apiJSON('fpreset_clear', { slot });

          if (!res || !res.ok) {
            alert('í”„ë¦¬ì…‹ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + (res?.message || res?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            return;
          }

          // í”„ë¡ íŠ¸ ë©”ëª¨ë¦¬ì—ì„œ ì‚­ì œ
          delete presetSlots.data[key];

          // ì•„ë˜ í”„ë¦¬ì…‹ ìŠ¬ë¡¯ ë²„íŠ¼ë“¤ UI ê°±ì‹ 
          updatePresetButtonsUI();

          // ëª¨ë‹¬ ë‚´ ì¸ë„¤ì¼/í…ìŠ¤íŠ¸ë„ ì´ˆê¸°í™”
          const $thumb = document.getElementById('presetCharThumb');
          const $charNm = document.getElementById('presetCharName');
          const $userNm = document.getElementById('presetUserName');

          if ($thumb) {
            $thumb.src = PLACEHOLDER_IMG || '';
          }
          if ($charNm) {
            $charNm.textContent = 'ì„ íƒëœ ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
          }
          if ($userNm) {
            $userNm.textContent = 'ì €ì¥ëœ ì´ë¦„ ì—†ìŒ';
          }

          alert(`ìŠ¬ë¡¯ ${slot}ì˜ í”„ë¦¬ì…‹ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.`);
        } catch (err) {
          console.error('[fpreset_clear] ì—ëŸ¬:', err);
          alert('í”„ë¦¬ì…‹ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      }


      // === ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ìŠ¬ë¡¯ ì´ˆê¸° ë°”ì¸ë”© ===
      (function initPresetUI() {
        // ìŠ¬ë¡¯ ë²„íŠ¼ í´ë¦­ â†’ ëª¨ë‹¬ ì˜¤í”ˆ
        document
  .querySelectorAll('.save-box .preset-btn[data-slot]')
  .forEach((btn) => {
    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      const slot = Number(btn.dataset.slot || '0');
      if (!slot) return;
      openPresetModal(slot);
    });
  });

        // íœ´ì§€í†µ ë²„íŠ¼ í´ë¦­ â†’ ìŠ¬ë¡¯ ì´ˆê¸°í™”
        document
          .querySelectorAll('.save-box .preset-trash[data-slot]')
          .forEach((btn) => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation(); // ë©”ì¸ ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ë²ˆì§€ëŠ” ê²ƒ ë°©ì§€
              const slot = Number(btn.dataset.slot || '0');
              if (!slot) return;
              handlePresetClear(slot);
            });
          });

        // ëª¨ë‹¬ ë‹«ê¸°
        document
          .querySelectorAll('[data-preset-close]')
          .forEach((el) => {
            el.addEventListener('click', () => {
              closePresetModal();
            });
          });

        // ëª¨ë‹¬ ë‚´ "ì €ì¥í•˜ê¸°" / "ë¶ˆëŸ¬ì˜¤ê¸°"
        document.getElementById('btnPresetSave')?.addEventListener('click', () => {
          handlePresetSave();   // âœ… íŒŒë¼ë¯¸í„° ì—†ì´
        });

        document.getElementById('btnPresetClear')?.addEventListener('click', () => {
          handlePresetClear();
        });

        document.getElementById('btnPresetLoad')?.addEventListener('click', () => {
          handlePresetLoad();   // âœ… íŒŒë¼ë¯¸í„° ì—†ì´
        });
        // âœ… í˜ì´ì§€ ë²„íŠ¼
document.getElementById('presetPagePrev')?.addEventListener('click', () => setPresetPage(presetPage - 1));
document.getElementById('presetPageNext')?.addEventListener('click', () => setPresetPage(presetPage + 1));

applyPresetPageToDom();
        // í˜ì´ì§€ ë¡œë”© ì‹œ ì„œë²„ì— ìˆëŠ” í”„ë¦¬ì…‹ ë©”íƒ€ ë™ê¸°í™”
        refreshPresetSlotsFromServer();
      })();



      // ì „ì—­ 1ì¤„(íŒŒì¼ ì–´ë”˜ê°€ ìƒë‹¨): ìµœì‹  í˜¸ì¶œë§Œ ë°˜ì˜í•˜ê¸° ìœ„í•œ ì‹œí€€ìŠ¤
      window.__computeReqSeq = 0;

      // â˜… calc_all + compute ê¸°ë°˜ ìµœì¢… ê³„ì‚°
      async function computeViaBackend(targetId, p /* 'phys' | 'mag' ìƒëµ ê°€ëŠ¥ */) {
        const box = document.getElementById(targetId);
        const btns = document.querySelectorAll('[data-compute-btn]');

        try {
          // ë²„íŠ¼ ì ê¸ˆ + UI ë¡œë”© ìƒíƒœ
          btns.forEach(b => b.disabled = true);
          if (box) {
            box.textContent = 'ê³„ì‚°ì¤‘ì…ë‹ˆë‹¤â€¦';
            box.classList.add('loading');
          }

          let id_token = await waitForIdToken();

          // 1) ìºë¦­í„° payload êµ¬ì„± ë° ì²´í¬
          const char = state.currentCharacter || {};
          if (!char || !char.name) {
            throw new Error('ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
          }

          const charPayload = {
            name: char.name,
            jobGroup: char.jobGroupLabel || char.jobGroup || '',
            sp: Number(char.sp ?? 0),
            tp: Number(char.tp ?? 0),
            power: char.power || 'physical',
          };

          // 2) ì¥ë¹„ ìŠ¤ëƒ…ìƒ·(equip) payload êµ¬ì„±
          const equipPayload = {};
          const sel = state.selections || {};
          for (const [slotKey, info] of Object.entries(sel)) {
            if (!info || !info.name) continue;
            equipPayload[slotKey] = {
              name: info.name,
              code: info.code || '',
              // img ê°™ì€ ë‹¤ë¥¸ í•„ë“œëŠ” ë°±ì—”ë“œì—ì„œ ì•ˆ ì“°ë‹ˆ í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ì¶”ê°€
            };
          }

          // 2-1) ê°•í™”(enh) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„± (state.upgrades â†’ payload.enh)
          const enhPayload = {};
          const ups = state.enh || {};
          for (const [slotKey, up] of Object.entries(ups)) {
            if (!up || !up.name) continue;
            enhPayload[slotKey] = {
              name: up.name,
              // ì¢…ë¥˜(type)ëŠ” ì‹œíŠ¸ ìƒì˜ íƒ€ì…(ì˜ˆ: 'ë¬´ê¸°', 'ë°©ì–´êµ¬' ë“±)ì´ë©´ ì‚¬ìš©,
              // ì—†ìœ¼ë©´ ë‚˜ì¤‘ì— ìŠ¬ë¡¯ì½”ë“œë¡œ ì„œë²„ì—ì„œ ìœ ì¶” ê°€ëŠ¥í•˜ë‹ˆ ë¹ˆ ë¬¸ìì—´ í—ˆìš©
              type: up.type || '',
              level: up.level ?? null,   // â˜… ì—¬ê¸° ì¶”ê°€
            };
          }

          // 2-2) ë§ˆë²•ë´‰ì¸(seals) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„± (state.seals â†’ payload.seals)
          const sealPayload = {};
          const seals = state.seals || {};
          for (const [slotKey, sv] of Object.entries(seals)) {
            if (!sv) continue;
            const uniqueName = sv.unique?.name || '';
            const general1Name = sv.general1?.name || '';
            if (!uniqueName && !general1Name) continue;

            sealPayload[slotKey] = {
              unique: uniqueName || null,
              general1: general1Name || null,
            };
          }

          // 2-3) ë§ˆë²•ë¶€ì—¬(enchant) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const enchantPayload = {};
          const enchants = state.enchants || {};
          for (const [key, eInfo] of Object.entries(enchants)) {
            if (!eInfo || !eInfo.name) continue;

            // keyëŠ” ì´ë¯¸ serverSlot(weapon, top, ...)ìœ¼ë¡œ ì €ì¥í–ˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì¨ë„ ë˜ê³ ,
            // í˜¹ì‹œ ëª°ë¼ í•œ ë²ˆ ë” ì •ê·œí™”
            const serverSlot = (typeof slotCodeToServerSlot === 'function')
              ? slotCodeToServerSlot(key)
              : key;

            enchantPayload[serverSlot] = {
              name: eInfo.name,
              enchType: eInfo.typeKey || eInfo.enchType || '',   // ì„œë²„ì—ì„œ 'ì¢…ë¥˜' ì»¬ëŸ¼ê³¼ ë§¤ì¹­ìš©
            };
          }

          // 2-4) ì— ë¸”ë ˜(emblem) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const emblemPayload = {};
          const emState = state.emblems || {};
          for (const [slotKey, arr] of Object.entries(emState)) {
            if (!Array.isArray(arr)) continue;

            // ìŠ¬ë¡¯ ë‚´ ì†Œì¼“ë³„ ìŠ¤ëƒ…ìƒ· (ì—†ìœ¼ë©´ null)    ì„œë²„ë¡œ ë„˜ê²¨ì£¼ëŠ” ì»¬ëŸ¼ ëª©ë¡
            const mapped = arr.map(e => {
              if (!e || !e.name) return null;
              return {
                name: e.name,
                levelVal: e.levelVal,
                type: e.type
              };
            });

            // ìµœì†Œ í•˜ë‚˜ë¼ë„ ìœ íš¨í•œ ì— ë¸”ë ˜ì´ ìˆìœ¼ë©´ ì „ì†¡
            if (mapped.some(x => x)) {
              emblemPayload[slotKey] = mapped;
            }
          }

          // 2-5) ì—°ë§ˆ(refine) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const refinePayload = {};
          const refState = state.refines || {};
          for (const [slotKey, info] of Object.entries(refState)) {
            if (!info || !info.name) continue;
            refinePayload[slotKey] = {
              name: info.name,
              refineType: info.refineType || '',
            };
          }

          // 2-6) ìŠ¤í‚¬ë£¬(runes) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const runesPayload = (() => {
            const runesState = state.runes || state.skillrune || null;
            if (!runesState) return null;
            return runesState;   // ê·¸ëŒ€ë¡œ ì„œë²„ë¡œ ë„˜ê²¨ì„œ calc_allì—ì„œ ì²˜ë¦¬
          })();

          // 2-6) ë£¬ ê°ì¸ ì„ íƒ ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const runeEngravePayload = (() => {
            const re = state.runeEngrave || state.runeengrave || null;
            const runeName = re?.name ? String(re.name).trim() : '';
            const runeLevel = re?.level ? String(re.level).trim() : '';
            if (!runeName || !runeLevel) return null;

            return {
              type: 'ë£¬ê°ì¸',
              name: runeName,
              level: runeLevel,
            };
          })();

          // 2-6) ì•„ë°”íƒ€ / ë¬´ê¸°ì•• ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const avatarPayload = (() => {
            const a = state.avatar || {};
            const out = {};
            if (a.avatarName) {
              out.avatarName = String(a.avatarName).trim();
            }
            if (a.imprintName) {
              out.imprintName = String(a.imprintName).trim();
            }
            return out;
          })();

          // 2-7) ì»¤ìŠ¤í…€ì˜µ(customSkills) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const customSkillsPayload = state.customSkills || null;

          // 2-8) íŠ¹ìˆ˜ ìŠ¤í‚¬ë£¬(ê°€í˜¸/ì§€í˜œ/ì™œê³¡) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const specialRunesPayload = state.specialRunes || null;

          // 2-8) ì„±ì•ˆì˜ ë´‰ì¸(castleSeal) ìŠ¤ëƒ…ìƒ· payload êµ¬ì„±
          const castleSealState = state.castleSeal || state.CastleSeal || null;
          let castleSealPayload = null;
          if (castleSealState) {
            const mainName = castleSealState.main?.name || castleSealState.main || '';
            const subName = castleSealState.sub?.name || castleSealState.sub || '';
            if (mainName || subName) {
              castleSealPayload = { mainName, subName };
            }
          }

          // 3) ìµœì¢… payload êµ¬ì„±
          const payload = { char: charPayload };
          if (Object.keys(equipPayload).length > 0) {
            payload.equip = equipPayload;
          }
          if (Object.keys(enhPayload || {}).length > 0) {
            payload.enh = enhPayload;
          }
          if (Object.keys(sealPayload || {}).length > 0) {
            payload.seals = sealPayload;
          }
          if (Object.keys(enchantPayload || {}).length > 0) {
            payload.enchants = enchantPayload;   // â˜… ì¶”ê°€
          }
          if (Object.keys(emblemPayload || {}).length > 0) {
            payload.emblems = emblemPayload;   // â˜… ì— ë¸”ë ˜ ì¶”ê°€
          }
          if (Object.keys(refinePayload || {}).length > 0) {
            payload.refines = refinePayload;   // â˜… ì—°ë§ˆ ì¶”ê°€
          }
          // â˜… ì•„ë°”íƒ€/ë¬´ê¸°ì•• payload ì¶”ê°€
          if (avatarPayload && (avatarPayload.avatarName || avatarPayload.imprintName)) {
            payload.avatar = avatarPayload;
          }
          // â˜… ì»¤ìŠ¤í…€ì˜µì€ ê°ì²´ ìì²´ë¥¼ ê·¸ëŒ€ë¡œ ì „ì†¡
          if (customSkillsPayload) {
            payload.customSkills = customSkillsPayload;
          }
          // â˜… íŠ¹ìˆ˜ ìŠ¤í‚¬ë£¬(ê°€í˜¸/ì§€í˜œ/ì™œê³¡) ì¹´ìš´íŠ¸ ì „ì†¡
          if (specialRunesPayload) {
            const g = Number(specialRunesPayload.gaho || 0) || 0;
            const j = Number(specialRunesPayload.jihe || 0) || 0;
            const w = Number(specialRunesPayload.waegok || 0) || 0;

            // ì „ë¶€ 0ì´ë©´ êµ³ì´ ì•ˆ ë³´ëƒ„
            if (g || j || w) {
              payload.specialRunes = { gaho: g, jihe: j, waegok: w };
            }
          }
          // â˜… ì„±ì•ˆì˜ ë´‰ì¸ ì„ íƒ ì‚¬í•­
          if (castleSealPayload) {
            payload.castleSeal = castleSealPayload;
          }

          // â˜… ì¼ë°˜ ìŠ¤í‚¬ë£¬ payload
          if (runesPayload) {
            payload.runes = runesPayload;
          }

          // â˜… ë£¬ ê°ì¸ payload
          if (runeEngravePayload) {
            payload.runeEngrave = runeEngravePayload;
          }

          // 3) calc_all: ìºë¦­í„° + ì¥ë¹„ë¥¼ ì„¸ì…˜ì— ë°˜ì˜
          async function callCalcAllOnce(token) {
            return fetch(`${WEBAPP_URL}?type=calc_all`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id_token: token,
                payload,
                p: p || null,
              }),
            }).then(r => r.json());
          }

          let resCalc = await callCalcAllOnce(id_token);

          // ğŸ”„ í† í° ë§Œë£Œ(401)ì¸ ê²½ìš°: í•œ ë²ˆë§Œ ìë™ ì¬ë¡œê·¸ì¸ í›„ ì¬ì‹œë„
          if (
            !resCalc?.ok &&
            resCalc?.code === 401 &&
            (resCalc?.error === 'invalid token' ||
              resCalc?.error === 'token_verify_fail' ||
              resCalc?.error === 'missing token')
          ) {
            try {
              const newToken = await forceReissueIdToken();
              if (newToken) {
                id_token = newToken;
                resCalc = await callCalcAllOnce(id_token);
              }
            } catch (reErr) {
              toast('ë¡œê·¸ì¸ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në¡œê·¸ì¸ í™”ë©´ì—ì„œ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
              throw new Error('login_expired');
            }
          }

          if (!resCalc?.ok) {
            throw new Error(resCalc?.message || resCalc?.error || 'calc_all_failed');
          }



          // 4) í•©ì‚°/íŒ¨ë„ ê°±ì‹  (sum_stats ë¶„ê¸° ì‚¬ìš©)
          if (typeof recalcAndRenderPanel === 'function') {
            try {
              await recalcAndRenderPanel();
            } catch (e) {
              console.warn('[computeViaBackend] recalcAndRenderPanel ì‹¤íŒ¨:', e);
            }
          }

          await saveSkillSelections();
          await simulateSkillUsage();

          // 5) ìµœì¢… ë°ë¯¸ì§€ ê³„ì‚° (compute ë¶„ê¸° í˜¸ì¶œ)
          const monster = state.monster || null;   // { name } í˜•íƒœ
          const timeKey = (typeof getTimeKey === 'function'
            ? getTimeKey()
            : '1m');   // í˜¹ì‹œ ëª°ë¼ì„œ ê¸°ë³¸ê°’ 1ë¶„

          async function callComputeOnce(token) {
            return fetch(`${WEBAPP_URL}?type=compute`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id_token: token,
                p: p || null,
                monster,
                window: timeKey,
              }),
            }).then(r => r.json());
          }

          let resCompute = await callComputeOnce(id_token);

          // calc_all ì´í›„ì—ë¼ë„ í† í°ì´ ë§Œë£Œë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ í•œ ë²ˆ ë” ë°©ì–´
          if (
            !resCompute?.ok &&
            resCompute?.code === 401 &&
            (resCompute?.error === 'invalid token' ||
              resCompute?.error === 'token_verify_fail' ||
              resCompute?.error === 'missing token')
          ) {
            try {
              const newToken2 = await forceReissueIdToken();
              if (newToken2) {
                id_token = newToken2;

                // ìƒˆ í† í° ì„¸ì…˜ì—ëŠ” ìºë¦­/ì¥ë¹„ ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ calc_allë¶€í„° ë‹¤ì‹œ í•œ ë²ˆ
                const resCalc2 = await callCalcAllOnce(id_token);
                if (!resCalc2?.ok) {
                  throw new Error(resCalc2?.message || resCalc2?.error || 'calc_all_failed');
                }

                resCompute = await callComputeOnce(id_token);
              }
            } catch (reErr) {
              toast('ë¡œê·¸ì¸ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\në¡œê·¸ì¸ í™”ë©´ì—ì„œ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
              throw new Error('login_expired');
            }
          }

          if (!resCompute?.ok) {
            throw new Error(resCompute?.message || resCompute?.error || 'compute_failed');
          }

          const total = Number(resCompute.total || 0);

// ğŸ”¹ ê³ ìœ íš¨ê³¼ í† ê¸€(ON)ì¼ ë•Œë§Œ 'ê³„ì‚°ê°’' ì‹œíŠ¸ì— ë¡œê·¸ ì ì¬
try {
  if (window.state && window.state.uniqueOnOff) {
    // 1) ì¥ë¹„ í”„ë¦¬ë·° ìµœì‹ í™” (ì„¸íŠ¸ ì •ë³´ ì •í™•íˆ ë½‘ê¸° ìœ„í•¨)
    if (typeof updateEquipDescPreview === 'function') {
      try { updateEquipDescPreview(); } catch (e) {
        console.warn('[computeViaBackend] updateEquipDescPreview ì‹¤íŒ¨:', e);
      }
    }

    const s = window.state || {};

    // 2) ê¸°ë³¸ ì •ë³´: ìºë¦­í„° / ë¬´ê¸° / ë¬´ê¸° ê³ ìœ íš¨ê³¼
    const charName = (s.currentCharacter?.name || '').trim();

    // ë¬´ê¸° ì´ë¦„
    let weaponName = '';
    try {
      if (typeof getCurrentWeaponName === 'function') {
        weaponName = getCurrentWeaponName();
      }
    } catch (_) {}

    // ë¬´ê¸° ê³ ìœ íš¨ê³¼ (ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…/ì—†ìŒ ë“±)
    const weaponUnique = (s.customSkills?.type || '').trim();

    // íŒ”ì°Œ ê³ ìœ íš¨ê³¼ (ì„ ë´‰/ì˜ì§€/ì´ìƒ/ì—†ìŒ ë“±)
    const braceletUnique = (
      (s.customSkills?.braceletType) ||
      s.customBraceletLabel ||
      ''
    ).trim();

    // 3) ì„¸íŠ¸ ì´ë¦„ë“¤ (ë°©ì–´êµ¬ / ì•…ì„¸ / íŠ¹ìˆ˜) - í”„ë¦¬ë·°ì—ì„œ ì¶”ì¶œ
    let armorSet = '';
    let accSet   = '';
    let specSet  = '';
    try {
      const sets = getCurrentSetSummaryFromPreview();
      armorSet = sets.armorSet || '';
      accSet   = sets.accSet   || '';
      specSet  = sets.specSet  || '';
    } catch (e) {
      console.warn('[computeViaBackend] getCurrentSetSummaryFromPreview ì‹¤íŒ¨:', e);
    }

        // 4) ê°ì„±ë£¬ ì •ë³´ (H: ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” ê°ì„±ë£¬ ë ˆë²¨, I: ê·¸ ê°œìˆ˜)
    let awakeningRuneLevel = '';
    let awakeningRuneCount = 0;
    try {
      const runes = s.runes || s.skillrune || null;
      const awak = runes?.awakening || {};
      const levels = Object.keys(awak)
        .map(k => Number(k))
        .filter(n => Number.isFinite(n) && n > 0);

      if (levels.length > 0) {
        // ë ˆë²¨ë³„ ê°œìˆ˜ ì¤‘ ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë ˆë²¨ ì°¾ê¸°
        let bestLevel = levels[0];
        let bestCount = Number(awak[bestLevel] || 0) || 0;

        for (const lvl of levels) {
          const c = Number(awak[lvl] || 0) || 0;
          // ë” ë§ì´ ì‚¬ìš©í•œ ë ˆë²¨ì´ ìš°ì„ , ë™ë¥ ì´ë©´ ë ˆë²¨ì´ ë” ë†’ì€ ìª½ ì„ íƒ
          if (c > bestCount || (c === bestCount && lvl > bestLevel)) {
            bestLevel = lvl;
            bestCount = c;
          }
        }

        awakeningRuneLevel = String(bestLevel); // ì˜ˆ: "65"
        awakeningRuneCount = bestCount;         // í•´ë‹¹ ë ˆë²¨ì˜ ê°œìˆ˜
      }
    } catch (e) {
      console.warn('[computeViaBackend] ê°ì„±ë£¬ ì •ë³´ ì¶”ì¶œ ì‹¤íŒ¨:', e);
    }


    // 5) ë£¬ ê°ì¸ ì„¤ì • (ì˜ˆ: "ê°€í˜¸ 3", "ì§€í˜œ 2" ë“±)
    let runeEngrave = '';
    try {
      const re = s.runeEngrave || {};
      const nm = (re.name || '').trim();
      const lv = (re.level || '').trim();
      if (nm && lv) runeEngrave = `${nm} ${lv}`;
      else runeEngrave = nm || lv || '';
    } catch (e) {
      console.warn('[computeViaBackend] ë£¬ê°ì¸ ì •ë³´ ì¶”ì¶œ ì‹¤íŒ¨:', e);
    }

    // 6) TPë¥¼ 5ë¡œ ë„£ì€ ìŠ¤í‚¬ ì´ë¦„ (ìµœëŒ€ 3ê°œ)
    let tpSkill1 = '', tpSkill2 = '', tpSkill3 = '';
    try {
      const tpMap = s.skillTpLv || {};
      const skillIds = Object.keys(tpMap).filter(id => Number(tpMap[id]) === 5);

      const names = [];
      for (const skillId of skillIds) {
        const tile = document.querySelector(`.st2-tile[data-skill-id="${skillId}"]`);
        if (!tile) continue;
        const nameEl = tile.querySelector('.st2-name');
        const nm = (nameEl?.textContent || '').trim();
        if (!nm) continue;
        names.push(nm);
        if (names.length >= 3) break;
      }

      tpSkill1 = names[0] || '';
      tpSkill2 = names[1] || '';
      tpSkill3 = names[2] || '';
    } catch (e) {
      console.warn('[computeViaBackend] TP5 ìŠ¤í‚¬ëª… ì¶”ì¶œ ì‹¤íŒ¨:', e);
    }

    // 7) ë°±ì—”ë“œ log_damage í˜¸ì¶œ
    try {
      await apiJSON('log_damage', {
        charName,
        weaponName,
        weaponUnique,
        armorSet,
        accSet,
        specSet,
        braceletUnique,
        awakeningRuneLevel,
        awakeningRuneCount,
        runeEngrave,
        tpSkill1,
        tpSkill2,
        tpSkill3,
        damage: total,
      });
    } catch (e) {
      console.warn('[computeViaBackend] log_damage í˜¸ì¶œ ì‹¤íŒ¨:', e);
    }
  }
} catch (e) {
  console.warn('[computeViaBackend] damage log wrapper ì‹¤íŒ¨:', e);
}


          if (box) {
            const n = Math.floor(total || 0).toLocaleString();
            box.textContent = n;
            box.classList.remove('loading');
          }
        } catch (e) {
          console.error('[computeViaBackend / calc_all+compute]', e);
          if (box) {
            const msg = String(e?.message || e || '');

            if (msg.includes('ìºë¦­í„°ë¥¼ ë¨¼ì €')) {
              // ìºë¦­í„° ë¯¸ì„ íƒ ì—ëŸ¬ëŠ” ê·¸ëŒ€ë¡œ
              box.textContent = e.message;
            } else if (msg.includes('login_expired') || msg.includes('login_timeout') || msg.includes('relogin_timeout')) {
              // ë¡œê·¸ì¸ ê´€ë ¨ ì—ëŸ¬ëŠ” ë³„ë„ ì•ˆë‚´
              box.textContent = 'ë¡œê·¸ì¸ ì‹œê°„ ë§Œë£Œ';
              if (typeof toast === 'function') {
                toast('ë¡œê·¸ì¸ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í›„ ê³„ì‚°ì„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
              }
            } else {
              box.textContent = 'ê³„ì‚° ì‹¤íŒ¨';
            }

            box.classList.remove('loading');
          }
        } finally {

          btns.forEach(b => b.disabled = false);
        }
      }

      // ğŸ”¹ í˜„ì¬ ì¥ë¹„ ì„ íƒ ìƒíƒœë¥¼ ì–•ì€ ë³µì‚¬
function cloneSelections(sel) {
  const out = {};
  for (const [slot, info] of Object.entries(sel || {})) {
    out[slot] = info ? { ...info } : null;
  }
  return out;
}

// ğŸ”¹ ë°±ì—…í•´ ë‘” ì¥ë¹„ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
async function restoreSelections(selBackup) {
  state.selections = {};
  if (!selBackup) return;

  for (const [slotKey, info] of Object.entries(selBackup)) {
    if (!info || !info.name) continue;
    await applyItemToSlot(slotKey, info);
  }
}

function filterSetsForAutoSweep(sets, nameList) {
  if (!Array.isArray(sets) || !sets.length) return [];
  if (!Array.isArray(nameList) || !nameList.length) return [];

  const nameSet = new Set(
    nameList.map(v => String(v ?? '').trim())
  );

  return sets.filter(set => nameSet.has(String(set.name || '').trim()));
}

let isAutoSetSweepRunning = false;

// ğŸ” ë‚´ê°€ ì§€ì •í•œ ì„¸íŠ¸ë“¤ë§Œ ëŒë ¤ì„œ ê³„ì‚°ê°’ ì‹œíŠ¸ì— ì¤„ì¤„ì´ ê¸°ë¡
async function runAutoSetSweepSelected(targetId, p /* 'phys' | 'mag' ìƒëµ ê°€ëŠ¥ */) {
  if (isAutoSetSweepRunning) return;
  isAutoSetSweepRunning = true;

  const originalSel = cloneSelections(state.selections || {});

  try {
    // 1) ì„¸íŠ¸ ì¹´ë“œ ëª©ë¡ í™•ë³´
    let armorSets = getArmorSetListForSweep();
let accSets   = getAccSetListForSweep();
let specSets  = getSpecSetListForSweep();

// ğŸ”¹ state.autoSweep ì— ë“¤ì–´ìˆëŠ” ì„¸íŠ¸ ì´ë¦„ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
const auto = state.autoSweep || { armor: [], acc: [], spec: [], weapon: [], weaponCustom: [] };

armorSets = filterSetsForAutoSweep(armorSets, auto.armor);
accSets   = filterSetsForAutoSweep(accSets,   auto.acc);
specSets  = filterSetsForAutoSweep(specSets,  auto.spec);

if (!armorSets.length && !accSets.length && !specSets.length) {
  alert('ìë™ê³„ì‚°ì— ì‚¬ìš©í•  ì„¸íŠ¸ê°€ ì„ íƒë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\nì„¸íŠ¸ ì„ íƒ ëª¨ë‹¬ì—ì„œ ìë™ê³„ì‚° ëŒ€ìƒì„ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
  return;
}

    // 3) ì–´ë–¤ ì¶•ì´ ë¹„ì–´ ìˆìœ¼ë©´ ê·¸ ì¶•ì€ "í˜„ì¬ ì¥ë¹„ ìœ ì§€"ë¡œ ë‘ 
    const armorLoop = armorSets.length ? armorSets : [null];
    const accLoop   = accSets.length   ? accSets   : [null];
    const specLoop  = specSets.length  ? specSets  : [null];

    // 4) 3ì¤‘ ë£¨í”„: (ì§€ì •í•œ ë°©ì–´êµ¬ Ã— ì§€ì •í•œ ì•…ì„¸ Ã— ì§€ì •í•œ íŠ¹ìˆ˜)
    for (const armor of armorLoop) {
      if (armor) await applyArmorSetToSlots(armor);

      for (const acc of accLoop) {
        if (acc) await applyAccSetToSlots(acc);

        for (const spec of specLoop) {
          if (spec) await applySpecSetToSlots(spec);

          // ğŸ‘‰ ê° ì¡°í•©ë§ˆë‹¤ ìµœì¢… ê³„ì‚° + log_damage â†’ ê³„ì‚°ê°’ ì‹œíŠ¸ì— 1ì¤„ì”© ê¸°ë¡
          await computeViaBackend(targetId, p);
        }
      }
    }
  } catch (e) {
    console.warn('[runAutoSetSweepSelected] ì‹¤íŒ¨:', e);
  } finally {
    // 5) ì›ë˜ ì¥ë¹„ ë³µì›
    try {
      await restoreSelections(originalSel);
    } catch (e2) {
      console.warn('[runAutoSetSweepSelected] ì›ë˜ ì¥ë¹„ ë³µì› ì‹¤íŒ¨:', e2);
    }
    isAutoSetSweepRunning = false;
  }
}

function _comboKey(a, b, c) {
  return `${String(a ?? '').trim()}||${String(b ?? '').trim()}||${String(c ?? '').trim()}`;
}

// âœ… ë°©ì–´êµ¬(ì„ íƒí•œ ê²ƒ)ëŠ” ê³ ì •ìœ¼ë¡œ ë‘ê³ , ì•…ì„¸/íŠ¹ìˆ˜ì—ì„œ "ê³„ì‚°ê°’ ì‹œíŠ¸ì— ì—†ëŠ” ì¡°í•©ë§Œ" ì¬ê³„ì‚°
async function runAutoSetSweepMissingArmorFixed(targetId, p) {
  if (isAutoSetSweepRunning) return;
  isAutoSetSweepRunning = true;

  // 0) ì›ë˜ ì¥ë¹„ ë°±ì—…
  const originalSel = cloneSelections(state.selections || {});

  try {
    const auto = state.autoSweep || (state.autoSweep = { armor: [], acc: [], spec: [], weapon: [], weaponCustom: [] });

    // 1) ì„¸íŠ¸ í›„ë³´ ë¦¬ìŠ¤íŠ¸
    let armorSets = filterSetsForAutoSweep(getArmorSetListForSweep(), auto.armor);
    let accSets   = filterSetsForAutoSweep(getAccSetListForSweep(),   auto.acc);
    let specSets  = filterSetsForAutoSweep(getSpecSetListForSweep(),  auto.spec);

    if (!armorSets.length) {
      if (typeof toast === 'function') toast('ë°©ì–´êµ¬ ìë™ê³„ì‚° ëŒ€ìƒì´ ì„ íƒë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }

    const armorNames = armorSets.map(x => String(x?.name || '').trim()).filter(Boolean);

    // ì•…ì„¸/íŠ¹ìˆ˜ ë‘˜ ë‹¤ ë¹„ë©´ â€œëˆ„ë½â€ì„ ë§Œë“¤ ì¡°í•© ìì²´ê°€ ì—†ìŒ
    if (!accSets.length && !specSets.length) {
      if (typeof toast === 'function') toast('ì•…ì„¸/íŠ¹ìˆ˜ ìë™ê³„ì‚° ëŒ€ìƒì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
      return;
    }

    // 2) í˜„ì¬ ìºë¦­/ë¬´ê¸° (log_damageì™€ ê°™ì€ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§)
    const s = window.state || {};
    const charName = String(s.currentCharacter?.name || '').trim();
    const weaponName = (typeof getCurrentWeaponName === 'function')
  ? getCurrentWeaponName()
  : String(s?.selections?.weapon?.name || '').trim();

    if (!charName) {
      if (typeof toast === 'function') toast('ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
      return;
    }

    // 3) ê³„ì‚°ê°’ ì‹œíŠ¸ì— ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¡°í•©í‚¤(ë‚´ê³„ì • + char/weapon + armor filter)
    let existing = new Set();
    const scan = await apiJSON('log_damage_scan', { armorSets: armorNames });
    const keys = Array.isArray(scan?.keys) ? scan.keys : [];
    existing = new Set(keys);

    console.log('[scan]', { armorNamesCount: armorNames.length, keys: keys.length });

    // 4) ë£¨í”„ ì¤€ë¹„
    const accLoop = accSets.length ? accSets : [null];   // ë¹„ì—ˆìœ¼ë©´ í˜„ì¬ ì•…ì„¸ ìœ ì§€
    const specLoop = specSets.length ? specSets : [null];// ë¹„ì—ˆìœ¼ë©´ í˜„ì¬ íŠ¹ìˆ˜ ìœ ì§€

    // nullì¼ ë•Œ ì“¸ â€œí˜„ì¬ ì„¸íŠ¸ëª…â€ ìŠ¤ëƒ…ìƒ·
    updateEquipDescPreview?.();
    const baseSummary = (typeof getCurrentSetSummaryFromPreview === 'function')
      ? (getCurrentSetSummaryFromPreview() || {})
      : {};
    const baseAccName = String(baseSummary.accSet || '').trim();
    const baseSpecName = String(baseSummary.specSet || '').trim();

    let did = 0;
    let skipped = 0;

    for (const armor of armorSets) {
      // âœ… ë°©ì–´êµ¬ëŠ” ì´ ë£¨í”„ì—ì„œë§Œ ë°”ë€œ(ê³ ì •ì¶•)
      await applyArmorSetToSlots(armor);
      const armorName = String(armor?.name || '').trim();

      for (const acc of accLoop) {
        if (acc) await applyAccSetToSlots(acc);
        const accName = acc ? String(acc?.name || '').trim() : baseAccName;

        for (const spec of specLoop) {
          if (spec) await applySpecSetToSlots(spec);
          const specName = spec ? String(spec?.name || '').trim() : baseSpecName;

          const key = _comboKey(armorName, accName, specName);
          if (existing.has(key)) { skipped++; continue; }
          existing.add(key);

          await computeViaBackend(targetId, p);
          did++;

          if (did % 10 === 0 && typeof toast === 'function') {
            toast(`ëˆ„ë½ ì¬ê³„ì‚° ì§„í–‰ì¤‘â€¦ (ì‹ ê·œ ${did} / ê±´ë„ˆëœ€ ${skipped})`);
          }
        }
      }
    }

    if (typeof toast === 'function') {
      toast(`ëˆ„ë½ ì¬ê³„ì‚° ì™„ë£Œ âœ… (ì‹ ê·œ ${did} / ê±´ë„ˆëœ€ ${skipped})`);
    }
  } catch (e) {
    console.warn('[runAutoSetSweepMissingArmorFixed] ì‹¤íŒ¨:', e);
  } finally {
    try { await restoreSelections(originalSel); } catch (e2) {}
    isAutoSetSweepRunning = false;
  }
}

async function runAutoWeaponCustomSweepSelected(targetId) {
  const auto = state.autoSweep || (state.autoSweep = { armor:[], acc:[], spec:[], weapon:[], weaponCustom:[] });

  const weaponNames = Array.isArray(auto.weapon) ? auto.weapon.slice() : [];
  const customTypes = Array.isArray(auto.weaponCustom) ? auto.weaponCustom.slice() : [];

  // ë¹„ì–´ìˆìœ¼ë©´ â€œí˜„ì¬ ìƒíƒœâ€ë¼ë„ 1íšŒëŠ” ëŒê²Œ ì²˜ë¦¬
  const curWeaponName = (typeof getCurrentWeaponName === 'function') ? getCurrentWeaponName() : '';
  if (!weaponNames.length && curWeaponName) weaponNames.push(curWeaponName);

  const curType = String(state?.customSkills?.type || '').trim();
  if (!customTypes.length) customTypes.push(curType || 'ì—†ìŒ');

  if (!weaponNames.length) {
    toast('ìë™ê³„ì‚° ëŒ€ìƒ ë¬´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. (ë¬´ê¸° ëª©ë¡ì—ì„œ Shift/Ctrl í´ë¦­ìœ¼ë¡œ ì¶”ê°€)');
    return;
  }

  // â˜… ì›ë³µ ìŠ¤ëƒ…ìƒ·
  const backupSelections = (typeof cloneSelections === 'function')
  ? cloneSelections(state.selections || {})
  : JSON.parse(JSON.stringify(state.selections || {}));
  const backupCustom = state.customSkills ? JSON.parse(JSON.stringify(state.customSkills)) : null;

  try {
    // ë¬´ê¸° ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ë³´ì¥ (ìºë¦­ jobGroup í•„ìš”)
    const jobGroup = state?.char?.jobGroup || state?.Char?.jobGroup || state?.CharStats?.jobGroup || '';
    if (typeof ensureEquipListLoaded === 'function') {
      await ensureEquipListLoaded('weapon', jobGroup);
    }

    // ë¬´ê¸° row ì°¾ê¸° helper
    const findWeaponRowByName = (name) => {
      if (typeof getItemsForSlot === 'function') {
        const items = getItemsForSlot('weapon', jobGroup) || [];
        const key = String(name || '').trim();
        return items.find(it => String(it?.name || '').trim() === key) || null;
      }
      return null;
    };

    // UI ì—…ë°ì´íŠ¸ helper (btnCustomOpt ë¼ë²¨/ìƒ‰ ë§ì¶”ê¸°)
    const syncWeaponCustomButtonUI = (picked) => {
      const btn = document.getElementById('btnCustomOpt');
      if (!btn) return;

      // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
      btn.classList.remove('customopt-ê°•íƒ€', 'customopt-ê´‘ì±„', 'customopt-ë¶„ì‡„', 'customopt-ì„ ëª…', 'customopt-none');

      const p = (picked === '' ? 'ì—†ìŒ' : picked);
      btn.textContent = `ë¬´ê¸° ì»¤ìŠ¤í…€: ${p || 'ì—†ìŒ'}`;
      if (!p || p === 'ì—†ìŒ') btn.classList.add('customopt-none');
      else btn.classList.add(`customopt-${p}`);
    };

    for (const wName of weaponNames) {
      const row = findWeaponRowByName(wName);
      if (!row) {
        console.warn('[autoWeaponSweep] weapon not found:', wName);
        continue;
      }

      // 1) ë¬´ê¸° ì ìš©
      if (typeof applyItemToSlot === 'function') {
        await applyItemToSlot('weapon', row);
      } else {
        // fallback
        state.selections = state.selections || {};
        state.selections.weapon = row;
      }

      for (const tRaw of customTypes) {
        const t = (tRaw === '' ? 'ì—†ìŒ' : String(tRaw || '').trim()) || 'ì—†ìŒ';

        // 2) ë¬´ê¸° ê³ ìœ íš¨ê³¼(ì»¤ìŠ¤í…€ì˜µ) ì ìš©: state.customSkillsì—ë§Œ ì €ì¥í•˜ë©´ ë¨ :contentReference[oaicite:10]{index=10}
        if (!state.customSkills) state.customSkills = {};
        if (t === 'ì—†ìŒ') {
          state.customSkills.type = '';
          state.customSkills.weaponName = '';
        } else {
          state.customSkills.type = t;          // ê°•íƒ€/ê´‘ì±„/ë¶„ì‡„/ì„ ëª…
          state.customSkills.weaponName = wName; // (ë°±ì—ì„œ weaponType í•´ì„) :contentReference[oaicite:11]{index=11}
        }
        syncWeaponCustomButtonUI(t);

        // 3) ê³„ì‚° ì‹¤í–‰ (calc_all payloadì— customSkills í¬í•¨ë¨) :contentReference[oaicite:12]{index=12}
        await computeViaBackend(targetId);
      }
    }

    toast('ë¬´ê¸°/ë¬´ê¸°ê³ ìœ íš¨ê³¼ ìë™ê³„ì‚° ì™„ë£Œ');
  } catch (e) {
    console.error('[autoWeaponSweep] fail:', e);
    toast('ë¬´ê¸°/ë¬´ê¸°ê³ ìœ íš¨ê³¼ ìë™ê³„ì‚° ì¤‘ ì˜¤ë¥˜');
  } finally {
  // â˜… ì›ë³µ (ì¥ì°© ë³µì›ì€ async)
  try {
    if (typeof restoreSelections === 'function') {
      await restoreSelections(backupSelections);
    } else {
      state.selections = backupSelections;
    }
  } catch (e2) {
    console.warn('[autoWeaponSweep] restoreSelections fail:', e2);
  }

  // ë¬´ê¸°ê³ ìœ íš¨ê³¼ë„ ì›ë³µ
  state.customSkills = backupCustom;

  // UIë„ ì›ë³µ ë°˜ì˜(í”„ë¦¬ë·°/ë²„íŠ¼)
  try { updateEquipDescPreview?.(); } catch (_) {}
  try {
    // ë„¤ í•¨ìˆ˜ ì•ˆì— ìˆë˜ syncWeaponCustomButtonUI ê·¸ëŒ€ë¡œ ì“°ë©´ ë¨
    const t = (backupCustom?.type ? String(backupCustom.type).trim() : '') || 'ì—†ìŒ';
    syncWeaponCustomButtonUI(t);
  } catch (_) {}
}
}


      document.getElementById('btn-sum-all-final')?.setAttribute('data-compute-btn', '');
      document.getElementById('btn-sum-all-final2')?.setAttribute('data-compute-btn', '');

      // ë²„íŠ¼: ëˆ„ë¥¼ ë•Œë§Œ ê°’ ì±„ì›€
      document.getElementById('btn-sum-all-final')?.addEventListener('click', () => {
        computeViaBackend('finalDamageValue');
      });

      // ë²„íŠ¼: ëˆ„ë¥¼ ë•Œë§Œ ê°’ ì±„ì›€
      document.getElementById('btn-sum-all-final2')?.addEventListener('click', () => {
        computeViaBackend('finalDamageValue2');
      });

      document.getElementById('btnAutoSetSweepSelected')?.addEventListener('click', () => {
  runAutoSetSweepSelected('finalDamageValue');
});

document.getElementById('btnAutoSetSweepMissing')?.addEventListener('click', () => {
  runAutoSetSweepMissingArmorFixed('finalDamageValue');
});

document.getElementById('btnAutoWeaponSweepSelected')?.addEventListener('click', async () => {
  await runAutoWeaponCustomSweepSelected('finalDamageValue');
});

      (() => {
        window.WEBAPP_URL = 'https://dnf-backend.gogo456654.workers.dev';

        window.idToken ??= null; // ë¡œê·¸ì¸ í›„ ë°›ì€ ID í† í° ì €ì¥ìš©

        const DBSkill = { loaded: false, headers: [], rows: [] }; // ìŠ¤í‚¬ ë¡œë”© ìƒíƒœ ì €ì¥ìš©(ì›í•˜ëŠ” ë„¤ì´ë° ì‚¬ìš©)

        // === ë¡œê·¸ì¸ ì„±ê³µ ì½œë°±(GSIì—ì„œ í˜¸ì¶œ) ===
        // ---------- ë¡œê·¸ì¸ ì²˜ë¦¬ ----------
        async function onGoogleCredential({ credential }) {
          try {
            if (!credential) throw new Error("ID í† í° ì—†ìŒ");
            window.idToken = credential; // í† í° ë³´ê´€
            document.dispatchEvent(new Event('gsi:issued'));

            // ë¡œê·¸ì¸ ìƒíƒœ ì•ˆë‚´ UI
            const card0 = document.querySelector(".login-card");
            if (card0) {
              card0.innerHTML = `
        <div class="login-title">ì ‘ê·¼ í™•ì¸ ì¤‘â€¦</div>
        <div class="login-desc">ê¶Œí•œ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
        <div class="login-row">
          <button id="btnPC" class="mode-btn" disabled>PC ê³„ì‚°ê¸° ì—´ê¸°</button>
          <button id="btnM" class="mode-btn" disabled>ëª¨ë°”ì¼ ê³„ì‚°ê¸° ì—´ê¸°</button>
        </div>`;
            }

            // âœ… ë¡œê·¸ì¸ í•‘ ê²°ê³¼ë¡œ í—ˆìš© ì—¬ë¶€ íŒì •
            const ping = await loginPingOnce();
            const allowed = !!(ping && ping.ok);

// âœ… (ì¶”ê°€) pingì—ì„œ email í™•ë³´ (ë°±ì—”ë“œê°€ í† í° ê²€ì¦ í›„ ë‚´ë ¤ì¤Œ)
const loginEmail = String(ping?.email || '').trim().toLowerCase();
const isSpecial = !!loginEmail && SPECIAL_USER_EMAILS.includes(loginEmail);

// (ì„ íƒ) ê¸°ì¡´ ë¡œì§ë“¤ê³¼ ê°™ì´ ì“°ê³  ì‹¶ìœ¼ë©´ CORE.userEmailë„ ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì±„ì›Œë‘ 
window.CORE = window.CORE || {};
if (loginEmail) CORE.userEmail = loginEmail;

            if (!allowed) console.warn("í—ˆìš© ì•ˆ ë¨:", ping);

            const card = document.querySelector(".login-card");
            if (card) {
              card.innerHTML = `
        <div class="login-title">${allowed ? "ì ‘ê·¼ ìŠ¹ì¸ë¨" : "ì ‘ê·¼ ì œí•œë¨"}</div>
        <div class="login-desc">
          ${allowed
                  ? "ì•„ë˜ì—ì„œ ì´ìš©í•  í™”ë©´ì„ ì„ íƒí•˜ì„¸ìš”."
                  : 'ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ ì—°êµ¬ì›ë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.<br><a class="join-link" href="https://www.youtube.com/channel/UCijUV3SuVe_qErzBpdOmKIA/join" target="_blank" rel="noopener">ê²Œì„ì‹¤í—˜ì—°êµ¬ì†Œ ì—°êµ¬ì› ê°€ì…í•˜ê¸°</a>'}
        </div>
        <div class="login-row">
      <button id="btnPC" class="mode-btn">PC ê³„ì‚°ê¸° ì—´ê¸°</button>
      <!-- â˜… ëª¨ë°”ì¼ì€ í•­ìƒ ë¹„í™œì„± + íˆ´íŒ -->
      <button id="btnM" class="mode-btn" disabled title="Comming Soon...">ëª¨ë°”ì¼ ê³„ì‚°ê¸° ì—´ê¸°</button>
    </div>
      `;

              if (!document.getElementById("mode-btn-style")) {
                const style = document.createElement("style");
                style.id = "mode-btn-style";
                style.textContent = `
          .mode-btn{
            height:40px; padding:0 14px; border-radius:999px;
            border:1px solid rgba(255,255,255,.2); background:#111827; color:#e6e9ef; cursor:pointer;
            transition: box-shadow .15s, border-color .15s, opacity .15s;
          }
          .mode-btn:hover{ border-color:#6ea8ff; box-shadow:0 0 0 2px rgba(110,168,255,.25) inset; }
          .mode-btn:disabled{ opacity:.5; cursor:not-allowed; filter: grayscale(30%); }
          .login-desc a.join-link{ color:#8fbaff; text-decoration: underline; }
        `;
                document.head.appendChild(style);
              }

              const btnPC = card.querySelector("#btnPC");
              const btnM = card.querySelector("#btnM");

              // ê¸°ë³¸ ì ê¸ˆ
              btnPC?.setAttribute("disabled", "true");
              btnM?.setAttribute("disabled", "true");

              // âœ… ëª¨ë°”ì¼ ë²„íŠ¼: allowed + SPECIAL_USER_EMAILS ì¼ ë•Œë§Œ í™œì„±í™”
if (btnM) {
  if (allowed && isSpecial) {
    btnM.removeAttribute('disabled');
    btnM.removeAttribute('title'); // íˆ´íŒ ì œê±°(ì›í•˜ë©´ ìœ ì§€í•´ë„ ë¨)
  } else {
    btnM.setAttribute('disabled', 'true');
    btnM.setAttribute('title', 'Comming Soon.');
  }
}

              if (allowed) {
                btnPC.removeAttribute("disabled");
                //   btnM.removeAttribute("disabled");

                // í•œ ë²ˆë§Œ ë¶€íŒ…ë˜ë„ë¡ ê°€ë“œ
                let __booting = false;

                btnPC.addEventListener('click', async () => {
                  if (__booting) return;
                  __booting = true;

                  try {
                    // ë¡œë”© ì˜¤ë²„ë ˆì´ ë„ìš°ê¸° + 0%ë¡œ ì´ˆê¸°í™”
                    showOverlay('ë°ì´í„° ì¤€ë¹„ ì¤‘â€¦');

                    // 1) ê¸°ë³¸ init (ê³„ì •/ê¶Œí•œ/CORE.lists ì„¸íŒ…)
                    setProgressExactMonotonic(5, 'ì´ˆê¸° ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
                    await initCalculatorOnce();

                    // 3) í™”ë©´ ì „í™˜
                    showCalcView('pc');

                    // âœ… PC ê³„ì‚°ê¸° ë¡œë”©ì´ ëë‚œ í›„ ê³µì§€ ëª¨ë‹¬ í‘œì‹œ
                    if (typeof window.showQuatroNoticeOnce === 'function') {
                      window.showQuatroNoticeOnce();
                    }

                    // 2) ì‹œíŠ¸/ì¥ë¹„ ë¯¸ë¦¬ ë¡œë”© (ì—¬ê¸°ì„œ ê²Œì´ì§€ê°€ 5% â†’ 100%ê¹Œì§€ ì›€ì§ì¸ë‹¤)
                    //await preloadAllSheets({ weightCore: 35, weightSlots: 65 });

                    // 3) í™”ë©´ ì „í™˜
                    showCalcView('pc');
                  } catch (e) {
                    console.error('[boot]', e);
                    (typeof toast === 'function' ? toast : alert)('ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                  } finally {
                    hideOverlay();
                    __booting = false;
                  }
                });


                btnM.addEventListener('click', () => {
  // âœ… ë¡œê·¸ì¸ í† í°ì„ ëª¨ë°”ì¼ í˜ì´ì§€ë¡œ ì „ë‹¬(ê°™ì€ ë„ë©”ì¸ì—ì„œë§Œ ìœ íš¨)
  const token = window.idToken || '';
  if (token) sessionStorage.setItem('id_token', token);

  // âœ… ëª¨ë°”ì¼ ì „ìš© HTMLë¡œ ì´ë™
  location.href = 'mobileindex.html';
});
              }
            }
          } catch (err) {
            console.warn("[Login] ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", err);
          }
        }
        // GSIì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•˜ë„ë¡ ì „ì—­ ë…¸ì¶œ ìœ ì§€
        window.onGoogleCredential = onGoogleCredential;

        // === ë·° ì „í™˜(ì—†ìœ¼ë©´ ì¶”ê°€) ===
        //  - ë©”ì¸ ìˆ¨ê¸°ê³  ê³„ì‚°ê¸° ë³´ì—¬ì£¼ê¸° + ëª¨ë“œ í´ë˜ìŠ¤ í† ê¸€
        function hideBlockHard(el) {
          if (!el) return;
          el.setAttribute('hidden', 'hidden');   // hidden ì†ì„±
          el.style.display = 'none';             // ì™„ì „ ì œê±°
          el.style.margin = '0';
          el.style.padding = '0';
          el.style.minHeight = '0';
          el.style.height = '0';
        }

        // â˜… í—¤ë” ê´‘ê³  â€” ì´ ë¸”ë¡ìœ¼ë¡œ êµì²´ (CSV â†’ ë°±ì—”ë“œ JSON ì‚¬ìš©)
        async function initHeaderAds() {
          try {
            const header = document.querySelector("header");
            if (!header) return;

            let ads = header.querySelector(".header-ads");
            if (!ads) {
              ads = document.createElement("div");
              ads.className = "header-ads";
              ads.innerHTML = `<span class="ad-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</span>`;
              header.appendChild(ads);
            }
            const adTextEl = ads.querySelector(".ad-text");
            if (ads.dataset.inited) return;
            ads.dataset.inited = "1";

            // ë°±ì—”ë“œì—ì„œ ëª©ë¡(JSON) ë¡œë“œ
            // ë°±ì—”ë“œì—ì„œ í•œ ì¤„ë§Œ ë°›ê¸°
            const r = await fetch(WEBAPP_URL + '?type=phrase&public=1', {
              method: "GET",
              mode: "cors",
              cache: "no-store"
            });
            if (!r.ok) throw new Error("phrase_fetch_failed");
            const data = await r.json().catch(() => ({ ok: false }));
            const text = (data && data.ok && data.message) ? String(data.message).trim() : '';

            if (!text) {
              adTextEl.textContent = "ë“±ë¡ëœ í•œë§ˆë””ê°€ ì—†ìŠµë‹ˆë‹¤.";
            } else {
              adTextEl.textContent = text;
            }


            // data.itemsëŠ” Apps Scriptê°€ ë‚´ë ¤ì£¼ëŠ” ì •ê·œí™” ê°ì²´ ë°°ì—´
            //  { ingame, position, youtube, google, message }
            // "ìˆ˜ì„" + "ì±…ì„" ëª¨ë‘ í—ˆìš© (ì•ì— ì ‘ë‘ì–´ê°€ ë¶™ì€ "ìˆ˜ì„ì—°êµ¬ì›"/"ì±…ì„ì—°êµ¬ì›"ë„ í¬í•¨)
            function escapeHTML(s = '') {
              return String(s)
                .replace(/&/g, '&amp;').replace(/</g, '&lt;')
                .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;').replace(/`/g, '&#96;');
            }

            function shuffleInPlace(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

            let messages = (data.items || [])
              .filter(x => {
  const pos = (x.position || '').trim();
  const pos0 = pos.replace(/^\[ì´ë²¤íŠ¸\]\s*/, '');
  const msg = (x.message || '').trim();
  return !!msg && /^(ìˆ˜ì„|ì±…ì„)/.test(pos0);
})
.map(x => {
  const pos = (x.position || '').trim();
  const pos0 = pos.replace(/^\[ì´ë²¤íŠ¸\]\s*/, '');
  const nick = (x.ingame || '').trim() || (x.youtube || '').trim();
  const msg = (x.message || '').trim();

  const isSenior = /^ìˆ˜ì„/.test(pos0); // âœ… ì´ë²¤íŠ¸ ìˆ˜ì„ë„ ìˆ˜ì„ ì²˜ë¦¬
  const roleBadge = isSenior
    ? '<span class="tag tag-senior" aria-label="ìˆ˜ì„" title="ìˆ˜ì„"><span class="badge-emoji">ğŸ‘‘</span></span>'
    : '<span class="tag-lead" aria-hidden="true"></span>';

                return `
      <span class="hdrmsg ${isSenior ? 'senior' : 'lead'}">
        ${roleBadge}
        ${nick ? `<span class="msg-nick">${escapeHTML(nick)} ë‹˜</span>` : ''}
        <span class="msg-bullet">Â·</span>
        <span class="msg-text">${escapeHTML(msg)}</span>
      </span>
    `.trim();
              });

            // ì¤‘ë³µ ì œê±°
            messages = [...new Set(messages)];

            // â˜… ìˆ˜ì„/ì±…ì„ ë¹„ìœ¨ ì¡°ì ˆ: ìˆ˜ì„ í•œë§ˆë””ë¥¼ ì±…ì„ë³´ë‹¤ ì•½ 1.5ë°° ìì£¼ ë‚˜ì˜¤ê²Œ ê°€ì¤‘ì¹˜ ë¶€ì—¬
            const seniorMsgs = messages.filter(html => html.includes('hdrmsg senior'));
            const leadMsgs = messages.filter(html => html.includes('hdrmsg lead'));

            if (seniorMsgs.length && leadMsgs.length) {
              const weighted = [];

              // ìˆ˜ì„: 3ë²ˆì”©, ì±…ì„: 2ë²ˆì”© ë„£ì–´ì„œ 3:2 â‰’ 1.5ë°° ë¹„ìœ¨ ë§Œë“¤ê¸°
              seniorMsgs.forEach(m => { weighted.push(m, m, m); }); // ìˆ˜ì„ 3íšŒ
              leadMsgs.forEach(m => { weighted.push(m, m); }); // ì±…ì„ 2íšŒ

              messages = weighted;
            }
            // (ë§Œì•½ ìˆ˜ì„ë§Œ ìˆê±°ë‚˜ ì±…ì„ë§Œ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ messages ì‚¬ìš©)

            // ì„ê¸°
            messages = shuffleInPlace(messages);

            if (!messages.length) {
              adTextEl.textContent = "ë“±ë¡ëœ í•œë§ˆë””ê°€ ì—†ìŠµë‹ˆë‹¤.";
              return;
            }

            // 6ì´ˆë§ˆë‹¤ ìˆœí™˜í•  ì´ëª¨ì§€ ëª©ë¡
            const SENIOR_EMOJIS = ['ğŸ‘‘', 'â­', 'ğŸ…', 'âœ¨'];
            let __emojiIdx = 0;

            // í˜„ì¬ í‘œì‹œëœ í•œë§ˆë”” ì»¨í…Œì´ë„ˆì—ì„œ ìˆ˜ì„ ë°°ì§€ ì´ëª¨ì§€ë§Œ êµì²´
            function applySeniorEmoji(target) {
              const node = target.querySelector('.tag-senior .badge-emoji');
              if (node) node.textContent = SENIOR_EMOJIS[__emojiIdx];
            }
            // ìˆœí™˜ í‘œì‹œ
            let i = 0, timer = null, paused = false;
            function show(idx) {
              adTextEl.classList.add("fade-out");
              setTimeout(() => {
                adTextEl.innerHTML = messages[idx % messages.length];
                adTextEl.classList.remove("fade-out");
                // ğŸ‘‡ ìƒˆ DOMì´ ë“¤ì–´ê°„ ë’¤, í•´ë‹¹ ë¼ìš´ë“œì˜ ì´ëª¨ì§€ë¥¼ ì ìš©
                applySeniorEmoji(adTextEl);
              }, 200); // ì´ ê°’(200ms)ì€ í˜ì´ë“œ ì‹œê°„ê³¼ ë§ì¶”ì„¸ìš”
            }
            const DISPLAY_MS = 6000;

            function start() {
              if (timer) clearInterval(timer);
              timer = setInterval(() => {
                if (paused) return;
                // ğŸ‘‡ ì´ëª¨ì§€ ì¸ë±ìŠ¤ ë¨¼ì € ìˆœí™˜
                __emojiIdx = (__emojiIdx + 1) % SENIOR_EMOJIS.length;
                // ë©”ì‹œì§€ë„ ë‹¤ìŒìœ¼ë¡œ
                i = (i + 1) % messages.length;
                show(i); // show() ì•ˆì—ì„œ ë°©ê¸ˆ ì¸ë±ìŠ¤ì˜ ì´ëª¨ì§€ë¥¼ ì ìš©
              }, DISPLAY_MS);
            }

            // ìµœì´ˆ 1íšŒ í‘œì‹œ ì‹œì—ë„ ì´ëª¨ì§€ ë°˜ì˜ë˜ë„ë¡ show(0)ë§Œ í˜¸ì¶œí•˜ë©´ OK
            show(0);
            start();

            ads.addEventListener("mouseenter", () => { paused = true; });
            ads.addEventListener("mouseleave", () => { paused = false; });

          } catch (e) {
            console.warn("[ADS] ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
          }
        }

        // ë¬¸ì„œ ì¤€ë¹„ í›„ ìë™ ì‹¤í–‰(ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        if (document.readyState === "complete" || document.readyState === "interactive") {
          initHeaderAds();
        } else {
          document.addEventListener("DOMContentLoaded", initHeaderAds);
        }


        if (typeof window.showCalcView !== "function") {
          let calcInited = false;
          window.showCalcView = function (mode) {
            const main = document.getElementById("main-view");
            const calc = document.getElementById("calc-view");
            hideBlockHard(main);                 // â† ìƒë‹¨ ê³µê°„ ì™„ì „ ì œê±°
            hideBlockHard(document.querySelector("section.hero"));
            // .shell ì»¨í…Œì´ë„ˆëŠ” ìœ ì§€, headerë¥¼ ì œì™¸í•œ ìì‹ë§Œ ì ‘ê¸°
            const shell = document.querySelector('div.shell');
            if (shell) {
              shell.querySelectorAll(':scope > :not(header):not(#site-header)').forEach(hideBlockHard);
            }
            // í˜¹ì‹œ .shell ë°–ì— ë‚¨ì•„ ìˆì„ ìˆ˜ ìˆëŠ” ëœë”© ì„¹ì…˜ë“¤ ë³´ê°•
            ['.login-wrap', '.hero', '.spacer', '.notice', '.grid', '#hero']
              .forEach(sel => hideBlockHard(document.querySelector(sel)));
            if (calc) {
              calc.removeAttribute('hidden');
              calc.style.display = 'block';
            }

            document.body.classList.toggle("pc", mode === "pc");
            document.body.classList.toggle("mobile", mode === "mobile");
            if (!calcInited) {
              // í•„ìš” ì‹œ í•œ ë²ˆë§Œ ì´ˆê¸°í™” ë¡œì§ í˜¸ì¶œ (initCalculator ë“±)
              calcInited = true;
            }
            window.scrollTo(0, 0);
          };
        }

        // (ì„ íƒ) #g_id_onloadì— client_idê°€ ë¹„ì–´ìˆìœ¼ë©´ ì±„ì›Œì¤Œ
        const onloadDiv = document.getElementById("g_id_onload");
        if (onloadDiv && !onloadDiv.dataset.clientId) {
          onloadDiv.dataset.clientId = window.GOOGLE_CLIENT_ID;
        }
        // ==========================
        // ê´€ë¦¬ì ë¬¸ì˜ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        // ==========================
        function openContactModal() {
          const $m = document.getElementById('contactModal');
          if (!$m) return;
          $m.classList.add('show');
          $m.setAttribute('aria-hidden', 'false');

          const $ta = document.getElementById('contactTalk');
          if ($ta) {
            $ta.focus();
          }
        }

        function closeContactModal() {
          const $m = document.getElementById('contactModal');
          if (!$m) return;
          $m.classList.remove('show');
          $m.setAttribute('aria-hidden', 'true');
        }

        // ìƒë‹¨ "ë¬¸ì˜í•˜ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
        const $contactBtn = document.getElementById('btnContactAdmin');
        if ($contactBtn) {
          $contactBtn.addEventListener('click', () => {
            openContactModal();
          });
        }

        // ëª¨ë‹¬ ë‚´ë¶€ ë‹«ê¸° ë²„íŠ¼ / ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        const $contactModal = document.getElementById('contactModal');
        if ($contactModal) {
          $contactModal.addEventListener('click', (e) => {
            const t = e.target;
            if (t.hasAttribute('data-contact-close') || t.classList.contains('backdrop')) {
              closeContactModal();
            }
          });
        }

      })();

const $btnSpecialPatch = document.getElementById('btnSpecialPatch');
const $btnSpecialAcc   = document.getElementById('btnSpecialAcc');
const $btnSpecialSpec  = document.getElementById('btnSpecialSpec');
const $btnAutoSetSweepSelected = document.getElementById('btnAutoSetSweepSelected');

if ($btnSpecialPatch && $armorSetModal) {
  $btnSpecialPatch.addEventListener('click', () => {
    renderArmorSetModal();
    showModal($armorSetModal, true);
  });
}

if ($btnSpecialAcc && $accSetModal) {
  $btnSpecialAcc.addEventListener('click', () => {
    renderAccSetModal();
    showModal($accSetModal, true);
  });
}

if ($btnSpecialSpec && $specSetModal) {
  $btnSpecialSpec.addEventListener('click', () => {
    renderSpecSetModal();
    showModal($specSetModal, true);
  });
}

// âœ… ì„ íƒ ì„¸íŠ¸ ìë™ê³„ì‚°
if ($btnAutoSetSweepSelected) {
  $btnAutoSetSweepSelected.addEventListener('click', async () => {
    // ì›í•˜ëŠ” ì¶œë ¥ ë°•ìŠ¤ IDë¡œ ë§ì¶°ì¤˜ (ì§€ê¸ˆì€ finalDamageValue ê¸°ì¤€)
    await runAutoSetSweepSelected('finalDamageValue');
  });
}

// =======================
// FAQ (ë¬¸ì˜ ì „ ìì£¼í•˜ëŠ” Q&A)
// =======================
function getFaqItems() {
  const lists = (window.CORE && window.CORE.lists) ? window.CORE.lists : {};
  const raw = lists ? lists['faq:list'] : null;
  return Array.isArray(raw) ? raw : [];
}

function openFaqModal() {
  const modal = document.getElementById('faqModal');
  if (!modal) return;

  // ë Œë”
  const box = document.getElementById('faqList');
  const items = getFaqItems();

  if (box) {
    box.innerHTML = '';
    if (!items.length) {
      box.innerHTML = `<div style="opacity:.8">ë“±ë¡ëœ Q&Aê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    } else {
      for (const it of items) {
        const q = String(it?.q ?? '').trim();
        const a = String(it?.a ?? '').trim();
        if (!q) continue;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'faq-q-btn';
        btn.textContent = q;
        btn.addEventListener('click', () => {
          // â€œëª¨ë‹¬ í•˜ë‚˜ ë”â€ëŠ” ë‹µë³€ ëª¨ë‹¬ë¡œ ì „í™˜(ê²¹ì¹¨ ë¬¸ì œ ë°©ì§€ìš©ìœ¼ë¡œ ëª©ë¡ ëª¨ë‹¬ ë‹«ê³  ë‹µë³€ ëª¨ë‹¬ ì˜¤í”ˆ)
          closeFaqModal();
          openFaqAnswerModal(q, a);
        });
        box.appendChild(btn);
      }
    }
  }

  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');
}

function closeFaqModal() {
  const modal = document.getElementById('faqModal');
  if (!modal) return;
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
}

function openFaqAnswerModal(q, a) {
  const modal = document.getElementById('faqAnswerModal');
  if (!modal) return;

  const qEl = document.getElementById('faqAnswerQ');
  const aEl = document.getElementById('faqAnswerA');
  if (qEl) qEl.textContent = q || '';
  function renderFaqAnswer(container, answerText) {
  if (!container) return;
  container.innerHTML = '';

  const lines = String(answerText || '').split(/\r?\n/);

  const isImgToken = (s) => {
    const t = String(s || '').trim();
    return (
      /^https?:\/\/\S+\.(png|jpg|jpeg|gif|webp)(\?\S*)?$/i.test(t) ||
      /^(\/?img\/\S+|\.\.?\/img\/\S+)\.(png|jpg|jpeg|gif|webp)(\?\S*)?$/i.test(t)
    );
  };

  const makeImg = (src) => {
    const img = document.createElement('img');
    img.className = 'faq-img';
    img.src = encodeURI(String(src || '').trim());
    img.alt = 'FAQ ì´ë¯¸ì§€';
    img.loading = 'lazy';
    return img;
  };

  for (const lineRaw of lines) {
    const line = lineRaw.trim();

    if (!line) {
      container.appendChild(document.createElement('br'));
      continue;
    }

    // âœ… í•œ ì¤„ì— | ë¡œ ì—¬ëŸ¬ ì´ë¯¸ì§€ë©´ "ìë™ ê·¸ë¦¬ë“œ"ë¡œ ë Œë”
    const parts = line.split('|').map(s => s.trim()).filter(Boolean);
    const allImgs = (parts.length >= 2) && parts.every(isImgToken);

    if (allImgs) {
      const grid = document.createElement('div');
      grid.className = 'faq-img-grid';
      for (const p of parts) grid.appendChild(makeImg(p));
      container.appendChild(grid);
      continue;
    }

    // âœ… í•œ ì¤„ì´ ì´ë¯¸ì§€ 1ê°œë©´ 1ì—´(ê¸°ì¡´ ë°©ì‹)
    if (isImgToken(line)) {
      container.appendChild(makeImg(line));
      continue;
    }

    // í…ìŠ¤íŠ¸
    const div = document.createElement('div');
    div.textContent = lineRaw;
    container.appendChild(div);
  }
}


// openFaqAnswerModal ì•ˆì—ì„œ:
if (aEl) renderFaqAnswer(aEl, a || '');


  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');
}

function closeFaqAnswerModal() {
  const modal = document.getElementById('faqAnswerModal');
  if (!modal) return;
  modal.classList.remove('show');
  modal.setAttribute('aria-hidden', 'true');
}

// ë²„íŠ¼ ì—°ê²°
const faqBtn = document.getElementById('btnFaq');
if (faqBtn) faqBtn.addEventListener('click', openFaqModal);

// ë‹«ê¸°(ëª©ë¡)
document.querySelectorAll('[data-faq-close]').forEach(el => {
  el.addEventListener('click', closeFaqModal);
});

// ë‹«ê¸°(ë‹µë³€)
document.querySelectorAll('[data-faqans-close]').forEach(el => {
  el.addEventListener('click', closeFaqAnswerModal);
});

// ë‹µë³€ ëª¨ë‹¬ì—ì„œ â€œëª©ë¡â€
document.querySelectorAll('[data-faqans-back]').forEach(el => {
  el.addEventListener('click', () => {
    closeFaqAnswerModal();
    openFaqModal();
  });
});


    </script>
</body>

</html>
<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>게임실험연구소 계산기 (시즌5) - Mobile</title>

  <style>
    :root {
      --bg: #070a12;
      --card: rgba(255, 255, 255, 0.06);
      --card2: rgba(255, 255, 255, 0.10);
      --line: rgba(255, 255, 255, 0.10);
      --text: #e9eef7;
      --muted: rgba(233, 238, 247, 0.70);
      --btn: #2563eb;
      --btn2: #111827;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --footer-h: 92px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 700px at 50% -20%, rgba(37, 99, 235, 0.28), transparent 55%), var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      overflow: hidden;
      /* 스와이프 컨텐츠 내부 스크롤만 */
    }

    /* ====== Layout ====== */
    .m-shell {
      height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    .m-header {
      position: sticky;
      top: 0;
      z-index: 50;
      padding: calc(10px + var(--safe-top)) 12px 10px 12px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.15));
      backdrop-filter: blur(10px);
    }

    .m-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .m-title {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .m-title .txt {
      font-weight: 800;
      letter-spacing: -0.2px;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .m-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 0 0 auto;
    }

    .m-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .m-action-btn:active {
      transform: translateY(1px);
    }

    .m-action-btn svg {
      width: 16px;
      height: 16px;
    }

    .m-action-btn svg path,
    .m-action-btn svg rect {
      fill: none;
      stroke: var(--text);
      stroke-width: 1.6;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* ====== Swipe Pages ====== */
    .m-main {
      flex: 1 1 auto;
      position: relative;
      padding-bottom: calc(var(--footer-h) + var(--safe-bottom));
      overflow: hidden;
    }

    .m-pages {
      height: 100%;
      display: flex;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;

      touch-action: pan-y;
      /* ✅ 추가: 가로는 우리가 제어, 세로 스크롤은 허용 */
      overscroll-behavior-x: contain;
      /* ✅ 추가: 가로 스와이프 튐 방지 */
    }

    .m-pages::-webkit-scrollbar {
      display: none;
    }

    .m-page {
      flex: 0 0 100%;
      height: 100%;
      scroll-snap-align: start;
      padding: 14px 12px 16px 12px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;

      /* ✅ 추가: 페이지 안에서 카드가 남은 높이를 채우도록 */
      display: flex;
      flex-direction: column;
      scroll-snap-stop: always;
      /* ✅ 추가: 스냅이 더 안정적으로 걸리게 */
    }

    .m-card {
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
    }

    /* ✅ 1페이지(캐릭터 선택) 카드가 남은 높이를 꽉 채우게 */
    #pageChar .m-card {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    /* ✅ big-pick 영역도 같이 늘어나서 버튼이 아래 고정 푸터 위까지 길어짐 */
    #pageChar .big-pick {
      flex: 1 1 auto;
      min-height: 0;
      /* flex에서 과도한 min-height 방지 */
    }

    #pageChar .hint {
      margin-top: 10px;
    }

    /* ===== 모바일 캐릭터 목록: 좌 썸네일 / 우 이름 ===== */
    /* ✅ 모달 내용: 손가락 드래그로 스크롤, 스크롤바는 숨김 */
    #charModal .dialog {
      overflow: hidden;
      /* dialog 자체는 숨기고 */
    }

    /* 실제 스크롤은 catalog에서 */
    #charModal #catalog {
      max-height: min(78vh, 720px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      /* iOS 관성 */
      scrollbar-width: none;
      /* Firefox */
    }

    #charModal #catalog::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    #charModal #catalog {
      touch-action: pan-y;
      /* 세로 스크롤 제스처 우선 */
    }

    #charModal .mchar-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #charModal .mchar-row {
      width: 100%;
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 12px;
      align-items: center;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: #fff;
      text-align: left;
      cursor: pointer;
    }

    #charModal .mchar-row:active {
      transform: translateY(1px);
    }

    #charModal .mchar-thumb {
      width: 72px;
      height: 44px;
      border-radius: 10px;
      object-fit: cover;
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.10);
    }

    #charModal .mchar-name {
      font-weight: 900;
      font-size: 15px;
      letter-spacing: -0.2px;
    }

    /* ===== 직업군 그룹 구분(배지 + 직업군명) ===== */
    #charModal .mchar-group {
      padding: 10px 0 14px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.10);
    }

    #charModal .mchar-group:first-child {
      border-top: 0;
      padding-top: 0;
    }

    #charModal .mchar-group-head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 2px 2px 10px 2px;
    }

    #charModal .mchar-badge {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.06);
      flex: 0 0 auto;
    }

    #charModal .mchar-group-title {
      font-weight: 900;
      font-size: 14px;
      letter-spacing: -0.2px;
      color: rgba(233, 238, 247, 0.95);
    }

    #charModal .mchar-group-sub {
      margin-left: 6px;
      font-size: 11px;
      color: rgba(233, 238, 247, 0.60);
      font-weight: 800;
    }

    #charModal .mchar-group-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      /* 기존 row 간격 유지 */
    }



    .big-pick {
      margin-top: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 210px;
      border-radius: 18px;
      border: 1px dashed rgba(255, 255, 255, 0.22);
      background: rgba(255, 255, 255, 0.03);

      position: relative;
      /* ✅ 추가 */
      overflow: hidden;
      /* ✅ 추가 (넘치는 부분 잘라서 꽉 찬 느낌) */
    }

    .big-pick button {
      width: 100%;
      max-width: 520px;
      border: none;
      border-radius: 16px;
      padding: 18px 16px;
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.4px;
      color: #ffffff;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.95), rgba(29, 78, 216, 0.95));
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.25);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .big-pick button:active {
      transform: translateY(1px);
    }

    /* ✅ 선택된 캐릭 이미지 표시 */
    #pickedCharImg.picked-char-img {
      display: none;
      /* 기본 숨김 (선택 후 block) */
      position: absolute;
      inset: 0;
      /* ✅ big-pick을 꽉 덮음 */
      width: 100%;
      height: 100%;
      max-width: none;
      max-height: none;

      object-fit: cover;
      /* ✅ 핵심: 잘려도 되니 꽉 채움 */
      object-position: center;

      border-radius: inherit;
      /* big-pick 라운드 그대로 */
      border: 0;
      background: rgba(0, 0, 0, 0.18);
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .page-title {
      font-size: 13px;
      font-weight: 800;
      color: rgba(233, 238, 247, 0.9);
      margin-bottom: 10px;
    }

    .ghost {
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0, 0, 0, 0.22);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
    }

    /* ====== Page 2: 장비 슬롯 ====== */
    #pageEquip .m-card {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    /* ====== Page 2: 장비(1열 상세 row) ====== */
    #pageEquip .equip-body {
      height: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 2px 0;
    }

    #pageEquip .equip-group {
      padding-top: 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.10);
    }

    #pageEquip .equip-group:first-child {
      padding-top: 0;
      border-top: 0;
    }

    #pageEquip .equip-group-head {
      font-weight: 900;
      font-size: 13px;
      letter-spacing: -0.2px;
      color: rgba(233, 238, 247, 0.92);
      margin-bottom: 10px;
    }

    #pageEquip .equip-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #pageEquip .equip-row {
      width: 100%;
      display: grid;
      grid-template-columns: 72px 1fr;
      gap: 10px;
      align-items: center;

      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.06);
      border-radius: 14px;
      padding: 8px;
      text-align: left;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    #pageEquip .equip-row:active {
      transform: translateY(1px);
    }

    /* 좌측: 이미지 + 이미지 아래 장비명 */
    #pageEquip .equip-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* 좌측 이미지: 둥근 정사각형(선택 전 빈 박스) */
    #pageEquip .equip-img {
      width: 56px;
      height: 56px;
      /* ✅ 정사각형 */
      border-radius: 14px;
      /* ✅ 끝이 둥근 정사각형 */
      background: rgba(0, 0, 0, 0.20);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    #pageEquip .equip-name {
      font-weight: 900;
      font-size: 12px;
      color: rgba(233, 238, 247, 0.95);
      text-align: center;
    }

    /* 우측: 강화(연마) | 마법봉인 | 마법부여 | 엠블렘 */
    #pageEquip .equip-right {
      min-width: 0;
      display: grid;

      /* ✅ 고정폭 대신 비율로 분배 (마법봉인 과점 방지) */
      grid-template-columns:
        minmax(52px, 0.85fr)
        /* 강화/연마 */
        minmax(0, 1.45fr)
        /* 마법봉인(옵션) */
        minmax(52px, 0.90fr)
        /* 마법부여 */
        minmax(48px, 0.60fr);
      /* 엠블렘 */

      gap: 4px;
      /* ✅ 6px → 4px */
      align-items: start;
    }

    /* 강화/연마 */
    #pageEquip .equip-enh {
      font-weight: 900;
      font-size: 11px;
      color: rgba(233, 238, 247, 0.95);
      line-height: 1.2;
    }

    #pageEquip .equip-grind {
      margin-top: 6px;
      font-weight: 850;
      font-size: 11px;
      color: rgba(233, 238, 247, 0.70);
      display: none;
      /* 기본 숨김 */
    }

    #pageEquip .equip-row[data-grind="1"] .equip-grind {
      display: block;
    }

    /* 옵션(고유/일반) */
    #pageEquip .equip-opts {
      min-width: 0;
    }

    #pageEquip .equip-unique {
      font-weight: 900;
      font-size: 11px;
      color: rgba(233, 238, 247, 0.92);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #pageEquip .equip-normal {
      margin-top: 6px;
      font-weight: 850;
      font-size: 11px;
      color: rgba(233, 238, 247, 0.65);

      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;

      -webkit-line-clamp: 2;
      /* WebKit */
      line-clamp: 2;
      /* ✅ 표준(린터 경고 제거용) */
    }

    /* 마법부여 / 엠블렘 공통 */
    #pageEquip .equip-col-title {
      font-weight: 900;
      font-size: 11px;
      color: rgba(233, 238, 247, 0.70);
      margin-bottom: 6px;
    }

    #pageEquip .equip-col-body {
      font-weight: 900;
      font-size: 12px;
      color: rgba(233, 238, 247, 0.92);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 엠블렘 아이콘 자리 */
    #pageEquip .equip-emblem-icons {
      display: flex;
      flex-direction: column;
      /* ✅ 세로로 */
      gap: 6px;
      align-items: center;
    }

    #pageEquip .equip-emblem-icons .emb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(0, 0, 0, 0.20);
    }

    /* ===== Equip list (Modal) ===== */
    .meq-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .meq-row {
      width: 100%;
      border: 0;
      background: var(--card2);
      color: var(--text);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      grid-template-columns: 54px 1fr;
      gap: 10px;
      align-items: center;
      text-align: left;
      box-shadow: 0 1px 0 rgba(255, 255, 255, 0.05) inset;
    }

    .meq-thumb {
      width: 54px;
      height: 54px;
      border-radius: 14px;
      background: #0b1220;
      border: 1px solid rgba(255, 255, 255, 0.08);
      object-fit: cover;
      display: block;
    }

    .meq-name {
      font-size: 14px;
      line-height: 1.25;
      font-weight: 700;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;

      /* ✅ 경고 방지용(표준 속성) */
      line-clamp: 2;
    }

    /* ✅ 2중 모달: 강화 모달은 장비 모달 위에 */
#equipEnhModal { z-index: 1100; }
#equipSealUModal { z-index: 1110; }
#equipSealNModal { z-index: 1110; }
#equipEnchantModal { z-index: 1120; }
#equipEmblemModal { z-index: 1130; }
#equipGrindModal { z-index: 1108; }


/* ✅ (PC와 유사한 리스트 스타일) 강화 + 마법봉인(고유/일반) + 마법부여 공통 */
#equipEnhModal .dialog,
#equipSealUModal .dialog,
#equipSealNModal .dialog,
#equipEnchantModal .dialog,
/* ✅ 추가 */
#equipEmblemModal .dialog,
#equipGrindModal .dialog{
  width: min(320px, 95vw);
  height: min(520px, 85vh);
}


/* 리스트(1열) */
#equipEnhModal .enh-list,
#equipSealUModal .enh-list,
#equipSealNModal .enh-list,
#equipEnchantModal .enh-list,
#equipGrindModal .enh-list{
  overflow: auto;
  padding: 10px;
  display: grid;
  grid-template-columns: 1fr; /* ✅ 1열 고정 */
  gap: 8px;
}

/* 버튼 (마법부여는 .enh-btn 이라 같이 포함) */
#equipEnhModal .enh-option,
#equipSealUModal .enh-option,
#equipSealNModal .enh-option,
#equipEnchantModal .enh-btn,
#equipGrindModal .enh-option{
  height: 36px;
  padding: 0 12px;
  text-align: left;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.25);
  color: rgba(240,230,210,0.95);
  cursor: pointer;
}

/* active (마법부여는 .enh-btn.active) */
#equipEnhModal .enh-option.active,
#equipSealUModal .enh-option.active,
#equipSealNModal .enh-option.active,
#equipEnchantModal .enh-btn.active,
#equipGrindModal .enh-option.active{
  border-color: rgba(207,162,79,0.9);
  box-shadow: 0 0 0 2px rgba(207,162,79,0.18) inset;
}





    /* ====== Bottom Fixed ====== */
    .m-footer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 60;
      padding: 10px 12px calc(10px + var(--safe-bottom)) 12px;
      border-top: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.10), rgba(0, 0, 0, 0.55));
      backdrop-filter: blur(10px);
    }

    .m-footer-row {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }

    .m-calc-btn {
      flex: 0 0 140px;
      border: none;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.95), rgba(29, 78, 216, 0.95));
      color: #fff;
      font-weight: 900;
      font-size: 18px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .m-calc-btn:active {
      transform: translateY(1px);
    }

    .m-result {
      flex: 1 1 auto;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.06);
      padding: 12px 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }

    .m-result .label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .m-result .value {
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -0.4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ====== Toast ====== */
    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(var(--footer-h) + 14px + var(--safe-bottom));
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.70);
      border: 1px solid rgba(255, 255, 255, 0.14);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* (선택) 모달은 나중에 PC에서 그대로 복붙할 예정이면,
       여기선 최소한의 기본만 둠 */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 1000;
    }

    .modal.show {
      display: block;
    }

    .modal .backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.62);
    }

    .modal .dialog {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(720px, 92vw);
      max-height: min(80vh, 720px);
      overflow: auto;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(10, 14, 24, 0.96);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
    }

    .modal .dialog header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.10);
    }

    .modal .dialog header h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: -0.2px;
    }

    .modal .dialog header .close {
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.06);
      color: #fff;
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .modal .contact-body {
      padding: 14px;
    }

    .contact-notice {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
      margin-bottom: 12px;
    }

    .contact-textarea {
      width: 100%;
      min-height: 130px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      padding: 10px 12px;
      resize: vertical;
      outline: none;
      font-size: 13px;
      line-height: 1.5;
    }

    .contact-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .ui-btnetc {
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(37, 99, 235, 0.85);
      color: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 800;
    }

    .faq-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .faq-q-btn {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.16);
      color: #e5e7eb;
      cursor: pointer;
    }
    /* ===== Emblem Modal UI ===== */
#equipEmblemModal .items{
  overflow: auto;
  padding: 10px;
}

/* 상단: 현재 슬롯/소켓 선택 영역 */
#equipEmblemTarget{
  position: sticky;
  top: 0;
  z-index: 2;
  padding: 8px;
  margin: 0 0 10px 0;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.10);
  background: rgba(0,0,0,0.22);
  backdrop-filter: blur(6px);
}

.em-target-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}
.em-slot-title{
  font-size: 13px;
  font-weight: 800;
  color: rgba(240,230,210,0.95);
}
.em-sockets{
  display:flex;
  gap:8px;
  align-items:center;
}
/* ✅ 상단 소켓 왼쪽에 플래티넘 속성 배지 */
.em-sock-wrap{
  display:flex;
  align-items:center;
  gap:4px;
}

.em-line-badge{
  font-size: 11px;
  font-weight: 900;
  line-height: 1;
  padding: 2px 6px;
  border-radius: 999px;

  color: rgba(240,230,210,0.92);
  background: rgba(0,0,0,0.40);
  border: 1px solid rgba(255,255,255,0.16);

  /* 클릭 방해 방지 */
  pointer-events: none;
}

.em-sock{
  width: 26px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.16);
  background: rgba(0,0,0,0.25);
  position: relative;
  overflow: hidden;
  cursor: pointer;
}
.em-sock.active{
  outline: 2px solid rgba(255,220,140,0.55);
}
.em-sock.has-img{
  background-size: cover;
  background-position: center;
}
.em-sock{
  position: relative; /* 혹시 빠져있으면 보장 */
}

.em-sock .num{
  position:absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);

  font-size: 13px;
  font-weight: 900;
  line-height: 1;

  padding: 3px 7px;
  border-radius: 999px;

  color: rgba(255,255,255,0.95);
  background: rgba(0,0,0,0.55);
  border: 1px solid rgba(255,255,255,0.20);

  text-shadow: 0 1px 2px rgba(0,0,0,0.9);
  pointer-events: none; /* 클릭 방해 방지 */
}

/* ===== Emblem Modal (세로 리스트 버전) ===== */
#equipEmblemList{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.em-group{
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 14px;
  background: rgba(0,0,0,0.18);
  overflow: hidden;
}

.em-group-title{
  padding: 10px 12px;
  font-size: 12px;
  font-weight: 900;
  color: rgba(240,230,210,0.92);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  background: rgba(0,0,0,0.18);
}

/* ✅ 특수장비 플래티넘: 속성 선택 UI */
.em-group-title.plat{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.em-line-btn{
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: rgba(240,230,210,0.92);
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 11px;
  font-weight: 900;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
}
.em-line-btn:active{ transform: translateY(1px); }

.em-line-choices{
  display:none;
  flex-wrap: wrap;
  gap: 8px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.03);
}
.em-line-choices.show{ display:flex; }

.em-line-opt{
  border:1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.25);
  color: rgba(240,230,210,0.92);
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 900;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
}
.em-line-opt.active{
  border-color: rgba(207,162,79,0.9);
  box-shadow: 0 0 0 2px rgba(207,162,79,0.18) inset;
}

.em-plat-hint{
  padding: 10px 12px;
  font-size: 12px;
  color: rgba(240,230,210,0.65);
}

.em-vlist{
  display:flex;
  flex-direction:column;
}

.em-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding: 10px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
  background: transparent;
  cursor:pointer;
  text-align:left;
}
.em-item:last-child{ border-bottom:none; }

.em-item:hover{
  background: rgba(255,255,255,0.04);
}

.em-item .thumb{
  width: 44px;
  height: 44px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.12);
  background: rgba(0,0,0,0.25);
  background-size: cover;
  background-position: center;
  flex: 0 0 auto;
  position: relative;
  overflow: hidden;
}

.em-item.none .thumb{
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 12px;
  font-weight: 900;
  color: rgba(240,230,210,0.75);
  background: rgba(0,0,0,0.18);
}

.em-item .meta{
  flex: 1 1 auto;
  min-width: 0;
}
.em-item .name{
  font-size: 13px;
  font-weight: 900;
  color: rgba(240,230,210,0.95);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.em-item .sub{
  margin-top: 2px;
  font-size: 12px;
  color: rgba(240,230,210,0.65);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.em-item .badge{
  flex: 0 0 auto;
  font-size: 12px;
  font-weight: 900;
  padding: 3px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.12);
  color: rgba(250,240,220,0.95);
  background: rgba(0,0,0,0.25);
}


/* 장비 리스트의 엠블렘 표시(오른쪽 작은 원) */
.equip-emblem-icons{
  display:flex;
  gap:6px;
  align-items:center;
}
.equip-emblem-icons .emb{
  width: 18px;
  height: 18px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(0,0,0,0.18);
  background-size: cover;
  background-position: center;
}
.equip-emblem-icons .emb.has-img{
  box-shadow: 0 0 0 1px rgba(255,220,140,0.25) inset;
}

/* 무기 종류 필터 바 (equipModal 안) */
.weapon-typebar{
  display:none;                 /* 기본 숨김, 무기에서만 show */
  gap: 8px;

  /* ✅ 높이(세로) 키우기 */
  padding: 12px 12px 12px 12px;
  min-height: 56px;
  align-items: center;

  /* ✅ 종류가 많으면 2줄로 내려가게 (영역이 더 넓어 보임) */
  display: flex;
  flex-wrap: wrap;

  /* ✅ 너무 많아져도 모달을 침범하지 않게 제한 */
  max-height: 92px;
  overflow-y: auto;

  /* 스크롤바 숨김(스크롤은 유지) */
  scrollbar-width: none;        /* firefox */
  -ms-overflow-style: none;     /* ie/edge */
}
.weapon-typebar::-webkit-scrollbar{ width:0; height:0; }

.weapon-typebtn{
  flex: 0 0 auto;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  color: rgba(233,238,247,.92);
  border-radius: 999px;
  padding: 9px 12px;
  font-size: 12px;
  font-weight: 900;
  letter-spacing: -0.2px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.weapon-typebtn.active{
  background: rgba(37,99,235,.35);
  border-color: rgba(37,99,235,.55);
}


    /* ✅ 장비 선택 모달만: 상단(헤더+버튼바) 고정, 목록만 스크롤 */
    #equipModal .dialog {
      overflow: hidden;
      /* dialog 전체 스크롤 금지 */
      display: flex;
      flex-direction: column;
    }

    /* 상단 버튼바 */
    #equipModal .equip-topbar {
  flex: 0 0 auto;
  display: flex;
  flex-wrap: wrap;               /* ✅ 버튼들이 다음 줄로 내려감 */
  gap: 8px;
  padding: 10px 14px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.10);
  background: rgba(10, 14, 24, 0.96);

  overflow-x: hidden;            /* ✅ 가로 스크롤 제거 */
  overflow-y: hidden;
}

    /* 버튼 스타일(작고 촘촘하게) */
    #equipModal .equip-topbtn {
      flex: 0 0 auto;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(233, 238, 247, 0.92);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }

    #equipModal .equip-topbtn.active {
      background: rgba(37, 99, 235, 0.85);
      border-color: rgba(37, 99, 235, 0.65);
      color: #fff;
    }

    /* ✅ 상단바: 엠블렘 버튼은 구멍만 표시 */
    #equipModal .equip-topbtn.is-emblems {
      padding: 6px 10px;
      min-width: 48px;
    }

    #equipModal .equip-topbtn .top-embs {
      display: flex;
      flex-direction: column;
      /* 세로 배치 */
      gap: 6px;
      align-items: center;
      justify-content: center;
    }

    #equipModal .equip-topbtn .top-embs .emb {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.22);
      display: block;
    }


    /* ✅ topbar 엠블렘: 버튼이 아니라 "구멍 2개" */
    #equipModal .equip-topemblem {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.06);
      color: rgba(255, 255, 255, 0.90);
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      user-select: none;
    }

    #equipModal .equip-topemblem .label {
      font-size: 11px;
      font-weight: 900;
      letter-spacing: -0.2px;
    }

    #equipModal .equip-topemblem .holes {
      display: inline-flex;
      flex-direction: column;
      /* ✅ 세로로 2개 */
      gap: 6px;
      align-items: center;
    }

    #equipModal .equip-topemblem .hole {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.10), rgba(0, 0, 0, 0.45) 72%);
      box-shadow:
        inset 0 2px 5px rgba(0, 0, 0, 0.55),
        0 1px 0 rgba(255, 255, 255, 0.06);
    }

    #equipModal .equip-topemblem.active {
      background: rgba(37, 99, 235, 0.85);
      border-color: rgba(37, 99, 235, 0.95);
      color: #fff;
    }

    #equipModal .equip-topemblem.active .hole {
      border-color: rgba(255, 255, 255, 0.32);
    }

    #equipModal .equip-topemblem:focus {
      outline: 2px solid rgba(37, 99, 235, 0.7);
      outline-offset: 2px;
    }


    /* ✅ 목록만 스크롤 */
    #equipModal #equipCatalog {
      flex: 1 1 auto;
      min-height: 0;
      /* flex에서 overflow 작동 필수 */
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ✅ 모달 내부 리스트: 스크롤바(막대)만 숨기고, 터치 스와이프 스크롤은 유지 */
#equipCatalog,
#equipEnhList,
#equipSealUList,
#equipSealNList,
#equipEnchantList,
#equipGrindList{
  overflow: auto;                 /* 스크롤은 가능해야 손으로 밀림 */
  -webkit-overflow-scrolling: touch; /* iOS 관성 스크롤 */
  scrollbar-width: none;          /* Firefox: 스크롤바 숨김 */
}


/* ✅ (선택모달) dialog 자체는 스크롤 금지: 스크롤은 리스트에서만 */
dialog,
#equipEnhModal .dialog,
#equipSealUModal .dialog,
#equipSealNModal .dialog,
#equipEnchantModal .dialog,
#equipEmblemModal .dialog,
#equipGrindModal .dialog{
  overflow: hidden;
  display: flex;            /* ✅ 추가 */
  flex-direction: column;   /* ✅ 추가 */
}

/* ✅ 헤더 아래 남은 공간을 items가 먹고, 그 안의 리스트만 스크롤되게 */
#equipEnhModal .items,
#equipSealUModal .items,
#equipSealNModal .items,
#equipEnchantModal .items,
#equipEmblemModal .items,
#equipGrindModal .items{
  flex: 1 1 auto;     /* ✅ 추가 */
  min-height: 0;      /* ✅ 핵심: flex 환경에서 내부 overflow가 작동하려면 필요 */
  overflow: hidden;   /* ✅ dialog은 숨기고, 실제 스크롤은 리스트에서만 */
}

/* ✅ 리스트: “스크롤바는 숨기되” 터치 스크롤은 허용 */
#equipCatalog,
#equipEnhList,
#equipSealUList,
#equipSealNList,
#equipEnchantList,
#equipEmblemList,
#equipGrindList{
  height: 100%;                 /* ✅ 추가: items 높이를 꽉 채움 */
  overflow: auto;
  overflow-x: hidden;           /* ✅ 가로 스크롤 방지 */
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  touch-action: pan-y;          /* ✅ 모바일에서 위/아래 드래그를 스크롤로 확실히 */
  overscroll-behavior: contain; /* ✅ 바운스/배경 스크롤 간섭 줄이기 */
}

/* Chrome/Safari/Edge: 스크롤바 숨김 */
#equipCatalog::-webkit-scrollbar,
#equipEnhList::-webkit-scrollbar,
#equipSealUList::-webkit-scrollbar,
#equipSealNList::-webkit-scrollbar,
#equipEnchantList::-webkit-scrollbar,
#equipEmblemList::-webkit-scrollbar,
#equipGrindList::-webkit-scrollbar{
  width: 0;
  height: 0;
  display: none;
}




  </style>
</head>

<body>
  <div class="m-shell">

    <!-- ====== Header ====== -->
    <header class="m-header">
      <div class="m-header-row">
        <div class="m-title">
          <div class="txt">게임실험연구소 계산기 (시즌5)</div>
        </div>

        <div class="m-actions">
          <!-- 문의하기 (PC와 동일 id 유지) -->
          <button id="btnContactAdmin" class="m-action-btn" type="button" title="문의하기">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <rect x="3" y="6" width="18" height="13" rx="2"></rect>
              <path d="M3 8l9 6 9-6"></path>
            </svg>
            <span>문의하기</span>
          </button>

          <!-- Q&A (PC와 동일 id 유지) -->
          <button id="btnFaq" class="m-action-btn" type="button" title="문의 전 자주하는 Q&A">
            <span>Q&amp;A</span>
          </button>
        </div>
      </div>
    </header>

    <!-- ====== Main (Swipe) ====== -->
    <main class="m-main">
      <div id="mobilePages" class="m-pages">

        <!-- Page 1: 캐릭터 -->
        <section class="m-page" id="pageChar">
          <div class="m-card">
            <div class="page-title">1 / 3</div>
            <div class="big-pick">
              <button id="btnPickChar" type="button">캐릭터 선택하기</button>
              <!-- ✅ 선택 후 표시될 캐릭터 이미지 -->
              <img id="pickedCharImg" class="picked-char-img" alt="" />
            </div>
            <div class="hint">
              • 좌/우로 넘겨가며 설정합니다.<br />
              • 지금은 모바일 UI 뼈대만 만든 상태입니다.
            </div>
          </div>
        </section>
        <!-- 캐릭터 선택 모달 (PC와 동일 id) -->
        <div id="charModal" class="modal" aria-hidden="true">
          <div class="backdrop" data-char-close></div>
          <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="charModalTitle">
            <header>
              <h2 id="charModalTitle">캐릭터 선택</h2>
              <button type="button" class="close" data-char-close>닫기</button>
            </header>

            <!-- PC 스크립트가 여기에 카드들을 렌더링함 -->
            <div id="catalog" class="catalog"></div>
          </div>
        </div>


        <!-- Page 2: 장비 -->
        <!-- ✅ 장비 선택 모달 -->
        <div id="equipModal" class="modal" aria-hidden="true">
          <div class="backdrop" data-equip-close></div>
          <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="equipModalTitle">
            <header>
              <h2 id="equipModalTitle">장비 선택</h2>
              <button type="button" class="close" data-equip-close>닫기</button>
            </header>
            <div class="equip-topbar" id="equipTopbar">
              <button type="button" class="equip-topbtn active" data-eqtab="enh">강화</button>

              <!-- ✅ 추가: 보조장비(sub)에서만 보여줄 연마 버튼 -->
              <button type="button" class="equip-topbtn equip-topbtn-grind" data-eqtab="grind"
                style="display:none;">연마</button>

              <!-- ✅ 마법봉인 = 고유옵션/일반옵션 2개 -->
              <button type="button" class="equip-topbtn" data-eqtab="seal_u">고유옵션</button>
              <button type="button" class="equip-topbtn" data-eqtab="seal_n">일반옵션</button>

              <button type="button" class="equip-topbtn" data-eqtab="enchant">마법부여</button>

              <!-- ✅ 엠블렘: 글자 없이 “구멍”만 (구멍 자체가 버튼) -->
              <button type="button" class="equip-topbtn is-emblems" data-eqtab="emblem" aria-label="엠블렘 선택">
                <span class="top-embs">
                  <!-- JS에서 슬롯 종류에 따라 1개/2개로 다시 그려줌 -->
                  <span class="emb"></span>
                  <span class="emb"></span>
                </span>
              </button>
            </div>


            <div id="equipCatalog" class="catalog"></div>
          </div>
        </div>

        <!-- ✅ (방법B) 강화 선택 2중 모달 -->
<div id="equipEnhModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-equip-enh-close></div>

  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="equipEnhModalTitle">
    <header>
      <h2 id="equipEnhModalTitle">강화 선택</h2>
      <button type="button" class="close" data-equip-enh-close>✕</button>
    </header>

    <div class="items">
      <div id="equipEnhList" class="enh-list"></div>
    </div>
  </div>
</div>

<!-- ✅ (방법B) 마법봉인: 고유옵션 2중 모달 -->
<div id="equipSealUModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-equip-seal-u-close></div>

  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="equipSealUModalTitle">
    <header>
      <h2 id="equipSealUModalTitle">고유옵션 선택</h2>
      <button type="button" class="close" data-equip-seal-u-close>✕</button>
    </header>

    <div class="items">
      <div id="equipSealUList" class="enh-list"></div>
    </div>
  </div>
</div>

<!-- ✅ (방법B) 마법봉인: 일반옵션 2중 모달 -->
<div id="equipSealNModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-equip-seal-n-close></div>

  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="equipSealNModalTitle">
    <header>
      <h2 id="equipSealNModalTitle">일반옵션 선택</h2>
      <button type="button" class="close" data-equip-seal-n-close>✕</button>
    </header>

    <div class="items">
      <div id="equipSealNList" class="enh-list"></div>
    </div>
  </div>
</div>

<!-- ✅ (방법B) 마법부여 선택 2중 모달 -->
<div id="equipEnchantModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-equip-enchant-close></div>

  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="equipEnchantModalTitle">
    <header>
      <h2 id="equipEnchantModalTitle">마법부여 선택</h2>
      <button type="button" class="close" data-equip-enchant-close>✕</button>
    </header>

    <div class="items">
      <div id="equipEnchantList" class="enh-list"></div>
    </div>
  </div>
</div>

<!-- ✅ (추가) 엠블렘 선택 2중 모달 -->
<div id="equipEmblemModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-equip-emblem-close></div>

  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="equipEmblemModalTitle">
    <header>
      <h2 id="equipEmblemModalTitle">엠블렘 선택</h2>
      <button type="button" class="close" data-equip-emblem-close>✕</button>
    </header>

    <div class="items">
      <div id="equipEmblemTarget"></div>
      <div id="equipEmblemList"></div>
    </div>
  </div>
</div>

<!-- ✅ (방법B) 연마 선택 2중 모달 -->
<div id="equipGrindModal" class="modal" aria-hidden="true">
  <div class="backdrop" data-equip-grind-close></div>

  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="equipGrindModalTitle">
    <header>
      <h2 id="equipGrindModalTitle">연마 선택</h2>
      <button type="button" class="close" data-equip-grind-close>✕</button>
    </header>

    <div class="items">
      <div id="equipGrindList" class="enh-list"></div>
    </div>
  </div>
</div>





        <section class="m-page" id="pageEquip">
          <div class="m-card">
            <div class="page-title">2 / 3</div>

            <div class="equip-body">

              <!-- 무기 -->
              <div class="equip-group">
                <div class="equip-group-head">무기</div>
                <div class="equip-list">
                  <button type="button" class="equip-row" data-slot="weapon" data-grind="1" aria-label="무기 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">무기</div>
                    </div>

                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>

                      <div class="equip-opts">
                        <div class="equip-col-title">마법봉인</div>
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>

                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>

                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>
                </div>
              </div>

              <!-- 방어구 -->
              <div class="equip-group">
                <div class="equip-group-head">방어구</div>
                <div class="equip-list">

                  <button type="button" class="equip-row" data-slot="headshoulder" aria-label="머리어깨 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">머리어깨</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="equip-row" data-slot="top" aria-label="상의 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">상의</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="equip-row" data-slot="bottom" aria-label="하의 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">하의</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="equip-row" data-slot="belt" aria-label="허리 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">허리</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="equip-row" data-slot="shoes" aria-label="신발 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">신발</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                </div>
              </div>

              <!-- 악세사리 -->
              <div class="equip-group">
                <div class="equip-group-head">악세사리</div>
                <div class="equip-list">

                  <button type="button" class="equip-row" data-slot="bracelet" aria-label="팔찌 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">팔찌</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="equip-row" data-slot="necklace" aria-label="목걸이 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">목걸이</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="equip-row" data-slot="ring" aria-label="반지 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">반지</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span><span class="emb"></span>
                           </div>
                        </div>
                      </div>
                  </button>

                </div>
              </div>

              <!-- 특수장비 -->
              <div class="equip-group">
                <div class="equip-group-head">특수장비</div>
                <div class="equip-list">

                  <button type="button" class="equip-row" data-slot="sub" data-grind="1" aria-label="보조장비 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">보조장비</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="equip-row" data-slot="magestone" aria-label="마법석 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">마법석</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                  <button type="button" class="equip-row" data-slot="earring" aria-label="귀걸이 선택">
                    <div class="equip-left">
                      <div class="equip-img" aria-hidden="true"></div>
                      <div class="equip-name">귀걸이</div>
                    </div>
                    <div class="equip-right">
                      <div class="equip-enh">
                        <div class="equip-enh-val">강화 +0</div>
                        <div class="equip-grind">연마 -</div>
                      </div>
                      <div class="equip-opts">
                        <div class="equip-unique">고유옵션 -</div>
                        <div class="equip-normal">일반옵션 -</div>
                      </div>
                      <div class="equip-enchant">
                        <div class="equip-col-title">마법부여</div>
                        <div class="equip-col-body">-</div>
                      </div>
                      <div class="equip-emblems">
                        <div class="equip-col-title">엠블렘</div>
                        <div class="equip-emblem-icons">
                          <span class="emb"></span>
                        </div>
                      </div>
                    </div>
                  </button>

                </div>
              </div>

            </div>
          </div>
        </section>



      </div>
    </main>

    <!-- ====== Bottom Fixed ====== -->
    <footer class="m-footer" style="height: var(--footer-h);">
      <div class="m-footer-row">
        <button id="btnMobileCompute" class="m-calc-btn" type="button">계산하기</button>

        <div class="m-result">
          <div class="label">계산 결과</div>
          <div id="mobileFinalDamage" class="value">-</div>
        </div>
      </div>
    </footer>

  </div>

  <!-- ====== Modals (PC 것을 그대로 가져오기 쉬운 형태) ====== -->
  <!-- 관리자 문의 모달 -->
  <div id="contactModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-contact-close></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
      <header>
        <h2 id="contactTitle">게임실험연구소에 문의하기</h2>
        <button type="button" class="close" data-contact-close>닫기</button>
      </header>

      <div class="contact-body">
        <div class="contact-notice">
          계산기 이용 중 정상적이지 않은 동작/오류/버그를 제보해주세요.<br />
          실시간 문의: 게임실험연구소 오픈채팅
        </div>

        <textarea id="contactTalk" class="contact-textarea" placeholder="문의 내용을 적어주세요."></textarea>
        <div class="contact-actions">
          <button id="btnContactSend" class="ui-btnetc" type="button">문의 보내기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FAQ 목록 모달 -->
  <div id="faqModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-faq-close></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
      <header>
        <h2 id="faqTitle">문의하기 전 자주하는 Q&amp;A</h2>
        <button type="button" class="close" data-faq-close>닫기</button>
      </header>

      <div class="contact-body">
        <div class="contact-notice">
          가장 많이 하시는 질문들을 모아두었습니다.
        </div>
        <div id="faqList" class="faq-list"></div>
      </div>
    </div>
  </div>

  <!-- FAQ 답변 모달 (일단 placeholder) -->
  <div id="faqAnswerModal" class="modal" aria-hidden="true">
    <div class="backdrop" data-faqans-close></div>
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="faqAnswerTitle">
      <header>
        <h2 id="faqAnswerTitle">Q&amp;A</h2>
        <button type="button" class="close" data-faqans-close>닫기</button>
      </header>
      <div class="contact-body">
        <div id="faqAnswerText" class="contact-notice"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    window.idToken = sessionStorage.getItem('id_token') || null;
    window.WEBAPP_URL = window.WEBAPP_URL || 'https://dnf-backend.gogo456654.workers.dev';
    const WEBAPP_URL = window.WEBAPP_URL;   // 기존 코드들이 쓰는 식별자 보존
    // DB
    const DB = { itemsBySlot: {}, loaded: {}, chars: { loaded: false, groups: [] } };
    // ✅ 전역이 없으면 만들고
    window.DBEnh = window.DBEnh || { loaded: false, list: [], byType: {} };
    // ✅ 지역 별칭은 전역을 가리키게
    const DBEnh = window.DBEnh;
    // 1) 토큰만 보내는 API (시트/목록 로딩 계열)
    function getStoredToken() {
      return (
        window.idToken ||
        sessionStorage.getItem('id_token') ||
        localStorage.getItem('id_token') ||
        null
      );
    }

    async function waitForIdToken(timeoutMs = 1500) {
      // 1) 즉시 꺼내기
      const now = getStoredToken();
      if (now) {
        window.idToken = now;
        return now;
      }

      // 2) 짧게 폴링(PC에서 넘어오는 타이밍이 애매할 때 대비)
      const t0 = Date.now();
      while (Date.now() - t0 < timeoutMs) {
        const tok = getStoredToken();
        if (tok) {
          window.idToken = tok;
          return tok;
        }
        await new Promise(r => setTimeout(r, 60));
      }

      throw new Error('no_id_token');
    }

    async function apiText(type) {
      const token = await waitForIdToken();
      const res = await fetch(`${WEBAPP_URL}?type=${encodeURIComponent(type)}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain',
          'Authorization': `Bearer ${token}`,
        },
        body: token, // ✅ 하위호환 유지
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          // 토큰이 만료/거부일 때 대비(선택)
          // sessionStorage.removeItem('id_token'); localStorage.removeItem('id_token');
        }
        throw new Error(`${type}_http_${res.status}`);
      }

      // 응답이 JSON이라고 가정하지만, 안전하게 처리
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { throw new Error(`${type}_bad_json`); }
    }

    async function apiJSON(type, payload = {}) {
      const token = await waitForIdToken();

      // ✅ 네 기존 형식 유지: Authorization + body.id_token
      const body = { id_token: token, ...payload };

      const res = await fetch(`${WEBAPP_URL}?type=${encodeURIComponent(type)}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify(body),
      });

      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          // sessionStorage.removeItem('id_token'); localStorage.removeItem('id_token');
        }
        throw new Error(`${type}_http_${res.status}`);
      }

      const text = await res.text();
      try { return JSON.parse(text); }
      catch { throw new Error(`${type}_bad_json`); }
    }

    // ✅ 모바일: 최초 1회 init 호출로 경량리스트(=CORE.lists) 전부 확보
    let __mobileInitPromise = null;

    async function initMobileAllLightListsOnce() {
      if (__mobileInitPromise) return __mobileInitPromise;

      __mobileInitPromise = (async () => {
        const res = await apiJSON('init', {});
        if (!res?.ok) {
          __mobileInitPromise = null;
          throw new Error(res?.error || 'init_failed');
        }

        window.CORE = window.CORE || {};
        CORE.lists = res.lists || {};
        CORE.userEmail = res.email || null;

        return CORE.lists;
      })();

      return __mobileInitPromise;
    }

    // ===== 캐릭터 선택 (모바일 전용: 좌 썸네일 / 우 이름) =====
    window.state = window.state || {};

    function _normImg(src) {
      const s = String(src || '').trim();
      if (!s) return '';
      if (/^https?:\/\//i.test(s)) return s;
      // img/xxx 형태면 현재 경로 기준으로 로딩되게
      if (s.startsWith('img/')) return './' + s.replace(/^\.?\//, '');
      return s;
    }

    function _pick(obj, keys) {
      for (const k of keys) {
        if (obj && obj[k] != null && String(obj[k]).trim() !== '') return obj[k];
      }
      return '';
    }

    function _getCharName(c) {
      return String(_pick(c, ['name', '이름', 'charName', '캐릭터명']) || '').trim();
    }
    function _getCharThumb(c) {
      return _normImg(_pick(c, ['thumbnail', '썸네일', 'thumb', 'thumbSrc']));
    }
    // ✅ 메인 표시용: 반드시 '이미지' 컬럼만 사용(썸네일 fallback 금지)
    function _getCharMainImage(c) {
      // 혹시 컬럼명이 공백 포함(예: "이미지 " )으로 들어오는 경우까지 커버
      const direct = _pick(c, ['fullSrc', '이미지', 'image', 'img', 'imgSrc']);
      if (direct) return _normImg(direct);

      // 느슨한 매칭(키의 공백 제거 후 비교)
      const target = new Set(['이미지', 'image', 'img', 'imgsrc'].map(s => s.toLowerCase()));
      for (const k in (c || {})) {
        const nk = String(k).replace(/\s+/g, '').toLowerCase();
        if (target.has(nk) && String(c[k] || '').trim() !== '') return _normImg(c[k]);
      }
      return '';
    }
    function applyPickedCharacterUI(c) {
      const pickBtn = document.getElementById('btnPickChar');
      const imgEl = document.getElementById('pickedCharImg');

      if (!pickBtn || !imgEl) return;

      const name = _getCharName(c) || '';
      const imgSrc = _getCharMainImage(c);  // ✅ 메인은 '이미지'만

      // 이미지가 없으면(예외) 기존 버튼 유지
      if (!imgSrc) {
        pickBtn.style.display = '';
        pickBtn.textContent = name || '캐릭터 선택하기';
        imgEl.style.display = 'none';
        imgEl.removeAttribute('src');
        imgEl.alt = '';
        return;
      }

      // ✅ 요구사항: 선택버튼은 사라지고 이미지가 들어감
      pickBtn.style.display = 'none';
      imgEl.src = imgSrc;
      imgEl.alt = name ? `${name} 이미지` : '';
      imgEl.style.display = 'block';

      if (!imgEl.dataset.boundPick) {
        imgEl.dataset.boundPick = '1';
        imgEl.addEventListener('click', () => openMobileCharacterPicker());
      }
    }

    function _getCharJobGroup(c) {
      return String(_pick(c, ['jobGroup', '직업군', 'group', 'job_group']) || '').trim();
    }
    function _getCharBadge(c) {
      // ‘종류’ 컬럼(배지 이미지)
      return _normImg(_pick(c, ['type', '종류', 'badge', 'badgeSrc', 'kind']) || '');
    }

    function renderMobileCharList(items) {
      const catalog = document.getElementById('catalog');
      if (!catalog) return;

      catalog.innerHTML = '';

      if (!Array.isArray(items) || items.length === 0) {
        catalog.innerHTML = `<div style="opacity:.8;padding:12px;">캐릭터 목록이 비어있습니다.</div>`;
        return;
      }

      // 1) 직업군별로 그룹 만들기(등장 순서 유지)
      const order = [];
      const groups = new Map(); // jobGroup -> { title, badge, list: [] }

      for (const c of items) {
        const name = _getCharName(c);
        if (!name) continue;

        const job = _getCharJobGroup(c) || '기타';
        const badge = _getCharBadge(c);

        if (!groups.has(job)) {
          groups.set(job, { title: job, badge: badge || '', list: [] });
          order.push(job);
        }
        const g = groups.get(job);
        if (!g.badge && badge) g.badge = badge; // 비어있으면 채워두기

        g.list.push(c);
      }

      // 2) 렌더
      const frag = document.createDocumentFragment();

      for (const job of order) {
        const g = groups.get(job);

        const groupEl = document.createElement('div');
        groupEl.className = 'mchar-group';

        // 헤더(배지 + 직업군명)
        const head = document.createElement('div');
        head.className = 'mchar-group-head';

        const img = document.createElement('img');
        img.className = 'mchar-badge';
        img.loading = 'lazy';
        img.alt = job;
        // 배지 없을 때 깨짐 방지(투명 1x1)
        img.src = g.badge || 'data:image/gif;base64,R0lGODlhAQABAAAAACw=';

        const titleWrap = document.createElement('div');
        titleWrap.innerHTML = `
      <span class="mchar-group-title">${job}</span>
      <span class="mchar-group-sub">(${g.list.length})</span>
    `;

        head.appendChild(img);
        head.appendChild(titleWrap);

        // 바디(기존 row를 그대로 사용)
        const body = document.createElement('div');
        body.className = 'mchar-group-body';

        for (const c of g.list) {
          const name = _getCharName(c);
          const thumb = _getCharThumb(c);

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'mchar-row';
          btn.innerHTML = `
        <img class="mchar-thumb" src="${thumb}" alt="">
        <div class="mchar-name">${name}</div>
      `;

          btn.addEventListener('click', () => {
            // 선택 저장
            window.state.currentCharacter = { ...c, name };

            // ✅ 버튼 숨기고, 캐릭 이미지 표시
            applyPickedCharacterUI(window.state.currentCharacter);

            // 모달 닫기
            const m = document.getElementById('charModal');
            if (m) {
              m.classList.remove('show');
              m.setAttribute('aria-hidden', 'true');
            }
          });

          body.appendChild(btn);
        }

        groupEl.appendChild(head);
        groupEl.appendChild(body);
        frag.appendChild(groupEl);
      }

      catalog.appendChild(frag);
    }

    async function openMobileCharacterPicker() {
      // init에서 경량리스트들 받아온다
      await initMobileAllLightListsOnce();

      // 핵심: char:list 배열
      const items = window.CORE?.lists?.['char:list'];

      renderMobileCharList(items);

      const m = document.getElementById('charModal');
      if (m) {
        m.classList.add('show');
        m.setAttribute('aria-hidden', 'false');
      }
    }

    // 닫기(backdrop + 닫기 버튼)
    document.querySelectorAll('[data-char-close]').forEach(el => {
      el.addEventListener('click', () => {
        const m = document.getElementById('charModal');
        m?.classList.remove('show');
        m?.setAttribute('aria-hidden', 'true');
      });
    });


    // ===== Toast =====
    function toast(msg) {
      const el = document.getElementById('toast');
      if (!el) return alert(msg);
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(el._t);
      el._t = setTimeout(() => el.classList.remove('show'), 1400);
    }

    // ✅ 페이지 열리면 즉시 경량리스트 전부 로드
    initMobileAllLightListsOnce().catch((e) => {
      console.error(e);
      toast('초기 데이터 로딩 실패');
    });

    // ===== Swipe Pages (PointerEvent: 터치/마우스 모두 지원) =====
    (function initSwipePages() {
      const pages = document.getElementById('mobilePages');
      if (!pages) return;

      // 실제 페이지(.m-page)만 카운트
      const getPageEls = () => Array.from(pages.children).filter(el => el.classList?.contains('m-page'));
      const getPageCount = () => getPageEls().length;

      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const pageWidth = () => pages.clientWidth || 1;
      const getIndex = () => Math.round(pages.scrollLeft / pageWidth());

      window.goToMobilePage = (i) => {
        const cnt = getPageCount();
        const idx = clamp(i | 0, 0, Math.max(0, cnt - 1));
        pages.scrollTo({ left: idx * pageWidth(), behavior: 'smooth' });
      };

      let pid = null;
      let sx = 0, sy = 0, startLeft = 0, lastDx = 0, dragging = false, horiz = null;

      const LOCK = 8;   // 방향 판별 최소 이동
      const TH = 40;  // 페이지 넘김 임계치(px)

      function onEnd() {
        if (!dragging) return;
        dragging = false;

        if (horiz !== true) { pid = null; return; }

        const w = pageWidth();
        const cnt = getPageCount();
        let idx = Math.round(startLeft / w);

        if (lastDx < -TH) idx += 1;
        else if (lastDx > TH) idx -= 1;
        else idx = getIndex();

        idx = clamp(idx, 0, Math.max(0, cnt - 1));
        pages.scrollTo({ left: idx * w, behavior: 'smooth' });

        pid = null;
      }

      pages.addEventListener('pointerdown', (e) => {
        // 마우스 좌클릭/터치만
        if (e.pointerType === 'mouse' && e.button !== 0) return;

        pid = e.pointerId;
        pages.setPointerCapture?.(pid);

        sx = e.clientX; sy = e.clientY;
        startLeft = pages.scrollLeft;
        lastDx = 0;
        dragging = true;
        horiz = null;
      }, { passive: true });

      pages.addEventListener('pointermove', (e) => {
        if (!dragging || pid == null || e.pointerId !== pid) return;

        const dx = e.clientX - sx;
        const dy = e.clientY - sy;
        lastDx = dx;

        if (horiz === null) {
          if (Math.abs(dx) < LOCK && Math.abs(dy) < LOCK) return;
          horiz = Math.abs(dx) > Math.abs(dy);
        }

        // 세로 제스처면 놔둠(페이지 내부 스크롤)
        if (!horiz) return;

        // 가로 제스처면 우리가 scrollLeft를 직접 제어
        e.preventDefault?.();
        pages.scrollLeft = startLeft - dx;
      }, { passive: false });

      pages.addEventListener('pointerup', onEnd, { passive: true });
      pages.addEventListener('pointercancel', onEnd, { passive: true });
    })();


    // ===== Header actions =====
    function openModal(id) {
      const m = document.getElementById(id);
      if (!m) return;
      m.classList.add('show');
      m.setAttribute('aria-hidden', 'false');
    }
    function closeModal(id) {
      const m = document.getElementById(id);
      if (!m) return;
      m.classList.remove('show');
      m.setAttribute('aria-hidden', 'true');
    }

    document.getElementById('btnContactAdmin')?.addEventListener('click', () => openModal('contactModal'));
    document.getElementById('btnFaq')?.addEventListener('click', () => {
      // 나중에 PC의 getFaqItems/openFaqModal 로직을 그대로 붙이면 됨
      const list = document.getElementById('faqList');
      if (list) {
        list.innerHTML = '';
        const empty = document.createElement('div');
        empty.style.opacity = '0.8';
        empty.textContent = '등록된 Q&A가 없습니다.';
        list.appendChild(empty);
      }
      openModal('faqModal');
    });

    // backdrop/close 공통
    document.querySelectorAll('[data-contact-close]').forEach(el => {
      el.addEventListener('click', () => closeModal('contactModal'));
    });
    document.getElementById('contactModal')?.addEventListener('click', (e) => {
      if (e.target?.classList?.contains('backdrop')) closeModal('contactModal');
    });

    document.querySelectorAll('[data-faq-close]').forEach(el => {
      el.addEventListener('click', () => closeModal('faqModal'));
    });
    document.getElementById('faqModal')?.addEventListener('click', (e) => {
      if (e.target?.classList?.contains('backdrop')) closeModal('faqModal');
    });

    document.querySelectorAll('[data-faqans-close]').forEach(el => {
      el.addEventListener('click', () => closeModal('faqAnswerModal'));
    });
    document.getElementById('faqAnswerModal')?.addEventListener('click', (e) => {
      if (e.target?.classList?.contains('backdrop')) closeModal('faqAnswerModal');
    });

    // ===== Equip Picker =====
    const EQUIP_SLOT_LABELS = {
      headshoulder: '머리어깨',
      top: '상의',
      bottom: '하의',
      belt: '허리',
      shoes: '신발',
      bracelet: '팔찌',
      necklace: '목걸이',
      ring: '반지',
      sub: '보조장비',
      magestone: '마법석',
      earring: '귀걸이',
      weapon: '무기',
    };

    function _equipListKey(slot) {
      return `${slot}:list`;
    }
function _baseJG_mobile(s){
  s = String(s || '').trim();
  // 괄호 안 옵션 제거(예: 거너(남) -> 거너)
  return s.replace(/\(.*?\)/g, '').trim();
}

function _jgMatches_mobile(a, b){
  a = String(a || '').trim();
  b = String(b || '').trim();
  if(!a || !b) return true;

  const aa = _baseJG_mobile(a);
  const bb = _baseJG_mobile(b);

  return (
    a === b ||
    aa === bb ||
    a.includes(b) || b.includes(a) ||
    aa.includes(bb) || bb.includes(aa)
  );
}

function _getEquipJobGroup_mobile(it){
  // 데이터 키가 뭐든 최대한 잡아내기
  return String(_pick(it, ['jobGroup','직업군','group','job_group','직업군(필터)']) || '').trim();
}

function _getWeaponType_mobile(it){
  // 무기 "종류" 컬럼(예: 소검/대검/권총 등) 최대한 잡아내기
  return String(_pick(it, ['type','종류','weaponType','무기종류','kind']) || '').trim();
}

function _ensureWeaponTypeBar_mobile(){
  let bar = document.getElementById('weaponTypeBar');
  if(bar) return bar;

  const dialog = document.querySelector('#equipModal .dialog');
  const catalog = document.getElementById('equipCatalog');
  if(!dialog || !catalog) return null;

  bar = document.createElement('div');
  bar.id = 'weaponTypeBar';
  bar.className = 'weapon-typebar';

  // equipCatalog 바로 위(=모달 안, 목록 위)에 끼워넣기
  dialog.insertBefore(bar, catalog);
  return bar;
}

function _hideWeaponTypeBar_mobile(){
  const bar = document.getElementById('weaponTypeBar');
  if(!bar) return;
  bar.style.display = 'none';
  bar.innerHTML = '';
}

function renderWeaponTypeBar_mobile(types, activeType, onPick){
  const bar = _ensureWeaponTypeBar_mobile();
  if(!bar) return;

  if(!Array.isArray(types) || types.length === 0){
    _hideWeaponTypeBar_mobile();
    return;
  }

  bar.style.display = 'flex';
  bar.innerHTML = '';

  // ✅ '전체' 없음: types만 렌더
  types.forEach(t=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'weapon-typebtn';
    b.textContent = t;
    if(t === activeType) b.classList.add('active');
    b.addEventListener('click', ()=>onPick(t));
    bar.appendChild(b);
  });
}

    function closeEquipModal() {
        _hideWeaponTypeBar_mobile();

  closeEquipEnhModal();
  closeEquipSealUModal();
  closeEquipSealNModal();
  closeEquipEnchantModal();
  closeEquipEmblemModal();

  const m = document.getElementById('equipModal');
  if (!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden', 'true');
}

    function openEquipModal() {
      const m = document.getElementById('equipModal');
      if (!m) return;
      m.classList.add('show');
      m.setAttribute('aria-hidden', 'false');
    }

    // 닫기(backdrop + 닫기 버튼)
    document.querySelectorAll('[data-equip-close]').forEach(el => {
      el.addEventListener('click', closeEquipModal);
    });
    document.getElementById('equipModal')?.addEventListener('click', (e) => {
      if (e.target?.classList?.contains('backdrop')) closeEquipModal();
    });

    function renderMobileEquipList(slot, items) {
      const titleEl = document.getElementById('equipModalTitle');
      if (titleEl) titleEl.textContent = `${EQUIP_SLOT_LABELS[slot] || slot} 선택`;

      const catalog = document.getElementById('equipCatalog');
      if (!catalog) return;
      catalog.innerHTML = '';

      const wrap = document.createElement('div');
      wrap.className = 'meq-wrap';

      for (const it of items) {
        const name = String(it?.name || '').trim();
        if (!name) continue;

        const img = _normImg(it?.image || '');

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'meq-row';
        btn.innerHTML = `
      <img class="meq-thumb" src="${img}" alt="">
      <div class="meq-name">${name}</div>
    `;

        btn.addEventListener('click', () => {
          window.state = window.state || {};
          window.state.equips = window.state.equips || {};
          window.state.equips[slot] = it;

          applyPickedEquipUI(slot, it);
          closeEquipModal();
        });

        wrap.appendChild(btn);
      }

      catalog.appendChild(wrap);
    }

    function applyPickedEquipUI(slot, it) {
      const row = document.querySelector(`#pageEquip .equip-row[data-slot="${slot}"]`);
      if (!row) return;

      // 왼쪽 이미지
      const imgBox = row.querySelector('.equip-img');
      if (imgBox) {
        const src = _normImg(it?.image || '');
        imgBox.style.backgroundImage = src ? `url("${src}")` : '';
        imgBox.style.backgroundSize = 'cover';
        imgBox.style.backgroundPosition = 'center';
        imgBox.style.backgroundRepeat = 'no-repeat';
      }

      // 이미지 아래 “장비이름”
      const nameEl = row.querySelector('.equip-name');
      if (nameEl) {
        nameEl.textContent = String(it?.name || EQUIP_SLOT_LABELS[slot] || '').trim();
      }

      // 우측 고유/일반 옵션 칸은 우선 prefix/desc로 채워줌(없으면 -)
      const uniqueEl = row.querySelector('.equip-unique');
      if (uniqueEl) {
        uniqueEl.textContent = String(it?.prefix || '').trim() || '—';
      }
      const normalEl = row.querySelector('.equip-normal');
      if (normalEl) {
        normalEl.textContent = String(it?.desc || '').trim() || '—';
      }
      _syncEnhLabelFromState_mobile(slot);
      _syncSealLabelFromState_mobile(slot);
      _syncGrindLabelFromState_mobile(slot);
    }

    // ===== Enhancement Picker (Mobile) =====
    function _enhTypeForSlot_mobile(slot) {
      if (slot === 'weapon') return '무기강화';
      if (['headshoulder', 'top', 'bottom', 'belt', 'shoes'].includes(slot)) return '방어구강화';
      if (['bracelet', 'necklace', 'ring'].includes(slot)) return '악세강화';
      if (['sub', 'support', 'earring', 'magestone'].includes(slot)) return '보장강화';
      return null;
    }

    function _getLightEnhList_mobile() {
      const lists = window.CORE?.lists || {};
      const list = lists['enh:list'] || lists['enhList']; // 백엔드 키가 enh:list면 이걸로 잡힘
      return Array.isArray(list) ? list : [];
    }

    function _parseEnhLevel_mobile(name) {
      const s = String(name || '');
      let m = s.match(/\+(\d{1,2})/); if (m) return parseInt(m[1], 10);
      m = s.match(/(\d{1,2})\s*강/); if (m) return parseInt(m[1], 10);
      m = s.match(/(\d{1,2})/); if (m) return parseInt(m[1], 10);
      return 0;
    }

    function _normEnhItem_mobile(row) {
      const raw = row?._raw || row || {};
      const name = String(row?.name ?? raw['이름'] ?? raw.name ?? '').trim();
      const type = String(row?.type ?? raw['종류'] ?? raw.type ?? '').trim();

      const lv =
        Number.isFinite(Number(row?.level)) ? Number(row.level) :
          Number.isFinite(Number(raw['강화'])) ? Number(raw['강화']) :
            _parseEnhLevel_mobile(name);

      return { name, type, level: lv, _raw: raw };
    }

    function _syncEnhLabelFromState_mobile(slot) {
      const row = document.querySelector(`#pageEquip .equip-row[data-slot="${slot}"]`);
      if (!row) return;
      const el = row.querySelector('.equip-enh-val'); // 모바일 UI에 존재 
      if (!el) return;

      const info = window.state?.enh?.[slot];
      if (info?.name) el.textContent = String(info.name).trim();
    }

    function openEquipEnhModal(){
  const m = document.getElementById('equipEnhModal');
  if(!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
}

function closeEquipEnhModal(){
  const m = document.getElementById('equipEnhModal');
  if(!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden', 'true');
}
function openEquipEmblemModal(){
  const m = document.getElementById('equipEmblemModal');
  if(!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden','false');
}
function closeEquipEmblemModal(){
  const m = document.getElementById('equipEmblemModal');
  if(!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden','true');
}

(function bindEquipEmblemModalCloseOnce(){
  const m = document.getElementById('equipEmblemModal');
  if(!m || m.__bound) return;
  m.__bound = 1;

  m.addEventListener('click', (e)=>{
    if (e.target?.classList?.contains('backdrop')) return closeEquipEmblemModal();
    if (e.target?.closest?.('[data-equip-emblem-close]')) return closeEquipEmblemModal();
  });
})();

// 닫기(backdrop + X)
(function bindEquipEnhModalCloseOnce(){
  const m = document.getElementById('equipEnhModal');
  if(!m || m.__bound) return;
  m.__bound = 1;

  m.addEventListener('click', (e) => {
    if (e.target?.classList?.contains('backdrop')) return closeEquipEnhModal();
    if (e.target?.closest?.('[data-equip-enh-close]')) return closeEquipEnhModal();
  });
})();
function _grindTypeForSlot_mobile(slot){
  return (slot === 'weapon') ? '무기연마' : '보조장비연마';
}

function _getGrindLevelFromName(name){
  const m = String(name || '').match(/^(\d+)연마$/);
  return m ? Number(m[1]) : 0;
}

function _syncGrindLabelFromState_mobile(slot){
  const row = document.querySelector(`#pageEquip .equip-row[data-slot="${slot}"]`);
  if(!row) return;

  const el = row.querySelector('.equip-grind');
  if(!el) return;

  const slotKey = (slot === 'weapon') ? 'weapon' : (slot === 'sub') ? 'sub' : '';
  const name = slotKey && window.state?.refines?.[slotKey]?.name ? String(window.state.refines[slotKey].name) : '';
  const lv = _getGrindLevelFromName(name);

  el.textContent = (lv > 0) ? `연마 ${lv}` : '연마 -';
}

function syncGrindTopbarLabel_mobile(slot){
  const bar = document.getElementById('equipTopbar');
  if(!bar) return;

  const btn = bar.querySelector('.equip-topbtn[data-eqtab="grind"]');
  if(!btn) return;

  const slotKey = (slot === 'weapon') ? 'weapon' : (slot === 'sub') ? 'sub' : '';
  const name = slotKey && window.state?.refines?.[slotKey]?.name ? String(window.state.refines[slotKey].name) : '';
  const lv = _getGrindLevelFromName(name);

  btn.textContent = (lv > 0) ? `연마 ${lv}` : '연마';
}

function renderMobileGrindList(slot){
  bindEquipGrindModalCloseOnce();

  const title = document.getElementById('equipGrindModalTitle');
  if(title){
    const slotName = (slot === 'weapon') ? '무기' : '보조장비';
title.textContent = `${slotName} 연마 선택`;
  }

  const listEl = document.getElementById('equipGrindList');
  if(!listEl) return;

  const labels = ['연마없음','1연마','2연마','3연마','4연마','5연마','6연마','7연마','8연마','9연마'];
  const slotKey = (slot === 'weapon') ? 'weapon' : 'sub';

  const curName = window.state?.refines?.[slotKey]?.name ? String(window.state.refines[slotKey].name) : '연마없음';

  listEl.innerHTML = '';
  labels.forEach(name=>{
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'enh-option';
    b.textContent = (name === '연마없음') ? '없음' : name;

    if(String(name) === curName) b.classList.add('active');

    b.addEventListener('click', ()=>{
      window.state = window.state || {};
      window.state.refines = window.state.refines || {};

      const refineType = _grindTypeForSlot_mobile(slot);
      const level = _getGrindLevelFromName(name);

      window.state.refines[slotKey] = { name, refineType, level };

      _syncGrindLabelFromState_mobile(slot);
      syncGrindTopbarLabel_mobile(slot);

      showEquipGrindModal(false);
      toast(level > 0 ? `연마 ${level} 적용` : '연마 해제');
    });

    listEl.appendChild(b);
  });

  showEquipGrindModal(true);
}

function openMobileGrindPicker(){
  const slot = window.state?.ui?.equipPickerSlot;
  if(!slot){ toast('슬롯 정보가 없습니다.'); return; }

  if(!(slot === 'weapon' || slot === 'sub')){
    toast('이 슬롯은 연마를 지원하지 않습니다.');
    return;
  }

  renderMobileGrindList(slot);
}


function showEquipGrindModal(on){
  const m = document.getElementById('equipGrindModal');
  if(!m) return;
  if(on){
    m.classList.add('show');
    m.setAttribute('aria-hidden','false');
  }else{
    m.classList.remove('show');
    m.setAttribute('aria-hidden','true');
  }
}

function bindEquipGrindModalCloseOnce(){
  const m = document.getElementById('equipGrindModal');
  if(!m || m.dataset.bound) return;
  m.dataset.bound = '1';

  m.addEventListener('click', (e)=>{
    if(e.target?.dataset?.equipGrindClose != null){
      showEquipGrindModal(false);
    }
  });
}

// =========================
// ✅ 마법봉인(고유/일반) 2중모달
// =========================

function openEquipSealUModal(){
  const m = document.getElementById('equipSealUModal');
  if(!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
}
function closeEquipSealUModal(){
  const m = document.getElementById('equipSealUModal');
  if(!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden', 'true');
}
(function bindEquipSealUModalCloseOnce(){
  const m = document.getElementById('equipSealUModal');
  if(!m || m.__bound) return;
  m.__bound = 1;
  m.addEventListener('click', (e) => {
    if (e.target?.classList?.contains('backdrop')) return closeEquipSealUModal();
    if (e.target?.closest?.('[data-equip-seal-u-close]')) return closeEquipSealUModal();
  });
})();

function openEquipSealNModal(){
  const m = document.getElementById('equipSealNModal');
  if(!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
}
function closeEquipSealNModal(){
  const m = document.getElementById('equipSealNModal');
  if(!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden', 'true');
}
function openEquipEnchantModal(){
  const m = document.getElementById('equipEnchantModal');
  if(!m) return;
  m.classList.add('show');
  m.setAttribute('aria-hidden', 'false');
}
function closeEquipEnchantModal(){
  const m = document.getElementById('equipEnchantModal');
  if(!m) return;
  m.classList.remove('show');
  m.setAttribute('aria-hidden', 'true');
}

(function bindEquipSealNModalCloseOnce(){
  const m = document.getElementById('equipSealNModal');
  if(!m || m.__bound) return;
  m.__bound = 1;
  m.addEventListener('click', (e) => {
    if (e.target?.classList?.contains('backdrop')) return closeEquipSealNModal();
    if (e.target?.closest?.('[data-equip-seal-n-close]')) return closeEquipSealNModal();
  });
})();
(function bindEquipEnchantModalCloseOnce(){
  const m = document.getElementById('equipEnchantModal');
  if(!m || m.__bound) return;
  m.__bound = 1;

  m.addEventListener('click', (e) => {
    if (e.target?.classList?.contains('backdrop')) return closeEquipEnchantModal();
    if (e.target?.closest?.('[data-equip-enchant-close]')) return closeEquipEnchantModal();
  });
})();
function _sealTypeKeysForSlot_mobile(slot){
  if(slot === 'weapon') return { u:'무기고유', g:'무기일반' };

  // ✅ 모바일 방어구 슬롯키: headshoulder / top / bottom / belt / shoes
  if(['headshoulder','top','bottom','belt','shoes'].includes(slot)) return { u:'방어고유', g:'방어일반' };

  // ✅ 모바일 악세 슬롯키: bracelet / necklace / ring
  if(['bracelet','necklace','ring'].includes(slot)) return { u:'악세고유', g:'악세일반' };

  // ✅ 모바일 특수(보조/마법석/귀걸이) = PC 표준: 보장고유/보장일반
  if(['sub','magestone','earring'].includes(slot)) return { u:'보장고유', g:'보장일반' };

  return null;
}

function normalizeSealType_mobile(s){
  const raw = String(s ?? '');
  const t = raw.replace(/\s+|-/g, '').replace(/[()]/g, '').trim();

  const has = (w) => t.includes(w);
  const isDef = /방어구|방어/.test(t);
  const isAks = /악세|악세서리|액세/.test(t);
  const isBoj = /보장|보조장비|보조/.test(t);

  const isUni = /고유/.test(t) || /고유옵션/.test(t);
  const isGen = /일반/.test(t) || /일반옵션/.test(t);

  if (has('무기') && isUni) return '무기고유';
  if (has('무기') && isGen) return '무기일반';
  if (isDef && isUni) return '방어고유';
  if (isDef && isGen) return '방어일반';
  if (isAks && isUni) return '악세고유';
  if (isAks && isGen) return '악세일반';
  if (isBoj && isUni) return '보장고유';
  if (isBoj && isGen) return '보장일반';
  return raw.trim();
}


function _syncSealLabelFromState_mobile(slot){
  const row = document.querySelector(`.equip-row[data-slot="${slot}"]`);
  if(!row) return;

  const uEl = row.querySelector('.equip-unique');
  const nEl = row.querySelector('.equip-normal');

  const uName = window.state?.seals?.[slot]?.unique?.name ? String(window.state.seals[slot].unique.name).trim() : '';
  const nName = window.state?.seals?.[slot]?.general1?.name ? String(window.state.seals[slot].general1.name).trim() : '';

  if(uEl) uEl.textContent = `고유옵션 ${uName || '-'}`;
  if(nEl) nEl.textContent = `일반옵션 ${nName || '-'}`;
}

function _syncEnchantLabelFromState_mobile(slot){
  const row = document.querySelector(`.equip-row[data-slot="${slot}"]`);
  if(!row) return;

  const body = row.querySelector('.equip-enchant .equip-col-body');
  if(!body) return;

  const name = window.state?.enchants?.[slot]?.name
    ? String(window.state.enchants[slot].name).trim()
    : '';

  body.textContent = name ? name : '-';
}


function renderMobileSealUniqueList(slot){
  const keys = _sealTypeKeysForSlot_mobile(slot);
  const type = keys?.u;
  if(!type){ toast('이 슬롯은 고유옵션 타입이 없습니다.'); return; }

  const list = _getLightEnhList_mobile()
    .map(_normEnhItem_mobile)
    .filter(x => x.name && normalizeSealType_mobile(x.type) === type);

  if(!list.length){
    toast(`고유옵션 목록을 불러오지 못했습니다. (${type})`);
    return;
  }


  const titleEl = document.getElementById('equipSealUModalTitle');
  if(titleEl) titleEl.textContent = `${EQUIP_SLOT_LABELS[slot] || slot} 고유옵션 선택`;

  const listEl = document.getElementById('equipSealUList');
  if(!listEl) return;
  listEl.innerHTML = '';

  const curName = window.state?.seals?.[slot]?.unique?.name ? String(window.state.seals[slot].unique.name).trim() : '';

  for(const it of list){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'enh-option' + (curName && curName === it.name ? ' active' : '');
    b.textContent = it.name;

    b.onclick = () => {
      window.state = window.state || {};
      window.state.seals = window.state.seals || {};
      window.state.seals[slot] = window.state.seals[slot] || {};
      window.state.seals[slot].unique = { name: it.name, type: it.type };

      _syncSealLabelFromState_mobile(slot);
      syncSealTopbarLabel_mobile(slot);
      closeEquipSealUModal(); // ✅ 장비 모달은 유지
    };

    listEl.appendChild(b);
  }

  window.state.ui = window.state.ui || {};
  window.state.ui.sealTargetSlot = slot;

  openEquipSealUModal();
}

function renderMobileSealNormalList(slot){
  const keys = _sealTypeKeysForSlot_mobile(slot);
  const type = keys?.g;
  if(!type){ toast('이 슬롯은 일반옵션 타입이 없습니다.'); return; }

  const list = _getLightEnhList_mobile()
    .map(_normEnhItem_mobile)
    .filter(x => x.name && x.type === type);

  if(!list.length){
    toast(`일반옵션 목록을 불러오지 못했습니다. (${type})`);
    return;
  }

  const titleEl = document.getElementById('equipSealNModalTitle');
  if(titleEl) titleEl.textContent = `${EQUIP_SLOT_LABELS[slot] || slot} 일반옵션 선택`;

  const listEl = document.getElementById('equipSealNList');
  if(!listEl) return;
  listEl.innerHTML = '';

  const curName = window.state?.seals?.[slot]?.general1?.name ? String(window.state.seals[slot].general1.name).trim() : '';

  for(const it of list){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'enh-option' + (curName && curName === it.name ? ' active' : '');
    b.textContent = it.name;

    b.onclick = () => {
      window.state = window.state || {};
      window.state.seals = window.state.seals || {};
      window.state.seals[slot] = window.state.seals[slot] || {};
      window.state.seals[slot].general1 = { name: it.name, type: it.type };

      _syncSealLabelFromState_mobile(slot);
      syncSealTopbarLabel_mobile(slot);
      closeEquipSealNModal(); // ✅ 장비 모달은 유지
    };

    listEl.appendChild(b);
  }

  window.state.ui = window.state.ui || {};
  window.state.ui.sealTargetSlot = slot;

  openEquipSealNModal();
}


    function renderMobileEnhList(slot){
  const type = _enhTypeForSlot_mobile(slot);
  if(!type){
    toast('이 슬롯은 강화 타입이 없습니다.');
    return;
  }

  const list = _getLightEnhList_mobile()
    .map(_normEnhItem_mobile)
    .filter(x => x.name && x.type === type);

  if(!list.length){
    toast(`강화 목록을 불러오지 못했습니다. (${type})`);
    return;
  }

  // 레벨 오름차순 정렬(보기 편하게)
  list.sort((a,b)=> (a.level||0) - (b.level||0) || a.name.localeCompare(b.name, 'ko'));

  // ✅ (방법B) 강화 모달에 렌더
  const titleEl = document.getElementById('equipEnhModalTitle');
  if(titleEl) titleEl.textContent = `${EQUIP_SLOT_LABELS[slot] || slot} 강화 선택`;

  const listEl = document.getElementById('equipEnhList');
  if(!listEl) return;
  listEl.innerHTML = '';

  const curName = window.state?.enh?.[slot]?.name ? String(window.state.enh[slot].name).trim() : '';

  for(const it of list){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'enh-option' + (curName && curName === it.name ? ' active' : '');
    b.textContent = it.name;

    b.onclick = () => {
      window.state = window.state || {};
      window.state.enh = window.state.enh || {};
      // ✅ PC버전/백코드가 기대하는 형태로 저장(name/type/level)
const lv = Number.isFinite(Number(it.level)) ? Number(it.level) : _parseEnhLevel_mobile(it.name);
window.state.enh[slot] = { name: it.name, type: it.type, level: lv };

      _syncEnhLabelFromState_mobile(slot);
      // ✅ 추가: 상단 '강화' 버튼 텍스트도 즉시 +수치로 변경
syncEnhTopbarLabel_mobile(slot);
      closeEquipEnhModal(); // ✅ 장비 모달은 유지하고, 강화 모달만 닫기
    };

    listEl.appendChild(b);
  }

  // UI 상태 기록(선택적)
  window.state.ui = window.state.ui || {};
  window.state.ui.enhTargetSlot = slot;

  openEquipEnhModal();
}

function _enchantTypeForSlot_mobile(slot){
  switch(slot){
    case 'weapon':        return '무기마부';
    case 'headshoulder':  return '머리어깨마부';
    case 'top':           return '상의마부';
    case 'bottom':        return '하의마부';
    case 'belt':          return '허리마부';
    case 'shoes':         return '신발마부';

    case 'bracelet':      return '팔찌마부';
    case 'necklace':      return '목걸이마부';
    case 'ring':          return '반지마부';

    case 'sub':           return '보장마부';
    case 'magestone':     return '마법석마부';
    case 'earring':       return '귀걸이마부';
    default: return '';
  }
}

function normalizeEnchantType_mobile(t){
  const s = String(t || '').replace(/\s+/g,'').trim();
  if(!s) return '';
  // 이미 "무기마부" 같이 들어오는 경우 그대로 사용
  if(s.endsWith('마부')) return s;

  // 혹시 "무기마법부여" 같은 형태면 마부 키로 변환
  if(/무기/.test(s)) return '무기마부';
  if(/머리어깨|어깨/.test(s)) return '머리어깨마부';
  if(/상의/.test(s)) return '상의마부';
  if(/하의/.test(s)) return '하의마부';
  if(/허리|벨트/.test(s)) return '허리마부';
  if(/신발/.test(s)) return '신발마부';
  if(/팔찌/.test(s)) return '팔찌마부';
  if(/목걸이/.test(s)) return '목걸이마부';
  if(/반지/.test(s)) return '반지마부';
  if(/보장|보조/.test(s)) return '보장마부';
  if(/마법석/.test(s)) return '마법석마부';
  if(/귀걸이/.test(s)) return '귀걸이마부';

  return s;
}

function renderMobileEnchantList(slot){
  const typeKey = _enchantTypeForSlot_mobile(slot);
  if(!typeKey){
    toast('이 슬롯은 마법부여를 지원하지 않습니다.');
    return;
  }

  const listEl = document.getElementById('equipEnchantList');
  if(!listEl) return;

  const map = window.EQUIP_SLOT_LABELS || {};
const slotLabel =
  map[slot]
  || (slot === 'headshoulder' ? (map.headshoulder || map.shoulder || '머리어깨') : '')
  || slot;

const titleEl = document.getElementById('equipEnchantModalTitle');
if(titleEl) titleEl.textContent = `${slotLabel} 마법부여 선택`;

  // ✅ 목록은 "강화마봉마부 시트"에서 가져오는 라이트 리스트를 재사용
  const raw = _getLightEnhList_mobile().map(_normEnhItem_mobile);

  const items = raw.filter(x=>{
    if(!x || !x.name) return false;
    return normalizeEnchantType_mobile(x.type) === typeKey;
  });

  // ✅ 렌더
  const picked = window.state?.enchants?.[slot]?.name ? String(window.state.enchants[slot].name) : '';

  let html = '';
  // 없음
  html += `
    <button type="button" class="enh-btn ${picked ? '' : 'active'}" data-none="1">
      없음
    </button>
  `;

  // 실제 옵션들 (정렬 X: 시트 순서 유지)
  for(const it of items){
    const name = String(it.name || '').trim();
    const active = (picked && picked === name) ? 'active' : '';
    html += `
      <button type="button" class="enh-btn ${active}"
        data-name="${name.replace(/"/g,'&quot;')}"
        data-typekey="${typeKey.replace(/"/g,'&quot;')}">
        ${name}
      </button>
    `;
  }

  listEl.innerHTML = html;

  // 클릭 핸들러(중복 바인딩 방지)
  if(!listEl.dataset.bound){
    listEl.dataset.bound = '1';
    listEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.enh-btn');
      if(!btn) return;

      const slot = window.state?.ui?.equipPickerSlot;
      if(!slot) return;

      (window.state = window.state || {}).enchants = (window.state.enchants || {});

      // 없음
      if(btn.dataset.none === '1'){
        delete window.state.enchants[slot];
        _syncEnchantLabelFromState_mobile(slot);
        syncEnchantTopbarLabel_mobile(slot);
        closeEquipEnchantModal();
        return;
      }

      // 선택
      const name = (btn.dataset.name || '').trim();
      const typeKey = (btn.dataset.typekey || '').trim();

      window.state.enchants[slot] = { name, typeKey };
      _syncEnchantLabelFromState_mobile(slot);
      syncEnchantTopbarLabel_mobile(slot);
      closeEquipEnchantModal();
    });
  }

  openEquipEnchantModal();
}


    function _isSpecialSlot(slot) {
      return slot === 'sub' || slot === 'magestone' || slot === 'earring';
    }

    function _getEnhLevelFromState_mobile(slot){
  const info = window.state?.enh?.[slot];
  if(!info) return 0;

  const lv = Number(info.level);
  if(Number.isFinite(lv) && lv > 0) return lv;

  // ✅ level이 없거나 0이면 name에서 숫자 파싱(12강 / +12 / 12)
  const name = String(info.name || '');
  return _parseEnhLevel_mobile(name);
}

function syncEnhTopbarLabel_mobile(slot){
  const bar = document.getElementById('equipTopbar');
  if(!bar) return;

  const enhBtn = bar.querySelector('.equip-topbtn[data-eqtab="enh"]');
  if(!enhBtn) return;

  // 기본 라벨 기억(처음 1회만)
  if(!enhBtn.dataset.baseLabel){
    enhBtn.dataset.baseLabel = (enhBtn.textContent || '강화').trim();
  }

  const lv = _getEnhLevelFromState_mobile(slot);

  // ✅ 원하는 표기: +12 처럼 "수치"로 바꾸기
  enhBtn.textContent = (lv > 0) ? `+${lv}` : enhBtn.dataset.baseLabel;

  // 만약 "강화 +12"로 표기하고 싶으면 위 줄 대신:
  // enhBtn.textContent = (lv > 0) ? `강화 +${lv}` : enhBtn.dataset.baseLabel;
}
/* =========================
 * ✅ 모바일 엠블렘 시스템
 * ========================= */

// (PC와 동일) 플래티넘 7라인
const PLAT_LINES = [
  { label:'화', key:'화' },
  { label:'수', key:'수' },
  { label:'명', key:'명' },
  { label:'암', key:'암' },
  { label:'모속', key:'모속' },
  { label:'힘', key:'힘' },
  { label:'지능', key:'지능' },
];

// (PC와 동일) 슬롯별 허용 엠블렘 타입
const SOCKET_RULES = {
  headshoulder: ['노란빛엠블렘'],
  belt: ['노란빛엠블렘'],
  top: ['붉은빛엠블렘'],
  bottom: ['붉은빛엠블렘'],
  shoes: ['푸른빛엠블렘'],
  bracelet: ['푸른빛엠블렘'],
  necklace: ['녹색빛엠블렘'],
  ring: ['녹색빛엠블렘'],
  weapon: ['붉은빛엠블렘','노란빛엠블렘','녹색빛엠블렘','푸른빛엠블렘'],
  sub: ['플래티넘엠블렘'],
  // title: ['플래티넘엠블렘'], // 모바일에 칭호 슬롯 붙일 때 사용
  earring: ['플래티넘엠블렘'],
  magestone: ['플래티넘엠블렘'],
};
const SOCKET_COUNT = (slotKey) => _isSpecialSlot(slotKey) ? 1 : 2;

// DBEnh.byType 준비(모바일은 init에서 CORE.lists만 있으니 여기서 그룹핑)
const PLACEHOLDER_IMG = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
function _ensureDBEnhByType_mobile(){
  window.DBEnh = window.DBEnh || {};
  if (DBEnh.byType && DBEnh.__byTypeReady) return;

  DBEnh.byType = {};
  const list = (window.CORE?.lists && (CORE.lists['enh:list'] || CORE.lists.enh || CORE.lists.enhList)) || [];
  for(const row of list){
    const it = _normEnhItem_mobile(row);
    const raw = it._raw || {};
    const type = String(it.type || '').trim();
    const name = String(it.name || '').trim();
    if(!type || !name) continue;

    // 이미지
    const img = _normImg(row?.image ?? raw['이미지'] ?? raw.image ?? '');
    // 플래티넘 라인 분류용(PC는 levelVal/tag를 쓰므로 여기서 하나 만들어 둠)
    const levelVal = String(
  row?.levelVal ??
  row?.level ??          // ✅ CORE 경량리스트에서 '렙제'가 level로 들어오는 케이스 대응
  raw['렙제'] ??
  raw['태그'] ??
  raw['tag'] ??
  raw.level ??
  ''
).trim();


    // 숫자 뱃지(이름에서 1~2자리 숫자)
    let level_num = '';
    const m = name.match(/(\d{1,2})/);
    if(m) level_num = m[1];

    const out = { name, type, img: img || PLACEHOLDER_IMG, levelVal, level_num, _raw: raw };
    (DBEnh.byType[type] = DBEnh.byType[type] || []).push(out);
  }
  DBEnh.__byTypeReady = true;
}

// state.emblems[slot] 배열 보장
function _ensureEmblemArray_mobile(slotKey){
  window.state = window.state || {};
  state.emblems = state.emblems || {};
  const cnt = SOCKET_COUNT(slotKey);
  if(!Array.isArray(state.emblems[slotKey])) state.emblems[slotKey] = new Array(cnt).fill(null);

  // 길이 보정
  if(state.emblems[slotKey].length !== cnt){
    const arr = state.emblems[slotKey].slice(0, cnt);
    while(arr.length < cnt) arr.push(null);
    state.emblems[slotKey] = arr;
  }
  return state.emblems[slotKey];
}

// 상단바(엠블렘 구멍) 이미지 동기화
function syncEmblemTopbarDots_mobile(slotKey){
  const bar = document.getElementById('equipTopbar');
  if(!bar) return;
  const emblemBtn = bar.querySelector('.equip-topbtn[data-eqtab="emblem"]');
  if(!emblemBtn) return;

  const dots = emblemBtn.querySelectorAll('.top-embs .emb');
  const arr = _ensureEmblemArray_mobile(slotKey);
  dots.forEach((d,i)=>{
    const picked = arr[i] || null;
    d.classList.toggle('has-img', !!picked);
    if(picked?.img) d.style.backgroundImage = `url("${String(picked.img).replace(/"/g,'\\"')}")`;
    else d.style.backgroundImage = '';
  });
}

// 장비 리스트(메인 페이지) 엠블렘 아이콘 동기화
function syncEquipRowEmblemIcons_mobile(slotKey){
  const row = document.querySelector(`#pageEquip .equip-row[data-slot="${slotKey}"]`);
  if(!row) return;
  const box = row.querySelector('.equip-emblem-icons');
  if(!box) return;

  const arr = _ensureEmblemArray_mobile(slotKey);
  const dots = box.querySelectorAll('.emb');
  dots.forEach((d,i)=>{
    const picked = arr[i] || null;
    d.classList.toggle('has-img', !!picked);
    if(picked?.img) d.style.backgroundImage = `url("${String(picked.img).replace(/"/g,'\\"')}")`;
    else d.style.backgroundImage = '';
  });
}

// 모달 상단 타겟(소켓 선택 UI) 렌더
function renderEmblemTarget_mobile(slotKey){
  const wrap = document.getElementById('equipEmblemTarget');
  if(!wrap) return;

  const cnt = SOCKET_COUNT(slotKey);
  const slotKo =
    (window.EQUIP_SLOT_LABELS && EQUIP_SLOT_LABELS[slotKey]) ||
    (document.querySelector(`#pageEquip .equip-row[data-slot="${slotKey}"] .equip-name`)?.textContent || slotKey);

  state.ui = state.ui || {};
  state.ui.emblemTarget = state.ui.emblemTarget || { slotKey, sockIndex: 0 };
  state.ui.emblemTarget.slotKey = slotKey;

  const arr = _ensureEmblemArray_mobile(slotKey);
  const cur = Math.max(0, Math.min(cnt-1, Number(state.ui.emblemTarget.sockIndex)||0));
  state.ui.emblemTarget.sockIndex = cur;

  wrap.innerHTML = `
    <div class="em-target-top">
      <div class="em-slot-title">${String(slotKo).trim()} · 엠블렘</div>
      <div class="em-sockets">
        ${Array.from({length:cnt}).map((_,i)=>{
          const p = arr[i];
          const bg = p?.img ? `style="background-image:url('${String(p.img).replace(/'/g,"\\'")}')"` : '';
          const active = (i===cur) ? 'active' : '';
          const has = p?.img ? 'has-img' : '';
          const num = p?.level_num ? `<span class="num">${p.level_num}</span>` : '';
          const line = (p?.type === '플래티넘엠블렘' && p?.tag)
  ? `<span class="em-line-badge">${String(p.tag).trim()}</span>`
  : '';

return `
  <span class="em-sock-wrap" data-sock="${i}">
    ${line}
    <button type="button" class="em-sock ${active} ${has}" data-sock="${i}" ${bg}>${num}</button>
  </span>
`;

        }).join('')}
      </div>
    </div>
    <div style="font-size:12px;color:rgba(240,230,210,0.75);">
      소켓을 눌러 대상을 바꾸고, 아래에서 엠블렘을 선택하세요.
    </div>
  `;

  // 소켓 클릭 바인딩(한 번만)
  if(!wrap.dataset.bound){
    wrap.dataset.bound = '1';
    wrap.addEventListener('click', (e)=>{
      const b = e.target.closest('.em-sock, .em-sock-wrap');
if(!b) return;
const i = Number(b.dataset.sock);
      if(!Number.isFinite(i)) return;
      state.ui.emblemTarget.sockIndex = i;
      renderEmblemTarget_mobile(slotKey);
    });
  }
}

// 모달 리스트(가로 행) 렌더
function renderEmblemList_mobile(slotKey){
  function _emNum(x){
  const n = parseInt(String(x?.level_num ?? '').replace(/[^\d]/g,''), 10);
  return Number.isFinite(n) ? n : -1;
}
// ✅ 내림차순: level_num 큰 것 먼저 → 이름(내림차순)
function _sortEmblemsDesc(a, b){
  const na = _emNum(a), nb = _emNum(b);
  if (nb !== na) return nb - na;
  const an = String(a?.name || '');
  const bn = String(b?.name || '');
  return bn.localeCompare(an, 'ko'); // name desc
}

  const listEl = document.getElementById('equipEmblemList');
  if(!listEl) return;

  const allow = SOCKET_RULES[slotKey] || [];
  listEl.innerHTML = '';

  if(!allow.length){
    listEl.innerHTML = `<div style="color:rgba(240,230,210,0.75);padding:8px;">선택 가능한 엠블렘이 없습니다.</div>`;
    return;
  }

  const isPlatinumOnly = (allow.length===1 && allow[0]==='플래티넘엠블렘');

  const makeItemBtn = (item, isNone=false) => {
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.className = 'em-item' + (isNone ? ' none' : '');
  const img = isNone ? '' : (item?.img || PLACEHOLDER_IMG);
  const name = isNone ? '없음' : (item?.name || '');
  const sub  = isNone ? '선택한 소켓을 비웁니다' : (item?.type || '');
  const badge = (!isNone && item?.level_num) ? String(item.level_num) : '';

  btn.innerHTML = `
    <div class="thumb" style="${isNone ? '' : `background-image:url('${String(img).replace(/'/g,"\\'")}')`}">
      ${isNone ? '없음' : ''}
    </div>
    <div class="meta">
      <div class="name">${name}</div>
      <div class="sub">${sub}</div>
    </div>
    <div class="badge">${badge}</div>
  `;
  return btn;
};

  const pick = (pickedItemOrNull) => {
    const t = state.ui?.emblemTarget || { slotKey, sockIndex:0 };
    const sKey = t.slotKey;
    const idx = Number(t.sockIndex)||0;

    _ensureEmblemArray_mobile(sKey);
    state.emblems[sKey][idx] = pickedItemOrNull ? {
      name: pickedItemOrNull.name,
      type: pickedItemOrNull.type,
      img: pickedItemOrNull.img,
      level_num: pickedItemOrNull.level_num,
      tag: pickedItemOrNull.levelVal,
    } : null;

    // UI 동기화
    syncEquipRowEmblemIcons_mobile(sKey);
    syncEmblemTopbarDots_mobile(sKey);
    renderEmblemTarget_mobile(sKey);

    // ✅ 자동 다음 소켓으로 이동(마지막이면 닫기)
    const cnt = SOCKET_COUNT(sKey);
    if(idx < cnt-1){
      state.ui.emblemTarget.sockIndex = idx + 1;
      renderEmblemTarget_mobile(sKey);
    }else{
      closeEquipEmblemModal();
    }
  };

  if(isPlatinumOnly){
  let base = (DBEnh.byType['플래티넘엠블렘'] || []);
  const isSpecial = _isSpecialSlot(slotKey); // sub / magestone / earring

  // ✅ 특수장비: "속성 선택" → 선택한 속성의 단계(이름)만 아래에 표시
  if(isSpecial){
    const ui = (state.ui || (state.ui = {}));
    const mem = (ui.emblemPlatLine || (ui.emblemPlatLine = {})); // 슬롯별 선택 기억
    const cur = (mem[slotKey] || '').trim();

    const group = document.createElement('div');
    group.className = 'em-group';

    const title = document.createElement('div');
    title.className = 'em-group-title plat';
    title.innerHTML = `
      <span>플래티넘 · <b class="em-plat-cur">${cur || '선택'}</b></span>
      <button type="button" class="em-line-btn">속성 선택</button>
    `;
    group.appendChild(title);

    const vlist = document.createElement('div');
    vlist.className = 'em-vlist';
    group.appendChild(vlist);

    // 속성 선택 패널(기본 숨김, 버튼 누르면 펼침)
    const chooser = document.createElement('div');
    chooser.className = 'em-line-choices';
    chooser.innerHTML = (PLAT_LINES || []).map(line => {
      const k = String(line.key || '').trim();
      const lb = String(line.label || k);
      return `<button type="button" class="em-line-opt" data-key="${k}">${lb}</button>`;
    }).join('');
    vlist.appendChild(chooser);

    const setActiveChooser = () => {
      const now = (mem[slotKey] || '').trim();
      chooser.querySelectorAll('.em-line-opt').forEach(b=>{
        b.classList.toggle('active', (b.dataset.key||'') === now);
      });
      const curEl = title.querySelector('.em-plat-cur');
      if(curEl) curEl.textContent = now || '선택';
    };

    const renderStageList = () => {
      // 기존 단계 버튼/힌트 제거(chooser는 유지)
      vlist.querySelectorAll('.em-item, .em-plat-hint').forEach(el => el.remove());

      setActiveChooser();

      const now = (mem[slotKey] || '').trim();
      if(!now){
        const hint = document.createElement('div');
        hint.className = 'em-plat-hint';
        hint.textContent = '속성(화/수/명/암/모속/힘/지능)을 먼저 선택해주세요.';
        vlist.appendChild(hint);
        return;
      }

      // 해제(없음)
      const noneBtn = document.createElement('button');
      noneBtn.type = 'button';
      noneBtn.className = 'em-item none';
      noneBtn.innerHTML = `
        <span class="thumb">없음</span>
        <span class="meta">
          <div class="name">없음</div>
          <div class="sub">플래티넘엠블렘</div>
        </span>
        <span class="badge">해제</span>
      `;
      noneBtn.addEventListener('click', ()=>{
        applyEmblem_mobile(slotKey, sockIdx, null);
        closeEquipEmblemModal();
      });
      vlist.appendChild(noneBtn);

      // ✅ 선택 속성과 일치하는 것만 "이름" 목록으로
      const items = base
        .filter(it => String((it.levelVal || '')).trim() === now)
        .sort(_sortEmblemsDesc);

      items.forEach(it=>{
  const btn = makeItemBtn(it, false);
  btn.addEventListener('click', ()=>pick(it)); // ✅ 선택 적용
  vlist.appendChild(btn);
});
    };

    // 버튼 눌러 chooser 토글
    const btnToggle = title.querySelector('.em-line-btn');
    if(btnToggle){
      btnToggle.addEventListener('click', ()=>{
        chooser.classList.toggle('show');
      });
    }

    // chooser에서 속성 선택
    chooser.addEventListener('click', (e)=>{
      const b = e.target.closest('.em-line-opt');
      if(!b) return;
      mem[slotKey] = (b.dataset.key || '').trim();
      chooser.classList.remove('show');
      renderStageList();
    });

    renderStageList();
    listEl.appendChild(group);
    return;
  }

  // (기존) 방어구/악세 등: 화/수/명/암 그룹 표시 유지
  const lines = PLAT_LINES.slice(0, 4);
  const SYNS = {
    '화': ['화','화속','화속성','불'],
    '수': ['수','수속','수속성','물'],
    '명': ['명','명속','명속성','빛'],
    '암': ['암','암속','암속성','어둠'],
    '모속': ['모속','모든속성','전속성'],
    '힘': ['힘'],
    '지능': ['지능'],
  };

  lines.forEach(line=>{
    const keys = SYNS[line.key] || [line.key];
    const group = document.createElement('div');
    group.className = 'em-group';
    group.innerHTML = `<div class="em-group-title">플래티넘 · ${line.label}</div>`;
    const vlist = document.createElement('div');
    vlist.className = 'em-vlist';

    const noneBtn = document.createElement('button');
    noneBtn.type = 'button';
    noneBtn.className = 'em-item none';
    noneBtn.innerHTML = `
      <span class="thumb">없음</span>
      <span class="meta">
        <div class="name">없음</div>
        <div class="sub">플래티넘엠블렘</div>
      </span>
      <span class="badge">해제</span>
    `;
    noneBtn.addEventListener('click', ()=>pick(null));
    vlist.appendChild(noneBtn);

    const filtered = base
      .filter(x=>{
        const lv = String(x.levelVal || '').trim();
        return keys.some(k => lv === k);
      })
      .sort(_sortEmblemsDesc);

    filtered.forEach(item=>{
      vlist.appendChild(makeItemBtn(item));
    });

    group.appendChild(vlist);
    listEl.appendChild(group);
  });

  }else{
    const orderMap = { '붉은빛엠블렘':0, '노란빛엠블렘':1, '녹색빛엠블렘':2, '푸른빛엠블렘':3 };

allow.slice().sort((a,b)=>(orderMap[a]??9)-(orderMap[b]??9)).forEach(type=>{
  const group = document.createElement('div');
  group.className = 'em-group';

  const title = document.createElement('div');
  title.className = 'em-group-title';
  title.textContent = type.replace('엠블렘',''); // 보기 좋게: 붉은빛/노란빛...
  group.appendChild(title);

  const vlist = document.createElement('div');
  vlist.className = 'em-vlist';

  // ✅ 없음은 항상 맨 위
  const noneBtn = makeItemBtn(null, true);
  noneBtn.addEventListener('click', ()=>pick(null));
  vlist.appendChild(noneBtn);

  // ✅ 내림차순 정렬
  const items = (DBEnh.byType[type] || []).slice().sort(_sortEmblemsDesc);
  items.forEach(item=>{
    const b = makeItemBtn(item, false);
    b.addEventListener('click', ()=>pick(item));
    vlist.appendChild(b);
  });

  group.appendChild(vlist);
  listEl.appendChild(group);
});
  }
}

// 외부 진입점: 슬롯/소켓으로 엠블렘 모달 열기
function openMobileEmblemPicker(slotKey, sockIndex=0){
  _ensureDBEnhByType_mobile();

  window.state = window.state || {};
  state.ui = state.ui || {};
  state.ui.emblemTarget = { slotKey, sockIndex };

  // 제목
  const titleEl = document.getElementById('equipEmblemModalTitle');
  if(titleEl){
    const slotKo =
      (window.EQUIP_SLOT_LABELS && EQUIP_SLOT_LABELS[slotKey]) ||
      (document.querySelector(`#pageEquip .equip-row[data-slot="${slotKey}"] .equip-name`)?.textContent || slotKey);
    titleEl.textContent = `${String(slotKo).trim()} 엠블렘 선택`;
  }

  _ensureEmblemArray_mobile(slotKey);
  renderEmblemTarget_mobile(slotKey);
  renderEmblemList_mobile(slotKey);

  openEquipEmblemModal();
}

function _shortTopbarText_mobile(s, maxLen = 7){
  s = String(s || '').trim();
  if(!s) return '';
  return (s.length > maxLen) ? (s.slice(0, maxLen - 1) + '…') : s;
}

function syncSealTopbarLabel_mobile(slot){
  const bar = document.getElementById('equipTopbar');
  if(!bar) return;

  const uBtn = bar.querySelector('.equip-topbtn[data-eqtab="seal_u"]');
  const nBtn = bar.querySelector('.equip-topbtn[data-eqtab="seal_n"]');

  if(uBtn && !uBtn.dataset.baseLabel){
    uBtn.dataset.baseLabel = (uBtn.textContent || '고유옵션').trim();
  }
  if(nBtn && !nBtn.dataset.baseLabel){
    nBtn.dataset.baseLabel = (nBtn.textContent || '일반옵션').trim();
  }

  const uName = window.state?.seals?.[slot]?.unique?.name
    ? String(window.state.seals[slot].unique.name).trim()
    : '';
  const nName = window.state?.seals?.[slot]?.general1?.name
    ? String(window.state.seals[slot].general1.name).trim()
    : '';

  if(uBtn) uBtn.textContent = uName ? _shortTopbarText_mobile(uName) : uBtn.dataset.baseLabel;
  if(nBtn) nBtn.textContent = nName ? _shortTopbarText_mobile(nName) : nBtn.dataset.baseLabel;
}

function syncEnchantTopbarLabel_mobile(slot){
  const bar = document.getElementById('equipTopbar');
  if(!bar) return;

  const btn = bar.querySelector('.equip-topbtn[data-eqtab="enchant"]');
  if(!btn) return;

  if(!btn.dataset.baseLabel){
    btn.dataset.baseLabel = (btn.textContent || '마법부여').trim();
  }

  const name = window.state?.enchants?.[slot]?.name
    ? String(window.state.enchants[slot].name).trim()
    : '';

  btn.textContent = name ? _shortTopbarText_mobile(name) : btn.dataset.baseLabel;
}




    function setEquipTopbarSlot(slot) {
      const bar = document.getElementById('equipTopbar');
      if (!bar) return;

      // ✅ 연마 탭: data-grind="1" 인 슬롯에서만 노출 (무기/보조장비)
const grindBtn = bar.querySelector('.equip-topbtn[data-eqtab="grind"]');
if(grindBtn){
  const row = document.querySelector(`#pageEquip .equip-row[data-slot="${slot}"]`);
  const canGrind = !!(row && row.dataset.grind === '1');
  grindBtn.style.display = canGrind ? '' : 'none';
  if(canGrind) syncGrindTopbarLabel_mobile(slot);
}

      // active 기본은 강화
      bar.querySelectorAll('.equip-topbtn').forEach(b => {
        b.classList.toggle('active', b.dataset.eqtab === 'enh');
      });

      // ✅ 추가: 현재 슬롯의 강화 수치로 '강화 버튼 텍스트' 갱신
syncEnhTopbarLabel_mobile(slot);

// ✅ 추가: 현재 슬롯의 고유/일반 선택값으로 상단 버튼 텍스트 갱신
syncSealTopbarLabel_mobile(slot);
syncEnchantTopbarLabel_mobile(slot);

      // ✅ 엠블렘 구멍 개수: 특수장비(보조/마법석/귀걸이)=1개, 그 외=2개
      const emblemBtn = bar.querySelector('.equip-topbtn[data-eqtab="emblem"]');
      if (emblemBtn) {
        const cnt = _isSpecialSlot(slot) ? 1 : 2;
        emblemBtn.innerHTML = `
      <span class="top-embs">
        ${Array.from({ length: cnt }).map(() => `<span class="emb"></span>`).join('')}
      </span>
    `;
    // 구멍 만든 직후, 현재 선택된 엠블렘 이미지 반영
    syncEmblemTopbarDots_mobile(slot);
      }

      // (선택) 현재 슬롯 저장해두면 나중에 탭 클릭 시 분기하기 편함
      (window.state = window.state || {}).ui = (window.state.ui || {});
      window.state.ui.equipPickerSlot = slot;
    }

    // ✅ 상단바 클릭(구멍 포함) → 탭 활성화
    (function bindEquipTopbarOnce() {
      const bar = document.getElementById('equipTopbar');
      if (!bar || bar.dataset.bound) return;
      bar.dataset.bound = '1';

      bar.addEventListener('click', async (e) => { // ✅ async로 변경
        const btn = e.target.closest('.equip-topbtn');
        if (!btn) return;

        bar.querySelectorAll('.equip-topbtn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const tab = btn.dataset.eqtab;

        // ✅ 강화 탭: enhList 버튼 목록 보여주기
        if (tab === 'enh') {
          const slot = window.state?.ui?.equipPickerSlot; // setEquipTopbarSlot에서 저장
          if (!slot) {
            toast('슬롯 정보가 없습니다.');
            return;
          }
          await initMobileAllLightListsOnce();  // 경량리스트 보장
          renderMobileEnhList(slot);
          return;
        }

        // 나머지는 일단 기존대로 토스트
        if (tab === 'grind') { 
  openMobileGrindPicker(); 
  return; 
}
        else if (tab === 'seal_u') {
  const slot = window.state?.ui?.equipPickerSlot; // ✅ setEquipTopbarSlot에서 저장한 슬롯
  if (!slot) { toast('슬롯 정보가 없습니다.'); return; }

  await initMobileAllLightListsOnce(); // ✅ 경량리스트 보장
  renderMobileSealUniqueList(slot);    // ✅ 고유옵션 모달 오픈 + 목록 렌더
  return;

} else if (tab === 'seal_n') {
  const slot = window.state?.ui?.equipPickerSlot; // ✅ setEquipTopbarSlot에서 저장한 슬롯
  if (!slot) { toast('슬롯 정보가 없습니다.'); return; }

  await initMobileAllLightListsOnce(); // ✅ 경량리스트 보장
  renderMobileSealNormalList(slot);    // ✅ 일반옵션 모달 오픈 + 목록 렌더
  return;
} else if (tab === 'enchant') {
  const slot = window.state?.ui?.equipPickerSlot;
  if(!slot) { toast('슬롯 정보가 없습니다.'); return; }

  initMobileAllLightListsOnce().then(()=>{
    renderMobileEnchantList(slot);
  });
  return;
} else if (tab === 'emblem') {
  const slot = window.state?.ui?.equipPickerSlot;
  if (!slot) { toast('슬롯 정보가 없습니다.'); return; }

  await initMobileAllLightListsOnce(); // 경량리스트 보장
  openMobileEmblemPicker(slot, 0);     // ✅ 엠블렘 모달 오픈
  return;
}
      });
    })();



    async function openEquipPicker(slot) {
      // ✅ 무기 선택(캐릭터 직업군 + 무기종류 필터 반영)
if (slot === 'weapon') {
  _hideWeaponTypeBar_mobile();
  await initMobileAllLightListsOnce(); // 경량리스트 보장

  // 1) 현재 선택 캐릭터 직업군 확보 (프로젝트 내 상태키가 다를 수 있어 방어적으로)
  const ch = window.state?.currentCharacter || window.state?.char || window.state?.pickedChar || null;
const jobGroup = _getCharJobGroup(ch) || '';
  if (!jobGroup) {
    toast('캐릭터를 먼저 선택해주세요.');
    return;
  }

  // 2) 무기 리스트 가져오기
  //    - 직업군별로 따로 내려주는 키가 있으면 그걸 우선
  //    - 없으면 weapon:list 전체에서 jobGroup으로 필터
  const keyByJob = `weapon:${jobGroup}:list`;
  const byJob = window.CORE?.lists?.[keyByJob];
  let items = Array.isArray(byJob) ? byJob.slice() : (window.CORE?.lists?.['weapon:list'] || []).slice();

  // 직업군별 키가 없어서 전체 weapon:list를 쓰는 경우만 jobGroup 필터
  if (!Array.isArray(byJob)) {
    const base = _baseJG_mobile(jobGroup);
items = items.filter(it => _jgMatches_mobile(_getEquipJobGroup_mobile(it), jobGroup));
  }

  // 3) 무기종류 탭(버튼) 구성 + 선택 시 목록 갱신
const baseItems = items.slice();

// 직업군에 해당하는 무기들에서 "종류" 목록 뽑기
let types = Array.from(new Set(
  baseItems.map(it => _getWeaponType_mobile(it)).filter(Boolean)
));

// 보기 좋게 정렬(원하면 제거 가능)
types.sort((a,b)=> String(a).localeCompare(String(b), 'ko-KR'));

// state.ui 준비
window.state = window.state || {};
window.state.ui = window.state.ui || {};

let activeType = String(window.state.ui.weaponType || '전체').trim() || '전체';
if (activeType !== '전체' && !types.includes(activeType)) activeType = '전체';
window.state.ui.weaponType = activeType;

// ✅ 탭 클릭 시: active 갱신 + 목록 재렌더
const onPickType = (t) => {
  t = String(t || '전체').trim() || '전체';
  window.state.ui.weaponType = t;

  // 탭 active 다시 그리기
  renderWeaponTypeBar_mobile(types, t, onPickType);

  // 목록 필터링 후 다시 렌더
  let filtered = baseItems;
  if (t !== '전체') filtered = baseItems.filter(it => _getWeaponType_mobile(it) === t);

  const catalog = document.getElementById('equipCatalog');
  if (!filtered.length) {
    toast('표시할 무기 목록이 없습니다.');
    if (catalog) {
      catalog.innerHTML = `<div style="padding:14px 16px; color:#c7b589;">표시할 무기 목록이 없습니다.</div>`;
    }
    return;
  }
  renderMobileEquipList('weapon', filtered);
};

// 최초 1회 탭 렌더
renderWeaponTypeBar_mobile(types, activeType, onPickType);

// 최초 진입 시 현재 선택 타입으로 필터 적용
items = baseItems;
if (activeType !== '전체') {
  items = baseItems.filter(it => _getWeaponType_mobile(it) === activeType);
}


  if (!items.length) {
    toast('표시할 무기 목록이 없습니다.');
    return;
  }

  setEquipTopbarSlot(slot);
  renderMobileEquipList(slot, items);
  openEquipModal();
  return;
}


      // init에서 경량리스트 전부 받기
      await initMobileAllLightListsOnce();

      const key = _equipListKey(slot);
      const items = window.CORE?.lists?.[key];

      if (!Array.isArray(items) || !items.length) {
        console.error('equip list missing:', key, items);
        toast(`장비 목록을 불러오지 못했습니다. (${key})`);
        return;
      }

      setEquipTopbarSlot(slot);
      renderMobileEquipList(slot, items);
      openEquipModal();
    }

    // ✅ 장비 슬롯 클릭 → 장비 선택
    document.getElementById('pageEquip')?.addEventListener('click', async (e) => {
      const btn = e.target?.closest?.('.equip-row');
      if (!btn) return;

      const slot = btn.getAttribute('data-slot');
      if (!slot) return;

      try {
        await openEquipPicker(slot);
      } catch (err) {
        console.error(err);
        toast('장비 목록을 불러오지 못했습니다.');
      }
    });


    // ===== Main actions (placeholders) =====
    document.getElementById('btnPickChar')?.addEventListener('click', async () => {
      try {
        await openMobileCharacterPicker();
      } catch (e) {
        console.error(e);
        toast('캐릭터 목록을 불러오지 못했습니다.');
      }
    });

    document.getElementById('btnContactSend')?.addEventListener('click', () => {
      toast('문의 전송(apiJSON contact_admin)은 다음 단계에서 연결합니다.');
    });

    document.getElementById('btnMobileCompute')?.addEventListener('click', () => {
      // 나중에 PC의 compute 호출 결과를 mobileFinalDamage에 꽂으면 됨
      document.getElementById('mobileFinalDamage').textContent = '계산(연결 전)';
      toast('계산 로직 연결은 다음 단계에서 진행합니다.');
    });
  </script>
</body>

</html>